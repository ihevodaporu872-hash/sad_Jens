{
  "nodes": [
    {
      "parameters": {},
      "id": "ebfcc157-a48e-4403-9bc9-b289104bd481",
      "name": "When clicking ‚ÄòExecute workflow‚Äô",
      "type": "n8n-nodes-base.manualTrigger",
      "position": [
        -1776,
        -864
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9cbd4ec9-df24-41e8-b47a-720a4cdb733b",
              "name": "path_to_converter",
              "type": "string",
              "value": "C:\\Users\\Artem Boiko\\Desktop\\n8n\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\DDC_Converter_Revit\\datadrivenlibs\\RvtExporter.exe"
            },
            {
              "id": "aa834467-80fb-476a-bac1-6728478834f0",
              "name": "path_project_file",
              "type": "string",
              "value": "C:\\Users\\Artem Boiko\\Desktop\\n8n\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\Sample_Projects\\2023 racbasicsampleproject.rvt"
            }
          ]
        },
        "options": {}
      },
      "id": "e36acf30-9147-4fde-80cc-5677e3128e3c",
      "name": "Set path to file and converter",
      "type": "n8n-nodes-base.set",
      "position": [
        -1568,
        -864
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "jsCode": "const { execSync } = require('child_process');\ntry {\n  const cmd = \"// TODO: set command\";\n  const result = execSync(cmd, { encoding: 'utf-8', timeout: 120000 });\n  return [{ json: { stdout: result, exitCode: 0 } }];\n} catch (e) {\n  return [{ json: { stderr: e.stderr || e.message, exitCode: e.status || 1 } }];\n}"
      },
      "id": "f9698884-d273-48be-ac9c-72edacba625f",
      "name": "Converting the project into a structured form",
      "type": "n8n-nodes-base.code",
      "position": [
        -1376,
        -864
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "content": "## ‚¨áÔ∏è Only modify the variables here  \n‚Äî everything else works automatically",
        "height": 384,
        "width": 192,
        "color": 4
      },
      "id": "d530ce95-fb05-467e-9445-5a05003c0059",
      "name": "Sticky Note2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1616,
        -1056
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "Simple n8n workflow",
        "height": 464,
        "width": 688,
        "color": 7
      },
      "id": "9a1212c7-ebf0-458e-acfd-7aa34b8b4917",
      "name": "Sticky Note3",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1856,
        -1104
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "run-cYpR0z9b",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "493a6067-6de5-4afa-a72b-6484023fb948",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -1984,
        -704
      ],
      "webhookId": "218791a5-08da-44e2-84be-00a2431873aa"
    },
    {
      "parameters": {
        "content": "‚≠ê **If you find our tools helpful**, please consider **starring our repository** on [GitHub](https://github.com/datadrivenconstruction/OpenConstructionEstimate-DDC-CWICR). \n\nYour support helps us improve and continue developing open solutions for the community!\n",
        "height": 132,
        "width": 420
      },
      "id": "4ac62645-24d2-44fe-893f-428788d0b660",
      "name": "Sticky Note1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -304,
        -1248
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üîê API CREDENTIALS SETUP\n\n### ‚¨áÔ∏è Configure node `üîë TOKEN` below:\n\n```json\n{\n  \"bot_token\": \"YOUR_BOT_TOKEN\",\n  \"AI_PROVIDER\": \"gemini\",\n  \"GEMINI_API_KEY\": \"YOUR_KEY\",\n  \"OPENAI_API_KEY\": \"YOUR_KEY\",\n  \"QDRANT_URL\": \"http://...\",\n  \"QDRANT_API_KEY\": \"YOUR_KEY\"\n}\n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n---\n\n### üì° APIs Required (3 keys):\n\n| # | API | Field | Get from |\n|---|-----|-------|----------|\n| 1 | Telegram | `bot_token` | @BotFather |\n| 2 | OpenAI | `OPENAI_API_KEY` | platform.openai.com |\n| 3 | Gemini | `GEMINI_API_KEY` | aistudio.google.com |\n\n\n### ‚öôÔ∏è Vision Provider:\n\n`AI_PROVIDER`:\n- `\"gemini\"` ‚Üí Gemini 2.0 Flash\n- `\"openai\"` ‚Üí GPT-4 Vision\n\n---\n\n### ‚úÖ Quick Start:\n\n1. Get bot token from @BotFather\n2. Get OpenAI key (for embeddings)\n3. Get Gemini key (for vision)\n4. Paste in `üîë TOKEN` node\n5. Set Telegram credential\n6. Activate workflow!",
        "height": 1200,
        "width": 428,
        "color": 5
      },
      "id": "900c891c-51d8-4548-9046-3122895414bc",
      "name": "üîê Credentials Setup",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -304,
        -1104
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üîÄ Route Switch\n\n**17 Actions:**\n\n| # | Action | Description |\n|---|--------|-------------|\n| 0 | show_lang | Language menu |\n| 1 | ask_photo | Request photo |\n| 2 | lang_selected | Save language |\n| 3 | show_analyze | Photo options |\n| 4 | analyze | AI vision |\n| 5 | show_edit_menu | Edit work |\n| 6 | works_updated | Qty changed |\n| 7 | ask_new_work | Add work |\n| 8 | start_calc | Calculate |\n| 9 | show_help | Help text |\n| 10 | view_details | Work info |\n| 11 | export_excel | CSV export |\n| 12 | export_pdf | PDF export |\n| 13 | process_pdf | PDF analysis |\n| 14 | analyze_text | Text input |\n| 15 | refine | Re-analyze |\n| 16 | fallback | Unknown |",
        "height": 1136,
        "width": 308,
        "color": 5
      },
      "id": "9c6e8318-184a-4168-827a-ed1273e7bbdc",
      "name": "Route Switch",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        672,
        -1424
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üåê Config\n\n**9 Languages:**\nDE, EN, RU, ES, FR, IT, PL, PT, UK\n\n**Contains:**\n- UI messages\n- Button labels\n- Currency symbols\n- Database mapping\n- System prompts\n\n**Auto-selects:**\n- Database by language\n- Currency by region",
        "height": 808,
        "width": 220,
        "color": 5
      },
      "id": "e1126d7f-b263-4ec6-8761-27b90ebcadcf",
      "name": "Config & Localization",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        432,
        -1104
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üß† Main Router\n\nCentral message handler:\n\n**Input:** Telegram Update\n\n**Processing:**\n- Parse message/callback\n- Manage user sessions\n- Detect content type\n- Route to action\n\n**Output:**\n`action` ‚Üí Route switch",
        "height": 808,
        "width": 268,
        "color": 5
      },
      "id": "8911df9c-23a8-46e1-a64a-4a55b3fad8a6",
      "name": "Main Router",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        144,
        -1104
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## ‚úÖ CHECKLIST\n\n**1. Telegram Bot**\n- [ ] Created via @BotFather\n- [ ] Token in üîë TOKEN\n- [ ] Credential configured\n\n**2. OpenAI**\n- [ ] API key obtained\n- [ ] Added to üîë TOKEN\n\n**3. Gemini/GPT-4**\n- [ ] Vision API enabled\n- [ ] Key configured\n\n**4. Activation**\n- [ ] Workflow active\n- [ ] Webhook set",
        "height": 428,
        "width": 324
      },
      "id": "ff806daa-00c0-4d0a-8740-94c358b26109",
      "name": "Checklist",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -640,
        -784
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## ‚öôÔ∏è Telegram Credentials\n\n### Setup n8n Credential:\n\n1. **Settings** ‚Üí Credentials\n2. **Add** ‚Üí Telegram API\n3. Enter Bot Token\n4. **Save**\n\n### Configure Trigger:\n1. Select credential in `Telegram Trigger`\n2. Set webhook mode\n3. Activate workflow\n\n### Test:\nSend `/start` to your bot",
        "height": 436,
        "width": 328
      },
      "id": "10110209-25f0-471c-821f-984b545becfb",
      "name": "Telegram Credentials",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -640,
        -336
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üöÄ DDC CWICR Pipeline\n### Construction Cost Estimation Bot\n\n**Version:** 10.3 Enhanced\n**Author:** DataDrivenConstruction.io\n\n**Features:**\n- üì∑ Photo analysis (GPT-4 Vision / Gemini)\n- üìÑ PDF floor plan processing\n- üîç Vector search (Qdrant + OpenAI)\n- ü§ñ AI reranking for accuracy\n- üìä HTML/Excel/PDF export\n- üåç 9 languages supported\n\n**Database:** 55,000+ construction rates\n\n‚≠ê **Star our repo:** [GitHub](https://github.com/datadrivenconstruction/OpenConstructionEstimate-DDC-CWICR)",
        "height": 440,
        "width": 318
      },
      "id": "002cfb12-6aa6-4ea9-941a-74473529affc",
      "name": "Intro",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -640,
        -1248
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// AGG - Final aggregation of calculation results + FREE DEMO info\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\n\nconst L = cfg.L || {};\nlet total = 0, workers_sum = 0, materials_sum = 0, machines_sum = 0, labor_hours_sum = 0;\nlet found_count = 0;\n\n// Get accumulated results\nconst storedResults = sd.res?.[cid] || [];\n\nconsole.log('=== AGG ===');\nconsole.log('Results count:', storedResults.length);\n\n// Process each result\nconst works = storedResults.map(w => {\n  const uc = w.uc || 0;\n  const tc = w.tc || 0;\n\n  total += tc;\n  workers_sum += (w.workers_total || 0);\n  materials_sum += (w.materials_total || 0);\n  machines_sum += (w.machines_total || 0);\n  labor_hours_sum += (w.labor_hours || 0);\n\n  if (w._found) found_count++;\n\n  return {\n    id: w.id,\n    name: w.name || w.sq,\n    query: w.sq || w.query,\n    qty: w.qty,\n    unit: w.unit,\n    room: w.room,\n    uc: uc,\n    tc: tc,\n    rate_code: w.rate_code || '',\n    rate_name: w.rate_name || '',\n    resources: w.resources || [],\n    workers_total: w.workers_total || 0,\n    materials_total: w.materials_total || 0,\n    machines_total: w.machines_total || 0,\n    labor_hours: w.labor_hours || 0,\n    found: w._found || false,\n    scope_of_work: w.scope_of_work || [],\n    original_query: w.original_query || w.name\n  };\n});\n\nconst pct = works.length > 0 ? Math.round(found_count / works.length * 100) : 0;\n\n// FREE DEMO info\nconst isLimited = session.isLimited || false;\nconst originalTotal = session.totalWorks || works.length;\nconst skippedWorks = originalTotal - works.length;\n\nconsole.log('Calculated:', works.length, '/', originalTotal);\nconsole.log('Found:', found_count, '/', works.length);\nconsole.log('Total cost:', total.toFixed(2));\nconsole.log('Limited:', isLimited);\n\n// Cleanup staticData\nif (sd.res?.[cid]) delete sd.res[cid];\nif (sd.calcProgress?.[cid]) delete sd.calcProgress[cid];\nif (sd.progress?.[cid]) delete sd.progress[cid];\n\n// Save for report generation\nsd.lastResults = { works, total, workers_sum, materials_sum, machines_sum, labor_hours_sum, found_count, pct, L };\n\nreturn {\n  json: {\n    chatId: cid,\n    bot_token: cfg.bot_token,\n    works: works,\n    total: Math.round(total * 100) / 100,\n    workers_sum: Math.round(workers_sum * 100) / 100,\n    materials_sum: Math.round(materials_sum * 100) / 100,\n    machines_sum: Math.round(machines_sum * 100) / 100,\n    labor_hours_sum: Math.round(labor_hours_sum * 100) / 100,\n    found_count: found_count,\n    total_count: works.length,\n    pct: pct,\n    L: L,\n    currency: L.sym || '‚Ç¨',\n    description: session.description || '',\n    // FREE DEMO\n    _is_limited: isLimited,\n    _total_works: originalTotal,\n    _skipped_works: skippedWorks\n  }\n};"
      },
      "id": "269e8b06-434f-40dd-8fe8-8aea6ea9d827",
      "name": "Agg",
      "type": "n8n-nodes-base.code",
      "position": [
        2912,
        48
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/deleteMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('üßπ Prep Cleanup').first().json.chatId }},\n  \"message_id\": {{ $('üßπ Prep Cleanup').first().json._delete_progress_msg || 0 }}\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "293581ed-87fb-46bc-824f-889c98b5e2bd",
      "name": "üóëÔ∏è Delete Progress Msg",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2736,
        48
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/deleteMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('üßπ Prep Cleanup').first().json.chatId }},\n  \"message_id\": {{ $('üßπ Prep Cleanup').first().json._delete_work_msg || 0 }}\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "5d7332f4-2eef-4b0b-b755-828f1ad1880d",
      "name": "üóëÔ∏è Delete Work Msg",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2544,
        48
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PREP CLEANUP - Prepare message IDs for deletion after loop completes\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config').first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(cfg.chatId);\n\n// Get message IDs to delete\nconst lastMsgId = sd.calcProgress?.[cid]?.lastMsgId || null;\nconst progressMsgId = sd.progress?.[cid]?.message_id || null;\n\nconsole.log('=== PREP CLEANUP ===');\nconsole.log('ChatId:', cid);\nconsole.log('Work msg:', lastMsgId);\nconsole.log('Progress msg:', progressMsgId);\n\nreturn {\n  json: {\n    chatId: cfg.chatId,\n    bot_token: cfg.bot_token,\n    L: cfg.L,\n    _delete_work_msg: lastMsgId,\n    _delete_progress_msg: progressMsgId\n  }\n};"
      },
      "id": "3895b01b-6341-4fff-8eb3-b6d1ccc88d6c",
      "name": "üßπ Prep Cleanup",
      "type": "n8n-nodes-base.code",
      "position": [
        2368,
        48
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// ACC - Accumulate calculation results for final aggregation\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst sd = $getWorkflowStaticData('global');\nconst w = $('üìä Update Result').first().json;\nconst cid = String(w.chatId);\n\nif (!sd.res) sd.res = {};\nif (!sd.res[cid]) sd.res[cid] = [];\nsd.res[cid].push(w);\n\nconsole.log('Accumulated:', sd.res[cid].length, '/', w.total_works);\n\nreturn { json: w };"
      },
      "id": "63117a24-d6c9-4ecb-897c-463e9bf69564",
      "name": "Acc",
      "type": "n8n-nodes-base.code",
      "position": [
        3088,
        848
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/editMessageText",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"message_id\": {{ $json._edit_msg_id || 0 }}, \"text\": {{ JSON.stringify($json._result_text) }}, \"parse_mode\": \"Markdown\"}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "9e008a77-039e-4103-8f5e-199f8e1886b7",
      "name": "üì§ Edit Result",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2912,
        848
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// UPDATE RESULT - Format result message (‚úì Found / Not found)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst calcData = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(calcData.chatId);\nconst L = calcData.L || {};\n\nconst current = calcData.work_index || 1;\nconst total = calcData.total_works || 1;\nconst name = calcData.name || calcData.sq || 'Work';\n\nlet shortName = name.length > 22 ? name.substring(0, 19) + '...' : name;\n\nconst tc = parseFloat(calcData.tc) || 0;\nconst uc = parseFloat(calcData.uc) || 0;\nconst rateCode = String(calcData.rate_code || '');\nconst rateName = String(calcData.rate_name || '');\nconst currency = calcData.currency || L.sym || '‚Ç¨';\n\nconst hasValidRate = rateCode && \n  !rateCode.includes('NOT_FOUND') && \n  !rateCode.includes('PAYLOAD_NOT_FOUND');\n\nconst found = tc > 0 || uc > 0 || hasValidRate || (rateName && rateName.length > 0);\n\nconsole.log('Result:', shortName, found ? '‚úì' : '‚úó', tc.toFixed(0), currency);\n\nlet text = '';\nif (found) {\n  text = current + '/' + total + ' ' + shortName + ' ‚úì\\n';\n  text += tc.toFixed(0) + ' ' + currency;\n  if (rateCode && hasValidRate) text += ' ¬∑ ' + rateCode.substring(0, 20);\n} else {\n  text = current + '/' + total + ' ' + shortName + '\\n';\n  text += (L.not_found || '–ù–µ –Ω–∞–π–¥–µ–Ω–æ');\n}\n\nconst msgId = sd.calcProgress?.[cid]?.lastMsgId || null;\n\nreturn { json: { ...calcData, _result_text: text, _edit_msg_id: msgId, _found: found } };"
      },
      "id": "75f778bd-c239-4c3a-87a9-33b7a224d30b",
      "name": "üìä Update Result",
      "type": "n8n-nodes-base.code",
      "position": [
        2752,
        848
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PREP QUERY - Prepare search query with credentials from TOKEN\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst loopItem = $input.first().json;\nconst tokenData = $('üîë TOKEN').first().json;\n\nconst originalQuery = loopItem.sq || loopItem.query || loopItem.name || '';\nconst collectionName = loopItem.db || '';\nconst L = loopItem.L || {};\nconst workUnit = loopItem.unit || 'm¬≤';\nconst workQty = loopItem.qty || 1;\n\n// Get credentials from TOKEN node\nconst OPENAI_API_KEY = tokenData.OPENAI_API_KEY || '';\nconst QDRANT_URL = tokenData.QDRANT_URL || 'http://localhost:6333';\nconst QDRANT_API_KEY = tokenData.QDRANT_API_KEY || '';\n\nconsole.log('=== PREP QUERY ===');\nconsole.log('Query:', originalQuery);\nconsole.log('Collection:', collectionName);\nconsole.log('Qdrant URL:', QDRANT_URL);\n\nif (!OPENAI_API_KEY || !originalQuery || !collectionName) {\n  console.log('ERROR: Missing required data');\n  return [{ json: { ...loopItem, _error: 'Missing data', _skip: true } }];\n}\n\nconst searchLang = L.search_lang || 'Russian';\n\n// Detect database language from collection name\nconst isRussianDB = collectionName.includes('RU_') || collectionName.includes('_RU');\nconst isGermanDB = collectionName.includes('DE_');\nconst dbLang = isRussianDB ? 'Russian' : (isGermanDB ? 'German' : 'English');\n\nconst transformPrompt = `You are a construction cost database search expert for ${dbLang} construction rates database.\n\nTASK: Transform user query into optimal SEARCH KEYWORDS that will match entries in a vector database of construction work rates.\n\nDATABASE CONTEXT:\n- Contains standardized construction work rates with codes, names, units, resources\n- Each rate has: rate_code, rate_name, rate_unit, scope_of_work, resources\n- Language: ${dbLang}\n\nTRANSFORMATION RULES:\n1. EXPAND abbreviations to full professional terms\n2. ADD synonyms and related construction terms\n3. INCLUDE work action verbs (install, apply, lay, mount)\n4. Keep original query terms + expanded terms\n5. Output in ${dbLang} language only\n\nUSER QUERY: ${originalQuery}\nUNIT: ${workUnit}\n\nReply with ONLY the optimized search keywords (one line, no explanations):`;\n\nreturn [{ json: {\n  ...loopItem,\n  _original_query: originalQuery,\n  _transform_prompt: transformPrompt,\n  _collection: collectionName,\n  _openai_key: OPENAI_API_KEY,\n  _db_lang: dbLang,\n  _qdrant_url: QDRANT_URL,\n  _qdrant_key: QDRANT_API_KEY\n}}];"
      },
      "id": "d67bfac8-5b6d-4c18-903c-470feb07fc00",
      "name": "1Ô∏è‚É£ Prep Query",
      "type": "n8n-nodes-base.code",
      "position": [
        3088,
        448
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// SAVE WORK MSG - Store message ID for later editing/deletion\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst loopItem = $('üìù Prep Work Msg').first().json;\nconst tgResp = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(loopItem.chatId);\n\nif (!sd.calcProgress) sd.calcProgress = {};\nif (!sd.calcProgress[cid]) sd.calcProgress[cid] = {};\nsd.calcProgress[cid].lastMsgId = tgResp.result?.message_id || null;\n\nconsole.log('Saved msg ID:', sd.calcProgress[cid].lastMsgId);\n\nreturn { json: loopItem };"
      },
      "id": "66a503a7-d3da-417b-82cf-a2c42ddf0377",
      "name": "üíæ Save Work Msg",
      "type": "n8n-nodes-base.code",
      "position": [
        2912,
        448
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $(\"üìù Prep Work Msg\").item.json.chatId }}, \"text\": {{ JSON.stringify($(\"üìù Prep Work Msg\").item.json._work_text) }}, \"parse_mode\": \"Markdown\"}",
        "options": {}
      },
      "id": "dfaf6f3f-1c55-4863-ad35-a4de61dc25dd",
      "name": "üì§ Send Work",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2736,
        448
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/deleteMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"message_id\": {{ $json._prev_msg_id || 0 }}}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "1071fad2-8ede-437e-a385-115234ac8a9d",
      "name": "üóëÔ∏è Delete Prev",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2544,
        448
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PREP WORK MSG - Create \"Searching...\" message for current work\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst loopItem = $('Loop').first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(loopItem.chatId);\nconst L = loopItem.L || {};\n\nconst current = loopItem.work_index || 1;\nconst total = loopItem.total_works || 1;\nconst name = loopItem.name || loopItem.sq || 'Work';\nconst qty = loopItem.qty || 1;\nconst unit = loopItem.unit || 'm¬≤';\nconst room = loopItem.room || '';\n\nlet shortName = name.length > 25 ? name.substring(0, 22) + '...' : name;\n\n// Minimal message\nlet text = current + '/' + total + ' ' + shortName + '\\n';\ntext += qty + ' ' + unit;\nif (room) text += ' ¬∑ ' + room;\ntext += '\\n...';\n\nconst prevMsgId = sd.calcProgress?.[cid]?.lastMsgId || null;\n\nconsole.log('Work', current, '/', total);\n\nreturn { json: { ...loopItem, _work_text: text, _prev_msg_id: prevMsgId } };"
      },
      "id": "d35a548e-3774-4a29-8a3e-71b7db89066b",
      "name": "üìù Prep Work Msg",
      "type": "n8n-nodes-base.code",
      "position": [
        2368,
        448
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "id": "ad81d50a-ee33-4b39-87c7-3c0f494e4dc4",
      "name": "Loop",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [
        2096,
        144
      ],
      "typeVersion": 3
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PREP WORKS - Prepare work items for calculation loop (FREE DEMO: 5 items)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $input.first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\n\n// Get limited works list (max 5 for FREE DEMO)\nconst FREE_LIMIT = cfg._free_limit || 5;\nconst works = session.limitedWorks || (session.works || []).slice(0, FREE_LIMIT);\nconst db = session.db || cfg.db;\nconst L = session.L || cfg.L;\n\n// Initialize results accumulator\nif (!sd.res) sd.res = {};\nsd.res[cid] = [];\n\nconst totalWorks = works.length;\n\nconsole.log('=== PREP WORKS ===');\nconsole.log('Processing:', totalWorks, 'items');\n\n// Return array for loop processing\nreturn works.map((w, idx) => ({ \n  json: { \n    ...w, \n    db, \n    L, \n    currency: L?.sym || '‚Ç¨',\n    bot_token: cfg.bot_token, \n    chatId: cid, \n    sq: w.query || w.name,\n    original_query: w.query || w.name,\n    work_index: idx + 1, \n    total_works: totalWorks,\n    _is_limited: cfg._is_limited,\n    _original_total: cfg._total_works\n  } \n}));"
      },
      "id": "3038bbc2-8b4f-407a-8230-e6ca5d4827a2",
      "name": "Prep Works",
      "type": "n8n-nodes-base.code",
      "position": [
        1856,
        144
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// SAVE PROGRESS ID - Store initial progress message ID for cleanup\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config').first().json;\nconst prepData = $('üìù Prep Progress').first().json;\nconst telegramResponse = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(cfg.chatId);\n\n// Store progress message info\nif (!sd.progress) sd.progress = {};\nsd.progress[cid] = {\n  message_id: telegramResponse.result?.message_id || 0,\n  chat_id: cfg.chatId,\n  bot_token: cfg.bot_token\n};\n\n// Initialize calculation progress tracker\nif (!sd.calcProgress) sd.calcProgress = {};\nsd.calcProgress[cid] = { lastMsgId: null };\n\nconsole.log('Progress msg ID:', sd.progress[cid].message_id);\n\nreturn { \n  json: { \n    ...cfg,\n    _free_limit: prepData._free_limit,\n    _is_limited: prepData._is_limited,\n    _total_works: prepData._total_works\n  } \n};"
      },
      "id": "6795ef37-1473-4ca5-af61-ce5e5206a68a",
      "name": "Save Progress ID",
      "type": "n8n-nodes-base.code",
      "position": [
        1680,
        144
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json._progress_chat_id }}, \"text\": {{ JSON.stringify($json._progress_text) }}, \"parse_mode\": \"Markdown\"}",
        "options": {}
      },
      "id": "2e5639ca-cf4d-4538-97bf-6125149b9f52",
      "name": "üì§ Send Progress",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1472,
        144
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PREP PROGRESS - Show initial calculation message with FREE DEMO limit\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config').first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(cfg.chatId);\nconst session = sd.sess?.[cid] || {};\n\nconst allWorks = session.works || [];\n\n// Get L from Config (primary) or session (fallback)\nconst L = cfg.L || session.L || {};\n\nconsole.log('=== PREP PROGRESS ===');\nconsole.log('L.search_lang:', L.search_lang);\n\n// FREE DEMO LIMIT\nconst FREE_LIMIT = 5;\nconst totalWorks = allWorks.length;\nconst isLimited = totalWorks > FREE_LIMIT;\nconst worksToProcess = Math.min(totalWorks, FREE_LIMIT);\n\nsession.isLimited = isLimited;\nsession.totalWorks = totalWorks;\nsession.limitedWorks = allWorks.slice(0, FREE_LIMIT);\n\nconst estimatedMinutes = Math.max(1, Math.ceil(worksToProcess * 8 / 60));\n\n// Use localized text with Russian fallback\nconst calcWord = L.loading || '–†–∞—Å—á—ë—Ç...';\nconst itemsWord = L.items || '–ø–æ–∑–∏—Ü–∏–π';\nconst minWord = L.min || '–º–∏–Ω';\n\nlet text = '';\nif (isLimited) {\n  text = 'FREE DEMO ¬∑ ' + FREE_LIMIT + '/' + totalWorks + ' ' + itemsWord + '\\n';\n} else {\n  text = calcWord + ' ' + worksToProcess + ' ' + itemsWord + '\\n';\n}\ntext += '~' + estimatedMinutes + ' ' + minWord;\n\nreturn {\n  json: {\n    ...cfg,\n    _progress_chat_id: cfg.chatId,\n    _progress_text: text,\n    _free_limit: FREE_LIMIT,\n    _is_limited: isLimited,\n    _total_works: totalWorks\n  }\n};"
      },
      "id": "df4a17fa-17e0-4a7f-b0d7-6d8a2bb7aad2",
      "name": "üìù Prep Progress",
      "type": "n8n-nodes-base.code",
      "position": [
        1232,
        144
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// üìÑ PDF DOWNLOAD PREP\nconst cfg = $('Config').first().json;\nconsole.log('=== PDF DOWNLOAD PREP ===');\nreturn {\n  json: {\n    ...cfg,\n    pdfFileId: cfg.pdfFileId,\n    pdfFileName: cfg.pdfFileName || 'document.pdf'\n  }\n};"
      },
      "id": "07415363-68cc-464e-a5e8-4cbb0e41f1db",
      "name": "üìÑ PDF Download Prep",
      "type": "n8n-nodes-base.code",
      "position": [
        1664,
        -416
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// üßπ DEDUPLICATE & MERGE v7\nconst cfgNode = $('Config').first().json;\nconst cid = String(cfgNode.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst acc = sd.pdfAcc?.[cid] || { rooms: [], works: [] };\n\nconsole.log('=== DEDUPLICATE v7 ===');\nconsole.log('Raw rooms:', acc.rooms.length, 'works:', acc.works.length);\n\n// Dedupe rooms\nconst roomMap = new Map();\nfor (const r of acc.rooms) {\n  const key = (r.name || '').toLowerCase().trim();\n  if (!roomMap.has(key) || (r.area_m2 || 0) > (roomMap.get(key).area_m2 || 0)) {\n    roomMap.set(key, r);\n  }\n}\nconst rooms = Array.from(roomMap.values()).map((r, i) => ({\n  ...r,\n  id: 'R' + String(i + 1).padStart(3, '0')\n}));\n\n// Dedupe works\nconst workMap = new Map();\nfor (const w of acc.works) {\n  const key = (w.name || '').toLowerCase().trim() + '_' + (w.unit || '') + '_' + (w.room || '');\n  if (workMap.has(key)) {\n    workMap.get(key).qty += (w.qty || 1);\n  } else {\n    workMap.set(key, { ...w, qty: w.qty || 1 });\n  }\n}\n\nconst works = Array.from(workMap.values()).map((w, i) => ({\n  id: 'W' + String(i + 1).padStart(3, '0'),\n  seq: i + 1,\n  name: w.name,\n  query: w.query || w.name,\n  qty: Math.round((w.qty || 1) * 100) / 100,\n  unit: w.unit || 'm¬≤',\n  room: w.room || '',\n  details: w.details || '',\n  conf: 'medium'\n}));\n\nconsole.log('Unique rooms:', rooms.length, 'works:', works.length);\n\nconst totalArea = rooms.reduce((sum, r) => sum + (r.area_m2 || 0), 0);\n\n// Save to session\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = {};\nsd.sess[cid].works = works;\nsd.sess[cid].rooms = rooms;\nsd.sess[cid].totalArea = totalArea;\nsd.sess[cid].L = cfgNode.L;\nsd.sess[cid].state = 'wait_edit';\n\n// Cleanup\nif (sd.pdfAcc) delete sd.pdfAcc[cid];\nif (sd.pdfData) delete sd.pdfData[cid];\n\nreturn {\n  json: {\n    chatId: cfgNode.chatId,\n    bot_token: cfgNode.bot_token,\n    L: cfgNode.L,\n    works,\n    rooms,\n    totalArea\n  }\n};"
      },
      "id": "9ec88556-a465-4dd4-bb03-77a6d0312020",
      "name": "üßπ Deduplicate & Merge",
      "type": "n8n-nodes-base.code",
      "position": [
        3872,
        -544
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"text\": {{ JSON.stringify($json.msg) }}, \"parse_mode\": \"Markdown\", \"reply_markup\": {\"inline_keyboard\": {{ JSON.stringify($json.keyboard) }}}}",
        "options": {}
      },
      "id": "e1af18ee-feb9-42db-a484-88405eaa3178",
      "name": "üì§ Send Works",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        4512,
        -784
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// SHOW WORKS - Display extracted work items with edit buttons\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfgNode = $('Config').first().json;\nconst inputData = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\n\nconst chatId = inputData.chatId || cfgNode.chatId;\nconst bot_token = inputData.bot_token || cfgNode.bot_token;\nconst cid = String(chatId);\n\n// Get L from multiple sources (session is most reliable)\nconst session = sd.sess?.[cid] || {};\nlet L = cfgNode.L || session.L || inputData.L || {};\n\n// Get works from input (from Deduplicate) or session\nconst works = inputData.works || session.works || [];\nconst rooms = inputData.rooms || session.rooms || [];\n\nconsole.log('=== SHOW WORKS ===');\nconsole.log('Works:', works.length);\nconsole.log('L.search_lang:', L.search_lang);\n\n// Save to session\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = {};\nif (works.length > 0) {\n  sd.sess[cid].works = works;\n  sd.sess[cid].rooms = rooms;\n  sd.sess[cid].L = L;\n  sd.sess[cid].db = cfgNode.db;\n  sd.sess[cid].state = 'wait_edit';\n}\n\nfunction short(str, len) {\n  str = String(str || '');\n  return str.length > len ? str.substring(0, len - 1) + '‚Ä¶' : str;\n}\n\nconst totalArea = rooms.reduce((sum, r) => sum + (r.area_m2 || 0), 0);\n\n// Use localized labels with fallback\nconst roomWord = L.rooms || '–∫–æ–º–Ω–∞—Ç';\nconst workWord = L.works_identified || '–ø–æ–∑–∏—Ü–∏–π';\nconst generalWord = L.general || '–û–±—â–µ–µ';\n\nlet msg = '*' + rooms.length + ' ' + roomWord;\nif (totalArea > 0) msg += ' ¬∑ ' + (Math.round(totalArea * 10) / 10) + ' m¬≤';\nmsg += '*\\n';\nmsg += '_' + works.length + ' ' + workWord + '_\\n\\n';\n\nif (works.length === 0) {\n  msg += '_' + (L.no_works || '–†–∞–±–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã') + '_\\n';\n} else {\n  const worksByRoom = new Map();\n  const noRoom = [];\n\n  for (const w of works) {\n    if (w.room && w.room.length > 0) {\n      if (!worksByRoom.has(w.room)) worksByRoom.set(w.room, []);\n      worksByRoom.get(w.room).push(w);\n    } else {\n      noRoom.push(w);\n    }\n  }\n\n  let workNum = 1;\n\n  for (const [roomName, roomWorks] of worksByRoom) {\n    const room = rooms.find(r => r.name === roomName);\n    const areaStr = room?.area_m2 ? ' ¬∑ ' + room.area_m2 + ' m¬≤' : '';\n    msg += '*' + short(roomName, 20) + '*' + areaStr + '\\n';\n\n    for (const w of roomWorks) {\n      const wname = short(w.name || 'Work', 25);\n      const qty = typeof w.qty === 'number' ? Math.round(w.qty * 100) / 100 : w.qty;\n      msg += workNum + '. ' + wname + ' ‚Äî ' + qty + ' ' + (w.unit || '') + '\\n';\n      workNum++;\n    }\n    msg += '\\n';\n  }\n\n  if (noRoom.length > 0) {\n    msg += '*' + generalWord + '*\\n';\n    for (const w of noRoom) {\n      const wname = short(w.name || 'Work', 25);\n      const qty = typeof w.qty === 'number' ? Math.round(w.qty * 100) / 100 : w.qty;\n      msg += workNum + '. ' + wname + ' ‚Äî ' + qty + ' ' + (w.unit || '') + '\\n';\n      workNum++;\n    }\n  }\n}\n\n// Build keyboard\nconst keyboard = [];\nconst maxBtns = works.length;\nif (maxBtns > 0) {\n  for (let i = 0; i < maxBtns; i += 5) {\n    const row = [];\n    for (let j = 0; j < 5 && i + j < maxBtns; j++) {\n      row.push({ text: '‚úè' + (i + j + 1), callback_data: 'edit_work_' + (i + j) });\n    }\n    keyboard.push(row);\n  }\n}\n\nkeyboard.push([\n  { text: L.btn_add_work || '+ –ü–æ–∑–∏—Ü–∏—è', callback_data: 'add_work' },\n  { text: L.btn_calc || '‚ñ∂ –†–∞—Å—á—ë—Ç', callback_data: 'calculate' }\n]);\nkeyboard.push([\n  { text: L.btn_new || 'üîÑ –ó–∞–Ω–æ–≤–æ', callback_data: 'new_photo' }\n]);\n\nreturn { json: { chatId, bot_token, L, msg, keyboard, works, rooms } };"
      },
      "id": "70b50765-04ec-4a61-bf9b-b4805f1db977",
      "name": "üìä Show Works",
      "type": "n8n-nodes-base.code",
      "position": [
        4384,
        -640
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// üì¶ ACCUMULATE v7\nconst cfg = $input.first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\n\nif (!sd.pdfAcc) sd.pdfAcc = {};\nif (!sd.pdfAcc[cid]) sd.pdfAcc[cid] = { rooms: [], works: [], totalArea: 0 };\n\nconst acc = sd.pdfAcc[cid];\n\nif (cfg.pageRooms) acc.rooms.push(...cfg.pageRooms);\nif (cfg.pageWorks) acc.works.push(...cfg.pageWorks);\nif (cfg.totalArea) acc.totalArea = Math.max(acc.totalArea, cfg.totalArea);\n\nconsole.log('Accumulated - rooms:', acc.rooms.length, 'works:', acc.works.length);\n\nreturn { json: { ...cfg } };"
      },
      "id": "7368bea6-e1a2-43c9-9832-9aa1f9d4695d",
      "name": "üì¶ Accumulate Pages",
      "type": "n8n-nodes-base.code",
      "position": [
        4112,
        -400
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// üè† PARSE PDF PAGE v7\nconst prepData = $('üëÅÔ∏è Prep Vision PDF').first().json;\nconst resp = $input.first().json;\n\nif (prepData._skip_vision) {\n  return { json: { ...prepData, pageRooms: [], pageWorks: [], totalArea: 0 } };\n}\n\nlet raw = resp.candidates?.[0]?.content?.parts?.[0]?.text || '';\nlet parsed = { rooms: [], works: [], total_area_m2: 0 };\n\ntry {\n  let clean = raw.replace(/```json\\s*/gi, '').replace(/```\\s*/gi, '').trim();\n  const s = clean.indexOf('{'), e = clean.lastIndexOf('}');\n  if (s !== -1 && e > s) {\n    parsed = JSON.parse(clean.substring(s, e + 1));\n  }\n  console.log('Parsed - rooms:', parsed.rooms?.length, 'works:', parsed.works?.length);\n} catch(err) {\n  console.log('Parse error:', err.message);\n}\n\nconst rooms = (parsed.rooms || []).map((r, i) => ({\n  id: 'R' + String(i + 1).padStart(3, '0'),\n  name: r.name || 'Room ' + (i + 1),\n  area_m2: r.area_m2 || 0\n}));\n\nconst works = (parsed.works || []).map((w, i) => {\n  let name = w.name || 'Work';\n  if (w.details && w.details.length > 0 && w.details.length < 30) {\n    name = name + ' ' + w.details;\n  }\n  return {\n    id: 'W' + String(i + 1).padStart(3, '0'),\n    name: name.trim(),\n    query: (w.name || 'Work').trim(),\n    room: w.room || '',\n    qty: w.qty || w.quantity || 1,\n    unit: w.unit || 'm¬≤',\n    details: w.details || '',\n    conf: 'medium'\n  };\n});\n\nreturn {\n  json: {\n    ...prepData,\n    pageRooms: rooms,\n    pageWorks: works,\n    totalArea: parsed.total_area_m2 || 0\n  }\n};"
      },
      "id": "d98b62e9-2f7d-4152-82ca-c502cdc33ed6",
      "name": "üè† Parse PDF Page",
      "type": "n8n-nodes-base.code",
      "position": [
        3888,
        -400
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json._vision_url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json._vision_body) }}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          },
          "timeout": 120000
        }
      },
      "id": "c3f929b2-29f5-422a-a513-2cfb128ccb4e",
      "name": "üëÅÔ∏è Call Vision PDF",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        3664,
        -400
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// üëÅÔ∏è PREP VISION PDF v7 - UNIVERSAL\nconst cfgNode = $('Config').first().json;\nconst tokenConfig = $('üîë TOKEN').first().json;\nconst loopData = $('üîÅ Loop PDF Pages').first().json;\n\nconst GEMINI_API_KEY = tokenConfig.GEMINI_API_KEY;\nconst cid = String(cfgNode.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst pdfBase64 = sd.pdfData?.[cid]?.base64 || '';\n\nif (!pdfBase64 || pdfBase64.length < 100) {\n  return { json: { ...cfgNode, _skip_vision: true } };\n}\n\nconst lang = cfgNode.lang || 'EN';\nconst langName = {\n  'RU': 'Russian', 'EN': 'English', 'DE': 'German',\n  'ES': 'Spanish', 'FR': 'French', 'PT': 'Portuguese',\n  'ZH': 'Chinese', 'AR': 'Arabic', 'HI': 'Hindi'\n}[lang] || 'English';\n\nconst prompt = `Analyze this architectural floor plan / construction drawing.\n\nYOUR TASK:\n1. Find room schedule/table if present - extract room names and areas\n2. If no table, estimate rooms from the drawing\n3. Generate construction works list for cost estimation database search\n\nOUTPUT in ${langName}:\n{\n  \"total_area_m2\": 99.15,\n  \"rooms\": [\n    {\"name\": \"Room Name\", \"area_m2\": 15.5}\n  ],\n  \"works\": [\n    {\"name\": \"work description\", \"room\": \"Room Name\", \"qty\": 15.5, \"unit\": \"m¬≤\", \"details\": \"optional specs\"}\n  ]\n}\n\nWORK NAMING GUIDELINES:\n- Use short, searchable descriptions (good for database lookup)\n- Include specifications when visible: dimensions, materials, types\n- Examples of good work names:\n  - \"Floor tiling\" or \"Laminate flooring\" (not just \"flooring\")\n  - \"Wall plastering\" or \"Drywall installation\"\n  - \"Interior door 800√ó2000mm\" (include size if visible)\n  - \"Suspended ceiling\" or \"Stretch ceiling\"\n  - \"Toilet installation\" or \"Sink installation\"\n\nQUANTITY GUIDELINES:\n- Floor works: qty = room area\n- Wall works: estimate from perimeter √ó height (typically 2.5-3m)\n- Ceiling works: qty = room area\n- Doors/windows/fixtures: count from drawing\n- Use realistic quantities that match the total area\n\nIMPORTANT:\n- Read any tables/schedules in the drawing for accurate data\n- Each work should reference which room it belongs to\n- Include \"details\" field for dimensions, materials, or specifications when visible\n- Respond ONLY with valid JSON, no explanations`;\n\nconst apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=' + GEMINI_API_KEY;\nconst requestBody = {\n  contents: [{ parts: [\n    { text: prompt },\n    { inline_data: { mime_type: 'application/pdf', data: pdfBase64 } }\n  ]}],\n  generationConfig: { temperature: 0.1, maxOutputTokens: 8000 }\n};\n\nreturn { json: { ...cfgNode, _vision_url: apiUrl, _vision_body: requestBody } };"
      },
      "id": "94ceae09-fcc0-4260-8705-3d342586275e",
      "name": "üëÅÔ∏è Prep Vision PDF",
      "type": "n8n-nodes-base.code",
      "position": [
        3440,
        -400
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "c9374545-83bd-4a2b-958a-7d8fba8f2ada",
      "name": "üîÅ Loop PDF Pages",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [
        3232,
        -416
      ],
      "typeVersion": 3
    },
    {
      "parameters": {
        "jsCode": "// üìÑ PREP PAGES LOOP\nconst cfg = $('üìù Prep PDF Message').first().json;\nconst pages = cfg.pdfPages || [{pageNum: 1}];\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst pdfData = sd.pdfData?.[cid] || {};\n\nreturn pages.map((p, i) => ({\n  json: {\n    ...cfg,\n    currentPage: p.pageNum,\n    totalPages: pages.length,\n    pdfBase64: pdfData.base64 || ''\n  }\n}));"
      },
      "id": "295b3adc-7784-4eac-bf8d-412ef91649a4",
      "name": "üìÑ Prep Pages Loop",
      "type": "n8n-nodes-base.code",
      "position": [
        3008,
        -416
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json._tg_chat_id }}, \"text\": {{ JSON.stringify($json._tg_text) }}, \"parse_mode\": \"Markdown\"}",
        "options": {}
      },
      "id": "845cd4d9-bf8e-41e9-a49d-a4e923b557a2",
      "name": "üì§ PDF Received",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2784,
        -416
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// üìù PREP PDF MESSAGE\nconst cfg = $('Config').first().json;\nconst data = $input.first().json;\nconst pages = data.totalPages || 1;\nconst estMinutes = Math.max(1, Math.ceil(pages * 0.5));\n\nlet text = 'üìÑ *PDF received*\\n\\n';\ntext += '‚è≥ Analyzing drawing...\\n';\ntext += '‚è± ~' + estMinutes + ' min\\n\\n';\ntext += '_Report will be sent to this chat_';\n\nreturn {\n  json: {\n    ...data,\n    _tg_chat_id: cfg.chatId,\n    _tg_text: text\n  }\n};"
      },
      "id": "0b176a53-e4bb-4e92-b699-a3011d29294b",
      "name": "üìù Prep PDF Message",
      "type": "n8n-nodes-base.code",
      "position": [
        2560,
        -416
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// üìÑ SPLIT PDF PAGES\nconst cfg = $('Config').first().json;\nconst inputBinary = $input.first().binary;\nconst MAX_PAGES = 3;\nlet pdfBase64 = '';\n\nif (inputBinary) {\n  const key = Object.keys(inputBinary)[0];\n  if (key) pdfBase64 = inputBinary[key].data || '';\n}\n\nconst sizeKB = pdfBase64 ? (pdfBase64.length * 0.75) / 1024 : 0;\nconst totalPages = Math.min(Math.max(1, Math.ceil(sizeKB / 150)), MAX_PAGES);\n\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nif (!sd.pdfData) sd.pdfData = {};\nsd.pdfData[cid] = { base64: pdfBase64, totalPages };\n\nconsole.log('PDF size KB:', Math.round(sizeKB), 'Pages:', totalPages);\n\nreturn {\n  json: {\n    ...cfg,\n    pdfPages: Array.from({length: totalPages}, (_, i) => ({pageNum: i+1})),\n    totalPages\n  }\n};"
      },
      "id": "45d36a30-2954-4e06-af06-bbd6d3b451ca",
      "name": "üìÑ Split PDF Pages",
      "type": "n8n-nodes-base.code",
      "position": [
        2352,
        -416
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/file/bot{{ $('üîë TOKEN').first().json.bot_token }}/{{ $json.result.file_path }}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "c59c5247-6de7-443f-ae6d-9a33f555ece0",
      "name": "üìÑ Download PDF",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2128,
        -416
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/getFile?file_id={{ $json.pdfFileId }}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "8fdff9ae-b775-4b18-acec-b95289f5f561",
      "name": "üìÑ Get PDF Path",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1888,
        -416
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Merge paths before Prep Vision\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst input = $input.first().json;\n\nconsole.log('=== MERGE TO VISION ===');\nconsole.log('photos:', input.photos?.length || 0);\nconsole.log('skipVision:', input.skipVision);\nconsole.log('L.search_lang:', input.L?.search_lang);\n\nreturn { json: input };"
      },
      "id": "b1bca518-24b6-4936-8511-943be2aa8d21",
      "name": "Merge To Vision1",
      "type": "n8n-nodes-base.code",
      "position": [
        2912,
        -768
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify('üì∑ ' + (($json.L && $json.L.photo) ? $json.L.photo.split('\\n')[0] : 'Please send a photo first')) }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "63b680c8-99ee-40f9-87f1-969a092d7311",
      "name": "üì§ No Photos Msg1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2736,
        -1088
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "operator": {
                "type": "boolean",
                "operation": "equals"
              },
              "leftValue": "={{ $json.noPhotosError }}",
              "rightValue": true
            }
          ]
        },
        "options": {}
      },
      "id": "f20665cd-14d1-40ea-8c63-5a9e7028b1a1",
      "name": "IF No Photos1",
      "type": "n8n-nodes-base.if",
      "position": [
        2448,
        -1040
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Merge Vision API response with original input data\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst originalInput = $('Prep Vision1').first().json;\nconst apiResponse = $input.first().json;\n\nconsole.log('=== MERGE VISION ===');\nconsole.log('Provider:', originalInput.provider);\nconsole.log('Has candidates:', (apiResponse.candidates || []).length);\nconsole.log('Has choices:', (apiResponse.choices || []).length);\n\nreturn { \n  json: { \n    ...originalInput,\n    candidates: apiResponse.candidates || [],\n    promptFeedback: apiResponse.promptFeedback,\n    choices: apiResponse.choices || [],\n    error: apiResponse.error\n  } \n};"
      },
      "id": "7103afa7-29b2-4981-8e59-9f90a7c5ca6c",
      "name": "Merge Vision1",
      "type": "n8n-nodes-base.code",
      "position": [
        3376,
        -768
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.apiUrl }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "={{ $json.provider === 'openai' ? 'Bearer ' + $json.apiKey : '' }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.requestBody) }}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "525919a4-d35f-4c6a-8fb5-e35c9f6e01f8",
      "name": "Call Vision1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        3216,
        -768
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Prepare request for Vision API (Gemini or OpenAI GPT-4o)\n// FIXED: Description in correct language\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst input = $input.first().json;\n\nconst photos = input.photos || [];\nconsole.log('=== PREP VISION ===');\nconsole.log('Photos received:', photos.length);\n\nif (photos.length === 0) {\n  console.log('‚ùå No photos to process');\n  return { json: { ...input, error: 'No photos', candidates: [], choices: [] } };\n}\n\nconsole.log('Photo base64 lengths:', photos.map(p => p.base64?.length || 0));\nconst description = input.description || '';\nconst L = input.L || {};\nconst searchLang = L.search_lang || 'German';\n\nconsole.log('Search language:', searchLang);\n\nconst tokenConfig = $('üîë TOKEN').first().json;\nconst provider = (tokenConfig.AI_PROVIDER || 'gemini').toLowerCase();\nconst geminiKey = tokenConfig.GEMINI_API_KEY;\nconst openaiKey = tokenConfig.OPENAI_API_KEY;\n\nconsole.log('AI Provider:', provider);\n\nif (provider === 'gemini' && (!geminiKey || geminiKey === 'YOUR_GEMINI_API_KEY_HERE')) {\n  return { json: { ...input, error: 'GEMINI_API_KEY not configured', candidates: [] } };\n}\nif (provider === 'openai' && (!openaiKey || openaiKey === 'YOUR_OPENAI_API_KEY_HERE')) {\n  return { json: { ...input, error: 'OPENAI_API_KEY not configured', choices: [] } };\n}\n\nconst LANG_CONFIG = {\n  'German': {\n    good: ['Gipskartonwand 2-lagig CW75', 'Trockenbau Abhangdecke', 'Fliesen Feinsteinzeug verlegen', 'Malerarbeiten Dispersionsfarbe', 'Elektroinstallation Steckdosen UP'],\n    bad: ['Wand', 'Decke', 'Installation'],\n    descExample: 'Renovierung Badezimmer mit Trockenbau und Fliesen',\n    descInstruction: 'Beschreibung auf Deutsch'\n  },\n  'English': {\n    good: ['Drywall installation 2-layer metal stud CW75', 'Suspended ceiling installation', 'Porcelain tile flooring installation', 'Painting emulsion 2 coats', 'Electrical outlets flush mount'],\n    bad: ['Wall', 'Ceiling', 'Tiles'],\n    descExample: 'Bathroom renovation with drywall and tiles',\n    descInstruction: 'Description in English'\n  },\n  'Russian': {\n    good: ['–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–µ—Ä–µ–≥–æ—Ä–æ–¥–æ–∫ –∏–∑ –ì–ö–õ 2 —Å–ª–æ—è –ø—Ä–æ—Ñ–∏–ª—å –ü–ü60', '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–≤–µ—Å–Ω—ã—Ö –ø–æ—Ç–æ–ª–∫–æ–≤ –∏–∑ –≥–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω–∞', '–û–±–ª–∏—Ü–æ–≤–∫–∞ –ø–æ–ª–∞ –∫–µ—Ä–∞–º–æ–≥—Ä–∞–Ω–∏—Ç–æ–º 600x600', '–û–∫—Ä–∞—Å–∫–∞ –≤–æ–¥–æ—ç–º—É–ª—å—Å–∏–æ–Ω–Ω–æ–π –∫—Ä–∞—Å–∫–æ–π 2 —Å–ª–æ—è', '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–æ–∑–µ—Ç–æ–∫ —Å–∫—Ä—ã—Ç–æ–π –ø—Ä–æ–≤–æ–¥–∫–∏'],\n    bad: ['–°—Ç–µ–Ω–∞', '–ü–æ—Ç–æ–ª–æ–∫', '–ü–ª–∏—Ç–∫–∞'],\n    descExample: '–†–µ–º–æ–Ω—Ç —Å–∞–Ω—É–∑–ª–∞ —Å –º–æ–Ω—Ç–∞–∂–æ–º –∫–∞—Ä–∫–∞—Å–∞ –∏ —Ä–∞–∑–≤–æ–¥–∫–æ–π —Ç—Ä—É–±',\n    descInstruction: '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ'\n  },\n  'Spanish': {\n    good: ['Tabique pladur 2 capas perfil 70', 'Falso techo desmontable', 'Solado gres porcel√°nico 60x60', 'Pintura pl√°stica 2 manos', 'Mecanismos el√©ctricos empotrados'],\n    bad: ['Pared', 'Techo', 'Azulejos'],\n    descExample: 'Reforma ba√±o con pladur y azulejos',\n    descInstruction: 'Descripci√≥n en espa√±ol'\n  },\n  'French': {\n    good: ['Cloison placo 2 couches ossature 70', 'Plafond suspendu dalles', 'Carrelage gr√®s c√©rame 60x60', 'Peinture acrylique 2 couches', 'Prises √©lectriques encastr√©es'],\n    bad: ['Mur', 'Plafond', 'Carrelage'],\n    descExample: 'R√©novation salle de bain avec placo et carrelage',\n    descInstruction: 'Description en fran√ßais'\n  },\n  'Portuguese': {\n    good: ['Divis√≥ria drywall 2 camadas perfil 70', 'Forro de gesso acartonado', 'Piso porcelanato 60x60', 'Pintura acr√≠lica 2 dem√£os', 'Tomadas el√©tricas embutidas'],\n    bad: ['Parede', 'Teto', 'Piso'],\n    descExample: 'Reforma banheiro com drywall e porcelanato',\n    descInstruction: 'Descri√ß√£o em portugu√™s'\n  },\n  'Chinese': {\n    good: ['ËΩªÈí¢ÈæôÈ™®Áü≥ËÜèÊùøÈöîÂ¢ôÂèåÂ±Ç', 'Áü≥ËÜèÊùøÂêäÈ°∂ÂÆâË£Ö', 'Âú∞Á†ñÈì∫Ë¥¥600x600', '‰π≥ËÉ∂ÊºÜÊ∂ÇÂà∑‰∏§ÈÅç', 'ÊöóË£ÖÁîµÊ∫êÊèíÂ∫ß'],\n    bad: ['Â¢ô', 'È°∂', 'Á†ñ'],\n    descExample: 'Âç´ÁîüÈó¥Ë£Ö‰øÆÔºåÁü≥ËÜèÊùøÈöîÂ¢ôÂíåÁì∑Á†ñÈì∫Ë¥¥',\n    descInstruction: 'Áî®‰∏≠ÊñáÊèèËø∞'\n  },\n  'Arabic': {\n    good: ['ÿ™ÿ±ŸÉŸäÿ® ÿ¨ÿØÿ±ÿßŸÜ ÿ¨ÿ®ÿ≥ ÿ®Ÿàÿ±ÿØ ÿ∑ÿ®ŸÇÿ™ŸäŸÜ', 'ÿ≥ŸÇŸÅ ŸÖÿπŸÑŸÇ ÿ¨ÿ®ÿ≥ ÿ®Ÿàÿ±ÿØ', 'ÿ™ÿ±ŸÉŸäÿ® ÿ®ŸÑÿßÿ∑ ÿ®Ÿàÿ±ÿ≥ŸÑŸäŸÜ 60x60', 'ÿØŸáÿßŸÜ ŸÖÿßÿ¶Ÿä ÿ∑ÿ®ŸÇÿ™ŸäŸÜ', 'ÿ™ÿ±ŸÉŸäÿ® ŸÖŸÇÿßÿ®ÿ≥ ŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ© ŸÖÿÆŸÅŸäÿ©'],\n    bad: ['ÿ¨ÿØÿßÿ±', 'ÿ≥ŸÇŸÅ', 'ÿ®ŸÑÿßÿ∑'],\n    descExample: 'ÿ™ÿ¨ÿØŸäÿØ ÿßŸÑÿ≠ŸÖÿßŸÖ ŸÖÿπ ÿßŸÑÿ¨ÿ®ÿ≥ ÿ®Ÿàÿ±ÿØ ŸàÿßŸÑÿ®ŸÑÿßÿ∑',\n    descInstruction: 'ÿßŸÑŸàÿµŸÅ ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©'\n  },\n  'Hindi': {\n    good: ['‡§°‡•ç‡§∞‡§æ‡§à‡§µ‡•â‡§≤ ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä‡§∂‡§® 2 ‡§≤‡•á‡§Ø‡§∞', '‡§´‡•â‡§≤‡•ç‡§∏ ‡§∏‡•Ä‡§≤‡§ø‡§Ç‡§ó ‡§ú‡§ø‡§™‡•ç‡§∏‡§Æ ‡§¨‡•ã‡§∞‡•ç‡§°', '‡§´‡•ç‡§≤‡•ã‡§∞ ‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ 600x600', '‡§á‡§Æ‡§≤‡•ç‡§∂‡§® ‡§™‡•á‡§Ç‡§ü 2 ‡§ï‡•ã‡§ü', '‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡§ø‡§ï ‡§∏‡•â‡§ï‡•á‡§ü‡•ç‡§∏ ‡§ï‡§Ç‡§∏‡•Ä‡§≤‡•ç‡§°'],\n    bad: ['‡§¶‡•Ä‡§µ‡§æ‡§∞', '‡§õ‡§§', '‡§ü‡§æ‡§á‡§≤'],\n    descExample: '‡§¨‡§æ‡§•‡§∞‡•Ç‡§Æ ‡§∞‡•á‡§®‡•ã‡§µ‡•á‡§∂‡§® ‡§°‡•ç‡§∞‡§æ‡§à‡§µ‡•â‡§≤ ‡§î‡§∞ ‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ ‡§ï‡•á ‡§∏‡§æ‡§•',\n    descInstruction: '‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§µ‡§∞‡§£'\n  }\n};\n\nconst langConfig = LANG_CONFIG[searchLang] || LANG_CONFIG['English'];\n\nconst prompt = `You are an expert construction cost estimator.\n\nCRITICAL LANGUAGE REQUIREMENT:\n- ALL your output MUST be ONLY in ${searchLang} language\n- The \"description\" field MUST be in ${searchLang} (${langConfig.descInstruction})\n- All \"name\" fields MUST be in ${searchLang}\n- Do NOT use English or any other language anywhere in your response\n\nAnalyze these photos and identify construction work items.\n\nGOOD QUERIES (specific, searchable) in ${searchLang}:\n${langConfig.good.map(e => '‚úì ' + e).join('\\n')}\n\nBAD QUERIES (too generic, avoid):\n${langConfig.bad.map(e => '‚úó ' + e).join('\\n')}\n\n${description ? 'CONTEXT: ' + description : ''}\n\nRULES:\n1. List ONLY what you can ACTUALLY SEE in the photos\n2. Use SPECIFIC technical terms in ${searchLang} like the good examples above\n3. Include materials, dimensions, specifications when visible\n4. Estimate quantities based on photo scale\n5. Write \"description\" field in ${searchLang} language\n\nFor each work item:\n- name: Specific ${searchLang} construction term (like good examples above)\n- qty: Estimated quantity (number)\n- unit: m¬≤ / m / pcs / kg\n- conf: high (clearly visible) / medium (partially visible)\n- cat: demolition / rough / finishing / mep\n\nEXAMPLE RESPONSE in ${searchLang}:\n{\"description\":\"${langConfig.descExample}\",\"items\":[{\"name\":\"${langConfig.good[0]}\",\"qty\":10,\"unit\":\"m¬≤\",\"conf\":\"high\",\"cat\":\"finishing\"}]}\n\nRespond ONLY with valid JSON. Remember: ALL text must be in ${searchLang}!`;\n\nlet requestBody, apiUrl, apiKey;\n\nif (provider === 'openai') {\n  apiUrl = 'https://generativelanguage.googleapis.com/v1beta/openai/chat/completions';\n  apiKey = openaiKey;\n  \n  const content = [{ type: 'text', text: prompt }];\n  \n  for (const photo of photos) {\n    if (photo.base64) {\n      content.push({\n        type: 'image_url',\n        image_url: {\n          url: 'data:image/jpeg;base64,' + photo.base64,\n          detail: 'high'\n        }\n      });\n    }\n  }\n  \n  requestBody = {\n    model: 'gpt-4o',\n    max_tokens: 4000,\n    temperature: 0.4,\n    messages: [\n      { role: 'system', content: `You are an expert construction cost estimator. CRITICAL: You MUST respond ONLY in ${searchLang} language. The \"description\" field and all \"name\" fields MUST be written in ${searchLang}. Do NOT use English. Respond only with valid JSON.` },\n      { role: 'user', content: content }\n    ]\n  };\n  \n} else {\n  apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + geminiKey;\n  apiKey = geminiKey;\n  \n  const parts = [];\n  \n  for (const photo of photos) {\n    if (photo.base64) {\n      parts.push({\n        inline_data: {\n          mime_type: 'image/jpeg',\n          data: photo.base64\n        }\n      });\n    }\n  }\n  \n  parts.push({ text: prompt });\n  \n  requestBody = {\n    contents: [{ parts: parts }],\n    generationConfig: {\n      temperature: 0.4,\n      maxOutputTokens: 4000\n    }\n  };\n}\n\nconsole.log('API URL:', apiUrl ? apiUrl.substring(0, 60) + '...' : 'EMPTY');\nconsole.log('Photos in request:', photos.length);\nconsole.log('Language:', searchLang);\n\nreturn { json: { \n  ...input, \n  provider: provider,\n  apiUrl: apiUrl,\n  apiKey: apiKey,\n  requestBody: requestBody \n}};"
      },
      "id": "9e29ecc5-8174-4f0d-8a27-a83a18a6d87d",
      "name": "Prep Vision1",
      "type": "n8n-nodes-base.code",
      "position": [
        3072,
        -768
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Convert downloaded photo to base64 for Vision API\n// FIXED: Save base64 to session for Refine Analysis\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst prepData = $('Prep Photo Download').first().json;\nconst binaryData = $input.first().binary;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(prepData.chatId);\n\nconsole.log('=== CONVERT TO BASE64 ===');\nconsole.log('chatId:', cid);\nconsole.log('Binary data keys:', Object.keys(binaryData || {}));\n\nconst photos = [];\n\nif (binaryData) {\n  const binaryKey = Object.keys(binaryData)[0];\n  if (binaryKey && binaryData[binaryKey]) {\n    const item = binaryData[binaryKey];\n    console.log('Binary item keys:', Object.keys(item));\n    \n    if (item.data) {\n      photos.push({\n        base64: item.data,\n        caption: ''\n      });\n      console.log('‚úÖ SUCCESS: Base64 length:', item.data.length);\n    }\n  }\n}\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –°–û–•–†–ê–ù–Ø–ï–ú base64 –≤ —Å–µ—Å—Å–∏—é –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (Refine Analysis)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = { lang: prepData.lang };\nsd.sess[cid].photos_base64 = photos;\nconsole.log('‚úÖ Saved base64 to session for chat:', cid, 'photos:', photos.length);\n\nconst L = prepData.L || sd.sess[cid]?.L || {};\n\nreturn { json: { \n  chatId: prepData.chatId,\n  bot_token: prepData.bot_token,\n  photos: photos,\n  photoCount: photos.length,\n  description: prepData.description || '',\n  L: L,\n  lang: prepData.lang,\n  skipVision: false\n}};"
      },
      "id": "af9d6c09-6e67-4817-a338-c77c8dfd15c3",
      "name": "Convert To Base",
      "type": "n8n-nodes-base.code",
      "position": [
        2736,
        -768
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/file/bot{{ $('üîë TOKEN').first().json.bot_token }}/{{ $json.result.file_path }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "3e7ae138-391a-4697-84ab-b70af5ee4566",
      "name": "Download Photo File1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2544,
        -768
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/getFile?file_id={{ $json.fileId }}",
        "options": {}
      },
      "id": "1082769f-7e07-4199-ac5c-13af90e673bc",
      "name": "Get File Path1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2368,
        -768
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Use stored base64 images from session\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst input = $input.first().json;\nconst cid = String(input.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\n\nconsole.log('=== USE STORED BASE64 ===');\nconsole.log('input.photos:', input.photos?.length || 0);\n\nconst photos = input.photos || [];\n\nif (photos.length === 0) {\n  console.log('‚ùå No photos in input');\n  return { json: { ...input, skipVision: true, noPhotos: true } };\n}\n\nconsole.log('‚úÖ Using', photos.length, 'stored photos');\nconsole.log('First photo base64 length:', photos[0]?.base64?.length || 0);\n\nreturn { json: { \n  chatId: input.chatId,\n  bot_token: input.bot_token,\n  photos: photos,\n  photoCount: photos.length,\n  description: input.description || session.description || '',\n  L: input.L || session.L || {},\n  lang: input.lang || session.lang,\n  skipVision: false,\n  noPhotos: false\n}};"
      },
      "id": "fad1da7a-9b79-4a5d-ba69-ec6f30876878",
      "name": "Use Stored Base64",
      "type": "n8n-nodes-base.code",
      "position": [
        2736,
        -928
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "operator": {
                "type": "boolean",
                "operation": "equals"
              },
              "leftValue": "={{ $json.skipDownload }}",
              "rightValue": true
            }
          ]
        },
        "options": {}
      },
      "id": "b7dbb4af-4247-4e8c-a2ca-cd26b58f0473",
      "name": "IF Skip Download",
      "type": "n8n-nodes-base.if",
      "position": [
        2176,
        -976
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// STEP 8: Calculate - FIXED VERSION v3\n// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ö\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst inputData = $input.first().json;\n\nconsole.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\nconsole.log('STEP 8: CALCULATE v3');\nconsole.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –£–ú–ù–´–ô –ü–û–ò–°–ö PAYLOAD - –∏—â–µ–º –≤–æ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nlet payload = null;\nlet payloadSource = 'not_found';\n\n// –í–∞—Ä–∏–∞–Ω—Ç 1: _best_result.payload\nif (inputData._best_result?.payload?.rate_code) {\n  payload = inputData._best_result.payload;\n  payloadSource = '_best_result.payload';\n}\n// –í–∞—Ä–∏–∞–Ω—Ç 2: _best_payload –Ω–∞–ø—Ä—è–º—É—é\nelse if (inputData._best_payload?.rate_code) {\n  payload = inputData._best_payload;\n  payloadSource = '_best_payload';\n}\n// –í–∞—Ä–∏–∞–Ω—Ç 3: –¥–∞–Ω–Ω—ã–µ –ª–µ–∂–∞—Ç –ø—Ä—è–º–æ –≤ _best_result (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ payload)\nelse if (inputData._best_result?.rate_code) {\n  payload = inputData._best_result;\n  payloadSource = '_best_result (direct)';\n}\n// –í–∞—Ä–∏–∞–Ω—Ç 4: payload –≤–Ω—É—Ç—Ä–∏ payload (–¥–≤–æ–π–Ω–∞—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å)\nelse if (inputData._best_result?.payload?.payload?.rate_code) {\n  payload = inputData._best_result.payload.payload;\n  payloadSource = '_best_result.payload.payload';\n}\n// –í–∞—Ä–∏–∞–Ω—Ç 5: –∏—â–µ–º rate_code –≥–¥–µ —É–≥–æ–¥–Ω–æ –≤ _best_result\nelse if (inputData._best_result) {\n  const br = inputData._best_result;\n  // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫\n  const findPayload = (obj, depth = 0) => {\n    if (!obj || depth > 3) return null;\n    if (obj.rate_code && obj.resources) return obj;\n    for (const key of Object.keys(obj)) {\n      if (typeof obj[key] === 'object' && obj[key] !== null) {\n        const found = findPayload(obj[key], depth + 1);\n        if (found) return found;\n      }\n    }\n    return null;\n  };\n  payload = findPayload(br);\n  if (payload) payloadSource = '_best_result (deep search)';\n}\n\nconsole.log('Payload source:', payloadSource);\nconsole.log('Payload found:', !!payload);\n\nif (payload) {\n  console.log('Payload keys:', Object.keys(payload));\n  console.log('rate_code:', payload.rate_code);\n  console.log('rate_name:', payload.rate_name?.substring(0, 50));\n  console.log('resources count:', (payload.resources || []).length);\n  console.log('cost_summary:', JSON.stringify(payload.cost_summary || {}).substring(0, 200));\n}\n\n// –ï—Å–ª–∏ payload –Ω–µ –Ω–∞–π–¥–µ–Ω - –≤—ã–≤–æ–¥–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏\nif (!payload) {\n  console.log('');\n  console.log('‚ùå PAYLOAD NOT FOUND! Debug info:');\n  console.log('inputData keys:', Object.keys(inputData));\n  if (inputData._best_result) {\n    console.log('_best_result keys:', Object.keys(inputData._best_result));\n    console.log('_best_result.payload:', typeof inputData._best_result.payload);\n    if (inputData._best_result.payload) {\n      console.log('_best_result.payload keys:', Object.keys(inputData._best_result.payload));\n    }\n  }\n  \n  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π\n  return [{ json: { \n    ...inputData,\n    rate_code: 'PAYLOAD_NOT_FOUND',\n    rate_name: inputData.name || inputData.sq || 'Unknown',\n    uc: 0, tc: 0,\n    resources: [],\n    _debug_keys: Object.keys(inputData),\n    _debug_best_result_keys: Object.keys(inputData._best_result || {}),\n    _debug_payload_source: payloadSource\n  }}];\n}\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –¢–µ–ø–µ—Ä—å payload –Ω–∞–π–¥–µ–Ω - –∏–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã\nconst workName = inputData.name || inputData.sq || '';\nconst workQty = inputData.qty || 1;\nconst workUnit = inputData.unit || 'm¬≤';\n\nconsole.log('');\nconsole.log('Work:', workName);\nconsole.log('Qty:', workQty, workUnit);\n\n// –î–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ü–µ–Ω–∫–∏\nconst rateCode = payload.rate_code || 'NOT_FOUND';\nconst rateName = payload.rate_name || workName;\nconst rateUnit = payload.rate_unit || '';\n\nconsole.log('Rate code:', rateCode);\nconsole.log('Rate name:', rateName?.substring(0, 50));\nconsole.log('Rate unit:', rateUnit);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –ü–æ–ª—É—á–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst costSummary = payload.cost_summary || {};\nlet totalCost = parseFloat(costSummary.total_cost_position || costSummary.total_cost || 0);\n\n// –ï—Å–ª–∏ cost_summary –ø—É—Å—Ç–æ–π, –≤—ã—á–∏—Å–ª—è–µ–º –∏–∑ —Ä–µ—Å—É—Ä—Å–æ–≤\nconst rawResources = payload.resources || [];\nif (totalCost === 0 && rawResources.length > 0) {\n  totalCost = rawResources.reduce((sum, r) => {\n    return sum + parseFloat(r.resource_cost_eur || 0);\n  }, 0);\n  console.log('Total cost calculated from resources:', totalCost);\n}\n\nconsole.log('Total cost:', totalCost);\nconsole.log('Resources count:', rawResources.length);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–ª–∏—Ç–µ–ª—å –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nlet unitDivisor = 1;\nconst rateUnitLower = (rateUnit || '').toLowerCase();\n\nif (rateUnitLower.includes('100 ') || rateUnitLower === '100 –º' || rateUnitLower === '100 –º¬≤' || rateUnitLower === '100 –º2') {\n  unitDivisor = 100;\n} else if (rateUnitLower.match(/^10\\s/) || rateUnitLower.includes('10 –º')) {\n  unitDivisor = 10;\n}\n\nconsole.log('Unit divisor:', unitDivisor);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Price calculation\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst uc = unitDivisor > 0 ? totalCost / unitDivisor : 0;\nconst tc = workQty * uc;\nconst scaleFactor = unitDivisor > 0 ? workQty / unitDivisor : workQty;\n\nconsole.log('');\nconsole.log('=== PRICE CALCULATION ===');\nconsole.log('UC (price per unit):', uc.toFixed(2), 'EUR');\nconsole.log('TC (total cost):', tc.toFixed(2), 'EUR');\nconsole.log('Scale factor:', scaleFactor);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nlet workersTotal = 0;\nlet materialsTotal = 0;\nlet machinesTotal = 0;\nlet laborHoursTotal = 0;\n\nconst resources = rawResources.map(r => {\n  const code = r.resource_code || '';\n  const name = r.resource_name || '';\n  const unit = r.resource_unit || '';\n  const rowType = r.row_type || '';\n  \n  const originalQty = r.resource_quantity !== null && r.resource_quantity !== undefined \n    ? parseFloat(r.resource_quantity) \n    : null;\n  const pricePerUnit = parseFloat(r.resource_price_per_unit_eur_current || 0);\n  const originalCost = parseFloat(r.resource_cost_eur || 0);\n  \n  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ä–µ—Å—É—Ä—Å–∞\n  let resourceType = 'material';\n  const rowTypeLower = (rowType || '').toLowerCase();\n  const codeUpper = (code || '').toUpperCase();\n  \n  if (rowTypeLower === '–º–∞—à–∏–Ω–∏—Å—Ç' || rowTypeLower.includes('–º–∞—à–∏–Ω–∏—Å—Ç')) {\n    resourceType = 'labor';\n  } else if (rowTypeLower === '—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ' || rowTypeLower.includes('—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤')) {\n    resourceType = 'machine';\n  } else if (codeUpper.startsWith('DXME') || codeUpper.startsWith('DX')) {\n    resourceType = 'machine';\n  } else if (codeUpper.startsWith('ME_') || codeUpper.startsWith('PU_') || codeUpper.startsWith('RI_')) {\n    resourceType = 'labor';\n  }\n  \n  // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ\n  let scaledQty = null;\n  let scaledCost = 0;\n  \n  if (originalQty !== null) {\n    scaledQty = originalQty * scaleFactor;\n    scaledCost = scaledQty * pricePerUnit;\n  } else {\n    scaledCost = originalCost * scaleFactor;\n  }\n  \n  // –°—É–º–º–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n  if (resourceType === 'labor') {\n    workersTotal += scaledCost;\n    if (unit === '—á' || unit === '—á–µ–ª.-—á' || unit === '—á–µ–ª-—á' || unit === '–º–∞—à.-—á') {\n      laborHoursTotal += scaledQty || 0;\n    }\n  } else if (resourceType === 'machine') {\n    machinesTotal += scaledCost;\n  } else {\n    materialsTotal += scaledCost;\n  }\n  \n  return {\n    resource_code: code,\n    resource_name: name,\n    resource_unit: unit,\n    resource_type: resourceType,\n    row_type: rowType,\n    resource_price: pricePerUnit,\n    original_quantity: originalQty,\n    original_cost: originalCost,\n    scaled_quantity: scaledQty,\n    scaled_cost: scaledCost\n  };\n});\n\nconsole.log('');\nconsole.log('=== RESOURCES BREAKDOWN ===');\nconsole.log('Resources processed:', resources.length);\nconsole.log('Workers total:', workersTotal.toFixed(2), 'EUR');\nconsole.log('Materials total:', materialsTotal.toFixed(2), 'EUR');\nconsole.log('Machines total:', machinesTotal.toFixed(2), 'EUR');\nconsole.log('Labor hours:', laborHoursTotal.toFixed(1), 'h');\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Scope of work\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst workSteps = payload.work_steps || [];\nconst scopeOfWork = workSteps.map(s => s.text || '').filter(t => t.length > 0);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Quality\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst llmScore = inputData._llm_score || 0;\nconst qdrantScore = inputData._qdrant_score || 0;\n\nconst qualityLevel = llmScore >= 75 ? 'high' : \n                     llmScore >= 50 ? 'medium' : \n                     llmScore >= 25 ? 'low' : 'not_found';\n\nconsole.log('');\nconsole.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\nconsole.log('‚úÖ CALCULATION COMPLETE');\nconsole.log('Rate:', rateCode, '-', rateName?.substring(0, 40));\nconsole.log('Total:', tc.toFixed(2), 'EUR');\nconsole.log('Resources:', resources.length);\nconsole.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –§–ò–ù–ê–õ–¨–ù–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nreturn [{ json: { \n  // Original data\n  ...inputData,\n  name: workName,\n  qty: workQty,\n  unit: workUnit,\n  \n  // Rate\n  rate_code: rateCode,\n  rate_name: rateName,\n  rate_unit: workUnit,\n  original_rate_unit: rateUnit,\n  \n  // Prices\n  uc,\n  tc,\n  \n  // Labor\n  labor_hours: laborHoursTotal,\n  workers_total: workersTotal,\n  machines_total: machinesTotal,\n  materials_total: materialsTotal,\n  \n  // Quality\n  ql: qualityLevel,\n  quality_score: llmScore,\n  qdrant_score: qdrantScore,\n  llm_score: llmScore,\n  llm_reason: inputData._llm_reason || '',\n  \n  // Resources\n  resources,\n  \n  // Scope of work\n  scope_of_work: scopeOfWork,\n  \n  // Hierarchy\n  hierarchy: payload.hierarchy || {},\n  \n  // Breakdown\n  cost_breakdown: { \n    workers: workersTotal, \n    machines: machinesTotal, \n    materials: materialsTotal \n  },\n  \n  // Debug\n  _payload_source: payloadSource,\n  _scale_factor: scaleFactor,\n  _unit_divisor: unitDivisor,\n  _original_total_cost: totalCost\n}}];"
      },
      "id": "092ec133-3fbc-4731-a778-3984858a22e1",
      "name": "9Ô∏è‚É£ Calculate",
      "type": "n8n-nodes-base.code",
      "position": [
        2544,
        848
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// 8Ô∏è‚É£ APPLY RERANK v4 - Enhanced result selection\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst prepData = $('6Ô∏è‚É£ Prep Rerank').first().json;\nconst llmResponse = $input.first().json;\n\nconsole.log('=== APPLY RERANK v4 ===');\n\nconst qdrantResults = prepData._qdrant_results || [];\n\nlet rankings = [];\ntry {\n  let text = llmResponse.choices?.[0]?.message?.content || '';\n  // Clear –æ—Ç markdown –∏ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤\n  text = text.replace(/```json\\n?/g, '').replace(/```/g, '').trim();\n  \n  // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ JSON\n  const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    const parsed = JSON.parse(jsonMatch[0]);\n    rankings = parsed.rankings || [];\n    console.log('Parsed rankings:', rankings.length);\n  }\n} catch(e) {\n  console.log('Parse error:', e.message);\n  // Fallback - –∏—Å–ø–æ–ª—å–∑—É–µ–º Qdrant scores\n  rankings = qdrantResults.map((r, i) => ({\n    index: i,\n    score: Math.round((r.score || 0) * 100),\n    reason: 'qdrant score'\n  }));\n}\n\n// –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º LLM –∏ Qdrant scores\nconst scored = qdrantResults.map((r, i) => {\n  const p = r.payload || {};\n  const rank = rankings.find(x => x.index === i);\n  const llmScore = rank?.score || 0;\n  const reason = rank?.reason || '';\n  const qdrantScore = (r.score || 0) * 100;\n  \n  // Weighted combination: LLM –≤–∞–∂–Ω–µ–µ –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ Qdrant\n  let combinedScore;\n  if (llmScore > 0) {\n    // LLM 70% + Qdrant 30%\n    combinedScore = llmScore * 0.7 + qdrantScore * 0.3;\n  } else {\n    combinedScore = qdrantScore;\n  }\n  \n  console.log('[' + i + '] LLM=' + llmScore + ' Qdrant=' + qdrantScore.toFixed(0) + ' Combined=' + combinedScore.toFixed(0) + ' - ' + (p.rate_code || 'N/A'));\n  \n  return {\n    ...r,\n    payload: p,\n    llm_score: llmScore,\n    llm_reason: reason,\n    qdrant_score: r.score || 0,\n    combined_score: combinedScore\n  };\n});\n\n// Sort –ø–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É score\nscored.sort((a, b) => b.combined_score - a.combined_score);\n\nconst best = scored[0];\nconst bestPayload = best?.payload || {};\n\n// Determine quality —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞\nlet qualityLevel = 'not_found';\nif (best.combined_score >= 80) qualityLevel = 'high';\nelse if (best.combined_score >= 60) qualityLevel = 'medium';\nelse if (best.combined_score >= 40) qualityLevel = 'low';\n\nconsole.log('');\nconsole.log('‚úÖ BEST: ' + bestPayload.rate_code + ' - ' + (bestPayload.rate_name || '').substring(0, 50));\nconsole.log('   Combined: ' + best.combined_score.toFixed(0) + ' | Quality: ' + qualityLevel);\nconsole.log('   Reason: ' + best.llm_reason);\n\nreturn [{ json: {\n  ...prepData,\n  _best_result: best,\n  _best_payload: bestPayload,\n  _llm_score: best?.llm_score || 0,\n  _llm_reason: best?.llm_reason || '',\n  _qdrant_score: best?.qdrant_score || 0,\n  _quality_level: qualityLevel,\n  ql: qualityLevel,\n  _openai_key: prepData._openai_key,\n  _step: 'rerank_done'\n}}];"
      },
      "id": "1cf90340-2c3f-4640-9a25-f43ae5f6f942",
      "name": "8Ô∏è‚É£ Apply Rerank",
      "type": "n8n-nodes-base.code",
      "position": [
        2352,
        848
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/openai/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json._openai_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gemini-2.5-flash\",\n  \"messages\": [\n    {\"role\": \"system\", \"content\": \"You are a construction cost database expert. Respond ONLY with valid JSON, no markdown.\"},\n    {\"role\": \"user\", \"content\": {{ JSON.stringify($json._rerank_prompt) }}}\n  ],\n  \"temperature\": 0.1,\n  \"max_tokens\": 500\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          },
          "timeout": 30000
        }
      },
      "id": "229d1385-5dda-4b7d-bc60-e22b1633843b",
      "name": "7Ô∏è‚É£ LLM Rerank",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        3264,
        656
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// 6Ô∏è‚É£ PREP RERANK v4 - Enhanced semantic matching\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst prepData = $('4Ô∏è‚É£ Extract Embedding').first().json;\nconst qdrantResponse = $input.first().json;\n\nconsole.log('=== PREP RERANK v4 ===');\n\nif (qdrantResponse.status?.error) {\n  return [{ json: { ...prepData, rate_code: 'QDRANT_ERROR', uc: 0, tc: 0, ql: 'not_found', resources: [] }}];\n}\n\nconst results = qdrantResponse.result || [];\nconsole.log('Qdrant results:', results.length);\n\nif (results.length === 0) {\n  return [{ json: { ...prepData, rate_code: 'NOT_FOUND', rate_name: prepData._original_query, uc: 0, tc: 0, ql: 'not_found', resources: [] }}];\n}\n\nconst originalQuery = prepData._original_query || prepData.name || '';\nconst workUnit = prepData.unit || 'm¬≤';\nconst workQty = prepData.qty || 1;\n\n// Format –∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤\nconst candidates = results.slice(0, 5).map((r, i) => {\n  const p = r.payload || {};\n  const code = p.rate_code || '';\n  const name = p.rate_name || '';\n  const unit = p.rate_unit || '';\n  \n  // Scope of work\n  const workSteps = p.work_steps || [];\n  const scopeText = workSteps.slice(0, 3).map(s => s.text).join('; ');\n  \n  // Key materials\n  const resources = p.resources || [];\n  const materials = resources\n    .filter(r => !r.resource_code?.match(/^(DXME|ME_|PU_|RI_)/))\n    .slice(0, 3)\n    .map(r => r.resource_name)\n    .join(', ');\n  \n  const qdrantScore = (r.score * 100).toFixed(0);\n  \n  console.log('[' + i + '] ' + code + ' - ' + name?.substring(0, 40) + ' | ' + qdrantScore + '%');\n  \n  return i + '. [' + code + '] ' + name + '\\n   Unit: ' + unit + ' | Scope: ' + (scopeText || 'n/a').substring(0, 100) + '\\n   Materials: ' + (materials || 'n/a');\n}).join('\\n\\n');\n\nconst rerankPrompt = `TASK: Score construction rate candidates (0-100) for matching user's work request.\n\nSCORING GUIDE:\n95-100: EXACT MATCH - Same work type, method, materials, unit compatible\n80-94: VERY GOOD - Same work, minor spec differences (thickness, brand)\n65-79: GOOD - Same category, different specification\n50-64: PARTIAL - Related work, different scope\n30-49: WEAK - Same trade, different work type\n0-29: WRONG - Different trade or unrelated\n\nCRITICAL DISTINCTIONS:\n‚Ä¢ –ì–ö–õ (–≥–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω) ‚â† –ì–í–õ (–≥–∏–ø—Å–æ–≤–æ–ª–æ–∫–Ω–æ) - DIFFERENT materials, max 60\n‚Ä¢ –°—Ç–µ–Ω—ã ‚â† –ü–æ—Ç–æ–ª–æ–∫ - check work location matches\n‚Ä¢ –ú–æ–Ω—Ç–∞–∂ ‚â† –î–µ–º–æ–Ω—Ç–∞–∂ - opposite operations\n‚Ä¢ 1 —Å–ª–æ–π ‚â† 2 —Å–ª–æ—è - check layer count\n‚Ä¢ Profile types: –ü–ü60 = ceiling, –ü–° = wall stud, –ü–ù = guide\n\nUNIT MATCHING:\n‚Ä¢ Query unit: ${workUnit}\n‚Ä¢ Rate unit should be compatible or convertible\n‚Ä¢ m¬≤ work ‚Üí m¬≤ rate (ideal)\n‚Ä¢ m¬≤ work ‚Üí 100m¬≤ rate (ok, will scale)\n\nUSER REQUEST: \"${originalQuery}\" (${workQty} ${workUnit})\n\nCANDIDATES:\n${candidates}\n\nReturn ONLY valid JSON (no markdown):\n{\"rankings\":[{\"index\":0,\"score\":N,\"reason\":\"brief reason\"},{\"index\":1,\"score\":N,\"reason\":\"brief reason\"}]}`;\n\nconsole.log('Prompt length:', rerankPrompt.length);\n\nreturn [{ json: {\n  ...prepData,\n  _qdrant_results: results,\n  _rerank_prompt: rerankPrompt,\n  _openai_key: prepData._openai_key,\n  _step: 'prep_rerank_done'\n}}];"
      },
      "id": "0492571b-4546-4854-b423-77afc6f8e44c",
      "name": "6Ô∏è‚É£ Prep Rerank",
      "type": "n8n-nodes-base.code",
      "position": [
        3088,
        656
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json._qdrant_url }}/collections/{{ $json._collection }}/points/search",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api-key",
              "value": "={{ $json._qdrant_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"vector\": {{ JSON.stringify($json._embedding) }},\n  \"limit\": 10,\n  \"with_payload\": true,\n  \"with_vector\": false\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          },
          "timeout": 30000
        }
      },
      "id": "07f0f6f9-c7bc-4a97-8548-f545a63eac2c",
      "name": "5Ô∏è‚É£ Qdrant Search",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2912,
        656
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// EXTRACT EMBEDDING - Get vector from OpenAI response\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst prepData = $('2Ô∏è‚É£ Extract Transform').first().json;\nconst embResponse = $input.first().json;\n\nconsole.log('=== EXTRACT EMBEDDING ===');\n\nif (embResponse.error) {\n  console.log('OpenAI Error:', embResponse.error.message);\n  return [{ json: { ...prepData, _error: embResponse.error.message, _embedding: [] }}];\n}\n\nconst embedding = embResponse.data?.[0]?.embedding || [];\nconsole.log('Embedding length:', embedding.length);\n\nif (embedding.length !== 3072) {\n  console.log('WARNING: Expected 3072, got', embedding.length);\n}\n\n// Pass all data including Qdrant credentials\nreturn [{ json: {\n  ...prepData,\n  _embedding: embedding,\n  _collection: prepData._collection,\n  _qdrant_url: prepData._qdrant_url,\n  _qdrant_key: prepData._qdrant_key,\n  _openai_key: prepData._openai_key,\n  _step: 'embedding_done'\n}}];"
      },
      "id": "c34a14b4-53fa-4ad0-9627-337e5c2e6547",
      "name": "4Ô∏è‚É£ Extract Embedding",
      "type": "n8n-nodes-base.code",
      "position": [
        2752,
        656
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/openai/embeddings",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json._openai_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gemini-embedding-001\",\n  \"input\": {{ JSON.stringify($json._query) }},\n  \"dimensions\": 3072\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          },
          "timeout": 30000
        }
      },
      "id": "bc108793-b267-4186-ba42-d1b1c1620338",
      "name": "3Ô∏è‚É£ OpenAI Embedding",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        2544,
        656
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// EXTRACT TRANSFORM - Clean LLM response and combine queries\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst prepData = $('1Ô∏è‚É£ Prep Query').first().json;\nconst llmResponse = $input.first().json;\n\nconsole.log('=== EXTRACT TRANSFORM ===');\n\nlet transformedQuery = prepData._original_query;\n\ntry {\n  const content = llmResponse.choices?.[0]?.message?.content || '';\n  if (content && content.length > 5) {\n    transformedQuery = content\n      .replace(/^(keywords?:|search:|query:|result:)/i, '')\n      .replace(/[\\n\\r]+/g, ' ')\n      .trim();\n    console.log('Transformed OK');\n  }\n} catch(e) {\n  console.log('Transform failed:', e.message);\n}\n\nconsole.log('Original:', prepData._original_query);\nconsole.log('Transformed:', transformedQuery.substring(0, 80));\n\n// Smart combination - original is more important\nconst originalWords = prepData._original_query.toLowerCase().split(/\\s+/);\nconst transformedWords = transformedQuery.toLowerCase().split(/\\s+/);\n\n// Add only new words from transformation\nconst newWords = transformedWords.filter(w => \n  w.length > 2 && !originalWords.some(ow => ow.includes(w) || w.includes(ow))\n);\n\nconst combinedQuery = prepData._original_query + ' ' + newWords.slice(0, 10).join(' ');\n\nconsole.log('Combined:', combinedQuery.substring(0, 100));\n\n// Pass all data including Qdrant credentials\nreturn [{ json: {\n  ...prepData,\n  _query: combinedQuery.trim(),\n  _transformed_query: transformedQuery,\n  _collection: prepData._collection,\n  _qdrant_url: prepData._qdrant_url,\n  _qdrant_key: prepData._qdrant_key,\n  _openai_key: prepData._openai_key,\n  _step: 'transform_done'\n}}];"
      },
      "id": "979de0f3-7375-4dd7-8953-dcb9300d26c3",
      "name": "2Ô∏è‚É£ Extract Transform",
      "type": "n8n-nodes-base.code",
      "position": [
        2352,
        656
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/openai/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json._openai_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gemini-2.5-flash\",\n  \"messages\": [{\"role\": \"user\", \"content\": {{ JSON.stringify($json._transform_prompt) }}}],\n  \"temperature\": 0.3,\n  \"max_tokens\": 200\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          },
          "timeout": 30000
        }
      },
      "id": "0a7c0db3-c551-4d88-b09f-0e1cd23324ff",
      "name": "1.5Ô∏è‚É£ LLM Transform",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        3264,
        448
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Parse Text LLM Response\n// Extract works from LLM API response\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst prepData = $('Prep Text LLM').first().json;\nconst apiResponse = $input.first().json;\nconst cid = String(prepData.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst L = prepData.L || {};\nconst provider = prepData._llm_provider || 'gemini';\n\nconsole.log('=== PARSE TEXT LLM ===');\nconsole.log('Provider:', provider);\n\nlet works = [];\nlet rawContent = '';\n\ntry {\n  // Extract text based on provider\n  if (provider === 'openai') {\n    rawContent = apiResponse.choices?.[0]?.message?.content || '';\n  } else {\n    rawContent = apiResponse.candidates?.[0]?.content?.parts?.[0]?.text || '';\n  }\n  \n  console.log('Raw response length:', rawContent.length);\n  console.log('Raw response preview:', rawContent.substring(0, 200));\n  \n  if (rawContent) {\n    // Clean and parse JSON\n    let cleanContent = rawContent\n      .replace(/```json\\s*/gi, '')\n      .replace(/```\\s*/gi, '')\n      .replace(/^[^\\[]*/, '')  // Remove anything before [\n      .trim();\n    \n    const jsonStart = cleanContent.indexOf('[');\n    const jsonEnd = cleanContent.lastIndexOf(']');\n    \n    if (jsonStart !== -1 && jsonEnd !== -1) {\n      const jsonStr = cleanContent.substring(jsonStart, jsonEnd + 1);\n      console.log('JSON to parse:', jsonStr.substring(0, 200));\n      works = JSON.parse(jsonStr);\n      console.log('Parsed works count:', works.length);\n    }\n  }\n} catch(e) {\n  console.log('Parse error:', e.message);\n}\n\n// Validate and normalize\nconst validWorks = (works || [])\n  .filter(w => w && w.name && String(w.name).length > 2)\n  .map((w, i) => ({\n    id: 'W' + String(i + 1).padStart(3, '0'),\n    seq: i + 1,\n    name: String(w.name).substring(0, 80).trim(),\n    query: String(w.name).substring(0, 80).trim(),\n    qty: Math.max(0.1, parseFloat(w.qty) || 1),\n    unit: ['m¬≤', 'm', 'pcs', 'kg', 'l', '—à—Ç', '–º¬≤', '–º', 'St', 'Stk'].includes(w.unit) ? w.unit : 'm¬≤',\n    room: w.room || '',\n    conf: 'medium',\n    cat: 'finishing'\n  }));\n\nconsole.log('Valid works:', validWorks.length);\n\n// Save to session\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = { lang: prepData.lang };\nsd.sess[cid].works = validWorks;\nsd.sess[cid].description = prepData.description || '';\nsd.sess[cid].state = 'wait_edit';\nsd.sess[cid].db = prepData.db;\nsd.sess[cid].L = L;\n\nreturn { json: { \n  ...prepData,\n  chatId: cid, \n  works: validWorks,\n  description: prepData.description || '',\n  L\n}};"
      },
      "id": "7770623f-506d-4056-8ea6-51aa5963b8b7",
      "name": "Parse Text LLM",
      "type": "n8n-nodes-base.code",
      "position": [
        1248,
        -640
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify($json.msg) }},\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [\n      [{\"text\": \"{{ $json.L.btn_export_excel || '‚Üì Excel' }}\", \"callback_data\": \"export_excel\"}, {\"text\": \"{{ $json.L.btn_export_pdf || '‚Üì PDF' }}\", \"callback_data\": \"export_pdf\"}],\n      [{\"text\": \"{{ $json.L.btn_restart || '‚Üª Restart' }}\", \"callback_data\": \"restart\"}]\n    ]\n  }\n}",
        "options": {}
      },
      "id": "ddff15ab-c198-4080-8833-0bfa1b4d38c6",
      "name": "üì§ Details",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1232,
        448
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// Detailed view with resource prices\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst data = sd.lastResults || {};\nconst L = data.L || cfg.L || {};\nconst works = data.works || [];\nconst sym = L.sym || '‚Ç¨';\n\nfunction fmtCur(v) { \n  if (!v || v === 0) return sym + ' 0';\n  return sym + ' ' + v.toFixed(2); \n}\n\nlet msg = `*${L.ready} ‚Äî ${L.resources}*\\n\\n`;\n\nworks.forEach((w, i) => {\n  const qi = { 'high': '‚óè', 'medium': '‚óã', 'low': '‚óå', 'not_found': '‚úï' }[w.ql] || '‚óã';\n  \n  msg += `*${i+1}. ${w.name}*\\n`;\n  if (w.rate_code && w.rate_code !== 'NOT_FOUND') {\n    msg += `${qi} \\`${w.rate_code}\\`\\n`;\n    if (w.rate_name && w.rate_name !== w.name) {\n      const rateName = (w.rate_name || '').substring(0, 45);\n      msg += `_${rateName}_\\n`;\n    }\n  } else {\n    msg += `${qi} _${L.not_found}_\\n`;\n  }\n  msg += `${w.qty} ${w.unit} √ó ${fmtCur(w.uc)} = *${fmtCur(w.tc)}*\\n`;\n  \n  // Cost breakdown\n  const parts = [];\n  if (w.workers_total > 0) parts.push(`${L.workers}: ${fmtCur(w.workers_total)}`);\n  if (w.materials_total > 0) parts.push(`${L.materials}: ${fmtCur(w.materials_total)}`);\n  if (w.machines_total > 0) parts.push(`${L.machines}: ${fmtCur(w.machines_total)}`);\n  if (parts.length > 0) msg += `_${parts.join(' ¬∑ ')}_\\n`;\n  \n  // Resources with prices\n  const resources = w.resources || [];\n  if (resources.length > 0) {\n    msg += `\\n`;\n    const showCount = Math.min(5, resources.length);\n    resources.slice(0, showCount).forEach((r, ri) => {\n      const isLast = ri === showCount - 1 && resources.length <= 5;\n      const prefix = isLast ? '‚îî' : '‚îú';\n      const typeTag = r.resource_type === 'labor' ? L.res_labor : r.resource_type === 'machine' ? L.res_machine : L.res_material;\n      const resName = (r.resource_name || '').substring(0, 26);\n      msg += `${prefix} *${typeTag}*: ${resName}\\n`;\n      \n      // Show quantity and cost\n      const qtyVal = r.scaled_quantity || r.resource_quantity || 0;\n      const costVal = r.scaled_cost || r.resource_cost || 0;\n      if (costVal > 0) {\n        msg += `   ${qtyVal.toFixed(2)} ${r.resource_unit || ''} = ${fmtCur(costVal)}\\n`;\n      } else {\n        msg += `   ${qtyVal.toFixed(2)} ${r.resource_unit || ''}\\n`;\n      }\n    });\n    if (resources.length > 5) {\n      msg += `‚îî _...+${resources.length - 5} ${L.resources}_\\n`;\n    }\n  }\n  \n  // Scope of work\n  const scope = w.scope_of_work || [];\n  if (scope.length > 0) {\n    msg += `\\nüìã *${L.scope_title || 'Scope of Work'}:*\\n`;\n    scope.forEach((s, si) => {\n      const prefix = si === scope.length - 1 ? '‚îî' : '‚îú';\n      const sText = (s || '').substring(0, 45);\n      msg += `${prefix} ${sText}\\n`;\n    });\n  }\n  msg += `\\n`;\n});\n\n// Summary\nmsg += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n`;\nconst totalParts = [];\nif (data.workers_sum > 0) totalParts.push(`${L.workers}: ${fmtCur(data.workers_sum)}`);\nif (data.materials_sum > 0) totalParts.push(`${L.materials}: ${fmtCur(data.materials_sum)}`);\nif (data.machines_sum > 0) totalParts.push(`${L.machines}: ${fmtCur(data.machines_sum)}`);\nif (totalParts.length > 0) msg += totalParts.join('\\n') + '\\n\\n';\n\nmsg += `*${L.total}: ${fmtCur(data.total || 0)}*\\n`;\n\nreturn { json: { ...cfg, msg, chatId: cid, bot_token: cfg.bot_token, L } };"
      },
      "id": "3796bd2e-fe14-4d29-b5dd-d8b5952b2357",
      "name": "View Details",
      "type": "n8n-nodes-base.code",
      "position": [
        1040,
        448
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify(($json.L && $json.L.fallback_start) || \"Use /start to begin\") }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "72863d69-bf25-4f98-8650-8969484132d5",
      "name": "üì§ Fallback",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1024,
        -208
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": \"*DDC CWICR - Help*\\n\\n*What is DDC CWICR?*\\nOpen source construction cost database\\nhttps://DataDrivenConstruction.io\\n\\n*Features:*\\nüì∏ Photo analysis with AI\\nüìù Text input with work lists\\nüåç 9 languages supported\\nüìä 55,000+ work items\\nüí∞ Regional pricing (EUR, USD, RUB, etc.)\\nüìÑ Excel & PDF export\\n\\n*How to use:*\\n1. Select your language\\n2. Send photo OR text description\\n3. Edit detected works if needed\\n4. Get cost estimate\\n\\n*Commands:*\\n/start - New estimate\\n\\n*Contact:*\\nGitHub: github.com/datadrivenconstruction/OpenConstructionEstimate-DDC-CWICR\",\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [[{\"text\": \"‚óÄÔ∏è Back\", \"callback_data\": \"back_to_lang\"}]]\n  }\n}",
        "options": {}
      },
      "id": "d20a9854-81cd-4eed-a76e-6d6792c0eec9",
      "name": "üì§ Help",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1040,
        448
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $json.chatId }}",
        "binaryData": true,
        "binaryPropertyName": "pdf",
        "additionalFields": {
          "caption": "={{ $json.L?.export_pdf_msg || 'üìÑ PDF Export (HTML)' }}",
          "fileName": "={{ $json.filename }}"
        }
      },
      "id": "b9e946ce-87f5-40f8-a10a-4b46d95f6f25",
      "name": "üì§ Send PDF",
      "type": "n8n-nodes-base.telegram",
      "position": [
        1472,
        288
      ],
      "webhookId": "75b0ff85",
      "typeVersion": 1.2,
      "credentials": {
        "telegramApi": {
          "id": "Pg9c5uHdiZaPWTEZ",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              },
              "leftValue": "={{ $json.skip }}",
              "rightValue": true
            }
          ]
        },
        "options": {}
      },
      "id": "5d1570ea-25ec-4481-af3c-da17e7a1bcdc",
      "name": "IF PDF",
      "type": "n8n-nodes-base.if",
      "position": [
        1232,
        304
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// Generate PDF (using HTML-to-PDF service or return HTML)\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst html = sd.html_report || '';\nconst L = sd.lastResults?.L || cfg.L || {};\n\nif (!html) {\n  // No HTML report yet - send message\n  try {\n    await $http.request({\n      method: 'POST',\n      url: `https://api.telegram.org/bot${cfg.bot_token}/sendMessage`,\n      body: { chat_id: parseInt(cid), text: '‚ùå No report to export. Please calculate first.' },\n      json: true\n    });\n  } catch(e) {}\n  return { json: { skip: true } };\n}\n\n// For now, send HTML file as \"PDF alternative\"\nconst filename = `Estimate_${(L.region || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().substring(0, 10)}.html`;\n\nreturn { json: { chatId: cid, L, bot_token: cfg.bot_token, filename }, binary: { pdf: { data: Buffer.from(html, 'utf-8').toString('base64'), mimeType: 'text/html', fileName: filename } } };"
      },
      "id": "792996ac-fee1-40be-9250-22cc9228df8b",
      "name": "Generate PDF",
      "type": "n8n-nodes-base.code",
      "position": [
        1040,
        304
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $json.chatId }}",
        "binaryData": true,
        "binaryPropertyName": "excel",
        "additionalFields": {
          "caption": "={{ $json.L?.export_excel_msg || 'üìä Excel Export (CSV)' }}",
          "fileName": "={{ $json.filename }}"
        }
      },
      "id": "b603eae6-e759-4c0a-8a3d-68ea96fa039b",
      "name": "üì§ Send Excel",
      "type": "n8n-nodes-base.telegram",
      "position": [
        1232,
        608
      ],
      "webhookId": "401e16ac",
      "typeVersion": 1.2,
      "credentials": {
        "telegramApi": {
          "id": "Pg9c5uHdiZaPWTEZ",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// Generate Excel file\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst data = sd.lastResults || {};\nconst L = data.L || cfg.L || {};\nconst works = data.works || [];\n\n// Create CSV content (Excel-compatible)\nlet csv = '\\uFEFF'; // BOM for UTF-8\ncsv += `${L.doc_title || 'ESTIMATE'} - ${data.description || 'Photo Estimate'}\\n`;\ncsv += `${L.region || 'Region'} | ${new Date().toLocaleDateString()}\\n\\n`;\n\n// Headers\ncsv += `${L.col_pos || 'Pos'};${L.col_code || 'Code'};${L.col_desc || 'Description'};${L.col_unit || 'Unit'};${L.col_qty || 'Qty'};${L.col_price || 'Price'};${L.col_total || 'Total'}\\n`;\n\n// Data rows\nworks.forEach((w, i) => {\n  const name = (w.rate_name || w.name || '').replace(/;/g, ',').replace(/\\n/g, ' ');\n  csv += `${i+1};${w.rate_code || ''};\"${name}\";${w.rate_unit || w.unit || ''};${(w.qty || 0).toFixed(2)};${(w.uc || 0).toFixed(2)};${(w.tc || 0).toFixed(2)}\\n`;\n  \n  // Resources\n  (w.resources || []).forEach(r => {\n    const resName = (r.resource_name || '').replace(/;/g, ',').replace(/\\n/g, ' ');\n    csv += `;${r.resource_code || ''};\"  ${resName}\";${r.resource_unit || ''};${(r.scaled_quantity || 0).toFixed(3)};${(r.resource_price || 0).toFixed(2)};${(r.scaled_cost || 0).toFixed(2)}\\n`;\n  });\n});\n\n// Totals\ncsv += `\\n;;;;;${L.total || 'TOTAL'};${(data.total || 0).toFixed(2)}\\n`;\ncsv += `;;;;;${L.workers || 'Labor'};${(data.workers_sum || 0).toFixed(2)}\\n`;\ncsv += `;;;;;${L.materials || 'Materials'};${(data.materials_sum || 0).toFixed(2)}\\n`;\ncsv += `;;;;;${L.machines || 'Equipment'};${(data.machines_sum || 0).toFixed(2)}\\n`;\n\nconst filename = `Estimate_${(L.region || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().substring(0, 10)}.csv`;\n\nreturn { json: { chatId: cid, L, bot_token: cfg.bot_token, filename }, binary: { excel: { data: Buffer.from(csv, 'utf-8').toString('base64'), mimeType: 'text/csv', fileName: filename } } };"
      },
      "id": "916ae248-0663-4d82-a5d1-2a2e283846f4",
      "name": "Generate Excel",
      "type": "n8n-nodes-base.code",
      "position": [
        1040,
        608
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $json.chatId }}",
        "binaryData": true,
        "binaryPropertyName": "html",
        "additionalFields": {
          "caption": "üìä Professional HTML Report",
          "fileName": "={{ $json.filename }}"
        }
      },
      "id": "43fa8a22-7522-44ca-afdd-c57ebbb5a5f3",
      "name": "üì§ Send HTML",
      "type": "n8n-nodes-base.telegram",
      "position": [
        3552,
        80
      ],
      "webhookId": "a0c501c4",
      "typeVersion": 1.2,
      "credentials": {
        "telegramApi": {
          "id": "Pg9c5uHdiZaPWTEZ",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst d = $input.first().json;\nconst html = d.html_content || '';\nconst L = d.L || {};\nconst now = new Date();\nconst ts = now.toISOString().replace(/[:.]/g, '-').substring(0, 16);\nconst filename = `Estimate_${(L.region || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}_${ts}.html`;\n\nreturn { json: { chatId: d.chatId, bot_token: d.bot_token, filename }, binary: { html: { data: Buffer.from(html, 'utf-8').toString('base64'), mimeType: 'text/html', fileName: filename } } };"
      },
      "id": "ab240741-d0c2-4a35-92fe-ec4f701a95ce",
      "name": "Prep HTML File",
      "type": "n8n-nodes-base.code",
      "position": [
        3392,
        80
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"text\": {{ JSON.stringify($json.msg) }}, \"parse_mode\": \"Markdown\", \"reply_markup\": {\"inline_keyboard\": [[{\"text\": \"{{ $json.L.resources || 'Resources' }}\", \"callback_data\": \"view_details\"}], [{\"text\": \"{{ $json.L.btn_export_excel || 'Excel' }}\", \"callback_data\": \"export_excel\"}, {\"text\": \"{{ $json.L.btn_export_pdf || 'PDF' }}\", \"callback_data\": \"export_pdf\"}], [{\"text\": \"{{ $json.L.btn_restart || 'New' }}\", \"callback_data\": \"restart\"}]]}}",
        "options": {}
      },
      "id": "dd3d3446-dc3f-4900-aba3-390ab7d61521",
      "name": "üì§ Final",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        3392,
        -80
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Final message with resources preview\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst d = $('Generate HTML').first().json;\nconst cid = d.chatId;\nconst sd = $getWorkflowStaticData('global');\nconst L = d.L || {};\n\nif (sd.res?.[cid]) delete sd.res[cid];\nif (sd.sess?.[cid]) sd.sess[cid].state = 'done';\n\nfunction fmt(v) { \n  try { return new Intl.NumberFormat(L.loc || 'en', { maximumFractionDigits: 0 }).format(v || 0); } \n  catch(e) { return (v || 0).toFixed(0); } \n}\nfunction fmtCur(v) { \n  const sym = L.sym || '$';\n  if (Math.abs(v) >= 1000) return sym + ' ' + fmt(v);\n  return sym + ' ' + (v || 0).toFixed(2);\n}\nfunction shortName(str, len) {\n  str = String(str || '');\n  if (str.length > len) return str.substring(0, len - 1) + '...';\n  return str;\n}\n\nfunction escMd(s) {\n  // Remove Markdown special chars for Telegram (Markdown mode doesn't support escaping)\n  return String(s || '').replace(/[_*`\\[\\]]/g, '');\n}\n\nconst works = d.works || [];\nconst total = d.total || 0;\nconst now = new Date();\nconst dateStr = now.toLocaleDateString(L.loc || 'en', { year: 'numeric', month: '2-digit', day: '2-digit' });\n\nconst qiMarks = { 'high': '‚óè', 'medium': '‚óã', 'low': '‚óå', 'not_found': '‚úï' };\n\n// Header\nlet msg = `*${L.doc_title || 'COST ESTIMATE'}*\\n`;\nmsg += `${dateStr} ¬∑ ${L.region || ''}\\n\\n`;\n\n// Works with resources\nworks.forEach((w, i) => {\n  const qi = qiMarks[w.ql] || '‚óã';\n  const name = escMd(shortName(w.rate_name || w.name || '', 30));\n  const sumStr = fmtCur(w.tc);\n  \n  msg += `${qi} *${i+1}.* ${name}\\n`;\n  msg += `   ${w.qty} ${w.unit} √ó ${fmtCur(w.uc)} = *${sumStr}*\\n`;\n  \n  // Show 2-3 resources\n  const resources = w.resources || [];\n  if (resources.length > 0) {\n    const preview = resources.slice(0, 3);\n    preview.forEach((r, ri) => {\n      const isLast = ri === preview.length - 1 && resources.length <= 3;\n      const prefix = isLast ? '‚îî' : '‚îú';\n      const typeIcon = r.resource_type === 'labor' ? 'L' : r.resource_type === 'machine' ? 'M' : 'R';\n      const rName = escMd(shortName(r.resource_name || '', 40));\n      const rCost = fmtCur(r.scaled_cost || 0);\n      msg += `   ${prefix} [${typeIcon}] ${rName} ${rCost}\\n`;\n    });\n    if (resources.length > 3) {\n      msg += `   ‚îî +${resources.length - 3} ${L.more_resources || 'more'}\\n`;\n    }\n  }\n  \n  // Show scope of work preview\n  const scope = w.scope_of_work || [];\n  if (scope.length > 0) {\n    msg += `   üìã ${L.scope_title || 'Scope'}:\\n`;\n    const scopePreview = scope.slice(0, 2);\n    scopePreview.forEach((s, si) => {\n      const isLast = si === scopePreview.length - 1 && scope.length <= 2;\n      const prefix = isLast ? '   ‚îî' : '   ‚îú';\n      const sText = escMd(shortName(s, 35));\n      msg += `${prefix} ‚Ä¢ ${sText}\\n`;\n    });\n    if (scope.length > 2) {\n      msg += `   ‚îî +${scope.length - 2} ${L.more_resources || 'more'}\\n`;\n    }\n  }\n});\n\n// Total\nmsg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n`;\nmsg += `*${L.total || 'TOTAL'}:* ${fmtCur(total)}\\n\\n`;\n\n// Quality legend\nconst qHigh = works.filter(w => w.ql === 'high').length;\nconst qMed = works.filter(w => w.ql === 'medium').length;\nconst qLow = works.filter(w => w.ql === 'low').length;\nconst qNone = works.filter(w => w.ql === 'not_found').length;\n\nconst avgLLM = works.length > 0 ? Math.round(works.reduce((s, w) => s + (w.llm_score || 0), 0) / works.length) : 0;\nmsg += `‚óè ${qHigh}  ‚óã ${qMed}  ‚óå ${qLow}  ‚úï ${qNone}  (${d.pct}% ${L.found_pct || 'found'})\\n`;\nif (avgLLM > 0) msg += `üéØ AI: ${avgLLM}%\\n`;\nmsg += `\\n`;\n\n// Cost breakdown\nif (d.workers_sum > 0 || d.materials_sum > 0 || d.machines_sum > 0) {\n  const parts = [];\n  if (d.workers_sum > 0) parts.push(`${L.workers || 'Labor'}: ${fmtCur(d.workers_sum)}`);\n  if (d.materials_sum > 0) parts.push(`${L.materials || 'Mat'}: ${fmtCur(d.materials_sum)}`);\n  if (d.machines_sum > 0) parts.push(`${L.machines || 'Equip'}: ${fmtCur(d.machines_sum)}`);\n  msg += parts.join(' ¬∑ ') + '\\n';\n}\n\nif (d.labor_hours_sum > 0) {\n  const days = Math.ceil(d.labor_hours_sum / 8);\n  msg += `${L.labor_hours || 'Hours'}: ${fmt(d.labor_hours_sum)}h ¬∑ ~${days} ${L.days || 'days'}\\n`;\n}\n\nmsg += `\\n_${L.price_note || 'Prices are approximate'}_\\n`;\nmsg += `_${L.more_in_html || 'Detailed report available'}_\\n\\n`;\nmsg += `${L.what_next || 'Options:'}`;\n\nreturn { json: { ...d, msg } };"
      },
      "id": "5960b5f3-a7d2-47af-bbe0-1bb4864e6678",
      "name": "Final",
      "type": "n8n-nodes-base.code",
      "position": [
        3248,
        48
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Generate HTML Report with expandable resources\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst d = $('Agg').first().json;\nconst L = d.L || {};\nconst cur = L.cur || 'USD'; \nconst loc = L.loc || 'en'; \nconst sym = L.sym || '$';\nconst works = d.works || []; \nconst total = d.total || 0;\n\nfunction fmt(v) { \n  try { \n    return new Intl.NumberFormat(loc, { style: 'currency', currency: cur, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(v || 0); \n  } catch(e) { \n    return sym + ' ' + (v || 0).toFixed(2); \n  } \n}\nfunction fmtNum(v, dec) { \n  return new Intl.NumberFormat(loc, { minimumFractionDigits: dec || 2, maximumFractionDigits: dec || 2 }).format(v || 0); \n}\nfunction esc(t) { \n  return String(t || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); \n}\n\nconst now = new Date();\nconst dateStr = now.toLocaleDateString(loc, { day: '2-digit', month: '2-digit', year: 'numeric' });\nconst timeStr = now.toLocaleTimeString(loc, { hour: '2-digit', minute: '2-digit' });\n\nconst laborPct = total > 0 ? Math.round(d.workers_sum / total * 100) : 0;\nconst materialPct = total > 0 ? Math.round(d.materials_sum / total * 100) : 0;\nconst machinePct = total > 0 ? Math.round(d.machines_sum / total * 100) : 0;\nconst laborDays = Math.ceil((d.labor_hours_sum || 0) / 8);\n\nlet html = `<!DOCTYPE html>\n<html><head><meta charset=\"UTF-8\">\n<title>${esc(L.doc_title || 'Cost Estimate')} - ${esc(d.description || '')}</title>\n<style>\n:root{--primary:#007AFF;--text:#1D1D1F;--text2:#86868B;--text3:#AEAEB2;--bg:#FFF;--bg2:#F5F5F7;--bg3:#E8E8ED;--border:#D2D2D7;--labor:#E3F2FD;--labor-text:#1565C0;--material:#FFF3E0;--material-text:#E65100;--machine:#F3E5F5;--machine-text:#7B1FA2}\n*{box-sizing:border-box}\nbody{font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,sans-serif;margin:0;padding:16px;background:var(--bg2);color:var(--text);font-size:12px;line-height:1.4}\n.container{background:var(--bg);max-width:1200px;margin:0 auto;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.08);overflow:hidden}\n.header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}\n.header h1{margin:0;font-size:18px;font-weight:600}\n.header-info{font-size:11px;color:var(--text3)}\n.toolbar{padding:10px 20px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap}\n.btn{padding:6px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);cursor:pointer;font-size:11px}\n.btn:hover{background:var(--bg3)}\n.kpi{display:flex;gap:8px;padding:12px 20px;background:var(--bg2);flex-wrap:wrap}\n.kpi-card{background:var(--bg);border-radius:8px;padding:10px 14px;border:1px solid var(--border);min-width:100px}\n.kpi-value{font-size:16px;font-weight:600}\n.kpi-label{font-size:9px;color:var(--text3);text-transform:uppercase}\ntable{width:100%;border-collapse:collapse}\nth,td{padding:8px 10px;text-align:left;border-bottom:1px solid var(--border)}\nth{background:var(--bg2);font-weight:500;font-size:10px;text-transform:uppercase;color:var(--text2)}\n.work-row{cursor:pointer;transition:background 0.15s}\n.work-row:hover{background:var(--bg2)}\n.work-row td:first-child{font-weight:500}\n.toggle{width:20px;color:var(--text3);font-size:10px}\n.res-row{background:#FAFAFA;font-size:11px}\n.res-row.hidden{display:none}\n.scope-row{background:#F0FFF0;font-size:11px}\n.scope-row.hidden{display:none}\n.scope-row td{padding:6px 10px 6px 30px;border-bottom:1px dashed #D0E8D0}\n.scope-toggle{color:var(--primary);cursor:pointer;font-size:10px;margin-left:8px}\n.res-row td{padding:6px 10px 6px 30px;border-bottom:1px dashed var(--border)}\n.res-tag{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:500;margin-right:6px}\n.res-labor{background:var(--labor);color:var(--labor-text)}\n.res-material{background:var(--material);color:var(--material-text)}\n.res-machine{background:var(--machine);color:var(--machine-text)}\n.summary-row{background:linear-gradient(90deg,var(--bg2),var(--bg));font-size:10px}\n.summary-row.hidden{display:none}\n.summary-row td{padding:6px 10px 6px 30px;border-top:1px solid var(--border)}\n.dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px}\n.dot-high{background:#34C759}\n.dot-medium{background:#FF9500}\n.dot-low{background:#FF3B30}\n.dot-none{background:#8E8E93}\n.total-row{background:var(--bg2);font-weight:600}\n.total-row td{padding:12px 10px}\n.right{text-align:right}\n.footer{padding:16px 20px;text-align:center;font-size:10px;color:var(--text3);border-top:1px solid var(--border)}\n.footer a{color:var(--primary);text-decoration:none}\n@media(max-width:600px){\n  body{padding:8px;font-size:11px}\n  th,td{padding:6px}\n  .kpi-card{min-width:80px;padding:8px}\n  .kpi-value{font-size:14px}\n}\n</style>\n</head><body>\n<div class=\"container\">\n<div class=\"header\">\n  <h1>${esc(L.doc_title || 'Cost Estimate')}</h1>\n  <div class=\"header-info\">${dateStr} ${timeStr} ¬∑ ${esc(L.region || '')}</div>\n</div>\n<div class=\"toolbar\">\n  <button class=\"btn\" onclick=\"expandAll()\">${esc(L.expand_all || 'Expand All')}</button>\n  <button class=\"btn\" onclick=\"collapseAll()\">${esc(L.collapse_all || 'Collapse All')}</button>\n</div>\n<div class=\"kpi\">\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${fmt(total)}</div><div class=\"kpi-label\">${esc(L.kpi_total || 'Total')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${works.length}</div><div class=\"kpi-label\">${esc(L.kpi_items || 'Items')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${laborDays}d</div><div class=\"kpi-label\">${esc(L.kpi_days || 'Days')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${laborPct}%</div><div class=\"kpi-label\">${esc(L.workers || 'Labor')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${materialPct}%</div><div class=\"kpi-label\">${esc(L.materials || 'Materials')}</div></div>\n</div>\n<table>\n<tr>\n  <th style=\"width:30px\"></th>\n  <th>${esc(L.col_code || 'Code')}</th>\n  <th>${esc(L.col_desc || 'Description')}</th>\n  <th>${esc(L.col_unit || 'Unit')}</th>\n  <th class=\"right\">${esc(L.col_qty || 'Qty')}</th>\n  <th class=\"right\">${esc(L.col_price || 'Price')}</th>\n  <th class=\"right\">${esc(L.col_total || 'Total')}</th>\n  <th style=\"width:30px\"></th>\n</tr>`;\n\nworks.forEach((w, i) => {\n  console.log('Work ' + (i+1) + ': ' + (w.rate_name || w.name) + ' - Resources: ' + (w.resources || []).length);\n  const hasRes = (w.resources || []).length > 0;\n  const isFirst = i === 0;\n  const dotClass = w.ql === 'high' ? 'dot-high' : w.ql === 'medium' ? 'dot-medium' : w.ql === 'low' ? 'dot-low' : 'dot-none';\n  const code = w.rate_code && w.rate_code !== 'NOT_FOUND' ? w.rate_code : '‚Äî';\n  \n  const hasScope = (w.scope_of_work || []).length > 0;\n  const scopeBtn = hasScope ? '<span class=\"scope-toggle\" onclick=\"event.stopPropagation();toggleScope(' + i + ')\">üìã</span>' : '';\n  \n  html += `<tr class=\"work-row\" data-work=\"${i}\" onclick=\"toggleWork(${i})\">\n    <td class=\"toggle\"><span id=\"icon-${i}\">${isFirst ? '‚ñº' : '‚ñ∂'}</span></td>\n    <td style=\"font-size:10px;color:var(--text2)\">${esc(code)}</td>\n    <td><strong>${esc(w.rate_name || w.name)}</strong>${scopeBtn}</td>\n    <td>${esc(w.rate_unit || w.unit)}</td>\n    <td class=\"right\">${fmtNum(w.qty)}</td>\n    <td class=\"right\">${fmt(w.uc)}</td>\n    <td class=\"right\"><strong>${fmt(w.tc)}</strong></td>\n    <td><span class=\"dot ${dotClass}\" title=\"${w.llm_match || ''}\"></span>${w.llm_score ? '<span style=\"font-size:9px;color:var(--text3);margin-left:2px\">' + w.llm_score + '</span>' : ''}</td>\n  </tr>`;\n  \n  // Scope of work rows\n  const scopeItems = w.scope_of_work || [];\n  if (scopeItems.length > 0) {\n    html += `<tr class=\"scope-row hidden\" data-scope=\"${i}\">\n      <td></td>\n      <td colspan=\"6\" style=\"background:#F8FFF8\">\n        <strong style=\"color:#2E7D32\">üìã ${esc(L.scope_title || 'Scope of Work')}:</strong><br>\n        ${scopeItems.map((s, si) => '<span style=\"color:#555\">‚Ä¢ ' + esc(s) + '</span>').join('<br>')}\n      </td>\n      <td></td>\n    </tr>`;\n  }\n  \n  // Resources\n  const resources = w.resources || [];\n  resources.forEach((r, ri) => {\n    const tagClass = r.resource_type === 'labor' ? 'res-labor' : r.resource_type === 'machine' ? 'res-machine' : 'res-material';\n    const tagLabel = r.resource_type === 'labor' ? (L.res_labor || 'Labor') : r.resource_type === 'machine' ? (L.res_machine || 'Equip') : (L.res_material || 'Mat');\n    const hiddenClass = isFirst ? '' : 'hidden';\n    const resQty = r.scaled_quantity || r.resource_quantity || 0;\n    const resPrice = r.resource_price || 0;\n    const resCost = r.scaled_cost || 0;\n    const norm = r.resource_quantity || r.norma || 0;\n    const pct = w.tc > 0 ? Math.round(resCost / w.tc * 100) : 0;\n    \n    html += `<tr class=\"res-row ${hiddenClass}\" data-work=\"${i}\">\n      <td></td>\n      <td><span style=\"font-size:9px;color:var(--text3)\">${esc(r.resource_code || '')}</span></td>\n      <td>\n        <span class=\"res-tag ${tagClass}\">${esc(tagLabel)}</span>\n        ${esc(r.resource_name || '')}\n        ${norm ? '<span style=\"color:var(--text3);font-size:9px;margin-left:4px\">√ó' + fmtNum(norm, 4) + '</span>' : ''}\n      </td>\n      <td style=\"font-size:10px\">${esc(r.resource_unit || '')}</td>\n      <td class=\"right\" style=\"font-size:10px\">${fmtNum(resQty, 3)}</td>\n      <td class=\"right\" style=\"font-size:10px\">${fmt(resPrice)}</td>\n      <td class=\"right\">${fmt(resCost)} <span style=\"font-size:9px;color:var(--text3)\">${pct}%</span></td>\n      <td></td>\n    </tr>`;\n  });\n  \n  // Summary row for work\n  if (resources.length > 0) {\n    const laborSum = resources.filter(r => r.resource_type === 'labor').reduce((s, r) => s + (r.scaled_cost || 0), 0);\n    const matSum = resources.filter(r => r.resource_type === 'material').reduce((s, r) => s + (r.scaled_cost || 0), 0);\n    const machSum = resources.filter(r => r.resource_type === 'machine').reduce((s, r) => s + (r.scaled_cost || 0), 0);\n    const hiddenClass = isFirst ? '' : 'hidden';\n    \n    html += `<tr class=\"summary-row ${hiddenClass}\" data-work=\"${i}\">\n      <td colspan=\"2\"></td>\n      <td colspan=\"4\">\n        <span style=\"color:var(--labor-text)\">${L.workers || 'Labor'}: ${fmt(laborSum)}</span> ¬∑ \n        <span style=\"color:var(--material-text)\">${L.materials || 'Mat'}: ${fmt(matSum)}</span> ¬∑ \n        <span style=\"color:var(--machine-text)\">${L.machines || 'Equip'}: ${fmt(machSum)}</span>\n      </td>\n      <td class=\"right\"><strong>${fmt(w.tc)}</strong></td>\n      <td></td>\n    </tr>`;\n  }\n});\n\nhtml += `<tr class=\"total-row\">\n  <td colspan=\"6\" style=\"text-align:right\">${esc(L.grand_total || 'TOTAL')}</td>\n  <td class=\"right\">${fmt(total)}</td>\n  <td></td>\n</tr>\n</table>\n<div class=\"footer\">\n  <a href=\"https://DataDrivenConstruction.io\" target=\"_blank\">DDC CWICR</a> ¬∑ \n  Open Source Construction Cost Database ¬∑ ${dateStr}\n</div>\n</div>\n<script>\nfunction toggleWork(idx) {\n  const icon = document.getElementById('icon-' + idx);\n  const rows = document.querySelectorAll('tr[data-work=\"' + idx + '\"]:not(.work-row)');\n  const isHidden = rows.length > 0 && rows[0].classList.contains('hidden');\n  rows.forEach(r => r.classList.toggle('hidden', !isHidden));\n  if (icon) icon.textContent = isHidden ? '‚ñº' : '‚ñ∂';\n}\nfunction expandAll() {\n  document.querySelectorAll('tr[data-work]').forEach(r => r.classList.remove('hidden'));\n  document.querySelectorAll('[id^=\"icon-\"]').forEach(i => i.textContent = '‚ñº');\n}\nfunction collapseAll() {\n  document.querySelectorAll('tr.res-row, tr.summary-row, tr.scope-row').forEach(r => r.classList.add('hidden'));\n  document.querySelectorAll('[id^=\"icon-\"]').forEach(i => i.textContent = '‚ñ∂');\n}\nfunction toggleScope(idx) {\n  const rows = document.querySelectorAll('tr.scope-row[data-scope=\"' + idx + '\"]');\n  rows.forEach(r => r.classList.toggle('hidden'));\n}\n</script>\n</body></html>`;\n\nconst sd = $getWorkflowStaticData('global');\nsd.html_report = html;\n\nreturn { json: { ...d, html_content: html } };"
      },
      "id": "00945df2-e008-4c9c-84c6-2017777e4eeb",
      "name": "Generate HTML",
      "type": "n8n-nodes-base.code",
      "position": [
        3088,
        48
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/answerCallbackQuery",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"callback_query_id\": \"{{ $('Config').item.json.callbackQueryId }}\",\n  \"text\": \"{{ $('Config').item.json.L.loading }}\",\n  \"show_alert\": false\n}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "a6f0c545-d832-44aa-bd2d-5280e1c2a0d6",
      "name": "Answer Calc CB",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1040,
        144
      ],
      "typeVersion": 4.2,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify($json.msg) }},\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": { \"inline_keyboard\": {{ JSON.stringify($json.keyboard) }} }\n}",
        "options": {}
      },
      "id": "9028edd1-ab9d-40c4-a47a-76c11fb1756c",
      "name": "üì§ Works Updated",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1232,
        -48
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// WORKS UPDATED - Show updated works list after quantity change\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst works = session.works || [];\nconst L = cfg.L || session.L || {};\n\nconsole.log('=== WORKS UPDATED ===');\nconsole.log('Works:', works.length);\nconsole.log('L.native:', L.native);\n\nlet msg = '‚úÖ ' + (L.work_added || '–û–±–Ω–æ–≤–ª–µ–Ω–æ') + '\\n\\n';\nmsg += '*' + works.length + ' ' + (L.items || '–ø–æ–∑–∏—Ü–∏–π') + '*\\n\\n';\n\nfor (let i = 0; i < works.length; i++) {\n  const w = works[i];\n  const name = w.name.length > 25 ? w.name.substring(0, 22) + '...' : w.name;\n  msg += (i + 1) + '. ' + name + ' ‚Äî ' + w.qty + ' ' + (w.unit || 'm¬≤') + '\\n';\n}\n\n// No limit\n\nconst keyboard = [];\nconst maxBtns = works.length;\nfor (let i = 0; i < maxBtns; i += 5) {\n  const row = [];\n  for (let j = 0; j < 5 && i + j < maxBtns; j++) {\n    row.push({ text: '‚úèÔ∏è' + (i + j + 1), callback_data: 'edit_work_' + (i + j) });\n  }\n  keyboard.push(row);\n}\n\nkeyboard.push([\n  { text: L.btn_add_work || '+ –ü–æ–∑–∏—Ü–∏—è', callback_data: 'add_work' },\n  { text: L.btn_calc || '‚ñ∂ –†–∞—Å—á—ë—Ç', callback_data: 'calculate' }\n]);\nkeyboard.push([{ text: L.btn_new || 'üîÑ –ó–∞–Ω–æ–≤–æ', callback_data: 'new_photo' }]);\n\nreturn { json: { ...cfg, msg, keyboard } };"
      },
      "id": "8acec97f-e5e6-4250-9791-41afd9afd9ff",
      "name": "Works Updated",
      "type": "n8n-nodes-base.code",
      "position": [
        1024,
        -48
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('Config').item.json.chatId }},\n  \"text\": {{ JSON.stringify($('Config').item.json.L.enter_work) }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "712ca636-5ee9-4df8-a2a6-3596a34d45c0",
      "name": "üì§ Ask New Work",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1248,
        -1040
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// EDIT MENU - Show edit buttons for selected work item\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst works = session.works || [];\nconst L = cfg.L || session.L || {};\n\nconst idx = session.editingWorkIndex || cfg.editingWorkIndex || 0;\nconst work = works[idx];\n\nconsole.log('=== EDIT MENU ===');\nconsole.log('Editing work index:', idx);\nconsole.log('Work:', work?.name);\n\nif (!work) {\n  return { json: { ...cfg, _skip: true } };\n}\n\nconst name = work.name.length > 30 ? work.name.substring(0, 27) + '...' : work.name;\nlet msg = '‚úèÔ∏è *' + (L.btn_edit || '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ') + '*\\n\\n';\nmsg += '*' + (idx + 1) + '. ' + name + '*\\n';\nmsg += 'üìè ' + work.qty + ' ' + (work.unit || 'm¬≤') + '\\n\\n';\nmsg += (L.edit_hint || '–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:');\n\n// Quantity edit buttons\nconst keyboard = [\n  [\n    { text: '-10', callback_data: 'qty_work_' + idx + '_minus10' },\n    { text: '-1', callback_data: 'qty_work_' + idx + '_minus1' },\n    { text: '+1', callback_data: 'qty_work_' + idx + '_plus1' },\n    { text: '+10', callback_data: 'qty_work_' + idx + '_plus10' }\n  ],\n  [\n    { text: '√∑2', callback_data: 'qty_work_' + idx + '_half' },\n    { text: '√ó2', callback_data: 'qty_work_' + idx + '_double' }\n  ],\n  [\n    { text: 'üóë ' + (L.btn_delete || '–£–¥–∞–ª–∏—Ç—å'), callback_data: 'delete_work_' + idx }\n  ],\n  [\n    { text: '‚óÄÔ∏è ' + (L.btn_done || '–ù–∞–∑–∞–¥'), callback_data: 'done_editing' }\n  ]\n];\n\nreturn { json: { ...cfg, msg, keyboard, chatId: cid } };"
      },
      "id": "fab438e1-963b-4351-b003-444af1e885bd",
      "name": "Edit Menu",
      "type": "n8n-nodes-base.code",
      "position": [
        1040,
        -32
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PARSE AI RESPONSE - Extract work items from Vision API response\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst data = $input.first().json;\nconst cid = String(data.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst L = data.L || {};\nconst provider = data.provider || 'gemini';\n\nconsole.log('=== PARSE AI ===');\nconsole.log('Provider:', provider);\nconsole.log('ChatId:', cid);\n\nlet p = { description: '', items: [] };\nlet rawContent = '';\n\ntry {\n  // Extract text from response based on provider\n  if (provider === 'openai') {\n    rawContent = data.choices?.[0]?.message?.content || '';\n  } else {\n    rawContent = data.candidates?.[0]?.content?.parts?.[0]?.text || '';\n  }\n  \n  console.log('Response length:', rawContent.length);\n  \n  if (rawContent) {\n    // Clean markdown and extract JSON\n    let cleanContent = rawContent\n      .replace(/```json\\s*/gi, '')\n      .replace(/```\\s*/gi, '')\n      .trim();\n    \n    const jsonStart = cleanContent.indexOf('{');\n    const jsonEnd = cleanContent.lastIndexOf('}');\n    \n    if (jsonStart !== -1 && jsonEnd !== -1) {\n      const jsonStr = cleanContent.substring(jsonStart, jsonEnd + 1);\n      p = JSON.parse(jsonStr);\n      console.log('Parsed items:', p.items?.length || 0);\n    }\n  }\n} catch(e) { \n  console.log('Parse error:', e.message);\n}\n\n// Validate and normalize items\nconst validItems = (p.items || [])\n  .filter(it => it.name && it.name.length > 2)\n  .map((it, i) => ({\n    id: 'W' + String(i + 1).padStart(3, '0'),\n    seq: i + 1,\n    name: String(it.name).substring(0, 80).trim(),\n    query: String(it.name).substring(0, 80).trim(),\n    qty: Math.max(0.1, parseFloat(it.qty) || 1),\n    unit: ['m¬≤', 'm', 'pcs', 'kg', 'l', '—à—Ç', '–º¬≤', '–º'].includes(it.unit) ? it.unit : 'm¬≤',\n    conf: ['high', 'medium', 'low'].includes(it.conf) ? it.conf : 'medium',\n    cat: ['demolition', 'rough', 'finishing', 'mep'].includes(it.cat) ? it.cat : 'finishing'\n  }));\n\nconsole.log('Valid items:', validItems.length);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// CRITICAL: Save works to session for later access\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = { lang: data.lang };\n\nsd.sess[cid].works = validItems;\nsd.sess[cid].description = p.description || '';\nsd.sess[cid].state = 'wait_edit';\nsd.sess[cid].db = data.db;\nsd.sess[cid].L = data.L;\n\nconsole.log('Saved to session:', sd.sess[cid].works.length, 'works');\n\nreturn { \n  json: { \n    ...data,\n    chatId: cid, \n    works: validItems,\n    description: p.description || '',\n    L: data.L\n  }\n};"
      },
      "id": "605b8781-6ebd-4bda-8f5a-703915e89069",
      "name": "Parse AI",
      "type": "n8n-nodes-base.code",
      "position": [
        3552,
        -768
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('Config').item.json.chatId }},\n  \"text\": \"{{ $('Config').item.json.L.photo_added }} ({{ $('Config').item.json.photos.length }} {{ $('Config').item.json.L.photos_count }})\",\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [\n      [{\"text\": \"{{ $('Config').item.json.L.add_more }}\", \"callback_data\": \"add_more_photos\"}, {\"text\": \"{{ $('Config').item.json.L.analyze_now }}\", \"callback_data\": \"analyze_photos\"}],\n      [{\"text\": \"{{ $('Config').item.json.L.btn_help }}\", \"callback_data\": \"show_help\"}]\n    ]\n  }\n}",
        "options": {}
      },
      "id": "81bc3b60-eb18-4f0a-9708-b21ff6cb939a",
      "name": "üì§ Analyze Options",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1248,
        -1168
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('Config').item.json.chatId }},\n  \"text\": {{ JSON.stringify($('Config').item.json.L.photo) }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "f292bd21-e4f9-42eb-b3a1-ba0befbf133d",
      "name": "üì§ Ask Photo",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1248,
        -1360
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/answerCallbackQuery",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"callback_query_id\": \"{{ $('Config').item.json.callbackQueryId }}\"\n}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "68d514e3-b515-4803-af1a-3fbd0f8ce04a",
      "name": "Answer Photo CB",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1040,
        -1360
      ],
      "typeVersion": 4.2,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('Config').item.json.chatId }},\n  \"text\": {{ JSON.stringify($('Config').item.json.L.ok + \"\\n\\n\" + $('Config').item.json.L.photo) }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "7e57e989-6831-48ab-b637-1e1c23382934",
      "name": "üì§ Lang OK",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1248,
        -1504
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/answerCallbackQuery",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"callback_query_id\": \"{{ $('Config').item.json.callbackQueryId }}\"\n}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "fe7aa44b-5b11-4f86-8a0b-e437eee8cba6",
      "name": "Answer Lang CB",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1040,
        -1504
      ],
      "typeVersion": 4.2,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": \"*DDC CWICR Cost Estimator*\\nhttps://DataDrivenConstruction.io\\n\\n‚ñ∏ Photo analysis (up to 4)\\n‚ñ∏ Text description\\n‚ñ∏ 9 languages ¬∑ 55,000+ work items\\n‚ñ∏ Excel & PDF export\\n\\nSelect language:\",\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [\n      [{\"text\": \"üá©üá™ Deutsch\", \"callback_data\": \"lang_DE\"}, {\"text\": \"üá¨üáß English\", \"callback_data\": \"lang_EN\"}, {\"text\": \"üá∑üá∫ –†—É—Å—Å–∫–∏–π\", \"callback_data\": \"lang_RU\"}],\n      [{\"text\": \"üá™üá∏ Espa√±ol\", \"callback_data\": \"lang_ES\"}, {\"text\": \"üá´üá∑ Fran√ßais\", \"callback_data\": \"lang_FR\"}, {\"text\": \"üáßüá∑ Portugu√™s\", \"callback_data\": \"lang_PT\"}],\n      [{\"text\": \"üá®üá≥ ‰∏≠Êñá\", \"callback_data\": \"lang_ZH\"}, {\"text\": \"üá¶üá™ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©\", \"callback_data\": \"lang_AR\"}, {\"text\": \"üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä\", \"callback_data\": \"lang_HI\"}],\n      [{\"text\": \"‚ùì Help\", \"callback_data\": \"show_help\"}]\n    ]\n  }\n}",
        "options": {}
      },
      "id": "96392839-25fa-44b7-9d05-ad7a8bdc8249",
      "name": "üì§ Lang Menu",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1040,
        -1648
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "a3c7266e-9deb-4abe-a856-0e835757cdc8",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_lang"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "LANG"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "abc9388b-156f-4a27-8b6b-16d0e18e9749",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "lang_selected"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "LANG_OK"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "6a8ae65c-90f2-4a74-ac8c-e7e34d8eb49f",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "ask_photo"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "PHOTO"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "96f28956-a38b-4d71-86b7-b9b2f2750cc7",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_analyze_options"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "ANALYZE_OPT"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "ea59db87-7ac6-44aa-9e6f-6f061c30b451",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "photo_added"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "PHOTO_ADDED"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "f1f0126d-794b-48f7-9097-9fb54d5f097e",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "analyze"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "ANALYZE"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "320b81af-ef5e-4776-814d-3aead2e0a38a",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "works_updated"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "WORKS_UPD"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "def6b912-0ac9-4066-b421-59fd67b596c8",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_edit_menu"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "EDIT_MENU"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "4ca5650d-0486-456a-b17c-34ec088923d1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "ask_new_work"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "ADD_WORK"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "8f7bceab-ef7c-43b4-8afa-a8c309a74645",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "start_calc"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "CALC"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "e1037d8b-0e5f-46c3-a008-ad16d97689c2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "export_excel"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "EXCEL"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "6fff52ee-58d7-4073-b42d-cb15298d5788",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "export_pdf"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "PDF"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "fdf49046-6eaf-4183-8ff8-209eff4fefc4",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_help"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "HELP"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "6b143832-1fbb-40ee-9465-ff85f59b0328",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "view_details"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "DETAILS"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "d687c3a2-8bec-42df-9b32-74609fbd2d89",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "refine_analysis"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "REFINE"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "244cd331-efdc-4e0e-b267-f51d8a6c6f3d",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "analyze_text"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "ANALYZE_TEXT"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "97856224-76ac-4a6d-8719-a5401d6d9ff1",
                    "operator": {
                      "name": "filter.operator.equals",
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "process_pdf"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "PDF_PROCESS"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "f9585768-de18-4c69-92f1-39ab1282658c",
      "name": "Route",
      "type": "n8n-nodes-base.switch",
      "position": [
        688,
        -976
      ],
      "typeVersion": 3.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// CONFIG v8.5 PRO - Professional style localization + PDF SUPPORT\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst input = $input.first().json;\nconst lang = (input.lang || 'EN').toUpperCase();\nconst chatId = String(input.chatId);\nconst sd = $getWorkflowStaticData('global');\n\nconst LANGS = {\n  'DE': { \n    fallback_start: 'Dr√ºcken Sie /start um zu beginnen', \n    rooms: 'R√§ume', works_identified: 'Positionen', general: 'Allgemein', no_works: 'Keine Arbeiten', items: 'Positionen', min: 'Min', \n    db: 'DE_BERLIN_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'German', flag: 'üá©üá™', native: 'Deutsch', cur: 'EUR', sym: '‚Ç¨', loc: 'de-DE', region: 'Berlin', search_lang: 'German',\n    // Professional welcome with PDF support\n    ok: '‚úÖ *Deutsch* ¬∑ Berlin ¬∑ EUR',\n    photo: `*Foto, PDF oder Beschreibung senden*\n\nüìÑ *PDF-Zeichnungen* ‚Äî Grundriss oder Bauplan (max. 3 Seiten)\nüì∑ *Foto* ‚Äî Raum oder Objekt fotografieren\n‚úèÔ∏è *Text* ‚Äî Arbeiten als Liste beschreiben\n\n_Beispiel zum Kopieren:_\n\\`\\`\\`\nGipskarton 2-lagig Metallprofil CW75 25m2\nFliesen Feinsteinzeug 60x60 Bad 15m2\nSpachteln Q3 Decken und Waende 120m2\nElektro Steckdosen UP 20 Stueck\n\\`\\`\\`\n\nOder Foto/PDF senden üì∑üìÑ`,\n    // PDF specific\n    pdf_received: 'üìÑ *PDF erhalten*',\n    pdf_processing: '‚è≥ Analysiere Zeichnung...',\n    pdf_pages: 'Seiten',\n    pdf_page_limit: '‚ö†Ô∏è Nur erste 3 Seiten werden verarbeitet',\n    pdf_rooms_found: 'üè† R√§ume gefunden',\n    pdf_elements_found: 'üß± Elemente gefunden',\n    pdf_works_generated: 'üìù Arbeiten generiert',\n    pdf_analyzing_page: 'üîç Analysiere Seite',\n    pdf_of: 'von',\n    pdf_complete: '‚úÖ Analyse abgeschlossen',\n    pdf_error: '‚ùå PDF-Verarbeitungsfehler',\n    // Rest of translations\n    photo_added: '‚úÖ Foto hinzugef√ºgt',\n    photos_count: 'Fotos',\n    add_more: '+ Weitere Fotos',\n    analyze_now: '‚ñ∂ Analyse starten',\n    analyzing: 'Bildanalyse l√§uft...',\n    found: '*Erkannte Leistungen:*',\n    edit_hint: 'Zur Bearbeitung antippen',\n    calc: 'Preisermittlung',\n    ready: '*KOSTENVORANSCHLAG*',\n    total: 'GESAMT',\n    days: 'Tage',\n    pct: 'Trefferquote',\n    workers: 'Lohn',\n    machines: 'Ger√§te',\n    materials: 'Material',\n    subtotal: 'Zusammenfassung',\n    searching: 'Suche',\n    of: 'von',\n    not_found: 'Keine √úbereinstimmung',\n    low_conf: 'Pr√ºfung empfohlen',\n    price_note: 'Preisbasis: Berlin 2025',\n    btn_calc: '‚ñ∂ Berechnen',\n    btn_new: '+ Neues Projekt',\n    btn_lang: '‚öô Sprache',\n    btn_edit: '‚úé √Ñndern',\n    btn_delete: '‚úï Entfernen',\n    btn_add_work: '+ Position',\n    btn_done: '‚úÖ Fertig',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª Neu starten',\n    btn_help: '? Hilfe',\n    loading: 'Preisermittlung l√§uft...',\n    more_in_html: 'Detaillierter Bericht verf√ºgbar',\n    resources: 'Details: Ressourcen & Leistungsumfang',\n    enter_work: '*Neue Position hinzuf√ºgen*\\nFormat: Bezeichnung, Menge Einheit\\nBeispiel: Gipskartonwand, 15 m¬≤',\n    work_added: '‚úÖ Position hinzugef√ºgt',\n    what_next: '*Weitere Optionen:*',\n    categories: 'Kategorien',\n    cat_demolition: 'Abbruch',\n    cat_rough: 'Rohbau',\n    cat_finishing: 'Ausbau',\n    cat_mep: 'TGA',\n    help_title: '*Benutzerhandbuch*',\n    help_text: `*Benutzerhandbuch*\n\n*1. Dokumentation*\nSenden Sie Fotos, PDF-Pl√§ne oder Beschreibung.\nPDF: max. 3 Seiten werden analysiert.\n\n*2. Pr√ºfung*\n√úberpr√ºfen Sie die erkannten Leistungen.\n\n*3. Kalkulation*\nPreisermittlung aus DDC CWICR Datenbank.\n\n*4. Export*\nErgebnisse als Excel oder PDF.\n\n*Befehle:*\n/start ‚Äî Neues Projekt\n/help ‚Äî Diese Hilfe`,\n    doc_title: 'KOSTENVORANSCHLAG',\n    col_pos: 'Pos', col_code: 'Kennziffer', col_desc: 'Bezeichnung', col_unit: 'Einh.', col_qty: 'Menge', col_price: 'EP', col_total: 'GP', col_labor: 'Std', col_quality: 'Q',\n    grand_total: 'GESAMTSUMME', labor_cost: 'Lohnkosten', material_cost: 'Materialkosten', labor_days: 'Arbeitstage',\n    kpi_total: 'Gesamtkosten', kpi_hours: 'Arbeitsstunden', kpi_days: 'Arbeitstage',\n    chart_cost_structure: 'Kostenstruktur', chart_labor: 'Lohn', chart_material: 'Material', chart_machines: 'Ger√§te',\n    res_labor: 'Lohn', res_material: 'Mat', res_machine: 'Ger',\n    collapse_all: 'Alle einklappen', expand_all: 'Alle ausklappen',\n    quality_high: 'Hohe √úbereinstimmung', quality_medium: 'Mittlere √úbereinstimmung', quality_low: 'Geringe √úbereinstimmung',\n    export_excel_msg: 'Excel-Export (CSV)', export_pdf_msg: 'PDF-Export', btn_refine: 'Genauer analysieren', found_pct: 'gefunden', more_resources: 'weitere', kpi_items: 'Positionen', scope_title: 'Leistungsumfang', show_scope: 'Leistungen anzeigen'\n  },\n\n  'EN': { \n    fallback_start: 'Use /start to begin', \n    rooms: '–∫–æ–º–Ω–∞—Ç', works_identified: 'works', general: '–û–±—â–µ–µ', no_works: '–†–∞–±–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', items: '–ø–æ–∑–∏—Ü–∏–π', min: '–º–∏–Ω', \n    db: 'ENG_TORONTO_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'English', flag: 'üá¨üáß', native: 'English', cur: 'CAD', sym: '$', loc: 'en-CA', region: 'Toronto', search_lang: 'English',\n    ok: '‚úÖ *English* ¬∑ Toronto ¬∑ CAD',\n    photo: `*Send photo, PDF or description*\n\nüìÑ *PDF drawings* ‚Äî floor plan or blueprint (max 3 pages)\nüì∑ *Photo* ‚Äî photograph room or object\n‚úèÔ∏è *Text* ‚Äî describe work as a list\n\n_Example to copy:_\n\\`\\`\\`\nDrywall 2-layer metal stud CW75 25m2\nPorcelain tiles 60x60 bathroom 15m2\nPlastering level 3 ceiling walls 120m2\nElectrical outlets flush mount 20 pcs\n\\`\\`\\`\n\nOr send photo/PDF üì∑üìÑ`,\n    // PDF specific\n    pdf_received: 'üìÑ *PDF received*',\n    pdf_processing: '‚è≥ Analyzing drawing...',\n    pdf_pages: 'pages',\n    pdf_page_limit: '‚ö†Ô∏è Processing first 3 pages only',\n    pdf_rooms_found: 'üè† Rooms found',\n    pdf_elements_found: 'üß± Elements found',\n    pdf_works_generated: 'üìù Works generated',\n    pdf_analyzing_page: 'üîç Analyzing page',\n    pdf_of: 'of',\n    pdf_complete: '‚úÖ Analysis complete',\n    pdf_error: '‚ùå PDF processing error',\n    // Rest\n    photo_added: '‚úÖ Photo added',\n    photos_count: 'photos',\n    add_more: '+ Add more',\n    analyze_now: '‚ñ∂ Start analysis',\n    analyzing: 'Analyzing images...',\n    found: '*Identified Work Items:*',\n    edit_hint: 'Tap to edit',\n    calc: 'Pricing lookup',\n    ready: '*COST ESTIMATE*',\n    total: 'TOTAL',\n    days: 'days',\n    pct: 'Match rate',\n    workers: 'Labor',\n    machines: 'Equipment',\n    materials: 'Materials',\n    subtotal: 'Summary',\n    searching: 'Searching',\n    of: 'of',\n    not_found: 'No match found',\n    low_conf: 'Review recommended',\n    price_note: 'Price basis: Toronto 2025',\n    btn_calc: '‚ñ∂ Calculate',\n    btn_new: '+ New Project',\n    btn_lang: '‚öô Language',\n    btn_edit: '‚úé Edit',\n    btn_delete: '‚úï Remove',\n    btn_add_work: '+ Add Item',\n    btn_done: '‚úÖ Done',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª Start Over',\n    btn_help: '? Help',\n    loading: 'Calculating prices...',\n    more_in_html: 'Detailed report available',\n    resources: 'Details: Resources & Scope of Work',\n    enter_work: '*Add New Item*\\nFormat: Description, Quantity Unit\\nExample: Drywall installation, 15 m¬≤',\n    work_added: '‚úÖ Item added',\n    what_next: '*Options:*',\n    categories: 'Categories',\n    cat_demolition: 'Demolition',\n    cat_rough: 'Structure',\n    cat_finishing: 'Finishes',\n    cat_mep: 'MEP',\n    help_title: '*User Guide*',\n    help_text: `*User Guide*\n\n*1. Documentation*\nSend photos, PDF plans or description.\nPDF: max 3 pages will be analyzed.\n\n*2. Review*\nCheck identified work items.\n\n*3. –†–∞—Å—á—ë—Ç*\nPricing from DDC CWICR database.\n\n*4. Export*\nExport as Excel or PDF.\n\n*Commands:*\n/start ‚Äî New project\n/help ‚Äî This guide`,\n    doc_title: 'COST ESTIMATE',\n    col_pos: 'No', col_code: 'Code', col_desc: 'Description', col_unit: 'Unit', col_qty: 'Qty', col_price: 'Rate', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'GRAND TOTAL', labor_cost: 'Labor Cost', material_cost: 'Material Cost', labor_days: 'Work Days',\n    kpi_total: 'Total Cost', kpi_hours: 'Work Hours', kpi_days: 'Work Days',\n    chart_cost_structure: 'Cost Structure', chart_labor: 'Labor', chart_material: 'Material', chart_machines: 'Equipment',\n    res_labor: 'Labor', res_material: 'Mat', res_machine: 'Equip',\n    collapse_all: 'Collapse all', expand_all: 'Expand all',\n    quality_high: 'High confidence', quality_medium: 'Medium confidence', quality_low: 'Low confidence',\n    export_excel_msg: 'Excel Export (CSV)', export_pdf_msg: 'PDF Export', btn_refine: 'Refine Analysis', found_pct: 'found', more_resources: 'more', kpi_items: 'Items', scope_title: 'Scope of Work', show_scope: 'Show scope'\n  },\n\n  'RU': { \n    fallback_start: '–ù–∞–∂–º–∏—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞', \n    rooms: '–∫–æ–º–Ω–∞—Ç', works_identified: '–ø–æ–∑–∏—Ü–∏–π', general: '–û–±—â–µ–µ', no_works: '–†–∞–±–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', items: '–ø–æ–∑–∏—Ü–∏–π', min: '–º–∏–Ω', \n    db: 'RU_STPETERSBURG_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Russian', flag: 'üá∑üá∫', native: '–†—É—Å—Å–∫–∏–π', cur: 'RUB', sym: '‚ÇΩ', loc: 'ru-RU', region: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', search_lang: 'Russian',\n    ok: '‚úÖ *–†—É—Å—Å–∫–∏–π* ¬∑ –°–ü–± ¬∑ RUB',\n    photo: `*–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ, PDF –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ*\n\nüìÑ *PDF —á–µ—Ä—Ç–µ–∂–∏* ‚Äî –ø–ª–∞–Ω —ç—Ç–∞–∂–∞ –∏–ª–∏ —á–µ—Ä—Ç—ë–∂ (–¥–æ 3 —Å—Ç—Ä.)\nüì∑ *–§–æ—Ç–æ* ‚Äî —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –ø–æ–º–µ—â–µ–Ω–∏–µ\n‚úèÔ∏è *–¢–µ–∫—Å—Ç* ‚Äî –æ–ø–∏—à–∏—Ç–µ —Ä–∞–±–æ—Ç—ã —Å–ø–∏—Å–∫–æ–º\n\n_–ü—Ä–∏–º–µ—Ä –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:_\n\\`\\`\\`\n–ì–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω 2 —Å–ª–æ—è –ø—Ä–æ—Ñ–∏–ª—å –ü–ü60 25–º2\n–ü–ª–∏—Ç–∫–∞ –∫–µ—Ä–∞–º–æ–≥—Ä–∞–Ω–∏—Ç 60x60 –≤–∞–Ω–Ω–∞—è 15–º2\n–®–ø–∞–∫–ª–µ–≤–∫–∞ –ø–æ–¥ –ø–æ–∫—Ä–∞—Å–∫—É –ø–æ—Ç–æ–ª–∫–∏ —Å—Ç–µ–Ω—ã 120–º2\n–†–æ–∑–µ—Ç–∫–∏ —Å–∫—Ä—ã—Ç—ã–π –º–æ–Ω—Ç–∞–∂ 20—à—Ç\n\\`\\`\\`\n\n–ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ/PDF üì∑üìÑ`,\n    // PDF specific\n    pdf_received: 'üìÑ *PDF –ø–æ–ª—É—á–µ–Ω*',\n    pdf_processing: '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —á–µ—Ä—Ç—ë–∂...',\n    pdf_pages: '—Å—Ç—Ä.',\n    pdf_page_limit: '‚ö†Ô∏è –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –ø–µ—Ä–≤—ã–µ 3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã',\n    pdf_rooms_found: 'üè† –ù–∞–π–¥–µ–Ω–æ –ø–æ–º–µ—â–µ–Ω–∏–π',\n    pdf_elements_found: 'üß± –ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤',\n    pdf_works_generated: 'üìù –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ —Ä–∞–±–æ—Ç',\n    pdf_analyzing_page: '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É',\n    pdf_of: '–∏–∑',\n    pdf_complete: '‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω',\n    pdf_error: '‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ PDF',\n    // Rest\n    photo_added: '‚úÖ –§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ',\n    photos_count: '—Ñ–æ—Ç–æ',\n    add_more: '+ –ï—â—ë —Ñ–æ—Ç–æ',\n    analyze_now: '‚ñ∂ –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑',\n    analyzing: '–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...',\n    found: '*–û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã:*',\n    edit_hint: '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è',\n    calc: '–ü–æ–∏—Å–∫ —Ä–∞—Å—Ü–µ–Ω–æ–∫',\n    ready: '*–°–ú–ï–¢–ê*',\n    total: '–ò–¢–û–ì–û',\n    days: '–¥–Ω.',\n    pct: '–¢–æ—á–Ω–æ—Å—Ç—å',\n    workers: '–¢—Ä—É–¥',\n    machines: '–ú–µ—Ö–∞–Ω–∏–∑–º—ã',\n    materials: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã',\n    subtotal: '–°–≤–æ–¥–∫–∞',\n    searching: '–ü–æ–∏—Å–∫',\n    of: '–∏–∑',\n    not_found: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',\n    low_conf: '–¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏',\n    price_note: '–ë–∞–∑–∞ —Ü–µ–Ω: –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ 2025',\n    btn_calc: '‚ñ∂ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å',\n    btn_new: '+ –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç',\n    btn_lang: '‚öô –Ø–∑—ã–∫',\n    btn_edit: '‚úé –ò–∑–º–µ–Ω–∏—Ç—å',\n    btn_delete: '‚úï –£–¥–∞–ª–∏—Ç—å',\n    btn_add_work: '+ –ü–æ–∑–∏—Ü–∏—è',\n    btn_done: '‚úÖ –ì–æ—Ç–æ–≤–æ',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª –ó–∞–Ω–æ–≤–æ',\n    btn_help: '? –°–ø—Ä–∞–≤–∫–∞',\n    loading: '–†–∞—Å—á—ë—Ç...',\n    more_in_html: '–ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç –¥–æ—Å—Ç—É–ø–µ–Ω',\n    resources: '–ü–æ–¥—Ä–æ–±–Ω–µ–µ: —Ä–µ—Å—É—Ä—Å—ã –∏ —Å–æ—Å—Ç–∞–≤—ã —Ä–∞–±–æ—Ç',\n    enter_work: '*–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é*\\n–§–æ—Ä–º–∞—Ç: –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ï–¥–∏–Ω–∏—Ü–∞\\n–ü—Ä–∏–º–µ—Ä: –ú–æ–Ω—Ç–∞–∂ –ì–ö–õ, 15 –º¬≤',\n    work_added: '‚úÖ –ü–æ–∑–∏—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞',\n    what_next: '*–î–µ–π—Å—Ç–≤–∏—è:*',\n    categories: '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏',\n    cat_demolition: '–î–µ–º–æ–Ω—Ç–∞–∂',\n    cat_rough: '–ß–µ—Ä–Ω–æ–≤—ã–µ',\n    cat_finishing: '–û—Ç–¥–µ–ª–∫–∞',\n    cat_mep: '–ò–Ω–∂–µ–Ω–µ—Ä–∏—è',\n    help_title: '*–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ*',\n    help_text: `*–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è*\n\n*1. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è*\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ, PDF-–ø–ª–∞–Ω –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ.\nPDF: –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –¥–æ 3 —Å—Ç—Ä–∞–Ω–∏—Ü.\n\n*2. –ü—Ä–æ–≤–µ—Ä–∫–∞*\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã.\n\n*3. –†–∞—Å—á—ë—Ç*\n–¶–µ–Ω—ã –∏–∑ –±–∞–∑—ã DDC CWICR.\n\n*4. –≠–∫—Å–ø–æ—Ä—Ç*\n–í—ã–≥—Ä—É–∑–∫–∞ –≤ Excel –∏–ª–∏ PDF.\n\n*–ö–æ–º–∞–Ω–¥—ã:*\n/start ‚Äî –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç\n/help ‚Äî –°–ø—Ä–∞–≤–∫–∞`,\n    doc_title: '–°–ú–ï–¢–ê',\n    col_pos: '‚Ññ', col_code: '–®–∏—Ñ—Ä', col_desc: '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', col_unit: '–ï–¥.', col_qty: '–ö–æ–ª.', col_price: '–¶–µ–Ω–∞', col_total: '–°—É–º–º–∞', col_labor: '–ß/—á', col_quality: '–ö',\n    grand_total: '–í–°–ï–ì–û', labor_cost: '–§–û–¢', material_cost: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã', labor_days: '–î–Ω–µ–π',\n    kpi_total: '–°—Ç–æ–∏–º–æ—Å—Ç—å', kpi_hours: '–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã', kpi_days: '–°—Ä–æ–∫',\n    chart_cost_structure: '–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞—Ç—Ä–∞—Ç', chart_labor: '–¢—Ä—É–¥', chart_material: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã', chart_machines: '–ú–µ—Ö–∞–Ω–∏–∑–º—ã',\n    res_labor: '–¢—Ä—É–¥', res_material: '–ú–∞—Ç', res_machine: '–ú–µ—Ö',\n    collapse_all: '–°–≤–µ—Ä–Ω—É—Ç—å', expand_all: '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å',\n    quality_high: '–í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å', quality_medium: '–°—Ä–µ–¥–Ω—è—è —Ç–æ—á–Ω–æ—Å—Ç—å', quality_low: '–ù–∏–∑–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å',\n    export_excel_msg: '–≠–∫—Å–ø–æ—Ä—Ç Excel (CSV)', export_pdf_msg: '–≠–∫—Å–ø–æ—Ä—Ç PDF', btn_refine: '–£—Ç–æ—á–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑', found_pct: '–Ω–∞–π–¥–µ–Ω–æ', more_resources: '–µ—â—ë', kpi_items: '–ü–æ–∑–∏—Ü–∏–∏', scope_title: '–°–æ—Å—Ç–∞–≤ —Ä–∞–±–æ—Ç', show_scope: '–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–∞–≤'\n  },\n\n  'ES': { \n    fallback_start: 'Pulse /start para comenzar', \n    rooms: 'habitaciones', works_identified: 'trabajos', general: '–û–±—â–µ–µ', no_works: 'Sin trabajos', items: 'elementos', min: '–º–∏–Ω', \n    db: 'ES_BARCELONA_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Spanish', flag: 'üá™üá∏', native: 'Espa√±ol', cur: 'EUR', sym: '‚Ç¨', loc: 'es-ES', region: 'Barcelona', search_lang: 'Spanish',\n    ok: '‚úÖ *Espa√±ol* ¬∑ Barcelona ¬∑ EUR',\n    photo: `*Env√≠e foto, PDF o descripci√≥n*\n\nüìÑ *Planos PDF* ‚Äî plano de planta o dibujo (m√°x. 3 p√°gs.)\nüì∑ *Foto* ‚Äî fotograf√≠e el espacio\n‚úèÔ∏è *Texto* ‚Äî describa trabajos en lista\n\n_Ejemplo para copiar:_\n\\`\\`\\`\nPladur 2 capas perfil met√°lico 25m2\nAzulejos porcel√°nico 60x60 ba√±o 15m2\nAlisado para pintura techos paredes 120m2\nEnchufes empotrados 20uds\n\\`\\`\\`\n\nO env√≠e foto/PDF üì∑üìÑ`,\n    pdf_received: 'üìÑ *PDF recibido*',\n    pdf_processing: '‚è≥ Analizando plano...',\n    pdf_pages: 'p√°ginas',\n    pdf_page_limit: '‚ö†Ô∏è Solo se procesan las primeras 3 p√°ginas',\n    pdf_rooms_found: 'üè† Habitaciones encontradas',\n    pdf_elements_found: 'üß± Elementos encontrados',\n    pdf_works_generated: 'üìù Trabajos generados',\n    pdf_analyzing_page: 'üîç Analizando p√°gina',\n    pdf_of: 'de',\n    pdf_complete: '‚úÖ An√°lisis completado',\n    pdf_error: '‚ùå Error al procesar PDF',\n    photo_added: '‚úÖ Foto a√±adida',\n    photos_count: 'fotos',\n    add_more: '+ M√°s fotos',\n    analyze_now: '‚ñ∂ Analizar',\n    analyzing: 'Analizando...',\n    found: '*Trabajos identificados:*',\n    edit_hint: 'Toque para editar',\n    calc: 'B√∫squeda de precios',\n    ready: '*PRESUPUESTO*',\n    total: 'TOTAL',\n    days: 'd√≠as',\n    pct: 'Precisi√≥n',\n    workers: 'M.O.',\n    machines: 'Equipos',\n    materials: 'Materiales',\n    subtotal: 'Resumen',\n    searching: 'Buscando',\n    of: 'de',\n    not_found: 'Sin coincidencia',\n    low_conf: 'Revisar',\n    price_note: 'Base: Barcelona 2025',\n    btn_calc: '‚ñ∂ Calcular',\n    btn_new: '+ Nuevo',\n    btn_lang: '‚öô Idioma',\n    btn_edit: '‚úé Editar',\n    btn_delete: '‚úï Eliminar',\n    btn_add_work: '+ Partida',\n    btn_done: '‚úÖ Listo',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª Reiniciar',\n    btn_help: '? Ayuda',\n    loading: 'Calculando...',\n    more_in_html: 'Informe detallado disponible',\n    resources: 'Detalles: recursos y alcance',\n    enter_work: '*A√±adir partida*\\nFormato: Descripci√≥n, Cantidad Unidad',\n    work_added: '‚úÖ A√±adido',\n    what_next: '*Opciones:*',\n    categories: 'Categor√≠as',\n    cat_demolition: 'Demolici√≥n',\n    cat_rough: 'Estructura',\n    cat_finishing: 'Acabados',\n    cat_mep: 'Instalaciones',\n    help_title: '*Gu√≠a*',\n    help_text: `*Gu√≠a de uso*\n\n*1.* Env√≠e fotos, PDF o descripci√≥n\nPDF: m√°x. 3 p√°ginas\n*2.* Revise los trabajos\n*3.* Calcule precios\n*4.* Exporte\n\n/start ‚Äî Nuevo\n/help ‚Äî Ayuda`,\n    doc_title: 'PRESUPUESTO',\n    col_pos: 'N¬∫', col_code: 'C√≥digo', col_desc: 'Descripci√≥n', col_unit: 'Ud', col_qty: 'Cant', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'TOTAL', labor_cost: 'M.O.', material_cost: 'Materiales', labor_days: 'D√≠as',\n    kpi_total: 'Coste Total', kpi_hours: 'Horas', kpi_days: 'D√≠as',\n    chart_cost_structure: 'Estructura', chart_labor: 'M.O.', chart_material: 'Mat', chart_machines: 'Eq',\n    res_labor: 'MO', res_material: 'Mat', res_machine: 'Eq',\n    collapse_all: 'Contraer', expand_all: 'Expandir',\n    quality_high: 'Alta', quality_medium: 'Media', quality_low: 'Baja',\n    export_excel_msg: 'Exportar Excel', export_pdf_msg: 'Exportar PDF', btn_refine: 'Refinar', found_pct: 'encontrado', more_resources: 'm√°s', kpi_items: 'Art√≠culos', scope_title: 'Alcance', show_scope: 'Ver alcance'\n  },\n\n  'FR': { \n    fallback_start: 'Appuyez sur /start pour commencer', \n    rooms: 'pi√®ces', works_identified: 'travaux', general: 'G√©n√©ral', no_works: 'Aucun travail', items: '√©l√©ments', min: '–º–∏–Ω', \n    db: 'FR_PARIS_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'French', flag: 'üá´üá∑', native: 'Fran√ßais', cur: 'EUR', sym: '‚Ç¨', loc: 'fr-FR', region: 'Paris', search_lang: 'French',\n    ok: '‚úÖ *Fran√ßais* ¬∑ Paris ¬∑ EUR',\n    photo: `*Envoyez photo, PDF ou description*\n\nüìÑ *Plans PDF* ‚Äî plan d'√©tage ou dessin (max 3 pages)\nüì∑ *Photo* ‚Äî photographiez l'espace\n‚úèÔ∏è *Texte* ‚Äî d√©crivez les travaux en liste\n\n_Exemple √† copier:_\n\\`\\`\\`\nPlaco 2 couches ossature m√©tallique 25m2\nCarrelage gr√®s c√©rame 60x60 sdb 15m2\nEnduit plafonds murs 120m2\nPrises encastr√©es 20pcs\n\\`\\`\\`\n\nOu envoyez photo/PDF üì∑üìÑ`,\n    pdf_received: 'üìÑ *PDF re√ßu*',\n    pdf_processing: '‚è≥ Analyse du plan...',\n    pdf_pages: 'pages',\n    pdf_page_limit: '‚ö†Ô∏è Seules les 3 premi√®res pages sont trait√©es',\n    pdf_rooms_found: 'üè† Pi√®ces trouv√©es',\n    pdf_elements_found: 'üß± √âl√©ments trouv√©s',\n    pdf_works_generated: 'üìù Travaux g√©n√©r√©s',\n    pdf_analyzing_page: 'üîç Analyse de la page',\n    pdf_of: 'sur',\n    pdf_complete: '‚úÖ Analyse termin√©e',\n    pdf_error: '‚ùå Erreur de traitement PDF',\n    photo_added: '‚úÖ Photo ajout√©e',\n    photos_count: 'photos',\n    add_more: '+ Autres photos',\n    analyze_now: '‚ñ∂ Analyser',\n    analyzing: 'Analyse en cours...',\n    found: '*Ouvrages identifi√©s:*',\n    edit_hint: 'Appuyez pour modifier',\n    calc: 'Recherche des prix',\n    ready: '*DEVIS*',\n    total: 'TOTAL',\n    days: 'jours',\n    pct: 'Pr√©cision',\n    workers: 'M.O.',\n    machines: 'Mat√©riel',\n    materials: 'Mat√©riaux',\n    subtotal: 'R√©sum√©',\n    searching: 'Recherche',\n    of: 'sur',\n    not_found: 'Non trouv√©',\n    low_conf: '√Ä v√©rifier',\n    price_note: 'Base: Paris 2025',\n    btn_calc: '‚ñ∂ Calculer',\n    btn_new: '+ Nouveau',\n    btn_lang: '‚öô Langue',\n    btn_edit: '‚úé Modifier',\n    btn_delete: '‚úï Supprimer',\n    btn_add_work: '+ Ouvrage',\n    btn_done: '‚úÖ Termin√©',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª Recommencer',\n    btn_help: '? Aide',\n    loading: 'Calcul en cours...',\n    more_in_html: 'Rapport d√©taill√© disponible',\n    resources: 'D√©tails: ressources et description',\n    enter_work: '*Ajouter ouvrage*\\nFormat: Description, Quantit√© Unit√©',\n    work_added: '‚úÖ Ajout√©',\n    what_next: '*Options:*',\n    categories: 'Cat√©gories',\n    cat_demolition: 'D√©molition',\n    cat_rough: 'Gros ≈ìuvre',\n    cat_finishing: 'Finitions',\n    cat_mep: 'CVC',\n    help_title: '*Guide*',\n    help_text: `*Guide d'utilisation*\n\n*1.* Envoyez photos, PDF ou description\nPDF: max 3 pages\n*2.* V√©rifiez les ouvrages\n*3.* Calculez les prix\n*4.* Exportez\n\n/start ‚Äî Nouveau\n/help ‚Äî Aide`,\n    doc_title: 'DEVIS',\n    col_pos: 'N¬∞', col_code: 'Code', col_desc: 'D√©signation', col_unit: 'U', col_qty: 'Qt√©', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'TOTAL', labor_cost: 'M.O.', material_cost: 'Mat√©riaux', labor_days: 'Jours',\n    kpi_total: 'Co√ªt Total', kpi_hours: 'Heures', kpi_days: 'Jours',\n    chart_cost_structure: 'Structure', chart_labor: 'M.O.', chart_material: 'Mat', chart_machines: '√âq',\n    res_labor: 'MO', res_material: 'Mat', res_machine: '√âq',\n    collapse_all: 'R√©duire', expand_all: 'D√©velopper',\n    quality_high: 'Haute', quality_medium: 'Moyenne', quality_low: 'Faible',\n    export_excel_msg: 'Export Excel', export_pdf_msg: 'Export PDF', btn_refine: 'Affiner', found_pct: 'trouv√©', more_resources: 'plus', kpi_items: 'Articles', scope_title: 'Description', show_scope: 'Voir description'\n  },\n\n  'PT': { \n    fallback_start: 'Pressione /start para come√ßar', \n    rooms: 'quartos', works_identified: 'trabalhos', general: 'Geral', no_works: 'Sem trabalhos', items: 'itens', min: '–º–∏–Ω', \n    db: 'PT_SAOPAULO_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Portuguese', flag: 'üáßüá∑', native: 'Portugu√™s', cur: 'BRL', sym: 'R$', loc: 'pt-BR', region: 'S√£o Paulo', search_lang: 'Portuguese',\n    ok: '‚úÖ *Portugu√™s* ¬∑ S√£o Paulo ¬∑ BRL',\n    photo: `*Envie foto, PDF ou descri√ß√£o*\n\nüìÑ *Plantas PDF* ‚Äî planta baixa ou desenho (m√°x. 3 p√°gs.)\nüì∑ *Foto* ‚Äî fotografe o ambiente\n‚úèÔ∏è *Texto* ‚Äî descreva os trabalhos em lista\n\n_Exemplo para copiar:_\n\\`\\`\\`\nDrywall 2 camadas perfil met√°lico 25m2\nPorcelanato 60x60 banheiro 15m2\nMassa corrida teto paredes 120m2\nTomadas embutidas 20un\n\\`\\`\\`\n\nOu envie foto/PDF üì∑üìÑ`,\n    pdf_received: 'üìÑ *PDF recebido*',\n    pdf_processing: '‚è≥ Analisando planta...',\n    pdf_pages: 'p√°ginas',\n    pdf_page_limit: '‚ö†Ô∏è Processando apenas as 3 primeiras p√°ginas',\n    pdf_rooms_found: 'üè† C√¥modos encontrados',\n    pdf_elements_found: 'üß± Elementos encontrados',\n    pdf_works_generated: 'üìù Trabalhos gerados',\n    pdf_analyzing_page: 'üîç Analisando p√°gina',\n    pdf_of: 'de',\n    pdf_complete: '‚úÖ An√°lise conclu√≠da',\n    pdf_error: '‚ùå Erro ao processar PDF',\n    photo_added: '‚úÖ Foto adicionada',\n    photos_count: 'fotos',\n    add_more: '+ Mais fotos',\n    analyze_now: '‚ñ∂ Analisar',\n    analyzing: 'Analisando...',\n    found: '*Servi√ßos identificados:*',\n    edit_hint: 'Toque para editar',\n    calc: 'Busca de pre√ßos',\n    ready: '*OR√áAMENTO*',\n    total: 'TOTAL',\n    days: 'dias',\n    pct: 'Precis√£o',\n    workers: 'M.O.',\n    machines: 'Equipamentos',\n    materials: 'Materiais',\n    subtotal: 'Resumo',\n    searching: 'Buscando',\n    of: 'de',\n    not_found: 'N√£o encontrado',\n    low_conf: 'Verificar',\n    price_note: 'Base: S√£o Paulo 2025',\n    btn_calc: '‚ñ∂ Calcular',\n    btn_new: '+ Novo',\n    btn_lang: '‚öô Idioma',\n    btn_edit: '‚úé Editar',\n    btn_delete: '‚úï Excluir',\n    btn_add_work: '+ Servi√ßo',\n    btn_done: '‚úÖ Pronto',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª Recome√ßar',\n    btn_help: '? Ajuda',\n    loading: 'Calculando...',\n    more_in_html: 'Relat√≥rio detalhado dispon√≠vel',\n    resources: 'Detalhes: recursos e escopo',\n    enter_work: '*Adicionar servi√ßo*\\nFormato: Descri√ß√£o, Quantidade Unidade',\n    work_added: '‚úÖ Adicionado',\n    what_next: '*Op√ß√µes:*',\n    categories: 'Categorias',\n    cat_demolition: 'Demoli√ß√£o',\n    cat_rough: 'Estrutura',\n    cat_finishing: 'Acabamento',\n    cat_mep: 'Instala√ß√µes',\n    help_title: '*Guia*',\n    help_text: `*Guia de uso*\n\n*1.* Envie fotos, PDF ou descri√ß√£o\nPDF: m√°x. 3 p√°ginas\n*2.* Revise os servi√ßos\n*3.* Calcule pre√ßos\n*4.* Exporte\n\n/start ‚Äî Novo\n/help ‚Äî Ajuda`,\n    doc_title: 'OR√áAMENTO',\n    col_pos: 'N¬∫', col_code: 'C√≥digo', col_desc: 'Descri√ß√£o', col_unit: 'Un', col_qty: 'Qtd', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'TOTAL', labor_cost: 'M.O.', material_cost: 'Materiais', labor_days: 'Dias',\n    kpi_total: 'Custo Total', kpi_hours: 'Horas', kpi_days: 'Dias',\n    chart_cost_structure: 'Estrutura', chart_labor: 'M.O.', chart_material: 'Mat', chart_machines: 'Eq',\n    res_labor: 'MO', res_material: 'Mat', res_machine: 'Eq',\n    collapse_all: 'Recolher', expand_all: 'Expandir',\n    quality_high: 'Alta', quality_medium: 'M√©dia', quality_low: 'Baixa',\n    export_excel_msg: 'Exportar Excel', export_pdf_msg: 'Exportar PDF', btn_refine: 'Refinar', found_pct: 'encontrado', more_resources: 'mais', kpi_items: 'Itens', scope_title: 'Escopo', show_scope: 'Ver escopo'\n  },\n\n  'ZH': { \n    db: 'ZH_SHANGHAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Chinese', flag: 'üá®üá≥', native: '‰∏≠Êñá', cur: 'CNY', sym: '¬•', loc: 'zh-CN', region: '‰∏äÊµ∑', search_lang: 'Chinese',\n    ok: '‚úÖ *‰∏≠Êñá* ¬∑ ‰∏äÊµ∑ ¬∑ CNY',\n    photo: `*ÂèëÈÄÅÁÖßÁâá„ÄÅPDFÊàñÊèèËø∞*\n\nüìÑ *PDFÂõæÁ∫∏* ‚Äî Âπ≥Èù¢ÂõæÊàñÂõæÁ∫∏ÔºàÊúÄÂ§ö3È°µÔºâ\nüì∑ *ÁÖßÁâá* ‚Äî ÊãçÊëÑÊàøÈó¥ÊàñÁâ©‰Ωì\n‚úèÔ∏è *ÊñáÂ≠ó* ‚Äî ‰ª•ÂàóË°®ÂΩ¢ÂºèÊèèËø∞\n\n_Â§çÂà∂Á§∫‰æãÔºö_\n\\`\\`\\`\nÁü≥ËÜèÊùøÂèåÂ±ÇËΩªÈí¢ÈæôÈ™® 25m2\nÁì∑Á†ñ600x600Âç´ÁîüÈó¥ 15m2\nËÖªÂ≠êÊâæÂπ≥È°∂Â¢ô 120m2\nÊöóË£ÖÊèíÂ∫ß 20‰∏™\n\\`\\`\\`\n\nÊàñÂèëÈÄÅÁÖßÁâá/PDF üì∑üìÑ`,\n    pdf_received: 'üìÑ *Â∑≤Êî∂Âà∞PDF*',\n    pdf_processing: '‚è≥ Ê≠£Âú®ÂàÜÊûêÂõæÁ∫∏...',\n    pdf_pages: 'È°µ',\n    pdf_page_limit: '‚ö†Ô∏è ‰ªÖÂ§ÑÁêÜÂâç3È°µ',\n    pdf_rooms_found: 'üè† ÂèëÁé∞ÊàøÈó¥',\n    pdf_elements_found: 'üß± ÂèëÁé∞ÂÖÉÁ¥†',\n    pdf_works_generated: 'üìù Â∑≤ÁîüÊàêÂ∑•‰ΩúÈ°π',\n    pdf_analyzing_page: 'üîç Ê≠£Âú®ÂàÜÊûêÁ¨¨',\n    pdf_of: 'È°µÔºåÂÖ±',\n    pdf_complete: '‚úÖ ÂàÜÊûêÂÆåÊàê',\n    pdf_error: '‚ùå PDFÂ§ÑÁêÜÈîôËØØ',\n    photo_added: '‚úÖ ÁÖßÁâáÂ∑≤Ê∑ªÂä†',\n    photos_count: 'Âº†',\n    add_more: '+ Êõ¥Â§öÁÖßÁâá',\n    analyze_now: '‚ñ∂ ÂºÄÂßãÂàÜÊûê',\n    analyzing: 'ÂàÜÊûê‰∏≠...',\n    found: '*ËØÜÂà´ÁöÑÂ∑•‰ΩúÈ°π:*',\n    edit_hint: 'ÁÇπÂáªÁºñËæë',\n    calc: '‰ª∑Ê†ºÊü•ËØ¢',\n    ready: '*Â∑•Á®ãÈ¢ÑÁÆó*',\n    total: 'ÂêàËÆ°',\n    days: 'Â§©',\n    pct: 'ÂåπÈÖçÁéá',\n    workers: '‰∫∫Â∑•',\n    machines: 'Êú∫Ê¢∞',\n    materials: 'ÊùêÊñô',\n    subtotal: 'ÊëòË¶Å',\n    searching: 'ÊêúÁ¥¢',\n    of: '/',\n    not_found: 'Êú™ÊâæÂà∞',\n    low_conf: 'ÈúÄÊ†∏Êü•',\n    price_note: '‰ª∑Ê†ºÂü∫ÂáÜÔºö‰∏äÊµ∑ 2025',\n    btn_calc: '‚ñ∂ ËÆ°ÁÆó',\n    btn_new: '+ Êñ∞È°πÁõÆ',\n    btn_lang: '‚öô ËØ≠Ë®Ä',\n    btn_edit: '‚úé ÁºñËæë',\n    btn_delete: '‚úï Âà†Èô§',\n    btn_add_work: '+ Ê∑ªÂä†',\n    btn_done: '‚úÖ ÂÆåÊàê',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª ÈáçÊñ∞ÂºÄÂßã',\n    btn_help: '? Â∏ÆÂä©',\n    loading: 'ËÆ°ÁÆó‰∏≠...',\n    more_in_html: 'ËØ¶ÁªÜÊä•ÂëäÂèØÁî®',\n    resources: 'ËØ¶ÊÉÖÔºöËµÑÊ∫êÂíåÂ∑•‰ΩúËåÉÂõ¥',\n    enter_work: '*Ê∑ªÂä†È°πÁõÆ*\\nÊ†ºÂºèÔºöÊèèËø∞ÔºåÊï∞Èáè Âçï‰Ωç',\n    work_added: '‚úÖ Â∑≤Ê∑ªÂä†',\n    what_next: '*ÈÄâÈ°π:*',\n    categories: 'Á±ªÂà´',\n    cat_demolition: 'ÊãÜÈô§',\n    cat_rough: 'ÁªìÊûÑ',\n    cat_finishing: 'Ë£ÖÈ•∞',\n    cat_mep: 'Êú∫Áîµ',\n    help_title: '*ÊåáÂçó*',\n    help_text: `*‰ΩøÁî®ÊåáÂçó*\n\n*1.* ÂèëÈÄÅÁÖßÁâá„ÄÅPDFÊàñÊèèËø∞\nPDFÔºöÊúÄÂ§ö3È°µ\n*2.* Ê£ÄÊü•Â∑•‰ΩúÈ°π\n*3.* ËÆ°ÁÆó‰ª∑Ê†º\n*4.* ÂØºÂá∫\n\n/start ‚Äî Êñ∞È°πÁõÆ\n/help ‚Äî Â∏ÆÂä©`,\n    doc_title: 'È¢ÑÁÆó',\n    col_pos: 'Â∫èÂè∑', col_code: 'ÁºñÁ†Å', col_desc: 'ÂêçÁß∞', col_unit: 'Âçï‰Ωç', col_qty: 'Êï∞Èáè', col_price: 'Âçï‰ª∑', col_total: 'ÂêàËÆ°', col_labor: 'Â∑•Êó∂', col_quality: 'Ë¥®',\n    grand_total: 'ÊÄªËÆ°', labor_cost: '‰∫∫Â∑•Ë¥π', material_cost: 'ÊùêÊñôË¥π', labor_days: 'Â∑•Êúü',\n    kpi_total: 'ÊÄªÊàêÊú¨', kpi_hours: 'Â∑•Êó∂', kpi_days: 'Â∑•Êúü',\n    chart_cost_structure: 'ÊàêÊú¨ÁªìÊûÑ', chart_labor: '‰∫∫Â∑•', chart_material: 'ÊùêÊñô', chart_machines: 'Êú∫Ê¢∞',\n    res_labor: '‰∫∫Â∑•', res_material: 'ÊùêÊñô', res_machine: 'Êú∫Ê¢∞',\n    collapse_all: 'ÊäòÂè†', expand_all: 'Â±ïÂºÄ',\n    quality_high: 'È´ò', quality_medium: '‰∏≠', quality_low: '‰Ωé',\n    export_excel_msg: 'ÂØºÂá∫Excel', export_pdf_msg: 'ÂØºÂá∫PDF', btn_refine: 'Á≤æÁ°ÆÂàÜÊûê', found_pct: 'ÊâæÂà∞', more_resources: 'Êõ¥Â§ö', kpi_items: 'È°πÁõÆ', scope_title: 'Â∑•‰ΩúËåÉÂõ¥', show_scope: 'Êü•ÁúãËåÉÂõ¥'\n  },\n\n  'AR': { \n    db: 'AR_DUBAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Arabic', flag: 'üá¶üá™', native: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', cur: 'AED', sym: 'ÿØ.ÿ•', loc: 'ar-AE', region: 'ÿØÿ®Ÿä', search_lang: 'Arabic',\n    ok: '‚úÖ *ÿßŸÑÿπÿ±ÿ®Ÿäÿ©* ¬∑ ÿØÿ®Ÿä ¬∑ AED',\n    photo: `*ÿ£ÿ±ÿ≥ŸÑ ÿµŸàÿ±ÿ© ÿ£Ÿà PDF ÿ£Ÿà ŸàÿµŸÅ*\n\nüìÑ *ŸÖÿÆÿ∑ÿ∑ÿßÿ™ PDF* ‚Äî ŸÖÿÆÿ∑ÿ∑ ÿßŸÑÿ∑ÿßÿ®ŸÇ ÿ£Ÿà ÿßŸÑÿ±ÿ≥ŸÖ (ÿ≠ÿ™Ÿâ 3 ÿµŸÅÿ≠ÿßÿ™)\nüì∑ *ÿµŸàÿ±ÿ©* ‚Äî ÿßŸÑÿ™ŸÇÿ∑ ÿµŸàÿ±ÿ© ŸÑŸÑŸÖŸÉÿßŸÜ\n‚úèÔ∏è *ŸÜÿµ* ‚Äî ÿµŸÅ ÿßŸÑÿ£ÿπŸÖÿßŸÑ ŸÉŸÇÿßÿ¶ŸÖÿ©\n\n_ŸÖÿ´ÿßŸÑ ŸÑŸÑŸÜÿ≥ÿÆ:_\n\\`\\`\\`\nÿ¨ÿ®ÿ≥ ÿ®Ÿàÿ±ÿØ ÿ∑ÿ®ŸÇÿ™ŸäŸÜ ŸáŸäŸÉŸÑ ŸÖÿπÿØŸÜŸä 25ŸÖ2\nÿ®ŸÑÿßÿ∑ ÿ≥Ÿäÿ±ÿßŸÖŸäŸÉ 60x60 ÿ≠ŸÖÿßŸÖ 15ŸÖ2\nŸÖÿπÿ¨ŸàŸÜ ÿ£ÿ≥ŸÇŸÅ ÿ¨ÿØÿ±ÿßŸÜ 120ŸÖ2\nŸÖŸÇÿßÿ®ÿ≥ ŸÖÿÆŸÅŸäÿ© 20ŸÇÿ∑ÿπÿ©\n\\`\\`\\`\n\nÿ£Ÿà ÿ£ÿ±ÿ≥ŸÑ ÿµŸàÿ±ÿ©/PDF üì∑üìÑ`,\n    pdf_received: 'üìÑ *ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ PDF*',\n    pdf_processing: '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖÿÆÿ∑ÿ∑...',\n    pdf_pages: 'ÿµŸÅÿ≠ÿßÿ™',\n    pdf_page_limit: '‚ö†Ô∏è ŸÖÿπÿßŸÑÿ¨ÿ© ÿ£ŸàŸÑ 3 ÿµŸÅÿ≠ÿßÿ™ ŸÅŸÇÿ∑',\n    pdf_rooms_found: 'üè† ÿßŸÑÿ∫ÿ±ŸÅ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©',\n    pdf_elements_found: 'üß± ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©',\n    pdf_works_generated: 'üìù ÿßŸÑÿ£ÿπŸÖÿßŸÑ ÿßŸÑŸÖŸèŸÜÿ¥ÿ£ÿ©',\n    pdf_analyzing_page: 'üîç ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©',\n    pdf_of: 'ŸÖŸÜ',\n    pdf_complete: '‚úÖ ÿßŸÉÿ™ŸÖŸÑ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ',\n    pdf_error: '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© PDF',\n    photo_added: '‚úÖ ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©',\n    photos_count: 'ÿµŸàÿ±',\n    add_more: '+ ÿßŸÑŸÖÿ≤ŸäÿØ',\n    analyze_now: '‚ñ∂ ÿ™ÿ≠ŸÑŸäŸÑ',\n    analyzing: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ...',\n    found: '*ÿßŸÑÿ£ÿπŸÖÿßŸÑ ÿßŸÑŸÖÿ≠ÿØÿØÿ©:*',\n    edit_hint: 'ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ™ÿπÿØŸäŸÑ',\n    calc: 'ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ£ÿ≥ÿπÿßÿ±',\n    ready: '*ÿßŸÑÿ™ŸÇÿØŸäÿ±*',\n    total: 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ',\n    days: 'ŸäŸàŸÖ',\n    pct: 'ÿßŸÑÿØŸÇÿ©',\n    workers: 'ÿπŸÖÿßŸÑÿ©',\n    machines: 'ŸÖÿπÿØÿßÿ™',\n    materials: 'ŸÖŸàÿßÿØ',\n    subtotal: 'ŸÖŸÑÿÆÿµ',\n    searching: 'ÿ®ÿ≠ÿ´',\n    of: 'ŸÖŸÜ',\n    not_found: 'ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ',\n    low_conf: 'ŸÑŸÑŸÖÿ±ÿßÿ¨ÿπÿ©',\n    price_note: 'ÿßŸÑÿ£ÿ≥ÿßÿ≥: ÿØÿ®Ÿä 2025',\n    btn_calc: '‚ñ∂ ÿ≠ÿ≥ÿßÿ®',\n    btn_new: '+ ÿ¨ÿØŸäÿØ',\n    btn_lang: '‚öô ŸÑÿ∫ÿ©',\n    btn_edit: '‚úé ÿ™ÿπÿØŸäŸÑ',\n    btn_delete: '‚úï ÿ≠ÿ∞ŸÅ',\n    btn_add_work: '+ ÿ•ÿ∂ÿßŸÅÿ©',\n    btn_done: '‚úÖ ÿ™ŸÖ',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª ÿßŸÑÿ®ÿØÿ° ŸÖŸÜ ÿ¨ÿØŸäÿØ',\n    btn_help: '? ŸÖÿ≥ÿßÿπÿØÿ©',\n    loading: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ÿ≥ÿßÿ®...',\n    more_in_html: 'ÿ™ŸÇÿ±Ÿäÿ± ŸÖŸÅÿµŸÑ ŸÖÿ™ÿßÿ≠',\n    resources: 'ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ: ÿßŸÑŸÖŸàÿßÿ±ÿØ ŸàŸÜÿ∑ÿßŸÇ ÿßŸÑÿπŸÖŸÑ',\n    enter_work: '*ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸÜÿØ*\\nÿßŸÑÿµŸäÿ∫ÿ©: ÿßŸÑŸàÿµŸÅÿå ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸàÿ≠ÿØÿ©',\n    work_added: '‚úÖ ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©',\n    what_next: '*ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™:*',\n    categories: 'ÿßŸÑŸÅÿ¶ÿßÿ™',\n    cat_demolition: 'ŸáÿØŸÖ',\n    cat_rough: 'ŸáŸäŸÉŸÑ',\n    cat_finishing: 'ÿ™ÿ¥ÿ∑Ÿäÿ®',\n    cat_mep: 'ŸÖŸäŸÉÿßŸÜŸäŸÉ',\n    help_title: '*ÿØŸÑŸäŸÑ*',\n    help_text: `*ÿØŸÑŸäŸÑ ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ*\n\n*1.* ÿ£ÿ±ÿ≥ŸÑ ÿµŸàÿ± ÿ£Ÿà PDF ÿ£Ÿà ŸàÿµŸÅ\nPDF: ÿ≠ÿ™Ÿâ 3 ÿµŸÅÿ≠ÿßÿ™\n*2.* ÿ±ÿßÿ¨ÿπ ÿßŸÑÿ£ÿπŸÖÿßŸÑ\n*3.* ÿßÿ≠ÿ≥ÿ® ÿßŸÑÿ£ÿ≥ÿπÿßÿ±\n*4.* ÿµÿØŸëÿ±\n\n/start ‚Äî ÿ¨ÿØŸäÿØ\n/help ‚Äî ŸÖÿ≥ÿßÿπÿØÿ©`,\n    doc_title: 'ÿßŸÑÿ™ŸÇÿØŸäÿ±',\n    col_pos: 'ÿ±ŸÇŸÖ', col_code: 'ÿßŸÑÿ±ŸÖÿ≤', col_desc: 'ÿßŸÑŸàÿµŸÅ', col_unit: 'Ÿàÿ≠ÿØÿ©', col_qty: 'ŸÉŸÖŸäÿ©', col_price: 'ÿ≥ÿπÿ±', col_total: 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ', col_labor: 'ÿ≥ÿßÿπÿßÿ™', col_quality: 'ÿ¨',\n    grand_total: 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä', labor_cost: 'ÿπŸÖÿßŸÑÿ©', material_cost: 'ŸÖŸàÿßÿØ', labor_days: 'ÿ£ŸäÿßŸÖ',\n    kpi_total: 'ÿßŸÑÿ™ŸÉŸÑŸÅÿ©', kpi_hours: 'ÿ≥ÿßÿπÿßÿ™', kpi_days: 'ÿ£ŸäÿßŸÖ',\n    chart_cost_structure: 'ÿßŸÑŸáŸäŸÉŸÑ', chart_labor: 'ÿπŸÖÿßŸÑÿ©', chart_material: 'ŸÖŸàÿßÿØ', chart_machines: 'ŸÖÿπÿØÿßÿ™',\n    res_labor: 'ÿπŸÖÿßŸÑÿ©', res_material: 'ŸÖŸàÿßÿØ', res_machine: 'ŸÖÿπÿØÿßÿ™',\n    collapse_all: 'ÿ∑Ÿä', expand_all: 'ÿ™Ÿàÿ≥Ÿäÿπ',\n    quality_high: 'ÿπÿßŸÑŸäÿ©', quality_medium: 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©', quality_low: 'ŸÖŸÜÿÆŸÅÿ∂ÿ©',\n    export_excel_msg: 'ÿ™ÿµÿØŸäÿ± Excel', export_pdf_msg: 'ÿ™ÿµÿØŸäÿ± PDF', btn_refine: 'ÿ™ÿ≠ŸÑŸäŸÑ ÿ£ÿØŸÇ', found_pct: 'Ÿàÿ¨ÿØ', more_resources: 'ÿßŸÑŸÖÿ≤ŸäÿØ', kpi_items: 'ÿ®ŸÜŸàÿØ', scope_title: 'ŸÜÿ∑ÿßŸÇ ÿßŸÑÿπŸÖŸÑ', show_scope: 'ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ∑ÿßŸÇ'\n  },\n\n  'HI': { \n    db: 'HI_MUMBAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Hindi', flag: 'üáÆüá≥', native: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä', cur: 'INR', sym: '‚Çπ', loc: 'hi-IN', region: '‡§Æ‡•Å‡§Ç‡§¨‡§à', search_lang: 'Hindi',\n    ok: '‚úÖ *‡§π‡§ø‡§®‡•ç‡§¶‡•Ä* ¬∑ ‡§Æ‡•Å‡§Ç‡§¨‡§à ¬∑ INR',\n    photo: `*‡§´‡§º‡•ã‡§ü‡•ã, PDF ‡§Ø‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡•á‡§ú‡•á‡§Ç*\n\nüìÑ *PDF ‡§°‡•ç‡§∞‡§æ‡§á‡§Ç‡§ó* ‚Äî ‡§´‡•ç‡§≤‡•ã‡§∞ ‡§™‡•ç‡§≤‡§æ‡§® ‡§Ø‡§æ ‡§¨‡•ç‡§≤‡•Ç‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü (‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 3 ‡§™‡•á‡§ú)\nüì∑ *‡§´‡§º‡•ã‡§ü‡•ã* ‚Äî ‡§ï‡§Æ‡§∞‡•á ‡§Ø‡§æ ‡§µ‡§∏‡•ç‡§§‡•Å ‡§ï‡•Ä ‡§´‡§º‡•ã‡§ü‡•ã\n‚úèÔ∏è *‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü* ‚Äî ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§∏‡•Ç‡§ö‡•Ä ‡§Æ‡•á‡§Ç\n\n_‡§ï‡•â‡§™‡•Ä ‡§â‡§¶‡§æ‡§π‡§∞‡§£:_\n\\`\\`\\`\n‡§°‡•ç‡§∞‡§æ‡§à‡§µ‡•â‡§≤ 2 ‡§≤‡•á‡§Ø‡§∞ ‡§Æ‡•á‡§ü‡§≤ ‡§´‡•ç‡§∞‡•á‡§Æ 25m2\n‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ 60x60 ‡§¨‡§æ‡§•‡§∞‡•Ç‡§Æ 15m2\n‡§™‡•Å‡§ü‡•ç‡§ü‡•Ä ‡§õ‡§§ ‡§¶‡•Ä‡§µ‡§æ‡§∞‡•á‡§Ç 120m2\n‡§∏‡•â‡§ï‡•á‡§ü 20 ‡§™‡•Ä‡§∏\n\\`\\`\\`\n\n‡§Ø‡§æ ‡§´‡§º‡•ã‡§ü‡•ã/PDF ‡§≠‡•á‡§ú‡•á‡§Ç üì∑üìÑ`,\n    pdf_received: 'üìÑ *PDF ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§*',\n    pdf_processing: '‚è≥ ‡§°‡•ç‡§∞‡§æ‡§á‡§Ç‡§ó ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£...',\n    pdf_pages: '‡§™‡•á‡§ú',\n    pdf_page_limit: '‚ö†Ô∏è ‡§ï‡•á‡§µ‡§≤ ‡§™‡§π‡§≤‡•á 3 ‡§™‡•á‡§ú ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§π‡•ã‡§Ç‡§ó‡•á',\n    pdf_rooms_found: 'üè† ‡§ï‡§Æ‡§∞‡•á ‡§Æ‡§ø‡§≤‡•á',\n    pdf_elements_found: 'üß± ‡§è‡§≤‡§ø‡§Æ‡•á‡§Ç‡§ü ‡§Æ‡§ø‡§≤‡•á',\n    pdf_works_generated: 'üìù ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§¨‡§®‡§æ‡§è ‡§ó‡§è',\n    pdf_analyzing_page: 'üîç ‡§™‡•á‡§ú ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£',\n    pdf_of: '‡§Æ‡•á‡§Ç ‡§∏‡•á',\n    pdf_complete: '‚úÖ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§™‡•Ç‡§∞‡•ç‡§£',\n    pdf_error: '‚ùå PDF ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø',\n    photo_added: '‚úÖ ‡§´‡§º‡•ã‡§ü‡•ã ‡§ú‡•ã‡§°‡§º‡•Ä ‡§ó‡§à',\n    photos_count: '‡§´‡§º‡•ã‡§ü‡•ã',\n    add_more: '+ ‡§î‡§∞ ‡§´‡§º‡•ã‡§ü‡•ã',\n    analyze_now: '‚ñ∂ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£',\n    analyzing: '‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£...',\n    found: '*‡§™‡§π‡§ö‡§æ‡§®‡•á ‡§ó‡§è ‡§ï‡§æ‡§∞‡•ç‡§Ø:*',\n    edit_hint: '‡§∏‡§Ç‡§™‡§æ‡§¶‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡•à‡§™ ‡§ï‡§∞‡•á‡§Ç',\n    calc: '‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§ñ‡•ã‡§ú',\n    ready: '*‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®*',\n    total: '‡§ï‡•Å‡§≤',\n    days: '‡§¶‡§ø‡§®',\n    pct: '‡§∏‡§ü‡•Ä‡§ï‡§§‡§æ',\n    workers: '‡§∂‡•ç‡§∞‡§Æ',\n    machines: '‡§â‡§™‡§ï‡§∞‡§£',\n    materials: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä',\n    subtotal: '‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂',\n    searching: '‡§ñ‡•ã‡§ú',\n    of: '‡§Æ‡•á‡§Ç ‡§∏‡•á',\n    not_found: '‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ',\n    low_conf: '‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç',\n    price_note: '‡§Ü‡§ß‡§æ‡§∞: ‡§Æ‡•Å‡§Ç‡§¨‡§à 2025',\n    btn_calc: '‚ñ∂ ‡§ó‡§£‡§®‡§æ',\n    btn_new: '+ ‡§®‡§Ø‡§æ',\n    btn_lang: '‚öô ‡§≠‡§æ‡§∑‡§æ',\n    btn_edit: '‚úé ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§',\n    btn_delete: '‚úï ‡§π‡§ü‡§æ‡§è‡§Ç',\n    btn_add_work: '+ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç',\n    btn_done: '‚úÖ ‡§π‡•ã ‡§ó‡§Ø‡§æ',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª ‡§´‡§ø‡§∞ ‡§∏‡•á',\n    btn_help: '? ‡§Æ‡§¶‡§¶',\n    loading: '‡§ó‡§£‡§®‡§æ...',\n    more_in_html: '‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§â‡§™‡§≤‡§¨‡•ç‡§ß',\n    resources: '‡§µ‡§ø‡§µ‡§∞‡§£: ‡§∏‡§Ç‡§∏‡§æ‡§ß‡§® ‡§î‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞',\n    enter_work: '*‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç*\\n‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™: ‡§µ‡§ø‡§µ‡§∞‡§£, ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§á‡§ï‡§æ‡§à',\n    work_added: '‚úÖ ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ',\n    what_next: '*‡§µ‡§ø‡§ï‡§≤‡•ç‡§™:*',\n    categories: '‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç',\n    cat_demolition: '‡§§‡•ã‡§°‡§º‡§´‡•ã‡§°‡§º',\n    cat_rough: '‡§¢‡§æ‡§Ç‡§ö‡§æ',\n    cat_finishing: '‡§´‡§º‡§ø‡§®‡§ø‡§∂‡§ø‡§Ç‡§ó',\n    cat_mep: 'MEP',\n    help_title: '*‡§ó‡§æ‡§á‡§°*',\n    help_text: `*‡§â‡§™‡§Ø‡•ã‡§ó ‡§ó‡§æ‡§á‡§°*\n\n*1.* ‡§´‡§º‡•ã‡§ü‡•ã, PDF ‡§Ø‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡•á‡§ú‡•á‡§Ç\nPDF: ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 3 ‡§™‡•á‡§ú\n*2.* ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç\n*3.* ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§ó‡§£‡§®‡§æ\n*4.* ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§\n\n/start ‚Äî ‡§®‡§Ø‡§æ\n/help ‚Äî ‡§Æ‡§¶‡§¶`,\n    doc_title: '‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®',\n    col_pos: '‡§ï‡•ç‡§∞‡§Æ', col_code: '‡§ï‡•ã‡§°', col_desc: '‡§µ‡§ø‡§µ‡§∞‡§£', col_unit: '‡§á‡§ï‡§æ‡§à', col_qty: '‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ', col_price: '‡§¶‡§∞', col_total: '‡§ï‡•Å‡§≤', col_labor: '‡§ò‡§Ç‡§ü‡•á', col_quality: '‡§ó‡•Å',\n    grand_total: '‡§ï‡•Å‡§≤ ‡§Ø‡•ã‡§ó', labor_cost: '‡§∂‡•ç‡§∞‡§Æ', material_cost: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä', labor_days: '‡§¶‡§ø‡§®',\n    kpi_total: '‡§ï‡•Å‡§≤ ‡§≤‡§æ‡§ó‡§§', kpi_hours: '‡§ò‡§Ç‡§ü‡•á', kpi_days: '‡§¶‡§ø‡§®',\n    chart_cost_structure: '‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ', chart_labor: '‡§∂‡•ç‡§∞‡§Æ', chart_material: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä', chart_machines: '‡§â‡§™‡§ï‡§∞‡§£',\n    res_labor: '‡§∂‡•ç‡§∞‡§Æ', res_material: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä', res_machine: '‡§â‡§™‡§ï‡§∞‡§£',\n    collapse_all: '‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§', expand_all: '‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§',\n    quality_high: '‡§â‡§ö‡•ç‡§ö', quality_medium: '‡§Æ‡§ß‡•ç‡§Ø‡§Æ', quality_low: '‡§®‡§ø‡§Æ‡•ç‡§®',\n    export_excel_msg: 'Excel ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§', export_pdf_msg: 'PDF ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§', btn_refine: '‡§∏‡•Å‡§ß‡§æ‡§∞‡•á‡§Ç', found_pct: '‡§Æ‡§ø‡§≤‡§æ', more_resources: '‡§î‡§∞', kpi_items: '‡§Ü‡§á‡§ü‡§Æ', scope_title: '‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞', show_scope: '‡§¶‡•á‡§ñ‡•á‡§Ç'\n  }\n};\n\nconst L = LANGS[lang] || LANGS['EN'];\n\n// Update session with language data\nif (sd.sess && sd.sess[chatId]) { \n  sd.sess[chatId].db = L.db; \n  sd.sess[chatId].L = L; \n}\n\n// Get voice/PDF file IDs from session if available\nconst voiceFileId = sd.sess?.[chatId]?.voiceFileId || input.voiceFileId || null;\nconst pdfFileId = sd.sess?.[chatId]?.pdfFileId || input.pdfFileId || null;\nconst pdfFileName = sd.sess?.[chatId]?.pdfFileName || input.pdfFileName || null;\n\nreturn { \n  json: { \n    ...input, \n    L: L, \n    db: L.db, \n    voiceFileId,\n    pdfFileId,\n    pdfFileName,\n    // API Keys passthrough\n    AI_PROVIDER: input.AI_PROVIDER || 'gemini',\n    GEMINI_API_KEY: input.GEMINI_API_KEY,\n    OPENAI_API_KEY: input.OPENAI_API_KEY\n  } \n};"
      },
      "id": "bcbc487b-c4cd-4c03-bca9-f742a19d99f7",
      "name": "Config",
      "type": "n8n-nodes-base.code",
      "position": [
        480,
        -720
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// MAIN ROUTER - Central message handler\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// MAIN ROUTER v8.5 PRO - Multi-photo, Voice, PDF, Edit, Categories, Export\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst update = $('Telegram Trigger').first().json;\nconst botToken = $input.first().json.bot_token;\nconst isCallback = !!update.callback_query;\n\nlet chatId, callbackData, callbackQueryId, text, fileId, hasImage, caption;\nlet hasVoice, voiceFileId, mediaGroupId;\nlet hasPDF, pdfFileId, pdfFileName; // PDF support\n\nif (isCallback) {\n  const cb = update.callback_query;\n  chatId = cb.message?.chat?.id;\n  callbackData = cb.data || '';\n  callbackQueryId = cb.id;\n  text = ''; fileId = null; hasImage = false; caption = ''; \n  hasVoice = false; voiceFileId = null; mediaGroupId = null;\n  hasPDF = false; pdfFileId = null; pdfFileName = null;\n} else {\n  const msg = update.message || {};\n  chatId = msg.chat?.id;\n  callbackData = ''; callbackQueryId = '';\n  text = msg.text || ''; caption = msg.caption || '';\n  mediaGroupId = msg.media_group_id || null;\n  \n  // Photo detection\n  const photo = msg.photo || [];\n  fileId = photo.length > 0 ? photo[photo.length - 1].file_id : null;\n  hasImage = !!fileId;\n  if (!fileId && msg.document?.mime_type?.startsWith('image/')) {\n    fileId = msg.document.file_id; hasImage = true;\n  }\n  \n  // Voice detection\n  hasVoice = !!(msg.voice || msg.audio);\n  voiceFileId = msg.voice?.file_id || msg.audio?.file_id || null;\n  \n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // PDF DOCUMENT DETECTION\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  const doc = msg.document || {};\n  hasPDF = doc.mime_type === 'application/pdf';\n  pdfFileId = hasPDF ? doc.file_id : null;\n  pdfFileName = hasPDF ? (doc.file_name || 'document.pdf') : null;\n}\n\nconst sd = $getWorkflowStaticData('global');\nif (!sd.sess) sd.sess = {};\nconst cid = String(chatId);\nif (!sd.sess[cid]) sd.sess[cid] = { \n  lang: null, works: [], state: 'new', db: null, L: null, \n  photos: [], voiceText: '', description: '',\n  categories: { demolition: true, rough: true, finishing: true, mep: true },\n  // PDF state\n  pdfFileId: null, pdfFileName: null, pdfPages: [], \n  rooms: [], elements: [], pdfProcessed: false\n};\nconst S = sd.sess[cid];\n\nlet action = 'none';\n\n// === COMMANDS ===\nif (text.toLowerCase() === '/start') {\n  S.lang = null; S.works = []; S.state = 'wait_lang'; S.db = null; S.L = null;\n  S.photos = []; S.voiceText = ''; S.description = '';\n  S.pdfFileId = null; S.pdfFileName = null; S.rooms = []; S.elements = []; S.pdfProcessed = false;\n  action = 'show_lang';\n}\nelse if (text.toLowerCase() === '/help') {\n  action = 'show_help';\n}\n\n// === LANGUAGE SELECTION ===\nelse if (/^lang_(DE|EN|RU|ES|FR|PT|ZH|AR|HI)$/i.test(callbackData)) {\n  S.lang = callbackData.replace('lang_', '').toUpperCase();\n  S.state = 'wait_photo'; action = 'lang_selected';\n}\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PDF HANDLING\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nelse if (hasPDF && S.lang) {\n  S.pdfFileId = pdfFileId;\n  S.pdfFileName = pdfFileName;\n  S.state = 'processing_pdf';\n  S.description = `üìÑ ${pdfFileName}`;\n  action = 'process_pdf';\n}\n\n// === PHOTO HANDLING (Multi-photo support) ===\nelse if (hasImage && S.lang) {\n  S.photos.push({ fileId, caption });\n  if (caption) S.description = caption;\n  \n  if (mediaGroupId) {\n    S.mediaGroupId = mediaGroupId;\n    S.state = 'collecting_photos';\n    action = 'photo_added';\n  } else {\n    S.state = 'ready_to_analyze';\n    action = 'show_analyze_options';\n  }\n}\n\n// === VOICE MESSAGE ===\nelse if (hasVoice && S.lang) {\n  S.voiceFileId = voiceFileId;\n  S.state = 'processing_voice';\n  action = 'process_voice';\n}\n\n// === ANALYZE BUTTON ===\nelse if (callbackData === 'analyze_photos') {\n  if (S.photos.length > 0) {\n    S.state = 'analyzing';\n    action = 'analyze';\n  } else {\n    action = 'ask_photo';\n  }\n}\n\n// === ADD MORE PHOTOS ===\nelse if (callbackData === 'add_more_photos') {\n  S.state = 'wait_photo';\n  action = 'ask_photo';\n}\n\n// === CATEGORY FILTERS ===\nelse if (/^cat_(demolition|rough|finishing|mep)$/.test(callbackData)) {\n  const cat = callbackData.replace('cat_', '');\n  S.categories[cat] = !S.categories[cat];\n  action = 'update_categories';\n}\n\n// === EDIT WORK ITEMS ===\nelse if (/^edit_work_(\\d+)$/.test(callbackData)) {\n  const idx = parseInt(callbackData.match(/edit_work_(\\d+)/)[1]);\n  S.editingWorkIndex = idx;\n  S.state = 'editing_work';\n  action = 'show_edit_menu';\n}\nelse if (/^delete_work_(\\d+)$/.test(callbackData)) {\n  const idx = parseInt(callbackData.match(/delete_work_(\\d+)/)[1]);\n  if (S.works[idx]) {\n    S.works.splice(idx, 1);\n    S.works.forEach((w, i) => { w.seq = i + 1; w.id = `W${String(i+1).padStart(3,'0')}`; });\n  }\n  action = 'works_updated';\n}\nelse if (/^qty_work_(\\d+)_(.+)$/.test(callbackData)) {\n  const match = callbackData.match(/qty_work_(\\d+)_(.+)/);\n  const idx = parseInt(match[1]);\n  const change = match[2];\n  if (S.works[idx]) {\n    let q = S.works[idx].qty;\n    if (change === 'plus10') q += 10;\n    else if (change === 'minus10') q = Math.max(1, q - 10);\n    else if (change === 'plus1') q += 1;\n    else if (change === 'minus1') q = Math.max(1, q - 1);\n    else if (change === 'double') q *= 2;\n    else if (change === 'half') q = Math.max(1, Math.round(q / 2));\n    S.works[idx].qty = q;\n  }\n  action = 'works_updated';\n}\nelse if (callbackData === 'add_work') {\n  S.state = 'adding_work';\n  action = 'ask_new_work';\n}\nelse if (callbackData === 'done_editing') {\n  S.state = 'works_shown';\n  action = 'works_updated';\n}\n\n// === CALCULATE ===\nelse if (callbackData === 'refine_analysis') {\n  action = 'refine_analysis';\n}\nelse if (callbackData === 'calculate') {\n  if (S.works && S.works.length > 0) {\n    S.state = 'calc';\n    action = 'start_calc';\n  } else {\n    action = 'ask_photo';\n  }\n}\n\n// === EXPORT OPTIONS ===\nelse if (callbackData === 'view_details') {\n  action = 'view_details';\n}\nelse if (callbackData === 'export_excel') {\n  action = 'export_excel';\n}\nelse if (callbackData === 'export_pdf') {\n  action = 'export_pdf';\n}\n\n// === NEW ESTIMATE / RESTART ===\nelse if (callbackData === 'new_photo' || callbackData === 'new_estimate' || callbackData === 'restart') {\n  S.photos = []; S.works = []; S.voiceText = ''; S.description = '';\n  S.pdfFileId = null; S.pdfFileName = null; S.rooms = []; S.elements = []; S.pdfProcessed = false;\n  S.state = 'wait_photo';\n  action = 'ask_photo';\n}\nelse if (callbackData === 'show_help' || callbackData === 'help') {\n  action = 'show_help';\n}\nelse if (callbackData === 'change_language') {\n  S.lang = null; S.state = 'wait_lang';\n  action = 'show_lang';\n}\n\n// === TEXT INPUT (for adding work) ===\nelse if (text && S.state === 'adding_work') {\n  const parts = text.split(',');\n  const name = parts[0]?.trim() || text;\n  let qty = 1, unit = 'm¬≤';\n  if (parts[1]) {\n    const qtyMatch = parts[1].match(/([\\d.,]+)\\s*(.*)/);\n    if (qtyMatch) {\n      qty = parseFloat(qtyMatch[1].replace(',', '.')) || 1;\n      unit = qtyMatch[2]?.trim() || 'm¬≤';\n    }\n  }\n  const newWork = {\n    id: `W${String(S.works.length + 1).padStart(3,'0')}`,\n    name, query: name, qty, unit, conf: 'medium', category: 'general', seq: S.works.length + 1\n  };\n  S.works.push(newWork);\n  S.state = 'works_shown';\n  action = 'works_updated';\n}\n\n// === FALLBACKS ===\nelse if (!S.lang) { action = 'show_lang'; }\nelse if (S.state === 'wait_photo' && !hasImage && !hasPDF && text && text.length > 5) {\n  S.description = text;\n  S.textInput = text;\n  S.photos = S.photos || [];\n  action = 'analyze_text';\n}\nelse if (S.state === 'wait_photo' && !hasImage && !hasPDF) { action = 'ask_photo'; }\nelse if (S.state === 'collecting_photos') {\n  action = 'none';\n}\n\nreturn { json: { \n  bot_token: botToken, chatId, action, lang: S.lang, works: S.works, \n  callbackData, callbackQueryId, isCallback, hasImage, hasVoice, \n  fileId, voiceFileId, text, caption, photos: S.photos,\n  categories: S.categories, editingWorkIndex: S.editingWorkIndex,\n  description: S.description, voiceText: S.voiceText,\n  // PDF fields\n  hasPDF, pdfFileId, pdfFileName,\n  rooms: S.rooms, elements: S.elements, pdfProcessed: S.pdfProcessed\n}};"
      },
      "id": "d022b3a1-a2de-4702-9466-eef279eba760",
      "name": "Main",
      "type": "n8n-nodes-base.code",
      "position": [
        224,
        -720
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{\n  \"bot_token\": \"YOUR_TELEGRAM_BOT_TOKEN\",\n  \"AI_PROVIDER\": \"gemini\",\n  \"GEMINI_API_KEY\": \"AIzaSyBRqtnMxmXWHa_oG4hA9VfjmXuUWZEQypc\",\n  \"OPENAI_API_KEY\": \"AIzaSyBRqtnMxmXWHa_oG4hA9VfjmXuUWZEQypc\",\n  \"QDRANT_URL\": \"http://localhost:6333\",\n  \"QDRANT_API_KEY\": \"YOUR_QDRANT_API_KEY\"\n}",
        "options": {}
      },
      "id": "ba0cc982-3109-4238-b0c9-70d05ed78ee8",
      "name": "üîë TOKEN",
      "type": "n8n-nodes-base.set",
      "position": [
        -48,
        -720
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "telegram-bot-5zNg8gkl",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "18d8bc09-e432-4e53-98e0-33ae954da179",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.webhook",
      "position": [
        -240,
        -720
      ],
      "webhookId": "00faed2e",
      "typeVersion": 2
    },
    {
      "parameters": {
        "content": "## üëÅÔ∏è Block 4: Vision Analysis Pipeline\n\n**Photo Analysis Flow:**\n```\nRefine ‚Üí Prep Download ‚Üí Get File ‚Üí Download ‚Üí Convert Base64 ‚Üí Merge ‚Üí Prep Vision ‚Üí Call API ‚Üí Parse AI ‚Üí Show Works\n```\n\n**AI Providers:**\n- **Gemini 2.0 Flash** ‚Äî Fast, multilingual\n- **GPT-4 Vision** ‚Äî High accuracy\n\n**Output:** JSON with work items:\n- name, qty, unit, conf, cat",
        "height": 644,
        "width": 2248,
        "color": 6
      },
      "id": "2dcffbc6-23e2-482d-b6b8-436fbd6e7ec3",
      "name": "Block 4 - Vision",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1424,
        -1264
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üìÑ Block 5: PDF Floor Plan Processing\n\n**PDF Pipeline:**\n```\nDownload Prep ‚Üí Get Path ‚Üí Download ‚Üí Split Pages ‚Üí Loop ‚Üí Vision per Page ‚Üí Parse ‚Üí Accumulate\n```\n\n**Features:**\n- Multi-page PDF support\n- Room detection per page\n- Measurements extraction\n- Aggregation across pages",
        "height": 312,
        "width": 2896,
        "color": 6
      },
      "id": "198a2a31-4fc6-4c23-83b8-df200848dc48",
      "name": "Block 5 - PDF",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1424,
        -576
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üîÑ Block 6: Calculation Loop\n\n**Per Work Item:**\n```\nPrep Query ‚Üí LLM Transform ‚Üí Embedding ‚Üí Qdrant Search ‚Üí Rerank ‚Üí Calculate ‚Üí Update Result ‚Üí Accumulate\n```\n\n**Vector Search:**\n- OpenAI embeddings\n- Qdrant vector DB\n- 55,000+ construction rates\n\n**AI Reranking:**\n- LLM validates matches\n- Quality scoring (‚óè‚óã‚óå‚úï)",
        "height": 724,
        "width": 1728,
        "color": 3
      },
      "id": "85be0db3-dd9b-4ce9-b872-4fdd8ab8a94a",
      "name": "Block 6 - Calculation",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2000,
        272
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üìä Block 7: Aggregation & Reports\n\n**Final Processing:**\n```\nCleanup ‚Üí Delete Messages ‚Üí Aggregate ‚Üí Generate HTML ‚Üí Final Message ‚Üí Send HTML\n```\n\n**Report Contents:**\n- Work items with resources\n- Cost breakdown (Labor/Materials/Equipment)\n- Quality indicators\n- Total calculation",
        "height": 420,
        "width": 1720,
        "color": 6
      },
      "id": "2b2e4f05-0564-4d7a-b841-1163744fca6e",
      "name": "Block 7 - Reports",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2000,
        -176
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üì• Block 8: Export Options\n\n**Available Exports:**\n- üìä **Excel (CSV)** ‚Äî Spreadsheet format\n- üìÑ **PDF** ‚Äî Professional document\n- üåê **HTML** ‚Äî Interactive report\n\n**View Details:**\n- Full resource breakdown\n- Scope of work preview\n- Rate codes & names",
        "height": 692,
        "width": 1320,
        "color": 6
      },
      "id": "e685ad5b-b8ef-461a-862d-dd66eaf1714d",
      "name": "Block 8 - Export",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        656,
        96
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üîç Vector Search Setup\n\n**Qdrant Collections:**\n- `DDC_CWICR_DE` ‚Äî German\n- `DDC_CWICR_EN` ‚Äî English  \n- `DDC_CWICR_RU` ‚Äî Russian\n- ... (9 languages total)\n\n**To enable:**\n1. Install Qdrant locally/VPS\n2. Upload datasets from GitHub\n3. Configure URL & API key\n\n**Database:** 55,000+ rates",
        "height": 384,
        "width": 236
      },
      "id": "a955b8b5-2772-4ed2-988c-61bc5ee3a1bf",
      "name": "Qdrant Info",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3472,
        592
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Refine analysis with advanced prompt\n// FIXED: Check if photos are available before proceeding\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst L = cfg.L || session.L || {};\n\nconsole.log('=== REFINE ANALYSIS ===');\nconsole.log('Session keys:', Object.keys(session));\nconsole.log('photos_base64:', session.photos_base64?.length || 0);\nconsole.log('photos:', (cfg.photos || session.photos || []).length);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –ü–†–û–í–ï–†–Ø–ï–ú: –µ—Å—Ç—å –ª–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞?\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst hasStoredBase64 = session.photos_base64 && session.photos_base64.length > 0;\nconst hasPhotoFileIds = (cfg.photos && cfg.photos.length > 0) || (session.photos && session.photos.length > 0);\n\nconsole.log('hasStoredBase64:', hasStoredBase64);\nconsole.log('hasPhotoFileIds:', hasPhotoFileIds);\n\nif (!hasStoredBase64 && !hasPhotoFileIds) {\n  console.log('No photos available for refinement - will ask user');\n  \n  if (!sd.sess) sd.sess = {};\n  if (!sd.sess[cid]) sd.sess[cid] = {};\n  sd.sess[cid].state = 'wait_photo';\n  \n  return { json: { \n    ...cfg, \n    chatId: cid,\n    skipRefine: true,\n    noPhotos: true,\n    L \n  }};\n}\n\nconsole.log('Photos available - proceeding with refine');\n\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = {};\nsd.sess[cid].use_advanced_prompt = true;\n\nreturn { json: { \n  ...cfg, \n  chatId: cid,\n  use_advanced_prompt: true, \n  skipRefine: false,\n  noPhotos: false,\n  L \n}};"
      },
      "id": "9e880376-8302-4acb-82a0-7bcf9aaccdd6",
      "name": "Refine Analysis",
      "type": "n8n-nodes-base.code",
      "position": [
        1584,
        -928
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "14fdccc2-7a01-4d7d-9da0-81c0174beb68",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              },
              "leftValue": "={{ $json.skipRefine }}",
              "rightValue": true
            }
          ]
        },
        "options": {}
      },
      "id": "825eff40-cfea-4ba9-ace2-55ff4f82065e",
      "name": "IF Skip Refine",
      "type": "n8n-nodes-base.if",
      "position": [
        1728,
        -992
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify('üì∑ ' + (($json.L && $json.L.photo) ? $json.L.photo.split('\\n')[0] : 'Please send a photo first')) }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "a26eb25a-58bb-4a56-9af0-ebd02fe313eb",
      "name": "üì§ Ask Photo Refine",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1936,
        -1120
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Prepare photo download\n// FIXED: Check for stored base64 first (for Refine Analysis)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst botToken = $('üîë TOKEN').first().json.bot_token;\nconst L = cfg.L || session.L || {};\n\nconsole.log('=== PREP PHOTO DOWNLOAD ===');\nconsole.log('chatId:', cid);\nconsole.log('session.photos_base64:', session.photos_base64?.length || 0);\nconsole.log('cfg.photos:', (cfg.photos || []).length);\nconsole.log('session.photos:', (session.photos || []).length);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –ü–†–û–í–ï–†–Ø–ï–ú: –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–µ—Å—Å–∏–∏?\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nif (session.photos_base64 && session.photos_base64.length > 0) {\n  console.log('‚úÖ Found stored base64 in session:', session.photos_base64.length, 'photos');\n  console.log('First photo base64 length:', session.photos_base64[0]?.base64?.length || 0);\n  \n  return { json: { \n    ...cfg,\n    chatId: cid,\n    bot_token: cfg.bot_token,\n    photos: session.photos_base64,\n    photoCount: session.photos_base64.length,\n    description: session.description || cfg.description || '',\n    useStoredBase64: true,\n    skipDownload: true,\n    botToken: botToken,\n    lang: cfg.lang || session.lang,\n    L\n  }};\n}\n\nconst photos = cfg.photos || session.photos || [];\n\nconsole.log('Photos to download:', photos.length);\n\nif (!photos || photos.length === 0) {\n  console.log('‚ùå No photos available');\n  return { json: { \n    ...cfg, \n    chatId: cid,\n    bot_token: cfg.bot_token,\n    photos: [], \n    photoCount: 0,\n    skipDownload: true,\n    noPhotosError: true,\n    botToken: botToken,\n    L\n  }};\n}\n\nconst firstPhoto = photos[0];\n\nconsole.log('Downloading photo with fileId:', firstPhoto.fileId);\n\nreturn { json: { \n  ...cfg,\n  chatId: cid,\n  bot_token: cfg.bot_token,\n  fileId: firstPhoto.fileId,\n  allPhotos: photos,\n  photoIndex: 0,\n  botToken: botToken,\n  useStoredBase64: false,\n  skipDownload: false,\n  L\n}};"
      },
      "id": "7b9c9e13-11ea-4494-8355-fa903c56c77e",
      "name": "Prep Photo Download",
      "type": "n8n-nodes-base.code",
      "position": [
        1936,
        -976
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Prep Text LLM Request\n// Prepare API request for text-to-works analysis\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config').first().json;\nconst tokenConfig = $('üîë TOKEN').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst L = cfg.L || {};\n\nconst textInput = cfg.text || session.textInput || cfg.textInput || cfg.description || '';\nconst searchLang = L.search_lang || 'English';\n\nconsole.log('=== PREP TEXT LLM ===');\nconsole.log('Input:', textInput);\nconsole.log('Language:', searchLang);\n\nif (!textInput || textInput.length < 3) {\n  return { json: { ...cfg, chatId: cid, _skip_llm: true, works: [], description: 'No input' }};\n}\n\nconst GEMINI_API_KEY = tokenConfig.GEMINI_API_KEY || '';\nconst OPENAI_API_KEY = tokenConfig.OPENAI_API_KEY || '';\nconst provider = (tokenConfig.AI_PROVIDER || 'gemini').toLowerCase();\n\n// Language-specific examples\nconst LANG_EXAMPLES = {\n  'German': {\n    input: 'Renovierung Badezimmer 8qm',\n    output: '[{\"name\": \"Fliesendemontage Wand Boden\", \"qty\": 24, \"unit\": \"m¬≤\"}, {\"name\": \"Wandfliesen Feinsteinzeug 30x60\", \"qty\": 16, \"unit\": \"m¬≤\"}, {\"name\": \"Bodenfliesen rutschfest\", \"qty\": 8, \"unit\": \"m¬≤\"}, {\"name\": \"WC wandh√§ngend montieren\", \"qty\": 1, \"unit\": \"pcs\"}, {\"name\": \"Waschtisch montieren\", \"qty\": 1, \"unit\": \"pcs\"}]'\n  },\n  'English': {\n    input: 'Bathroom renovation 8sqm',\n    output: '[{\"name\": \"Tile removal walls floor\", \"qty\": 24, \"unit\": \"m¬≤\"}, {\"name\": \"Wall tiles porcelain 30x60\", \"qty\": 16, \"unit\": \"m¬≤\"}, {\"name\": \"Floor tiles anti-slip\", \"qty\": 8, \"unit\": \"m¬≤\"}, {\"name\": \"Wall-hung toilet install\", \"qty\": 1, \"unit\": \"pcs\"}, {\"name\": \"Vanity basin install\", \"qty\": 1, \"unit\": \"pcs\"}]'\n  },\n  'Russian': {\n    input: '—Ä–µ–º–æ–Ω—Ç –∫—É—Ö–Ω–∏ 20–º2 —Å—Ç–µ–Ω—ã –∏ –ª–∞–º–∏–Ω–∞—Ç',\n    output: '[{\"name\": \"–î–µ–º–æ–Ω—Ç–∞–∂ —Å—Ç–∞—Ä—ã—Ö –æ–±–æ–µ–≤\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"–®—Ç—É–∫–∞—Ç—É—Ä–∫–∞ —Å—Ç–µ–Ω –≥–∏–ø—Å–æ–≤–∞—è\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"–®–ø–∞–∫–ª—ë–≤–∫–∞ —Å—Ç–µ–Ω —Ñ–∏–Ω–∏—à–Ω–∞—è\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"–û–∫—Ä–∞—Å–∫–∞ —Å—Ç–µ–Ω –≤–æ–¥–æ—ç–º—É–ª—å—Å–∏–æ–Ω–Ω–∞—è\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"–î–µ–º–æ–Ω—Ç–∞–∂ –Ω–∞–ø–æ–ª—å–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è\", \"qty\": 20, \"unit\": \"m¬≤\"}, {\"name\": \"–£–∫–ª–∞–¥–∫–∞ –ª–∞–º–∏–Ω–∞—Ç–∞ —Å –ø–æ–¥–ª–æ–∂–∫–æ–π\", \"qty\": 20, \"unit\": \"m¬≤\"}, {\"name\": \"–ú–æ–Ω—Ç–∞–∂ –ø–ª–∏–Ω—Ç—É—Å–∞\", \"qty\": 18, \"unit\": \"m\"}]'\n  },\n  'Spanish': {\n    input: 'reforma cocina 20m2 paredes y suelo',\n    output: '[{\"name\": \"Retirada papel pintado\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Enlucido paredes\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Pintura paredes\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Demolici√≥n suelo\", \"qty\": 20, \"unit\": \"m¬≤\"}, {\"name\": \"Tarima flotante\", \"qty\": 20, \"unit\": \"m¬≤\"}]'\n  },\n  'French': {\n    input: 'r√©novation cuisine 20m2 murs et sol',\n    output: '[{\"name\": \"D√©pose papier peint\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Enduit murs\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Peinture murs\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"D√©pose rev√™tement sol\", \"qty\": 20, \"unit\": \"m¬≤\"}, {\"name\": \"Pose parquet flottant\", \"qty\": 20, \"unit\": \"m¬≤\"}]'\n  },\n  'Portuguese': {\n    input: 'reforma cozinha 20m2 paredes e piso',\n    output: '[{\"name\": \"Remo√ß√£o papel parede\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Reboco paredes\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Pintura paredes\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Remo√ß√£o piso\", \"qty\": 20, \"unit\": \"m¬≤\"}, {\"name\": \"Piso laminado\", \"qty\": 20, \"unit\": \"m¬≤\"}]'\n  }\n};\n\nconst langExample = LANG_EXAMPLES[searchLang] || LANG_EXAMPLES['English'];\n\nconst prompt = `You are a construction cost estimator. Extract ALL construction works from user's text.\n\nRULES:\n1. Output ONLY valid JSON array - NO explanations, NO markdown code blocks\n2. Generate works in ${searchLang} language  \n3. Be COMPREHENSIVE - include ALL works needed for described scope\n4. Use REALISTIC quantities based on area/room size mentioned\n5. Work names must be SPECIFIC for database search (not generic like \"wall work\")\n\nUNITS: m¬≤ (area), m (linear), pcs (items), kg, l\n\nEXAMPLE:\nInput: \"${langExample.input}\"\nOutput: ${langExample.output}\n\nUSER INPUT: \"${textInput}\"\n\nJSON ARRAY OUTPUT:`;\n\nlet apiUrl, requestBody;\n\nif (provider === 'gemini' && GEMINI_API_KEY) {\n  apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=' + GEMINI_API_KEY;\n  requestBody = {\n    contents: [{ parts: [{ text: prompt }] }],\n    generationConfig: { temperature: 0.15, maxOutputTokens: 4000 }\n  };\n} else if (OPENAI_API_KEY) {\n  apiUrl = 'https://generativelanguage.googleapis.com/v1beta/openai/chat/completions';\n  requestBody = {\n    model: 'gemini-2.5-flash',\n    messages: [{ role: 'user', content: prompt }],\n    temperature: 0.15,\n    max_tokens: 4000\n  };\n}\n\nconsole.log('Provider:', provider);\nconsole.log('API URL:', apiUrl ? 'configured' : 'MISSING');\n\nreturn { json: { \n  ...cfg, \n  chatId: cid, \n  textInput,\n  description: textInput.substring(0, 50) + (textInput.length > 50 ? '...' : ''),\n  _llm_provider: provider,\n  _llm_api_url: apiUrl,\n  _llm_request_body: requestBody,\n  _llm_api_key: provider === 'openai' ? OPENAI_API_KEY : '',\n  L\n}};"
      },
      "id": "40437d5a-6326-483d-8633-d7a65c6ab331",
      "name": "Prep Text LLM",
      "type": "n8n-nodes-base.code",
      "position": [
        848,
        -640
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json._llm_api_url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "={{ $json._llm_provider === 'openai' ? 'Bearer ' + $json._llm_api_key : '' }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json._llm_request_body) }}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "bb5d127a-832c-4b57-80e6-6f27366b6524",
      "name": "Call Text LLM",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1040,
        -640
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify($json.msg) }},\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": { \"inline_keyboard\": {{ JSON.stringify($json.keyboard) }} }\n}",
        "options": {}
      },
      "id": "0c892318-fede-4019-9d7d-4b64a93d9abe",
      "name": "üì§ Edit Menu",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1232,
        -32
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "formTitle": "Revit File Converter",
        "formDescription": "Configure your Revit file conversion settings",
        "formFields": {
          "values": [
            {
              "fieldLabel": "Path to Revit Converter (RvtExporter.exe)",
              "fieldType": "string",
              "requiredField": true
            },
            {
              "fieldLabel": "Revit File Path",
              "fieldType": "string",
              "requiredField": true
            },
            {
              "fieldLabel": "Export Mode",
              "fieldType": "dropdown",
              "fieldOptions": {
                "values": [
                  {
                    "option": "basic"
                  },
                  {
                    "option": "standard"
                  },
                  {
                    "option": "complete"
                  },
                  {
                    "option": "custom"
                  }
                ]
              }
            },
            {
              "fieldLabel": "Conversion Options",
              "fieldType": "dropdown",
              "fieldOptions": {
                "values": [
                  {
                    "option": "bbox"
                  },
                  {
                    "option": "schedule"
                  },
                  {
                    "option": "sheets2pdf"
                  },
                  {
                    "option": "-no-xlsx"
                  },
                  {
                    "option": "-no-collada"
                  }
                ]
              },
              "multiselect": true
            }
          ]
        },
        "options": {}
      },
      "id": "9c41ce6c-1377-4baa-9190-2e5f355023eb",
      "name": "Form UI",
      "type": "n8n-nodes-base.formTrigger",
      "position": [
        -1840,
        912
      ],
      "webhookId": "cbade463-e399-47e5-b433-7e35886c332c",
      "typeVersion": 2.2,
      "disabled": true
    },
    {
      "parameters": {
        "content": "\n## ‚ö†Ô∏è Troubleshooting\n\n### Browser Popup Issues\nIf the form doesn't open:\n1. Look for a popup blocker icon in your browser's address bar\n2. Click it and select \"Always allow popups from this site\"\n3. Refresh the page and try again\n\n### Executable Path Issues\nIf conversion fails, ensure you're using the correct path:\n\n‚úÖ **Correct path:**\n```\nC:\\DDC_Converter_Revit\\datadrivenlibs\\RvtExporter.exe\n```\n\n‚ùå **Incorrect path:**\n```\nC:\\Community\\DDC_Converter_Revit\\RvtExporter.exe",
        "height": 540,
        "width": 524,
        "color": 7
      },
      "id": "e9a5afd3-5f09-4132-9788-dcf90f530a9f",
      "name": "Instructions",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2816,
        1152
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9cbd4ec9-df24-41e8-b47a-720a4cdb733b",
              "name": "path_to_revit_converter",
              "type": "string",
              "value": "C:\\Users\\Artem Boiko\\Desktop\\n8n\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\DDC_Converter_Revit\\RvtExporter.exe"
            },
            {
              "id": "aa834467-80fb-476a-bac1-6728478834f0",
              "name": "revit_file",
              "type": "string",
              "value": "C:\\Users\\Artem Boiko\\Desktop\\n8n\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\Sample_Projects\\2022 rstadvancedsampleproject.rvt"
            },
            {
              "id": "c3939399-e855-44a7-bb47-83dbb1e85e4f",
              "name": "(optional) Export mode (basic, standard, complete, custom) ",
              "type": "string",
              "value": "basic"
            },
            {
              "id": "748a7f80-f0cb-4147-bb22-6f88818c5a63",
              "name": "(optional) Add the BoundingBox geometry of each element in XLSX ",
              "type": "string",
              "value": "bbox"
            },
            {
              "id": "75f4016f-f04e-48ae-aae6-c231a5cc69aa",
              "name": "(optional) Export all Schedules ",
              "type": "string",
              "value": "schedule"
            },
            {
              "id": "bfbbccdb-e781-47fd-8e84-107f1ef57460",
              "name": "(optional) Export all Sheets to PDF",
              "type": "string",
              "value": "sheets2pdf"
            },
            {
              "id": "acc49689-ab70-4620-87ca-309ed90c0acd",
              "name": "(optional) Disable export to .xlsx format",
              "type": "string",
              "value": "-no-xlsx"
            },
            {
              "id": "bcbb4a29-c290-4ca4-b71b-1df755a14458",
              "name": "(optional) Disable export to .dae format ",
              "type": "string",
              "value": "-no-collada"
            },
            {
              "id": "b513c17c-a174-44cf-b935-36b3855624ba",
              "name": "(optional) output_folder",
              "type": "string",
              "value": "C:\\Users\\ars\\source\\repos\\DataDrivenConstruction\\test\\sample_files\\test"
            }
          ]
        },
        "options": {}
      },
      "id": "4d5b23f7-f7c6-472c-9bad-5eb8b2d7df78",
      "name": "Set the conversion variables",
      "type": "n8n-nodes-base.set",
      "position": [
        -1840,
        560
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "content": "### Option 1: Manual Variables\n- Click **\"Manual Trigger\"** to use pre-configured variables\n- Modify the variables in the **\"Set Variables\"** node as needed\n\n## üîß Configuration\n- Update the **RvtExporter.exe** path in the form or variables\n- Ensure the path points to the executable inside the **`datadrivenlibs`** folder",
        "height": 420,
        "width": 428,
        "color": 4
      },
      "id": "d88d6e35-241d-44f7-814f-2a70061b8654",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2016,
        320
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "const { execSync } = require('child_process');\ntry {\n  const cmd = \"// TODO: set command\";\n  const result = execSync(cmd, { encoding: 'utf-8', timeout: 120000 });\n  return [{ json: { stdout: result, exitCode: 0 } }];\n} catch (e) {\n  return [{ json: { stderr: e.stderr || e.message, exitCode: e.status || 1 } }];\n}"
      },
      "id": "0ad804b9-b736-499c-8982-304839d11a60",
      "name": "Converting the project into a structured form1",
      "type": "n8n-nodes-base.code",
      "position": [
        -1488,
        688
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "content": "### Option 2: Form UI\n- Activate and click **\"Form UI\"** to open the web form\n- Fill in your converter path and Revit file path\n- Select export mode and options\n\n\n",
        "height": 376,
        "width": 428,
        "color": 5
      },
      "id": "50ca6050-2fa3-46b8-bed2-0d8d07df4b85",
      "name": "Sticky Note4",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2016,
        752
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "",
        "height": 836,
        "width": 1020,
        "color": 7
      },
      "id": "fafafffa-04e0-4086-812e-46761147aacb",
      "name": "Sticky Note5",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2272,
        304
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üìã Options Parameter Configuration Guide\n\n## üéØ Overview\nThe Options parameter allows you to customize the export process with various flags and settings. Multiple options can be combined using spaces.\n\n## üöÄ Available Options\n\n### üì¶ Export Modes\n| Mode   | Description |\n|------|-------------|\n| `basic`   |  Minimal export with essential data only |\n| `standard`   | Default export level with standard properties |\n| `complete`   | Full export including all available data |\n| `custom`   | Custom export using category file specification |\n\n### üõ†Ô∏è Feature Flags\n| Option | Description |\n|--------|-------------|\n| `bbox` | Add BoundingBox geometry of each element in XLSX |\n| `schedule` | Export all Schedules |\n| `sheets2pdf` | Export all Sheets to PDF format |\n| `[<output file>]` | Specify custom output file path |\n| `[<category file>]` | Text file with category names (required for custom mode) |\n\n### üö´ Disable Options\n| Option | Description |\n|--------|-------------|\n| `-no-xlsx` | Disable export to .xlsx format |\n| `-no-collada` | Disable export to .dae format |\n\n---\n\n## üìù Notes\n- All options are case-sensitive\n- Invalid combinations will be ignored\n- Default behavior applies when no options are specified",
        "height": 836,
        "width": 520
      },
      "id": "1a552b26-eca0-482e-a821-df6d01b1e8ae",
      "name": "Sticky Note6",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2816,
        304
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "run-DO7lywP4",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "7b808e5c-f69d-4940-9624-c18f3588e0c2",
      "name": "Webhook Trigger1",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -2416,
        720
      ],
      "webhookId": "5f73054e-dd72-4545-823c-31555cf9ffea"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9cbd4ec9-df24-41e8-b47a-720a4cdb733b",
              "name": "path_to_revit_converter",
              "type": "string",
              "value": "C:\\Users\\Artem Boiko\\Desktop\\n8n\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\DDC_Converter_Revit\\RvtExporter.exe"
            },
            {
              "id": "aa834467-80fb-476a-bac1-6728478834f0",
              "name": "revit_file",
              "type": "string",
              "value": "C:\\Users\\Artem Boiko\\Desktop\\n8n\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\Sample_Projects\\2023 racbasicsampleproject.rvt"
            }
          ]
        },
        "options": {}
      },
      "id": "9679bc5d-3975-427b-96eb-eb40e99d529c",
      "name": "Setup - Define file paths",
      "type": "n8n-nodes-base.set",
      "position": [
        -400,
        1552
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "jsCode": "const { execSync } = require('child_process');\ntry {\n  const cmd = \"// TODO: set command\";\n  const result = execSync(cmd, { encoding: 'utf-8', timeout: 120000 });\n  return [{ json: { stdout: result, exitCode: 0 } }];\n} catch (e) {\n  return [{ json: { stderr: e.stderr || e.message, exitCode: e.status || 1 } }];\n}"
      },
      "id": "edb13689-6b64-4720-8b10-ce8717ab9673",
      "name": "Extract - Run Revit converter",
      "type": "n8n-nodes-base.code",
      "position": [
        -144,
        1552
      ],
      "typeVersion": 2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "condition1",
              "operator": {
                "type": "object",
                "operation": "exists",
                "rightType": "any"
              },
              "leftValue": "={{ $node[\"Extract - Run Revit converter\"].json.error }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "1f8c30af-db7e-49b8-b554-0bad70641c59",
      "name": "Check - Did extraction succeed?",
      "type": "n8n-nodes-base.if",
      "position": [
        48,
        1552
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9cbd4ec9-df24-41e8-b47a-720a4cdb733b",
              "name": "xlsx_filename",
              "type": "string",
              "value": "={{ $node[\"Setup - Define file paths\"].json[\"revit_file\"].slice(0, -4) + \"_rvt.xlsx\" }}"
            }
          ]
        },
        "options": {}
      },
      "id": "ee252a74-a60a-439d-bb18-e02eeadf407e",
      "name": "Success - Create Excel filename",
      "type": "n8n-nodes-base.set",
      "position": [
        240,
        1568
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "error-message-id",
              "name": "error_message",
              "type": "string",
              "value": "=Extraction failed: {{ $node[\"Extract - Run Revit converter\"].json.error || \"Unknown error\" }}"
            },
            {
              "id": "error-code-id",
              "name": "error_code",
              "type": "number",
              "value": "={{ $node[\"Extract - Run Revit converter\"].json.code || -1 }}"
            }
          ]
        },
        "options": {}
      },
      "id": "69767f94-61f3-48b5-818b-9de5df81f4ca",
      "name": "Error - Show what went wrong",
      "type": "n8n-nodes-base.set",
      "position": [
        240,
        1392
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "filePath": "={{ $json[\"xlsx_filename\"] }}"
      },
      "id": "d7deb02a-1980-44d5-a552-4acbbef9763b",
      "name": "Extract - Read Excel file from disk",
      "type": "n8n-nodes-base.readBinaryFile",
      "position": [
        448,
        1568
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "796a73a6-66f2-4595-bbfb-b570e3287929",
      "name": "Extract - Parse Excel to data",
      "type": "n8n-nodes-base.spreadsheetFile",
      "position": [
        656,
        1568
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üî∑ EXTRACT Phase\n\n**E**xtract data from Revit file:\n1. Setup file paths\n2. Run Revit converter (RVT ‚Üí Excel)\n3. Check if conversion succeeded\n4. Read Excel file from disk\n5. Parse Excel into structured data",
        "height": 504,
        "width": 648,
        "color": 6
      },
      "id": "334a6008-9468-4d26-a2a2-1fb3d5ae469c",
      "name": "Extract Phase Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -752,
        1264
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "",
        "height": 504,
        "width": 1288,
        "color": 5
      },
      "id": "4c81ec24-4f4c-400a-9a0d-594f99eb1a0b",
      "name": "Extract Phase Note1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -176,
        1264
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json['On the standard 3D View'] }}",
              "value2": true
            }
          ]
        }
      },
      "id": "be661d4d-b9eb-4f71-acbe-1631a0ca65ab",
      "name": "On the standard 3D View",
      "type": "n8n-nodes-base.if",
      "position": [
        864,
        1568
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "# ETL with CAD (BIM)  \n**Extract. Transform. Load ‚Äî the future of data processing in construction**\n\nETL (Extract, Transform, Load) is a time-tested and universal approach at the heart of every mature digital infrastructure. When applied to CAD and BIM data, it becomes not just relevant ‚Äî but essential.\nETL is more than just a technical process. It‚Äôs a mindset shift ‚Äî one that takes BIM out of the siloed world of 3D modeling and into the open world of transparent, interoperable, and machine-readable data. It is this paradigm that powers platforms like [DataDrivenConstruction.io](https://datadrivenconstruction.io) and drives the future of digital transformation in the built environment.\n",
        "height": 712,
        "width": 1908,
        "color": 7
      },
      "id": "65df8628-ce1f-43e0-adf4-2670507fc31d",
      "name": "Sticky Note7",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -768,
        1088
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## ‚¨áÔ∏è Only modify the variables here  \neverything else works automatically",
        "height": 368,
        "color": 4
      },
      "id": "3f860cf0-7536-4c5f-a8fc-967901ba3c05",
      "name": "Sticky Note8",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -464,
        1376
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "run-MRC9gvYp",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "ff2dacbb-d3e9-4cb3-bddf-05f7e6facd7b",
      "name": "Webhook Trigger2",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -832,
        1712
      ],
      "webhookId": "2a423e24-0cb4-468a-be3d-2ced827a7680"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json[\"Category : String\"] }}",
              "value2": "OST_Walls"
            }
          ]
        }
      },
      "id": "cc9bbc68-4944-43d1-a5c0-8b16399ffee8",
      "name": "Transform - Filter only OST_Walls",
      "type": "n8n-nodes-base.if",
      "position": [
        6832,
        1136
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "wall-type-name",
              "name": "type_name",
              "type": "string",
              "value": "={{ $json[\"Type Name : String\"] || \"Unknown Type\" }}"
            },
            {
              "id": "wall-volume",
              "name": "volume",
              "type": "number",
              "value": "={{ parseFloat($json[\"Volume : Double\"]) || 0 }}"
            },
            {
              "id": "processed-date",
              "name": "processed_date",
              "type": "string",
              "value": "={{ new Date().toISOString() }}"
            }
          ]
        },
        "options": {}
      },
      "id": "2c403c49-a012-48af-bfbe-695fbad7fdad",
      "name": "Transform - Clean wall data",
      "type": "n8n-nodes-base.set",
      "position": [
        7024,
        1136
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "functionCode": "// Group walls by Type Name and sum Volume\n// Using only built-in JavaScript functions\n\n// Get all wall elements\nconst allWalls = $input.all().map(item => item.json);\n\n// Group by type_name using reduce\nconst grouped = allWalls.reduce((acc, wall) => {\n  const typeName = wall.type_name;\n  if (!acc[typeName]) {\n    acc[typeName] = [];\n  }\n  acc[typeName].push(wall);\n  return acc;\n}, {});\n\n// Create grouping results\nconst groupedResults = Object.keys(grouped).map(typeName => {\n  const walls = grouped[typeName];\n  const totalVolume = walls.reduce((sum, wall) => sum + (wall.volume || 0), 0);\n  const count = walls.length;\n  \n  return {\n    type_name: typeName,\n    wall_count: count,\n    total_volume: Math.round(totalVolume * 1000) / 1000, // round to 3 decimal places\n    average_volume: count > 0 ? Math.round((totalVolume / count) * 1000) / 1000 : 0,\n    processed_date: new Date().toISOString()\n  };\n});\n\n// Sort by total volume descending\nconst sortedResults = groupedResults.sort((a, b) => b.total_volume - a.total_volume);\n\nreturn sortedResults.map(item => ({ json: item }));"
      },
      "id": "17d9cf66-1bb2-4c35-b97d-7d93ee089d16",
      "name": "Transform - Group by Type Name & sum Volume",
      "type": "n8n-nodes-base.function",
      "position": [
        7232,
        1136
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "functionCode": "// Generate HTML report from grouped wall data\nconst groupedData = $input.all().map(item => item.json);\n\n// Create summary statistics\nconst totalWallTypes = groupedData.length;\nconst totalWalls = groupedData.reduce((sum, item) => sum + item.wall_count, 0);\nconst totalVolume = groupedData.reduce((sum, item) => sum + item.total_volume, 0);\nconst avgVolumePerWall = totalWalls > 0 ? Math.round((totalVolume / totalWalls) * 1000) / 1000 : 0;\n\nconst sourceFile = $node[\"Setup - Define file paths\"].json[\"revit_file\"];\nconst processedDate = new Date().toLocaleString();\n\n// Generate wall type cards HTML\nconst wallTypeCards = groupedData.map((wallType, index) => {\n  const percentage = totalVolume > 0 ? (wallType.total_volume / totalVolume) * 100 : 0;\n  return `\n    <div class=\"wall-type-card\" style=\"animation-delay: ${index * 0.1}s;\">\n      <div class=\"wall-type-header\">\n        <div class=\"wall-type-name\">${wallType.type_name}</div>\n        <div class=\"wall-count\">${wallType.wall_count} walls</div>\n      </div>\n      <div class=\"wall-metrics\">\n        <div class=\"metric\">\n          <div class=\"metric-label\">Total Volume</div>\n          <div class=\"metric-value\">${wallType.total_volume.toFixed(3)} m¬≥</div>\n        </div>\n        <div class=\"metric\">\n          <div class=\"metric-label\">Average Volume</div>\n          <div class=\"metric-value\">${wallType.average_volume.toFixed(3)} m¬≥</div>\n        </div>\n        <div class=\"metric\">\n          <div class=\"metric-label\">Percentage</div>\n          <div class=\"metric-value\">${percentage.toFixed(1)}%</div>\n        </div>\n      </div>\n      <div class=\"volume-bar\">\n        <div class=\"volume-fill\" style=\"width: ${percentage}%;\"></div>\n      </div>\n    </div>`;\n}).join('');\n\n// Generate complete HTML\nconst htmlContent = `<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Quantity Take Off Report</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            min-height: 100vh;\n            padding: 20px;\n        }\n\n        .container {\n            max-width: 1000px;\n            margin: 0 auto;\n            background: rgba(255, 255, 255, 0.95);\n            border-radius: 20px;\n            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);\n            overflow: hidden;\n            backdrop-filter: blur(10px);\n        }\n\n        .header {\n            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);\n            color: white;\n            padding: 30px;\n            text-align: center;\n        }\n\n        .header h1 {\n            font-size: 2.2rem;\n            margin-bottom: 8px;\n        }\n\n        .header p {\n            font-size: 1rem;\n            opacity: 0.9;\n        }\n\n        .summary-cards {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n            gap: 15px;\n            padding: 30px;\n            background: #f8f9fa;\n        }\n\n        .summary-card {\n            background: white;\n            padding: 20px;\n            border-radius: 12px;\n            text-align: center;\n            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);\n            transition: transform 0.3s ease;\n            border-left: 4px solid;\n        }\n\n        .summary-card:hover {\n            transform: translateY(-3px);\n        }\n\n        .summary-card.types { border-left-color: #e74c3c; }\n        .summary-card.walls { border-left-color: #3498db; }\n        .summary-card.volume { border-left-color: #2ecc71; }\n        .summary-card.average { border-left-color: #f39c12; }\n\n        .summary-card h3 {\n            color: #2c3e50;\n            font-size: 0.8rem;\n            text-transform: uppercase;\n            letter-spacing: 1px;\n            margin-bottom: 8px;\n        }\n\n        .summary-card .value {\n            font-size: 1.8rem;\n            font-weight: bold;\n            color: #2c3e50;\n            margin-bottom: 4px;\n        }\n\n        .summary-card .unit {\n            color: #7f8c8d;\n            font-size: 0.8rem;\n        }\n\n        .content {\n            padding: 30px;\n        }\n\n        .section-title {\n            font-size: 1.5rem;\n            color: #2c3e50;\n            margin-bottom: 20px;\n            text-align: center;\n            position: relative;\n        }\n\n        .section-title::after {\n            content: '';\n            position: absolute;\n            bottom: -8px;\n            left: 50%;\n            transform: translateX(-50%);\n            width: 60px;\n            height: 3px;\n            background: linear-gradient(135deg, #3498db, #e74c3c);\n            border-radius: 2px;\n        }\n\n        .wall-types-grid {\n            display: grid;\n            gap: 15px;\n            margin-top: 20px;\n        }\n\n        .wall-type-card {\n            background: white;\n            border-radius: 12px;\n            padding: 20px;\n            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);\n            transition: all 0.3s ease;\n            border-left: 4px solid #3498db;\n        }\n\n        .wall-type-card:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);\n        }\n\n        .wall-type-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 15px;\n        }\n\n        .wall-type-name {\n            font-size: 1.1rem;\n            font-weight: bold;\n            color: #2c3e50;\n        }\n\n        .wall-count {\n            background: linear-gradient(135deg, #3498db, #2980b9);\n            color: white;\n            padding: 6px 12px;\n            border-radius: 15px;\n            font-size: 0.8rem;\n            font-weight: bold;\n        }\n\n        .wall-metrics {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));\n            gap: 10px;\n        }\n\n        .metric {\n            text-align: center;\n            padding: 12px;\n            background: #f8f9fa;\n            border-radius: 8px;\n        }\n\n        .metric-label {\n            font-size: 0.7rem;\n            color: #6c757d;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n            margin-bottom: 4px;\n        }\n\n        .metric-value {\n            font-size: 1rem;\n            font-weight: bold;\n            color: #2c3e50;\n        }\n\n        .volume-bar {\n            width: 100%;\n            height: 6px;\n            background: #e9ecef;\n            border-radius: 3px;\n            margin-top: 12px;\n            overflow: hidden;\n        }\n\n        .volume-fill {\n            height: 100%;\n            background: linear-gradient(90deg, #3498db, #2ecc71);\n            border-radius: 3px;\n            transition: width 0.8s ease;\n        }\n\n        .footer {\n            background: #2c3e50;\n            color: white;\n            padding: 20px;\n            text-align: center;\n            font-size: 0.9rem;\n        }\n\n        .footer-info {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));\n            gap: 15px;\n            margin-bottom: 15px;\n        }\n\n        .footer-item strong {\n            display: block;\n            margin-bottom: 4px;\n            color: #3498db;\n        }\n\n        @media (max-width: 768px) {\n            .header h1 { font-size: 1.8rem; }\n            .summary-cards { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); padding: 20px; }\n            .content { padding: 20px; }\n            .wall-type-header { flex-direction: column; align-items: flex-start; gap: 8px; }\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <div class=\"header\">\n            <h1>üìä Quantity Take Off Report</h1>\n            <p>Wall analysis and volume calculations from Revit data</p>\n        </div>\n\n        <div class=\"summary-cards\">\n            <div class=\"summary-card types\">\n                <h3>Wall Types</h3>\n                <div class=\"value\">${totalWallTypes}</div>\n                <div class=\"unit\">Different Types</div>\n            </div>\n            <div class=\"summary-card walls\">\n                <h3>Total Walls</h3>\n                <div class=\"value\">${totalWalls}</div>\n                <div class=\"unit\">Wall Elements</div>\n            </div>\n            <div class=\"summary-card volume\">\n                <h3>Total Volume</h3>\n                <div class=\"value\">${totalVolume.toFixed(3)}</div>\n                <div class=\"unit\">m¬≥</div>\n            </div>\n            <div class=\"summary-card average\">\n                <h3>Average Volume</h3>\n                <div class=\"value\">${avgVolumePerWall.toFixed(3)}</div>\n                <div class=\"unit\">m¬≥ per wall</div>\n            </div>\n        </div>\n\n        <div class=\"content\">\n            <h2 class=\"section-title\">Wall Types Breakdown</h2>\n            <div class=\"wall-types-grid\">\n                ${wallTypeCards}\n            </div>\n        </div>\n\n        <div class=\"footer\">\n            <div class=\"footer-info\">\n                <div class=\"footer-item\">\n                    <strong>Source File:</strong>\n                    ${sourceFile.split('\\\\').pop()}\n                </div>\n                <div class=\"footer-item\">\n                    <strong>Processed Date:</strong>\n                    ${processedDate}\n                </div>\n                <div class=\"footer-item\">\n                    <strong>Generated By:</strong>\n                    n8n Workflow Pipeline\n                </div>\n            </div>\n            <p style=\"margin-top: 15px; opacity: 0.7;\">\n                Data extracted from Revit and processed through automated ETL pipeline.\n            </p>\n        </div>\n    </div>\n</body>\n</html>`;\n\n// Create filename based on source file\nconst sourceBasename = sourceFile.replace(/\\.[^/.]+$/, \"\"); // Remove extension\nconst outputFilename = sourceBasename + \"_quantity_takeoff_report.html\";\n\n// Create proper binary data structure for n8n writeBinaryFile node\nconst binaryData = {\n  data: Buffer.from(htmlContent, 'utf8'),\n  mimeType: 'text/html',\n  fileName: outputFilename.split('\\\\').pop() // Get just filename without path\n};\n\n// Return data with proper binary structure\nreturn [{\n  json: {\n    filename: outputFilename,\n    summary: {\n      total_wall_types: totalWallTypes,\n      total_walls: totalWalls,\n      total_volume: Math.round(totalVolume * 1000) / 1000,\n      average_volume_per_wall: avgVolumePerWall,\n      processed_at: new Date().toISOString(),\n      source_file: sourceFile\n    },\n    grouped_data: groupedData,\n    message: `Generated HTML report for ${totalWallTypes} wall types (${totalWalls} total walls)`,\n    htmlContent: htmlContent\n  },\n  binary: {\n    data: binaryData\n  }\n}];"
      },
      "id": "c44ff940-8c0e-481c-8a10-d83dcff4c2ce",
      "name": "Transform - Generate HTML Report",
      "type": "n8n-nodes-base.function",
      "position": [
        7424,
        1136
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "fileName": "={{ $json.filename }}",
        "options": {}
      },
      "id": "cf377a0c-600d-4937-afb5-4e7679fc03b1",
      "name": "Load - Save HTML Report",
      "type": "n8n-nodes-base.writeBinaryFile",
      "position": [
        7632,
        1136
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "success-message",
              "name": "success",
              "type": "boolean",
              "value": true
            },
            {
              "id": "final-message",
              "name": "final_message",
              "type": "string",
              "value": "={{ $node[\"Transform - Generate HTML Report\"].json.message }}. File saved as: {{ $node[\"Transform - Generate HTML Report\"].json.filename }}"
            },
            {
              "id": "summary-data",
              "name": "summary",
              "type": "object",
              "value": "={{ $node[\"Transform - Generate HTML Report\"].json.summary }}"
            }
          ]
        },
        "options": {}
      },
      "id": "92276687-8d39-4541-aed0-eb58dc400743",
      "name": "Success - Final results",
      "type": "n8n-nodes-base.set",
      "position": [
        7840,
        1136
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "content": "## üî∑ TRANSFORM Phase\n\n**T**ransform raw data:\n1. Filter ONLY records with 'Category : String' = 'OST_Walls'\n2. Clean data: extract ID, Type Name, Volume\n3. Group by 'Type Name : String'\n4. Sum 'Volume : Double' for each group\n5. Calculate statistics per group",
        "height": 520,
        "width": 992,
        "color": 5
      },
      "id": "6850fd8b-0a6e-4cbf-9d82-e65b70293d36",
      "name": "Transform Phase Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        6576,
        800
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üî∑ LOAD Phase\n\n**L**oad processed data as HTML report:\n1. Generate beautiful HTML report with embedded CSS\n2. Include summary statistics cards\n3. Display grouped data with visual progress bars\n4. Save as HTML file for easy viewing\n5. Results include:\n   - Interactive dashboard design\n   - Summary statistics\n   - Grouped data by Type Name\n   - Visual volume comparisons\n   - Professional styling",
        "height": 520,
        "width": 520
      },
      "id": "76d01163-d08c-475f-ae68-e408740572ff",
      "name": "Load Phase Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        7584,
        800
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "message",
              "name": "message",
              "type": "string",
              "value": "Elements not visible in standard 3D view"
            },
            {
              "id": "filtered_count",
              "name": "filtered_count",
              "type": "number",
              "value": "={{ $input.all().length }}"
            },
            {
              "id": "reason",
              "name": "reason",
              "type": "string",
              "value": "Parameter 'On the standard 3D View' is not True"
            }
          ]
        },
        "options": {}
      },
      "id": "4dc9d7d4-fb41-4a90-9c0c-f0c66ffda8cd",
      "name": "Non-3D View Elements Output",
      "type": "n8n-nodes-base.set",
      "position": [
        6976,
        960
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9cbd4ec9-df24-41e8-b47a-720a4cdb733b",
              "name": "path_to_revit_converter",
              "type": "string",
              "value": "C:\\Users\\Artem Boiko\\Desktop\\n8n\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\DDC_Converter_Revit\\RvtExporter.exe"
            },
            {
              "id": "aa834467-80fb-476a-bac1-6728478834f0",
              "name": "revit_file",
              "type": "string",
              "value": "C:\\Users\\Artem Boiko\\Desktop\\n8n\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\Sample_Projects\\2023 racbasicsampleproject.rvt"
            }
          ]
        },
        "options": {}
      },
      "id": "2d8eb591-cd30-4d9a-811f-13062d86cb74",
      "name": "Setup - Define file paths1",
      "type": "n8n-nodes-base.set",
      "position": [
        5392,
        1136
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "jsCode": "const { execSync } = require('child_process');\ntry {\n  const cmd = \"// TODO: set command\";\n  const result = execSync(cmd, { encoding: 'utf-8', timeout: 120000 });\n  return [{ json: { stdout: result, exitCode: 0 } }];\n} catch (e) {\n  return [{ json: { stderr: e.stderr || e.message, exitCode: e.status || 1 } }];\n}"
      },
      "id": "4eb37684-7ffa-4fb5-9838-9f04dba0df52",
      "name": "Extract - Run Revit converter1",
      "type": "n8n-nodes-base.code",
      "position": [
        5600,
        1136
      ],
      "typeVersion": 2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "condition1",
              "operator": {
                "type": "object",
                "operation": "exists",
                "rightType": "any"
              },
              "leftValue": "={{ $node[\"Extract - Run Revit converter1\"].json.error }}",
              "rightValue": ""
            }
          ]
        },
        "options": {}
      },
      "id": "d33f48d3-c0fc-47d6-aa0c-c668876b8100",
      "name": "Check - Did extraction succeed?1",
      "type": "n8n-nodes-base.if",
      "position": [
        5808,
        1136
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9cbd4ec9-df24-41e8-b47a-720a4cdb733b",
              "name": "xlsx_filename",
              "type": "string",
              "value": "={{ $node[\"Setup - Define file paths1\"].json[\"revit_file\"].slice(0, -4) + \"_rvt.xlsx\" }}"
            }
          ]
        },
        "options": {}
      },
      "id": "c817e88b-5a26-4e71-adf5-6f818db3b363",
      "name": "Success - Create Excel filename1",
      "type": "n8n-nodes-base.set",
      "position": [
        6000,
        1136
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "error-message-id",
              "name": "error_message",
              "type": "string",
              "value": "=Extraction failed: {{ $node[\"Extract - Run Revit converter1\"].json.error || \"Unknown error\" }}"
            },
            {
              "id": "error-code-id",
              "name": "error_code",
              "type": "number",
              "value": "={{ $node[\"Extract - Run Revit converter1\"].json.code || -1 }}"
            }
          ]
        },
        "options": {}
      },
      "id": "6816db29-0b85-4f4b-8b72-acf62c80b91d",
      "name": "Error - Show what went wrong1",
      "type": "n8n-nodes-base.set",
      "position": [
        6000,
        944
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "filePath": "={{ $json[\"xlsx_filename\"] }}"
      },
      "id": "9a86677d-40c9-4e9d-8ca6-5fcd2920fb62",
      "name": "Extract - Read Excel file from disk1",
      "type": "n8n-nodes-base.readBinaryFile",
      "position": [
        6208,
        1136
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "22a28bc2-e78f-459c-845a-279fdf3e4a47",
      "name": "Extract - Parse Excel to data1",
      "type": "n8n-nodes-base.spreadsheetFile",
      "position": [
        6400,
        1136
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üî∑ EXTRACT Phase\n\n**E**xtract data from Revit file:\n1. Setup file paths\n2. Run Revit converter (RVT ‚Üí Excel)\n3. Check if conversion succeeded\n4. Read Excel file from disk\n5. Parse Excel into structured data",
        "height": 520,
        "width": 1512,
        "color": 6
      },
      "id": "239d7848-80b2-4fca-92b8-fa0d7bb262bd",
      "name": "Extract Phase Note2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5040,
        800
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "# ETL with CAD (BIM)  \n**Extract. Transform. Load ‚Äî the future of data processing in construction**\n\nETL (Extract, Transform, Load) is a time-tested and universal approach at the heart of every mature digital infrastructure. When applied to CAD and BIM data, it becomes not just relevant ‚Äî but essential.\nETL is more than just a technical process. It‚Äôs a mindset shift ‚Äî one that takes BIM out of the siloed world of 3D modeling and into the open world of transparent, interoperable, and machine-readable data. It is this paradigm that powers platforms like [DataDrivenConstruction.io](https://datadrivenconstruction.io) and drives the future of digital transformation in the built environment.\n",
        "height": 720,
        "width": 3120,
        "color": 7
      },
      "id": "fd059ca9-af28-498d-8af2-b20f6522e493",
      "name": "Sticky Note9",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5008,
        624
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## ‚¨áÔ∏è Only modify the variables here  \neverything else works automatically",
        "height": 368,
        "width": 224,
        "color": 4
      },
      "id": "e19ddb60-ee98-456d-b4c8-e55f57db288c",
      "name": "Sticky Note10",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5328,
        928
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json['On the standard 3D View : Boolean'] }}",
              "value2": true
            }
          ]
        }
      },
      "id": "ea310b68-1cc1-4156-9373-a96ae4c56f6b",
      "name": "On the standard 3D View1",
      "type": "n8n-nodes-base.if",
      "position": [
        6640,
        1136
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "run-8db6aRqx",
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "e630243a-135d-4638-8bb8-db151608ad15",
      "name": "Webhook Trigger3",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        4976,
        1296
      ],
      "webhookId": "ea07ecba-951a-420d-a267-621de8322a2b"
    },
    {
      "parameters": {
        "content": "## üìã Quick Start Guide\n\n**1Ô∏è‚É£ Configure Settings**\nEdit \"Set Configuration Parameters\":\n- `converter_path`: Path to RvtExporter.exe\n- `source_folder`: Your CAD files location\n- `output_folder`: Where to save results\n- `file_extension`: .rvt, .ifc, .dwg, or .dgn\n\n**2Ô∏è‚É£ Run Pipeline**\nClick \"Execute Workflow\"\n\n**3Ô∏è‚É£ Get Results**\n‚úÖ Excel data files\n‚úÖ 3D DAE models\n‚úÖ HTML report",
        "height": 368,
        "width": 376
      },
      "id": "522c666b-6459-4564-bef9-628a79371326",
      "name": "Sticky Note23",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4816,
        2832
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üéì Video Tutorials\n\n**üìπ [CAD-BIM Pipeline Tutorial](https://www.youtube.com/watch?v=PMTZNRFjD6c)**\nComplete walkthrough of CAD-BIM automation\n\n**‚ö° [Automated Validation](https://www.youtube.com/watch?v=p84AmP2dcvg)**\nStop manual BIM checking forever\n\nüí° **Pro tip:** Watch before first run!",
        "height": 224,
        "width": 380,
        "color": 2
      },
      "id": "e599ef1a-d2da-4201-b4e3-429259564ef3",
      "name": "Sticky Note25",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4816,
        3216
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üÜò Support\n\n**Resources:**\nüåê [DataDrivenConstruction.io](https://datadrivenconstruction.io)\nüìß support@datadrivenconstruction.io\nüí¨ [Community Forum](https://t.me/datadrivenconstruction)\n\n**Documentation:**\nüìö [n8n Docs](https://docs.n8n.io)\nüé• [YouTube Channel](https://youtube.com/@datadrivenconstruction)",
        "height": 244,
        "width": 372,
        "color": 2
      },
      "id": "725e294c-3a1d-47ea-8335-cfbfebea8c82",
      "name": "Sticky Note28",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4816,
        3776
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üéØ Use Cases\n\n**Weekly Reports**\nAutomate Monday conversions\n\n**Quality Control**\nValidate before client delivery\n\n**Archive Projects**\nConvert old files to lightweight formats\n\n**BI Integration**\nFeed Excel data to Power BI",
        "height": 304,
        "width": 380,
        "color": 2
      },
      "id": "6ae6aec2-2d85-4b73-aabf-9143b587c342",
      "name": "Sticky Note29",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4816,
        3456
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// Capture pipeline start time at the very beginning\nconst now = new Date();\nreturn [{\n  json: {\n    pipeline_start_time: now.toISOString(),\n    pipeline_start_timestamp: now.getTime(),\n    pipeline_start_message: `Pipeline started at ${now.toLocaleString()}`\n  }\n}];"
      },
      "id": "95d2d438-3596-4269-b590-d8b0c029465a",
      "name": "Capture Pipeline Start Time1",
      "type": "n8n-nodes-base.code",
      "position": [
        -3584,
        3264
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "f012067c-c79b-490c-b11f-fdd1f2b567d4",
      "name": "Merge Pipeline Start with Config1",
      "type": "n8n-nodes-base.merge",
      "position": [
        -3040,
        3280
      ],
      "typeVersion": 3
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "converter-path",
              "name": "converter_path",
              "type": "string",
              "value": "C:\\Users\\Artem Boiko\\Desktop\\n8n\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\DDC_Converter_Revit\\datadrivenlibs\\RvtExporter.exe"
            },
            {
              "id": "source-folder",
              "name": "source_folder",
              "type": "string",
              "value": "C:\\Users\\Artem Boiko\\Desktop\\n8n\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\Sample_Projects"
            },
            {
              "id": "output-folder",
              "name": "output_folder",
              "type": "string",
              "value": "C:\\Users\\Artem Boiko\\Desktop\\n8n\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\cad2data-Revit-IFC-DWG-DGN-pipeline-with-conversion-validation-qto-main\\Sample_Projects"
            },
            {
              "id": "include-subfolders",
              "name": "include_subfolders",
              "type": "boolean",
              "value": false
            },
            {
              "id": "file-extension",
              "name": "file_extension",
              "type": "string",
              "value": ".rvt"
            },
            {
              "id": "a811f4ba-b7a5-4774-a1fa-90d9c43a0de6",
              "name": "options",
              "type": "string",
              "value": "basic schedule  -no-collada"
            }
          ]
        },
        "options": {}
      },
      "id": "83e93ca4-ff52-4fa0-b85e-56851a113cdd",
      "name": "Set Configuration Parameters1",
      "type": "n8n-nodes-base.set",
      "position": [
        -3312,
        3120
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "jsCode": "const { execSync } = require('child_process');\ntry {\n  const cmd = \"// TODO: set command\";\n  const result = execSync(cmd, { encoding: 'utf-8', timeout: 120000 });\n  return [{ json: { stdout: result, exitCode: 0 } }];\n} catch (e) {\n  return [{ json: { stderr: e.stderr || e.message, exitCode: e.status || 1 } }];\n}"
      },
      "id": "15b6c37c-df67-4415-96c5-ba57903c4529",
      "name": "Find CAD Files1",
      "type": "n8n-nodes-base.code",
      "position": [
        -2880,
        3296
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "52507c16-44b2-417a-b34f-629ac8d3c108",
      "name": "Merge Config with Search Results1",
      "type": "n8n-nodes-base.merge",
      "position": [
        -2720,
        3184
      ],
      "typeVersion": 3
    },
    {
      "parameters": {
        "jsCode": "// Process file list with configuration and pipeline start time\nconst configData = $input.first().json || {};\nconst searchData = $input.last().json || {};\n\nconst output = searchData.stdout || '';\nconst stderr = searchData.stderr || '';\n\n// Preserve pipeline start time\nconst pipeline_start_time = configData.pipeline_start_time || '';\nconst pipeline_start_timestamp = configData.pipeline_start_timestamp || Date.now();\n\nconsole.log('=== Processing File List ===');\nconsole.log('Pipeline start time:', pipeline_start_time);\nconsole.log('Config data:', configData);\nconsole.log('Raw output:', output);\nconsole.log('Files found:', output ? output.split(/\\r?\\n/).filter(x => x.trim()).length : 0);\n\nconst config = {\n  converter_path: configData.converter_path || '',\n  source_folder: configData.source_folder || '',\n  output_folder: configData.output_folder || '',\n  include_subfolders: configData.include_subfolders || false,\n  file_extension: configData.file_extension || '.rvt',\n  options: configData.options || ''\n};\n\nif (!output || !output.trim()) {\n  return [{\n    json: {\n      files: [],\n      total_files: 0,\n      message: `No files found with extension '${config.file_extension}' in ${config.source_folder}`,\n      error: stderr || 'No output from search command',\n      config: config,\n      pipeline_start_time: pipeline_start_time,\n      pipeline_start_timestamp: pipeline_start_timestamp\n    }\n  }];\n}\n\nlet normalizedExtension = (config.file_extension || '').trim();\nif (normalizedExtension && !normalizedExtension.startsWith('.')) {\n  normalizedExtension = '.' + normalizedExtension;\n}\n\nlet rawPaths = [];\ntry {\n  rawPaths = output.trim().split(/\\r?\\n/)\n    .map(path => (path || '').trim())\n    .filter(path => path && path.length > 0);\n} catch (error) {\n  console.log('Error splitting output:', error);\n  return [{\n    json: {\n      files: [],\n      total_files: 0,\n      message: `Error processing search results: ${error.message}`,\n      config: config,\n      pipeline_start_time: pipeline_start_time,\n      pipeline_start_timestamp: pipeline_start_timestamp\n    }\n  }];\n}\n\nconst filePaths = rawPaths.filter(path => {\n  if (!path || !normalizedExtension) return false;\n  const lowerPath = path.toLowerCase();\n  const lowerExt = normalizedExtension.toLowerCase();\n  return lowerPath.endsWith(lowerExt);\n});\n\nif (filePaths.length === 0) {\n  return [{\n    json: {\n      files: [],\n      total_files: 0,\n      message: `No files found with extension '${normalizedExtension}' in ${config.source_folder}`,\n      config: config,\n      pipeline_start_time: pipeline_start_time,\n      pipeline_start_timestamp: pipeline_start_timestamp\n    }\n  }];\n}\n\nconst files = filePaths.map((filePath, index) => {\n  let fileName = 'unknown_file';\n  let fileNameWithoutExt = 'unknown_file';\n  \n  try {\n    if (filePath && typeof filePath === 'string') {\n      const normalizedPath = filePath.replace(/\\\\/g, '/');\n      const pathParts = normalizedPath.split('/');\n      fileName = pathParts[pathParts.length - 1] || 'unknown_file';\n      \n      console.log(`Processing file ${index + 1}: ${fileName} from path: ${filePath}`);\n      \n      const lastDotIndex = fileName.lastIndexOf('.');\n      if (lastDotIndex > 0) {\n        fileNameWithoutExt = fileName.substring(0, lastDotIndex);\n      } else {\n        fileNameWithoutExt = fileName;\n      }\n    }\n  } catch (error) {\n    console.log(`Error parsing file path ${filePath}:`, error);\n  }\n  \n  const extWithoutDot = normalizedExtension ? normalizedExtension.substring(1) : 'unknown';\n  \n  return {\n    index: index + 1,\n    file_path: filePath,\n    file_name: fileName,\n    file_name_without_ext: fileNameWithoutExt,\n    converter_path: config.converter_path,\n    expected_output: `${config.output_folder}\\\\${fileNameWithoutExt}_${extWithoutDot}.xlsx`,\n    expected_output_dae: `${config.output_folder}\\\\${fileNameWithoutExt}_${extWithoutDot}.dae`,\n    config: config,\n    options: config.options,\n    pipeline_start_time: pipeline_start_time,\n    pipeline_start_timestamp: pipeline_start_timestamp\n  };\n});\n\nconsole.log('Processed files:', files.map(f => f.file_name));\n\nreturn [{\n  json: {\n    files: files,\n    total_files: files.length,\n    message: `Found ${files.length} files to convert`,\n    config: config,\n    pipeline_start_time: pipeline_start_time,\n    pipeline_start_timestamp: pipeline_start_timestamp\n  }\n}];"
      },
      "id": "84c23497-f71f-4777-b4ce-b7d6c6259003",
      "name": "Process File List1",
      "type": "n8n-nodes-base.code",
      "position": [
        -2560,
        3184
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "files-exist-condition",
              "operator": {
                "type": "number",
                "operation": "gt"
              },
              "leftValue": "={{ $json.files && $json.files.length || 0 }}",
              "rightValue": 0
            }
          ]
        },
        "options": {}
      },
      "id": "dc2bdf28-eb57-464a-bc28-93d854133270",
      "name": "Check if Files Exist1",
      "type": "n8n-nodes-base.if",
      "position": [
        -2400,
        3184
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "fieldToSplitOut": "files",
        "options": {}
      },
      "id": "f2acc5b7-1d08-4d16-bca1-7a870f3f2e52",
      "name": "Split Files for Processing1",
      "type": "n8n-nodes-base.splitOut",
      "position": [
        -2208,
        3168
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "const { execSync } = require('child_process');\ntry {\n  const cmd = \"// TODO: set command\";\n  const result = execSync(cmd, { encoding: 'utf-8', timeout: 120000 });\n  return [{ json: { stdout: result, exitCode: 0 } }];\n} catch (e) {\n  return [{ json: { stderr: e.stderr || e.message, exitCode: e.status || 1 } }];\n}"
      },
      "id": "b0a93178-679e-466e-8f86-67af1e2cb660",
      "name": "Create Output Directory1",
      "type": "n8n-nodes-base.code",
      "position": [
        -2032,
        3264
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "07657398-1e78-4e81-a2ad-0caf6df6d6ca",
      "name": "Merge File Data1",
      "type": "n8n-nodes-base.merge",
      "position": [
        -1872,
        3184
      ],
      "typeVersion": 3
    },
    {
      "parameters": {
        "jsCode": "// Capture conversion start time and preserve ALL data including pipeline start\nreturn $input.all().map(item => {\n  const json = {...item.json};\n  json.conversion_start_time = new Date().toISOString();\n  json.conversion_start_timestamp = Date.now();\n  console.log(`Starting conversion for: ${json.file_name} at ${json.conversion_start_time}`);\n  console.log(`Pipeline started at: ${json.pipeline_start_time}`);\n  return {json};\n});"
      },
      "id": "c66262dc-4419-4759-a9ad-2bbbad8a3829",
      "name": "Capture Start Time1",
      "type": "n8n-nodes-base.code",
      "position": [
        -1696,
        3184
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "unit": "milliseconds"
      },
      "id": "d805d506-c2f9-4965-9445-d7bc80aa40b9",
      "name": "Small Delay",
      "type": "n8n-nodes-base.wait",
      "position": [
        -1536,
        3184
      ],
      "webhookId": "5a1cb608-ec3e-4832-a289-f6a52ef8bc7a",
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "const { execSync } = require('child_process');\ntry {\n  const cmd = \"// TODO: set command\";\n  const result = execSync(cmd, { encoding: 'utf-8', timeout: 120000 });\n  return [{ json: { stdout: result, exitCode: 0 } }];\n} catch (e) {\n  return [{ json: { stderr: e.stderr || e.message, exitCode: e.status || 1 } }];\n}"
      },
      "id": "e8dee03c-0142-462a-8ff8-63e880996da2",
      "name": "Execute Conversion1",
      "type": "n8n-nodes-base.code",
      "position": [
        -1376,
        3296
      ],
      "typeVersion": 2,
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Calculate actual conversion time and rename outputs - preserve pipeline start time\nreturn $input.all().map(item => {\n  const json = {...item.json};\n  \n  // Rename stdout/stderr\n  json.conversion_stdout = json.stdout || '';\n  json.conversion_stderr = json.stderr || '';\n  json.conversion_exitCode = json.exitCode || 0;\n  delete json.stdout;\n  delete json.stderr;\n  delete json.exitCode;\n  \n  // Calculate actual processing time with decimal precision\n  if (json.conversion_start_timestamp) {\n    const endTime = Date.now();\n    const startTime = json.conversion_start_timestamp;\n    const processingTimeMs = endTime - startTime;\n    json.processing_time = processingTimeMs / 1000;\n    json.processing_time_ms = processingTimeMs;\n    json.conversion_end_time = new Date().toISOString();\n    json.conversion_end_timestamp = endTime;\n    console.log(`Conversion completed for: ${json.file_name} in ${json.processing_time.toFixed(2)} seconds`);\n  } else {\n    json.processing_time = 0;\n    json.processing_time_ms = 0;\n    console.warn(`No start timestamp found for: ${json.file_name}`);\n  }\n  \n  // Ensure pipeline start time is preserved\n  console.log(`Pipeline start preserved: ${json.pipeline_start_timestamp}`);\n  \n  return {json};\n});"
      },
      "id": "f6086c7c-0ffc-4c9b-90d1-914ab911c852",
      "name": "Calculate Conversion Time1",
      "type": "n8n-nodes-base.code",
      "position": [
        -1216,
        3296
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "ba9f68b7-3c81-474e-a552-e36e5ed832d6",
      "name": "Merge Data Before Verification1",
      "type": "n8n-nodes-base.merge",
      "position": [
        -1056,
        3184
      ],
      "typeVersion": 3
    },
    {
      "parameters": {
        "jsCode": "const { execSync } = require('child_process');\ntry {\n  const cmd = \"// TODO: set command\";\n  const result = execSync(cmd, { encoding: 'utf-8', timeout: 120000 });\n  return [{ json: { stdout: result, exitCode: 0 } }];\n} catch (e) {\n  return [{ json: { stderr: e.stderr || e.message, exitCode: e.status || 1 } }];\n}"
      },
      "id": "8a674bcb-80bc-4716-b132-c74e9868c61d",
      "name": "Verify Output Files and Get Sizes1",
      "type": "n8n-nodes-base.code",
      "position": [
        -896,
        3184
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Complete file verification with processing time - preserve pipeline start time\nconst allInputs = $input.all();\nconst mergedDataItems = $('Merge Data Before Verification1').all();\n\nconsole.log(`=== Complete File Verification ===`);\nconsole.log(`Total verification inputs: ${allInputs.length}`);\nconsole.log(`Total merged data items: ${mergedDataItems.length}`);\n\nconst results = [];\n\n// Process each file\nallInputs.forEach((input, index) => {\n  const verificationData = input.json || {};\n  \n  // Find corresponding merged data by matching index\n  const mergedData = mergedDataItems[index]?.json || {};\n  \n  // Extract all necessary data from merged node\n  const fileName = mergedData.file_name || 'unknown_file';\n  const filePath = mergedData.file_path || '';\n  const expectedOutput = mergedData.expected_output || '';\n  const expectedOutputDae = mergedData.expected_output_dae || '';\n  const fileIndex = mergedData.index || index + 1;\n  const processingTime = mergedData.processing_time || 0;\n  const config = mergedData.config || {};\n  const conversionStartTime = mergedData.conversion_start_time || '';\n  const conversionEndTime = mergedData.conversion_end_time || '';\n  const conversionEndTimestamp = mergedData.conversion_end_timestamp || Date.now();\n  \n  // IMPORTANT: Preserve pipeline start time\n  const pipelineStartTime = mergedData.pipeline_start_time || '';\n  const pipelineStartTimestamp = mergedData.pipeline_start_timestamp || 0;\n\n  console.log(`Processing verification for file ${fileIndex}: ${fileName}`);\n  console.log('Actual processing time:', processingTime, 'seconds');\n  console.log('Pipeline start timestamp:', pipelineStartTimestamp);\n\n  // Get verification output from the current input\n  let verificationOutput = verificationData.stdout || verificationData.verification_output || '';\n\n  // Parse PowerShell output\n  let successXlsx = false;\n  let successDae = false;\n  let successRevit = false;\n  let fileSizeXlsx = 0;\n  let fileSizeDae = 0;\n  let fileSizeRevit = 0;\n\n  try {\n    if (verificationOutput && verificationOutput.includes('|')) {\n      const parts = verificationOutput.split('|');\n      \n      parts.forEach(part => {\n        if (part && part.includes('XLSX_EXISTS:')) {\n          successXlsx = part.includes('XLSX_EXISTS:True');\n        }\n        if (part && part.includes('XLSX_SIZE:')) {\n          const sizeStr = part.replace('XLSX_SIZE:', '').trim();\n          fileSizeXlsx = parseInt(sizeStr) || 0;\n        }\n        if (part && part.includes('DAE_EXISTS:')) {\n          successDae = part.includes('DAE_EXISTS:True');\n        }\n        if (part && part.includes('DAE_SIZE:')) {\n          const sizeStr = part.replace('DAE_SIZE:', '').trim();\n          fileSizeDae = parseInt(sizeStr) || 0;\n        }\n        if (part && part.includes('REVIT_EXISTS:')) {\n          successRevit = part.includes('REVIT_EXISTS:True');\n        }\n        if (part && part.includes('REVIT_SIZE:')) {\n          const sizeStr = part.replace('REVIT_SIZE:', '').trim();\n          fileSizeRevit = parseInt(sizeStr) || 0;\n        }\n      });\n    }\n  } catch (error) {\n    console.log('Error parsing verification output:', error);\n  }\n\n  const finalSuccess = successXlsx && successDae && fileSizeXlsx > 0 && fileSizeDae > 0;\n\n  const statusMessage = finalSuccess \n    ? `‚úÖ [${fileIndex}] Successfully converted: ${fileName} (XLSX: ${Math.round(fileSizeXlsx/1024)}KB, DAE: ${Math.round(fileSizeDae/1024)}KB, ${processingTime.toFixed(1)}s)`\n    : `‚ùå [${fileIndex}] Failed to convert: ${fileName} (XLSX: ${successXlsx && fileSizeXlsx > 0 ? '‚úì' : '‚úó'}, DAE: ${successDae && fileSizeDae > 0 ? '‚úì' : '‚úó'}, ${processingTime.toFixed(1)}s)`;\n\n  const result = {\n    file_name: fileName,\n    file_path: filePath,\n    expected_output: expectedOutput,\n    expected_output_dae: expectedOutputDae,\n    success: finalSuccess,\n    success_xlsx: successXlsx && fileSizeXlsx > 0,\n    success_dae: successDae && fileSizeDae > 0,\n    processing_time: processingTime,\n    file_size: fileSizeXlsx + fileSizeDae,\n    file_size_xlsx: fileSizeXlsx,\n    file_size_dae: fileSizeDae,\n    file_size_revit: fileSizeRevit,\n    index: fileIndex,\n    status: finalSuccess ? 'converted' : 'failed',\n    message: statusMessage,\n    timestamp: new Date().toISOString(),\n    verification_output: verificationOutput,\n    config: config,\n    conversion_start_time: conversionStartTime,\n    conversion_end_time: conversionEndTime,\n    conversion_end_timestamp: conversionEndTimestamp,\n    pipeline_start_time: pipelineStartTime,\n    pipeline_start_timestamp: pipelineStartTimestamp\n  };\n\n  console.log(`Verification complete for ${fileName}: ${result.message}`);\n  results.push({ json: result });\n});\n\nconsole.log(`=== Returning ${results.length} verification results ===`);\nreturn results;"
      },
      "id": "b53c0c0e-c6e8-49df-a74d-582d93ca3a9f",
      "name": "Complete File Verification1",
      "type": "n8n-nodes-base.code",
      "position": [
        -736,
        3184
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Generate HTML Report with CORRECT pipeline timing and no-collada handling\nconst results = $input.all();\n\n// Get the current time as pipeline end\nconst pipelineEndTime = Date.now();\n\n// Find the pipeline start timestamp from the data\nlet pipelineStartTimestamp = null;\nlet config = {};\n\n// Extract timing and config from results\nfor (const result of results) {\n  if (result.json) {\n    // Get pipeline start timestamp\n    if (result.json.pipeline_start_timestamp && !pipelineStartTimestamp) {\n      pipelineStartTimestamp = result.json.pipeline_start_timestamp;\n      console.log('Found pipeline start timestamp:', pipelineStartTimestamp);\n    }\n    \n    // Get config\n    if (result.json.config && Object.keys(result.json.config).length > 0) {\n      config = result.json.config;\n    }\n  }\n}\n\n// Check if no-collada option is enabled\nconst noColladaEnabled = config.options && config.options.includes('no-collada');\nconsole.log('No-collada mode enabled:', noColladaEnabled);\n\n// Calculate total pipeline time in minutes\nlet totalPipelineMinutes = '0.00';\nif (pipelineStartTimestamp) {\n  const totalMs = pipelineEndTime - pipelineStartTimestamp;\n  totalPipelineMinutes = (totalMs / 60000).toFixed(2);\n  console.log('Pipeline timing:', {\n    start: pipelineStartTimestamp,\n    end: pipelineEndTime,\n    totalMs: totalMs,\n    totalMinutes: totalPipelineMinutes\n  });\n} else {\n  console.warn('No pipeline start timestamp found!');\n}\n\n// Use config output folder or fallback\nconst outputFolder = config.output_folder || 'C:\\\\temp';\n\n// Count successful and failed conversions\nlet totalFiles = 0;\nlet successfulConversions = 0;\nlet failedConversions = 0;\nlet totalInputSize = 0;\nlet totalOutputSize = 0;\n\nconst successfulFiles = [];\nconst failedFiles = [];\n\nresults.forEach((result, index) => {\n  const data = result.json || {};\n  totalFiles++;\n  \n  const processingTime = data.processing_time || 0;\n  const xlsxSuccess = data.success_xlsx || false;\n  const daeSuccess = data.success_dae || false;\n  const fileSizeRevit = data.file_size_revit || 0;\n  const fileSizeXlsx = data.file_size_xlsx || 0;\n  const fileSizeDae = data.file_size_dae || 0;\n  \n  totalInputSize += fileSizeRevit;\n  \n  // Modified success logic for no-collada mode\n  let isSuccess = false;\n  if (noColladaEnabled) {\n    // In no-collada mode, only XLSX matters\n    isSuccess = xlsxSuccess;\n    if (isSuccess) {\n      totalOutputSize += fileSizeXlsx;\n    }\n  } else {\n    // Normal mode: both XLSX and DAE must succeed\n    isSuccess = xlsxSuccess && daeSuccess;\n    if (isSuccess) {\n      totalOutputSize += fileSizeXlsx + fileSizeDae;\n    }\n  }\n  \n  if (isSuccess) {\n    successfulConversions++;\n    successfulFiles.push({\n      name: data.file_name || `File ${index + 1}`,\n      originalSize: Math.round(fileSizeRevit / 1024),\n      xlsxSize: Math.round(fileSizeXlsx / 1024),\n      daeSize: Math.round(fileSizeDae / 1024),\n      totalSize: Math.round((fileSizeXlsx + (noColladaEnabled ? 0 : fileSizeDae)) / 1024),\n      xlsxPath: data.expected_output || '',\n      daePath: data.expected_output_dae || '',\n      noCollada: noColladaEnabled\n    });\n  } else {\n    failedConversions++;\n    failedFiles.push({\n      name: data.file_name || `File ${index + 1}`,\n      originalSize: Math.round(fileSizeRevit / 1024),\n      xlsxStatus: xlsxSuccess ? '‚úì' : '‚úó',\n      daeStatus: daeSuccess ? '‚úì' : '‚úó'\n    });\n  }\n});\n\nconst successRate = totalFiles > 0 ? Math.round((successfulConversions / totalFiles) * 100) : 0;\n\n// Generate timestamp for filename\nconst now = new Date();\nconst timestamp = now.toISOString().slice(0,19).replace(/:/g, '-');\nconst fileName = `CAD_Conversion_Report_${timestamp}.html`;\nconst fullPath = `${outputFolder}\\\\${fileName}`.replace(/\\\\\\\\/g, '\\\\');\n\nconsole.log('Report summary:', {\n  totalFiles,\n  successfulConversions,\n  failedConversions,\n  successRate: successRate + '%',\n  totalPipelineTime: totalPipelineMinutes + ' minutes',\n  outputPath: fullPath,\n  noColladaMode: noColladaEnabled\n});\n\n// Create HTML content with professional styling\nconst htmlContent = `<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>CAD Project Batch Conversion Report</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n        \n        body { \n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif; \n            background: #f5f6fa;\n            color: #2c3e50;\n            line-height: 1.6;\n        }\n        \n        .container { \n            max-width: 1400px; \n            margin: 0 auto; \n            background: white; \n            box-shadow: 0 0 40px rgba(0, 0, 0, 0.08); \n        }\n        \n        .header { \n            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);\n            color: white; \n            padding: 60px 40px;\n            position: relative;\n            overflow: hidden;\n        }\n        \n        .header::before {\n            content: '';\n            position: absolute;\n            top: -50%;\n            right: -10%;\n            width: 40%;\n            height: 200%;\n            background: rgba(255, 255, 255, 0.05);\n            transform: rotate(35deg);\n        }\n        \n        .header-content {\n            position: relative;\n            z-index: 1;\n        }\n        \n        .header h1 { \n            font-size: 2.8rem; \n            font-weight: 300;\n            letter-spacing: -1px;\n            margin-bottom: 15px;\n        }\n        \n        .header .subtitle { \n            font-size: 1.1rem;\n            opacity: 0.85;\n            font-weight: 400;\n        }\n        \n        .header .timestamp {\n            margin-top: 20px;\n            font-size: 0.95rem;\n            opacity: 0.7;\n        }\n        \n        .content {\n            padding: 40px;\n        }\n        \n        .metrics { \n            display: grid; \n            grid-template-columns: repeat(5, 1fr); \n            gap: 20px; \n            margin: -20px 0 40px 0;\n            position: relative;\n            z-index: 10;\n        }\n        \n        @media (max-width: 1200px) {\n            .metrics {\n                grid-template-columns: repeat(3, 1fr);\n            }\n        }\n        \n        @media (max-width: 768px) {\n            .metrics {\n                grid-template-columns: repeat(2, 1fr);\n            }\n        }\n        \n        @media (max-width: 480px) {\n            .metrics {\n                grid-template-columns: 1fr;\n            }\n        }\n        \n        .metric { \n            background: white;\n            padding: 30px 20px;\n            border-radius: 12px;\n            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);\n            transition: all 0.3s ease;\n            border: 1px solid #e8ecf1;\n            position: relative;\n            overflow: hidden;\n            text-align: center;\n        }\n        \n        .metric::before {\n            content: '';\n            position: absolute;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 4px;\n            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);\n        }\n        \n        .metric:hover {\n            transform: translateY(-3px);\n            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);\n        }\n        \n        .metric-value { \n            font-size: 2.2rem; \n            font-weight: 600;\n            color: #1e3c72;\n            margin-bottom: 8px;\n            line-height: 1;\n        }\n        \n        .metric-label { \n            font-size: 0.85rem; \n            color: #64748b;\n            font-weight: 500;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n        }\n        \n        .metric.highlight {\n            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);\n            border-color: #3b82f6;\n        }\n        \n        .metric.highlight::before {\n            background: linear-gradient(90deg, #10b981 0%, #059669 100%);\n        }\n        \n        .section { \n            margin: 40px 0;\n            background: white;\n            border-radius: 12px;\n            overflow: hidden;\n            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.06);\n            border: 1px solid #e8ecf1;\n        }\n        \n        .section-header {\n            background: #f8fafc;\n            padding: 24px 32px;\n            border-bottom: 1px solid #e8ecf1;\n        }\n        \n        .section h2 { \n            color: #1e293b;\n            font-size: 1.4rem;\n            font-weight: 600;\n            display: flex;\n            align-items: center;\n            gap: 10px;\n        }\n        \n        .section-content {\n            padding: 0;\n        }\n        \n        table { \n            width: 100%; \n            border-collapse: collapse;\n        }\n        \n        th, td { \n            padding: 16px 24px;\n            text-align: left;\n            border-bottom: 1px solid #f1f5f9;\n        }\n        \n        th { \n            background: #f8fafc;\n            font-weight: 600;\n            color: #475569;\n            font-size: 0.875rem;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n            position: sticky;\n            top: 0;\n            z-index: 1;\n        }\n        \n        tr:last-child td {\n            border-bottom: none;\n        }\n        \n        tr:hover { \n            background: #f8fafc;\n        }\n        \n        .status-success { \n            background: #10b981;\n            color: white;\n            padding: 6px 12px;\n            border-radius: 6px;\n            font-size: 0.75rem;\n            font-weight: 600;\n            display: inline-block;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n        }\n        \n        .status-failed { \n            background: #ef4444;\n            color: white;\n            padding: 6px 12px;\n            border-radius: 6px;\n            font-size: 0.75rem;\n            font-weight: 600;\n            display: inline-block;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n        }\n        \n        .status-skipped { \n            background: #6b7280;\n            color: white;\n            padding: 6px 12px;\n            border-radius: 6px;\n            font-size: 0.75rem;\n            font-weight: 600;\n            display: inline-block;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n        }\n        \n        .config-section {\n            background: #f8fafc;\n            padding: 32px;\n            border-radius: 12px;\n            margin: 40px 0;\n        }\n        \n        .config-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));\n            gap: 24px;\n            margin-top: 20px;\n        }\n        \n        .config-item {\n            display: flex;\n            align-items: flex-start;\n            gap: 16px;\n        }\n        \n        .config-label {\n            font-weight: 600;\n            color: #475569;\n            min-width: 140px;\n            font-size: 0.9rem;\n        }\n        \n        .config-value {\n            color: #1e293b;\n            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;\n            background: white;\n            padding: 8px 12px;\n            border-radius: 6px;\n            font-size: 0.85rem;\n            word-break: break-all;\n            flex: 1;\n            border: 1px solid #e2e8f0;\n        }\n        \n        .footer { \n            background: #f8fafc;\n            padding: 40px;\n            text-align: center;\n            color: #64748b;\n            border-top: 1px solid #e8ecf1;\n        }\n        \n        .footer .company {\n            font-size: 1.1rem;\n            font-weight: 600;\n            color: #1e293b;\n            margin-bottom: 8px;\n        }\n        \n        .footer .version {\n            font-size: 0.85rem;\n            margin-top: 16px;\n            color: #94a3b8;\n        }\n        \n        .report-location {\n            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);\n            border: 1px solid #3b82f6;\n            border-radius: 12px;\n            padding: 20px 28px;\n            margin: 30px 0;\n            text-align: center;\n            color: #1e3c72;\n            font-size: 0.95rem;\n        }\n        \n        .report-location strong {\n            color: #1e3c72;\n            font-weight: 600;\n        }\n        \n        .size-cell {\n            font-family: 'SF Mono', Monaco, monospace;\n            font-size: 0.9rem;\n        }\n        \n        .file-link {\n            color: #3b82f6;\n            text-decoration: none;\n            font-weight: 500;\n            transition: all 0.2s ease;\n            position: relative;\n            display: inline-block;\n            padding: 2px 0;\n        }\n        \n        .file-link:hover {\n            color: #2563eb;\n            text-decoration: underline;\n        }\n        \n        .tooltip {\n            position: relative;\n            display: inline-block;\n        }\n        \n        .tooltip .tooltiptext {\n            visibility: hidden;\n            width: 280px;\n            background-color: #333;\n            color: #fff;\n            text-align: center;\n            border-radius: 8px;\n            padding: 12px 16px;\n            position: absolute;\n            z-index: 1000;\n            bottom: 125%;\n            left: 50%;\n            margin-left: -140px;\n            opacity: 0;\n            transition: opacity 0.3s;\n            font-size: 0.85rem;\n            line-height: 1.4;\n            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);\n        }\n        \n        .tooltip .tooltiptext::after {\n            content: \"\";\n            position: absolute;\n            top: 100%;\n            left: 50%;\n            margin-left: -5px;\n            border-width: 5px;\n            border-style: solid;\n            border-color: #333 transparent transparent transparent;\n        }\n        \n        .tooltip:hover .tooltiptext {\n            visibility: visible;\n            opacity: 1;\n        }\n        \n        .no-collada-notice {\n            background: #fef3c7;\n            border: 1px solid #fbbf24;\n            border-radius: 8px;\n            padding: 16px;\n            margin: 20px 0;\n            color: #92400e;\n            font-size: 0.9rem;\n            text-align: center;\n        }\n        \n        .no-collada-notice strong {\n            color: #78350f;\n        }\n        \n        @media print {\n            body { background: white; }\n            .container { box-shadow: none; }\n            .metric { box-shadow: none; border: 1px solid #e5e7eb; }\n            .section { box-shadow: none; page-break-inside: avoid; }\n            .tooltip .tooltiptext { display: none; }\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <div class=\"header\">\n            <div class=\"header-content\">\n                <h1>CAD Project Batch Conversion Report</h1>\n                <p class=\"subtitle\">Automated conversion pipeline execution summary</p>\n                <p class=\"timestamp\">${now.toLocaleString('en-US', { \n                    weekday: 'long', \n                    year: 'numeric', \n                    month: 'long', \n                    day: 'numeric', \n                    hour: '2-digit', \n                    minute: '2-digit' \n                })}</p>\n            </div>\n        </div>\n        \n        <div class=\"content\">\n            <div class=\"metrics\">\n                <div class=\"metric\">\n                    <div class=\"metric-value\">${totalFiles}</div>\n                    <div class=\"metric-label\">Total Files</div>\n                </div>\n                <div class=\"metric highlight\">\n                    <div class=\"metric-value\">${successRate}%</div>\n                    <div class=\"metric-label\">Success Rate</div>\n                </div>\n                <div class=\"metric\">\n                    <div class=\"metric-value\">${totalPipelineMinutes}</div>\n                    <div class=\"metric-label\">Total Time (Minutes)</div>\n                </div>\n                <div class=\"metric\">\n                    <div class=\"metric-value\">${Math.round(totalInputSize / 1048576)} MB</div>\n                    <div class=\"metric-label\">Total Input Size</div>\n                </div>\n                <div class=\"metric\">\n                    <div class=\"metric-value\">${Math.round(totalOutputSize / 1048576)} MB</div>\n                    <div class=\"metric-label\">Total Output Size</div>\n                </div>\n            </div>\n\n            <div class=\"report-location\">\n                <strong>Report Location:</strong> ${fullPath}\n            </div>\n\n            ${noColladaEnabled ? `\n            <div class=\"no-collada-notice\">\n                <strong>Note:</strong> DAE (Collada) file generation was skipped as per configuration (no-collada option enabled).\n            </div>\n            ` : ''}\n\n            ${successfulFiles.length > 0 ? `\n            <div class=\"section\">\n                <div class=\"section-header\">\n                    <h2>‚úÖ Successfully Converted Files (${successfulFiles.length})</h2>\n                </div>\n                <div class=\"section-content\">\n                    <table>\n                        <thead>\n                            <tr>\n                                <th>File Name</th>\n                                <th>Original Size</th>\n                                <th>Excel Output</th>\n                                ${noColladaEnabled ? '<th>DAE Output</th>' : '<th>DAE Output</th>'}\n                                <th>Total Output</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            ${successfulFiles.map(file => `\n                                <tr>\n                                    <td><strong>${file.name}</strong></td>\n                                    <td class=\"size-cell\">${file.originalSize} KB</td>\n                                    <td class=\"size-cell\">\n                                        <a href=\"file:///${file.xlsxPath.replace(/\\\\/g, '/')}\" class=\"file-link\" target=\"_blank\">${file.xlsxSize} KB</a>\n                                    </td>\n                                    <td class=\"size-cell\">\n                                        ${noColladaEnabled ? \n                                            '<span class=\"status-skipped\">SKIPPED</span>' : \n                                            `<div class=\"tooltip\">\n                                                <a href=\"file:///${file.daePath.replace(/\\\\/g, '/')}\" class=\"file-link\" target=\"_blank\">${file.daeSize} KB</a>\n                                                <span class=\"tooltiptext\">üí° Tip: Use the free CAD Assistant software for the best viewing experience of DAE files</span>\n                                            </div>`\n                                        }\n                                    </td>\n                                    <td class=\"size-cell\"><strong>${file.totalSize} KB</strong></td>\n                                </tr>\n                            `).join('')}\n                        </tbody>\n                    </table>\n                </div>\n            </div>\n            ` : ''}\n\n            ${failedFiles.length > 0 ? `\n            <div class=\"section\">\n                <div class=\"section-header\">\n                    <h2>‚ùå Failed Conversions (${failedFiles.length})</h2>\n                </div>\n                <div class=\"section-content\">\n                    <table>\n                        <thead>\n                            <tr>\n                                <th>File Name</th>\n                                <th>Original Size</th>\n                                <th>XLSX Status</th>\n                                <th>DAE Status</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            ${failedFiles.map(file => `\n                                <tr>\n                                    <td><strong>${file.name}</strong></td>\n                                    <td class=\"size-cell\">${file.originalSize} KB</td>\n                                    <td><span class=\"status-${file.xlsxStatus === '‚úì' ? 'success' : 'failed'}\">${file.xlsxStatus === '‚úì' ? 'SUCCESS' : 'FAILED'}</span></td>\n                                    <td>${noColladaEnabled && file.xlsxStatus === '‚úì' ? \n                                        '<span class=\"status-skipped\">SKIPPED</span>' : \n                                        `<span class=\"status-${file.daeStatus === '‚úì' ? 'success' : 'failed'}\">${file.daeStatus === '‚úì' ? 'SUCCESS' : 'FAILED'}</span>`\n                                    }</td>\n                                </tr>\n                            `).join('')}\n                        </tbody>\n                    </table>\n                </div>\n            </div>\n            ` : ''}\n\n            <div class=\"config-section\">\n                <h2 style=\"color: #1e293b; font-size: 1.4rem; font-weight: 600; margin-bottom: 20px;\">\n                    ‚öôÔ∏è Configuration Details\n                </h2>\n                <div class=\"config-grid\">\n                    <div class=\"config-item\">\n                        <span class=\"config-label\">Source Folder:</span>\n                        <span class=\"config-value\">${config.source_folder || 'Not specified'}</span>\n                    </div>\n                    <div class=\"config-item\">\n                        <span class=\"config-label\">Output Folder:</span>\n                        <span class=\"config-value\">${config.output_folder || 'Not specified'}</span>\n                    </div>\n                    <div class=\"config-item\">\n                        <span class=\"config-label\">File Extension:</span>\n                        <span class=\"config-value\">${config.file_extension || 'Not specified'}</span>\n                    </div>\n                    <div class=\"config-item\">\n                        <span class=\"config-label\">Include Subfolders:</span>\n                        <span class=\"config-value\">${config.include_subfolders ? 'Yes' : 'No'}</span>\n                    </div>\n                    <div class=\"config-item\">\n                        <span class=\"config-label\">Converter Options:</span>\n                        <span class=\"config-value\">${config.options || 'None'}</span>\n                    </div>\n                    <div class=\"config-item\">\n                        <span class=\"config-label\">Generated:</span>\n                        <span class=\"config-value\">${now.toLocaleString()}</span>\n                    </div>\n                    <div class=\"config-item\">\n                        <span class=\"config-label\">Workflow ID:</span>\n                        <span class=\"config-value\">FYFQhblt4gILLSpe</span>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <div class=\"footer\">\n            <div class=\"company\">DataDrivenConstruction.io</div>\n            <div>Professional CAD Conversion Pipeline</div>\n            <div class=\"version\">Version 2.0 | Automated Batch Processing System</div>\n        </div>\n    </div>\n</body>\n</html>`;\n\n// Return data for saving and opening\nreturn [{\n    json: {\n        html_content: htmlContent,\n        file_name: fileName,\n        full_path: fullPath,\n        output_folder: outputFolder,\n        total_files: totalFiles,\n        successful_conversions: successfulConversions,\n        failed_conversions: failedConversions,\n        success_rate: successRate,\n        total_pipeline_time: totalPipelineMinutes,\n        config: config,\n        summary_message: `‚úÖ Conversion Complete! ${successfulConversions}/${totalFiles} files converted successfully (${successRate}% success rate) in ${totalPipelineMinutes} minutes`\n    }\n}];"
      },
      "id": "a782ff97-62a3-4585-9917-f5ad1f27ec64",
      "name": "Generate HTML Report1",
      "type": "n8n-nodes-base.code",
      "position": [
        -576,
        3184
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Prepare binary data for file saving\nconst item = $input.first().json;\n\nconsole.log('Preparing binary data for file:', item.file_name);\nconsole.log('Full path:', item.full_path);\n\nif (!item.html_content) {\n  throw new Error('No HTML content found');\n}\n\nreturn [{\n  json: item,\n  binary: {\n    report: {\n      data: Buffer.from(item.html_content, 'utf-8').toString('base64'),\n      mimeType: 'text/html',\n      fileName: item.file_name,\n      fileExtension: 'html'\n    }\n  }\n}];"
      },
      "id": "7ef8e144-475d-4400-b562-2cb68bc9acfd",
      "name": "Prepare Binary Data1",
      "type": "n8n-nodes-base.code",
      "position": [
        -416,
        3184
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "fileName": "={{ $json.full_path }}",
        "dataPropertyName": "report",
        "options": {}
      },
      "id": "fd57f976-2296-4bc6-ab1b-5bfb7bfb62c7",
      "name": "Save HTML File1",
      "type": "n8n-nodes-base.writeBinaryFile",
      "position": [
        -256,
        3184
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// Verify file was saved and prepare for opening\nconst data = $input.first().json;\nconst fullPath = data.full_path || '';\n\nconsole.log('Preparing to open file:', fullPath);\n\n// Normalize path for Windows\nconst windowsPath = fullPath.replace(/\\\\\\\\/g, '\\\\').replace(/\\//g, '\\\\');\n\nreturn [{\n  json: {\n    ...data,\n    windows_path: windowsPath,\n    command_to_open: `cmd /c start \"\" \"${windowsPath}\"`\n  }\n}];"
      },
      "id": "a8785ab7-cabe-4f4e-8951-9df03c763fdd",
      "name": "Verify and Prepare Path1",
      "type": "n8n-nodes-base.code",
      "position": [
        -96,
        3184
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "const { execSync } = require('child_process');\ntry {\n  const cmd = \"// TODO: set command\";\n  const result = execSync(cmd, { encoding: 'utf-8', timeout: 120000 });\n  return [{ json: { stdout: result, exitCode: 0 } }];\n} catch (e) {\n  return [{ json: { stderr: e.stderr || e.message, exitCode: e.status || 1 } }];\n}"
      },
      "id": "64363884-de63-4b2e-9040-5df797316ece",
      "name": "Open HTML Report1",
      "type": "n8n-nodes-base.code",
      "position": [
        64,
        3184
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "const { execSync } = require('child_process');\ntry {\n  const cmd = \"// TODO: set command\";\n  const result = execSync(cmd, { encoding: 'utf-8', timeout: 120000 });\n  return [{ json: { stdout: result, exitCode: 0 } }];\n} catch (e) {\n  return [{ json: { stderr: e.stderr || e.message, exitCode: e.status || 1 } }];\n}"
      },
      "id": "a5133ec2-dbac-4d59-bbcc-1f2a88693ebc",
      "name": "Final Completion Notice1",
      "type": "n8n-nodes-base.code",
      "position": [
        224,
        3184
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "no-files-message",
              "name": "message",
              "type": "string",
              "value": "‚ö†Ô∏è No files found to convert with the specified parameters"
            },
            {
              "id": "no-files-details",
              "name": "details",
              "type": "string",
              "value": "Please check: 1) Source folder path exists, 2) File extension is correct, 3) Files exist in the specified location"
            }
          ]
        },
        "options": {}
      },
      "id": "94093387-6b6c-4d06-bc90-d3c710fe46a1",
      "name": "No Files Found Response1",
      "type": "n8n-nodes-base.set",
      "position": [
        -2208,
        3392
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "content": "## ‚ö° GROUP 4: CONVERSION EXECUTION\n\n**Nodes in this group:**\n‚Ä¢ Capture Start Time\n‚Ä¢ Small Delay\n‚Ä¢ Execute Conversion\n‚Ä¢ Calculate Conversion Time\n\n**What happens here:**\n1Ô∏è‚É£ Timestamp captured for each file\n2Ô∏è‚É£ Small delay prevents overload\n3Ô∏è‚É£ RvtExporter.exe runs the conversion\n4Ô∏è‚É£ Processing time calculated\n\nüîß **Command:** \n`RvtExporter.exe [input] [output.xlsx] [output.dae]`\n\n‚è±Ô∏è **Conversion Time:** 1 Minute per 100Mb.",
        "height": 840,
        "width": 800,
        "color": 5
      },
      "id": "88c4d7e0-d4e4-4cc3-a9f4-3bb54ff8d2b2",
      "name": "Sticky Note11",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1728,
        2720
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## ‚úÖ GROUP 5: VALIDATION\n\n**Nodes in this group:**\n‚Ä¢ Merge Data Before Verification\n‚Ä¢ Verify Output Files and Get Sizes\n‚Ä¢ Complete File Verification\n\n**What happens here:**\n1Ô∏è‚É£ All conversion data is consolidated\n2Ô∏è‚É£ PowerShell checks if outputs exist\n3Ô∏è‚É£ File sizes are measured\n4Ô∏è‚É£ Success/failure status determined\n\n**Success criteria:**\n‚Ä¢ Both XLSX and DAE files exist\n‚Ä¢ File sizes > 0 bytes\n‚Ä¢ No conversion errors",
        "height": 836,
        "width": 284,
        "color": 6
      },
      "id": "6c2a7bee-913d-4f09-911c-27362712e8b2",
      "name": "Sticky Note15",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -912,
        2720
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üìä GROUP 6: REPORTING\n\n**Nodes in this group:**\n‚Ä¢ Generate HTML Report\n‚Ä¢ Prepare Binary Data\n‚Ä¢ Save HTML File\n\n**What happens here:**\n1Ô∏è‚É£ All results compiled into statistics\n2Ô∏è‚É£ Professional HTML report generated\n3Ô∏è‚É£ Report saved to output folder\n\n**Report includes:**\n‚Ä¢ Success rate & metrics\n‚Ä¢ Processing times\n‚Ä¢ File sizes & links\n‚Ä¢ Detailed conversion log",
        "height": 832,
        "width": 456
      },
      "id": "294b65ed-e3f8-43b7-b610-8d543482e279",
      "name": "Sticky Note16",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -608,
        2720
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üéØ GROUP 7: FINALIZATION\n\n**Nodes in this group:**\n‚Ä¢ Verify and Prepare Path\n‚Ä¢ Open HTML Report\n‚Ä¢ Final Completion Notice\n\n**What happens here:**\n1Ô∏è‚É£ Report path normalized for Windows\n2Ô∏è‚É£ HTML report opens in browser\n3Ô∏è‚É£ Success message displayed\n\n**Final output:**\n‚Ä¢ Report auto-opens\n‚Ä¢ Summary in console\n‚Ä¢ All files ready for use",
        "height": 828,
        "width": 484
      },
      "id": "d3b3f087-7f2e-4152-92a8-bf9ece546068",
      "name": "Sticky Note17",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -128,
        2720
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üìù Configuration Example\n\n```\nconverter_path: \nC:\\DDC_Converter\\RvtExporter.exe\nsource_folder: \nC:\\Projects\\Building_A\noutput_folder: \nC:\\Projects\\Converted\nfile_extension: .rvt\ninclude_subfolders: false\n```",
        "height": 308,
        "width": 488,
        "color": 4
      },
      "id": "815d55ea-90f5-42cc-aa93-bf6703352a25",
      "name": "Sticky Note30",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3872,
        3584
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {}
          ]
        }
      },
      "id": "ecfe60cc-c172-499a-88d5-e9305dc9f133",
      "name": "Schedule Trigger1",
      "type": "n8n-nodes-base.scheduleTrigger",
      "position": [
        -3808,
        3168
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "content": "## üìã Options Parameter Configuration Guide\n\n## üéØ Overview\nThe Options parameter allows you to customize the export process with various flags and settings. Multiple options can be combined using spaces.\n\n## üöÄ Available Options\n\n### üì¶ Export Modes\n| Mode   | Description |\n|------|-------------|\n| `basic`   |  Minimal export with essential data only |\n| `standard`   | Default export level with standard properties |\n| `complete`   | Full export including all available data |\n| `custom`   | Custom export using category file specification |\n\n### üõ†Ô∏è Feature Flags\n| Option | Description |\n|--------|-------------|\n| `bbox` | Add BoundingBox geometry of each element in XLSX |\n| `schedule` | Export all Schedules |\n| `sheets2pdf` | Export all Sheets to PDF format |\n| `[<output file>]` | Specify custom output file path |\n| `[<category file>]` | Text file with category names (required for custom mode) |\n\n### üö´ Disable Options\n| Option | Description |\n|--------|-------------|\n| `-no-xlsx` | Disable export to .xlsx format |\n| `-no-collada` | Disable export to .dae format |\n\n---\n\n## üí° Usage Examples\n\n### Example 1: **Basic Export with BoundingBox**\n```bash\nOptions: bbox basic\n```\n> Exports basic data with BoundingBox geometry included\n\n### Example 2: **Complete Export with Schedules**\n```bash\nOptions: complete schedule sheets2pdf\n```\n> Full data export including all schedules and sheets converted to PDF\n\n### Example 3: **Custom Mode with Category File**\n```bash\nOptions: custom categories.txt bbox\n```\n> Custom export using categories.txt file with BoundingBox geometry\n\n### Example 4: **Export Without Specific Formats**\n```bash\nOptions: standard -no-xlsx -no-collada\n```\n> Standard export excluding XLSX and Collada formats\n\n### Example 5: **Schedules Only Export**\n```bash\nOptions: schedule -no-collada\n```\n> Export only schedules without Collada format\n\n### Example 6: **Custom Output Path**\n```bash\nOptions: C:\\Output\\result.xlsx complete bbox\n```\n> Complete export with BoundingBox to specific output file\n\n---\n\n## ‚ö° Quick Tips\n- **Combine multiple options** by separating them with spaces\n- **Order matters** - export mode should come before other options\n- **Custom mode** requires a category file to function properly\n- **Disable flags** can be used to exclude unwanted formats\n\n---\n\n## üìù Notes\n- All options are case-sensitive\n- Invalid combinations will be ignored\n- Default behavior applies when no options are specified",
        "height": 1940,
        "width": 520
      },
      "id": "2183ab66-772e-4738-b882-c476d3ae1789",
      "name": "Sticky Note12",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4416,
        2720
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üèÅ GROUP 1: INITIALIZATION\n\n**Nodes in this group:**\n‚Ä¢ Manual Trigger\n‚Ä¢ Capture Pipeline Start Time\n‚Ä¢ Set Configuration Parameters\n‚Ä¢ Merge Pipeline Start with Config\n\n**What happens here:**\n1Ô∏è‚É£ Pipeline starts manually or on schedule\n2Ô∏è‚É£ Current timestamp is captured for metrics\n3Ô∏è‚É£ All settings are loaded (paths, folders, etc.)\n4Ô∏è‚É£ Configuration merged with timing data\n\nüí° **Key:** This sets up everything needed for the conversion process",
        "height": 844,
        "width": 756,
        "color": 6
      },
      "id": "dd0eff22-618c-4382-adcc-15d770aa2bc4",
      "name": "Sticky Note13",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3872,
        2720
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üîç GROUP 2: FILE DISCOVERY\n\n**Nodes in this group:**\n‚Ä¢ Find CAD Files\n‚Ä¢ Merge Config with Search Results\n‚Ä¢ Process File List\n‚Ä¢ Check if Files Exist\n\n**What happens here:**\n1Ô∏è‚É£ PowerShell scans the source folder\n2Ô∏è‚É£ Filters files by extension (.rvt, .ifc, etc.)\n3Ô∏è‚É£ Creates a list with full paths\n4Ô∏è‚É£ Validates that files were found\n\nüìÅ **Output:** Array of file objects with paths\n‚ùå **If no files:** Pipeline stops gracefully",
        "height": 840,
        "width": 1024,
        "color": 5
      },
      "id": "bd0d96d3-b88a-4ea6-b4c4-1b140360b92d",
      "name": "Sticky Note14",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3104,
        2720
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üîÑ GROUP 3: BATCH PREPARATION\n\n**Nodes in this group:**\n‚Ä¢ Split Files for Processing\n‚Ä¢ Create Output Directory\n‚Ä¢ Merge File Data\n\n**What happens here:**\n1Ô∏è‚É£ File list is split into individual items\n2Ô∏è‚É£ Output directory is created (if needed)\n3Ô∏è‚É£ Each file gets conversion parameters\n\nüéØ **Purpose:** Enables parallel processing\nüìä **Data added:** Expected output paths for XLSX & DAE",
        "height": 844,
        "width": 316,
        "color": 5
      },
      "id": "4571cae9-12ed-4a06-bb50-4a3999678d77",
      "name": "Sticky Note18",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2064,
        2720
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## ‚¨áÔ∏è Only modify the variables here  \n‚Äî everything else works automatically",
        "height": 384,
        "width": 192,
        "color": 4
      },
      "id": "a8bb8058-1b00-4981-a409-a4af7a5e70ba",
      "name": "Sticky Note19",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3360,
        2912
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "telegram-bot-ygHTL-eo",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "cb0c407a-a77c-47b3-9d1b-9704536ae1b1",
      "name": "Telegram Trigger1",
      "type": "n8n-nodes-base.webhook",
      "position": [
        2416,
        6640
      ],
      "webhookId": "da06f3e4-5c38-4698-90c5-ed8bcc977443",
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// Prepare Lang OK message body\nconst cfg = $('Config1').item.json;\nconst L = cfg.L || {};\n\n// Two options message\nconst examples = {\n  DE: `‚úÖ *Deutsch* ¬∑ Berlin ¬∑ EUR\n\n*Beschreiben Sie Ihr Projekt:*\n\n*Option 1 ‚Äî Kurzbeschreibung:*\n\\`Renovierung K√ºche 15m¬≤, mittlere Qualit√§t\\`\n\\`Badezimmer komplett neu 8m¬≤\\`\n\n*Option 2 ‚Äî Detaillierte Liste:*\n\\`\\`\\`\nGipskarton 2-lagig 25m2\nFliesen 60x60 Bad 15m2\nSpachteln Decken W√§nde 120m2\nSteckdosen 20 St√ºck\n\\`\\`\\``,\n\n  EN: `‚úÖ *English* ¬∑ Toronto ¬∑ CAD\n\n*Describe your project:*\n\n*Option 1 ‚Äî Brief description:*\n\\`Kitchen renovation 15m¬≤, medium quality\\`\n\\`Complete bathroom remodel 8m¬≤\\`\n\n*Option 2 ‚Äî Detailed list:*\n\\`\\`\\`\nDrywall 2-layer 25m2\nTiles 60x60 bathroom 15m2\nPlastering ceiling walls 120m2\nElectrical outlets 20 pcs\n\\`\\`\\``,\n\n  RU: `‚úÖ *–†—É—Å—Å–∫–∏–π* ¬∑ –°–ü–± ¬∑ RUB\n\n*–û–ø–∏—à–∏—Ç–µ –≤–∞—à –ø—Ä–æ–µ–∫—Ç:*\n\n*–í–∞—Ä–∏–∞–Ω—Ç 1 ‚Äî –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:*\n\\`–†–µ–º–æ–Ω—Ç –∫—É—Ö–Ω–∏ 15–º¬≤, —Å—Ä–µ–¥–Ω–∏–π –∫–ª–∞—Å—Å\\`\n\\`–í–∞–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞ –ø–æ–¥ –∫–ª—é—á 8–º¬≤\\`\n\n*–í–∞—Ä–∏–∞–Ω—Ç 2 ‚Äî –î–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫:*\n\\`\\`\\`\n–ì–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω 2 —Å–ª–æ—è 25–º2\n–ü–ª–∏—Ç–∫–∞ 60x60 –≤–∞–Ω–Ω–∞—è 15–º2\n–®–ø–∞–∫–ª–µ–≤–∫–∞ –ø–æ—Ç–æ–ª–∫–∏ —Å—Ç–µ–Ω—ã 120–º2\n–†–æ–∑–µ—Ç–∫–∏ 20—à—Ç\n\\`\\`\\``,\n\n  ES: `‚úÖ *Espa√±ol* ¬∑ Barcelona ¬∑ EUR\n\n*Describa su proyecto:*\n\n*Opci√≥n 1 ‚Äî Descripci√≥n breve:*\n\\`Reforma cocina 15m¬≤, calidad media\\`\n\\`Ba√±o completo 8m¬≤\\`\n\n*Opci√≥n 2 ‚Äî Lista detallada:*\n\\`\\`\\`\nPladur 2 capas 25m2\nAzulejos 60x60 ba√±o 15m2\nAlisado techos paredes 120m2\nEnchufes 20uds\n\\`\\`\\``,\n\n  FR: `‚úÖ *Fran√ßais* ¬∑ Paris ¬∑ EUR\n\n*D√©crivez votre projet:*\n\n*Option 1 ‚Äî Description courte:*\n\\`R√©novation cuisine 15m¬≤, qualit√© moyenne\\`\n\\`Salle de bain compl√®te 8m¬≤\\`\n\n*Option 2 ‚Äî Liste d√©taill√©e:*\n\\`\\`\\`\nPlaco 2 couches 25m2\nCarrelage 60x60 sdb 15m2\nEnduit plafonds murs 120m2\nPrises 20pcs\n\\`\\`\\``,\n\n  PT: `‚úÖ *Portugu√™s* ¬∑ S√£o Paulo ¬∑ BRL\n\n*Descreva seu projeto:*\n\n*Op√ß√£o 1 ‚Äî Descri√ß√£o breve:*\n\\`Reforma cozinha 15m¬≤, qualidade m√©dia\\`\n\\`Banheiro completo 8m¬≤\\`\n\n*Op√ß√£o 2 ‚Äî Lista detalhada:*\n\\`\\`\\`\nDrywall 2 camadas 25m2\nPorcelanato 60x60 banheiro 15m2\nMassa corrida teto paredes 120m2\nTomadas 20un\n\\`\\`\\``,\n\n  ZH: `‚úÖ *‰∏≠Êñá* ¬∑ ‰∏äÊµ∑ ¬∑ CNY\n\n*ÊèèËø∞ÊÇ®ÁöÑÈ°πÁõÆ:*\n\n*ÈÄâÈ°π1 ‚Äî ÁÆÄË¶ÅÊèèËø∞:*\n\\`Âé®ÊàøÁøªÊñ∞ 15m¬≤Ôºå‰∏≠Á≠âÂìÅË¥®\\`\n\\`Âç´ÁîüÈó¥ÂÖ®Â•ó 8m¬≤\\`\n\n*ÈÄâÈ°π2 ‚Äî ËØ¶ÁªÜÊ∏ÖÂçï:*\n\\`\\`\\`\nÁü≥ËÜèÊùøÂèåÂ±Ç 25m2\nÁì∑Á†ñ60x60Âç´ÁîüÈó¥ 15m2\nËÖªÂ≠êÈ°∂Â¢ô 120m2\nÊèíÂ∫ß 20‰∏™\n\\`\\`\\``,\n\n  AR: `‚úÖ *ÿßŸÑÿπÿ±ÿ®Ÿäÿ©* ¬∑ ÿØÿ®Ÿä ¬∑ AED\n\n*ÿµŸÅ ŸÖÿ¥ÿ±ŸàÿπŸÉ:*\n\n*ÿßŸÑÿÆŸäÿßÿ± 1 ‚Äî ŸàÿµŸÅ ŸÖÿÆÿ™ÿµÿ±:*\n\\`ÿ™ÿ¨ÿØŸäÿØ ŸÖÿ∑ÿ®ÿÆ 15ŸÖ¬≤ÿå ÿ¨ŸàÿØÿ© ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©\\`\n\\`ÿ≠ŸÖÿßŸÖ ŸÉÿßŸÖŸÑ 8ŸÖ¬≤\\`\n\n*ÿßŸÑÿÆŸäÿßÿ± 2 ‚Äî ŸÇÿßÿ¶ŸÖÿ© ŸÖŸÅÿµŸÑÿ©:*\n\\`\\`\\`\nÿ¨ÿ®ÿ≥ ÿ®Ÿàÿ±ÿØ ÿ∑ÿ®ŸÇÿ™ŸäŸÜ 25ŸÖ2\nÿ®ŸÑÿßÿ∑ 60x60 ÿ≠ŸÖÿßŸÖ 15ŸÖ2\nŸÖÿπÿ¨ŸàŸÜ ÿ£ÿ≥ŸÇŸÅ ÿ¨ÿØÿ±ÿßŸÜ 120ŸÖ2\nŸÖŸÇÿßÿ®ÿ≥ 20 ŸÇÿ∑ÿπÿ©\n\\`\\`\\``,\n\n  HI: `‚úÖ *‡§π‡§ø‡§®‡•ç‡§¶‡•Ä* ¬∑ ‡§Æ‡•Å‡§Ç‡§¨‡§à ¬∑ INR\n\n*‡§Ö‡§™‡§®‡§æ ‡§™‡•ç‡§∞‡•ã‡§ú‡•á‡§ï‡•ç‡§ü ‡§¨‡§§‡§æ‡§è‡§Ç:*\n\n*‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ 1 ‚Äî ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§µ‡§ø‡§µ‡§∞‡§£:*\n\\`‡§ï‡§ø‡§ö‡§® ‡§∞‡•á‡§®‡•ã‡§µ‡•á‡§∂‡§® 15m¬≤, ‡§Æ‡§ß‡•ç‡§Ø‡§Æ ‡§ï‡•ç‡§µ‡§æ‡§≤‡§ø‡§ü‡•Ä\\`\n\\`‡§¨‡§æ‡§•‡§∞‡•Ç‡§Æ ‡§™‡•Ç‡§∞‡•ç‡§£ 8m¬≤\\`\n\n*‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ 2 ‚Äî ‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§∏‡•Ç‡§ö‡•Ä:*\n\\`\\`\\`\n‡§°‡•ç‡§∞‡§æ‡§à‡§µ‡•â‡§≤ 2 ‡§≤‡•á‡§Ø‡§∞ 25m2\n‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ 60x60 ‡§¨‡§æ‡§•‡§∞‡•Ç‡§Æ 15m2\n‡§™‡•Å‡§ü‡•ç‡§ü‡•Ä ‡§õ‡§§ ‡§¶‡•Ä‡§µ‡§æ‡§∞‡•á‡§Ç 120m2\n‡§∏‡•â‡§ï‡•á‡§ü 20 ‡§™‡•Ä‡§∏\n\\`\\`\\``\n};\n\nconst lang = cfg.lang || 'EN';\nconst text = examples[lang] || examples['EN'];\n\nreturn {\n  json: {\n    chatId: cfg.chatId,\n    _body: {\n      chat_id: cfg.chatId,\n      text: text,\n      parse_mode: \"Markdown\",\n      reply_markup: {\n        inline_keyboard: [\n          [\n            {text: \"‚ùì Help\", callback_data: \"show_help\"}, \n            {text: \"üåê Language\", callback_data: \"change_language\"}\n          ]\n        ]\n      }\n    }\n  }\n};"
      },
      "id": "0d874f81-5f0c-46c2-8542-9db1cc89a3e4",
      "name": "Prep Lang OK",
      "type": "n8n-nodes-base.code",
      "position": [
        3840,
        5920
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "519bfbb9-8f49-49f9-ba53-8a234a1e6e35",
              "name": "chatInput",
              "type": "string",
              "value": "={{ $json._parse_prompt }}"
            }
          ]
        },
        "options": {}
      },
      "id": "e6963c56-de4b-4e50-ac8e-20f9e30b88f8",
      "name": "üîß Config Parse",
      "type": "n8n-nodes-base.set",
      "position": [
        3824,
        6512
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "messages": {
          "messageValues": [
            {
              "message": "={{ $('üîß Config Parse').item.json.chatInput }}"
            }
          ]
        }
      },
      "id": "df844eb4-dd80-47c5-9387-7e01d8baa518",
      "name": "ü§ñ AI Parse Text",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        3984,
        6512
      ],
      "typeVersion": 1.4
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.15
        }
      },
      "id": "a05aef5c-38be-45b6-b8ea-42ee5a312bf5",
      "name": "OpenAI Model 1",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "position": [
        4032,
        7968
      ],
      "typeVersion": 1,
      "credentials": {
        "googlePalmApi": {
          "id": "6iXMzd83cyZSS9j5",
          "name": "Gemini - googlePalmApi"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "83df83a1-7099-4f1d-a41c-11bdacf6587c",
              "name": "chatInput",
              "type": "string",
              "value": "={{ $json._transform_prompt }}"
            }
          ]
        },
        "options": {}
      },
      "id": "11ce0846-7a04-46eb-90f8-fcc9454450d9",
      "name": "üîß Config Transform",
      "type": "n8n-nodes-base.set",
      "position": [
        6208,
        7808
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "messages": {
          "messageValues": [
            {
              "message": "={{ $('üîß Config Transform').item.json.chatInput }}"
            }
          ]
        }
      },
      "id": "cf5d33b3-8e5a-4a52-bea6-5c0a2b0d22b0",
      "name": "ü§ñ AI Transform",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        6384,
        7808
      ],
      "typeVersion": 1.4
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.3
        }
      },
      "id": "8e341111-f9a3-4e35-95a1-ef3064dda537",
      "name": "OpenAI Model 2",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "position": [
        4352,
        8176
      ],
      "typeVersion": 1,
      "credentials": {
        "googlePalmApi": {
          "id": "6iXMzd83cyZSS9j5",
          "name": "Gemini - googlePalmApi"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "39cc26f5-b4d3-4c66-94b2-b9f2f12267e4",
              "name": "system_prompt",
              "type": "string",
              "value": "You are a construction cost database expert. Respond ONLY with valid JSON, no markdown."
            },
            {
              "id": "09774508-e3cf-41ea-844a-a65c00e12cba",
              "name": "chatInput",
              "type": "string",
              "value": "={{ $json._rerank_prompt }}"
            }
          ]
        },
        "options": {}
      },
      "id": "c9bdb45a-dacf-4651-b57d-e938e1ed027d",
      "name": "üîß Config Rerank",
      "type": "n8n-nodes-base.set",
      "position": [
        6208,
        8000
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "messages": {
          "messageValues": [
            {
              "message": "={{ $('üîß Config Rerank').item.json.chatInput }}"
            }
          ]
        }
      },
      "id": "948fcec5-ccd8-4f4d-aeae-379bb5365f81",
      "name": "ü§ñ AI Rerank",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        6384,
        8000
      ],
      "typeVersion": 1.4
    },
    {
      "parameters": {
        "jsCode": "// Parse AI response for text works\nconst aiResponse = $input.first().json;\nconst prepData = $('Prep Text LLM1').first().json;\nconst cid = String(prepData.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst L = prepData.L || {};\n\nconsole.log('=== PARSE TEXT RESPONSE ===');\n\nlet text = '';\nif (aiResponse.text) {\n  text = aiResponse.text;\n} else if (aiResponse.response?.text) {\n  text = aiResponse.response.text;\n} else if (aiResponse.output) {\n  text = aiResponse.output;\n}\n\nconsole.log('Raw response:', text?.substring(0, 200));\n\n// Clean response - remove markdown code blocks\ntext = text.replace(/```json\\n?/gi, '').replace(/```\\n?/g, '').trim();\n\n// Extract JSON array\nlet works = [];\ntry {\n  const match = text.match(/\\[.*\\]/s);\n  if (match) {\n    works = JSON.parse(match[0]);\n  } else {\n    works = JSON.parse(text);\n  }\n} catch (e) {\n  console.log('Parse error:', e.message);\n  // Try line by line\n  const lines = text.split('\\n').filter(l => l.trim().startsWith('{'));\n  if (lines.length > 0) {\n    try {\n      works = JSON.parse('[' + lines.join(',') + ']');\n    } catch (e2) {\n      console.log('Fallback parse failed');\n    }\n  }\n}\n\nconsole.log('Parsed works:', works.length);\n\n// Validate and clean works\nworks = works.map((w, i) => ({\n  id: i + 1,\n  name: String(w.name || w.work || '').trim(),\n  qty: parseFloat(w.qty || w.quantity || 1) || 1,\n  unit: String(w.unit || 'm¬≤').trim(),\n  room: w.room || ''\n})).filter(w => w.name.length > 0);\n\n// Save to session\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = {};\nsd.sess[cid].works = works;\nsd.sess[cid].description = prepData.description || prepData.textInput?.substring(0, 50) || '';\nsd.sess[cid].state = 'parsed';\n\nconsole.log('Saved', works.length, 'works to session');\n\nreturn { json: { \n  ...prepData, \n  works, \n  _parsed: true,\n  _works_count: works.length\n}};"
      },
      "id": "6b958f0c-7afa-4b4c-a826-20a7b32cfb3e",
      "name": "üìù Parse Text Response",
      "type": "n8n-nodes-base.code",
      "position": [
        4288,
        6512
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "content": "## ü§ñ AI Parse Text\n\n**Purpose:** Extract works from user text\n\n**Models (enable ONE):**\n- ‚úì OpenAI Model 1 (gemini-2.5-flash)\n- ‚óã Claude Model 1 (disabled)\n- ‚óã Gemini Model 1 (disabled)\n\n**To switch:** Disable current, enable other",
        "height": 392,
        "width": 1112,
        "color": 6
      },
      "id": "4f10abcb-666b-4bec-be5a-26d07aea4eea",
      "name": "Sticky AI Parse",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3648,
        6256
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## ü§ñ AI Transform & Rerank\n\n**Transform:** Optimize search query\n**Rerank:** Score candidates 0-100\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n**Models per stage:**\n- OpenAI Model 2/3 (active)\n- Claude Model 2/3 (disabled)\n- Gemini Model 2/3 (disabled)\n\n**To switch models:**\n1. Disable current model node\n2. Enable alternative model\n3. Connects automatically",
        "height": 736,
        "width": 456
      },
      "id": "00797524-e68c-4986-9d84-cc837bd2388a",
      "name": "Sticky AI Transform Rerank",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        6176,
        7664
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## ‚ö†Ô∏è Setup üîë TOKEN\n\n**Edit TOKEN node values:**\n\n- `bot_token` ‚Üí Telegram token\n- `QDRANT_URL` ‚Üí Qdrant server\n\n**Error \"resource not found\"?**\n‚Üí bot_token is invalid\n\n**Get token:** @BotFather ‚Üí /newbot",
        "height": 264,
        "width": 280
      },
      "id": "a8ef4101-2397-4bbb-8f0b-900bbf8150e9",
      "name": "Token Setup",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2416,
        6832
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4f212355-64b3-4ce6-b0ba-d5c9684d12b3",
              "name": "text",
              "type": "string",
              "value": "={{ $json._query }}"
            },
            {
              "id": "6335a7c9-976c-4404-a80b-1969dbb9d6f5",
              "name": "model",
              "type": "string",
              "value": "gemini-embedding-001"
            },
            {
              "id": "5676b77d-c38f-42c5-bb8b-7869c0344efe",
              "name": "dimensions",
              "type": "number",
              "value": "=3072"
            }
          ]
        },
        "options": {}
      },
      "id": "6c90a184-1d91-4d2e-89da-3180be91adcc",
      "name": "üîß Config Embed",
      "type": "n8n-nodes-base.set",
      "position": [
        5312,
        8000
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/openai/embeddings",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ `Bearer ${$(\"üîë TOKEN1\").first().json.OPENAI_API_KEY}` }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"{{ $('üîß Config Embed').item.json.model || 'gemini-embedding-001' }}\",\n  \"input\": {{ JSON.stringify($('üîß Config Embed').item.json.text) }},\n  \"dimensions\": {{ $('üîß Config Embed').item.json.dimensions || 3072 }}\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          },
          "timeout": 30000
        }
      },
      "id": "faf7b762-321e-4b55-b359-3d823bd9093b",
      "name": "3Ô∏è‚É£ Embeddings API",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        5488,
        8000
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "content": "## üßÆ Embeddings\n\n**Settings in Config Embed:**\n- `model`: gemini-embedding-001\n- `dimensions`: 3072\n\n**Change model:**\nEdit üîß Config Embed node\n\n**Credentials:**\nUses n8n OpenAI credential in 3Ô∏è‚É£ Embeddings API",
        "height": 264,
        "width": 384
      },
      "id": "e9d70d92-e201-4188-bbc7-a5a5b60233eb",
      "name": "Sticky Embeddings",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5024,
        8128
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "modelName": "models/gemini-2.5-pro",
        "options": {}
      },
      "id": "efde7660-7820-4dbb-8bf9-d56f173ae687",
      "name": "Google Gemini Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "position": [
        4176,
        8176
      ],
      "typeVersion": 1,
      "credentials": {
        "googlePalmApi": {
          "id": "6iXMzd83cyZSS9j5",
          "name": "Gemini - googlePalmApi"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "claude-opus-4-20250514",
          "cachedResultName": "Claude Opus 4"
        },
        "options": {}
      },
      "id": "fdf70b5e-ee94-4d4b-9d25-8e82ba3642fd",
      "name": "Anthropic Chat Model2",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "position": [
        4192,
        7968
      ],
      "typeVersion": 1.3,
      "disabled": true
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "1248e3a3-90b3-4e7f-9270-a6928bea3d6a",
      "name": "OpenRouter Chat Model1",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "position": [
        4352,
        7968
      ],
      "typeVersion": 1,
      "disabled": true
    },
    {
      "parameters": {
        "content": "## üß† Available AI Models\n\nConnect any model to LLM Chain nodes:\n\n- **OpenAI** ‚Äî GPT-4o (default)\n- **Anthropic** ‚Äî Claude 3.5\n- **Google Gemini** ‚Äî Gemini Pro\n- **OpenRouter** ‚Äî Multiple models\n- **xAI Grok** ‚Äî Grok models\n\nModels are used for:\n- Header analysis\n- Category classification\n- Project type detection\n- Phase generation\n- Work decomposition\n- Validation",
        "height": 528,
        "width": 904
      },
      "id": "c576c78a-56cf-49a8-ac30-09dad2c6502a",
      "name": "LLM Models",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3648,
        7872
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "d2ec9bdf-e092-4dce-9b14-c979f21089a1",
      "name": "DeepSeek Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatDeepSeek",
      "position": [
        4016,
        8176
      ],
      "typeVersion": 1,
      "disabled": true
    },
    {
      "parameters": {
        "content": "‚≠ê **Star us on GitHub!**\n\n[github.com/datadrivenconstruction/DDC-CWICR](https://github.com/datadrivenconstruction/OpenConstructionEstimate-DDC-CWICR)\n\n**DDC CWICR** ‚Äî Open Source Construction Cost Database\n- 55,000+ work items\n- 9 languages\n- Free forever",
        "height": 132,
        "width": 404
      },
      "id": "b5086e23-4f71-4608-acea-503abe922b16",
      "name": "Sticky Note20",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2352,
        6032
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üîê Credentials Setup\n\n### üîë TOKEN node:\n- `bot_token` - Telegram Bot API\n- `QDRANT_URL` - Qdrant server\n- `QDRANT_API_KEY` - Qdrant auth\n\n### n8n Credentials (Settings ‚Üí Credentials):\n- **OpenAI API** - for LLM + Embeddings\n- **Anthropic API** - (optional) for Claude\n- **Google Gemini API** - (optional) for Gemini\n\n### To switch AI models:\n1. Disable current model node\n2. Enable alternative model\n3. Models auto-connect to chain",
        "height": 936,
        "width": 412,
        "color": 5
      },
      "id": "4c2684fc-ec04-4dae-9513-a2e4e20507b2",
      "name": "üîê Credentials Setup1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2352,
        6176
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## ‚úÖ SETUP CHECKLIST\n\n**1. Telegram Bot**\n- [ ] Create via @BotFather\n- [ ] Token in üîë TOKEN\n\n**2. n8n Credentials**\n- [ ] Add OpenAI credential\n- [ ] Link to Model nodes\n\n**3. Qdrant**\n- [ ] Install/connect Qdrant\n- [ ] Load DDC collections\n- [ ] Set QDRANT_URL\n\n**4. Test**\n- [ ] /start ‚Üí language\n- [ ] Enter works\n- [ ] Get estimate",
        "height": 460,
        "width": 324
      },
      "id": "00618133-4272-43b2-bb7e-aceacfbe2b8d",
      "name": "Checklist1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2016,
        6496
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üöÄ DDC CWICR Text Estimator\n### Construction Cost Estimation Bot\n\n**Version:** 11.0 AI Nodes\n**Author:** DataDrivenConstruction.io\n\n**All AI via n8n Credentials:**\n- ü§ñ Parse Text (OpenAI/Claude/Gemini)\n- ü§ñ Transform Query\n- ü§ñ Rerank Results\n- üìä Embeddings (OpenAI)\n\n**Features:**\n- üí¨ Text input\n- üåç 9 languages\n- üîç Vector search\n- üìä HTML/Excel/PDF\n\n**No API keys in code!**\nUse n8n Credentials only.",
        "height": 440,
        "width": 318
      },
      "id": "c57a59eb-63ab-4502-b31e-5c1ae8d9c828",
      "name": "Intro1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2016,
        6032
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e7b8f8af-ca88-4515-a8ce-3d2c50b815b6",
              "name": "bot_token",
              "type": "string",
              "value": "YOUR_TELEGRAM_BOT_TOKEN"
            },
            {
              "id": "bd298b9a-45b6-4b99-9e50-0346cc402a30",
              "name": "OPENAI_API_KEY",
              "type": "string",
              "value": "AIzaSyBRqtnMxmXWHa_oG4hA9VfjmXuUWZEQypc"
            },
            {
              "id": "9c4cfdd2-d46e-465b-ac08-cea275128c20",
              "name": "QDRANT_URL",
              "type": "string",
              "value": "http://localhost:6333"
            },
            {
              "id": "835c6846-26c6-4a0f-ad75-f352010fe4a8",
              "name": "QDRANT_API_KEY",
              "type": "string",
              "value": ""
            },
            {
              "id": "auto-GEMINI_API_KEY-1770669956478",
              "name": "GEMINI_API_KEY",
              "type": "string",
              "value": "AIzaSyBRqtnMxmXWHa_oG4hA9VfjmXuUWZEQypc"
            }
          ]
        },
        "options": {}
      },
      "id": "dea8cd5a-49ef-4467-bcf0-3fc5b82de7dd",
      "name": "üîë TOKEN1",
      "type": "n8n-nodes-base.set",
      "position": [
        2608,
        6640
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "content": "## üîÄ Route Switch\n\n**11 Actions:**\n\n| # | Action | Description |\n|---|--------|-------------|\n| 0 | show_lang | Language menu |\n| 1 | lang_selected | Confirm & prompt |\n| 2 | works_updated | After edit |\n| 3 | calculate | Start calculation |\n| 4 | edit | Show edit menu |\n| 5 | export_excel | CSV download |\n| 6 | export_pdf | PDF download |\n| 7 | view_details | Resource details |\n| 8 | help | Help message |\n| 9 | restart | New session |\n| 10 | fallback | Error handler |",
        "height": 1072,
        "width": 308,
        "color": 4
      },
      "id": "98df3f43-6244-4519-9875-7485f3a796bd",
      "name": "Route Switch1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3312,
        6032
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üåê Config & Localization\n\n**9 Languages:**\nDE, EN, RU, ES, FR, PT, ZH, AR, HI\n\n**Contains:**\n- UI messages (buttons, prompts)\n- Currency symbols (‚Ç¨/$‚ÇΩ¬•)\n- Database mapping\n- Search language names\n\n**Auto-selects:**\n- Qdrant collection by language\n- Currency by region\n- UI text localization\n\n**Customizable:**\n- Add new languages in LANG object\n- Modify button labels\n- Change currency defaults",
        "height": 808,
        "width": 220,
        "color": 5
      },
      "id": "a6820712-8a88-4fe9-ba35-e13ed7a17f43",
      "name": "Config & Localization1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3072,
        6032
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üß† Main Router\n\nCentral message handler.\n\n**Input:** Telegram Update\n\n**Processing:**\n1. Parse message/callback\n2. Manage user sessions\n3. Detect content type\n4. Route to action\n\n**Output:** `action` code (0-10)\n\n**Session Storage:**\n- User language\n- Work items list\n- Calculation results\n- State machine",
        "height": 808,
        "width": 268,
        "color": 5
      },
      "id": "19298c92-3fe6-4e06-a28c-73b9cb40de57",
      "name": "Main Router1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        2784,
        6032
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// AGG - Final aggregation of calculation results + DDC CWICR info\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config1').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\n\nconst L = cfg.L || {};\nlet total = 0, workers_sum = 0, materials_sum = 0, machines_sum = 0, labor_hours_sum = 0;\nlet found_count = 0;\n\n// Get accumulated results\nconst storedResults = sd.res?.[cid] || [];\n\nconsole.log('=== AGG ===');\nconsole.log('Results count:', storedResults.length);\n\n// Process each result\nconst works = storedResults.map(w => {\n  const uc = w.uc || 0;\n  const tc = w.tc || 0;\n\n  total += tc;\n  workers_sum += (w.workers_total || 0);\n  materials_sum += (w.materials_total || 0);\n  machines_sum += (w.machines_total || 0);\n  labor_hours_sum += (w.labor_hours || 0);\n\n  if (w._found) found_count++;\n\n  return {\n    id: w.id,\n    name: w.name || w.sq,\n    query: w.sq || w.query,\n    qty: w.qty,\n    unit: w.unit,\n    room: w.room,\n    uc: uc,\n    tc: tc,\n    rate_code: w.rate_code || '',\n    rate_name: w.rate_name || '',\n    resources: w.resources || [],\n    workers_total: w.workers_total || 0,\n    materials_total: w.materials_total || 0,\n    machines_total: w.machines_total || 0,\n    labor_hours: w.labor_hours || 0,\n    found: w._found || false,\n    scope_of_work: w.scope_of_work || [],\n    original_query: w.original_query || w.name\n  };\n});\n\nconst pct = works.length > 0 ? Math.round(found_count / works.length * 100) : 0;\n\n// DDC CWICR info\nconst isLimited = false; // No limit\nconst originalTotal = session.totalWorks || works.length;\nconst skippedWorks = originalTotal - works.length;\n\nconsole.log('Calculated:', works.length, '/', originalTotal);\nconsole.log('Found:', found_count, '/', works.length);\nconsole.log('Total cost:', total.toFixed(2));\n// No limit mode\n\n// Cleanup staticData\nif (sd.res?.[cid]) delete sd.res[cid];\nif (sd.calcProgress?.[cid]) delete sd.calcProgress[cid];\nif (sd.progress?.[cid]) delete sd.progress[cid];\n\n// Save for report generation\nsd.lastResults = { works, total, workers_sum, materials_sum, machines_sum, labor_hours_sum, found_count, pct, L };\n\nreturn {\n  json: {\n    chatId: cid,\n    bot_token: cfg.bot_token,\n    works: works,\n    total: Math.round(total * 100) / 100,\n    workers_sum: Math.round(workers_sum * 100) / 100,\n    materials_sum: Math.round(materials_sum * 100) / 100,\n    machines_sum: Math.round(machines_sum * 100) / 100,\n    labor_hours_sum: Math.round(labor_hours_sum * 100) / 100,\n    found_count: found_count,\n    total_count: works.length,\n    pct: pct,\n    L: L,\n    currency: L.sym || '‚Ç¨',\n    description: session.description || '',\n    // DDC CWICR\n    _is_limited: isLimited,\n    _total_works: originalTotal,\n    _skipped_works: skippedWorks\n  }\n};"
      },
      "id": "17952886-8639-4fcb-b7d1-81dc710fc9e4",
      "name": "Agg1",
      "type": "n8n-nodes-base.code",
      "position": [
        6032,
        7424
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/deleteMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('üßπ Prep Cleanup1').first().json.chatId }},\n  \"message_id\": {{ $('üßπ Prep Cleanup1').first().json._delete_progress_msg || 0 }}\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "ec3e33b7-0d2e-47b6-a2af-0b7e079f42ff",
      "name": "üóëÔ∏è Delete Progress Msg1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        5856,
        7424
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/deleteMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('üßπ Prep Cleanup1').first().json.chatId }},\n  \"message_id\": {{ $('üßπ Prep Cleanup1').first().json._delete_work_msg || 0 }}\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "581db9a4-3702-4e3a-9559-6d5033db53ab",
      "name": "üóëÔ∏è Delete Work Msg1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        5664,
        7424
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PREP CLEANUP - Prepare message IDs for deletion after loop completes\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config1').first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(cfg.chatId);\n\n// Get message IDs to delete\nconst lastMsgId = sd.calcProgress?.[cid]?.lastMsgId || null;\nconst progressMsgId = sd.progress?.[cid]?.message_id || null;\n\nconsole.log('=== PREP CLEANUP ===');\nconsole.log('ChatId:', cid);\nconsole.log('Work msg:', lastMsgId);\nconsole.log('Progress msg:', progressMsgId);\n\nreturn {\n  json: {\n    chatId: cfg.chatId,\n    bot_token: cfg.bot_token,\n    L: cfg.L,\n    _delete_work_msg: lastMsgId,\n    _delete_progress_msg: progressMsgId\n  }\n};"
      },
      "id": "5ebc5c47-3aad-441a-86f2-7539d2c248b9",
      "name": "üßπ Prep Cleanup1",
      "type": "n8n-nodes-base.code",
      "position": [
        5488,
        7424
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// ACC - Accumulate calculation results for final aggregation\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst sd = $getWorkflowStaticData('global');\nconst w = $('üìä Update Result1').first().json;\nconst cid = String(w.chatId);\n\nif (!sd.res) sd.res = {};\nif (!sd.res[cid]) sd.res[cid] = [];\nsd.res[cid].push(w);\n\nconsole.log('Accumulated:', sd.res[cid].length, '/', w.total_works);\n\nreturn { json: w };"
      },
      "id": "cb42b795-ea07-4d57-b464-9cfaea582e66",
      "name": "Acc1",
      "type": "n8n-nodes-base.code",
      "position": [
        6032,
        8208
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/editMessageText",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"message_id\": {{ $json._edit_msg_id || 0 }}, \"text\": {{ JSON.stringify($json._result_text) }}, \"parse_mode\": \"Markdown\"}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "c82a88d7-582c-46f4-a263-d8711093433c",
      "name": "üì§ Edit Result1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        5856,
        8208
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// UPDATE RESULT - Format result message (‚úì Found / Not found)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst calcData = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(calcData.chatId);\nconst L = calcData.L || {};\n\nconst current = calcData.work_index || 1;\nconst total = calcData.total_works || 1;\nconst name = calcData.name || calcData.sq || 'Work';\n\nlet shortName = name.length > 22 ? name.substring(0, 19) + '...' : name;\n\nconst tc = parseFloat(calcData.tc) || 0;\nconst uc = parseFloat(calcData.uc) || 0;\nconst rateCode = String(calcData.rate_code || '');\nconst rateName = String(calcData.rate_name || '');\nconst currency = calcData.currency || L.sym || '‚Ç¨';\n\nconst hasValidRate = rateCode && \n  !rateCode.includes('NOT_FOUND') && \n  !rateCode.includes('PAYLOAD_NOT_FOUND');\n\nconst found = tc > 0 || uc > 0 || hasValidRate || (rateName && rateName.length > 0);\n\nconsole.log('Result:', shortName, found ? '‚úì' : '‚úó', tc.toFixed(0), currency);\n\nlet text = '';\nif (found) {\n  text = current + '/' + total + ' ' + shortName + ' ‚úì\\n';\n  text += tc.toFixed(0) + ' ' + currency;\n  if (rateCode && hasValidRate) text += ' ¬∑ ' + rateCode.substring(0, 20);\n} else {\n  text = current + '/' + total + ' ' + shortName + '\\n';\n  text += (L.not_found || '–ù–µ –Ω–∞–π–¥–µ–Ω–æ');\n}\n\nconst msgId = sd.calcProgress?.[cid]?.lastMsgId || null;\n\nreturn { json: { ...calcData, _result_text: text, _edit_msg_id: msgId, _found: found } };"
      },
      "id": "aac07bb6-70c9-4f1b-983e-addd79eb1f6c",
      "name": "üìä Update Result1",
      "type": "n8n-nodes-base.code",
      "position": [
        5696,
        8208
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PREP QUERY - Prepare search query with Qdrant credentials from TOKEN\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst loopItem = $input.first().json;\nconst tokenData = $('üîë TOKEN1').first().json;\n\nconst originalQuery = loopItem.sq || loopItem.query || loopItem.name || '';\nconst collectionName = loopItem.db || '';\nconst L = loopItem.L || {};\nconst workUnit = loopItem.unit || 'm¬≤';\nconst workQty = loopItem.qty || 1;\n\n// Get Qdrant credentials from TOKEN node\nconst QDRANT_URL = tokenData.QDRANT_URL || 'http://localhost:6333';\nconst QDRANT_API_KEY = tokenData.QDRANT_API_KEY || '';\n\nconsole.log('=== PREP QUERY ===');\nconsole.log('Query:', originalQuery);\nconsole.log('Collection:', collectionName);\nconsole.log('Qdrant URL:', QDRANT_URL);\n\nif (!originalQuery || !collectionName) {\n  console.log('ERROR: Missing query or collection');\n  return [{ json: { ...loopItem, _error: 'Missing data', _skip: true } }];\n}\n\nconst searchLang = L.search_lang || 'Russian';\n\n// Detect database language from collection name\nconst isRussianDB = collectionName.includes('RU_') || collectionName.includes('_RU');\nconst isGermanDB = collectionName.includes('DE_');\nconst dbLang = isRussianDB ? 'Russian' : (isGermanDB ? 'German' : 'English');\n\nconst transformPrompt = `You are a construction cost database search expert for ${dbLang} construction rates database.\n\nTASK: Transform user query into optimal SEARCH KEYWORDS that will match entries in a vector database of construction work rates.\n\nDATABASE CONTEXT:\n- Contains standardized construction work rates with codes, names, units, resources\n- Each rate has: rate_code, rate_name, rate_unit, scope_of_work, resources\n- Language: ${dbLang}\n\nTRANSFORMATION RULES:\n1. EXPAND abbreviations to full professional terms\n2. ADD synonyms and related construction terms\n3. INCLUDE work action verbs (install, apply, lay, mount)\n4. Keep original query terms + expanded terms\n5. Output in ${dbLang} language only\n\nUSER QUERY: ${originalQuery}\nUNIT: ${workUnit}\n\nReply with ONLY the optimized search keywords (one line, no explanations):`;\n\nreturn [{ json: {\n  ...loopItem,\n  _original_query: originalQuery,\n  _transform_prompt: transformPrompt,\n  _collection: collectionName,\n  _db_lang: dbLang,\n  _qdrant_url: QDRANT_URL,\n  _qdrant_key: QDRANT_API_KEY\n}}];"
      },
      "id": "3fd6efd2-3a4d-460b-bf8e-ca7cda4e792b",
      "name": "1Ô∏è‚É£ Prep Query1",
      "type": "n8n-nodes-base.code",
      "position": [
        6032,
        7808
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// SAVE WORK MSG - Store message ID for later editing/deletion\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst loopItem = $('üìù Prep Work Msg1').first().json;\nconst tgResp = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(loopItem.chatId);\n\nif (!sd.calcProgress) sd.calcProgress = {};\nif (!sd.calcProgress[cid]) sd.calcProgress[cid] = {};\nsd.calcProgress[cid].lastMsgId = tgResp.result?.message_id || null;\n\nconsole.log('Saved msg ID:', sd.calcProgress[cid].lastMsgId);\n\nreturn { json: loopItem };"
      },
      "id": "1e7602d7-ed57-41e3-b0cb-de1862e5dd05",
      "name": "üíæ Save Work Msg1",
      "type": "n8n-nodes-base.code",
      "position": [
        5856,
        7808
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $(\"üìù Prep Work Msg1\").item.json.chatId }}, \"text\": {{ JSON.stringify($(\"üìù Prep Work Msg1\").item.json._work_text) }}, \"parse_mode\": \"Markdown\"}",
        "options": {}
      },
      "id": "d9632123-00ce-45e6-8305-b3f999bf1e88",
      "name": "üì§ Send Work1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        5680,
        7808
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/deleteMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"message_id\": {{ $json._prev_msg_id || 0 }}}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "198dd76d-d9fc-49bd-b1d2-a73b9bcace06",
      "name": "üóëÔ∏è Delete Prev1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        5488,
        7808
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PREP WORK MSG - Create localized \"Searching...\" message for current work\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst loopItem = $('Loop1').first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(loopItem.chatId);\nconst L = loopItem.L || {};\nconst lang = L.search_lang || 'English';\n\nconst current = loopItem.work_index || 1;\nconst total = loopItem.total_works || 1;\nconst name = loopItem.name || loopItem.sq || 'Work';\nconst qty = loopItem.qty || 1;\nconst unit = loopItem.unit || 'm¬≤';\n\nlet shortName = name.length > 30 ? name.substring(0, 27) + '...' : name;\n\n// Localized search messages\nconst SEARCH_WORD = {\n  'German': 'üîç Suche',\n  'English': 'üîç Searching',\n  'Russian': 'üîç –ü–æ–∏—Å–∫',\n  'Spanish': 'üîç Buscando',\n  'French': 'üîç Recherche',\n  'Portuguese': 'üîç Buscando',\n  'Chinese': 'üîç ÊêúÁ¥¢‰∏≠',\n  'Arabic': 'üîç ÿ®ÿ≠ÿ´',\n  'Hindi': 'üîç ‡§ñ‡•ã‡§ú'\n};\n\nconst searchWord = SEARCH_WORD[lang] || 'üîç Searching';\n\n// Format: \"üîç –ü–æ–∏—Å–∫ 3/26\\n–ì–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω 25m¬≤\"\nlet text = `${searchWord} ${current}/${total}\\n`;\ntext += `*${shortName}*\\n`;\ntext += `${qty} ${unit}`;\n\nconst prevMsgId = sd.calcProgress?.[cid]?.lastMsgId || null;\n\nconsole.log('Work', current, '/', total, '-', shortName);\n\nreturn { json: { ...loopItem, _work_text: text, _prev_msg_id: prevMsgId } };"
      },
      "id": "c514d713-5b59-481e-a6b1-19fc7ba05b49",
      "name": "üìù Prep Work Msg1",
      "type": "n8n-nodes-base.code",
      "position": [
        5312,
        7808
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "id": "5d7b6bb1-b45c-48a0-9203-7d7737e71dfe",
      "name": "Loop1",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [
        5136,
        7440
      ],
      "typeVersion": 3
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PREP WORKS - Prepare work items for calculation loop (: 5 items)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $input.first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\n\n// Get all works (no limit)\nconst works = session.works || [];\nconst db = session.db || cfg.db;\nconst L = session.L || cfg.L;\n\n// Initialize results accumulator\nif (!sd.res) sd.res = {};\nsd.res[cid] = [];\n\nconst totalWorks = works.length;\n\nconsole.log('=== PREP WORKS ===');\nconsole.log('Processing:', totalWorks, 'items');\n\n// Return array for loop processing\nreturn works.map((w, idx) => ({ \n  json: { \n    ...w, \n    db, \n    L, \n    currency: L?.sym || '‚Ç¨',\n    bot_token: cfg.bot_token, \n    chatId: cid, \n    sq: w.query || w.name,\n    original_query: w.query || w.name,\n    work_index: idx + 1, \n    total_works: totalWorks,\n    _is_limited: cfg._is_limited,\n    _original_total: cfg._total_works\n  } \n}));"
      },
      "id": "50eefe8a-2669-41ed-ae4a-77a1829f69af",
      "name": "Prep Works1",
      "type": "n8n-nodes-base.code",
      "position": [
        4848,
        7184
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// SAVE PROGRESS ID - Store initial progress message ID for cleanup\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config1').first().json;\nconst prepData = $('üìù Prep Progress1').first().json;\nconst telegramResponse = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(cfg.chatId);\n\n// Store progress message info\nif (!sd.progress) sd.progress = {};\nsd.progress[cid] = {\n  message_id: telegramResponse.result?.message_id || 0,\n  chat_id: cfg.chatId,\n  bot_token: cfg.bot_token\n};\n\n// Initialize calculation progress tracker\nif (!sd.calcProgress) sd.calcProgress = {};\nsd.calcProgress[cid] = { lastMsgId: null };\n\nconsole.log('Progress msg ID:', sd.progress[cid].message_id);\n\nreturn { \n  json: { \n    ...cfg,\n    _total_works: prepData._total_works\n  } \n};"
      },
      "id": "2b5ee597-b766-4a59-9b41-1b1edc7d4c37",
      "name": "Save Progress ID1",
      "type": "n8n-nodes-base.code",
      "position": [
        4672,
        7184
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json._progress_chat_id }}, \"text\": {{ JSON.stringify($json._progress_text) }}, \"parse_mode\": \"Markdown\"}",
        "options": {}
      },
      "id": "5bea42a9-29ff-44e9-bf90-6e426385409a",
      "name": "üì§ Send Progress1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        4464,
        7184
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PREP PROGRESS - Show calculation progress message (localized)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config1').first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(cfg.chatId);\nconst session = sd.sess?.[cid] || {};\n\nconst allWorks = session.works || [];\nconst L = cfg.L || session.L || {};\nconst lang = cfg.lang || 'EN';\n\nconsole.log('=== PREP PROGRESS ===');\nconsole.log('Works:', allWorks.length);\nconsole.log('Language:', lang);\n\nconst totalWorks = allWorks.length;\nconst estimatedMinutes = Math.max(1, Math.ceil(totalWorks * 8 / 60));\n\n// Localized messages for \"Searching prices...\"\nconst SEARCH_MESSAGES = {\n  DE: `üîç *Preissuche l√§uft...*\\n\\n${totalWorks} Positionen\\n‚è± ~${estimatedMinutes} Min`,\n  EN: `üîç *Searching prices...*\\n\\n${totalWorks} items\\n‚è± ~${estimatedMinutes} min`,\n  RU: `üîç *–ü–æ–∏—Å–∫ —Ä–∞—Å—Ü–µ–Ω–æ–∫...*\\n\\n${totalWorks} –ø–æ–∑–∏—Ü–∏–π\\n‚è± ~${estimatedMinutes} –º–∏–Ω`,\n  ES: `üîç *Buscando precios...*\\n\\n${totalWorks} elementos\\n‚è± ~${estimatedMinutes} min`,\n  FR: `üîç *Recherche des prix...*\\n\\n${totalWorks} √©l√©ments\\n‚è± ~${estimatedMinutes} min`,\n  PT: `üîç *Buscando pre√ßos...*\\n\\n${totalWorks} itens\\n‚è± ~${estimatedMinutes} min`,\n  ZH: `üîç *Ê≠£Âú®ÊêúÁ¥¢‰ª∑Ê†º...*\\n\\n${totalWorks} È°πÁõÆ\\n‚è± ~${estimatedMinutes} ÂàÜÈíü`,\n  AR: `üîç *ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ£ÿ≥ÿπÿßÿ±...*\\n\\n${totalWorks} ÿπŸÜÿßÿµÿ±\\n‚è± ~${estimatedMinutes} ÿØŸÇŸäŸÇÿ©`,\n  HI: `üîç *‡§ï‡•Ä‡§Æ‡§§‡•á‡§Ç ‡§ñ‡•ã‡§ú ‡§∞‡§π‡•á ‡§π‡•à‡§Ç...*\\n\\n${totalWorks} ‡§Ü‡§á‡§ü‡§Æ\\n‚è± ~${estimatedMinutes} ‡§Æ‡§ø‡§®‡§ü`\n};\n\nconst text = SEARCH_MESSAGES[lang] || SEARCH_MESSAGES['EN'];\n\n// Save to session\nsession.totalWorks = totalWorks;\n\nreturn {\n  json: {\n    ...cfg,\n    _progress_chat_id: cfg.chatId,\n    _progress_text: text,\n    _total_works: totalWorks\n  }\n};"
      },
      "id": "3282206a-5313-467f-ba1a-2e6fad511f59",
      "name": "üìù Prep Progress1",
      "type": "n8n-nodes-base.code",
      "position": [
        4224,
        7184
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"text\": {{ JSON.stringify($json.msg) }}, \"parse_mode\": \"Markdown\", \"reply_markup\": {\"inline_keyboard\": {{ JSON.stringify($json.keyboard) }}}}",
        "options": {}
      },
      "id": "d263c324-f935-49b3-a100-9e826294871a",
      "name": "üì§ Send Works1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        4624,
        6512
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// SHOW WORKS - Display extracted work items with edit buttons\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfgNode = $('Config1').first().json;\nconst inputData = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\n\nconst chatId = inputData.chatId || cfgNode.chatId;\nconst bot_token = inputData.bot_token || cfgNode.bot_token;\nconst cid = String(chatId);\n\n// Get L from multiple sources (session is most reliable)\nconst session = sd.sess?.[cid] || {};\nlet L = cfgNode.L || session.L || inputData.L || {};\n\n// Get works from input (from Deduplicate) or session\nconst works = inputData.works || session.works || [];\nconst rooms = inputData.rooms || session.rooms || [];\n\nconsole.log('=== SHOW WORKS ===');\nconsole.log('Works:', works.length);\nconsole.log('L.search_lang:', L.search_lang);\n\n// Save to session\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = {};\nif (works.length > 0) {\n  sd.sess[cid].works = works;\n  sd.sess[cid].rooms = rooms;\n  sd.sess[cid].L = L;\n  sd.sess[cid].db = cfgNode.db;\n  sd.sess[cid].state = 'wait_edit';\n}\n\nfunction short(str, len) {\n  str = String(str || '');\n  return str.length > len ? str.substring(0, len - 1) + '‚Ä¶' : str;\n}\n\nconst totalArea = rooms.reduce((sum, r) => sum + (r.area_m2 || 0), 0);\n\n// Use localized labels with fallback\nconst roomWord = L.rooms || '–∫–æ–º–Ω–∞—Ç';\nconst workWord = L.works_identified || '–ø–æ–∑–∏—Ü–∏–π';\nconst generalWord = L.general || '–û–±—â–µ–µ';\n\nlet msg = '*' + rooms.length + ' ' + roomWord;\nif (totalArea > 0) msg += ' ¬∑ ' + (Math.round(totalArea * 10) / 10) + ' m¬≤';\nmsg += '*\\n';\nmsg += '_' + works.length + ' ' + workWord + '_\\n\\n';\n\nif (works.length === 0) {\n  msg += '_' + (L.no_works || '–†–∞–±–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã') + '_\\n';\n} else {\n  const worksByRoom = new Map();\n  const noRoom = [];\n\n  for (const w of works) {\n    if (w.room && w.room.length > 0) {\n      if (!worksByRoom.has(w.room)) worksByRoom.set(w.room, []);\n      worksByRoom.get(w.room).push(w);\n    } else {\n      noRoom.push(w);\n    }\n  }\n\n  let workNum = 1;\n\n  for (const [roomName, roomWorks] of worksByRoom) {\n    const room = rooms.find(r => r.name === roomName);\n    const areaStr = room?.area_m2 ? ' ¬∑ ' + room.area_m2 + ' m¬≤' : '';\n    msg += '*' + short(roomName, 20) + '*' + areaStr + '\\n';\n\n    for (const w of roomWorks) {\n      const wname = short(w.name || 'Work', 25);\n      const qty = typeof w.qty === 'number' ? Math.round(w.qty * 100) / 100 : w.qty;\n      msg += workNum + '. ' + wname + ' ‚Äî ' + qty + ' ' + (w.unit || '') + '\\n';\n      workNum++;\n    }\n    msg += '\\n';\n  }\n\n  if (noRoom.length > 0) {\n    msg += '*' + generalWord + '*\\n';\n    for (const w of noRoom) {\n      const wname = short(w.name || 'Work', 25);\n      const qty = typeof w.qty === 'number' ? Math.round(w.qty * 100) / 100 : w.qty;\n      msg += workNum + '. ' + wname + ' ‚Äî ' + qty + ' ' + (w.unit || '') + '\\n';\n      workNum++;\n    }\n  }\n}\n\n// Build keyboard\nconst keyboard = [];\nconst maxBtns = works.length;\nif (maxBtns > 0) {\n  for (let i = 0; i < maxBtns; i += 5) {\n    const row = [];\n    for (let j = 0; j < 5 && i + j < maxBtns; j++) {\n      row.push({ text: '‚úè' + (i + j + 1), callback_data: 'edit_work_' + (i + j) });\n    }\n    keyboard.push(row);\n  }\n}\n\nkeyboard.push([\n  { text: L.btn_add_work || '+ –ü–æ–∑–∏—Ü–∏—è', callback_data: 'add_work' },\n  { text: L.btn_calc || '‚ñ∂ –†–∞—Å—á—ë—Ç', callback_data: 'calculate' }\n]);\nkeyboard.push([\n  { text: L.btn_new || 'üîÑ –ó–∞–Ω–æ–≤–æ', callback_data: 'restart' }\n]);\n\nreturn { json: { chatId, bot_token, L, msg, keyboard, works, rooms } };"
      },
      "id": "5c38d1e2-bd74-479c-9d8c-da3c58caa701",
      "name": "üìä Show Works1",
      "type": "n8n-nodes-base.code",
      "position": [
        4480,
        6512
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// STEP 8: Calculate - FIXED VERSION v3\n// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ö\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst inputData = $input.first().json;\n\nconsole.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\nconsole.log('STEP 8: CALCULATE v3');\nconsole.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –£–ú–ù–´–ô –ü–û–ò–°–ö PAYLOAD - –∏—â–µ–º –≤–æ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nlet payload = null;\nlet payloadSource = 'not_found';\n\n// –í–∞—Ä–∏–∞–Ω—Ç 1: _best_result.payload\nif (inputData._best_result?.payload?.rate_code) {\n  payload = inputData._best_result.payload;\n  payloadSource = '_best_result.payload';\n}\n// –í–∞—Ä–∏–∞–Ω—Ç 2: _best_payload –Ω–∞–ø—Ä—è–º—É—é\nelse if (inputData._best_payload?.rate_code) {\n  payload = inputData._best_payload;\n  payloadSource = '_best_payload';\n}\n// –í–∞—Ä–∏–∞–Ω—Ç 3: –¥–∞–Ω–Ω—ã–µ –ª–µ–∂–∞—Ç –ø—Ä—è–º–æ –≤ _best_result (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ payload)\nelse if (inputData._best_result?.rate_code) {\n  payload = inputData._best_result;\n  payloadSource = '_best_result (direct)';\n}\n// –í–∞—Ä–∏–∞–Ω—Ç 4: payload –≤–Ω—É—Ç—Ä–∏ payload (–¥–≤–æ–π–Ω–∞—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å)\nelse if (inputData._best_result?.payload?.payload?.rate_code) {\n  payload = inputData._best_result.payload.payload;\n  payloadSource = '_best_result.payload.payload';\n}\n// –í–∞—Ä–∏–∞–Ω—Ç 5: –∏—â–µ–º rate_code –≥–¥–µ —É–≥–æ–¥–Ω–æ –≤ _best_result\nelse if (inputData._best_result) {\n  const br = inputData._best_result;\n  // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫\n  const findPayload = (obj, depth = 0) => {\n    if (!obj || depth > 3) return null;\n    if (obj.rate_code && obj.resources) return obj;\n    for (const key of Object.keys(obj)) {\n      if (typeof obj[key] === 'object' && obj[key] !== null) {\n        const found = findPayload(obj[key], depth + 1);\n        if (found) return found;\n      }\n    }\n    return null;\n  };\n  payload = findPayload(br);\n  if (payload) payloadSource = '_best_result (deep search)';\n}\n\nconsole.log('Payload source:', payloadSource);\nconsole.log('Payload found:', !!payload);\n\nif (payload) {\n  console.log('Payload keys:', Object.keys(payload));\n  console.log('rate_code:', payload.rate_code);\n  console.log('rate_name:', payload.rate_name?.substring(0, 50));\n  console.log('resources count:', (payload.resources || []).length);\n  console.log('cost_summary:', JSON.stringify(payload.cost_summary || {}).substring(0, 200));\n}\n\n// –ï—Å–ª–∏ payload –Ω–µ –Ω–∞–π–¥–µ–Ω - –≤—ã–≤–æ–¥–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏\nif (!payload) {\n  console.log('');\n  console.log('‚ùå PAYLOAD NOT FOUND! Debug info:');\n  console.log('inputData keys:', Object.keys(inputData));\n  if (inputData._best_result) {\n    console.log('_best_result keys:', Object.keys(inputData._best_result));\n    console.log('_best_result.payload:', typeof inputData._best_result.payload);\n    if (inputData._best_result.payload) {\n      console.log('_best_result.payload keys:', Object.keys(inputData._best_result.payload));\n    }\n  }\n  \n  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π\n  return [{ json: { \n    ...inputData,\n    rate_code: 'PAYLOAD_NOT_FOUND',\n    rate_name: inputData.name || inputData.sq || 'Unknown',\n    uc: 0, tc: 0,\n    resources: [],\n    _debug_keys: Object.keys(inputData),\n    _debug_best_result_keys: Object.keys(inputData._best_result || {}),\n    _debug_payload_source: payloadSource\n  }}];\n}\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –¢–µ–ø–µ—Ä—å payload –Ω–∞–π–¥–µ–Ω - –∏–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã\nconst workName = inputData.name || inputData.sq || '';\nconst workQty = inputData.qty || 1;\nconst workUnit = inputData.unit || 'm¬≤';\n\nconsole.log('');\nconsole.log('Work:', workName);\nconsole.log('Qty:', workQty, workUnit);\n\n// –î–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ü–µ–Ω–∫–∏\nconst rateCode = payload.rate_code || 'NOT_FOUND';\nconst rateName = payload.rate_name || workName;\nconst rateUnit = payload.rate_unit || '';\n\nconsole.log('Rate code:', rateCode);\nconsole.log('Rate name:', rateName?.substring(0, 50));\nconsole.log('Rate unit:', rateUnit);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –ü–æ–ª—É—á–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst costSummary = payload.cost_summary || {};\nlet totalCost = parseFloat(costSummary.total_cost_position || costSummary.total_cost || 0);\n\n// –ï—Å–ª–∏ cost_summary –ø—É—Å—Ç–æ–π, –≤—ã—á–∏—Å–ª—è–µ–º –∏–∑ —Ä–µ—Å—É—Ä—Å–æ–≤\nconst rawResources = payload.resources || [];\nif (totalCost === 0 && rawResources.length > 0) {\n  totalCost = rawResources.reduce((sum, r) => {\n    return sum + parseFloat(r.resource_cost_eur || 0);\n  }, 0);\n  console.log('Total cost calculated from resources:', totalCost);\n}\n\nconsole.log('Total cost:', totalCost);\nconsole.log('Resources count:', rawResources.length);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–ª–∏—Ç–µ–ª—å –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nlet unitDivisor = 1;\nconst rateUnitLower = (rateUnit || '').toLowerCase();\n\nif (rateUnitLower.includes('100 ') || rateUnitLower === '100 –º' || rateUnitLower === '100 –º¬≤' || rateUnitLower === '100 –º2') {\n  unitDivisor = 100;\n} else if (rateUnitLower.match(/^10\\s/) || rateUnitLower.includes('10 –º')) {\n  unitDivisor = 10;\n}\n\nconsole.log('Unit divisor:', unitDivisor);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Price calculation\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst uc = unitDivisor > 0 ? totalCost / unitDivisor : 0;\nconst tc = workQty * uc;\nconst scaleFactor = unitDivisor > 0 ? workQty / unitDivisor : workQty;\n\nconsole.log('');\nconsole.log('=== PRICE CALCULATION ===');\nconsole.log('UC (price per unit):', uc.toFixed(2), 'EUR');\nconsole.log('TC (total cost):', tc.toFixed(2), 'EUR');\nconsole.log('Scale factor:', scaleFactor);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nlet workersTotal = 0;\nlet materialsTotal = 0;\nlet machinesTotal = 0;\nlet laborHoursTotal = 0;\n\nconst resources = rawResources.map(r => {\n  const code = r.resource_code || '';\n  const name = r.resource_name || '';\n  const unit = r.resource_unit || '';\n  const rowType = r.row_type || '';\n  \n  const originalQty = r.resource_quantity !== null && r.resource_quantity !== undefined \n    ? parseFloat(r.resource_quantity) \n    : null;\n  const pricePerUnit = parseFloat(r.resource_price_per_unit_eur_current || 0);\n  const originalCost = parseFloat(r.resource_cost_eur || 0);\n  \n  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ä–µ—Å—É—Ä—Å–∞\n  let resourceType = 'material';\n  const rowTypeLower = (rowType || '').toLowerCase();\n  const codeUpper = (code || '').toUpperCase();\n  \n  if (rowTypeLower === '–º–∞—à–∏–Ω–∏—Å—Ç' || rowTypeLower.includes('–º–∞—à–∏–Ω–∏—Å—Ç')) {\n    resourceType = 'labor';\n  } else if (rowTypeLower === '—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ' || rowTypeLower.includes('—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤')) {\n    resourceType = 'machine';\n  } else if (codeUpper.startsWith('DXME') || codeUpper.startsWith('DX')) {\n    resourceType = 'machine';\n  } else if (codeUpper.startsWith('ME_') || codeUpper.startsWith('PU_') || codeUpper.startsWith('RI_')) {\n    resourceType = 'labor';\n  }\n  \n  // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ\n  let scaledQty = null;\n  let scaledCost = 0;\n  \n  if (originalQty !== null) {\n    scaledQty = originalQty * scaleFactor;\n    scaledCost = scaledQty * pricePerUnit;\n  } else {\n    scaledCost = originalCost * scaleFactor;\n  }\n  \n  // –°—É–º–º–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n  if (resourceType === 'labor') {\n    workersTotal += scaledCost;\n    if (unit === '—á' || unit === '—á–µ–ª.-—á' || unit === '—á–µ–ª-—á' || unit === '–º–∞—à.-—á') {\n      laborHoursTotal += scaledQty || 0;\n    }\n  } else if (resourceType === 'machine') {\n    machinesTotal += scaledCost;\n  } else {\n    materialsTotal += scaledCost;\n  }\n  \n  return {\n    resource_code: code,\n    resource_name: name,\n    resource_unit: unit,\n    resource_type: resourceType,\n    row_type: rowType,\n    resource_price: pricePerUnit,\n    original_quantity: originalQty,\n    original_cost: originalCost,\n    scaled_quantity: scaledQty,\n    scaled_cost: scaledCost\n  };\n});\n\nconsole.log('');\nconsole.log('=== RESOURCES BREAKDOWN ===');\nconsole.log('Resources processed:', resources.length);\nconsole.log('Workers total:', workersTotal.toFixed(2), 'EUR');\nconsole.log('Materials total:', materialsTotal.toFixed(2), 'EUR');\nconsole.log('Machines total:', machinesTotal.toFixed(2), 'EUR');\nconsole.log('Labor hours:', laborHoursTotal.toFixed(1), 'h');\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Scope of work\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst workSteps = payload.work_steps || [];\nconst scopeOfWork = workSteps.map(s => s.text || '').filter(t => t.length > 0);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Quality\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst llmScore = inputData._llm_score || 0;\nconst qdrantScore = inputData._qdrant_score || 0;\n\nconst qualityLevel = llmScore >= 75 ? 'high' : \n                     llmScore >= 50 ? 'medium' : \n                     llmScore >= 25 ? 'low' : 'not_found';\n\nconsole.log('');\nconsole.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\nconsole.log('‚úÖ CALCULATION COMPLETE');\nconsole.log('Rate:', rateCode, '-', rateName?.substring(0, 40));\nconsole.log('Total:', tc.toFixed(2), 'EUR');\nconsole.log('Resources:', resources.length);\nconsole.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –§–ò–ù–ê–õ–¨–ù–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nreturn [{ json: { \n  // Original data\n  ...inputData,\n  name: workName,\n  qty: workQty,\n  unit: workUnit,\n  \n  // Rate\n  rate_code: rateCode,\n  rate_name: rateName,\n  rate_unit: workUnit,\n  original_rate_unit: rateUnit,\n  \n  // Prices\n  uc,\n  tc,\n  \n  // Labor\n  labor_hours: laborHoursTotal,\n  workers_total: workersTotal,\n  machines_total: machinesTotal,\n  materials_total: materialsTotal,\n  \n  // Quality\n  ql: qualityLevel,\n  quality_score: llmScore,\n  qdrant_score: qdrantScore,\n  llm_score: llmScore,\n  llm_reason: inputData._llm_reason || '',\n  \n  // Resources\n  resources,\n  \n  // Scope of work\n  scope_of_work: scopeOfWork,\n  \n  // Hierarchy\n  hierarchy: payload.hierarchy || {},\n  \n  // Breakdown\n  cost_breakdown: { \n    workers: workersTotal, \n    machines: machinesTotal, \n    materials: materialsTotal \n  },\n  \n  // Debug\n  _payload_source: payloadSource,\n  _scale_factor: scaleFactor,\n  _unit_divisor: unitDivisor,\n  _original_total_cost: totalCost\n}}];"
      },
      "id": "799df6a2-34a9-4f93-8448-367929f0e29c",
      "name": "9Ô∏è‚É£ Calculate1",
      "type": "n8n-nodes-base.code",
      "position": [
        5488,
        8208
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// 8Ô∏è‚É£ APPLY RERANK v5 - Fixed empty results handling\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst prepData = $('6Ô∏è‚É£ Prep Rerank1').first().json;\nconst llmResponse = $input.first().json;\n\nconsole.log('=== APPLY RERANK v5 ===');\n\nconst qdrantResults = prepData._qdrant_results || [];\n\n// Early exit if no results\nif (qdrantResults.length === 0) {\n  console.log('No Qdrant results to rerank');\n  return [{ json: {\n    ...prepData,\n    _best_result: null,\n    _best_payload: {},\n    _llm_score: 0,\n    _llm_reason: 'no results',\n    _qdrant_score: 0,\n    _quality_level: 'not_found',\n    ql: 'not_found',\n    _step: 'rerank_done'\n  }}];\n}\n\n// Helper: extract actual data from various payload formats\nfunction getPayloadData(rawPayload) {\n  // Format 1: LangChain/n8n format - data in payload_full\n  if (rawPayload.payload_full) {\n    return rawPayload.payload_full;\n  }\n  // Format 2: data in metadata\n  if (rawPayload.metadata?.rate_code || rawPayload.metadata?.hierarchy) {\n    return rawPayload.metadata;\n  }\n  // Format 3: direct format - data at root level\n  if (rawPayload.rate_code || rawPayload.hierarchy) {\n    return rawPayload;\n  }\n  return rawPayload;\n}\n\nlet rankings = [];\ntry {\n  // AI node returns text directly, HTTP returns choices[0].message.content\n  let text = llmResponse.text || llmResponse.choices?.[0]?.message?.content || '';\n  \n  // Clear –æ—Ç markdown –∏ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤\n  text = text.replace(/```json\\n?/g, '').replace(/```/g, '').trim();\n  \n  console.log('Raw LLM response:', text.substring(0, 200));\n  \n  // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ JSON\n  const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    const parsed = JSON.parse(jsonMatch[0]);\n    rankings = parsed.rankings || [];\n    console.log('Parsed rankings:', rankings.length);\n  }\n} catch(e) {\n  console.log('Parse error:', e.message);\n  // Fallback - –∏—Å–ø–æ–ª—å–∑—É–µ–º Qdrant scores\n  rankings = qdrantResults.map((r, i) => ({\n    index: i,\n    score: Math.round((r.score || 0) * 100),\n    reason: 'qdrant score'\n  }));\n}\n\n// –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º LLM –∏ Qdrant scores\nconst scored = qdrantResults.map((r, i) => {\n  const rawPayload = r.payload || {};\n  const p = getPayloadData(rawPayload);\n  const h = p.hierarchy || {};\n  \n  // Normalize payload with extracted data\n  const normalizedPayload = {\n    ...p,\n    rate_code: p.rate_code || h.subsection_code || h.section_code || h.justification_nr || '',\n    rate_name: p.rate_name || h.subsection_name || h.section_name || '',\n    rate_unit: p.rate_unit || h.unit || '',\n    resources: p.resources || [],\n    work_steps: p.work_steps || [],\n    hierarchy: h\n  };\n  \n  const rank = rankings.find(x => x.index === i);\n  const llmScore = rank?.score || 0;\n  const reason = rank?.reason || '';\n  const qdrantScore = (r.score || 0) * 100;\n  \n  // Weighted combination: LLM –≤–∞–∂–Ω–µ–µ –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ Qdrant\n  let combinedScore;\n  if (llmScore > 0) {\n    combinedScore = llmScore * 0.7 + qdrantScore * 0.3;\n  } else {\n    combinedScore = qdrantScore;\n  }\n  \n  console.log('[' + i + '] LLM=' + llmScore + ' Qdrant=' + qdrantScore.toFixed(0) + ' Combined=' + combinedScore.toFixed(0) + ' - ' + (normalizedPayload.rate_code || 'N/A'));\n  \n  return {\n    ...r,\n    payload: normalizedPayload,\n    llm_score: llmScore,\n    llm_reason: reason,\n    qdrant_score: r.score || 0,\n    combined_score: combinedScore\n  };\n});\n\n// Sort –ø–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É score\nscored.sort((a, b) => b.combined_score - a.combined_score);\n\nconst best = scored[0];\nconst bestPayload = best?.payload || {};\nconst combinedScore = best?.combined_score || 0;\n\n// Determine quality —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞\nlet qualityLevel = 'not_found';\nif (combinedScore >= 80) qualityLevel = 'high';\nelse if (combinedScore >= 60) qualityLevel = 'medium';\nelse if (combinedScore >= 40) qualityLevel = 'low';\n\nconsole.log('');\nconsole.log('‚úÖ BEST: ' + (bestPayload.rate_code || 'N/A') + ' - ' + (bestPayload.rate_name || '').substring(0, 50));\nconsole.log('   Combined: ' + combinedScore.toFixed(0) + ' | Quality: ' + qualityLevel);\nconsole.log('   Reason: ' + (best?.llm_reason || 'N/A'));\n\nreturn [{ json: {\n  ...prepData,\n  _best_result: best || null,\n  _best_payload: bestPayload,\n  _llm_score: best?.llm_score || 0,\n  _llm_reason: best?.llm_reason || '',\n  _qdrant_score: best?.qdrant_score || 0,\n  _quality_level: qualityLevel,\n  ql: qualityLevel,\n  _step: 'rerank_done'\n}}];"
      },
      "id": "65fdb131-81bb-4e91-8f11-a5ec6c2a5d05",
      "name": "8Ô∏è‚É£ Apply Rerank1",
      "type": "n8n-nodes-base.code",
      "position": [
        6688,
        8000
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// 6Ô∏è‚É£ PREP RERANK v4 - Fixed for LangChain/n8n vector store format\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst prepData = $('4Ô∏è‚É£ Extract Embedding1').first().json;\nconst qdrantResponse = $input.first().json;\n\nconsole.log('=== PREP RERANK v4 ===');\n\nif (qdrantResponse.status?.error) {\n  return [{ json: { ...prepData, rate_code: 'QDRANT_ERROR', uc: 0, tc: 0, ql: 'not_found', resources: [] }}];\n}\n\nconst results = qdrantResponse.result || [];\nconsole.log('Qdrant results:', results.length);\n\nif (results.length === 0) {\n  return [{ json: { ...prepData, rate_code: 'NOT_FOUND', rate_name: prepData._original_query, uc: 0, tc: 0, ql: 'not_found', resources: [] }}];\n}\n\nconst originalQuery = prepData._original_query || prepData.name || '';\nconst workUnit = prepData.unit || 'm¬≤';\nconst workQty = prepData.qty || 1;\n\n// Helper: extract actual data from various payload formats\nfunction getPayloadData(rawPayload) {\n  // Format 1: LangChain/n8n format - data in payload_full\n  if (rawPayload.payload_full) {\n    return rawPayload.payload_full;\n  }\n  // Format 2: data in metadata\n  if (rawPayload.metadata?.rate_code || rawPayload.metadata?.hierarchy) {\n    return rawPayload.metadata;\n  }\n  // Format 3: direct format - data at root level\n  if (rawPayload.rate_code || rawPayload.hierarchy) {\n    return rawPayload;\n  }\n  // Return as-is\n  return rawPayload;\n}\n\n// Format –∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤\nconst candidates = results.slice(0, 5).map((r, i) => {\n  const rawPayload = r.payload || {};\n  const p = getPayloadData(rawPayload);\n  const h = p.hierarchy || {};\n  \n  // Extract rate info (support both formats)\n  const code = p.rate_code || h.subsection_code || h.section_code || h.justification_nr || '';\n  const name = p.rate_name || h.subsection_name || h.section_name || '';\n  const unit = p.rate_unit || h.unit || '';\n  \n  // Scope of work\n  const workSteps = p.work_steps || [];\n  const scopeText = workSteps.slice(0, 3).map(s => s.text || s).join('; ');\n  \n  // Key materials\n  const resources = p.resources || [];\n  const materials = resources\n    .filter(res => !res.resource_code?.match(/^(DXME|ME_|PU_|RI_)/))\n    .slice(0, 3)\n    .map(res => res.resource_name)\n    .join(', ');\n  \n  const qdrantScore = (r.score * 100).toFixed(0);\n  \n  console.log('[' + i + '] ' + code + ' - ' + (name || '').substring(0, 40) + ' | ' + qdrantScore + '%');\n  \n  return i + '. [' + code + '] ' + name + '\\n   Unit: ' + unit + ' | Scope: ' + (scopeText || 'n/a').substring(0, 100) + '\\n   Materials: ' + (materials || 'n/a');\n}).join('\\n\\n');\n\nconst rerankPrompt = `TASK: Score construction rate candidates (0-100) for matching user's work request.\n\nSCORING GUIDE:\n95-100: EXACT MATCH - Same work type, method, materials, unit compatible\n80-94: VERY GOOD - Same work, minor spec differences (thickness, brand)\n65-79: GOOD - Same category, different specification\n50-64: PARTIAL - Related work, different scope\n30-49: WEAK - Same trade, different work type\n0-29: WRONG - Different trade or unrelated\n\nCRITICAL DISTINCTIONS:\n‚Ä¢ –ì–ö–õ (–≥–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω) ‚â† –ì–í–õ (–≥–∏–ø—Å–æ–≤–æ–ª–æ–∫–Ω–æ) - DIFFERENT materials, max 60\n‚Ä¢ –°—Ç–µ–Ω—ã ‚â† –ü–æ—Ç–æ–ª–æ–∫ - check work location matches\n‚Ä¢ –ú–æ–Ω—Ç–∞–∂ ‚â† –î–µ–º–æ–Ω—Ç–∞–∂ - opposite operations\n‚Ä¢ 1 —Å–ª–æ–π ‚â† 2 —Å–ª–æ—è - check layer count\n‚Ä¢ Profile types: –ü–ü60 = ceiling, –ü–° = wall stud, –ü–ù = guide\n\nUNIT MATCHING:\n‚Ä¢ Query unit: ${workUnit}\n‚Ä¢ Rate unit should be compatible or convertible\n‚Ä¢ m¬≤ work ‚Üí m¬≤ rate (ideal)\n‚Ä¢ m¬≤ work ‚Üí 100m¬≤ rate (ok, will scale)\n\nUSER REQUEST: \"${originalQuery}\" (${workQty} ${workUnit})\n\nCANDIDATES:\n${candidates}\n\nReturn ONLY valid JSON (no markdown):\n{\"rankings\":[{\"index\":0,\"score\":N,\"reason\":\"brief reason\"},{\"index\":1,\"score\":N,\"reason\":\"brief reason\"}]}`;\n\nconsole.log('Prompt length:', rerankPrompt.length);\n\nreturn [{ json: {\n  ...prepData,\n  _qdrant_results: results,\n  _rerank_prompt: rerankPrompt,\n  _step: 'prep_rerank_done'\n}}];"
      },
      "id": "78fcc9ac-baa5-44fc-a476-2a98bb68d1b4",
      "name": "6Ô∏è‚É£ Prep Rerank1",
      "type": "n8n-nodes-base.code",
      "position": [
        6032,
        8000
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json._qdrant_url }}/collections/{{ $json._collection }}/points/search",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api-key",
              "value": "={{ $json._qdrant_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"vector\": {{ JSON.stringify($json._embedding) }},\n  \"limit\": 10,\n  \"with_payload\": true,\n  \"with_vector\": false\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          },
          "timeout": 30000
        }
      },
      "id": "01098aff-6bd4-4b0c-b680-11f8e1cfcae5",
      "name": "5Ô∏è‚É£ Qdrant Search1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        5856,
        8000
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// EXTRACT EMBEDDING - Get vector from OpenAI response\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst prepData = $('2Ô∏è‚É£ Extract Transform1').first().json;\nconst embResponse = $input.first().json;\n\nconsole.log('=== EXTRACT EMBEDDING ===');\n\nif (embResponse.error) {\n  console.log('OpenAI Error:', embResponse.error.message);\n  return [{ json: { ...prepData, _error: embResponse.error.message, _embedding: [] }}];\n}\n\nconst embedding = embResponse.data?.[0]?.embedding || [];\nconsole.log('Embedding length:', embedding.length);\n\n// Accept various embedding sizes\nif (embedding.length < 256) {\n  console.log('WARNING: Embedding too short:', embedding.length);\n}\n\n// Pass all data including Qdrant credentials\nreturn [{ json: {\n  ...prepData,\n  _embedding: embedding,\n  _collection: prepData._collection,\n  _qdrant_url: prepData._qdrant_url,\n  _qdrant_key: prepData._qdrant_key,\n  _step: 'embedding_done'\n}}];"
      },
      "id": "8bb13d30-57c4-421f-9305-396dcce63c1b",
      "name": "4Ô∏è‚É£ Extract Embedding1",
      "type": "n8n-nodes-base.code",
      "position": [
        5696,
        8000
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// EXTRACT TRANSFORM - Clean AI response and combine queries\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst prepData = $('1Ô∏è‚É£ Prep Query1').first().json;\nconst aiResponse = $input.first().json;\n\nconsole.log('=== EXTRACT TRANSFORM ===');\n\nlet transformedQuery = prepData._original_query;\n\ntry {\n  // n8n AI node returns text in different places\n  let content = '';\n  if (aiResponse.text) {\n    content = aiResponse.text;\n  } else if (aiResponse.response?.text) {\n    content = aiResponse.response.text;\n  } else if (aiResponse.output) {\n    content = aiResponse.output;\n  } else if (aiResponse.choices?.[0]?.message?.content) {\n    // Fallback for raw API response\n    content = aiResponse.choices[0].message.content;\n  }\n  \n  if (content && content.length > 5) {\n    transformedQuery = content\n      .replace(/^(keywords?:|search:|query:|result:)/i, '')\n      .replace(/[\\n\\r]+/g, ' ')\n      .trim();\n    console.log('Transformed OK');\n  }\n} catch(e) {\n  console.log('Transform failed:', e.message);\n}\n\nconsole.log('Original:', prepData._original_query);\nconsole.log('Transformed:', transformedQuery.substring(0, 80));\n\n// Smart combination - original is more important\nconst originalWords = prepData._original_query.toLowerCase().split(/\\s+/);\nconst transformedWords = transformedQuery.toLowerCase().split(/\\s+/);\n\n// Add only new words from transformation\nconst newWords = transformedWords.filter(w => \n  w.length > 2 && !originalWords.some(ow => ow.includes(w) || w.includes(ow))\n);\n\nconst combinedQuery = prepData._original_query + ' ' + newWords.slice(0, 10).join(' ');\n\nconsole.log('Combined:', combinedQuery.substring(0, 100));\n\nreturn [{ json: {\n  ...prepData,\n  _query: combinedQuery.trim(),\n  _transformed_query: transformedQuery,\n  _collection: prepData._collection,\n  _qdrant_url: prepData._qdrant_url,\n  _qdrant_key: prepData._qdrant_key,\n  _step: 'transform_done'\n}}];"
      },
      "id": "75ee1873-cf0f-4dd1-b590-fec415bf11ba",
      "name": "2Ô∏è‚É£ Extract Transform1",
      "type": "n8n-nodes-base.code",
      "position": [
        6688,
        7808
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify($json.msg) }},\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [\n      [{\"text\": \"{{ $json.L.btn_export_excel || '‚Üì Excel' }}\", \"callback_data\": \"export_excel\"}, {\"text\": \"{{ $json.L.btn_export_pdf || '‚Üì PDF' }}\", \"callback_data\": \"export_pdf\"}],\n      [{\"text\": \"{{ $json.L.btn_restart || '‚Üª Restart' }}\", \"callback_data\": \"restart\"}]\n    ]\n  }\n}",
        "options": {}
      },
      "id": "650468d2-6a3f-4b85-8ba6-d26975431e8e",
      "name": "üì§ Details1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        4224,
        7488
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// Detailed view with resource prices\nconst cfg = $('Config1').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst data = sd.lastResults || {};\nconst L = data.L || cfg.L || {};\nconst works = data.works || [];\nconst sym = L.sym || '‚Ç¨';\n\nfunction fmtCur(v) { \n  if (!v || v === 0) return sym + ' 0';\n  return sym + ' ' + v.toFixed(2); \n}\n\nlet msg = `*${L.ready} ‚Äî ${L.resources}*\\n\\n`;\n\nworks.forEach((w, i) => {\n  const qi = { 'high': '‚óè', 'medium': '‚óã', 'low': '‚óå', 'not_found': '‚úï' }[w.ql] || '‚óã';\n  \n  msg += `*${i+1}. ${w.name}*\\n`;\n  if (w.rate_code && w.rate_code !== 'NOT_FOUND') {\n    msg += `${qi} \\`${w.rate_code}\\`\\n`;\n    if (w.rate_name && w.rate_name !== w.name) {\n      const rateName = (w.rate_name || '').substring(0, 45);\n      msg += `_${rateName}_\\n`;\n    }\n  } else {\n    msg += `${qi} _${L.not_found}_\\n`;\n  }\n  msg += `${w.qty} ${w.unit} √ó ${fmtCur(w.uc)} = *${fmtCur(w.tc)}*\\n`;\n  \n  // Cost breakdown\n  const parts = [];\n  if (w.workers_total > 0) parts.push(`${L.workers}: ${fmtCur(w.workers_total)}`);\n  if (w.materials_total > 0) parts.push(`${L.materials}: ${fmtCur(w.materials_total)}`);\n  if (w.machines_total > 0) parts.push(`${L.machines}: ${fmtCur(w.machines_total)}`);\n  if (parts.length > 0) msg += `_${parts.join(' ¬∑ ')}_\\n`;\n  \n  // Resources with prices\n  const resources = w.resources || [];\n  if (resources.length > 0) {\n    msg += `\\n`;\n    const showCount = Math.min(5, resources.length);\n    resources.slice(0, showCount).forEach((r, ri) => {\n      const isLast = ri === showCount - 1 && resources.length <= 5;\n      const prefix = isLast ? '‚îî' : '‚îú';\n      const typeTag = r.resource_type === 'labor' ? L.res_labor : r.resource_type === 'machine' ? L.res_machine : L.res_material;\n      const resName = (r.resource_name || '').substring(0, 26);\n      msg += `${prefix} *${typeTag}*: ${resName}\\n`;\n      \n      // Show quantity and cost\n      const qtyVal = r.scaled_quantity || r.resource_quantity || 0;\n      const costVal = r.scaled_cost || r.resource_cost || 0;\n      if (costVal > 0) {\n        msg += `   ${qtyVal.toFixed(2)} ${r.resource_unit || ''} = ${fmtCur(costVal)}\\n`;\n      } else {\n        msg += `   ${qtyVal.toFixed(2)} ${r.resource_unit || ''}\\n`;\n      }\n    });\n    if (resources.length > 5) {\n      msg += `‚îî _...+${resources.length - 5} ${L.resources}_\\n`;\n    }\n  }\n  \n  // Scope of work\n  const scope = w.scope_of_work || [];\n  if (scope.length > 0) {\n    msg += `\\nüìã *${L.scope_title || 'Scope of Work'}:*\\n`;\n    scope.forEach((s, si) => {\n      const prefix = si === scope.length - 1 ? '‚îî' : '‚îú';\n      const sText = (s || '').substring(0, 45);\n      msg += `${prefix} ${sText}\\n`;\n    });\n  }\n  msg += `\\n`;\n});\n\n// Summary\nmsg += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n`;\nconst totalParts = [];\nif (data.workers_sum > 0) totalParts.push(`${L.workers}: ${fmtCur(data.workers_sum)}`);\nif (data.materials_sum > 0) totalParts.push(`${L.materials}: ${fmtCur(data.materials_sum)}`);\nif (data.machines_sum > 0) totalParts.push(`${L.machines}: ${fmtCur(data.machines_sum)}`);\nif (totalParts.length > 0) msg += totalParts.join('\\n') + '\\n\\n';\n\nmsg += `*${L.total}: ${fmtCur(data.total || 0)}*\\n`;\n\nreturn { json: { ...cfg, msg, chatId: cid, bot_token: cfg.bot_token, L } };"
      },
      "id": "ddece257-1303-438a-9274-23f2465ba934",
      "name": "View Details1",
      "type": "n8n-nodes-base.code",
      "position": [
        4032,
        7488
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify(($json.L && $json.L.fallback_start) || \"Use /start to begin\") }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "376b44f9-24bb-440d-8b02-3d12c9ccf346",
      "name": "üì§ Fallback1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        3680,
        6976
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": \"*DDC CWICR - Help*\\n\\n*What is DDC CWICR?*\\nOpen source construction cost database\\nhttps://DataDrivenConstruction.io\\n\\n*Features:*\\nüì∏ Photo analysis with AI\\nüìù Text input with work lists\\nüåç 9 languages supported\\nüìä 55,000+ work items\\nüí∞ Regional pricing (EUR, USD, RUB, etc.)\\nüìÑ Excel & PDF export\\n\\n*How to use:*\\n1. Select your language\\n2. Send photo OR text description\\n3. Edit detected works if needed\\n4. Get cost estimate\\n\\n*Commands:*\\n/start - New estimate\\n\\n*Contact:*\\nGitHub: github.com/datadrivenconstruction/OpenConstructionEstimate-DDC-CWICR\",\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [[{\"text\": \"‚óÄÔ∏è Back\", \"callback_data\": \"back_to_lang\"}]]\n  }\n}",
        "options": {}
      },
      "id": "b742f04a-c2fe-4980-af0a-f312de552908",
      "name": "üì§ Help1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        4032,
        7488
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $json.chatId }}",
        "binaryData": true,
        "binaryPropertyName": "pdf",
        "additionalFields": {
          "caption": "={{ $json.L?.export_pdf_msg || 'üìÑ PDF Export (HTML)' }}",
          "fileName": "={{ $json.filename }}"
        }
      },
      "id": "a29a0b8a-e379-431a-9102-61f9d4ece76c",
      "name": "üì§ Send PDF1",
      "type": "n8n-nodes-base.telegram",
      "position": [
        4464,
        7328
      ],
      "webhookId": "0cfa0dd8-bdc3-4031-9a7a-1d3948d2c347",
      "typeVersion": 1.2,
      "credentials": {
        "telegramApi": {
          "id": "Pg9c5uHdiZaPWTEZ",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              },
              "leftValue": "={{ $json.skip }}",
              "rightValue": true
            }
          ]
        },
        "options": {}
      },
      "id": "48e38cd1-f688-4239-b026-063f4a43ea37",
      "name": "IF PDF1",
      "type": "n8n-nodes-base.if",
      "position": [
        4224,
        7344
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// Generate PDF (using HTML-to-PDF service or return HTML)\nconst cfg = $('Config1').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst html = sd.html_report || '';\nconst L = sd.lastResults?.L || cfg.L || {};\n\nif (!html) {\n  // No HTML report yet - send message\n  try {\n    await $http.request({\n      method: 'POST',\n      url: `https://api.telegram.org/bot${cfg.bot_token}/sendMessage`,\n      body: { chat_id: parseInt(cid), text: '‚ùå No report to export. Please calculate first.' },\n      json: true\n    });\n  } catch(e) {}\n  return { json: { skip: true } };\n}\n\n// For now, send HTML file as \"PDF alternative\"\nconst filename = `Estimate_${(L.region || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().substring(0, 10)}.html`;\n\nreturn { json: { chatId: cid, L, bot_token: cfg.bot_token, filename }, binary: { pdf: { data: Buffer.from(html, 'utf-8').toString('base64'), mimeType: 'text/html', fileName: filename } } };"
      },
      "id": "bd4047f6-a11a-4056-a0f4-0934f9b99309",
      "name": "Generate PDF1",
      "type": "n8n-nodes-base.code",
      "position": [
        4032,
        7344
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $json.chatId }}",
        "binaryData": true,
        "binaryPropertyName": "excel",
        "additionalFields": {
          "caption": "={{ $json.L?.export_excel_msg || 'üìä Excel Export (CSV)' }}",
          "fileName": "={{ $json.filename }}"
        }
      },
      "id": "de02aadf-e7ba-4ee0-a8b9-f7e76d24b4bb",
      "name": "üì§ Send Excel1",
      "type": "n8n-nodes-base.telegram",
      "position": [
        4224,
        7648
      ],
      "webhookId": "944e581c-0095-4205-9487-8551328862ea",
      "typeVersion": 1.2,
      "credentials": {
        "telegramApi": {
          "id": "Pg9c5uHdiZaPWTEZ",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// Generate Excel file\nconst cfg = $('Config1').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst data = sd.lastResults || {};\nconst L = data.L || cfg.L || {};\nconst works = data.works || [];\n\n// Create CSV content (Excel-compatible)\nlet csv = '\\uFEFF'; // BOM for UTF-8\ncsv += `${L.doc_title || 'ESTIMATE'} - ${data.description || 'Estimate'}\\n`;\ncsv += `${L.region || 'Region'} | ${new Date().toLocaleDateString()}\\n\\n`;\n\n// Headers\ncsv += `${L.col_pos || 'Pos'};${L.col_code || 'Code'};${L.col_desc || 'Description'};${L.col_unit || 'Unit'};${L.col_qty || 'Qty'};${L.col_price || 'Price'};${L.col_total || 'Total'}\\n`;\n\n// Data rows\nworks.forEach((w, i) => {\n  const name = (w.rate_name || w.name || '').replace(/;/g, ',').replace(/\\n/g, ' ');\n  csv += `${i+1};${w.rate_code || ''};\"${name}\";${w.rate_unit || w.unit || ''};${(w.qty || 0).toFixed(2)};${(w.uc || 0).toFixed(2)};${(w.tc || 0).toFixed(2)}\\n`;\n  \n  // Resources\n  (w.resources || []).forEach(r => {\n    const resName = (r.resource_name || '').replace(/;/g, ',').replace(/\\n/g, ' ');\n    csv += `;${r.resource_code || ''};\"  ${resName}\";${r.resource_unit || ''};${(r.scaled_quantity || 0).toFixed(3)};${(r.resource_price || 0).toFixed(2)};${(r.scaled_cost || 0).toFixed(2)}\\n`;\n  });\n});\n\n// Totals\ncsv += `\\n;;;;;${L.total || 'TOTAL'};${(data.total || 0).toFixed(2)}\\n`;\ncsv += `;;;;;${L.workers || 'Labor'};${(data.workers_sum || 0).toFixed(2)}\\n`;\ncsv += `;;;;;${L.materials || 'Materials'};${(data.materials_sum || 0).toFixed(2)}\\n`;\ncsv += `;;;;;${L.machines || 'Equipment'};${(data.machines_sum || 0).toFixed(2)}\\n`;\n\nconst filename = `Estimate_${(L.region || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().substring(0, 10)}.csv`;\n\nreturn { json: { chatId: cid, L, bot_token: cfg.bot_token, filename }, binary: { excel: { data: Buffer.from(csv, 'utf-8').toString('base64'), mimeType: 'text/csv', fileName: filename } } };"
      },
      "id": "a906ee6b-394e-4f1d-85be-bc9a8cbf556d",
      "name": "Generate Excel1",
      "type": "n8n-nodes-base.code",
      "position": [
        4032,
        7648
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $json.chatId }}",
        "binaryData": true,
        "binaryPropertyName": "html",
        "additionalFields": {
          "caption": "üìä Professional HTML Report",
          "fileName": "={{ $json.filename }}"
        }
      },
      "id": "ca0e1e1f-0167-4a89-b6b7-e69a59f0666b",
      "name": "üì§ Send HTML1",
      "type": "n8n-nodes-base.telegram",
      "position": [
        6800,
        7424
      ],
      "webhookId": "2d59d493-4108-40d3-b74e-77fd2b869592",
      "typeVersion": 1.2,
      "credentials": {
        "telegramApi": {
          "id": "Pg9c5uHdiZaPWTEZ",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst d = $input.first().json;\nconst html = d.html_content || '';\nconst L = d.L || {};\nconst now = new Date();\nconst ts = now.toISOString().replace(/[:.]/g, '-').substring(0, 16);\nconst filename = `Estimate_${(L.region || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}_${ts}.html`;\n\nreturn { json: { chatId: d.chatId, bot_token: d.bot_token, filename }, binary: { html: { data: Buffer.from(html, 'utf-8').toString('base64'), mimeType: 'text/html', fileName: filename } } };"
      },
      "id": "4e79dac0-dc73-4089-ad0a-eb1e38143bab",
      "name": "Prep HTML File1",
      "type": "n8n-nodes-base.code",
      "position": [
        6576,
        7424
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"text\": {{ JSON.stringify($json.msg) }}, \"parse_mode\": \"Markdown\", \"reply_markup\": {\"inline_keyboard\": [[{\"text\": \"{{ $json.L.resources || 'Resources' }}\", \"callback_data\": \"view_details\"}], [{\"text\": \"{{ $json.L.btn_export_excel || 'Excel' }}\", \"callback_data\": \"export_excel\"}, {\"text\": \"{{ $json.L.btn_export_pdf || 'PDF' }}\", \"callback_data\": \"export_pdf\"}], [{\"text\": \"{{ $json.L.btn_restart || 'New' }}\", \"callback_data\": \"restart\"}]]}}",
        "options": {}
      },
      "id": "b6e09afc-cc36-46a6-83ba-870f90220ca3",
      "name": "üì§ Final1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        6576,
        7280
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Final message (ultra-compact for Telegram 4096 limit)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst d = $('Generate HTML1').first().json;\nconst cid = d.chatId;\nconst sd = $getWorkflowStaticData('global');\nconst L = d.L || {};\n\nif (sd.res?.[cid]) delete sd.res[cid];\nif (sd.sess?.[cid]) sd.sess[cid].state = 'done';\n\nfunction fmt(v) { \n  try { return new Intl.NumberFormat(L.loc || 'en', { maximumFractionDigits: 0 }).format(v || 0); } \n  catch(e) { return String(Math.round(v || 0)); } \n}\n\nfunction fmtCur(v) { \n  const sym = L.sym || '$';\n  const num = Math.round(v || 0);\n  return sym + ' ' + fmt(num);\n}\n\nfunction esc(s) {\n  // Remove ALL markdown special chars to avoid Telegram parse errors\n  return String(s || '').replace(/[_*`\\[\\]()~>#+\\-=|{}.!\\\\]/g, '');\n}\n\nfunction shortName(str, len) {\n  str = esc(str);\n  if (str.length > len) return str.substring(0, len - 1) + '‚Ä¶';\n  return str;\n}\n\nconst works = d.works || [];\nconst total = d.total || 0;\nconst now = new Date();\nconst dateStr = now.toLocaleDateString(L.loc || 'en', { day: '2-digit', month: '2-digit', year: 'numeric' });\n\n// Build compact message\nlet lines = [];\n\n// Header\nlines.push('*' + esc(L.doc_title || 'COST ESTIMATE') + '*');\nlines.push(dateStr + ' ¬∑ ' + esc(L.region || ''));\nlines.push(works.length + ' ' + esc(L.items || 'items'));\nlines.push('');\n\n// Works list - super compact\nconst MAX_ITEMS_SHOWN = 30;\nconst showWorks = works.slice(0, MAX_ITEMS_SHOWN);\n\nshowWorks.forEach((w, i) => {\n  const name = shortName(w.rate_name || w.name || '', 20);\n  lines.push((i+1) + '. ' + name + ' ' + fmtCur(w.tc));\n});\n\nif (works.length > MAX_ITEMS_SHOWN) {\n  lines.push('... +' + (works.length - MAX_ITEMS_SHOWN) + ' ' + esc(L.more_resources || 'more'));\n}\n\n// Total\nlines.push('');\nlines.push('*' + esc(L.total || 'TOTAL') + ': ' + fmtCur(total) + '*');\nlines.push('');\n\n// Breakdown (one line)\nconst parts = [];\nif (d.workers_sum > 0) parts.push(fmtCur(d.workers_sum));\nif (d.materials_sum > 0) parts.push(fmtCur(d.materials_sum));\nif (d.machines_sum > 0) parts.push(fmtCur(d.machines_sum));\nif (parts.length > 0) lines.push(parts.join(' ¬∑ '));\n\n// Hours\nif (d.labor_hours_sum > 0) {\n  const days = Math.ceil(d.labor_hours_sum / 8);\n  lines.push(fmt(d.labor_hours_sum) + 'h ¬∑ ' + days + ' ' + esc(L.days || 'd'));\n}\n\n// Build message\nlet msg = lines.join('\\n');\n\n// Hard truncate at 3800 chars to be safe\nif (msg.length > 3800) {\n  msg = msg.substring(0, 3700);\n  msg += '\\n\\n...\\n*' + esc(L.total || 'TOTAL') + ': ' + fmtCur(total) + '*';\n}\n\nconsole.log('Final msg length:', msg.length);\n\nreturn { json: { ...d, msg } };"
      },
      "id": "5fef33ee-7191-4a16-8640-76a7a500c89c",
      "name": "Final1",
      "type": "n8n-nodes-base.code",
      "position": [
        6368,
        7424
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Generate HTML Report with expandable resources\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst d = $('Agg1').first().json;\nconst L = d.L || {};\nconst cur = L.cur || 'USD'; \nconst loc = L.loc || 'en'; \nconst sym = L.sym || '$';\nconst works = d.works || []; \nconst total = d.total || 0;\n\nfunction fmt(v) { \n  try { \n    return new Intl.NumberFormat(loc, { style: 'currency', currency: cur, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(v || 0); \n  } catch(e) { \n    return sym + ' ' + (v || 0).toFixed(2); \n  } \n}\nfunction fmtNum(v, dec) { \n  return new Intl.NumberFormat(loc, { minimumFractionDigits: dec || 2, maximumFractionDigits: dec || 2 }).format(v || 0); \n}\nfunction esc(t) { \n  return String(t || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); \n}\n\nconst now = new Date();\nconst dateStr = now.toLocaleDateString(loc, { day: '2-digit', month: '2-digit', year: 'numeric' });\nconst timeStr = now.toLocaleTimeString(loc, { hour: '2-digit', minute: '2-digit' });\n\nconst laborPct = total > 0 ? Math.round(d.workers_sum / total * 100) : 0;\nconst materialPct = total > 0 ? Math.round(d.materials_sum / total * 100) : 0;\nconst machinePct = total > 0 ? Math.round(d.machines_sum / total * 100) : 0;\nconst laborDays = Math.ceil((d.labor_hours_sum || 0) / 8);\n\nlet html = `<!DOCTYPE html>\n<html><head><meta charset=\"UTF-8\">\n<title>${esc(L.doc_title || 'Cost Estimate')} - ${esc(d.description || '')}</title>\n<style>\n:root{--primary:#007AFF;--text:#1D1D1F;--text2:#86868B;--text3:#AEAEB2;--bg:#FFF;--bg2:#F5F5F7;--bg3:#E8E8ED;--border:#D2D2D7;--labor:#E3F2FD;--labor-text:#1565C0;--material:#FFF3E0;--material-text:#E65100;--machine:#F3E5F5;--machine-text:#7B1FA2}\n*{box-sizing:border-box}\nbody{font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,sans-serif;margin:0;padding:16px;background:var(--bg2);color:var(--text);font-size:12px;line-height:1.4}\n.container{background:var(--bg);max-width:1200px;margin:0 auto;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.08);overflow:hidden}\n.header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}\n.header h1{margin:0;font-size:18px;font-weight:600}\n.header-info{font-size:11px;color:var(--text3)}\n.toolbar{padding:10px 20px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap}\n.btn{padding:6px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);cursor:pointer;font-size:11px}\n.btn:hover{background:var(--bg3)}\n.kpi{display:flex;gap:8px;padding:12px 20px;background:var(--bg2);flex-wrap:wrap}\n.kpi-card{background:var(--bg);border-radius:8px;padding:10px 14px;border:1px solid var(--border);min-width:100px}\n.kpi-value{font-size:16px;font-weight:600}\n.kpi-label{font-size:9px;color:var(--text3);text-transform:uppercase}\ntable{width:100%;border-collapse:collapse}\nth,td{padding:8px 10px;text-align:left;border-bottom:1px solid var(--border)}\nth{background:var(--bg2);font-weight:500;font-size:10px;text-transform:uppercase;color:var(--text2)}\n.work-row{cursor:pointer;transition:background 0.15s}\n.work-row:hover{background:var(--bg2)}\n.work-row td:first-child{font-weight:500}\n.toggle{width:20px;color:var(--text3);font-size:10px}\n.res-row{background:#FAFAFA;font-size:11px}\n.res-row.hidden{display:none}\n.scope-row{background:#F0FFF0;font-size:11px}\n.scope-row.hidden{display:none}\n.scope-row td{padding:6px 10px 6px 30px;border-bottom:1px dashed #D0E8D0}\n.scope-toggle{color:var(--primary);cursor:pointer;font-size:10px;margin-left:8px}\n.res-row td{padding:6px 10px 6px 30px;border-bottom:1px dashed var(--border)}\n.res-tag{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:500;margin-right:6px}\n.res-labor{background:var(--labor);color:var(--labor-text)}\n.res-material{background:var(--material);color:var(--material-text)}\n.res-machine{background:var(--machine);color:var(--machine-text)}\n.summary-row{background:linear-gradient(90deg,var(--bg2),var(--bg));font-size:10px}\n.summary-row.hidden{display:none}\n.summary-row td{padding:6px 10px 6px 30px;border-top:1px solid var(--border)}\n.dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px}\n.dot-high{background:#34C759}\n.dot-medium{background:#FF9500}\n.dot-low{background:#FF3B30}\n.dot-none{background:#8E8E93}\n.total-row{background:var(--bg2);font-weight:600}\n.total-row td{padding:12px 10px}\n.right{text-align:right}\n.footer{padding:16px 20px;text-align:center;font-size:10px;color:var(--text3);border-top:1px solid var(--border)}\n.footer a{color:var(--primary);text-decoration:none}\n@media(max-width:600px){\n  body{padding:8px;font-size:11px}\n  th,td{padding:6px}\n  .kpi-card{min-width:80px;padding:8px}\n  .kpi-value{font-size:14px}\n}\n</style>\n</head><body>\n<div class=\"container\">\n<div class=\"header\">\n  <h1>${esc(L.doc_title || 'Cost Estimate')}</h1>\n  <div class=\"header-info\">${dateStr} ${timeStr} ¬∑ ${esc(L.region || '')}</div>\n</div>\n<div class=\"toolbar\">\n  <button class=\"btn\" onclick=\"expandAll()\">${esc(L.expand_all || 'Expand All')}</button>\n  <button class=\"btn\" onclick=\"collapseAll()\">${esc(L.collapse_all || 'Collapse All')}</button>\n</div>\n<div class=\"kpi\">\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${fmt(total)}</div><div class=\"kpi-label\">${esc(L.kpi_total || 'Total')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${works.length}</div><div class=\"kpi-label\">${esc(L.kpi_items || 'Items')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${laborDays}d</div><div class=\"kpi-label\">${esc(L.kpi_days || 'Days')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${laborPct}%</div><div class=\"kpi-label\">${esc(L.workers || 'Labor')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${materialPct}%</div><div class=\"kpi-label\">${esc(L.materials || 'Materials')}</div></div>\n</div>\n<table>\n<tr>\n  <th style=\"width:30px\"></th>\n  <th>${esc(L.col_code || 'Code')}</th>\n  <th>${esc(L.col_desc || 'Description')}</th>\n  <th>${esc(L.col_unit || 'Unit')}</th>\n  <th class=\"right\">${esc(L.col_qty || 'Qty')}</th>\n  <th class=\"right\">${esc(L.col_price || 'Price')}</th>\n  <th class=\"right\">${esc(L.col_total || 'Total')}</th>\n  <th style=\"width:30px\"></th>\n</tr>`;\n\nworks.forEach((w, i) => {\n  console.log('Work ' + (i+1) + ': ' + (w.rate_name || w.name) + ' - Resources: ' + (w.resources || []).length);\n  const hasRes = (w.resources || []).length > 0;\n  const isFirst = i === 0;\n  const dotClass = w.ql === 'high' ? 'dot-high' : w.ql === 'medium' ? 'dot-medium' : w.ql === 'low' ? 'dot-low' : 'dot-none';\n  const code = w.rate_code && w.rate_code !== 'NOT_FOUND' ? w.rate_code : '‚Äî';\n  \n  const hasScope = (w.scope_of_work || []).length > 0;\n  const scopeBtn = hasScope ? '<span class=\"scope-toggle\" onclick=\"event.stopPropagation();toggleScope(' + i + ')\">üìã</span>' : '';\n  \n  html += `<tr class=\"work-row\" data-work=\"${i}\" onclick=\"toggleWork(${i})\">\n    <td class=\"toggle\"><span id=\"icon-${i}\">${isFirst ? '‚ñº' : '‚ñ∂'}</span></td>\n    <td style=\"font-size:10px;color:var(--text2)\">${esc(code)}</td>\n    <td><strong>${esc(w.rate_name || w.name)}</strong>${scopeBtn}</td>\n    <td>${esc(w.rate_unit || w.unit)}</td>\n    <td class=\"right\">${fmtNum(w.qty)}</td>\n    <td class=\"right\">${fmt(w.uc)}</td>\n    <td class=\"right\"><strong>${fmt(w.tc)}</strong></td>\n    <td><span class=\"dot ${dotClass}\" title=\"${w.llm_match || ''}\"></span>${w.llm_score ? '<span style=\"font-size:9px;color:var(--text3);margin-left:2px\">' + w.llm_score + '</span>' : ''}</td>\n  </tr>`;\n  \n  // Scope of work rows\n  const scopeItems = w.scope_of_work || [];\n  if (scopeItems.length > 0) {\n    html += `<tr class=\"scope-row hidden\" data-scope=\"${i}\">\n      <td></td>\n      <td colspan=\"6\" style=\"background:#F8FFF8\">\n        <strong style=\"color:#2E7D32\">üìã ${esc(L.scope_title || 'Scope of Work')}:</strong><br>\n        ${scopeItems.map((s, si) => '<span style=\"color:#555\">‚Ä¢ ' + esc(s) + '</span>').join('<br>')}\n      </td>\n      <td></td>\n    </tr>`;\n  }\n  \n  // Resources\n  const resources = w.resources || [];\n  resources.forEach((r, ri) => {\n    const tagClass = r.resource_type === 'labor' ? 'res-labor' : r.resource_type === 'machine' ? 'res-machine' : 'res-material';\n    const tagLabel = r.resource_type === 'labor' ? (L.res_labor || 'Labor') : r.resource_type === 'machine' ? (L.res_machine || 'Equip') : (L.res_material || 'Mat');\n    const hiddenClass = isFirst ? '' : 'hidden';\n    const resQty = r.scaled_quantity || r.resource_quantity || 0;\n    const resPrice = r.resource_price || 0;\n    const resCost = r.scaled_cost || 0;\n    const norm = r.resource_quantity || r.norma || 0;\n    const pct = w.tc > 0 ? Math.round(resCost / w.tc * 100) : 0;\n    \n    html += `<tr class=\"res-row ${hiddenClass}\" data-work=\"${i}\">\n      <td></td>\n      <td><span style=\"font-size:9px;color:var(--text3)\">${esc(r.resource_code || '')}</span></td>\n      <td>\n        <span class=\"res-tag ${tagClass}\">${esc(tagLabel)}</span>\n        ${esc(r.resource_name || '')}\n        ${norm ? '<span style=\"color:var(--text3);font-size:9px;margin-left:4px\">√ó' + fmtNum(norm, 4) + '</span>' : ''}\n      </td>\n      <td style=\"font-size:10px\">${esc(r.resource_unit || '')}</td>\n      <td class=\"right\" style=\"font-size:10px\">${fmtNum(resQty, 3)}</td>\n      <td class=\"right\" style=\"font-size:10px\">${fmt(resPrice)}</td>\n      <td class=\"right\">${fmt(resCost)} <span style=\"font-size:9px;color:var(--text3)\">${pct}%</span></td>\n      <td></td>\n    </tr>`;\n  });\n  \n  // Summary row for work\n  if (resources.length > 0) {\n    const laborSum = resources.filter(r => r.resource_type === 'labor').reduce((s, r) => s + (r.scaled_cost || 0), 0);\n    const matSum = resources.filter(r => r.resource_type === 'material').reduce((s, r) => s + (r.scaled_cost || 0), 0);\n    const machSum = resources.filter(r => r.resource_type === 'machine').reduce((s, r) => s + (r.scaled_cost || 0), 0);\n    const hiddenClass = isFirst ? '' : 'hidden';\n    \n    html += `<tr class=\"summary-row ${hiddenClass}\" data-work=\"${i}\">\n      <td colspan=\"2\"></td>\n      <td colspan=\"4\">\n        <span style=\"color:var(--labor-text)\">${L.workers || 'Labor'}: ${fmt(laborSum)}</span> ¬∑ \n        <span style=\"color:var(--material-text)\">${L.materials || 'Mat'}: ${fmt(matSum)}</span> ¬∑ \n        <span style=\"color:var(--machine-text)\">${L.machines || 'Equip'}: ${fmt(machSum)}</span>\n      </td>\n      <td class=\"right\"><strong>${fmt(w.tc)}</strong></td>\n      <td></td>\n    </tr>`;\n  }\n});\n\nhtml += `<tr class=\"total-row\">\n  <td colspan=\"6\" style=\"text-align:right\">${esc(L.grand_total || 'TOTAL')}</td>\n  <td class=\"right\">${fmt(total)}</td>\n  <td></td>\n</tr>\n</table>\n<div class=\"footer\">\n  <a href=\"https://DataDrivenConstruction.io\" target=\"_blank\">DDC CWICR</a> ¬∑ \n  Open Source Construction Cost Database ¬∑ ${dateStr}\n</div>\n</div>\n<script>\nfunction toggleWork(idx) {\n  const icon = document.getElementById('icon-' + idx);\n  const rows = document.querySelectorAll('tr[data-work=\"' + idx + '\"]:not(.work-row)');\n  const isHidden = rows.length > 0 && rows[0].classList.contains('hidden');\n  rows.forEach(r => r.classList.toggle('hidden', !isHidden));\n  if (icon) icon.textContent = isHidden ? '‚ñº' : '‚ñ∂';\n}\nfunction expandAll() {\n  document.querySelectorAll('tr[data-work]').forEach(r => r.classList.remove('hidden'));\n  document.querySelectorAll('[id^=\"icon-\"]').forEach(i => i.textContent = '‚ñº');\n}\nfunction collapseAll() {\n  document.querySelectorAll('tr.res-row, tr.summary-row, tr.scope-row').forEach(r => r.classList.add('hidden'));\n  document.querySelectorAll('[id^=\"icon-\"]').forEach(i => i.textContent = '‚ñ∂');\n}\nfunction toggleScope(idx) {\n  const rows = document.querySelectorAll('tr.scope-row[data-scope=\"' + idx + '\"]');\n  rows.forEach(r => r.classList.toggle('hidden'));\n}\n</script>\n</body></html>`;\n\nconst sd = $getWorkflowStaticData('global');\nsd.html_report = html;\n\nreturn { json: { ...d, html_content: html } };"
      },
      "id": "69dce140-aaef-4dd4-9749-df93cef638c9",
      "name": "Generate HTML1",
      "type": "n8n-nodes-base.code",
      "position": [
        6208,
        7424
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/answerCallbackQuery",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"callback_query_id\": \"{{ $('Config1').item.json.callbackQueryId }}\",\n  \"text\": \"{{ $('Config1').item.json.L.loading }}\",\n  \"show_alert\": false\n}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "f46bb4a7-be39-4a87-8dd5-2fbf4a76eb09",
      "name": "Answer Calc CB1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        4032,
        7184
      ],
      "typeVersion": 4.2,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify($json.msg) }},\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": { \"inline_keyboard\": {{ JSON.stringify($json.keyboard) }} }\n}",
        "options": {}
      },
      "id": "dab28247-872b-4167-ba7b-906218c53db8",
      "name": "üì§ Works Updated1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        3824,
        6832
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// WORKS UPDATED - Show updated works list after quantity change\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config1').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst works = session.works || [];\nconst L = cfg.L || session.L || {};\n\nconsole.log('=== WORKS UPDATED ===');\nconsole.log('Works:', works.length);\nconsole.log('L.native:', L.native);\n\nlet msg = '‚úÖ ' + (L.work_added || '–û–±–Ω–æ–≤–ª–µ–Ω–æ') + '\\n\\n';\nmsg += '*' + works.length + ' ' + (L.items || '–ø–æ–∑–∏—Ü–∏–π') + '*\\n\\n';\n\nfor (let i = 0; i < works.length; i++) {\n  const w = works[i];\n  const name = w.name.length > 25 ? w.name.substring(0, 22) + '...' : w.name;\n  msg += (i + 1) + '. ' + name + ' ‚Äî ' + w.qty + ' ' + (w.unit || 'm¬≤') + '\\n';\n}\n\n// No limit\n\nconst keyboard = [];\nconst maxBtns = works.length;\nfor (let i = 0; i < maxBtns; i += 5) {\n  const row = [];\n  for (let j = 0; j < 5 && i + j < maxBtns; j++) {\n    row.push({ text: '‚úèÔ∏è' + (i + j + 1), callback_data: 'edit_work_' + (i + j) });\n  }\n  keyboard.push(row);\n}\n\nkeyboard.push([\n  { text: L.btn_add_work || '+ –ü–æ–∑–∏—Ü–∏—è', callback_data: 'add_work' },\n  { text: L.btn_calc || '‚ñ∂ –†–∞—Å—á—ë—Ç', callback_data: 'calculate' }\n]);\nkeyboard.push([{ text: L.btn_new || 'üîÑ –ó–∞–Ω–æ–≤–æ', callback_data: 'restart' }]);\n\nreturn { json: { ...cfg, msg, keyboard } };"
      },
      "id": "d30c4f2d-42ac-4ba9-a7c1-4580d7ecbbf3",
      "name": "Works Updated1",
      "type": "n8n-nodes-base.code",
      "position": [
        3680,
        6832
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('Config1').item.json.chatId }},\n  \"text\": {{ JSON.stringify($('Config1').item.json.L.enter_work) }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "ca8b2ea7-498d-4018-a9c4-3be5e20144ce",
      "name": "üì§ Ask New Work1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        3680,
        6080
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// EDIT MENU - Show edit buttons for selected work item\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config1').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst works = session.works || [];\nconst L = cfg.L || session.L || {};\n\nconst idx = session.editingWorkIndex || cfg.editingWorkIndex || 0;\nconst work = works[idx];\n\nconsole.log('=== EDIT MENU ===');\nconsole.log('Editing work index:', idx);\nconsole.log('Work:', work?.name);\n\nif (!work) {\n  return { json: { ...cfg, _skip: true } };\n}\n\nconst name = work.name.length > 30 ? work.name.substring(0, 27) + '...' : work.name;\nlet msg = '‚úèÔ∏è *' + (L.btn_edit || '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ') + '*\\n\\n';\nmsg += '*' + (idx + 1) + '. ' + name + '*\\n';\nmsg += 'üìè ' + work.qty + ' ' + (work.unit || 'm¬≤') + '\\n\\n';\nmsg += (L.edit_hint || '–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:');\n\n// Quantity edit buttons\nconst keyboard = [\n  [\n    { text: '-10', callback_data: 'qty_work_' + idx + '_minus10' },\n    { text: '-1', callback_data: 'qty_work_' + idx + '_minus1' },\n    { text: '+1', callback_data: 'qty_work_' + idx + '_plus1' },\n    { text: '+10', callback_data: 'qty_work_' + idx + '_plus10' }\n  ],\n  [\n    { text: '√∑2', callback_data: 'qty_work_' + idx + '_half' },\n    { text: '√ó2', callback_data: 'qty_work_' + idx + '_double' }\n  ],\n  [\n    { text: 'üóë ' + (L.btn_delete || '–£–¥–∞–ª–∏—Ç—å'), callback_data: 'delete_work_' + idx }\n  ],\n  [\n    { text: '‚óÄÔ∏è ' + (L.btn_done || '–ù–∞–∑–∞–¥'), callback_data: 'done_editing' }\n  ]\n];\n\nreturn { json: { ...cfg, msg, keyboard, chatId: cid } };"
      },
      "id": "8bb93e3a-b846-48d8-8390-5c862f9aa7fd",
      "name": "Edit Menu1",
      "type": "n8n-nodes-base.code",
      "position": [
        3680,
        6688
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json._body) }}",
        "options": {}
      },
      "id": "ea9a2b55-4623-4385-9f9b-6f89abb7a048",
      "name": "üì§ Lang OK1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        3984,
        5920
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/answerCallbackQuery",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"callback_query_id\": \"{{ $('Config1').item.json.callbackQueryId }}\"\n}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "4b4a5abc-0ce3-4126-b41b-7c8ad7750f0e",
      "name": "Answer Lang CB1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        3680,
        5920
      ],
      "typeVersion": 4.2,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": \"*DDC CWICR Cost Estimator*\\nhttps://DataDrivenConstruction.io\\n\\n‚ñ∏ Photo analysis (up to 4)\\n‚ñ∏ Text description\\n‚ñ∏ 9 languages ¬∑ 55,000+ work items\\n‚ñ∏ Excel & PDF export\\n\\nSelect language:\",\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [\n      [{\"text\": \"üá©üá™ Deutsch\", \"callback_data\": \"lang_DE\"}, {\"text\": \"üá¨üáß English\", \"callback_data\": \"lang_EN\"}, {\"text\": \"üá∑üá∫ –†—É—Å—Å–∫–∏–π\", \"callback_data\": \"lang_RU\"}],\n      [{\"text\": \"üá™üá∏ Espa√±ol\", \"callback_data\": \"lang_ES\"}, {\"text\": \"üá´üá∑ Fran√ßais\", \"callback_data\": \"lang_FR\"}, {\"text\": \"üáßüá∑ Portugu√™s\", \"callback_data\": \"lang_PT\"}],\n      [{\"text\": \"üá®üá≥ ‰∏≠Êñá\", \"callback_data\": \"lang_ZH\"}, {\"text\": \"üá¶üá™ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©\", \"callback_data\": \"lang_AR\"}, {\"text\": \"üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä\", \"callback_data\": \"lang_HI\"}],\n      [{\"text\": \"‚ùì Help\", \"callback_data\": \"show_help\"}]\n    ]\n  }\n}",
        "options": {}
      },
      "id": "a8b6693e-48c2-4a85-8f2a-2146f92ce300",
      "name": "üì§ Lang Menu1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        3680,
        5776
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "a3c7266e-9deb-4abe-a856-0e835757cdc8",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_lang"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "LANG"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "abc9388b-156f-4a27-8b6b-16d0e18e9749",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "lang_selected"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "LANG_OK"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "320b81af-ef5e-4776-814d-3aead2e0a38a",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "works_updated"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "WORKS_UPD"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "def6b912-0ac9-4066-b421-59fd67b596c8",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_edit_menu"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "EDIT_MENU"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "4ca5650d-0486-456a-b17c-34ec088923d1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "ask_new_work"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "ADD_WORK"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "8f7bceab-ef7c-43b4-8afa-a8c309a74645",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "start_calc"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "CALC"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "e1037d8b-0e5f-46c3-a008-ad16d97689c2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "export_excel"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "EXCEL"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "6fff52ee-58d7-4073-b42d-cb15298d5788",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "export_pdf"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "PDF"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "fdf49046-6eaf-4183-8ff8-209eff4fefc4",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_help"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "HELP"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "6b143832-1fbb-40ee-9465-ff85f59b0328",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "view_details"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "DETAILS"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "244cd331-efdc-4e0e-b267-f51d8a6c6f3d",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "analyze_text"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "ANALYZE_TEXT"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "4693d071-2b17-42c7-ad4a-ad7219d9b57b",
      "name": "Route1",
      "type": "n8n-nodes-base.switch",
      "position": [
        3408,
        6480
      ],
      "typeVersion": 3.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// CONFIG v8.5 PRO - Professional style localization + PDF SUPPORT\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst input = $input.first().json;\nconst lang = (input.lang || 'EN').toUpperCase();\nconst chatId = String(input.chatId);\nconst sd = $getWorkflowStaticData('global');\n\nconst LANGS = {\n  'DE': { \n    fallback_start: 'Dr√ºcken Sie /start um zu beginnen', \n    rooms: 'R√§ume', works_identified: 'Positionen', general: 'Allgemein', no_works: 'Keine Arbeiten', items: 'Positionen', min: 'Min', \n    db: 'DE_BERLIN_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'German', flag: 'üá©üá™', native: 'Deutsch', cur: 'EUR', sym: '‚Ç¨', loc: 'de-DE', region: 'Berlin', search_lang: 'German',\n    // Professional welcome with PDF support\n    ok: '‚úÖ *Deutsch* ¬∑ Berlin ¬∑ EUR',\n    text_prompt: `*Beschreiben Sie die Arbeiten:*\\n\\n_Beispiel:_\\n\\`\\`\\`\\nGipskarton 2-lagig 25m2\\nFliesen Bad 15m2\\nMalerarbeiten 120m2\\n\\`\\`\\``,\n    photo: `*Foto, PDF oder Beschreibung senden*\n\nüìÑ *PDF-Zeichnungen* ‚Äî Grundriss oder Bauplan (max. 3 Seiten)\nüì∑ *Foto* ‚Äî Raum oder Objekt fotografieren\n‚úèÔ∏è *Text* ‚Äî Arbeiten als Liste beschreiben\n\n_Beispiel zum Kopieren:_\n\\`\\`\\`\nGipskarton 2-lagig Metallprofil CW75 25m2\nFliesen Feinsteinzeug 60x60 Bad 15m2\nSpachteln Q3 Decken und Waende 120m2\nElektro Steckdosen UP 20 Stueck\n\\`\\`\\`\n\nOder Foto/PDF senden üì∑üìÑ`,\n    // PDF specific\n    pdf_received: 'üìÑ *PDF erhalten*',\n    pdf_processing: '‚è≥ Analysiere Zeichnung...',\n    pdf_pages: 'Seiten',\n    pdf_page_limit: '‚ö†Ô∏è Nur erste 3 Seiten werden verarbeitet',\n    pdf_rooms_found: 'üè† R√§ume gefunden',\n    pdf_elements_found: 'üß± Elemente gefunden',\n    pdf_works_generated: 'üìù Arbeiten generiert',\n    pdf_analyzing_page: 'üîç Analysiere Seite',\n    pdf_of: 'von',\n    pdf_complete: '‚úÖ Analyse abgeschlossen',\n    pdf_error: '‚ùå PDF-Verarbeitungsfehler',\n    // Rest of translations\n    photo_added: '‚úÖ Foto hinzugef√ºgt',\n    photos_count: 'Fotos',\n    add_more: '+ Weitere Fotos',\n    analyze_now: '‚ñ∂ Analyse starten',\n    analyzing: 'Bildanalyse l√§uft...',\n    found: '*Erkannte Leistungen:*',\n    edit_hint: 'Zur Bearbeitung antippen',\n    calc: 'Preisermittlung',\n    ready: '*KOSTENVORANSCHLAG*',\n    total: 'GESAMT',\n    days: 'Tage',\n    pct: 'Trefferquote',\n    workers: 'Lohn',\n    machines: 'Ger√§te',\n    materials: 'Material',\n    subtotal: 'Zusammenfassung',\n    searching: 'Suche',\n    of: 'von',\n    not_found: 'Keine √úbereinstimmung',\n    low_conf: 'Pr√ºfung empfohlen',\n    price_note: 'Preisbasis: Berlin 2025',\n    btn_calc: '‚ñ∂ Berechnen',\n    btn_new: '+ Neues Projekt',\n    btn_lang: '‚öô Sprache',\n    btn_edit: '‚úé √Ñndern',\n    btn_delete: '‚úï Entfernen',\n    btn_add_work: '+ Position',\n    btn_done: '‚úÖ Fertig',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª Neu starten',\n    btn_help: '? Hilfe',\n    loading: 'Preisermittlung l√§uft...',\n    more_in_html: 'Detaillierter Bericht verf√ºgbar',\n    resources: 'Details: Ressourcen & Leistungsumfang',\n    enter_work: '*Neue Position hinzuf√ºgen*\\nFormat: Bezeichnung, Menge Einheit\\nBeispiel: Gipskartonwand, 15 m¬≤',\n    work_added: '‚úÖ Position hinzugef√ºgt',\n    what_next: '*Weitere Optionen:*',\n    categories: 'Kategorien',\n    cat_demolition: 'Abbruch',\n    cat_rough: 'Rohbau',\n    cat_finishing: 'Ausbau',\n    cat_mep: 'TGA',\n    help_title: '*Benutzerhandbuch*',\n    help_text: `*Benutzerhandbuch*\n\n*1. Dokumentation*\nSenden Sie Fotos, PDF-Pl√§ne oder Beschreibung.\nPDF: max. 3 Seiten werden analysiert.\n\n*2. Pr√ºfung*\n√úberpr√ºfen Sie die erkannten Leistungen.\n\n*3. Kalkulation*\nPreisermittlung aus DDC CWICR Datenbank.\n\n*4. Export*\nErgebnisse als Excel oder PDF.\n\n*Befehle:*\n/start ‚Äî Neues Projekt\n/help ‚Äî Diese Hilfe`,\n    doc_title: 'KOSTENVORANSCHLAG',\n    col_pos: 'Pos', col_code: 'Kennziffer', col_desc: 'Bezeichnung', col_unit: 'Einh.', col_qty: 'Menge', col_price: 'EP', col_total: 'GP', col_labor: 'Std', col_quality: 'Q',\n    grand_total: 'GESAMTSUMME', labor_cost: 'Lohnkosten', material_cost: 'Materialkosten', labor_days: 'Arbeitstage',\n    kpi_total: 'Gesamtkosten', kpi_hours: 'Arbeitsstunden', kpi_days: 'Arbeitstage',\n    chart_cost_structure: 'Kostenstruktur', chart_labor: 'Lohn', chart_material: 'Material', chart_machines: 'Ger√§te',\n    res_labor: 'Lohn', res_material: 'Mat', res_machine: 'Ger',\n    collapse_all: 'Alle einklappen', expand_all: 'Alle ausklappen',\n    quality_high: 'Hohe √úbereinstimmung', quality_medium: 'Mittlere √úbereinstimmung', quality_low: 'Geringe √úbereinstimmung',\n    export_excel_msg: 'Excel-Export (CSV)', export_pdf_msg: 'PDF-Export', btn_refine: 'Genauer analysieren', found_pct: 'gefunden', more_resources: 'weitere', kpi_items: 'Positionen', scope_title: 'Leistungsumfang', show_scope: 'Leistungen anzeigen'\n  },\n\n  'EN': { \n    fallback_start: 'Use /start to begin', \n    rooms: '–∫–æ–º–Ω–∞—Ç', works_identified: 'works', general: '–û–±—â–µ–µ', no_works: '–†–∞–±–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', items: '–ø–æ–∑–∏—Ü–∏–π', min: '–º–∏–Ω', \n    db: 'ENG_TORONTO_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'English', flag: 'üá¨üáß', native: 'English', cur: 'CAD', sym: '$', loc: 'en-CA', region: 'Toronto', search_lang: 'English',\n    ok: '‚úÖ *English* ¬∑ Toronto ¬∑ CAD',\n    text_prompt: `*Describe the works:*\\n\\n_Example:_\\n\\`\\`\\`\\nDrywall 2-layer 25m2\\nFloor tiles bathroom 15m2\\nPainting walls 120m2\\n\\`\\`\\``,\n    photo: `*Send photo, PDF or description*\n\nüìÑ *PDF drawings* ‚Äî floor plan or blueprint (max 3 pages)\nüì∑ *Photo* ‚Äî photograph room or object\n‚úèÔ∏è *Text* ‚Äî describe work as a list\n\n_Example to copy:_\n\\`\\`\\`\nDrywall 2-layer metal stud CW75 25m2\nPorcelain tiles 60x60 bathroom 15m2\nPlastering level 3 ceiling walls 120m2\nElectrical outlets flush mount 20 pcs\n\\`\\`\\`\n\nOr send photo/PDF üì∑üìÑ`,\n    // PDF specific\n    pdf_received: 'üìÑ *PDF received*',\n    pdf_processing: '‚è≥ Analyzing drawing...',\n    pdf_pages: 'pages',\n    pdf_page_limit: '‚ö†Ô∏è Processing first 3 pages only',\n    pdf_rooms_found: 'üè† Rooms found',\n    pdf_elements_found: 'üß± Elements found',\n    pdf_works_generated: 'üìù Works generated',\n    pdf_analyzing_page: 'üîç Analyzing page',\n    pdf_of: 'of',\n    pdf_complete: '‚úÖ Analysis complete',\n    pdf_error: '‚ùå PDF processing error',\n    // Rest\n    photo_added: '‚úÖ Photo added',\n    photos_count: 'photos',\n    add_more: '+ Add more',\n    analyze_now: '‚ñ∂ Start analysis',\n    analyzing: 'Analyzing images...',\n    found: '*Identified Work Items:*',\n    edit_hint: 'Tap to edit',\n    calc: 'Pricing lookup',\n    ready: '*COST ESTIMATE*',\n    total: 'TOTAL',\n    days: 'days',\n    pct: 'Match rate',\n    workers: 'Labor',\n    machines: 'Equipment',\n    materials: 'Materials',\n    subtotal: 'Summary',\n    searching: 'Searching',\n    of: 'of',\n    not_found: 'No match found',\n    low_conf: 'Review recommended',\n    price_note: 'Price basis: Toronto 2025',\n    btn_calc: '‚ñ∂ Calculate',\n    btn_new: '+ New Project',\n    btn_lang: '‚öô Language',\n    btn_edit: '‚úé Edit',\n    btn_delete: '‚úï Remove',\n    btn_add_work: '+ Add Item',\n    btn_done: '‚úÖ Done',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª Start Over',\n    btn_help: '? Help',\n    loading: 'Calculating prices...',\n    more_in_html: 'Detailed report available',\n    resources: 'Details: Resources & Scope of Work',\n    enter_work: '*Add New Item*\\nFormat: Description, Quantity Unit\\nExample: Drywall installation, 15 m¬≤',\n    work_added: '‚úÖ Item added',\n    what_next: '*Options:*',\n    categories: 'Categories',\n    cat_demolition: 'Demolition',\n    cat_rough: 'Structure',\n    cat_finishing: 'Finishes',\n    cat_mep: 'MEP',\n    help_title: '*User Guide*',\n    help_text: `*User Guide*\n\n*1. Documentation*\nSend photos, PDF plans or description.\nPDF: max 3 pages will be analyzed.\n\n*2. Review*\nCheck identified work items.\n\n*3. –†–∞—Å—á—ë—Ç*\nPricing from DDC CWICR database.\n\n*4. Export*\nExport as Excel or PDF.\n\n*Commands:*\n/start ‚Äî New project\n/help ‚Äî This guide`,\n    doc_title: 'COST ESTIMATE',\n    col_pos: 'No', col_code: 'Code', col_desc: 'Description', col_unit: 'Unit', col_qty: 'Qty', col_price: 'Rate', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'GRAND TOTAL', labor_cost: 'Labor Cost', material_cost: 'Material Cost', labor_days: 'Work Days',\n    kpi_total: 'Total Cost', kpi_hours: 'Work Hours', kpi_days: 'Work Days',\n    chart_cost_structure: 'Cost Structure', chart_labor: 'Labor', chart_material: 'Material', chart_machines: 'Equipment',\n    res_labor: 'Labor', res_material: 'Mat', res_machine: 'Equip',\n    collapse_all: 'Collapse all', expand_all: 'Expand all',\n    quality_high: 'High confidence', quality_medium: 'Medium confidence', quality_low: 'Low confidence',\n    export_excel_msg: 'Excel Export (CSV)', export_pdf_msg: 'PDF Export', btn_refine: 'Refine Analysis', found_pct: 'found', more_resources: 'more', kpi_items: 'Items', scope_title: 'Scope of Work', show_scope: 'Show scope'\n  },\n\n  'RU': { \n    fallback_start: '–ù–∞–∂–º–∏—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞', \n    rooms: '–∫–æ–º–Ω–∞—Ç', works_identified: '–ø–æ–∑–∏—Ü–∏–π', general: '–û–±—â–µ–µ', no_works: '–†–∞–±–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', items: '–ø–æ–∑–∏—Ü–∏–π', min: '–º–∏–Ω', \n    db: 'RU_STPETERSBURG_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Russian', flag: 'üá∑üá∫', native: '–†—É—Å—Å–∫–∏–π', cur: 'RUB', sym: '‚ÇΩ', loc: 'ru-RU', region: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', search_lang: 'Russian',\n    ok: '‚úÖ *–†—É—Å—Å–∫–∏–π* ¬∑ –°–ü–± ¬∑ RUB',\n    text_prompt: `*–û–ø–∏—à–∏—Ç–µ —Ä–∞–±–æ—Ç—ã:*\\n\\n_–ü—Ä–∏–º–µ—Ä:_\\n\\`\\`\\`\\n–ì–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω 2 —Å–ª–æ—è 25–º2\\n–ü–ª–∏—Ç–∫–∞ –≤–∞–Ω–Ω–∞—è 15–º2\\n–ü–æ–∫—Ä–∞—Å–∫–∞ —Å—Ç–µ–Ω 120–º2\\n\\`\\`\\``,\n    photo: `*–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ, PDF –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ*\n\nüìÑ *PDF —á–µ—Ä—Ç–µ–∂–∏* ‚Äî –ø–ª–∞–Ω —ç—Ç–∞–∂–∞ –∏–ª–∏ —á–µ—Ä—Ç—ë–∂ (–¥–æ 3 —Å—Ç—Ä.)\nüì∑ *–§–æ—Ç–æ* ‚Äî —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –ø–æ–º–µ—â–µ–Ω–∏–µ\n‚úèÔ∏è *–¢–µ–∫—Å—Ç* ‚Äî –æ–ø–∏—à–∏—Ç–µ —Ä–∞–±–æ—Ç—ã —Å–ø–∏—Å–∫–æ–º\n\n_–ü—Ä–∏–º–µ—Ä –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:_\n\\`\\`\\`\n–ì–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω 2 —Å–ª–æ—è –ø—Ä–æ—Ñ–∏–ª—å –ü–ü60 25–º2\n–ü–ª–∏—Ç–∫–∞ –∫–µ—Ä–∞–º–æ–≥—Ä–∞–Ω–∏—Ç 60x60 –≤–∞–Ω–Ω–∞—è 15–º2\n–®–ø–∞–∫–ª–µ–≤–∫–∞ –ø–æ–¥ –ø–æ–∫—Ä–∞—Å–∫—É –ø–æ—Ç–æ–ª–∫–∏ —Å—Ç–µ–Ω—ã 120–º2\n–†–æ–∑–µ—Ç–∫–∏ —Å–∫—Ä—ã—Ç—ã–π –º–æ–Ω—Ç–∞–∂ 20—à—Ç\n\\`\\`\\`\n\n–ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ/PDF üì∑üìÑ`,\n    // PDF specific\n    pdf_received: 'üìÑ *PDF –ø–æ–ª—É—á–µ–Ω*',\n    pdf_processing: '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —á–µ—Ä—Ç—ë–∂...',\n    pdf_pages: '—Å—Ç—Ä.',\n    pdf_page_limit: '‚ö†Ô∏è –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –ø–µ—Ä–≤—ã–µ 3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã',\n    pdf_rooms_found: 'üè† –ù–∞–π–¥–µ–Ω–æ –ø–æ–º–µ—â–µ–Ω–∏–π',\n    pdf_elements_found: 'üß± –ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤',\n    pdf_works_generated: 'üìù –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ —Ä–∞–±–æ—Ç',\n    pdf_analyzing_page: '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É',\n    pdf_of: '–∏–∑',\n    pdf_complete: '‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω',\n    pdf_error: '‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ PDF',\n    // Rest\n    photo_added: '‚úÖ –§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ',\n    photos_count: '—Ñ–æ—Ç–æ',\n    add_more: '+ –ï—â—ë —Ñ–æ—Ç–æ',\n    analyze_now: '‚ñ∂ –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑',\n    analyzing: '–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...',\n    found: '*–û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã:*',\n    edit_hint: '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è',\n    calc: '–ü–æ–∏—Å–∫ —Ä–∞—Å—Ü–µ–Ω–æ–∫',\n    ready: '*–°–ú–ï–¢–ê*',\n    total: '–ò–¢–û–ì–û',\n    days: '–¥–Ω.',\n    pct: '–¢–æ—á–Ω–æ—Å—Ç—å',\n    workers: '–¢—Ä—É–¥',\n    machines: '–ú–µ—Ö–∞–Ω–∏–∑–º—ã',\n    materials: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã',\n    subtotal: '–°–≤–æ–¥–∫–∞',\n    searching: '–ü–æ–∏—Å–∫',\n    of: '–∏–∑',\n    not_found: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',\n    low_conf: '–¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏',\n    price_note: '–ë–∞–∑–∞ —Ü–µ–Ω: –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ 2025',\n    btn_calc: '‚ñ∂ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å',\n    btn_new: '+ –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç',\n    btn_lang: '‚öô –Ø–∑—ã–∫',\n    btn_edit: '‚úé –ò–∑–º–µ–Ω–∏—Ç—å',\n    btn_delete: '‚úï –£–¥–∞–ª–∏—Ç—å',\n    btn_add_work: '+ –ü–æ–∑–∏—Ü–∏—è',\n    btn_done: '‚úÖ –ì–æ—Ç–æ–≤–æ',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª –ó–∞–Ω–æ–≤–æ',\n    btn_help: '? –°–ø—Ä–∞–≤–∫–∞',\n    loading: '–†–∞—Å—á—ë—Ç...',\n    more_in_html: '–ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç –¥–æ—Å—Ç—É–ø–µ–Ω',\n    resources: '–ü–æ–¥—Ä–æ–±–Ω–µ–µ: —Ä–µ—Å—É—Ä—Å—ã –∏ —Å–æ—Å—Ç–∞–≤—ã —Ä–∞–±–æ—Ç',\n    enter_work: '*–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é*\\n–§–æ—Ä–º–∞—Ç: –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ï–¥–∏–Ω–∏—Ü–∞\\n–ü—Ä–∏–º–µ—Ä: –ú–æ–Ω—Ç–∞–∂ –ì–ö–õ, 15 –º¬≤',\n    work_added: '‚úÖ –ü–æ–∑–∏—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞',\n    what_next: '*–î–µ–π—Å—Ç–≤–∏—è:*',\n    categories: '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏',\n    cat_demolition: '–î–µ–º–æ–Ω—Ç–∞–∂',\n    cat_rough: '–ß–µ—Ä–Ω–æ–≤—ã–µ',\n    cat_finishing: '–û—Ç–¥–µ–ª–∫–∞',\n    cat_mep: '–ò–Ω–∂–µ–Ω–µ—Ä–∏—è',\n    help_title: '*–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ*',\n    help_text: `*–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è*\n\n*1. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è*\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ, PDF-–ø–ª–∞–Ω –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ.\nPDF: –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –¥–æ 3 —Å—Ç—Ä–∞–Ω–∏—Ü.\n\n*2. –ü—Ä–æ–≤–µ—Ä–∫–∞*\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã.\n\n*3. –†–∞—Å—á—ë—Ç*\n–¶–µ–Ω—ã –∏–∑ –±–∞–∑—ã DDC CWICR.\n\n*4. –≠–∫—Å–ø–æ—Ä—Ç*\n–í—ã–≥—Ä—É–∑–∫–∞ –≤ Excel –∏–ª–∏ PDF.\n\n*–ö–æ–º–∞–Ω–¥—ã:*\n/start ‚Äî –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç\n/help ‚Äî –°–ø—Ä–∞–≤–∫–∞`,\n    doc_title: '–°–ú–ï–¢–ê',\n    col_pos: '‚Ññ', col_code: '–®–∏—Ñ—Ä', col_desc: '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', col_unit: '–ï–¥.', col_qty: '–ö–æ–ª.', col_price: '–¶–µ–Ω–∞', col_total: '–°—É–º–º–∞', col_labor: '–ß/—á', col_quality: '–ö',\n    grand_total: '–í–°–ï–ì–û', labor_cost: '–§–û–¢', material_cost: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã', labor_days: '–î–Ω–µ–π',\n    kpi_total: '–°—Ç–æ–∏–º–æ—Å—Ç—å', kpi_hours: '–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã', kpi_days: '–°—Ä–æ–∫',\n    chart_cost_structure: '–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞—Ç—Ä–∞—Ç', chart_labor: '–¢—Ä—É–¥', chart_material: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã', chart_machines: '–ú–µ—Ö–∞–Ω–∏–∑–º—ã',\n    res_labor: '–¢—Ä—É–¥', res_material: '–ú–∞—Ç', res_machine: '–ú–µ—Ö',\n    collapse_all: '–°–≤–µ—Ä–Ω—É—Ç—å', expand_all: '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å',\n    quality_high: '–í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å', quality_medium: '–°—Ä–µ–¥–Ω—è—è —Ç–æ—á–Ω–æ—Å—Ç—å', quality_low: '–ù–∏–∑–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å',\n    export_excel_msg: '–≠–∫—Å–ø–æ—Ä—Ç Excel (CSV)', export_pdf_msg: '–≠–∫—Å–ø–æ—Ä—Ç PDF', btn_refine: '–£—Ç–æ—á–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑', found_pct: '–Ω–∞–π–¥–µ–Ω–æ', more_resources: '–µ—â—ë', kpi_items: '–ü–æ–∑–∏—Ü–∏–∏', scope_title: '–°–æ—Å—Ç–∞–≤ —Ä–∞–±–æ—Ç', show_scope: '–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–∞–≤'\n  },\n\n  'ES': { \n    fallback_start: 'Pulse /start para comenzar', \n    rooms: 'habitaciones', works_identified: 'trabajos', general: '–û–±—â–µ–µ', no_works: 'Sin trabajos', items: 'elementos', min: '–º–∏–Ω', \n    db: 'ES_BARCELONA_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Spanish', flag: 'üá™üá∏', native: 'Espa√±ol', cur: 'EUR', sym: '‚Ç¨', loc: 'es-ES', region: 'Barcelona', search_lang: 'Spanish',\n    ok: '‚úÖ *Espa√±ol* ¬∑ Barcelona ¬∑ EUR',\n    text_prompt: `*Describa los trabajos:*\\n\\n_Ejemplo:_\\n\\`\\`\\`\\nPladur 2 capas 25m2\\nAzulejos ba√±o 15m2\\nPintura paredes 120m2\\n\\`\\`\\``,\n    photo: `*Env√≠e foto, PDF o descripci√≥n*\n\nüìÑ *Planos PDF* ‚Äî plano de planta o dibujo (m√°x. 3 p√°gs.)\nüì∑ *Foto* ‚Äî fotograf√≠e el espacio\n‚úèÔ∏è *Texto* ‚Äî describa trabajos en lista\n\n_Ejemplo para copiar:_\n\\`\\`\\`\nPladur 2 capas perfil met√°lico 25m2\nAzulejos porcel√°nico 60x60 ba√±o 15m2\nAlisado para pintura techos paredes 120m2\nEnchufes empotrados 20uds\n\\`\\`\\`\n\nO env√≠e foto/PDF üì∑üìÑ`,\n    pdf_received: 'üìÑ *PDF recibido*',\n    pdf_processing: '‚è≥ Analizando plano...',\n    pdf_pages: 'p√°ginas',\n    pdf_page_limit: '‚ö†Ô∏è Solo se procesan las primeras 3 p√°ginas',\n    pdf_rooms_found: 'üè† Habitaciones encontradas',\n    pdf_elements_found: 'üß± Elementos encontrados',\n    pdf_works_generated: 'üìù Trabajos generados',\n    pdf_analyzing_page: 'üîç Analizando p√°gina',\n    pdf_of: 'de',\n    pdf_complete: '‚úÖ An√°lisis completado',\n    pdf_error: '‚ùå Error al procesar PDF',\n    photo_added: '‚úÖ Foto a√±adida',\n    photos_count: 'fotos',\n    add_more: '+ M√°s fotos',\n    analyze_now: '‚ñ∂ Analizar',\n    analyzing: 'Analizando...',\n    found: '*Trabajos identificados:*',\n    edit_hint: 'Toque para editar',\n    calc: 'B√∫squeda de precios',\n    ready: '*PRESUPUESTO*',\n    total: 'TOTAL',\n    days: 'd√≠as',\n    pct: 'Precisi√≥n',\n    workers: 'M.O.',\n    machines: 'Equipos',\n    materials: 'Materiales',\n    subtotal: 'Resumen',\n    searching: 'Buscando',\n    of: 'de',\n    not_found: 'Sin coincidencia',\n    low_conf: 'Revisar',\n    price_note: 'Base: Barcelona 2025',\n    btn_calc: '‚ñ∂ Calcular',\n    btn_new: '+ Nuevo',\n    btn_lang: '‚öô Idioma',\n    btn_edit: '‚úé Editar',\n    btn_delete: '‚úï Eliminar',\n    btn_add_work: '+ Partida',\n    btn_done: '‚úÖ Listo',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª Reiniciar',\n    btn_help: '? Ayuda',\n    loading: 'Calculando...',\n    more_in_html: 'Informe detallado disponible',\n    resources: 'Detalles: recursos y alcance',\n    enter_work: '*A√±adir partida*\\nFormato: Descripci√≥n, Cantidad Unidad',\n    work_added: '‚úÖ A√±adido',\n    what_next: '*Opciones:*',\n    categories: 'Categor√≠as',\n    cat_demolition: 'Demolici√≥n',\n    cat_rough: 'Estructura',\n    cat_finishing: 'Acabados',\n    cat_mep: 'Instalaciones',\n    help_title: '*Gu√≠a*',\n    help_text: `*Gu√≠a de uso*\n\n*1.* Env√≠e fotos, PDF o descripci√≥n\nPDF: m√°x. 3 p√°ginas\n*2.* Revise los trabajos\n*3.* Calcule precios\n*4.* Exporte\n\n/start ‚Äî Nuevo\n/help ‚Äî Ayuda`,\n    doc_title: 'PRESUPUESTO',\n    col_pos: 'N¬∫', col_code: 'C√≥digo', col_desc: 'Descripci√≥n', col_unit: 'Ud', col_qty: 'Cant', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'TOTAL', labor_cost: 'M.O.', material_cost: 'Materiales', labor_days: 'D√≠as',\n    kpi_total: 'Coste Total', kpi_hours: 'Horas', kpi_days: 'D√≠as',\n    chart_cost_structure: 'Estructura', chart_labor: 'M.O.', chart_material: 'Mat', chart_machines: 'Eq',\n    res_labor: 'MO', res_material: 'Mat', res_machine: 'Eq',\n    collapse_all: 'Contraer', expand_all: 'Expandir',\n    quality_high: 'Alta', quality_medium: 'Media', quality_low: 'Baja',\n    export_excel_msg: 'Exportar Excel', export_pdf_msg: 'Exportar PDF', btn_refine: 'Refinar', found_pct: 'encontrado', more_resources: 'm√°s', kpi_items: 'Art√≠culos', scope_title: 'Alcance', show_scope: 'Ver alcance'\n  },\n\n  'FR': { \n    fallback_start: 'Appuyez sur /start pour commencer', \n    rooms: 'pi√®ces', works_identified: 'travaux', general: 'G√©n√©ral', no_works: 'Aucun travail', items: '√©l√©ments', min: '–º–∏–Ω', \n    db: 'FR_PARIS_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'French', flag: 'üá´üá∑', native: 'Fran√ßais', cur: 'EUR', sym: '‚Ç¨', loc: 'fr-FR', region: 'Paris', search_lang: 'French',\n    ok: '‚úÖ *Fran√ßais* ¬∑ Paris ¬∑ EUR',\n    text_prompt: `*D√©crivez les travaux:*\\n\\n_Exemple:_\\n\\`\\`\\`\\nPlaco 2 couches 25m2\\nCarrelage sdb 15m2\\nPeinture murs 120m2\\n\\`\\`\\``,\n    photo: `*Envoyez photo, PDF ou description*\n\nüìÑ *Plans PDF* ‚Äî plan d'√©tage ou dessin (max 3 pages)\nüì∑ *Photo* ‚Äî photographiez l'espace\n‚úèÔ∏è *Texte* ‚Äî d√©crivez les travaux en liste\n\n_Exemple √† copier:_\n\\`\\`\\`\nPlaco 2 couches ossature m√©tallique 25m2\nCarrelage gr√®s c√©rame 60x60 sdb 15m2\nEnduit plafonds murs 120m2\nPrises encastr√©es 20pcs\n\\`\\`\\`\n\nOu envoyez photo/PDF üì∑üìÑ`,\n    pdf_received: 'üìÑ *PDF re√ßu*',\n    pdf_processing: '‚è≥ Analyse du plan...',\n    pdf_pages: 'pages',\n    pdf_page_limit: '‚ö†Ô∏è Seules les 3 premi√®res pages sont trait√©es',\n    pdf_rooms_found: 'üè† Pi√®ces trouv√©es',\n    pdf_elements_found: 'üß± √âl√©ments trouv√©s',\n    pdf_works_generated: 'üìù Travaux g√©n√©r√©s',\n    pdf_analyzing_page: 'üîç Analyse de la page',\n    pdf_of: 'sur',\n    pdf_complete: '‚úÖ Analyse termin√©e',\n    pdf_error: '‚ùå Erreur de traitement PDF',\n    photo_added: '‚úÖ Photo ajout√©e',\n    photos_count: 'photos',\n    add_more: '+ Autres photos',\n    analyze_now: '‚ñ∂ Analyser',\n    analyzing: 'Analyse en cours...',\n    found: '*Ouvrages identifi√©s:*',\n    edit_hint: 'Appuyez pour modifier',\n    calc: 'Recherche des prix',\n    ready: '*DEVIS*',\n    total: 'TOTAL',\n    days: 'jours',\n    pct: 'Pr√©cision',\n    workers: 'M.O.',\n    machines: 'Mat√©riel',\n    materials: 'Mat√©riaux',\n    subtotal: 'R√©sum√©',\n    searching: 'Recherche',\n    of: 'sur',\n    not_found: 'Non trouv√©',\n    low_conf: '√Ä v√©rifier',\n    price_note: 'Base: Paris 2025',\n    btn_calc: '‚ñ∂ Calculer',\n    btn_new: '+ Nouveau',\n    btn_lang: '‚öô Langue',\n    btn_edit: '‚úé Modifier',\n    btn_delete: '‚úï Supprimer',\n    btn_add_work: '+ Ouvrage',\n    btn_done: '‚úÖ Termin√©',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª Recommencer',\n    btn_help: '? Aide',\n    loading: 'Calcul en cours...',\n    more_in_html: 'Rapport d√©taill√© disponible',\n    resources: 'D√©tails: ressources et description',\n    enter_work: '*Ajouter ouvrage*\\nFormat: Description, Quantit√© Unit√©',\n    work_added: '‚úÖ Ajout√©',\n    what_next: '*Options:*',\n    categories: 'Cat√©gories',\n    cat_demolition: 'D√©molition',\n    cat_rough: 'Gros ≈ìuvre',\n    cat_finishing: 'Finitions',\n    cat_mep: 'CVC',\n    help_title: '*Guide*',\n    help_text: `*Guide d'utilisation*\n\n*1.* Envoyez photos, PDF ou description\nPDF: max 3 pages\n*2.* V√©rifiez les ouvrages\n*3.* Calculez les prix\n*4.* Exportez\n\n/start ‚Äî Nouveau\n/help ‚Äî Aide`,\n    doc_title: 'DEVIS',\n    col_pos: 'N¬∞', col_code: 'Code', col_desc: 'D√©signation', col_unit: 'U', col_qty: 'Qt√©', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'TOTAL', labor_cost: 'M.O.', material_cost: 'Mat√©riaux', labor_days: 'Jours',\n    kpi_total: 'Co√ªt Total', kpi_hours: 'Heures', kpi_days: 'Jours',\n    chart_cost_structure: 'Structure', chart_labor: 'M.O.', chart_material: 'Mat', chart_machines: '√âq',\n    res_labor: 'MO', res_material: 'Mat', res_machine: '√âq',\n    collapse_all: 'R√©duire', expand_all: 'D√©velopper',\n    quality_high: 'Haute', quality_medium: 'Moyenne', quality_low: 'Faible',\n    export_excel_msg: 'Export Excel', export_pdf_msg: 'Export PDF', btn_refine: 'Affiner', found_pct: 'trouv√©', more_resources: 'plus', kpi_items: 'Articles', scope_title: 'Description', show_scope: 'Voir description'\n  },\n\n  'PT': { \n    fallback_start: 'Pressione /start para come√ßar', \n    rooms: 'quartos', works_identified: 'trabalhos', general: 'Geral', no_works: 'Sem trabalhos', items: 'itens', min: '–º–∏–Ω', \n    db: 'PT_SAOPAULO_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Portuguese', flag: 'üáßüá∑', native: 'Portugu√™s', cur: 'BRL', sym: 'R$', loc: 'pt-BR', region: 'S√£o Paulo', search_lang: 'Portuguese',\n    ok: '‚úÖ *Portugu√™s* ¬∑ S√£o Paulo ¬∑ BRL',\n    text_prompt: `*Descreva os trabalhos:*\\n\\n_Exemplo:_\\n\\`\\`\\`\\nDrywall 2 camadas 25m2\\nPorcelanato banheiro 15m2\\nPintura paredes 120m2\\n\\`\\`\\``,\n    photo: `*Envie foto, PDF ou descri√ß√£o*\n\nüìÑ *Plantas PDF* ‚Äî planta baixa ou desenho (m√°x. 3 p√°gs.)\nüì∑ *Foto* ‚Äî fotografe o ambiente\n‚úèÔ∏è *Texto* ‚Äî descreva os trabalhos em lista\n\n_Exemplo para copiar:_\n\\`\\`\\`\nDrywall 2 camadas perfil met√°lico 25m2\nPorcelanato 60x60 banheiro 15m2\nMassa corrida teto paredes 120m2\nTomadas embutidas 20un\n\\`\\`\\`\n\nOu envie foto/PDF üì∑üìÑ`,\n    pdf_received: 'üìÑ *PDF recebido*',\n    pdf_processing: '‚è≥ Analisando planta...',\n    pdf_pages: 'p√°ginas',\n    pdf_page_limit: '‚ö†Ô∏è Processando apenas as 3 primeiras p√°ginas',\n    pdf_rooms_found: 'üè† C√¥modos encontrados',\n    pdf_elements_found: 'üß± Elementos encontrados',\n    pdf_works_generated: 'üìù Trabalhos gerados',\n    pdf_analyzing_page: 'üîç Analisando p√°gina',\n    pdf_of: 'de',\n    pdf_complete: '‚úÖ An√°lise conclu√≠da',\n    pdf_error: '‚ùå Erro ao processar PDF',\n    photo_added: '‚úÖ Foto adicionada',\n    photos_count: 'fotos',\n    add_more: '+ Mais fotos',\n    analyze_now: '‚ñ∂ Analisar',\n    analyzing: 'Analisando...',\n    found: '*Servi√ßos identificados:*',\n    edit_hint: 'Toque para editar',\n    calc: 'Busca de pre√ßos',\n    ready: '*OR√áAMENTO*',\n    total: 'TOTAL',\n    days: 'dias',\n    pct: 'Precis√£o',\n    workers: 'M.O.',\n    machines: 'Equipamentos',\n    materials: 'Materiais',\n    subtotal: 'Resumo',\n    searching: 'Buscando',\n    of: 'de',\n    not_found: 'N√£o encontrado',\n    low_conf: 'Verificar',\n    price_note: 'Base: S√£o Paulo 2025',\n    btn_calc: '‚ñ∂ Calcular',\n    btn_new: '+ Novo',\n    btn_lang: '‚öô Idioma',\n    btn_edit: '‚úé Editar',\n    btn_delete: '‚úï Excluir',\n    btn_add_work: '+ Servi√ßo',\n    btn_done: '‚úÖ Pronto',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª Recome√ßar',\n    btn_help: '? Ajuda',\n    loading: 'Calculando...',\n    more_in_html: 'Relat√≥rio detalhado dispon√≠vel',\n    resources: 'Detalhes: recursos e escopo',\n    enter_work: '*Adicionar servi√ßo*\\nFormato: Descri√ß√£o, Quantidade Unidade',\n    work_added: '‚úÖ Adicionado',\n    what_next: '*Op√ß√µes:*',\n    categories: 'Categorias',\n    cat_demolition: 'Demoli√ß√£o',\n    cat_rough: 'Estrutura',\n    cat_finishing: 'Acabamento',\n    cat_mep: 'Instala√ß√µes',\n    help_title: '*Guia*',\n    help_text: `*Guia de uso*\n\n*1.* Envie fotos, PDF ou descri√ß√£o\nPDF: m√°x. 3 p√°ginas\n*2.* Revise os servi√ßos\n*3.* Calcule pre√ßos\n*4.* Exporte\n\n/start ‚Äî Novo\n/help ‚Äî Ajuda`,\n    doc_title: 'OR√áAMENTO',\n    col_pos: 'N¬∫', col_code: 'C√≥digo', col_desc: 'Descri√ß√£o', col_unit: 'Un', col_qty: 'Qtd', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'TOTAL', labor_cost: 'M.O.', material_cost: 'Materiais', labor_days: 'Dias',\n    kpi_total: 'Custo Total', kpi_hours: 'Horas', kpi_days: 'Dias',\n    chart_cost_structure: 'Estrutura', chart_labor: 'M.O.', chart_material: 'Mat', chart_machines: 'Eq',\n    res_labor: 'MO', res_material: 'Mat', res_machine: 'Eq',\n    collapse_all: 'Recolher', expand_all: 'Expandir',\n    quality_high: 'Alta', quality_medium: 'M√©dia', quality_low: 'Baixa',\n    export_excel_msg: 'Exportar Excel', export_pdf_msg: 'Exportar PDF', btn_refine: 'Refinar', found_pct: 'encontrado', more_resources: 'mais', kpi_items: 'Itens', scope_title: 'Escopo', show_scope: 'Ver escopo'\n  },\n\n  'ZH': { \n    db: 'ZH_SHANGHAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Chinese', flag: 'üá®üá≥', native: '‰∏≠Êñá', cur: 'CNY', sym: '¬•', loc: 'zh-CN', region: '‰∏äÊµ∑', search_lang: 'Chinese',\n    ok: '‚úÖ *‰∏≠Êñá* ¬∑ ‰∏äÊµ∑ ¬∑ CNY',\n    text_prompt: `*ÊèèËø∞Â∑•‰Ωú:*\\n\\n_Á§∫‰æã:_\\n\\`\\`\\`\\nÁü≥ËÜèÊùøÂèåÂ±Ç 25m2\\nÁì∑Á†ñÂç´ÁîüÈó¥ 15m2\\nÂ¢ôÈù¢Ê∂ÇÊñô 120m2\\n\\`\\`\\``,\n    photo: `*ÂèëÈÄÅÁÖßÁâá„ÄÅPDFÊàñÊèèËø∞*\n\nüìÑ *PDFÂõæÁ∫∏* ‚Äî Âπ≥Èù¢ÂõæÊàñÂõæÁ∫∏ÔºàÊúÄÂ§ö3È°µÔºâ\nüì∑ *ÁÖßÁâá* ‚Äî ÊãçÊëÑÊàøÈó¥ÊàñÁâ©‰Ωì\n‚úèÔ∏è *ÊñáÂ≠ó* ‚Äî ‰ª•ÂàóË°®ÂΩ¢ÂºèÊèèËø∞\n\n_Â§çÂà∂Á§∫‰æãÔºö_\n\\`\\`\\`\nÁü≥ËÜèÊùøÂèåÂ±ÇËΩªÈí¢ÈæôÈ™® 25m2\nÁì∑Á†ñ600x600Âç´ÁîüÈó¥ 15m2\nËÖªÂ≠êÊâæÂπ≥È°∂Â¢ô 120m2\nÊöóË£ÖÊèíÂ∫ß 20‰∏™\n\\`\\`\\`\n\nÊàñÂèëÈÄÅÁÖßÁâá/PDF üì∑üìÑ`,\n    pdf_received: 'üìÑ *Â∑≤Êî∂Âà∞PDF*',\n    pdf_processing: '‚è≥ Ê≠£Âú®ÂàÜÊûêÂõæÁ∫∏...',\n    pdf_pages: 'È°µ',\n    pdf_page_limit: '‚ö†Ô∏è ‰ªÖÂ§ÑÁêÜÂâç3È°µ',\n    pdf_rooms_found: 'üè† ÂèëÁé∞ÊàøÈó¥',\n    pdf_elements_found: 'üß± ÂèëÁé∞ÂÖÉÁ¥†',\n    pdf_works_generated: 'üìù Â∑≤ÁîüÊàêÂ∑•‰ΩúÈ°π',\n    pdf_analyzing_page: 'üîç Ê≠£Âú®ÂàÜÊûêÁ¨¨',\n    pdf_of: 'È°µÔºåÂÖ±',\n    pdf_complete: '‚úÖ ÂàÜÊûêÂÆåÊàê',\n    pdf_error: '‚ùå PDFÂ§ÑÁêÜÈîôËØØ',\n    photo_added: '‚úÖ ÁÖßÁâáÂ∑≤Ê∑ªÂä†',\n    photos_count: 'Âº†',\n    add_more: '+ Êõ¥Â§öÁÖßÁâá',\n    analyze_now: '‚ñ∂ ÂºÄÂßãÂàÜÊûê',\n    analyzing: 'ÂàÜÊûê‰∏≠...',\n    found: '*ËØÜÂà´ÁöÑÂ∑•‰ΩúÈ°π:*',\n    edit_hint: 'ÁÇπÂáªÁºñËæë',\n    calc: '‰ª∑Ê†ºÊü•ËØ¢',\n    ready: '*Â∑•Á®ãÈ¢ÑÁÆó*',\n    total: 'ÂêàËÆ°',\n    days: 'Â§©',\n    pct: 'ÂåπÈÖçÁéá',\n    workers: '‰∫∫Â∑•',\n    machines: 'Êú∫Ê¢∞',\n    materials: 'ÊùêÊñô',\n    subtotal: 'ÊëòË¶Å',\n    searching: 'ÊêúÁ¥¢',\n    of: '/',\n    not_found: 'Êú™ÊâæÂà∞',\n    low_conf: 'ÈúÄÊ†∏Êü•',\n    price_note: '‰ª∑Ê†ºÂü∫ÂáÜÔºö‰∏äÊµ∑ 2025',\n    btn_calc: '‚ñ∂ ËÆ°ÁÆó',\n    btn_new: '+ Êñ∞È°πÁõÆ',\n    btn_lang: '‚öô ËØ≠Ë®Ä',\n    btn_edit: '‚úé ÁºñËæë',\n    btn_delete: '‚úï Âà†Èô§',\n    btn_add_work: '+ Ê∑ªÂä†',\n    btn_done: '‚úÖ ÂÆåÊàê',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª ÈáçÊñ∞ÂºÄÂßã',\n    btn_help: '? Â∏ÆÂä©',\n    loading: 'ËÆ°ÁÆó‰∏≠...',\n    more_in_html: 'ËØ¶ÁªÜÊä•ÂëäÂèØÁî®',\n    resources: 'ËØ¶ÊÉÖÔºöËµÑÊ∫êÂíåÂ∑•‰ΩúËåÉÂõ¥',\n    enter_work: '*Ê∑ªÂä†È°πÁõÆ*\\nÊ†ºÂºèÔºöÊèèËø∞ÔºåÊï∞Èáè Âçï‰Ωç',\n    work_added: '‚úÖ Â∑≤Ê∑ªÂä†',\n    what_next: '*ÈÄâÈ°π:*',\n    categories: 'Á±ªÂà´',\n    cat_demolition: 'ÊãÜÈô§',\n    cat_rough: 'ÁªìÊûÑ',\n    cat_finishing: 'Ë£ÖÈ•∞',\n    cat_mep: 'Êú∫Áîµ',\n    help_title: '*ÊåáÂçó*',\n    help_text: `*‰ΩøÁî®ÊåáÂçó*\n\n*1.* ÂèëÈÄÅÁÖßÁâá„ÄÅPDFÊàñÊèèËø∞\nPDFÔºöÊúÄÂ§ö3È°µ\n*2.* Ê£ÄÊü•Â∑•‰ΩúÈ°π\n*3.* ËÆ°ÁÆó‰ª∑Ê†º\n*4.* ÂØºÂá∫\n\n/start ‚Äî Êñ∞È°πÁõÆ\n/help ‚Äî Â∏ÆÂä©`,\n    doc_title: 'È¢ÑÁÆó',\n    col_pos: 'Â∫èÂè∑', col_code: 'ÁºñÁ†Å', col_desc: 'ÂêçÁß∞', col_unit: 'Âçï‰Ωç', col_qty: 'Êï∞Èáè', col_price: 'Âçï‰ª∑', col_total: 'ÂêàËÆ°', col_labor: 'Â∑•Êó∂', col_quality: 'Ë¥®',\n    grand_total: 'ÊÄªËÆ°', labor_cost: '‰∫∫Â∑•Ë¥π', material_cost: 'ÊùêÊñôË¥π', labor_days: 'Â∑•Êúü',\n    kpi_total: 'ÊÄªÊàêÊú¨', kpi_hours: 'Â∑•Êó∂', kpi_days: 'Â∑•Êúü',\n    chart_cost_structure: 'ÊàêÊú¨ÁªìÊûÑ', chart_labor: '‰∫∫Â∑•', chart_material: 'ÊùêÊñô', chart_machines: 'Êú∫Ê¢∞',\n    res_labor: '‰∫∫Â∑•', res_material: 'ÊùêÊñô', res_machine: 'Êú∫Ê¢∞',\n    collapse_all: 'ÊäòÂè†', expand_all: 'Â±ïÂºÄ',\n    quality_high: 'È´ò', quality_medium: '‰∏≠', quality_low: '‰Ωé',\n    export_excel_msg: 'ÂØºÂá∫Excel', export_pdf_msg: 'ÂØºÂá∫PDF', btn_refine: 'Á≤æÁ°ÆÂàÜÊûê', found_pct: 'ÊâæÂà∞', more_resources: 'Êõ¥Â§ö', kpi_items: 'È°πÁõÆ', scope_title: 'Â∑•‰ΩúËåÉÂõ¥', show_scope: 'Êü•ÁúãËåÉÂõ¥'\n  },\n\n  'AR': { \n    db: 'AR_DUBAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Arabic', flag: 'üá¶üá™', native: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', cur: 'AED', sym: 'ÿØ.ÿ•', loc: 'ar-AE', region: 'ÿØÿ®Ÿä', search_lang: 'Arabic',\n    ok: '‚úÖ *ÿßŸÑÿπÿ±ÿ®Ÿäÿ©* ¬∑ ÿØÿ®Ÿä ¬∑ AED',\n    text_prompt: `*ÿµŸÅ ÿßŸÑÿ£ÿπŸÖÿßŸÑ:*\\n\\n_ŸÖÿ´ÿßŸÑ:_\\n\\`\\`\\`\\nÿ¨ÿ®ÿ≥ ÿ®Ÿàÿ±ÿØ ÿ∑ÿ®ŸÇÿ™ŸäŸÜ 25ŸÖ2\\nÿ®ŸÑÿßÿ∑ ÿ≠ŸÖÿßŸÖ 15ŸÖ2\\nÿØŸáÿßŸÜ ÿ¨ÿØÿ±ÿßŸÜ 120ŸÖ2\\n\\`\\`\\``,\n    photo: `*ÿ£ÿ±ÿ≥ŸÑ ÿµŸàÿ±ÿ© ÿ£Ÿà PDF ÿ£Ÿà ŸàÿµŸÅ*\n\nüìÑ *ŸÖÿÆÿ∑ÿ∑ÿßÿ™ PDF* ‚Äî ŸÖÿÆÿ∑ÿ∑ ÿßŸÑÿ∑ÿßÿ®ŸÇ ÿ£Ÿà ÿßŸÑÿ±ÿ≥ŸÖ (ÿ≠ÿ™Ÿâ 3 ÿµŸÅÿ≠ÿßÿ™)\nüì∑ *ÿµŸàÿ±ÿ©* ‚Äî ÿßŸÑÿ™ŸÇÿ∑ ÿµŸàÿ±ÿ© ŸÑŸÑŸÖŸÉÿßŸÜ\n‚úèÔ∏è *ŸÜÿµ* ‚Äî ÿµŸÅ ÿßŸÑÿ£ÿπŸÖÿßŸÑ ŸÉŸÇÿßÿ¶ŸÖÿ©\n\n_ŸÖÿ´ÿßŸÑ ŸÑŸÑŸÜÿ≥ÿÆ:_\n\\`\\`\\`\nÿ¨ÿ®ÿ≥ ÿ®Ÿàÿ±ÿØ ÿ∑ÿ®ŸÇÿ™ŸäŸÜ ŸáŸäŸÉŸÑ ŸÖÿπÿØŸÜŸä 25ŸÖ2\nÿ®ŸÑÿßÿ∑ ÿ≥Ÿäÿ±ÿßŸÖŸäŸÉ 60x60 ÿ≠ŸÖÿßŸÖ 15ŸÖ2\nŸÖÿπÿ¨ŸàŸÜ ÿ£ÿ≥ŸÇŸÅ ÿ¨ÿØÿ±ÿßŸÜ 120ŸÖ2\nŸÖŸÇÿßÿ®ÿ≥ ŸÖÿÆŸÅŸäÿ© 20ŸÇÿ∑ÿπÿ©\n\\`\\`\\`\n\nÿ£Ÿà ÿ£ÿ±ÿ≥ŸÑ ÿµŸàÿ±ÿ©/PDF üì∑üìÑ`,\n    pdf_received: 'üìÑ *ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ PDF*',\n    pdf_processing: '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖÿÆÿ∑ÿ∑...',\n    pdf_pages: 'ÿµŸÅÿ≠ÿßÿ™',\n    pdf_page_limit: '‚ö†Ô∏è ŸÖÿπÿßŸÑÿ¨ÿ© ÿ£ŸàŸÑ 3 ÿµŸÅÿ≠ÿßÿ™ ŸÅŸÇÿ∑',\n    pdf_rooms_found: 'üè† ÿßŸÑÿ∫ÿ±ŸÅ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©',\n    pdf_elements_found: 'üß± ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©',\n    pdf_works_generated: 'üìù ÿßŸÑÿ£ÿπŸÖÿßŸÑ ÿßŸÑŸÖŸèŸÜÿ¥ÿ£ÿ©',\n    pdf_analyzing_page: 'üîç ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©',\n    pdf_of: 'ŸÖŸÜ',\n    pdf_complete: '‚úÖ ÿßŸÉÿ™ŸÖŸÑ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ',\n    pdf_error: '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© PDF',\n    photo_added: '‚úÖ ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©',\n    photos_count: 'ÿµŸàÿ±',\n    add_more: '+ ÿßŸÑŸÖÿ≤ŸäÿØ',\n    analyze_now: '‚ñ∂ ÿ™ÿ≠ŸÑŸäŸÑ',\n    analyzing: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ...',\n    found: '*ÿßŸÑÿ£ÿπŸÖÿßŸÑ ÿßŸÑŸÖÿ≠ÿØÿØÿ©:*',\n    edit_hint: 'ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ™ÿπÿØŸäŸÑ',\n    calc: 'ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ£ÿ≥ÿπÿßÿ±',\n    ready: '*ÿßŸÑÿ™ŸÇÿØŸäÿ±*',\n    total: 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ',\n    days: 'ŸäŸàŸÖ',\n    pct: 'ÿßŸÑÿØŸÇÿ©',\n    workers: 'ÿπŸÖÿßŸÑÿ©',\n    machines: 'ŸÖÿπÿØÿßÿ™',\n    materials: 'ŸÖŸàÿßÿØ',\n    subtotal: 'ŸÖŸÑÿÆÿµ',\n    searching: 'ÿ®ÿ≠ÿ´',\n    of: 'ŸÖŸÜ',\n    not_found: 'ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ',\n    low_conf: 'ŸÑŸÑŸÖÿ±ÿßÿ¨ÿπÿ©',\n    price_note: 'ÿßŸÑÿ£ÿ≥ÿßÿ≥: ÿØÿ®Ÿä 2025',\n    btn_calc: '‚ñ∂ ÿ≠ÿ≥ÿßÿ®',\n    btn_new: '+ ÿ¨ÿØŸäÿØ',\n    btn_lang: '‚öô ŸÑÿ∫ÿ©',\n    btn_edit: '‚úé ÿ™ÿπÿØŸäŸÑ',\n    btn_delete: '‚úï ÿ≠ÿ∞ŸÅ',\n    btn_add_work: '+ ÿ•ÿ∂ÿßŸÅÿ©',\n    btn_done: '‚úÖ ÿ™ŸÖ',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª ÿßŸÑÿ®ÿØÿ° ŸÖŸÜ ÿ¨ÿØŸäÿØ',\n    btn_help: '? ŸÖÿ≥ÿßÿπÿØÿ©',\n    loading: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ÿ≥ÿßÿ®...',\n    more_in_html: 'ÿ™ŸÇÿ±Ÿäÿ± ŸÖŸÅÿµŸÑ ŸÖÿ™ÿßÿ≠',\n    resources: 'ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ: ÿßŸÑŸÖŸàÿßÿ±ÿØ ŸàŸÜÿ∑ÿßŸÇ ÿßŸÑÿπŸÖŸÑ',\n    enter_work: '*ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸÜÿØ*\\nÿßŸÑÿµŸäÿ∫ÿ©: ÿßŸÑŸàÿµŸÅÿå ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸàÿ≠ÿØÿ©',\n    work_added: '‚úÖ ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©',\n    what_next: '*ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™:*',\n    categories: 'ÿßŸÑŸÅÿ¶ÿßÿ™',\n    cat_demolition: 'ŸáÿØŸÖ',\n    cat_rough: 'ŸáŸäŸÉŸÑ',\n    cat_finishing: 'ÿ™ÿ¥ÿ∑Ÿäÿ®',\n    cat_mep: 'ŸÖŸäŸÉÿßŸÜŸäŸÉ',\n    help_title: '*ÿØŸÑŸäŸÑ*',\n    help_text: `*ÿØŸÑŸäŸÑ ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ*\n\n*1.* ÿ£ÿ±ÿ≥ŸÑ ÿµŸàÿ± ÿ£Ÿà PDF ÿ£Ÿà ŸàÿµŸÅ\nPDF: ÿ≠ÿ™Ÿâ 3 ÿµŸÅÿ≠ÿßÿ™\n*2.* ÿ±ÿßÿ¨ÿπ ÿßŸÑÿ£ÿπŸÖÿßŸÑ\n*3.* ÿßÿ≠ÿ≥ÿ® ÿßŸÑÿ£ÿ≥ÿπÿßÿ±\n*4.* ÿµÿØŸëÿ±\n\n/start ‚Äî ÿ¨ÿØŸäÿØ\n/help ‚Äî ŸÖÿ≥ÿßÿπÿØÿ©`,\n    doc_title: 'ÿßŸÑÿ™ŸÇÿØŸäÿ±',\n    col_pos: 'ÿ±ŸÇŸÖ', col_code: 'ÿßŸÑÿ±ŸÖÿ≤', col_desc: 'ÿßŸÑŸàÿµŸÅ', col_unit: 'Ÿàÿ≠ÿØÿ©', col_qty: 'ŸÉŸÖŸäÿ©', col_price: 'ÿ≥ÿπÿ±', col_total: 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ', col_labor: 'ÿ≥ÿßÿπÿßÿ™', col_quality: 'ÿ¨',\n    grand_total: 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä', labor_cost: 'ÿπŸÖÿßŸÑÿ©', material_cost: 'ŸÖŸàÿßÿØ', labor_days: 'ÿ£ŸäÿßŸÖ',\n    kpi_total: 'ÿßŸÑÿ™ŸÉŸÑŸÅÿ©', kpi_hours: 'ÿ≥ÿßÿπÿßÿ™', kpi_days: 'ÿ£ŸäÿßŸÖ',\n    chart_cost_structure: 'ÿßŸÑŸáŸäŸÉŸÑ', chart_labor: 'ÿπŸÖÿßŸÑÿ©', chart_material: 'ŸÖŸàÿßÿØ', chart_machines: 'ŸÖÿπÿØÿßÿ™',\n    res_labor: 'ÿπŸÖÿßŸÑÿ©', res_material: 'ŸÖŸàÿßÿØ', res_machine: 'ŸÖÿπÿØÿßÿ™',\n    collapse_all: 'ÿ∑Ÿä', expand_all: 'ÿ™Ÿàÿ≥Ÿäÿπ',\n    quality_high: 'ÿπÿßŸÑŸäÿ©', quality_medium: 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©', quality_low: 'ŸÖŸÜÿÆŸÅÿ∂ÿ©',\n    export_excel_msg: 'ÿ™ÿµÿØŸäÿ± Excel', export_pdf_msg: 'ÿ™ÿµÿØŸäÿ± PDF', btn_refine: 'ÿ™ÿ≠ŸÑŸäŸÑ ÿ£ÿØŸÇ', found_pct: 'Ÿàÿ¨ÿØ', more_resources: 'ÿßŸÑŸÖÿ≤ŸäÿØ', kpi_items: 'ÿ®ŸÜŸàÿØ', scope_title: 'ŸÜÿ∑ÿßŸÇ ÿßŸÑÿπŸÖŸÑ', show_scope: 'ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ∑ÿßŸÇ'\n  },\n\n  'HI': { \n    db: 'HI_MUMBAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Hindi', flag: 'üáÆüá≥', native: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä', cur: 'INR', sym: '‚Çπ', loc: 'hi-IN', region: '‡§Æ‡•Å‡§Ç‡§¨‡§à', search_lang: 'Hindi',\n    ok: '‚úÖ *‡§π‡§ø‡§®‡•ç‡§¶‡•Ä* ¬∑ ‡§Æ‡•Å‡§Ç‡§¨‡§à ¬∑ INR',\n    text_prompt: `*‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§µ‡§∞‡•ç‡§£‡§® ‡§ï‡§∞‡•á‡§Ç:*\\n\\n_‡§â‡§¶‡§æ‡§π‡§∞‡§£:_\\n\\`\\`\\`\\n‡§°‡•ç‡§∞‡§æ‡§à‡§µ‡•â‡§≤ 2 ‡§≤‡•á‡§Ø‡§∞ 25m2\\n‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ ‡§¨‡§æ‡§•‡§∞‡•Ç‡§Æ 15m2\\n‡§™‡•á‡§Ç‡§ü‡§ø‡§Ç‡§ó ‡§¶‡•Ä‡§µ‡§æ‡§∞‡•á‡§Ç 120m2\\n\\`\\`\\``,\n    photo: `*‡§´‡§º‡•ã‡§ü‡•ã, PDF ‡§Ø‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡•á‡§ú‡•á‡§Ç*\n\nüìÑ *PDF ‡§°‡•ç‡§∞‡§æ‡§á‡§Ç‡§ó* ‚Äî ‡§´‡•ç‡§≤‡•ã‡§∞ ‡§™‡•ç‡§≤‡§æ‡§® ‡§Ø‡§æ ‡§¨‡•ç‡§≤‡•Ç‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü (‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 3 ‡§™‡•á‡§ú)\nüì∑ *‡§´‡§º‡•ã‡§ü‡•ã* ‚Äî ‡§ï‡§Æ‡§∞‡•á ‡§Ø‡§æ ‡§µ‡§∏‡•ç‡§§‡•Å ‡§ï‡•Ä ‡§´‡§º‡•ã‡§ü‡•ã\n‚úèÔ∏è *‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü* ‚Äî ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§∏‡•Ç‡§ö‡•Ä ‡§Æ‡•á‡§Ç\n\n_‡§ï‡•â‡§™‡•Ä ‡§â‡§¶‡§æ‡§π‡§∞‡§£:_\n\\`\\`\\`\n‡§°‡•ç‡§∞‡§æ‡§à‡§µ‡•â‡§≤ 2 ‡§≤‡•á‡§Ø‡§∞ ‡§Æ‡•á‡§ü‡§≤ ‡§´‡•ç‡§∞‡•á‡§Æ 25m2\n‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ 60x60 ‡§¨‡§æ‡§•‡§∞‡•Ç‡§Æ 15m2\n‡§™‡•Å‡§ü‡•ç‡§ü‡•Ä ‡§õ‡§§ ‡§¶‡•Ä‡§µ‡§æ‡§∞‡•á‡§Ç 120m2\n‡§∏‡•â‡§ï‡•á‡§ü 20 ‡§™‡•Ä‡§∏\n\\`\\`\\`\n\n‡§Ø‡§æ ‡§´‡§º‡•ã‡§ü‡•ã/PDF ‡§≠‡•á‡§ú‡•á‡§Ç üì∑üìÑ`,\n    pdf_received: 'üìÑ *PDF ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§*',\n    pdf_processing: '‚è≥ ‡§°‡•ç‡§∞‡§æ‡§á‡§Ç‡§ó ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£...',\n    pdf_pages: '‡§™‡•á‡§ú',\n    pdf_page_limit: '‚ö†Ô∏è ‡§ï‡•á‡§µ‡§≤ ‡§™‡§π‡§≤‡•á 3 ‡§™‡•á‡§ú ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§π‡•ã‡§Ç‡§ó‡•á',\n    pdf_rooms_found: 'üè† ‡§ï‡§Æ‡§∞‡•á ‡§Æ‡§ø‡§≤‡•á',\n    pdf_elements_found: 'üß± ‡§è‡§≤‡§ø‡§Æ‡•á‡§Ç‡§ü ‡§Æ‡§ø‡§≤‡•á',\n    pdf_works_generated: 'üìù ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§¨‡§®‡§æ‡§è ‡§ó‡§è',\n    pdf_analyzing_page: 'üîç ‡§™‡•á‡§ú ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£',\n    pdf_of: '‡§Æ‡•á‡§Ç ‡§∏‡•á',\n    pdf_complete: '‚úÖ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§™‡•Ç‡§∞‡•ç‡§£',\n    pdf_error: '‚ùå PDF ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø',\n    photo_added: '‚úÖ ‡§´‡§º‡•ã‡§ü‡•ã ‡§ú‡•ã‡§°‡§º‡•Ä ‡§ó‡§à',\n    photos_count: '‡§´‡§º‡•ã‡§ü‡•ã',\n    add_more: '+ ‡§î‡§∞ ‡§´‡§º‡•ã‡§ü‡•ã',\n    analyze_now: '‚ñ∂ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£',\n    analyzing: '‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£...',\n    found: '*‡§™‡§π‡§ö‡§æ‡§®‡•á ‡§ó‡§è ‡§ï‡§æ‡§∞‡•ç‡§Ø:*',\n    edit_hint: '‡§∏‡§Ç‡§™‡§æ‡§¶‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡•à‡§™ ‡§ï‡§∞‡•á‡§Ç',\n    calc: '‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§ñ‡•ã‡§ú',\n    ready: '*‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®*',\n    total: '‡§ï‡•Å‡§≤',\n    days: '‡§¶‡§ø‡§®',\n    pct: '‡§∏‡§ü‡•Ä‡§ï‡§§‡§æ',\n    workers: '‡§∂‡•ç‡§∞‡§Æ',\n    machines: '‡§â‡§™‡§ï‡§∞‡§£',\n    materials: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä',\n    subtotal: '‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂',\n    searching: '‡§ñ‡•ã‡§ú',\n    of: '‡§Æ‡•á‡§Ç ‡§∏‡•á',\n    not_found: '‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ',\n    low_conf: '‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç',\n    price_note: '‡§Ü‡§ß‡§æ‡§∞: ‡§Æ‡•Å‡§Ç‡§¨‡§à 2025',\n    btn_calc: '‚ñ∂ ‡§ó‡§£‡§®‡§æ',\n    btn_new: '+ ‡§®‡§Ø‡§æ',\n    btn_lang: '‚öô ‡§≠‡§æ‡§∑‡§æ',\n    btn_edit: '‚úé ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§',\n    btn_delete: '‚úï ‡§π‡§ü‡§æ‡§è‡§Ç',\n    btn_add_work: '+ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç',\n    btn_done: '‚úÖ ‡§π‡•ã ‡§ó‡§Ø‡§æ',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª ‡§´‡§ø‡§∞ ‡§∏‡•á',\n    btn_help: '? ‡§Æ‡§¶‡§¶',\n    loading: '‡§ó‡§£‡§®‡§æ...',\n    more_in_html: '‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§â‡§™‡§≤‡§¨‡•ç‡§ß',\n    resources: '‡§µ‡§ø‡§µ‡§∞‡§£: ‡§∏‡§Ç‡§∏‡§æ‡§ß‡§® ‡§î‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞',\n    enter_work: '*‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç*\\n‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™: ‡§µ‡§ø‡§µ‡§∞‡§£, ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§á‡§ï‡§æ‡§à',\n    work_added: '‚úÖ ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ',\n    what_next: '*‡§µ‡§ø‡§ï‡§≤‡•ç‡§™:*',\n    categories: '‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç',\n    cat_demolition: '‡§§‡•ã‡§°‡§º‡§´‡•ã‡§°‡§º',\n    cat_rough: '‡§¢‡§æ‡§Ç‡§ö‡§æ',\n    cat_finishing: '‡§´‡§º‡§ø‡§®‡§ø‡§∂‡§ø‡§Ç‡§ó',\n    cat_mep: 'MEP',\n    help_title: '*‡§ó‡§æ‡§á‡§°*',\n    help_text: `*‡§â‡§™‡§Ø‡•ã‡§ó ‡§ó‡§æ‡§á‡§°*\n\n*1.* ‡§´‡§º‡•ã‡§ü‡•ã, PDF ‡§Ø‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡•á‡§ú‡•á‡§Ç\nPDF: ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 3 ‡§™‡•á‡§ú\n*2.* ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç\n*3.* ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§ó‡§£‡§®‡§æ\n*4.* ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§\n\n/start ‚Äî ‡§®‡§Ø‡§æ\n/help ‚Äî ‡§Æ‡§¶‡§¶`,\n    doc_title: '‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®',\n    col_pos: '‡§ï‡•ç‡§∞‡§Æ', col_code: '‡§ï‡•ã‡§°', col_desc: '‡§µ‡§ø‡§µ‡§∞‡§£', col_unit: '‡§á‡§ï‡§æ‡§à', col_qty: '‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ', col_price: '‡§¶‡§∞', col_total: '‡§ï‡•Å‡§≤', col_labor: '‡§ò‡§Ç‡§ü‡•á', col_quality: '‡§ó‡•Å',\n    grand_total: '‡§ï‡•Å‡§≤ ‡§Ø‡•ã‡§ó', labor_cost: '‡§∂‡•ç‡§∞‡§Æ', material_cost: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä', labor_days: '‡§¶‡§ø‡§®',\n    kpi_total: '‡§ï‡•Å‡§≤ ‡§≤‡§æ‡§ó‡§§', kpi_hours: '‡§ò‡§Ç‡§ü‡•á', kpi_days: '‡§¶‡§ø‡§®',\n    chart_cost_structure: '‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ', chart_labor: '‡§∂‡•ç‡§∞‡§Æ', chart_material: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä', chart_machines: '‡§â‡§™‡§ï‡§∞‡§£',\n    res_labor: '‡§∂‡•ç‡§∞‡§Æ', res_material: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä', res_machine: '‡§â‡§™‡§ï‡§∞‡§£',\n    collapse_all: '‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§', expand_all: '‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§',\n    quality_high: '‡§â‡§ö‡•ç‡§ö', quality_medium: '‡§Æ‡§ß‡•ç‡§Ø‡§Æ', quality_low: '‡§®‡§ø‡§Æ‡•ç‡§®',\n    export_excel_msg: 'Excel ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§', export_pdf_msg: 'PDF ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§', btn_refine: '‡§∏‡•Å‡§ß‡§æ‡§∞‡•á‡§Ç', found_pct: '‡§Æ‡§ø‡§≤‡§æ', more_resources: '‡§î‡§∞', kpi_items: '‡§Ü‡§á‡§ü‡§Æ', scope_title: '‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞', show_scope: '‡§¶‡•á‡§ñ‡•á‡§Ç'\n  }\n};\n\nconst L = LANGS[lang] || LANGS['EN'];\n\n// Update session with language data\nif (sd.sess && sd.sess[chatId]) { \n  sd.sess[chatId].db = L.db; \n  sd.sess[chatId].L = L; \n}\n\n// Get voice/PDF file IDs from session if available\nconst voiceFileId = sd.sess?.[chatId]?.voiceFileId || input.voiceFileId || null;\nconst pdfFileId = sd.sess?.[chatId]?.pdfFileId || input.pdfFileId || null;\nconst pdfFileName = sd.sess?.[chatId]?.pdfFileName || input.pdfFileName || null;\n\nreturn { \n  json: { \n    ...input, \n    L: L, \n    db: L.db, \n    voiceFileId,\n    pdfFileId,\n    pdfFileName,\n    // API Keys passthrough\n  } \n};"
      },
      "id": "c7df8929-0e08-4ff9-b5ec-550805e6918e",
      "name": "Config1",
      "type": "n8n-nodes-base.code",
      "position": [
        3120,
        6640
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// MAIN ROUTER - Text-Only Version\n// DDC CWICR - Data Driven Construction Cost Estimator\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst update = $('Telegram Trigger1').first().json;\nconst botToken = $input.first().json.bot_token;\nconst isCallback = !!update.callback_query;\n\nlet chatId, callbackData, callbackQueryId, text;\n\nif (isCallback) {\n  const cb = update.callback_query;\n  chatId = cb.message?.chat?.id;\n  callbackData = cb.data || '';\n  callbackQueryId = cb.id;\n  text = '';\n} else {\n  const msg = update.message || {};\n  chatId = msg.chat?.id;\n  callbackData = '';\n  callbackQueryId = '';\n  text = msg.text || '';\n}\n\nconst sd = $getWorkflowStaticData('global');\nif (!sd.sess) sd.sess = {};\nconst cid = String(chatId);\nif (!sd.sess[cid]) sd.sess[cid] = { \n  lang: null, works: [], state: 'new', db: null, L: null, description: ''\n};\nconst S = sd.sess[cid];\n\nlet action = 'none';\n\n// === COMMANDS ===\nif (text.toLowerCase() === '/start') {\n  S.lang = null; S.works = []; S.state = 'wait_lang'; S.db = null; S.L = null;\n  S.description = '';\n  action = 'show_lang';\n}\nelse if (text.toLowerCase() === '/help') {\n  action = 'show_help';\n}\n\n// === LANGUAGE SELECTION ===\nelse if (/^lang_(DE|EN|RU|ES|FR|PT|ZH|AR|HI)$/i.test(callbackData)) {\n  S.lang = callbackData.replace('lang_', '').toUpperCase();\n  S.state = 'wait_text';\n  action = 'lang_selected';\n}\n\n// === EDIT WORK ITEMS ===\nelse if (/^edit_work_(\\d+)$/.test(callbackData)) {\n  const idx = parseInt(callbackData.match(/edit_work_(\\d+)/)[1]);\n  S.editingWorkIndex = idx;\n  S.state = 'editing_work';\n  action = 'show_edit_menu';\n}\nelse if (/^delete_work_(\\d+)$/.test(callbackData)) {\n  const idx = parseInt(callbackData.match(/delete_work_(\\d+)/)[1]);\n  if (S.works[idx]) {\n    S.works.splice(idx, 1);\n    S.works.forEach((w, i) => { w.seq = i + 1; w.id = `W${String(i+1).padStart(3,'0')}`; });\n  }\n  action = 'works_updated';\n}\nelse if (/^qty_work_(\\d+)_(.+)$/.test(callbackData)) {\n  const match = callbackData.match(/qty_work_(\\d+)_(.+)/);\n  const idx = parseInt(match[1]);\n  const change = match[2];\n  if (S.works[idx]) {\n    let q = S.works[idx].qty;\n    if (change === 'plus10') q += 10;\n    else if (change === 'minus10') q = Math.max(1, q - 10);\n    else if (change === 'plus1') q += 1;\n    else if (change === 'minus1') q = Math.max(1, q - 1);\n    else if (change === 'double') q *= 2;\n    else if (change === 'half') q = Math.max(1, Math.round(q / 2));\n    S.works[idx].qty = q;\n  }\n  action = 'works_updated';\n}\nelse if (callbackData === 'add_work') {\n  S.state = 'adding_work';\n  action = 'ask_new_work';\n}\nelse if (callbackData === 'done_editing') {\n  S.state = 'works_shown';\n  action = 'works_updated';\n}\n\n// === CALCULATE ===\nelse if (callbackData === 'calculate') {\n  if (S.works && S.works.length > 0) {\n    S.state = 'calc';\n    action = 'start_calc';\n  } else {\n    action = 'lang_selected'; // show text prompt again\n  }\n}\n\n// === EXPORT ===\nelse if (callbackData === 'view_details') { action = 'view_details'; }\nelse if (callbackData === 'export_excel') { action = 'export_excel'; }\nelse if (callbackData === 'export_pdf') { action = 'export_pdf'; }\n\n// === RESTART ===\nelse if (callbackData === 'restart' || callbackData === 'new_estimate') {\n  S.works = []; S.description = ''; S.state = 'wait_text';\n  action = 'lang_selected';\n}\nelse if (callbackData === 'show_help' || callbackData === 'help') { action = 'show_help'; }\nelse if (callbackData === 'change_language' || callbackData === 'back_to_lang') {\n  S.lang = null; S.state = 'wait_lang';\n  action = 'show_lang';\n}\n\n// === TEXT INPUT ===\nelse if (text && S.state === 'adding_work') {\n  const parts = text.split(',');\n  const name = parts[0]?.trim() || text;\n  let qty = 1, unit = 'm¬≤';\n  if (parts[1]) {\n    const qtyMatch = parts[1].match(/([\\d.,]+)\\s*(.*)/);\n    if (qtyMatch) {\n      qty = parseFloat(qtyMatch[1].replace(',', '.')) || 1;\n      unit = qtyMatch[2]?.trim() || 'm¬≤';\n    }\n  }\n  S.works.push({\n    id: `W${String(S.works.length + 1).padStart(3,'0')}`,\n    name, query: name, qty, unit, conf: 'medium', seq: S.works.length + 1\n  });\n  S.state = 'works_shown';\n  action = 'works_updated';\n}\nelse if (text && S.lang && (S.state === 'wait_text' || S.state === 'new') && text.length > 3) {\n  S.description = text;\n  S.textInput = text;\n  action = 'analyze_text';\n}\n\n// === FALLBACKS ===\nelse if (!S.lang) { action = 'show_lang'; }\nelse if (!text && S.state === 'wait_text') { action = 'lang_selected'; }\n\nreturn { json: { \n  bot_token: botToken, chatId, action, lang: S.lang, works: S.works, \n  callbackData, callbackQueryId, isCallback, text,\n  description: S.description, editingWorkIndex: S.editingWorkIndex\n}};"
      },
      "id": "3bcbc766-e59c-4673-a4c5-db5ed0a13f7c",
      "name": "Main1",
      "type": "n8n-nodes-base.code",
      "position": [
        2864,
        6640
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "content": "## üîÑ Block 6: Calculation Loop\n\n**Per Work Item:**\n```\nPrep ‚Üí LLM Transform ‚Üí Embed ‚Üí \nQdrant Search ‚Üí Rerank ‚Üí Calculate\n```\n\n**Vector Search:**\n- OpenAI text-embedding-3-small\n- Qdrant similarity search\n- LLM reranking (best match)\n\n**Output per item:**\n- Matched rate code\n- Unit cost\n- Total cost\n- Resources breakdown\n- Scope of work",
        "height": 772,
        "width": 1936,
        "color": 3
      },
      "id": "832a4344-aa51-4e70-a760-2874ed7b4828",
      "name": "Block 6 - Calculation1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5008,
        7648
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üìä Block 7: Reports\n\n**Final Processing:**\n```\nAggregate ‚Üí Generate HTML ‚Üí Send\n```\n**Report Contents:**\n- Work items with costs\n- Resources (labor/material/machine)\n- Scope of work\n- Quality indicators\n- Cost breakdown charts",
        "height": 484,
        "width": 1928,
        "color": 6
      },
      "id": "00e4b628-0c19-4d32-9ca3-d45b0787e77b",
      "name": "Block 7 - Reports1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5008,
        7136
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üì• Block 8: Export\n\n**Available Exports:**\n- üìä **Excel (CSV)** ‚Äî Spreadsheet\n- üìÑ **PDF** ‚Äî Document\n- üåê **HTML** ‚Äî Interactive\n\n**View Details button:**\n- Full resource breakdown\n- Scope of work\n- Quality scores\n\n**Data includes:**\n- Rate codes\n- Unit prices\n- Labor hours\n- Material costs",
        "height": 692,
        "width": 1320,
        "color": 6
      },
      "id": "a070fee1-f249-47ae-8328-41b23393b529",
      "name": "Block 8 - Export1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3648,
        7136
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üîç Qdrant Vector DB\n\n**Collections (9 languages):**\n- `DDC_CWICR_DE` ‚Äî German\n- `DDC_CWICR_EN` ‚Äî English\n- `DDC_CWICR_RU` ‚Äî Russian\n- `DDC_CWICR_ES` ‚Äî Spanish\n- `DDC_CWICR_FR` ‚Äî French\n- `DDC_CWICR_PT` ‚Äî Portuguese\n- `DDC_CWICR_ZH` ‚Äî Chinese\n- `DDC_CWICR_AR` ‚Äî Arabic\n- `DDC_CWICR_HI` ‚Äî Hindi\n\n**Setup:**\n1. Install Qdrant\n2. Load collections from DDC repo\n3. Configure QDRANT_URL\n\n**Each collection:** ~55,000 vectors",
        "height": 528,
        "width": 380
      },
      "id": "b5f811cf-00b6-427e-a899-c8041fd914a2",
      "name": "Qdrant Info1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4592,
        7872
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Prep Text LLM Request (for AI Node)\n// Prepare prompt for text-to-works analysis\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config1').first().json;\nconst tokenConfig = $('üîë TOKEN1').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst L = cfg.L || {};\n\nconst textInput = cfg.text || session.textInput || cfg.textInput || cfg.description || '';\nconst searchLang = L.search_lang || 'English';\n\nconsole.log('=== PREP TEXT LLM ===');\nconsole.log('Input:', textInput);\nconsole.log('Language:', searchLang);\n\nif (!textInput || textInput.length < 3) {\n  return { json: { ...cfg, chatId: cid, _skip_llm: true, works: [], description: 'No input' }};\n}\n\n// Language-specific examples\nconst LANG_EXAMPLES = {\n  'German': {\n    input: 'Renovierung Badezimmer 8qm',\n    output: '[{\"name\": \"Fliesendemontage Wand Boden\", \"qty\": 24, \"unit\": \"m¬≤\"}, {\"name\": \"Wandfliesen Feinsteinzeug 30x60\", \"qty\": 16, \"unit\": \"m¬≤\"}, {\"name\": \"Bodenfliesen rutschfest\", \"qty\": 8, \"unit\": \"m¬≤\"}, {\"name\": \"WC wandh√§ngend montieren\", \"qty\": 1, \"unit\": \"pcs\"}, {\"name\": \"Waschtisch montieren\", \"qty\": 1, \"unit\": \"pcs\"}]'\n  },\n  'English': {\n    input: 'Bathroom renovation 8sqm',\n    output: '[{\"name\": \"Tile removal walls floor\", \"qty\": 24, \"unit\": \"m¬≤\"}, {\"name\": \"Wall tiles porcelain 30x60\", \"qty\": 16, \"unit\": \"m¬≤\"}, {\"name\": \"Floor tiles anti-slip\", \"qty\": 8, \"unit\": \"m¬≤\"}, {\"name\": \"Wall-hung toilet install\", \"qty\": 1, \"unit\": \"pcs\"}, {\"name\": \"Vanity basin install\", \"qty\": 1, \"unit\": \"pcs\"}]'\n  },\n  'Russian': {\n    input: '—Ä–µ–º–æ–Ω—Ç –∫—É—Ö–Ω–∏ 20–º2 —Å—Ç–µ–Ω—ã –∏ –ª–∞–º–∏–Ω–∞—Ç',\n    output: '[{\"name\": \"–î–µ–º–æ–Ω—Ç–∞–∂ —Å—Ç–∞—Ä—ã—Ö –æ–±–æ–µ–≤\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"–®—Ç—É–∫–∞—Ç—É—Ä–∫–∞ —Å—Ç–µ–Ω –≥–∏–ø—Å–æ–≤–∞—è\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"–®–ø–∞–∫–ª—ë–≤–∫–∞ —Å—Ç–µ–Ω —Ñ–∏–Ω–∏—à–Ω–∞—è\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"–û–∫—Ä–∞—Å–∫–∞ —Å—Ç–µ–Ω –≤–æ–¥–æ—ç–º—É–ª—å—Å–∏–æ–Ω–Ω–∞—è\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"–î–µ–º–æ–Ω—Ç–∞–∂ –Ω–∞–ø–æ–ª—å–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è\", \"qty\": 20, \"unit\": \"m¬≤\"}, {\"name\": \"–£–∫–ª–∞–¥–∫–∞ –ª–∞–º–∏–Ω–∞—Ç–∞ —Å –ø–æ–¥–ª–æ–∂–∫–æ–π\", \"qty\": 20, \"unit\": \"m¬≤\"}, {\"name\": \"–ú–æ–Ω—Ç–∞–∂ –ø–ª–∏–Ω—Ç—É—Å–∞\", \"qty\": 18, \"unit\": \"m\"}]'\n  },\n  'Spanish': {\n    input: 'reforma cocina 20m2 paredes y suelo',\n    output: '[{\"name\": \"Retirada papel pintado\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Enlucido paredes\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Pintura paredes\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Demolici√≥n suelo\", \"qty\": 20, \"unit\": \"m¬≤\"}, {\"name\": \"Tarima flotante\", \"qty\": 20, \"unit\": \"m¬≤\"}]'\n  },\n  'French': {\n    input: 'r√©novation cuisine 20m2 murs et sol',\n    output: '[{\"name\": \"D√©pose papier peint\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Enduit murs\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Peinture murs\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"D√©pose rev√™tement sol\", \"qty\": 20, \"unit\": \"m¬≤\"}, {\"name\": \"Pose parquet flottant\", \"qty\": 20, \"unit\": \"m¬≤\"}]'\n  },\n  'Portuguese': {\n    input: 'reforma cozinha 20m2 paredes e piso',\n    output: '[{\"name\": \"Remo√ß√£o papel parede\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Reboco paredes\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Pintura paredes\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Remo√ß√£o piso\", \"qty\": 20, \"unit\": \"m¬≤\"}, {\"name\": \"Piso laminado\", \"qty\": 20, \"unit\": \"m¬≤\"}]'\n  }\n};\n\nconst langExample = LANG_EXAMPLES[searchLang] || LANG_EXAMPLES['English'];\n\nconst parsePrompt = `You are a construction cost estimator. Extract ALL construction works from user's text.\n\nRULES:\n1. Output ONLY valid JSON array - NO explanations, NO markdown code blocks\n2. Generate works in ${searchLang} language  \n3. Be COMPREHENSIVE - include ALL works needed for described scope\n4. Use REALISTIC quantities based on area/room size mentioned\n5. Work names must be SPECIFIC for database search (not generic like \"wall work\")\n\nUNITS: m¬≤ (area), m (linear), pcs (items), kg, l\n\nEXAMPLE:\nInput: \"${langExample.input}\"\nOutput: ${langExample.output}\n\nUSER INPUT: \"${textInput}\"\n\nJSON ARRAY OUTPUT:`;\n\nconsole.log('Prompt prepared, length:', parsePrompt.length);\n\nreturn { json: { \n  ...cfg, \n  chatId: cid, \n  textInput,\n  description: textInput.substring(0, 50) + (textInput.length > 50 ? '...' : ''),\n  _parse_prompt: parsePrompt,\n  L\n}};"
      },
      "id": "88aadaaf-f554-4d09-b714-e88814e46ac7",
      "name": "Prep Text LLM1",
      "type": "n8n-nodes-base.code",
      "position": [
        3680,
        6512
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN1').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify($json.msg) }},\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": { \"inline_keyboard\": {{ JSON.stringify($json.keyboard) }} }\n}",
        "options": {}
      },
      "id": "5ac72104-9ead-42d6-a1b7-fe68a5cc9cc3",
      "name": "üì§ Edit Menu1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        3824,
        6688
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "content": "",
        "height": 448,
        "width": 320,
        "color": 6
      },
      "id": "5b457a77-fd57-4575-a59e-f501c50d43d6",
      "name": "Sticky Note21",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3648,
        6672
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "formTitle": "üì∏ Photo Cost Estimate Pro v2",
        "formDescription": "Upload a construction photo for automatic cost estimation.\nIMPROVED: Multi-stage AI decomposition for accurate work identification.\nPrices based on DDC CWICR regional databases (9 languages).",
        "formFields": {
          "values": [
            {
              "fieldLabel": "üì∑ Upload Photo",
              "fieldType": "file",
              "multipleFiles": false,
              "acceptFileTypes": ".jpg,.jpeg,.png,.webp",
              "requiredField": true
            },
            {
              "fieldLabel": "üåç Region & Language",
              "fieldType": "dropdown",
              "fieldOptions": {
                "values": [
                  {
                    "option": "üá©üá™ German - Berlin (EUR ‚Ç¨)"
                  },
                  {
                    "option": "üá¨üáß English - Toronto (CAD $)"
                  },
                  {
                    "option": "üá∑üá∫ Russian - St. Petersburg (RUB ‚ÇΩ)"
                  },
                  {
                    "option": "üá™üá∏ Spanish - Barcelona (EUR ‚Ç¨)"
                  },
                  {
                    "option": "üá´üá∑ French - Paris (EUR ‚Ç¨)"
                  },
                  {
                    "option": "üáßüá∑ Portuguese - S√£o Paulo (BRL R$)"
                  },
                  {
                    "option": "üá®üá≥ Chinese - Shanghai (CNY ¬•)"
                  },
                  {
                    "option": "üá¶üá™ Arabic - Dubai (AED ÿØ.ÿ•)"
                  },
                  {
                    "option": "üáÆüá≥ Hindi - Mumbai (INR ‚Çπ)"
                  }
                ]
              },
              "requiredField": true
            },
            {
              "fieldLabel": "üèóÔ∏è Work Type",
              "fieldType": "dropdown",
              "fieldOptions": {
                "values": [
                  {
                    "option": "üî® New Construction"
                  },
                  {
                    "option": "üîÑ Renovation / Remodel"
                  },
                  {
                    "option": "üîß Repair"
                  },
                  {
                    "option": "‚ùì Auto-detect"
                  }
                ]
              },
              "requiredField": true
            },
            {
              "fieldLabel": "üìù Description (optional)",
              "fieldType": "textarea",
              "placeholder": "Describe what's in the photo, specify dimensions, or add context..."
            }
          ]
        },
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "b656bb3a-a0cb-4201-8796-be0bde0abee1",
      "name": "Photo Upload Form",
      "type": "n8n-nodes-base.formTrigger",
      "position": [
        -4320,
        9168
      ],
      "webhookId": "3ca247ba-2fe8-4ff9-a71a-eab9b76d5bf4",
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// EXTRACT INPUT FROM FORM - 9 LANGUAGES + WORK TYPE\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst input = $input.first();\nconst formData = input.json || {};\n\nconst regionField = formData['üåç Region & Language'] || formData['Region & Language'] || '';\nconst workTypeField = formData['üèóÔ∏è Work Type'] || formData['Work Type'] || 'Auto-detect';\n\n// 9 languages mapping\nconst langMap = {\n  'German': 'DE',\n  'English': 'EN',\n  'Russian': 'RU',\n  'Spanish': 'ES',\n  'French': 'FR',\n  'Portuguese': 'PT',\n  'Chinese': 'ZH',\n  'Arabic': 'AR',\n  'Hindi': 'HI'\n};\n\nlet languageCode = 'EN';\nfor (const [lang, code] of Object.entries(langMap)) {\n  if (regionField.includes(lang)) {\n    languageCode = code;\n    break;\n  }\n}\n\n// Work type detection\nlet workType = 'auto';\nif (workTypeField.includes('New')) workType = 'new_construction';\nelse if (workTypeField.includes('Renovation')) workType = 'renovation';\nelse if (workTypeField.includes('Repair')) workType = 'repair';\n\nconst userDescription = formData['üìù Description (optional)'] || formData['Description (optional)'] || '';\n\nlet photoBase64 = '';\nlet photoMimeType = 'image/jpeg';\n\nif (input.binary) {\n  for (const key of Object.keys(input.binary)) {\n    const bin = input.binary[key];\n    if (bin.mimeType && bin.mimeType.startsWith('image/')) {\n      photoBase64 = bin.data;\n      photoMimeType = bin.mimeType;\n      break;\n    }\n  }\n}\n\nreturn {\n  json: {\n    language_code: languageCode,\n    photo_base64: photoBase64,\n    photo_mime_type: photoMimeType,\n    has_photo: photoBase64.length > 100,\n    user_description: userDescription,\n    selected_region: regionField,\n    work_type: workType\n  }\n};"
      },
      "id": "c1ec41b7-ef15-4cf0-90e1-83f1248f1ec1",
      "name": "Extract Input",
      "type": "n8n-nodes-base.code",
      "position": [
        -4096,
        9168
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// LANGUAGE & VECTOR DB CONFIGURATION - 9 LANGUAGES\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst input = $input.first().json;\nconst languageCode = (input.language_code || 'EN').toUpperCase();\n\nconst languageConfig = {\n  'DE': {\n    city: 'Berlin',\n    vectorDb: 'DE_BERLIN_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR',\n    language: 'German',\n    languageNative: 'Deutsch',\n    currency: 'EUR',\n    currencySymbol: '‚Ç¨',\n    locale: 'de-DE',\n    systemPromptLang: 'Antworte auf Deutsch.',\n    searchLang: 'German'\n  },\n  'EN': {\n    city: 'Toronto',\n    vectorDb: 'ENG_TORONTO_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR',\n    language: 'English',\n    languageNative: 'English',\n    currency: 'CAD',\n    currencySymbol: '$',\n    locale: 'en-CA',\n    systemPromptLang: 'Respond in English.',\n    searchLang: 'English'\n  },\n  'RU': {\n    city: 'St. Petersburg',\n    vectorDb: 'RU_STPETERSBURG_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR',\n    language: 'Russian',\n    languageNative: '–†—É—Å—Å–∫–∏–π',\n    currency: 'RUB',\n    currencySymbol: '‚ÇΩ',\n    locale: 'ru-RU',\n    systemPromptLang: '–û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.',\n    searchLang: 'Russian'\n  },\n  'FR': {\n    city: 'Paris',\n    vectorDb: 'FR_PARIS_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR',\n    language: 'French',\n    languageNative: 'Fran√ßais',\n    currency: 'EUR',\n    currencySymbol: '‚Ç¨',\n    locale: 'fr-FR',\n    systemPromptLang: 'R√©pondez en fran√ßais.',\n    searchLang: 'French'\n  },\n  'ES': {\n    city: 'Barcelona',\n    vectorDb: 'ES_BARCELONA_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR',\n    language: 'Spanish',\n    languageNative: 'Espa√±ol',\n    currency: 'EUR',\n    currencySymbol: '‚Ç¨',\n    locale: 'es-ES',\n    systemPromptLang: 'Responde en espa√±ol.',\n    searchLang: 'Spanish'\n  },\n  'PT': {\n    city: 'S√£o Paulo',\n    vectorDb: 'PT_SAOPAULO_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR',\n    language: 'Portuguese',\n    languageNative: 'Portugu√™s',\n    currency: 'BRL',\n    currencySymbol: 'R$',\n    locale: 'pt-BR',\n    systemPromptLang: 'Responda em portugu√™s.',\n    searchLang: 'Portuguese'\n  },\n  'ZH': {\n    city: 'Shanghai',\n    vectorDb: 'ZH_SHANGHAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR',\n    language: 'Chinese',\n    languageNative: '‰∏≠Êñá',\n    currency: 'CNY',\n    currencySymbol: '¬•',\n    locale: 'zh-CN',\n    systemPromptLang: 'ËØ∑Áî®‰∏≠ÊñáÂõûÁ≠î„ÄÇ',\n    searchLang: 'Chinese'\n  },\n  'AR': {\n    city: 'Dubai',\n    vectorDb: 'AR_DUBAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR',\n    language: 'Arabic',\n    languageNative: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',\n    currency: 'AED',\n    currencySymbol: 'ÿØ.ÿ•',\n    locale: 'ar-AE',\n    systemPromptLang: 'ÿ£ÿ¨ÿ® ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©.',\n    searchLang: 'Arabic'\n  },\n  'HI': {\n    city: 'Mumbai',\n    vectorDb: 'HI_MUMBAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR',\n    language: 'Hindi',\n    languageNative: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä',\n    currency: 'INR',\n    currencySymbol: '‚Çπ',\n    locale: 'hi-IN',\n    systemPromptLang: '‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§ú‡§µ‡§æ‡§¨ ‡§¶‡•á‡§Ç‡•§',\n    searchLang: 'Hindi'\n  }\n};\n\nconst config = languageConfig[languageCode] || languageConfig['EN'];\n\nreturn {\n  json: {\n    ...input,\n    language_code: languageCode,\n    language_config: config,\n    qdrant_collection: config.vectorDb,\n    city: config.city,\n    language: config.language,\n    language_native: config.languageNative,\n    currency: config.currency,\n    currency_symbol: config.currencySymbol,\n    locale: config.locale,\n    system_prompt_lang: config.systemPromptLang,\n    search_lang: config.searchLang,\n    pricing_level: config.city\n  }\n};"
      },
      "id": "787420d7-5932-402a-9f70-e983ada38a07",
      "name": "Configure Language",
      "type": "n8n-nodes-base.code",
      "position": [
        -3872,
        9168
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "operator": {
                "type": "boolean",
                "operation": "equals"
              },
              "leftValue": "={{ $json.has_photo }}",
              "rightValue": true
            }
          ]
        },
        "options": {}
      },
      "id": "fa61eb49-83ba-483e-9110-2cc56493c98f",
      "name": "Has Photo?",
      "type": "n8n-nodes-base.if",
      "position": [
        -3648,
        9168
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "return {\n  json: {\n    success: false,\n    error: true,\n    message: '‚ùå No photo provided',\n    html_content: '<!DOCTYPE html><html><head><meta charset=\"UTF-8\"></head><body style=\"font-family:system-ui;padding:40px;text-align:center;\"><h1>‚ùå Error</h1><p>No photo was uploaded. Please go back and upload a construction photo.</p></body></html>'\n  }\n};"
      },
      "id": "5dba9273-bb5a-4021-bf95-b895cfbcc1a7",
      "name": "Error No Photo",
      "type": "n8n-nodes-base.code",
      "position": [
        -3440,
        9328
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prompt",
              "name": "chatInput",
              "type": "string",
              "value": "=You are an expert construction surveyor. {{ $json.system_prompt_lang }}\n\n## STAGE 1: IDENTIFY ELEMENTS FROM PHOTO\n\nAnalyze this construction photo and identify ALL visible elements.\n\n### IDENTIFICATION RULES:\n1. **Identify ROOM TYPE** first (bathroom, kitchen, bedroom, living room, hallway, exterior, facade, roof, basement, utility)\n2. **List ALL visible construction elements** with their materials\n3. **Estimate dimensions** using reference objects:\n   - Standard door: 2.0m height, 0.9m width\n   - Standard window: 1.2m √ó 1.4m\n   - Ceiling height: typically 2.5-2.7m\n   - Brick: 25cm √ó 12cm √ó 6.5cm\n   - Tile: 30cm √ó 30cm or 60cm √ó 60cm\n   - Socket/switch: 8cm √ó 8cm\n\n{{ $json.user_description ? 'User note: ' + $json.user_description : '' }}\n\nReturn ONLY valid JSON (no markdown, no code blocks):\n{\n  \"room_type\": \"bathroom|kitchen|bedroom|living_room|hallway|exterior|facade|roof|basement|utility|other\",\n  \"room_description\": \"Brief description of what you see\",\n  \"estimated_dimensions\": {\n    \"floor_area_m2\": 0,\n    \"wall_area_m2\": 0,\n    \"ceiling_height_m\": 2.5,\n    \"perimeter_m\": 0\n  },\n  \"elements\": [\n    {\n      \"element_type\": \"wall|floor|ceiling|window|door|fixture|furniture|mep\",\n      \"element_name\": \"Descriptive name\",\n      \"material\": \"concrete|brick|drywall|tile|wood|glass|metal|plastic\",\n      \"surface_finish\": \"painted|tiled|plastered|wallpaper|raw|laminate\",\n      \"quantity\": 1,\n      \"unit\": \"m¬≤|m|pcs\",\n      \"estimated_size\": \"e.g. 3.5 m¬≤ or 2.1 m\",\n      \"condition\": \"new|good|worn|damaged\",\n      \"notes\": \"Any additional observations\"\n    }\n  ],\n  \"fixtures\": [\n    {\n      \"fixture_type\": \"toilet|sink|bathtub|shower|faucet|radiator|socket|switch|light|vent\",\n      \"quantity\": 1,\n      \"notes\": \"Description\"\n    }\n  ],\n  \"work_type_detected\": \"new_construction|renovation|repair\",\n  \"confidence\": \"high|medium|low\"\n}"
            }
          ]
        },
        "options": {}
      },
      "id": "31c7572f-c76f-4e0a-9295-074ff75c24c3",
      "name": "STAGE 1 Vision Prompt",
      "type": "n8n-nodes-base.set",
      "position": [
        -3440,
        9152
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "messages": {
          "messageValues": [
            {
              "message": "={{ $json.chatInput }}"
            }
          ]
        }
      },
      "id": "6e4da840-92de-48f6-9510-3ee88bbaf7b1",
      "name": "STAGE 1 Analyze Photo",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        -3216,
        9152
      ],
      "typeVersion": 1.4
    },
    {
      "parameters": {
        "options": {
          "maxOutputTokens": 4000,
          "temperature": 0.2
        }
      },
      "id": "a5d0ac14-97f3-47fe-80d6-f0916e26ef9b",
      "name": "GPT-4 Vision",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "position": [
        -3216,
        9360
      ],
      "typeVersion": 1,
      "credentials": {
        "googlePalmApi": {
          "id": "6iXMzd83cyZSS9j5",
          "name": "Gemini - googlePalmApi"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PARSE STAGE 1 VISION RESPONSE\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst aiResponse = $input.first().json;\nconst configData = $('Configure Language').first().json;\n\nlet parsed = {\n  room_type: 'unknown',\n  room_description: 'Analysis failed',\n  elements: [],\n  fixtures: [],\n  estimated_dimensions: { floor_area_m2: 10, wall_area_m2: 30, ceiling_height_m: 2.5, perimeter_m: 12 }\n};\n\ntry {\n  const content = aiResponse.text || aiResponse.content || aiResponse.response || '';\n  let jsonStr = content;\n  \n  const jsonMatch = content.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n  if (jsonMatch) {\n    jsonStr = jsonMatch[1];\n  } else {\n    const codeMatch = content.match(/```\\s*([\\s\\S]*?)\\s*```/);\n    if (codeMatch) {\n      jsonStr = codeMatch[1];\n    } else {\n      const objMatch = content.match(/\\{[\\s\\S]*\\}/);\n      if (objMatch) {\n        jsonStr = objMatch[0];\n      }\n    }\n  }\n  \n  parsed = JSON.parse(jsonStr);\n} catch (error) {\n  console.error('Parse error:', error.message);\n}\n\nreturn {\n  json: {\n    ...configData,\n    stage1_result: parsed,\n    room_type: parsed.room_type || 'unknown',\n    room_description: parsed.room_description || 'Photo analysis',\n    elements: parsed.elements || [],\n    fixtures: parsed.fixtures || [],\n    dimensions: parsed.estimated_dimensions || {},\n    work_type_detected: parsed.work_type_detected || configData.work_type || 'renovation',\n    confidence: parsed.confidence || 'medium'\n  }\n};"
      },
      "id": "e3bfad33-6193-4091-ad0a-b6ec03ca3daa",
      "name": "Parse STAGE 1",
      "type": "n8n-nodes-base.code",
      "position": [
        -2944,
        9152
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "prompt2",
              "name": "chatInput",
              "type": "string",
              "value": "={{ $json.system_prompt_lang }}\n\n## STAGE 4: DECOMPOSE ELEMENTS TO CONSTRUCTION WORKS\n\nYou are a construction cost estimator. Based on the photo analysis, decompose each element into specific construction work items.\n\n### PHOTO ANALYSIS RESULTS:\n- Room Type: {{ $json.room_type }}\n- Description: {{ $json.room_description }}\n- Work Type: {{ $json.work_type_detected }}\n- Dimensions: Floor {{ $json.dimensions.floor_area_m2 || 10 }} m¬≤, Walls {{ $json.dimensions.wall_area_m2 || 30 }} m¬≤\n\n### ELEMENTS DETECTED:\n{{ JSON.stringify($json.elements, null, 2) }}\n\n### FIXTURES DETECTED:\n{{ JSON.stringify($json.fixtures, null, 2) }}\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n## CATEGORY ‚Üí WORK ITEMS MAPPING (USE THIS!)\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n### BATHROOM:\n1. Demolition of old finishes (m¬≤) - if renovation\n2. Waterproofing floor (m¬≤)\n3. Waterproofing walls wet zone (m¬≤)\n4. Floor screed (m¬≤)\n5. Wall tiling (m¬≤)\n6. Floor tiling (m¬≤)\n7. Ceiling finishing (m¬≤)\n8. Toilet installation (pcs)\n9. Sink/washbasin installation (pcs)\n10. Bathtub installation (pcs) - if present\n11. Shower cabin installation (pcs) - if present\n12. Faucet/mixer installation (pcs)\n13. Towel rail installation (pcs)\n14. Mirror installation (pcs)\n15. Ventilation installation (pcs)\n16. Electrical: sockets, switches, lighting (pcs)\n17. Plumbing pipes (m)\n18. Door installation (pcs)\n\n### KITCHEN:\n1. Demolition of old finishes (m¬≤) - if renovation\n2. Wall preparation/plastering (m¬≤)\n3. Wall tiling (backsplash area) (m¬≤)\n4. Floor finishing (m¬≤)\n5. Ceiling finishing (m¬≤)\n6. Kitchen cabinets installation (m)\n7. Countertop installation (m)\n8. Sink installation (pcs)\n9. Faucet installation (pcs)\n10. Appliance connections (pcs)\n11. Electrical: sockets, switches (pcs)\n12. Lighting installation (pcs)\n13. Ventilation hood installation (pcs)\n14. Plumbing pipes (m)\n\n### LIVING ROOM / BEDROOM:\n1. Demolition of old finishes (m¬≤) - if renovation\n2. Wall preparation (m¬≤)\n3. Wall painting OR wallpaper (m¬≤)\n4. Floor preparation/screed (m¬≤)\n5. Floor covering - laminate/parquet/carpet (m¬≤)\n6. Baseboard/skirting installation (m)\n7. Ceiling finishing - paint/stretch/drywall (m¬≤)\n8. Electrical: sockets, switches (pcs)\n9. Lighting installation (pcs)\n10. Window sill finishing (m)\n11. Door installation (pcs)\n12. Radiator installation (pcs) - if visible\n\n### FLOOR WORKS:\n1. Old floor demolition (m¬≤) - if renovation\n2. Floor leveling/screed (m¬≤)\n3. Insulation (m¬≤) - if ground floor\n4. Underfloor heating (m¬≤) - if applicable\n5. Primer/preparation (m¬≤)\n6. Floor covering (m¬≤)\n7. Baseboard installation (m)\n\n### WALL WORKS:\n- Drywall: Metal framing (m¬≤) ‚Üí Insulation (m¬≤) ‚Üí Boarding (m¬≤) ‚Üí Jointing (m¬≤) ‚Üí Painting (m¬≤)\n- Masonry: Brickwork (m¬≤) ‚Üí Plastering (m¬≤) ‚Üí Painting (m¬≤)\n- Tiling: Wall preparation (m¬≤) ‚Üí Tiling (m¬≤) ‚Üí Grouting (m¬≤)\n\n### WINDOW WORKS:\n1. Old window demolition (pcs) - if renovation\n2. Window frame installation (pcs)\n3. Glazing (m¬≤)\n4. Internal sill (m)\n5. External sill (m)\n6. Sealing/foam (m)\n7. Trim/architrave (m)\n8. Painting/finishing (m)\n\n### DOOR WORKS:\n1. Old door demolition (pcs) - if renovation\n2. Door frame installation (pcs)\n3. Door leaf hanging (pcs)\n4. Hardware installation (pcs)\n5. Trim/architrave (m)\n6. Painting/finishing (m¬≤)\n\n### ELECTRICAL WORKS:\n1. Cable routing (m)\n2. Socket installation (pcs)\n3. Switch installation (pcs)\n4. Junction box (pcs)\n5. Lighting point (pcs)\n6. Panel/breaker installation (pcs)\n\n### PLUMBING WORKS:\n1. Pipe installation - supply (m)\n2. Pipe installation - drain (m)\n3. Valve installation (pcs)\n4. Connection to fixture (pcs)\n5. Pressure testing (pcs)\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n## CRITICAL RULES:\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n1. **NEVER return empty work_items** - minimum 3 works per element\n2. **Include PREPARATION works** - demolition, priming, leveling\n3. **Include FINISHING works** - painting, sealing, cleaning\n4. **Match units correctly**: areas‚Üím¬≤, lengths‚Üím, items‚Üípcs\n5. **For RENOVATION**: always include demolition/removal works first\n6. **Scale quantities** from dimensions provided\n7. **search_query must be in {{ $json.search_lang }}** for vector database\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nReturn ONLY valid JSON:\n{\n  \"work_items\": [\n    {\n      \"work_sequence\": 1,\n      \"work_category\": \"PREPARATION|MAIN|FINISHING|MEP\",\n      \"work_name\": \"Work name in {{ $json.language }}\",\n      \"search_query\": \"Search terms in {{ $json.search_lang }} for DDC CWICR database - be specific!\",\n      \"quantity\": 12.5,\n      \"unit\": \"m¬≤|m|pcs\",\n      \"calculation_basis\": \"floor_area √ó 1.0 = 12.5 m¬≤\",\n      \"source_element\": \"Which element this work is for\",\n      \"is_demolition\": false\n    }\n  ],\n  \"total_works_count\": 15,\n  \"phases\": [\"PREPARATION\", \"MAIN\", \"FINISHING\", \"MEP\"]\n}"
            }
          ]
        },
        "options": {}
      },
      "id": "bfea5f11-1f8e-4db2-92fb-7721da4b2ca2",
      "name": "STAGE 4 Decompose Prompt",
      "type": "n8n-nodes-base.set",
      "position": [
        -2768,
        9152
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "messages": {
          "messageValues": [
            {
              "message": "={{ $json.chatInput }}"
            }
          ]
        }
      },
      "id": "9d752418-8cf1-4412-bdb9-6df702b44d0e",
      "name": "STAGE 4 Decompose LLM",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "position": [
        -2544,
        9152
      ],
      "typeVersion": 1.4
    },
    {
      "parameters": {
        "options": {
          "maxOutputTokens": 8000,
          "temperature": 0.3
        }
      },
      "id": "d0674147-5165-49ae-8beb-b59b405b3932",
      "name": "GPT-4 Decompose",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "position": [
        -2544,
        9360
      ],
      "typeVersion": 1,
      "credentials": {
        "googlePalmApi": {
          "id": "6iXMzd83cyZSS9j5",
          "name": "Gemini - googlePalmApi"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PARSE STAGE 4 DECOMPOSITION RESPONSE\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst aiResponse = $input.first().json;\nconst configData = $('Parse STAGE 1').first().json;\n\nlet parsed = { work_items: [] };\n\ntry {\n  const content = aiResponse.text || aiResponse.content || aiResponse.response || '';\n  let jsonStr = content;\n  \n  const jsonMatch = content.match(/```json\\s*([\\s\\S]*?)\\s*```/);\n  if (jsonMatch) {\n    jsonStr = jsonMatch[1];\n  } else {\n    const objMatch = content.match(/\\{[\\s\\S]*\\}/);\n    if (objMatch) {\n      jsonStr = objMatch[0];\n    }\n  }\n  \n  parsed = JSON.parse(jsonStr);\n} catch (error) {\n  console.error('STAGE 4 Parse error:', error.message);\n}\n\n// Validate and enrich work items\nconst workItems = (parsed.work_items || []).map((work, idx) => {\n  // Ensure search_query exists and is meaningful\n  let searchQuery = work.search_query || work.work_name || '';\n  \n  // Add language-specific terms if needed\n  if (searchQuery.length < 5) {\n    searchQuery = work.work_name + ' ' + (work.source_element || '');\n  }\n  \n  return {\n    work_id: `W${String(idx + 1).padStart(3, '0')}`,\n    work_sequence: work.work_sequence || idx + 1,\n    work_category: work.work_category || 'MAIN',\n    work_name: work.work_name || 'Unnamed work',\n    search_query: searchQuery.trim(),\n    project_quantity: parseFloat(work.quantity) || 1,\n    unit: work.unit || 'm¬≤',\n    calculation_basis: work.calculation_basis || '',\n    source_element: work.source_element || '',\n    is_demolition: work.is_demolition || false\n  };\n});\n\n// Sort by sequence\nworkItems.sort((a, b) => a.work_sequence - b.work_sequence);\n\nreturn {\n  json: {\n    ...configData,\n    work_items: workItems,\n    works_count: workItems.length,\n    phases: parsed.phases || ['PREPARATION', 'MAIN', 'FINISHING', 'MEP'],\n    stage4_success: workItems.length >= 3\n  }\n};"
      },
      "id": "92aec9ac-8f3f-41bd-aa08-3f02fca448a0",
      "name": "Parse STAGE 4",
      "type": "n8n-nodes-base.code",
      "position": [
        -2256,
        9152
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PREPARE WORKS FOR LOOP\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst data = $input.first().json;\nconst works = data.work_items || [];\n\nconst staticData = $getWorkflowStaticData('global');\nstaticData.photo_config = {\n  language_code: data.language_code,\n  language: data.language,\n  currency: data.currency,\n  currency_symbol: data.currency_symbol,\n  locale: data.locale,\n  city: data.city,\n  qdrant_collection: data.qdrant_collection,\n  room_type: data.room_type,\n  room_description: data.room_description,\n  dimensions: data.dimensions,\n  work_type_detected: data.work_type_detected,\n  phases: data.phases,\n  elements: data.elements,\n  fixtures: data.fixtures\n};\nstaticData.work_results = [];\n\nif (works.length === 0) {\n  return [{ json: { _no_works: true, message: 'No work items generated' } }];\n}\n\nreturn works.map((work) => ({\n  json: {\n    ...work,\n    expected_unit: work.unit,\n    type_name: work.work_name,\n    category: work.work_category,\n    assigned_phase: work.work_category,\n    qdrant_collection: data.qdrant_collection,\n    language: data.language,\n    currency: data.currency,\n    currency_symbol: data.currency_symbol,\n    locale: data.locale\n  }\n}));"
      },
      "id": "b67b7be2-32f4-4982-a62a-d194444c3ee4",
      "name": "Prepare Works",
      "type": "n8n-nodes-base.code",
      "position": [
        -2080,
        9152
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "id": "721ddd1e-5f9e-424b-b064-f6faf997c4f7",
      "name": "Loop Works",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [
        -1888,
        9152
      ],
      "typeVersion": 3
    },
    {
      "parameters": {
        "jsCode": "// Store current work item for Vector Search\nconst work = $input.first().json;\nconst staticData = $getWorkflowStaticData('global');\nstaticData.currentWork = work;\nreturn { json: work };"
      },
      "id": "747a3edb-dc4b-481b-8eb3-df3861b78831",
      "name": "Store Work Data",
      "type": "n8n-nodes-base.code",
      "position": [
        -1408,
        9360
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "amount": 0.3
      },
      "id": "6a7c61dd-de41-4a9c-a297-9a45ff14523b",
      "name": "Wait",
      "type": "n8n-nodes-base.wait",
      "position": [
        -1264,
        9360
      ],
      "webhookId": "wait-photo-v3",
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "jsCode": "// Restore work data from staticData after Wait\nconst staticData = $getWorkflowStaticData('global');\nconst work = staticData.currentWork || {};\nreturn { json: work };"
      },
      "id": "3d6b58ed-1729-4049-a2e1-389c42552bf3",
      "name": "Restore Work Data",
      "type": "n8n-nodes-base.code",
      "position": [
        -1120,
        9360
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "mode": "load",
        "qdrantCollection": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.qdrant_collection }}"
        },
        "prompt": "={{ $json.search_query || $json.work_name }}",
        "topK": 5,
        "options": {
          "contentPayloadKey": "content"
        }
      },
      "id": "f205e1fc-9b3c-4481-9b5c-2661d09f5a46",
      "name": "Vector Search",
      "type": "@n8n/n8n-nodes-langchain.vectorStoreQdrant",
      "position": [
        -960,
        9360
      ],
      "typeVersion": 1.1
    },
    {
      "parameters": {
        "modelName": "models/gemini-embedding-001"
      },
      "id": "73a9bcb2-b5bc-4f39-abd1-8b9f1e53b87a",
      "name": "Embeddings",
      "type": "@n8n/n8n-nodes-langchain.embeddingsGoogleGemini",
      "position": [
        -976,
        9520
      ],
      "typeVersion": 1,
      "credentials": {
        "googlePalmApi": {
          "id": "6iXMzd83cyZSS9j5",
          "name": "Gemini - googlePalmApi"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// STAGE 5: PARSE & VALIDATE VECTOR SEARCH RESULTS\n// FIXED: Correct document/pageContent extraction\n// Quality scoring v2.0 + Resource extraction\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst searchResults = $input.all();\nconst staticData = $getWorkflowStaticData('global');\nconst workData = staticData.currentWork || {};\n\n// MACHINE/LABOR PATTERNS (9 languages)\nconst MACHINE_PATTERNS = ['masch', 'maschinenstunde', 'ger√§t', 'machine', 'mach-h', 'equipment', 'heure machine', 'engin', 'm√°quina', 'equipo', 'equipamento', '–º–∞—à–∏–Ω', '–º–∞—à-—á', '–º–∞—à.—á', '–º–∞—à.-—á', '–º–µ—Ö–∞–Ω–∏–∑–º', 'Êú∫Âô®', 'Êú∫Ê¢∞', 'ËÆæÂ§á', 'Âè∞Áè≠', 'ÿ¢ŸÑÿ©', 'ŸÖÿπÿØÿ©', '‡§Æ‡§∂‡•Ä‡§®', '‡§Ø‡§Ç‡§§‡•ç‡§∞'];\nconst LABOR_PATTERNS = ['std', 'stunde', 'arbeiter', 'hour', 'man-hour', 'labor', 'worker', 'heure', 'ouvrier', 'hora', 'obrero', 'oper√°rio', '—á-—á', '—á–µ–ª-—á', '—á–µ–ª–æ–≤–µ–∫–æ-—á–∞—Å', '—Ç—Ä—É–¥', '—Ä–∞–±–æ—á–∏–π', '—Ä–∞–∑—Ä—è–¥', ' —á', 'Â∑•Êó∂', '‰∫∫Â∑•', 'Â∑•‰∫∫', 'ÿ≥ÿßÿπÿ©', 'ÿπÿßŸÖŸÑ', '‡§ò‡§Ç‡§ü‡§æ', '‡§∂‡•ç‡§∞‡§Æ', '‡§Æ‡§ú‡§¶‡•Ç‡§∞'];\n\nfunction detectResourceType(unit, name, code) {\n  const combined = ((unit || '') + ' ' + (name || '') + ' ' + (code || '')).toLowerCase();\n  if (MACHINE_PATTERNS.some(p => combined.includes(p.toLowerCase()))) return 'machine';\n  if (LABOR_PATTERNS.some(p => combined.includes(p.toLowerCase()))) return 'labor';\n  return 'material';\n}\n\nfunction normalizeUnit(unit) {\n  if (!unit) return '';\n  const u = unit.toLowerCase().trim();\n  const unitGroups = {\n    'm2': ['m¬≤', 'm2', 'qm', '–∫–≤–º', '–∫–≤.–º', '–∫–≤. –º', 'sq.m', 'sqm', 'Âπ≥ÊñπÁ±≥'],\n    'm3': ['m¬≥', 'm3', 'cbm', '–∫—É–±.–º', '–∫—É–±. –º', 'cu.m', 'Á´ãÊñπÁ±≥'],\n    'm': ['m', '–º', 'lm', 'lfm', '–ø.–º', '–ø. –º', 'lin.m', 'Á±≥'],\n    'stk': ['stk', 'st√ºck', 'st', '—à—Ç', '—à—Ç.', 'pcs', 'ea', 'each', 'unit', '‰∏™', '‰ª∂'],\n    '100m2': ['100 m¬≤', '100m¬≤', '100 m2', '100m2', '100 qm', '100 –∫–≤.–º']\n  };\n  for (const [normalized, variants] of Object.entries(unitGroups)) {\n    if (variants.some(v => u === v || u.includes(v))) return normalized;\n  }\n  return u;\n}\n\n// MATERIAL KEYWORDS for matching\nconst MATERIAL_KEYWORDS = [\n  'aluminum', 'aluminium', 'alu', '–∞–ª—é–º–∏–Ω',\n  'wood', 'holz', '–¥–µ—Ä–µ–≤', '–¥—Ä–µ–≤–µ—Å', 'Êú®',\n  'plastic', 'pvc', 'kunststoff', '–ø–ª–∞—Å—Ç–∏–∫', '–ø–≤—Ö',\n  'steel', 'stahl', '—Å—Ç–∞–ª', '–º–µ—Ç–∞–ª–ª', 'Èí¢',\n  'concrete', 'beton', '–±–µ—Ç–æ–Ω', 'Ê∑∑ÂáùÂúü',\n  'glass', 'glas', '—Å—Ç–µ–∫–ª', 'ÁéªÁíÉ',\n  'brick', 'ziegel', '–∫–∏—Ä–ø–∏—á', 'Á†ñ',\n  'tile', 'fliese', '–ø–ª–∏—Ç–∫', '–∫–∞—Ñ–µ–ª—å', 'Áì∑Á†ñ',\n  'ceramic', 'keramik', '–∫–µ—Ä–∞–º–∏–∫', 'Èô∂Áì∑',\n  'gypsum', 'gips', '–≥–∏–ø—Å', 'Áü≥ËÜè',\n  'drywall', '–≥–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω', '–≥–∫–ª',\n  'paint', 'farbe', '–∫—Ä–∞—Å–∫', 'Ê≤πÊºÜ',\n  'wallpaper', 'tapete', '–æ–±–æ', 'Â£ÅÁ∫∏',\n  'laminate', 'laminat', '–ª–∞–º–∏–Ω–∞—Ç',\n  'parquet', 'parkett', '–ø–∞—Ä–∫–µ—Ç'\n];\n\n// WORK TYPE KEYWORDS for matching\nconst WORK_TYPE_KEYWORDS = [\n  'installation', 'montage', '—É—Å—Ç–∞–Ω–æ–≤–∫', '–º–æ–Ω—Ç–∞–∂', 'ÂÆâË£Ö',\n  'demolition', 'abbruch', '–¥–µ–º–æ–Ω—Ç–∞–∂', '—Å–Ω–æ—Å', '—Ä–∞–∑–±–æ—Ä', 'ÊãÜÈô§',\n  'preparation', 'vorbereitung', '–ø–æ–¥–≥–æ—Ç–æ–≤', 'ÂáÜÂ§á',\n  'sealing', 'abdichtung', '–≥–µ—Ä–º–µ—Ç–∏–∑', '–≥–∏–¥—Ä–æ–∏–∑–æ–ª', 'ÂØÜÂ∞Å',\n  'insulation', 'd√§mmung', '–∏–∑–æ–ª—è—Ü', '—É—Ç–µ–ø–ª', '‰øùÊ∏©',\n  'finishing', '–æ—Ç–¥–µ–ª–∫', 'finish', 'Ë£Ö‰øÆ',\n  'excavation', 'aushub', '–≤—ã–µ–º–∫', '–∫–æ–ø–∞–Ω', 'ÂºÄÊåñ',\n  'concrete', 'beton', '–±–µ—Ç–æ–Ω–∏—Ä', 'Ê∑∑ÂáùÂúü',\n  'reinforcement', 'bewehrung', '–∞—Ä–º–∏—Ä', 'Èí¢Á≠ã',\n  'plastering', 'putz', '—à—Ç—É–∫–∞—Ç—É—Ä', 'ÊäπÁÅ∞',\n  'painting', 'malen', 'anstrich', '–æ–∫—Ä–∞—Å–∫', '–ø–æ–∫—Ä–∞—Å–∫', 'Ê≤πÊºÜ',\n  'tiling', 'fliesen', '–æ–±–ª–∏—Ü–æ–≤', '—É–∫–ª–∞–¥–∫ –ø–ª–∏—Ç–∫', 'Ë¥¥Á†ñ',\n  'flooring', 'boden', '–Ω–∞–ø–æ–ª—å–Ω', '–ø–æ–ª', 'Âú∞Êùø',\n  'roofing', 'dach', '–∫—Ä–æ–≤–ª', 'Â±ãÈù¢',\n  'plumbing', 'sanit√§r', '—Å–∞–Ω—Ç–µ—Ö–Ω', 'ÁÆ°ÈÅì',\n  'electrical', 'elektro', '—ç–ª–µ–∫—Ç—Ä', 'ÁîµÊ∞î'\n];\n\n// NOT FOUND FALLBACK\nif (!searchResults || searchResults.length === 0) {\n  return [{\n    json: {\n      ...workData,\n      rate_code: 'NOT_FOUND',\n      rate_name: '[Not Found] ' + (workData.work_name || 'Unknown'),\n      rate_unit: workData.expected_unit || 'm¬≤',\n      unit_cost: 0,\n      total_cost: 0,\n      estimated_labor_hours: 0,\n      quality_level: 'not_found',\n      quality_score: 0,\n      quality_reason: 'No search results',\n      resources_all: [],\n      cost_breakdown: { workers: 0, machines: 0, materials: 0 }\n    }\n  }];\n}\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// FIX: CORRECT EXTRACTION OF document.pageContent\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst parsedResults = searchResults.map((item) => {\n  const data = item.json || {};\n  \n  // FIX: Handle nested document structure from Vector Search\n  const doc = data.document || {};\n  const content = String(doc.pageContent || doc.content || data.pageContent || data.content || '');\n  const metadata = doc.metadata || data.metadata || {};\n  const score = data.score || 0;\n  \n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // EXTRACT TOTAL COST from \"Total cost: 3127.16 EUR\"\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  let totalCost = 0;\n  const costPatterns = [\n    /Total\\s*cost:\\s*([\\d.,]+)\\s*(?:EUR|USD|RUB|CAD|CNY|AED|INR|BRL)/i,\n    /Resources?\\s*cost:\\s*([\\d.,]+)/i,\n    /(?:Gesamt|–ò–¢–û–ì–û|–í—Å–µ–≥–æ|–°—Ç–æ–∏–º–æ—Å—Ç—å)[^\\d]*([\\d.,]+)/i,\n    /(?:EUR|USD|RUB|CAD|\\$|‚Ç¨|‚ÇΩ)\\s*([\\d.,]+)/i\n  ];\n  for (const pattern of costPatterns) {\n    const match = content.match(pattern);\n    if (match) {\n      totalCost = parseFloat(match[1].replace(/,/g, '.').replace(/\\s/g, '')) || 0;\n      if (totalCost > 0) break;\n    }\n  }\n  \n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // EXTRACT CODE, NAME, UNIT from content if not in metadata\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  let rateCode = metadata.rsts || metadata.code || '';\n  let rateName = metadata.names || metadata.name || '';\n  let rateUnit = metadata.unit || '';\n  \n  // Fallback: extract from content\n  if (!rateCode) {\n    const codeMatch = content.match(/CODE:\\s*([A-Z–ê-–Øa-z–∞-—è0-9_-]+)/i);\n    if (codeMatch) rateCode = codeMatch[1];\n  }\n  if (!rateName) {\n    const nameMatch = content.match(/NAME:\\s*(.+?)(?:\\n|UNIT:|CATEGORY:)/i);\n    if (nameMatch) rateName = nameMatch[1].trim();\n  }\n  if (!rateUnit) {\n    const unitMatch = content.match(/UNIT:\\s*(.+?)(?:\\n|CATEGORY:)/i);\n    if (unitMatch) rateUnit = unitMatch[1].trim();\n  }\n  \n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // EXTRACT LABOR HOURS\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  let laborHours = 0;\n  const laborMatch = content.match(/(?:—Ä–∞–∑—Ä—è–¥|worker|arbeiter|labor)[^‚Äî\\n]*‚Äî\\s*([\\d.,]+)\\s*(?:—á|—á–∞—Å|std|hour|h)/i);\n  if (laborMatch) {\n    laborHours = parseFloat(laborMatch[1].replace(',', '.')) || 0;\n  }\n  \n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // EXTRACT RESOURCES from RESOURCES: section\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  const resources = [];\n  const resourcesSection = content.match(/RESOURCES:\\s*([\\s\\S]*?)(?:$|MACHINES:|SCOPE|CLASSIFICATION:)/i);\n  if (resourcesSection) {\n    const resourcesText = resourcesSection[1];\n    const resourceLines = resourcesText.split('\\n').filter(line => line.trim().startsWith('-'));\n    \n    for (const line of resourceLines) {\n      const resMatch = line.match(/^-\\s*([A-Z–ê-–Øa-z–∞-—è0-9_-]+)\\s*[‚Äî‚Äì-]\\s*(.+?)\\s*[‚Äî‚Äì-]\\s*([\\d.,]+)\\s*(.+?)$/i);\n      if (resMatch) {\n        const resCode = resMatch[1].trim();\n        const resName = resMatch[2].trim();\n        const resQty = parseFloat(resMatch[3].replace(',', '.')) || 0;\n        const resUnit = resMatch[4].trim();\n        const resType = detectResourceType(resUnit, resName, resCode);\n        \n        resources.push({\n          resource_code: resCode,\n          resource_name: resName,\n          resource_quantity: resQty,\n          resource_unit: resUnit,\n          resource_cost: 0,\n          resource_type: resType\n        });\n      }\n    }\n  }\n  \n  return {\n    rate_code: rateCode,\n    rate_name: rateName,\n    rate_unit: rateUnit,\n    total_cost_position: totalCost,\n    worker_labor_hours: laborHours,\n    hierarchy: metadata.hierarchy || '',\n    resources: resources,\n    resources_count: resources.length,\n    vector_score: score,\n    content_preview: content.substring(0, 300)\n  };\n});\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// QUALITY SCORING v2.0\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst expectedUnit = normalizeUnit(workData.expected_unit || workData.unit || '');\nconst searchQuery = (workData.search_query || workData.work_name || '').toLowerCase();\nconst workName = (workData.work_name || '').toLowerCase();\n\nconst scoredResults = parsedResults.map(result => {\n  let score = 0;\n  const factors = [];\n  const resultUnit = normalizeUnit(result.rate_unit);\n  const rateName = (result.rate_name || '').toLowerCase();\n  const rateContent = (result.content_preview || '').toLowerCase();\n  const combined = rateName + ' ' + rateContent;\n  \n  if (result.total_cost_position > 0) { \n    score += 30; \n    factors.push('has_price:' + result.total_cost_position.toFixed(0)); \n  }\n  \n  if (result.resources_count > 0) { \n    score += Math.min(25, result.resources_count * 5); \n    factors.push('resources:' + result.resources_count); \n  }\n  \n  if (resultUnit && expectedUnit) {\n    if (resultUnit === expectedUnit) { \n      score += 20; \n      factors.push('unit_exact'); \n    } else if (resultUnit.includes(expectedUnit) || expectedUnit.includes(resultUnit)) { \n      score += 10; \n      factors.push('unit_partial'); \n    }\n  }\n  \n  const materialMatches = MATERIAL_KEYWORDS.filter(kw => \n    (workName.includes(kw) || searchQuery.includes(kw)) && combined.includes(kw)\n  );\n  if (materialMatches.length > 0) {\n    score += 15;\n    factors.push('material:' + materialMatches[0]);\n  }\n  \n  const workTypeMatches = WORK_TYPE_KEYWORDS.filter(kw => \n    (workName.includes(kw) || searchQuery.includes(kw)) && combined.includes(kw)\n  );\n  if (workTypeMatches.length > 0) {\n    score += 10;\n    factors.push('work_type:' + workTypeMatches[0]);\n  }\n  \n  const queryWords = searchQuery.split(/\\s+/).filter(w => w.length > 3);\n  const matchedWords = queryWords.filter(w => rateName.includes(w) || rateContent.includes(w));\n  if (matchedWords.length > 0) { \n    score += Math.min(15, matchedWords.length * 5); \n    factors.push('words:' + matchedWords.length); \n  }\n  \n  if (result.vector_score > 0.5) {\n    score += 10;\n    factors.push('vscore:' + result.vector_score.toFixed(2));\n  } else if (result.vector_score > 0.4) {\n    score += 5;\n    factors.push('vscore:' + result.vector_score.toFixed(2));\n  }\n  \n  const hasLabor = result.resources.some(r => r.resource_type === 'labor');\n  const hasMaterial = result.resources.some(r => r.resource_type === 'material');\n  if (hasLabor && hasMaterial) {\n    score += 5;\n    factors.push('complete_rate');\n  }\n  \n  return { ...result, quality_score: score, quality_factors: factors };\n});\n\nconst sorted = scoredResults.sort((a, b) => b.quality_score - a.quality_score);\nconst best = sorted[0] || { quality_score: 0, quality_factors: [], resources: [] };\n\nlet qualityLevel = 'not_found';\nconst s = best.quality_score;\nif (s >= 60) { qualityLevel = 'high'; }\nelse if (s >= 40) { qualityLevel = 'medium'; }\nelse if (s >= 20) { qualityLevel = 'low'; }\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// CALCULATE COSTS\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst projectQuantity = workData.project_quantity || 0;\nconst unitCost = best.total_cost_position || 0;\n\nlet unitDivisor = 1;\nconst rateUnit = (best.rate_unit || '').toLowerCase();\nif (rateUnit.includes('100')) unitDivisor = 100;\nelse if (rateUnit.includes('10 ')) unitDivisor = 10;\n\nconst quantityInRateUnits = projectQuantity / unitDivisor;\nconst totalCost = quantityInRateUnits * unitCost;\nconst estimatedLaborHours = (best.worker_labor_hours || 0) * quantityInRateUnits;\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// SCALE & CATEGORIZE RESOURCES\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nlet laborCost = 0, machineCost = 0, materialCost = 0;\nconst scaledResources = (best.resources || []).map(r => {\n  const scaledQty = (r.resource_quantity || 0) * quantityInRateUnits;\n  const scaledCost = (r.resource_cost || 0) * quantityInRateUnits;\n  \n  if (r.resource_type === 'labor') laborCost += scaledCost;\n  else if (r.resource_type === 'machine') machineCost += scaledCost;\n  else materialCost += scaledCost;\n  \n  return { ...r, scaled_quantity: scaledQty, scaled_cost: scaledCost };\n});\n\nif (laborCost === 0 && materialCost === 0 && totalCost > 0) {\n  laborCost = totalCost * 0.35;\n  materialCost = totalCost * 0.55;\n  machineCost = totalCost * 0.10;\n}\n\nreturn [{\n  json: {\n    work_id: workData.work_id,\n    work_sequence: workData.work_sequence,\n    work_category: workData.work_category,\n    work_name: workData.work_name,\n    source_element: workData.source_element,\n    calculation_basis: workData.calculation_basis,\n    is_demolition: workData.is_demolition,\n    rate_code: best.rate_code || 'NOT_FOUND',\n    rate_name: best.rate_name || workData.work_name || 'Not found',\n    rate_unit: best.rate_unit || workData.expected_unit,\n    project_quantity: projectQuantity,\n    project_unit: workData.unit || workData.expected_unit,\n    quantity_in_rate_units: quantityInRateUnits,\n    calculated_quantity: quantityInRateUnits,\n    unit_divisor: unitDivisor,\n    unit_cost: unitCost,\n    total_cost: totalCost,\n    estimated_labor_hours: estimatedLaborHours,\n    quality_level: qualityLevel,\n    quality_score: s,\n    quality_reason: 'Score ' + s + '/100: ' + best.quality_factors.join(', '),\n    currency: workData.currency,\n    currency_symbol: workData.currency_symbol,\n    locale: workData.locale,\n    type_name: workData.type_name,\n    category: workData.category,\n    assigned_phase: workData.assigned_phase,\n    resources_all: scaledResources,\n    cost_breakdown: {\n      workers: laborCost,\n      machines: machineCost,\n      materials: materialCost\n    },\n    calculation_details: {\n      method: 'photo_analysis',\n      calculation_basis: workData.calculation_basis,\n      raw_value: projectQuantity,\n      unit_divisor: unitDivisor,\n      formula_display: (workData.unit || 'Qty') + ' = ' + projectQuantity\n    },\n    search_debug: {\n      query_used: workData.search_query,\n      results_count: searchResults.length,\n      best_match_score: s,\n      best_vector_score: best.vector_score || 0,\n      best_rate_found: best.rate_name || 'none'\n    }\n  }\n}];"
      },
      "id": "89444bb8-5d4e-409f-8c56-019eef50b931",
      "name": "STAGE 5 Parse & Score",
      "type": "n8n-nodes-base.code",
      "position": [
        -704,
        9360
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ACCUMULATE RESULTS\nconst staticData = $getWorkflowStaticData('global');\nconst work = $input.first().json;\nif (!staticData.work_results) staticData.work_results = [];\nstaticData.work_results.push(work);\nreturn { json: work };"
      },
      "id": "58250821-3818-4179-9d78-4915687eeffe",
      "name": "Accumulate",
      "type": "n8n-nodes-base.code",
      "position": [
        -560,
        9360
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// STAGE 7.5: AGGREGATE & VALIDATE RESULTS\n// Build by_phase structure with validation\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst staticData = $getWorkflowStaticData('global');\nconst config = staticData.photo_config || {};\nconst works = staticData.work_results || [];\n\n// Calculate totals\nlet grandTotal = 0, grandHours = 0;\nlet grandLaborCost = 0, grandMaterialCost = 0, grandMachineCost = 0;\nlet qHigh = 0, qMedium = 0, qLow = 0, qNotFound = 0;\n\nworks.forEach(w => {\n  grandTotal += w.total_cost || 0;\n  grandHours += w.estimated_labor_hours || 0;\n  \n  const cb = w.cost_breakdown || {};\n  grandLaborCost += cb.workers || 0;\n  grandMaterialCost += cb.materials || 0;\n  grandMachineCost += cb.machines || 0;\n  \n  if (w.quality_level === 'high') qHigh++;\n  else if (w.quality_level === 'medium') qMedium++;\n  else if (w.quality_level === 'low') qLow++;\n  else qNotFound++;\n});\n\n// Sort by sequence\nworks.sort((a, b) => (a.work_sequence || 0) - (b.work_sequence || 0));\n\n// Group by category (PREPARATION, MAIN, FINISHING, MEP)\nconst categories = {};\nworks.forEach(w => {\n  const cat = w.work_category || 'MAIN';\n  if (!categories[cat]) {\n    categories[cat] = {\n      works: [],\n      total_cost: 0,\n      labor_hours: 0\n    };\n  }\n  categories[cat].works.push(w);\n  categories[cat].total_cost += w.total_cost || 0;\n  categories[cat].labor_hours += w.estimated_labor_hours || 0;\n});\n\n// Build by_phase structure\nconst phaseOrder = ['PREPARATION', 'MAIN', 'FINISHING', 'MEP'];\nconst byPhase = phaseOrder\n  .filter(phase => categories[phase])\n  .map((phase, idx) => {\n    const cat = categories[phase];\n    const phaseName = {\n      'PREPARATION': config.language_code === 'RU' ? '–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã' : \n                     config.language_code === 'DE' ? 'Vorbereitungsarbeiten' : 'Preparation Works',\n      'MAIN': config.language_code === 'RU' ? '–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∞–±–æ—Ç—ã' : \n              config.language_code === 'DE' ? 'Hauptarbeiten' : 'Main Works',\n      'FINISHING': config.language_code === 'RU' ? '–û—Ç–¥–µ–ª–æ—á–Ω—ã–µ —Ä–∞–±–æ—Ç—ã' : \n                   config.language_code === 'DE' ? 'Ausbauarbeiten' : 'Finishing Works',\n      'MEP': config.language_code === 'RU' ? '–ò–Ω–∂–µ–Ω–µ—Ä–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã' : \n             config.language_code === 'DE' ? 'Haustechnik' : 'MEP Systems'\n    }[phase] || phase;\n    \n    return {\n      phase_name: phaseName,\n      phase_code: phase,\n      phase_total_cost: cat.total_cost,\n      phase_labor_hours: cat.labor_hours,\n      types: [{\n        type_name: config.room_description || 'Photo Analysis',\n        category: config.room_type || 'General',\n        element_count: cat.works.length,\n        type_total_cost: cat.total_cost,\n        type_total_labor_hours: cat.labor_hours,\n        works: cat.works\n      }]\n    };\n  });\n\n// VALIDATION CHECKS\nconst validationIssues = [];\n\nif (works.length < 3) {\n  validationIssues.push('‚ö†Ô∏è Less than 3 work items generated');\n}\n\nconst foundPercent = works.length > 0 ? Math.round((qHigh + qMedium + qLow) / works.length * 100) : 0;\nif (foundPercent < 50) {\n  validationIssues.push('‚ö†Ô∏è Less than 50% rates found - manual review needed');\n}\n\nconst zeroCostCount = works.filter(w => w.total_cost === 0).length;\nif (zeroCostCount > works.length * 0.3) {\n  validationIssues.push('‚ö†Ô∏è Many items with zero cost - database coverage issue');\n}\n\nif (config.work_type_detected === 'renovation') {\n  const hasDemolition = works.some(w => w.is_demolition || \n    (w.work_name || '').toLowerCase().match(/–¥–µ–º–æ–Ω—Ç–∞–∂|—Å–Ω–æ—Å|—Ä–∞–∑–±–æ—Ä|demolition|abbruch|removal/));\n  if (!hasDemolition) {\n    validationIssues.push('üí° Renovation detected but no demolition works - consider adding');\n  }\n}\n\nconst photoConfig = staticData.photo_config;\nstaticData.work_results = [];\nstaticData.photo_config = null;\n\nreturn {\n  json: {\n    by_phase: byPhase,\n    cost_summary: {\n      grand_total_cost: grandTotal,\n      grand_labor_hours: grandHours,\n      grand_resource_cost: grandLaborCost,\n      grand_material_cost: grandMaterialCost,\n      grand_machine_cost: grandMachineCost\n    },\n    photo_analysis: {\n      description: photoConfig?.room_description || 'Photo Analysis',\n      room_type: photoConfig?.room_type || 'unknown',\n      location_type: photoConfig?.room_type || 'interior',\n      room_size: (photoConfig?.dimensions?.floor_area_m2 || 'N/A') + ' m¬≤',\n      work_phase: photoConfig?.work_type_detected || 'general',\n      materials: photoConfig?.elements?.map(e => e.material).filter(Boolean) || [],\n      elements_count: photoConfig?.elements?.length || 0,\n      fixtures_count: photoConfig?.fixtures?.length || 0\n    },\n    language_code: photoConfig?.language_code || 'EN',\n    currency: photoConfig?.currency || 'EUR',\n    currency_symbol: photoConfig?.currency_symbol || '‚Ç¨',\n    locale: photoConfig?.locale || 'en-US',\n    city: photoConfig?.city || 'Toronto',\n    language: photoConfig?.language || 'English',\n    pricing_level: photoConfig?.city || 'Toronto',\n    quality_stats: {\n      total: works.length,\n      high: qHigh,\n      medium: qMedium,\n      low: qLow,\n      not_found: qNotFound,\n      found_percent: foundPercent\n    },\n    validation: {\n      issues: validationIssues,\n      issues_count: validationIssues.length,\n      passed: validationIssues.length === 0\n    }\n  }\n};"
      },
      "id": "cb292497-e371-40df-b81c-4cbdd0333959",
      "name": "STAGE 7.5 Aggregate & Validate",
      "type": "n8n-nodes-base.code",
      "position": [
        -1600,
        9120
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// STAGE 9: PROFESSIONAL HTML REPORT - 9 LANGUAGES\n// Photo Cost Estimate Pro v2 - with validation section\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst input = $input.first().json;\n\nconst langCode = (input.language_code || 'EN').toUpperCase();\nconst currency = input.currency || 'EUR';\nconst currencySymbol = input.currency_symbol || '‚Ç¨';\nconst locale = input.locale || 'en-US';\nconst pricingLevel = input.pricing_level || input.city || 'Unknown';\nconst photoAnalysis = input.photo_analysis || {};\nconst validation = input.validation || {};\nconst projectName = photoAnalysis.description || 'Photo Cost Estimate';\n\nconst RATES_LINK = 'https://openconstructionestimate.com/all-estimates/?utm=OCE';\n\n// TRANSLATIONS - 9 LANGUAGES\nconst translations = {\n  'DE': { doc_title: 'KOSTENVORANSCHLAG', project: 'Projekt', pricing_level: 'Preisniveau', date: 'Datum', col_pos: 'Pos.', col_code: 'Kennziffer', col_description: 'Bezeichnung', col_calc: 'Berechnung', col_unit: 'Einheit', col_qty: 'Menge', col_price: 'EP', col_total: 'GP', col_labor: 'Std.', col_quality: 'Q', subtotal: 'Zwischensumme', grand_total: 'GESAMTSUMME', labor_cost: 'Lohnkosten', material_cost: 'Materialkosten', labor_days: 'Arbeitstage', found_rates: 'Gefunden', manual_check: 'pr√ºfen', kpi_total: 'Gesamtkosten', kpi_hours: 'Arbeitsstunden', kpi_days: 'Arbeitstage', chart_cost_structure: 'Kostenstruktur', chart_by_phase: 'Nach Phase', chart_labor: 'Lohn', chart_material: 'Material', chart_machines: 'Maschinen', chart_timeline: 'Zeitplan', chart_hierarchy: 'Kostenhierarchie', collapse_all: 'Alles einklappen', expand_all: 'Alles ausklappen', res_labor: 'Lohn', res_material: 'Mat.', res_machine: 'Masch.', photo_analysis: 'Fotoanalyse', location: 'Raumtyp', room_size: 'Raumgr√∂√üe', work_phase: 'Arbeitstyp', materials: 'Materialien', validation: 'Validierung', validation_passed: 'Alle Pr√ºfungen bestanden', validation_issues: 'Hinweise' },\n  'EN': { doc_title: 'COST ESTIMATE', project: 'Project', pricing_level: 'Pricing Level', date: 'Date', col_pos: 'Pos.', col_code: 'Code', col_description: 'Description', col_calc: 'Calculation', col_unit: 'Unit', col_qty: 'Qty', col_price: 'UP', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q', subtotal: 'Subtotal', grand_total: 'GRAND TOTAL', labor_cost: 'Labor Cost', material_cost: 'Material Cost', labor_days: 'Work Days', found_rates: 'Found', manual_check: 'check', kpi_total: 'Total Cost', kpi_hours: 'Work Hours', kpi_days: 'Work Days', chart_cost_structure: 'Cost Structure', chart_by_phase: 'By Phase', chart_labor: 'Labor', chart_material: 'Material', chart_machines: 'Machines', chart_timeline: 'Timeline', chart_hierarchy: 'Cost Hierarchy', collapse_all: 'Collapse All', expand_all: 'Expand All', res_labor: 'Labor', res_material: 'Mat.', res_machine: 'Mach.', photo_analysis: 'Photo Analysis', location: 'Room Type', room_size: 'Room Size', work_phase: 'Work Type', materials: 'Materials', validation: 'Validation', validation_passed: 'All checks passed', validation_issues: 'Issues' },\n  'RU': { doc_title: '–°–ú–ï–¢–ê', project: '–ü—Ä–æ–µ–∫—Ç', pricing_level: '–£—Ä–æ–≤–µ–Ω—å —Ü–µ–Ω', date: '–î–∞—Ç–∞', col_pos: 'N', col_code: '–®–∏—Ñ—Ä', col_description: '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', col_calc: '–†–∞—Å—á—ë—Ç', col_unit: '–ï–¥.', col_qty: '–ö–æ–ª-–≤–æ', col_price: '–¶–µ–Ω–∞', col_total: '–°—É–º–º–∞', col_labor: '–ß/—á', col_quality: '–ö', subtotal: '–ò—Ç–æ–≥–æ', grand_total: '–í–°–ï–ì–û', labor_cost: '–¢—Ä—É–¥', material_cost: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã', labor_days: '–î–Ω–µ–π', found_rates: '–ù–∞–π–¥–µ–Ω–æ', manual_check: '–ø—Ä–æ–≤–µ—Ä–∏—Ç—å', kpi_total: '–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å', kpi_hours: '–ß–∞—Å—ã', kpi_days: '–î–Ω–∏', chart_cost_structure: '–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞—Ç—Ä–∞—Ç', chart_by_phase: '–ü–æ —ç—Ç–∞–ø–∞–º', chart_labor: '–¢—Ä—É–¥', chart_material: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã', chart_machines: '–ú–∞—à–∏–Ω—ã', chart_timeline: '–ì—Ä–∞—Ñ–∏–∫', chart_hierarchy: '–ò–µ—Ä–∞—Ä—Ö–∏—è –∑–∞—Ç—Ä–∞—Ç', collapse_all: '–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë', expand_all: '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å—ë', res_labor: '–¢—Ä—É–¥', res_material: '–ú–∞—Ç.', res_machine: '–ú–∞—à.', photo_analysis: '–ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ', location: '–¢–∏–ø –ø–æ–º–µ—â–µ–Ω–∏—è', room_size: '–ü–ª–æ—â–∞–¥—å', work_phase: '–¢–∏–ø —Ä–∞–±–æ—Ç', materials: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã', validation: '–ü—Ä–æ–≤–µ—Ä–∫–∞', validation_passed: '–í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã', validation_issues: '–ó–∞–º–µ—á–∞–Ω–∏—è' },\n  'FR': { doc_title: 'DEVIS ESTIMATIF', project: 'Projet', pricing_level: 'Niveau de prix', date: 'Date', col_pos: 'Pos.', col_code: 'Code', col_description: 'D√©signation', col_calc: 'Calcul', col_unit: 'Unit√©', col_qty: 'Qt√©', col_price: 'PU', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q', subtotal: 'Sous-total', grand_total: 'TOTAL G√âN√âRAL', labor_cost: 'Main-d-oeuvre', material_cost: 'Mat√©riaux', labor_days: 'Jours', found_rates: 'Trouv√©s', manual_check: 'v√©rifier', kpi_total: 'Co√ªt Total', kpi_hours: 'Heures', kpi_days: 'Jours', chart_cost_structure: 'Structure des co√ªts', chart_by_phase: 'Par phase', chart_labor: 'Main-d-oeuvre', chart_material: 'Mat√©riaux', chart_machines: 'Machines', chart_timeline: 'Planning', chart_hierarchy: 'Hi√©rarchie', collapse_all: 'Tout r√©duire', expand_all: 'Tout d√©velopper', res_labor: 'M.O.', res_material: 'Mat.', res_machine: 'Mach.', photo_analysis: 'Analyse photo', location: 'Type de pi√®ce', room_size: 'Surface', work_phase: 'Type de travaux', materials: 'Mat√©riaux', validation: 'Validation', validation_passed: 'Toutes les v√©rifications pass√©es', validation_issues: 'Remarques' },\n  'ES': { doc_title: 'PRESUPUESTO', project: 'Proyecto', pricing_level: 'Nivel de precios', date: 'Fecha', col_pos: 'Pos.', col_code: 'C√≥digo', col_description: 'Descripci√≥n', col_calc: 'C√°lculo', col_unit: 'Unidad', col_qty: 'Cant.', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q', subtotal: 'Subtotal', grand_total: 'TOTAL GENERAL', labor_cost: 'Mano obra', material_cost: 'Materiales', labor_days: 'D√≠as', found_rates: 'Encontrados', manual_check: 'verificar', kpi_total: 'Coste Total', kpi_hours: 'Horas', kpi_days: 'D√≠as', chart_cost_structure: 'Estructura de costes', chart_by_phase: 'Por fase', chart_labor: 'Mano obra', chart_material: 'Material', chart_machines: 'M√°quinas', chart_timeline: 'Cronograma', chart_hierarchy: 'Jerarqu√≠a', collapse_all: 'Contraer todo', expand_all: 'Expandir todo', res_labor: 'M.O.', res_material: 'Mat.', res_machine: 'M√°q.', photo_analysis: 'An√°lisis foto', location: 'Tipo de espacio', room_size: 'Superficie', work_phase: 'Tipo de obra', materials: 'Materiales', validation: 'Validaci√≥n', validation_passed: 'Todas las verificaciones pasaron', validation_issues: 'Observaciones' },\n  'PT': { doc_title: 'OR√áAMENTO', project: 'Projeto', pricing_level: 'N√≠vel de pre√ßos', date: 'Data', col_pos: 'Pos.', col_code: 'C√≥digo', col_description: 'Descri√ß√£o', col_calc: 'C√°lculo', col_unit: 'Unidade', col_qty: 'Qtd.', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q', subtotal: 'Subtotal', grand_total: 'TOTAL GERAL', labor_cost: 'M√£o obra', material_cost: 'Materiais', labor_days: 'Dias', found_rates: 'Encontrados', manual_check: 'verificar', kpi_total: 'Custo Total', kpi_hours: 'Horas', kpi_days: 'Dias', chart_cost_structure: 'Estrutura de custos', chart_by_phase: 'Por fase', chart_labor: 'M√£o obra', chart_material: 'Material', chart_machines: 'M√°quinas', chart_timeline: 'Cronograma', chart_hierarchy: 'Hierarquia', collapse_all: 'Recolher tudo', expand_all: 'Expandir tudo', res_labor: 'M.O.', res_material: 'Mat.', res_machine: 'M√°q.', photo_analysis: 'An√°lise foto', location: 'Tipo de espa√ßo', room_size: '√Årea', work_phase: 'Tipo de obra', materials: 'Materiais', validation: 'Valida√ß√£o', validation_passed: 'Todas as verifica√ß√µes passaram', validation_issues: 'Observa√ß√µes' },\n  'ZH': { doc_title: 'Â∑•Á®ãÈ¢ÑÁÆó', project: 'È°πÁõÆ', pricing_level: '‰ª∑Ê†ºÊ∞¥Âπ≥', date: 'Êó•Êúü', col_pos: 'Â∫èÂè∑', col_code: 'ÁºñÁ†Å', col_description: 'ÂêçÁß∞', col_calc: 'ËÆ°ÁÆó', col_unit: 'Âçï‰Ωç', col_qty: 'Êï∞Èáè', col_price: 'Âçï‰ª∑', col_total: 'ÂêàËÆ°', col_labor: 'Â∑•Êó∂', col_quality: 'Ë¥®', subtotal: 'Â∞èËÆ°', grand_total: 'ÊÄªËÆ°', labor_cost: '‰∫∫Â∑•Ë¥π', material_cost: 'ÊùêÊñôË¥π', labor_days: 'Â∑•‰ΩúÊó•', found_rates: 'Â∑≤ÊâæÂà∞', manual_check: 'Ê†∏Êü•', kpi_total: 'ÊÄªÊàêÊú¨', kpi_hours: 'Â∑•Êó∂', kpi_days: 'Â∑•‰ΩúÊó•', chart_cost_structure: 'ÊàêÊú¨ÁªìÊûÑ', chart_by_phase: 'ÊåâÈò∂ÊÆµ', chart_labor: '‰∫∫Â∑•', chart_material: 'ÊùêÊñô', chart_machines: 'Êú∫Ê¢∞', chart_timeline: 'ËøõÂ∫¶', chart_hierarchy: 'Â±ÇÊ¨°', collapse_all: 'ÂÖ®ÈÉ®ÊäòÂè†', expand_all: 'ÂÖ®ÈÉ®Â±ïÂºÄ', res_labor: '‰∫∫Â∑•', res_material: 'ÊùêÊñô', res_machine: 'Êú∫Ê¢∞', photo_analysis: 'ÁÖßÁâáÂàÜÊûê', location: 'ÊàøÈó¥Á±ªÂûã', room_size: 'Èù¢ÁßØ', work_phase: 'ÊñΩÂ∑•Á±ªÂûã', materials: 'ÊùêÊñô', validation: 'È™åËØÅ', validation_passed: 'ÊâÄÊúâÊ£ÄÊü•ÈÄöËøá', validation_issues: 'ÈóÆÈ¢ò' },\n  'AR': { doc_title: 'ÿ™ŸÇÿØŸäÿ± ÿßŸÑÿ™ŸÉŸÑŸÅÿ©', project: 'ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ', pricing_level: 'ŸÖÿ≥ÿ™ŸàŸâ ÿßŸÑÿ£ÿ≥ÿπÿßÿ±', date: 'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ', col_pos: 'ÿ±ŸÇŸÖ', col_code: 'ÿßŸÑÿ±ŸÖÿ≤', col_description: 'ÿßŸÑŸàÿµŸÅ', col_calc: 'ÿßŸÑÿ≠ÿ≥ÿßÿ®', col_unit: 'ÿßŸÑŸàÿ≠ÿØÿ©', col_qty: 'ÿßŸÑŸÉŸÖŸäÿ©', col_price: 'ÿ≥ÿπÿ± ÿßŸÑŸàÿ≠ÿØÿ©', col_total: 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ', col_labor: 'ÿ≥ÿßÿπÿßÿ™', col_quality: 'ÿ¨', subtotal: 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÅÿ±ÿπŸä', grand_total: 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑŸÉŸÑŸä', labor_cost: 'ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿπŸÖÿßŸÑÿ©', material_cost: 'ÿ™ŸÉŸÑŸÅÿ© ÿßŸÑŸÖŸàÿßÿØ', labor_days: 'ÿ£ŸäÿßŸÖ ÿßŸÑÿπŸÖŸÑ', found_rates: 'ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ±', manual_check: 'ÿ™ÿ≠ŸÇŸÇ', kpi_total: 'ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©', kpi_hours: 'ÿ≥ÿßÿπÿßÿ™ ÿßŸÑÿπŸÖŸÑ', kpi_days: 'ÿ£ŸäÿßŸÖ ÿßŸÑÿπŸÖŸÑ', chart_cost_structure: 'ŸáŸäŸÉŸÑ ÿßŸÑÿ™ŸÉŸÑŸÅÿ©', chart_by_phase: 'ÿ≠ÿ≥ÿ® ÿßŸÑŸÖÿ±ÿ≠ŸÑÿ©', chart_labor: 'ÿßŸÑÿπŸÖÿßŸÑÿ©', chart_material: 'ÿßŸÑŸÖŸàÿßÿØ', chart_machines: 'ÿßŸÑŸÖÿπÿØÿßÿ™', chart_timeline: 'ÿßŸÑÿ¨ÿØŸàŸÑ ÿßŸÑÿ≤ŸÖŸÜŸä', chart_hierarchy: 'ÿ™ÿ≥ŸÑÿ≥ŸÑ ÿßŸÑÿ™ŸÉÿßŸÑŸäŸÅ', collapse_all: 'ÿ∑Ÿä ÿßŸÑŸÉŸÑ', expand_all: 'ÿ™Ÿàÿ≥Ÿäÿπ ÿßŸÑŸÉŸÑ', res_labor: 'ÿπŸÖÿßŸÑÿ©', res_material: 'ŸÖŸàÿßÿØ', res_machine: 'ŸÖÿπÿØÿßÿ™', photo_analysis: 'ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ©', location: 'ŸÜŸàÿπ ÿßŸÑÿ∫ÿ±ŸÅÿ©', room_size: 'ÿßŸÑŸÖÿ≥ÿßÿ≠ÿ©', work_phase: 'ŸÜŸàÿπ ÿßŸÑÿπŸÖŸÑ', materials: 'ÿßŸÑŸÖŸàÿßÿØ', validation: 'ÿßŸÑÿ™ÿ≠ŸÇŸÇ', validation_passed: 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿ≠Ÿàÿµÿßÿ™ ŸÜÿßÿ¨ÿ≠ÿ©', validation_issues: 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™' },\n  'HI': { doc_title: '‡§≤‡§æ‡§ó‡§§ ‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®', project: '‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ', pricing_level: '‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§∏‡•ç‡§§‡§∞', date: '‡§§‡§æ‡§∞‡•Ä‡§ñ', col_pos: '‡§ï‡•ç‡§∞‡§Æ', col_code: '‡§ï‡•ã‡§°', col_description: '‡§µ‡§ø‡§µ‡§∞‡§£', col_calc: '‡§ó‡§£‡§®‡§æ', col_unit: '‡§á‡§ï‡§æ‡§à', col_qty: '‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ', col_price: '‡§¶‡§∞', col_total: '‡§ï‡•Å‡§≤', col_labor: '‡§ò‡§Ç‡§ü‡•á', col_quality: '‡§ó‡•Å', subtotal: '‡§â‡§™-‡§Ø‡•ã‡§ó', grand_total: '‡§ï‡•Å‡§≤ ‡§Ø‡•ã‡§ó', labor_cost: '‡§∂‡•ç‡§∞‡§Æ ‡§≤‡§æ‡§ó‡§§', material_cost: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä ‡§≤‡§æ‡§ó‡§§', labor_days: '‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§¶‡§ø‡§µ‡§∏', found_rates: '‡§Æ‡§ø‡§≤‡§æ', manual_check: '‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç', kpi_total: '‡§ï‡•Å‡§≤ ‡§≤‡§æ‡§ó‡§§', kpi_hours: '‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ò‡§Ç‡§ü‡•á', kpi_days: '‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§¶‡§ø‡§µ‡§∏', chart_cost_structure: '‡§≤‡§æ‡§ó‡§§ ‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ', chart_by_phase: '‡§ö‡§∞‡§£ ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞', chart_labor: '‡§∂‡•ç‡§∞‡§Æ', chart_material: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä', chart_machines: '‡§Æ‡§∂‡•Ä‡§®‡•á‡§Ç', chart_timeline: '‡§∏‡§Æ‡§Ø‡§∞‡•á‡§ñ‡§æ', chart_hierarchy: '‡§™‡§¶‡§æ‡§®‡•Å‡§ï‡•ç‡§∞‡§Æ', collapse_all: '‡§∏‡§≠‡•Ä ‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç', expand_all: '‡§∏‡§≠‡•Ä ‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§ï‡§∞‡•á‡§Ç', res_labor: '‡§∂‡•ç‡§∞‡§Æ', res_material: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä', res_machine: '‡§Æ‡§∂‡•Ä‡§®', photo_analysis: '‡§´‡•ã‡§ü‡•ã ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£', location: '‡§ï‡§Æ‡§∞‡•á ‡§ï‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞', room_size: '‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞‡§´‡§≤', work_phase: '‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞', materials: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä', validation: '‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§®', validation_passed: '‡§∏‡§≠‡•Ä ‡§ú‡§æ‡§Å‡§ö ‡§™‡§æ‡§∏', validation_issues: '‡§Æ‡•Å‡§¶‡•ç‡§¶‡•á' }\n};\nconst t = translations[langCode] || translations['EN'];\n\n// HELPERS\nfunction formatCurrency(value) {\n  if (value === null || value === undefined || isNaN(value)) return '‚Äî';\n  try { return new Intl.NumberFormat(locale, { style: 'currency', currency: currency, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value); }\n  catch (e) { return currencySymbol + value.toFixed(2); }\n}\nfunction formatNumber(value, decimals) {\n  if (decimals === undefined) decimals = 3;\n  if (value === null || value === undefined || isNaN(value)) return '‚Äî';\n  try { return new Intl.NumberFormat(locale, { minimumFractionDigits: decimals, maximumFractionDigits: decimals }).format(value); }\n  catch (e) { return value.toFixed(decimals); }\n}\nfunction formatDateTime() {\n  try { return new Intl.DateTimeFormat(locale, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }).format(new Date()); }\n  catch (e) { return new Date().toISOString().split('T')[0]; }\n}\nfunction escapeHtml(text) {\n  if (!text) return '';\n  return String(text).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;');\n}\n\n// DATA\nconst phases = input.by_phase || [];\nconst costSummary = input.cost_summary || {};\nconst qualityStats = input.quality_stats || {};\nconst grandTotal = costSummary.grand_total_cost || 0;\nconst grandLaborHours = costSummary.grand_labor_hours || 0;\nconst grandResourceCost = costSummary.grand_resource_cost || 0;\nconst grandMaterialCost = costSummary.grand_material_cost || 0;\nconst grandMachineCost = costSummary.grand_machine_cost || 0;\n\nconst totalWorks = qualityStats.total || 0;\nconst qualityHigh = qualityStats.high || 0;\nconst qualityMedium = qualityStats.medium || 0;\nconst qualityLow = qualityStats.low || 0;\nconst qualityNotFound = qualityStats.not_found || 0;\nconst foundRates = qualityHigh + qualityMedium + qualityLow;\nconst foundPercent = qualityStats.found_percent || 0;\n\nconst laborDays = Math.ceil(grandLaborHours / 8);\nconst laborPercent = grandTotal > 0 ? Math.round(grandResourceCost / grandTotal * 100) : 35;\nconst materialPercent = grandTotal > 0 ? Math.round(grandMaterialCost / grandTotal * 100) : 55;\nconst machinesPercent = grandTotal > 0 ? Math.round(grandMachineCost / grandTotal * 100) : 10;\n\nconst dateTimeStr = formatDateTime();\n\nconst phaseChartData = phases.map(function(phase) { return { name: phase.phase_name || 'Phase', cost: phase.phase_total_cost || 0, hours: phase.phase_labor_hours || 0 }; });\n\n// HTML GENERATION\nvar html = `<!DOCTYPE html>\n<html>\n<head>\n<meta charset=\"UTF-8\">\n<title>${t.doc_title} - ${escapeHtml(projectName)}</title>\n<style>\n:root { --primary: #007AFF; --primary-light: #5AC8FA; --primary-dark: #0051D5; --text-primary: #1D1D1F; --text-secondary: #86868B; --text-muted: #AEAEB2; --bg-white: #FFFFFF; --bg-light: #F5F5F7; --bg-medium: #E8E8ED; --border: #D2D2D7; --success: #34C759; --warning: #FF9500; --error: #FF3B30; }\nbody { font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Arial, sans-serif; margin: 0; padding: 20px; background: #F5F5F7; color: var(--text-primary); line-height: 1.5; font-size: 11px; }\n.container { background: var(--bg-white); max-width: 1350px; margin: 0 auto; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-radius: 20px; overflow: hidden; }\ntable { border-collapse: collapse; width: 100%; }\ntd, th { padding: 8px 10px; text-align: left; vertical-align: middle; }\n.header-new { background: var(--bg-white); color: var(--text-primary); display: flex; justify-content: space-between; align-items: center; padding: 14px 20px; border-bottom: 1px solid var(--border); }\n.header-left { display: flex; flex-direction: column; }\n.header-title-new { font-size: 18px; font-weight: 600; letter-spacing: -0.3px; color: var(--text-primary); }\n.header-project-new { font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-top: 2px; }\n.header-info-new { font-size: 11px; font-weight: 400; color: var(--text-muted); margin-top: 2px; }\n.header-right { display: flex; align-items: center; gap: 12px; }\n.header-logo { height: 32px; opacity: 0.9; }\n.header-logo:hover { opacity: 1; }\n.header-btn { display: inline-flex; align-items: center; gap: 5px; padding: 7px 12px; background: var(--bg-light); border: 1px solid var(--border); border-radius: 16px; color: var(--text-secondary); text-decoration: none; font-size: 11px; font-weight: 500; transition: all 0.2s; }\n.header-btn:hover { background: var(--bg-medium); color: var(--text-primary); }\n.header-btn svg { width: 14px; height: 14px; }\n.charts-section { background: var(--bg-light); padding: 16px 20px; }\n.chart-card { background: var(--bg-white); border-radius: 10px; padding: 14px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); border: 1px solid var(--border); }\n.chart-title { font-size: 10px; font-weight: 600; color: var(--text-muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.4px; }\n.row-1 { display: grid; grid-template-columns: auto 1fr; gap: 12px; margin-bottom: 12px; }\n.kpi-row { display: flex; gap: 6px; }\n.kpi-card { background: var(--bg-white); border-radius: 8px; padding: 10px 14px; display: flex; align-items: center; gap: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); border: 1px solid var(--border); white-space: nowrap; }\n.kpi-icon { font-size: 16px; opacity: 0.5; }\n.kpi-value { font-size: 16px; font-weight: 600; letter-spacing: -0.3px; color: var(--text-primary); line-height: 1.1; }\n.kpi-label { font-size: 8px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.2px; }\n.row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }\n.row-3 { display: grid; grid-template-columns: 1fr; gap: 12px; }\n.h-bar { margin-bottom: 8px; }\n.h-bar-label { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 3px; color: var(--text-primary); }\n.h-bar-label span:last-child { font-weight: 600; }\n.h-bar-track { background: var(--bg-medium); border-radius: 2px; height: 5px; overflow: hidden; display: flex; }\n.h-bar-fill { height: 100%; }\n.treemap { display: flex; gap: 6px; height: 60px; }\n.treemap-item { border-radius: 8px; padding: 8px 10px; background: var(--bg-light); color: var(--text-primary); display: flex; flex-direction: column; justify-content: space-between; border: 1px solid var(--border); min-width: 0; cursor: pointer; transition: all 0.15s; }\n.treemap-item:hover { background: var(--bg-medium); border-color: var(--text-secondary); transform: translateY(-1px); }\n.treemap-name { font-size: 9px; color: var(--text-muted); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }\n.treemap-value { font-size: 12px; font-weight: 600; color: var(--text-primary); }\n.treemap-percent { font-size: 9px; color: var(--text-secondary); }\n.timeline-row { display: flex; align-items: center; margin-bottom: 8px; }\n.timeline-label { width: 120px; font-size: 11px; font-weight: 500; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }\n.timeline-track { flex: 1; height: 18px; background: var(--bg-medium); border-radius: 4px; position: relative; overflow: hidden; }\n.timeline-bar { position: absolute; height: 100%; border-radius: 4px; font-size: 10px; color: white; display: flex; align-items: center; justify-content: center; font-weight: 500; background: #1D1D1F; min-width: 4px; }\n.quality-bar { background: var(--bg-medium); padding: 8px 16px; font-size: 10px; color: var(--text-secondary); display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }\n.quality-item { display: flex; align-items: center; gap: 4px; }\n.quality-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }\n.dot-high { background: #1D1D1F; }\n.dot-medium { background: #86868B; }\n.dot-low { background: #AEAEB2; }\n.dot-notfound { background: #D2D2D7; }\n.quality-percent { font-weight: 600; color: var(--text-primary); }\n.table-controls { display: flex; gap: 8px; padding: 10px 16px; background: var(--bg-light); border-bottom: 1px solid var(--border); }\n.control-btn { padding: 6px 12px; background: var(--bg-white); border: 1px solid var(--border); border-radius: 6px; font-size: 11px; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }\n.control-btn:hover { background: var(--bg-medium); color: var(--text-primary); }\n.col-header { background: var(--bg-medium); color: var(--text-secondary); font-weight: 600; font-size: 9px; text-transform: uppercase; letter-spacing: 0.5px; text-align: center; padding: 8px 6px; border-bottom: 2px solid var(--border); }\n.phase { background: var(--primary); color: #FFFFFF; font-weight: 600; font-size: 11px; cursor: pointer; }\n.phase:hover { opacity: 0.95; }\n.type { background: #EFF6FF; color: var(--text-primary); font-weight: 600; font-size: 10px; border-left: 3px solid var(--primary); cursor: pointer; }\n.type:hover { opacity: 0.95; }\n.work { background: var(--bg-white); color: var(--text-primary); font-size: 10px; border-bottom: 1px solid var(--bg-medium); cursor: pointer; }\n.work:hover { background: #FAFAFA; }\n.work-demolition { background: #FEF3C7; }\n.work-demolition:hover { background: #FDE68A; }\n.resource { background: var(--bg-light); color: var(--text-muted); font-size: 9px; border-bottom: 1px solid var(--bg-medium); }\n.subtotal { background: var(--bg-light); color: var(--text-primary); font-weight: 600; font-size: 12px; border-top: 1px solid var(--border); }\n.grand-total { background: var(--text-primary); color: #FFFFFF; font-weight: 600; font-size: 14px; }\n.grand-total-info { background: var(--primary-dark); color: rgba(255,255,255,0.9); font-size: 10px; }\n.highlight { color: #FCD34D; font-weight: 600; }\n.right { text-align: right; }\n.center { text-align: center; }\n.num { font-variant-numeric: tabular-nums; }\n.link { color: var(--primary); text-decoration: none; }\n.link:hover { text-decoration: underline; }\n.toggle-icon { display: inline-block; width: 16px; transition: transform 0.2s; cursor: pointer; }\ntr.hidden { display: none; }\n.calc-cell { font-size: 9px; color: var(--text-muted); line-height: 1.4; max-width: 200px; }\n.calc-type { color: var(--primary); font-weight: 600; font-size: 9px; display: block; margin-bottom: 2px; }\n.calc-formula { font-family: monospace; font-size: 8px; color: var(--text-secondary); background: #F0F9FF; border: 1px solid #BAE6FD; padding: 3px 6px; border-radius: 4px; display: block; }\n.res-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-left: 4px; }\n.res-tag-labor { background: #1D1D1F; color: white; }\n.res-tag-material { background: #86868B; color: white; }\n.res-tag-machine { background: #AEAEB2; color: white; }\n.photo-info { padding: 12px 20px; background: #EFF6FF; border-bottom: 1px solid var(--border); font-size: 11px; }\n.photo-info-title { font-weight: 600; color: var(--primary-dark); margin-bottom: 6px; }\n.photo-info-item { display: inline-block; margin-right: 16px; color: var(--text-secondary); }\n.photo-info-item strong { color: var(--text-primary); }\n.validation-bar { padding: 10px 20px; font-size: 11px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }\n.validation-passed { background: #D1FAE5; color: #065F46; }\n.validation-issues { background: #FEF3C7; color: #92400E; }\n.validation-icon { font-size: 14px; }\n.validation-text { font-weight: 500; }\n.validation-issue { background: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 4px; font-size: 10px; }\n.footer { background: var(--bg-medium); padding: 10px 16px; border-top: 1px solid var(--border); }\n.footer-main { display: flex; align-items: flex-start; gap: 16px; flex-wrap: wrap; }\n.footer-brand { font-weight: 700; font-size: 10px; color: var(--primary); white-space: nowrap; }\n.footer-info { font-size: 9px; color: var(--text-muted); flex: 1; min-width: 200px; }\n.footer-links { display: flex; gap: 10px; font-size: 9px; }\n.footer-links a { color: var(--primary); text-decoration: none; white-space: nowrap; }\n.footer-db { font-size: 8px; color: var(--text-muted); margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border); }\n@media print { body { padding: 0; background: white; } .container { box-shadow: none; } }\n</style>\n</head>\n<body>\n<div class=\"container\">\n`;\n\n// HEADER\nhtml += '<div class=\"header-new\"><div class=\"header-left\"><div class=\"header-title-new\">' + t.doc_title + ' v2</div><div class=\"header-project-new\">' + escapeHtml(projectName) + '</div><div class=\"header-info-new\">' + t.pricing_level + ': ' + pricingLevel + ' | ' + dateTimeStr + '</div></div><div class=\"header-right\"><a href=\"https://github.com/datadrivenconstruction\" target=\"_blank\" class=\"header-btn\"><svg viewBox=\"0 0 24 24\" fill=\"currentColor\"><path d=\"M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.+123456789066 1.983-.399 3.+123456789038 3.+12345678907-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z\"/></svg>GitHub</a><a href=\"https://datadrivenconstruction.io/\" target=\"_blank\"><img src=\"https://datadrivenconstruction.io/wp-content/uploads/2023/07/DataDrivenConstruction-1-1.png\" alt=\"DDC\" class=\"header-logo\"></a></div></div>\\n';\n\n// PHOTO INFO\nhtml += '<div class=\"photo-info\"><div class=\"photo-info-title\">üì∑ ' + t.photo_analysis + '</div><span class=\"photo-info-item\"><strong>' + t.location + ':</strong> ' + escapeHtml(photoAnalysis.room_type || 'N/A') + '</span><span class=\"photo-info-item\"><strong>' + t.room_size + ':</strong> ' + escapeHtml(photoAnalysis.room_size || 'N/A') + '</span><span class=\"photo-info-item\"><strong>' + t.work_phase + ':</strong> ' + escapeHtml(photoAnalysis.work_phase || 'N/A') + '</span><span class=\"photo-info-item\"><strong>Elements:</strong> ' + (photoAnalysis.elements_count || 0) + '</span><span class=\"photo-info-item\"><strong>Fixtures:</strong> ' + (photoAnalysis.fixtures_count || 0) + '</span>';\nif (photoAnalysis.materials && photoAnalysis.materials.length > 0) {\n  html += '<span class=\"photo-info-item\"><strong>' + t.materials + ':</strong> ' + escapeHtml(photoAnalysis.materials.slice(0, 5).join(', ')) + '</span>';\n}\nhtml += '</div>\\n';\n\n// VALIDATION BAR\nif (validation.passed) {\n  html += '<div class=\"validation-bar validation-passed\"><span class=\"validation-icon\">‚úÖ</span><span class=\"validation-text\">' + t.validation_passed + '</span></div>\\n';\n} else if (validation.issues && validation.issues.length > 0) {\n  html += '<div class=\"validation-bar validation-issues\"><span class=\"validation-icon\">‚ö†Ô∏è</span><span class=\"validation-text\">' + t.validation_issues + ':</span>';\n  validation.issues.forEach(function(issue) {\n    html += '<span class=\"validation-issue\">' + escapeHtml(issue) + '</span>';\n  });\n  html += '</div>\\n';\n}\n\n// CHARTS SECTION\nhtml += '<div class=\"charts-section\"><div class=\"row-1\"><div class=\"kpi-row\"><div class=\"kpi-card\"><div class=\"kpi-icon\">üí∞</div><div class=\"kpi-content\"><div class=\"kpi-value\">' + formatCurrency(grandTotal) + '</div><div class=\"kpi-label\">' + t.kpi_total + '</div></div></div><div class=\"kpi-card\"><div class=\"kpi-icon\">‚è±Ô∏è</div><div class=\"kpi-content\"><div class=\"kpi-value\">' + formatNumber(grandLaborHours, 0) + ' h</div><div class=\"kpi-label\">' + t.kpi_hours + '</div></div></div><div class=\"kpi-card\"><div class=\"kpi-icon\">üìÖ</div><div class=\"kpi-content\"><div class=\"kpi-value\">' + laborDays + '</div><div class=\"kpi-label\">' + t.kpi_days + '</div></div></div></div><div class=\"chart-card\"><div class=\"chart-title\">' + t.chart_cost_structure + '</div><div class=\"h-bar\" style=\"margin-bottom:10px;\"><div class=\"h-bar-track\" style=\"height:8px;\"><div class=\"h-bar-fill\" style=\"width:' + laborPercent + '%;background:#1D1D1F;\"></div><div class=\"h-bar-fill\" style=\"width:' + materialPercent + '%;background:#86868B;\"></div><div class=\"h-bar-fill\" style=\"width:' + machinesPercent + '%;background:#AEAEB2;\"></div></div></div><div style=\"display:flex;flex-direction:column;gap:5px;font-size:10px;\"><div style=\"display:flex;justify-content:space-between;\"><span><span style=\"display:inline-block;width:8px;height:8px;background:#1D1D1F;border-radius:2px;margin-right:6px;\"></span>' + t.chart_labor + '</span><span style=\"font-weight:600;\">' + formatCurrency(grandResourceCost) + ' (' + laborPercent + '%)</span></div><div style=\"display:flex;justify-content:space-between;\"><span><span style=\"display:inline-block;width:8px;height:8px;background:#86868B;border-radius:2px;margin-right:6px;\"></span>' + t.chart_material + '</span><span style=\"font-weight:600;\">' + formatCurrency(grandMaterialCost) + ' (' + materialPercent + '%)</span></div><div style=\"display:flex;justify-content:space-between;\"><span><span style=\"display:inline-block;width:8px;height:8px;background:#AEAEB2;border-radius:2px;margin-right:6px;\"></span>' + t.chart_machines + '</span><span style=\"font-weight:600;\">' + formatCurrency(grandMachineCost) + ' (' + machinesPercent + '%)</span></div></div></div></div>';\n\n// Phase chart\nvar phaseHtml = '';\nfor (var i = 0; i < phaseChartData.length; i++) {\n  var p = phaseChartData[i];\n  var pct = grandTotal > 0 ? Math.round(p.cost / grandTotal * 100) : 0;\n  phaseHtml += '<div class=\"h-bar\"><div class=\"h-bar-label\"><span>' + escapeHtml(p.name) + '</span><span>' + formatCurrency(p.cost) + '</span></div><div class=\"h-bar-track\"><div class=\"h-bar-fill\" style=\"width:' + pct + '%;background:#1D1D1F;\"></div></div></div>';\n}\n\n// Timeline chart\nvar timelineHtml = '';\nfor (var i = 0; i < phaseChartData.length; i++) {\n  var p = phaseChartData[i];\n  var phaseDays = Math.ceil(p.hours / 8);\n  var widthPct = laborDays > 0 ? Math.min(phaseDays / laborDays * 100, 100) : 100;\n  timelineHtml += '<div class=\"timeline-row\"><div class=\"timeline-label\">' + escapeHtml(p.name) + '</div><div class=\"timeline-track\"><div class=\"timeline-bar\" style=\"left:0;width:' + widthPct + '%;\">' + phaseDays + 'd</div></div></div>';\n}\n\nhtml += '<div class=\"row-2\"><div class=\"chart-card\"><div class=\"chart-title\">' + t.chart_by_phase + '</div>' + phaseHtml + '</div><div class=\"chart-card\"><div class=\"chart-title\">' + t.chart_timeline + '</div>' + timelineHtml + '</div></div>';\n\n// Treemap\nvar treemapHtml = '';\nfor (var i = 0; i < phaseChartData.length; i++) {\n  var p = phaseChartData[i];\n  var pct = grandTotal > 0 ? Math.round(p.cost / grandTotal * 100) : 0;\n  treemapHtml += '<div class=\"treemap-item\" data-phase=\"' + (i+1) + '\" style=\"flex:' + (pct || 1) + ';\"><div class=\"treemap-name\">' + escapeHtml(p.name) + '</div><div class=\"treemap-value\">' + formatCurrency(p.cost) + '</div><div class=\"treemap-percent\">' + pct + '%</div></div>';\n}\nhtml += '<div class=\"row-3\"><div class=\"chart-card\"><div class=\"chart-title\">' + t.chart_hierarchy + '</div><div class=\"treemap\">' + treemapHtml + '</div></div></div></div>\\n';\n\n// TABLE CONTROLS\nhtml += '<div class=\"table-controls\"><button class=\"control-btn\" onclick=\"collapseAll()\">' + t.collapse_all + '</button><button class=\"control-btn\" onclick=\"expandAll()\">' + t.expand_all + '</button></div>\\n';\n\n// QUALITY BAR\nhtml += '<div class=\"quality-bar\"><div class=\"quality-item\"><span>' + t.found_rates + ':</span><span class=\"quality-percent\">' + foundPercent + '%</span><span>(' + foundRates + '/' + totalWorks + ')</span></div><div class=\"quality-item\"><span class=\"quality-dot dot-high\"></span><span>' + qualityHigh + '</span></div><div class=\"quality-item\"><span class=\"quality-dot dot-medium\"></span><span>' + qualityMedium + '</span></div><div class=\"quality-item\"><span class=\"quality-dot dot-low\"></span><span>' + qualityLow + '</span></div><div class=\"quality-item\"><span class=\"quality-dot dot-notfound\"></span><span>' + qualityNotFound + '</span></div>';\nif (qualityNotFound > 0) {\n  html += '<div class=\"quality-item\" style=\"color:var(--warning)\">‚ö† ' + qualityNotFound + ' ' + t.manual_check + '</div>';\n}\nhtml += '</div>\\n';\n\n// TABLE\nhtml += '<table><tr class=\"col-header\"><td style=\"width:4%\">' + t.col_pos + '</td><td style=\"width:9%\">' + t.col_code + '</td><td style=\"width:24%\">' + t.col_description + '</td><td style=\"width:16%\">' + t.col_calc + '</td><td style=\"width:6%\">' + t.col_unit + '</td><td style=\"width:7%\" class=\"right\">' + t.col_qty + '</td><td style=\"width:9%\" class=\"right\">' + t.col_price + '</td><td style=\"width:9%\" class=\"right\">' + t.col_total + '</td><td style=\"width:5%\" class=\"right\">' + t.col_labor + '</td><td style=\"width:4%\" class=\"center\">' + t.col_quality + '</td></tr>';\n\n// DATA ROWS\nvar globalWorkIndex = 0;\nfor (var phaseIdx = 0; phaseIdx < phases.length; phaseIdx++) {\n  var phase = phases[phaseIdx];\n  var phaseNum = phaseIdx + 1;\n  var phasePercent = grandTotal > 0 ? ((phase.phase_total_cost || 0) / grandTotal * 100).toFixed(0) : '0';\n  \n  html += '<tr class=\"phase\" id=\"phase-' + phaseNum + '\" data-phase=\"' + phaseNum + '\"><td>' + phaseNum + '</td><td></td><td colspan=\"2\"><span class=\"toggle-icon\">‚ñº</span> ' + escapeHtml(phase.phase_name || 'Phase') + '</td><td></td><td></td><td></td><td class=\"right num\">' + formatCurrency(phase.phase_total_cost || 0) + '</td><td class=\"right num\">' + formatNumber(phase.phase_labor_hours || 0, 1) + '</td><td class=\"center\">' + phasePercent + '%</td></tr>';\n\n  var types = phase.types || [];\n  for (var typeIdx = 0; typeIdx < types.length; typeIdx++) {\n    var type = types[typeIdx];\n    var typeNum = typeIdx + 1;\n    var typeName = type.type_name || 'Unknown Type';\n    var elementCount = type.element_count || 1;\n    var category = type.category || '';\n    \n    html += '<tr class=\"type\" data-phase=\"' + phaseNum + '\" data-type=\"' + typeNum + '\"><td>' + phaseNum + '.' + typeNum + '</td><td></td><td><span class=\"toggle-icon\">‚ñΩ</span> ' + escapeHtml(typeName) + ' <span style=\"color:var(--text-muted)\">(√ó' + elementCount + ')</span></td><td class=\"calc-cell\"><span class=\"calc-type\">' + escapeHtml(category) + '</span></td><td></td><td></td><td></td><td class=\"right num\">' + formatCurrency(type.type_total_cost || 0) + '</td><td class=\"right num\">' + formatNumber(type.type_total_labor_hours || 0, 1) + '</td><td></td></tr>';\n\n    var works = type.works || [];\n    for (var workIdx = 0; workIdx < works.length; workIdx++) {\n      var work = works[workIdx];\n      var workNum = workIdx + 1;\n      globalWorkIndex++;\n      var level = work.quality_level || 'not_found';\n      var dotClass = 'dot-notfound';\n      if (level === 'high') dotClass = 'dot-high';\n      else if (level === 'medium') dotClass = 'dot-medium';\n      else if (level === 'low') dotClass = 'dot-low';\n      \n      var rateCode = work.rate_code || '';\n      var codeLink = (rateCode && rateCode !== 'NOT_FOUND') ? '<a href=\"' + RATES_LINK + '\" class=\"link\" target=\"_blank\">' + escapeHtml(rateCode) + '</a>' : '‚Äî';\n      \n      var calcDetails = work.calculation_details || {};\n      var calcDisplay = '<span class=\"calc-type\">' + escapeHtml(work.calculation_basis || work.source_element || '') + '</span>';\n      if (calcDetails.formula_display) {\n        calcDisplay += '<span class=\"calc-formula\">' + escapeHtml(calcDetails.formula_display) + '</span>';\n      }\n      \n      var workRowClass = 'work';\n      if (work.is_demolition) workRowClass += ' work-demolition';\n      \n      html += '<tr class=\"' + workRowClass + '\" data-phase=\"' + phaseNum + '\" data-type=\"' + typeNum + '\" data-work=\"' + globalWorkIndex + '\"><td style=\"padding-left:16px\">' + phaseNum + '.' + typeNum + '.' + workNum + '</td><td>' + codeLink + '</td><td style=\"padding-left:24px\"><span class=\"toggle-icon\">‚ñø</span> ' + (work.is_demolition ? 'üî® ' : '') + escapeHtml(work.rate_name || work.work_name || 'Work') + '</td><td class=\"calc-cell\">' + calcDisplay + '</td><td>' + escapeHtml(work.rate_unit || work.project_unit || '‚Äî') + '</td><td class=\"right num\">' + formatNumber(work.calculated_quantity || work.quantity_in_rate_units || work.project_quantity || 0, 4) + '</td><td class=\"right num\">' + formatCurrency(work.unit_cost || 0) + '</td><td class=\"right num\">' + formatCurrency(work.total_cost || 0) + '</td><td class=\"right num\">' + formatNumber(work.estimated_labor_hours || 0, 1) + '</td><td class=\"center\"><span class=\"quality-dot ' + dotClass + '\"></span></td></tr>';\n\n      var resources = work.resources_all || [];\n      for (var resIdx = 0; resIdx < resources.length; resIdx++) {\n        var res = resources[resIdx];\n        var isLast = resIdx === resources.length - 1;\n        var prefix = isLast ? '‚îî' : '‚îú';\n        var resType = res.resource_type || 'material';\n        var tagLabels = { labor: t.res_labor, material: t.res_material, machine: t.res_machine };\n        var tagLabel = tagLabels[resType] || t.res_material;\n        var tagClass = 'res-tag res-tag-' + resType;\n        \n        html += '<tr class=\"resource\" data-phase=\"' + phaseNum + '\" data-type=\"' + typeNum + '\" data-work=\"' + globalWorkIndex + '\"><td></td><td style=\"font-size:9px;\"><span style=\"opacity:0.5;\">' + escapeHtml(res.resource_code || '') + '</span><span class=\"' + tagClass + '\">' + tagLabel + '</span></td><td style=\"padding-left:36px\">' + prefix + ' ' + escapeHtml(res.resource_name || 'Resource') + '</td><td></td><td>' + escapeHtml(res.resource_unit || '') + '</td><td class=\"right num\">' + formatNumber(res.scaled_quantity || res.resource_quantity || 0, 4) + '</td><td class=\"right num\">' + formatCurrency(res.price_per_unit || 0) + '</td><td class=\"right num\">' + formatCurrency(res.scaled_cost || res.resource_cost || 0) + '</td><td></td><td></td></tr>';\n      }\n    }\n  }\n  \n  html += '<tr class=\"subtotal\" data-phase=\"' + phaseNum + '\"><td></td><td></td><td colspan=\"2\">' + t.subtotal + ' ' + phaseNum + '</td><td></td><td></td><td></td><td class=\"right num\">' + formatCurrency(phase.phase_total_cost || 0) + '</td><td class=\"right num\">' + formatNumber(phase.phase_labor_hours || 0, 1) + '</td><td class=\"center\">' + phasePercent + '%</td></tr>';\n}\n\n// GRAND TOTAL\nhtml += '<tr class=\"grand-total\"><td colspan=\"4\" style=\"padding-left:16px\">' + t.grand_total + '</td><td></td><td></td><td></td><td class=\"right num\">' + formatCurrency(grandTotal) + '</td><td class=\"right num\">' + formatNumber(grandLaborHours, 1) + '</td><td class=\"center\">100%</td></tr>';\nhtml += '<tr class=\"grand-total-info\"><td colspan=\"4\" style=\"padding-left:16px\">' + t.labor_cost + ': <span class=\"highlight\">' + formatCurrency(grandResourceCost) + '</span> (' + laborPercent + '%)</td><td colspan=\"3\">' + t.material_cost + ': <span class=\"highlight\">' + formatCurrency(grandMaterialCost) + '</span></td><td colspan=\"3\" class=\"right\" style=\"padding-right:16px\"><span class=\"highlight\">' + laborDays + '</span> ' + t.labor_days + '</td></tr>';\nhtml += '</table>\\n';\n\n// FOOTER\nhtml += '<div class=\"footer\"><div class=\"footer-main\"><div class=\"footer-brand\">OPEN CONSTRUCTION ESTIMATE v2</div><div class=\"footer-info\">Professional cost estimation powered by DDC CWICR database | Multi-stage AI decomposition</div><div class=\"footer-links\"><a href=\"' + RATES_LINK + '\" target=\"_blank\">openconstructionestimate.com</a><a href=\"https://github.com/datadrivenconstruction/OpenConstructionEstimate-DDC-CWICR\" target=\"_blank\">GitHub</a><a href=\"https://datadrivenconstruction.io\" target=\"_blank\">datadrivenconstruction.io</a></div></div><div class=\"footer-db\">DDC CWICR ‚Äî Construction Work Items, Costs & Resources Database | Generated: ' + dateTimeStr + '</div></div>\\n';\n\nhtml += '</div>\\n';\n\n// SCRIPT\nhtml += `<script>\nfunction collapseAll() {\n  document.querySelectorAll(\"tr.phase\").forEach(function(row) {\n    row.classList.add(\"collapsed\");\n    var icon = row.querySelector(\".toggle-icon\");\n    if (icon) icon.textContent = \"‚ñ∂\";\n    var phaseId = row.dataset.phase;\n    document.querySelectorAll('tr[data-phase=\"' + phaseId + '\"]:not(.phase)').forEach(function(child) {\n      child.classList.add(\"hidden\");\n    });\n  });\n}\n\nfunction expandAll() {\n  document.querySelectorAll(\"tr.phase\").forEach(function(row) {\n    row.classList.remove(\"collapsed\");\n    var icon = row.querySelector(\".toggle-icon\");\n    if (icon) icon.textContent = \"‚ñº\";\n    var phaseId = row.dataset.phase;\n    document.querySelectorAll('tr[data-phase=\"' + phaseId + '\"]:not(.phase)').forEach(function(child) {\n      child.classList.remove(\"hidden\");\n    });\n  });\n  document.querySelectorAll(\"tr.type\").forEach(function(row) {\n    row.classList.remove(\"collapsed\");\n    var icon = row.querySelector(\".toggle-icon\");\n    if (icon) icon.textContent = \"‚ñΩ\";\n  });\n  document.querySelectorAll(\"tr.work\").forEach(function(row) {\n    row.classList.remove(\"collapsed\");\n    var icon = row.querySelector(\".toggle-icon\");\n    if (icon) icon.textContent = \"‚ñø\";\n  });\n}\n\ndocument.addEventListener(\"DOMContentLoaded\", function() {\n  document.querySelectorAll(\"tr.phase\").forEach(function(row) {\n    row.addEventListener(\"click\", function(e) {\n      if (e.target.tagName === \"A\") return;\n      var phaseId = this.dataset.phase;\n      this.classList.toggle(\"collapsed\");\n      var icon = this.querySelector(\".toggle-icon\");\n      var isCollapsed = this.classList.contains(\"collapsed\");\n      if (icon) icon.textContent = isCollapsed ? \"‚ñ∂\" : \"‚ñº\";\n      document.querySelectorAll('tr[data-phase=\"' + phaseId + '\"]:not(.phase)').forEach(function(child) {\n        if (isCollapsed) {\n          child.classList.add(\"hidden\");\n        } else {\n          if (child.classList.contains(\"resource\")) {\n            var workId = child.dataset.work;\n            var parentWork = document.querySelector('tr.work[data-work=\"' + workId + '\"]');\n            if (parentWork && !parentWork.classList.contains(\"collapsed\")) {\n              child.classList.remove(\"hidden\");\n            }\n          } else if (child.classList.contains(\"work\")) {\n            var typeId = child.dataset.type;\n            var parentType = document.querySelector('tr.type[data-phase=\"' + phaseId + '\"][data-type=\"' + typeId + '\"]');\n            if (parentType && !parentType.classList.contains(\"collapsed\")) {\n              child.classList.remove(\"hidden\");\n            }\n          } else {\n            child.classList.remove(\"hidden\");\n          }\n        }\n      });\n    });\n  });\n  \n  document.querySelectorAll(\"tr.type\").forEach(function(row) {\n    row.addEventListener(\"click\", function(e) {\n      e.stopPropagation();\n      if (e.target.tagName === \"A\") return;\n      var phaseId = this.dataset.phase;\n      var typeId = this.dataset.type;\n      this.classList.toggle(\"collapsed\");\n      var icon = this.querySelector(\".toggle-icon\");\n      var isCollapsed = this.classList.contains(\"collapsed\");\n      if (icon) icon.textContent = isCollapsed ? \"‚ñ∑\" : \"‚ñΩ\";\n      \n      document.querySelectorAll('tr.work[data-phase=\"' + phaseId + '\"][data-type=\"' + typeId + '\"]').forEach(function(work) {\n        if (isCollapsed) {\n          work.classList.add(\"hidden\");\n        } else {\n          work.classList.remove(\"hidden\");\n        }\n      });\n      \n      document.querySelectorAll('tr.resource[data-phase=\"' + phaseId + '\"][data-type=\"' + typeId + '\"]').forEach(function(res) {\n        if (isCollapsed) {\n          res.classList.add(\"hidden\");\n        } else {\n          var workId = res.dataset.work;\n          var parentWork = document.querySelector('tr.work[data-work=\"' + workId + '\"]');\n          if (parentWork && !parentWork.classList.contains(\"collapsed\")) {\n            res.classList.remove(\"hidden\");\n          }\n        }\n      });\n    });\n  });\n  \n  document.querySelectorAll(\"tr.work\").forEach(function(row) {\n    row.addEventListener(\"click\", function(e) {\n      e.stopPropagation();\n      if (e.target.tagName === \"A\") return;\n      var workId = this.dataset.work;\n      this.classList.toggle(\"collapsed\");\n      var icon = this.querySelector(\".toggle-icon\");\n      var isCollapsed = this.classList.contains(\"collapsed\");\n      if (icon) icon.textContent = isCollapsed ? \"‚ñπ\" : \"‚ñø\";\n      \n      document.querySelectorAll('tr.resource[data-work=\"' + workId + '\"]').forEach(function(res) {\n        if (isCollapsed) {\n          res.classList.add(\"hidden\");\n        } else {\n          res.classList.remove(\"hidden\");\n        }\n      });\n    });\n  });\n  \n  document.querySelectorAll(\".treemap-item\").forEach(function(item) {\n    item.addEventListener(\"click\", function() {\n      var phaseId = this.dataset.phase;\n      var targetRow = document.getElementById(\"phase-\" + phaseId);\n      if (targetRow) {\n        if (targetRow.classList.contains(\"collapsed\")) targetRow.click();\n        targetRow.scrollIntoView({ behavior: \"smooth\", block: \"start\" });\n        targetRow.style.background = \"#FFFBEB\";\n        setTimeout(function() { targetRow.style.background = \"\"; }, 1500);\n      }\n    });\n  });\n  \n  // Default: hide resources\n  document.querySelectorAll(\"tr.resource\").forEach(function(row) {\n    row.classList.add(\"hidden\");\n  });\n  document.querySelectorAll(\"tr.work\").forEach(function(row) {\n    row.classList.add(\"collapsed\");\n    var icon = row.querySelector(\".toggle-icon\");\n    if (icon) icon.textContent = \"‚ñπ\";\n  });\n});\n</script>\n`;\n\nhtml += '</body>\\n</html>';\n\nreturn {\n  json: {\n    success: true,\n    html_content: html,\n    summary: {\n      total_cost: grandTotal,\n      total_cost_formatted: formatCurrency(grandTotal),\n      labor_hours: grandLaborHours,\n      labor_days: laborDays,\n      works_count: totalWorks,\n      found_percent: foundPercent,\n      pricing_city: pricingLevel,\n      currency: currency\n    },\n    photo_analysis: photoAnalysis,\n    quality_stats: qualityStats,\n    validation: validation,\n    message: '‚úÖ ' + t.doc_title + ' v2! ' + totalWorks + ' works ‚Üí ' + formatCurrency(grandTotal) + ' (' + pricingLevel + ')'\n  }\n};"
      },
      "id": "d8199234-bdcc-4eac-97f2-6c23b3d24c9b",
      "name": "STAGE 9 HTML Report",
      "type": "n8n-nodes-base.code",
      "position": [
        -1184,
        9120
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// FINAL HTML OUTPUT - Returns HTML directly to Form\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst input = $input.first().json;\nconst htmlContent = input.html_content || '<!DOCTYPE html><html><head><meta charset=\"UTF-8\"></head><body><h1>Error</h1><p>No content generated</p></body></html>';\n\n// Form Trigger with responseMode: lastNode will return this\nreturn {\n  json: {\n    success: true,\n    message: input.message || 'Estimate complete!',\n    summary: input.summary || {},\n    validation: input.validation || {}\n  },\n  binary: {\n    data: {\n      data: Buffer.from(htmlContent, 'utf-8').toString('base64'),\n      mimeType: 'text/html',\n      fileName: 'PhotoEstimate_v2.html'\n    }\n  }\n};"
      },
      "id": "6da3fa95-6a37-44cd-a791-65f9d65ca75e",
      "name": "Final HTML Output",
      "type": "n8n-nodes-base.code",
      "position": [
        -976,
        9120
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "content": "## ‚úÖ STAGE 7.5: Validation\n\n**Checks performed:**\n1. Minimum 3 work items\n2. Found rate % > 50%\n3. Zero cost items < 30%\n4. Renovation has demolition\n\nGroups works by category:\n- PREPARATION\n- MAIN\n- FINISHING\n- MEP",
        "height": 464,
        "width": 260,
        "color": 5
      },
      "id": "ca47704b-8b00-4abd-8a5f-06453bca8d83",
      "name": "Validation Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1728,
        8816
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üìä Pipeline Overview\n\n| Stage | Description |\n|-------|-------------|\n| 1 | Vision analyzes photo |\n| 4 | Decompose to works |\n| 5 | Vector search pricing |\n| 5.2 | Parse & Score results |\n| 7 | Calculate costs |\n| 7.5 | Validate works |\n| 9 | Generate HTML report |",
        "height": 240,
        "width": 328,
        "color": 7
      },
      "id": "c6d006c8-5a27-45cf-b05b-745975f538a4",
      "name": "Pipeline Overview",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4736,
        9408
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## Block 1: Photo Upload & Config\n\nThis block:\n- Receives photo from web form\n- Extracts language/region settings\n- Configures Vector DB collection\n- Validates photo presence\n\n**Supported formats:** JPG, PNG, WebP",
        "height": 824,
        "width": 1080,
        "color": 5
      },
      "id": "9a3e35a7-1dc1-4949-9083-a08ca72fd4ef",
      "name": "Block 1 Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4384,
        8816
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## Block 2: STAGE 1 - Vision Analysis\n\n### ü§ñ AI Photo Analysis\n\nGPT-4 Vision analyzes photo:\n- Detects room type (bathroom, kitchen, etc.)\n- Identifies construction elements\n- Estimates dimensions from references\n- Lists fixtures and materials\n\n**Output:** Structured JSON with elements",
        "height": 820,
        "width": 464,
        "color": 6
      },
      "id": "e780c527-3cb9-4f22-9d2f-869c1f4db06c",
      "name": "Block 2 Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3280,
        8816
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## Block 3: STAGE 4 - Work Decomposition\n\n### ü§ñ AI Decomposition\n\nDecomposes elements into construction works:\n- BATHROOM ‚Üí waterproofing, tiling, plumbing\n- KITCHEN ‚Üí cabinets, countertops, backsplash\n- FLOOR ‚Üí screed, covering, baseboard\n- WALL ‚Üí prep, finish, paint\n- MEP ‚Üí electrical, plumbing\n\n**Rules:**\n- Minimum 3 works per element\n- Include PREP + MAIN + FINISHING\n- For renovation: add demolition first",
        "height": 816,
        "width": 656,
        "color": 6
      },
      "id": "5d6fe3c9-3297-4dcb-b204-c0c5fe7e56bc",
      "name": "Block 3 Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2800,
        8816
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## Block 4: STAGE 5 - Pricing Loop\n\nProcesses each work item:\n\n1. **Vector Search** - Find rates in Qdrant\n2. **Parse Results** - Extract costs & resources\n3. **Quality Scoring** - Rate match quality\n4. **Calculate** - Qty √ó Unit Price\n\n**Database:** DDC CWICR\n700,000+ construction rates",
        "height": 816,
        "width": 380,
        "color": 5
      },
      "id": "ae87b1c5-20b8-4d5a-a9e5-089ec13a75ac",
      "name": "Block 4 Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2128,
        8816
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "### üîç Vector Search\n\nSearches DDC CWICR database:\n- 3072-dim embeddings\n- Top 5 matches per query\n- Multilingual support",
        "height": 176,
        "width": 276
      },
      "id": "648acb1f-0072-4f51-a487-23d8b1f14bc2",
      "name": "Vector Search Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -656,
        8816
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "### ‚ö° STAGE 5.2 Parse & Score\n\n**FIXED:** Correct document extraction\n\nExtracts from Qdrant results:\n- Total cost from content\n- Rate code, name, unit\n- Resources (labor/material/machine)\n",
        "height": 336,
        "width": 1356,
        "color": 4
      },
      "id": "c2c20083-dc76-4e4c-952d-6fe233255e2d",
      "name": "Parse Score Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1728,
        9296
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## Block 6: Report Generation\n\n### üìä STAGE 9 HTML Report\n**Features:**\n- Professional design\n- Quality indicators (‚óè ‚óã)\n- Calculation formulas\n- Clickable rate links\n- Cost structure charts\n- Phase timeline\n- Treemap visualization\n- 9 language support\n\n**Output:** HTML + XLS files",
        "height": 460,
        "width": 776,
        "color": 5
      },
      "id": "e67f7e75-bf2e-4301-8e96-e1db09d20101",
      "name": "Block 6 Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1456,
        8816
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üß† AI Models Used\n\n**GPT-4 Vision** ‚Äî Photo analysis\n**GPT-4** ‚Äî Work decomposition\n\nCan be replaced with:\n- Anthropic Claude 3.5\n- Google Gemini Pro\n- OpenRouter models",
        "height": 232,
        "width": 328
      },
      "id": "67555055-7265-44fc-b37b-1b92f1d0b9d0",
      "name": "AI Models Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4736,
        8816
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "### üì• Vector Database Setup\n\nTo enable search:\n1. Install Qdrant (local or VPS)\n2. Add Qdrant credentials\n3. Upload DDC CWICR dataset\n4. Select collection for your language\n\nCollections available on [GitHub](https://github.com/datadrivenconstruction)",
        "height": 248,
        "width": 272
      },
      "id": "3be63dc0-4474-47e0-828d-ffff4bb93b70",
      "name": "Qdrant Setup Note",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -656,
        9024
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "# üì∏ Photo Cost Estimate Pro v2\n\n## Multi-stage AI decomposition pipeline\n\n",
        "height": 144,
        "width": 560
      },
      "id": "f4bf0c00-30f2-426e-a8d1-0a609a378737",
      "name": "Info1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4384,
        8656
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "### Pipeline:\n1. üì∑ GPT-4 Vision ‚Üí Elements\n2. üîÑ STAGE 4: Decompose ‚Üí Works  \n3. üîç Vector Search DDC CWICR\n4. ‚úÖ Validation Stage\n5. üìä HTML Report\n\n### Regions (9):\nüá©üá™ Berlin | üá¨üáß Toronto | üá∑üá∫ St. Petersburg\nüá™üá∏ Barcelona | üá´üá∑ Paris | üáßüá∑ S√£o Paulo\nüá®üá≥ Shanghai | üá¶üá™ Dubai | üáÆüá≥ Mumbai\n\n‚≠ê **Star our repository** on [GitHub](https://github.com/datadrivenconstruction/OpenConstructionEstimate-DDC-CWICR)",
        "height": 312,
        "width": 328
      },
      "id": "857f5963-1b5e-46a6-bd9f-b69273845cb4",
      "name": "AI Models Note1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4736,
        9072
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "‚≠ê **If you find our tools helpful**, please consider **starring our repository** on [GitHub](https://github.com/datadrivenconstruction/OpenConstructionEstimate-DDC-CWICR). \n\nYour support helps us improve and continue developing open solutions for the community!\n",
        "height": 132,
        "width": 356
      },
      "id": "acf12375-9006-4c32-88f5-5af7aaa81cf5",
      "name": "Sticky Note22",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1056,
        8656
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üåç UI Messages\n\nTelegram menus:\n- Language selection\n- Photo request\n- Analysis options\n- Help text\n- Error messages\n\nAll localized in Config node",
        "height": 692,
        "width": 384,
        "color": 6
      },
      "id": "19f21d79-a44f-421f-87e1-08ccc503dc9e",
      "name": "UI Messages",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2448,
        12416
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "‚≠ê **If you find our tools helpful**, please consider **starring our repository** on [GitHub](https://github.com/datadrivenconstruction/OpenConstructionEstimate-DDC-CWICR). \n\nYour support helps us improve and continue developing open solutions for the community!\n",
        "height": 132,
        "width": 420
      },
      "id": "10f4db92-4059-4815-b10b-64026b36b4f4",
      "name": "Sticky Note24",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3760,
        13072
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üîê API CREDENTIALS SETUP\n\n### ‚¨áÔ∏è Configure node `üîë TOKEN` below:\n\n```json\n{\n  \"bot_token\": \"YOUR_BOT_TOKEN\",\n  \"AI_PROVIDER\": \"gemini\",\n  \"GEMINI_API_KEY\": \"YOUR_KEY\",\n  \"OPENAI_API_KEY\": \"YOUR_KEY\",\n  \"QDRANT_URL\": \"http://...\",\n  \"QDRANT_API_KEY\": \"YOUR_KEY\"\n}\n```\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n---\n\n### üì° APIs Required (3 keys):\n\n| # | API | Field | Get from |\n|---|-----|-------|----------|\n| 1 | Telegram | `bot_token` | @BotFather |\n| 2 | OpenAI | `OPENAI_API_KEY` | platform.openai.com |\n| 3 | Gemini | `GEMINI_API_KEY` | aistudio.google.com |\n\n\n### ‚öôÔ∏è Vision Provider:\n\n`AI_PROVIDER`:\n- `\"gemini\"` ‚Üí Gemini 2.0 Flash\n- `\"openai\"` ‚Üí GPT-4 Vision\n\n---\n\n### ‚úÖ Quick Start:\n\n1. Get bot token from @BotFather\n2. Get OpenAI key (for embeddings)\n3. Get Gemini key (for vision)\n4. Paste in `üîë TOKEN` node\n5. Set Telegram credential\n6. Activate workflow!",
        "height": 1200,
        "width": 428,
        "color": 5
      },
      "id": "b3e04dd3-ab44-4df2-b3ee-14cd3e772637",
      "name": "üîê Credentials Setup2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3760,
        13216
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üîÄ Route Switch\n\n**17 Actions:**\n\n| # | Action | Description |\n|---|--------|-------------|\n| 0 | show_lang | Language menu |\n| 1 | ask_photo | Request photo |\n| 2 | lang_selected | Save language |\n| 3 | show_analyze | Photo options |\n| 4 | analyze | AI vision |\n| 5 | show_edit_menu | Edit work |\n| 6 | works_updated | Qty changed |\n| 7 | ask_new_work | Add work |\n| 8 | start_calc | Calculate |\n| 9 | show_help | Help text |\n| 10 | view_details | Work info |\n| 11 | export_excel | CSV export |\n| 12 | export_pdf | PDF export |\n| 13 | process_pdf | PDF analysis |\n| 14 | analyze_text | Text input |\n| 15 | refine | Re-analyze |\n| 16 | fallback | Unknown |",
        "height": 1136,
        "width": 308,
        "color": 5
      },
      "id": "9b65504c-b499-4b54-aa69-5204f2b3a6c3",
      "name": "Route Switch2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2784,
        12896
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üåê Config\n\n**9 Languages:**\nDE, EN, RU, ES, FR, IT, PL, PT, UK\n\n**Contains:**\n- UI messages\n- Button labels\n- Currency symbols\n- Database mapping\n- System prompts\n\n**Auto-selects:**\n- Database by language\n- Currency by region",
        "height": 808,
        "width": 220,
        "color": 5
      },
      "id": "8006ce18-52c8-4fa1-915d-b88c1fd93446",
      "name": "Config & Localization2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3024,
        13216
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üß† Main Router\n\nCentral message handler:\n\n**Input:** Telegram Update\n\n**Processing:**\n- Parse message/callback\n- Manage user sessions\n- Detect content type\n- Route to action\n\n**Output:**\n`action` ‚Üí Route switch",
        "height": 808,
        "width": 268,
        "color": 5
      },
      "id": "bcf131f9-309a-4fea-a021-cada42d8a01b",
      "name": "Main Router2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3312,
        13216
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## ‚úÖ CHECKLIST\n\n**1. Telegram Bot**\n- [ ] Created via @BotFather\n- [ ] Token in üîë TOKEN\n- [ ] Credential configured\n\n**2. OpenAI**\n- [ ] API key obtained\n- [ ] Added to üîë TOKEN\n\n**3. Gemini/GPT-4**\n- [ ] Vision API enabled\n- [ ] Key configured\n\n**4. Activation**\n- [ ] Workflow active\n- [ ] Webhook set",
        "height": 428,
        "width": 324
      },
      "id": "3974e6e0-57a8-4179-add1-e82b0c29cbfc",
      "name": "Checklist2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4096,
        13536
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## ‚öôÔ∏è Telegram Credentials\n\n### Setup n8n Credential:\n\n1. **Settings** ‚Üí Credentials\n2. **Add** ‚Üí Telegram API\n3. Enter Bot Token\n4. **Save**\n\n### Configure Trigger:\n1. Select credential in `Telegram Trigger`\n2. Set webhook mode\n3. Activate workflow\n\n### Test:\nSend `/start` to your bot",
        "height": 436,
        "width": 328
      },
      "id": "7342e6b1-d48c-4bfd-b2f7-bd82e6651a76",
      "name": "Telegram Credentials1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4096,
        13984
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üöÄ DDC CWICR Pipeline\n### Construction Cost Estimation Bot\n\n**Version:** 10.3 Enhanced\n**Author:** DataDrivenConstruction.io\n\n**Features:**\n- üì∑ Photo analysis (GPT-4 Vision / Gemini)\n- üìÑ PDF floor plan processing\n- üîç Vector search (Qdrant + OpenAI)\n- ü§ñ AI reranking for accuracy\n- üìä HTML/Excel/PDF export\n- üåç 9 languages supported\n\n**Database:** 55,000+ construction rates\n\n‚≠ê **Star our repo:** [GitHub](https://github.com/datadrivenconstruction/OpenConstructionEstimate-DDC-CWICR)",
        "height": 440,
        "width": 318
      },
      "id": "13ac8022-af72-442e-a96f-d4e622a90ec0",
      "name": "Intro2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4096,
        13072
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// AGG - Final aggregation of calculation results + FREE DEMO info\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config2').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\n\nconst L = cfg.L || {};\nlet total = 0, workers_sum = 0, materials_sum = 0, machines_sum = 0, labor_hours_sum = 0;\nlet found_count = 0;\n\n// Get accumulated results\nconst storedResults = sd.res?.[cid] || [];\n\nconsole.log('=== AGG ===');\nconsole.log('Results count:', storedResults.length);\n\n// Process each result\nconst works = storedResults.map(w => {\n  const uc = w.uc || 0;\n  const tc = w.tc || 0;\n\n  total += tc;\n  workers_sum += (w.workers_total || 0);\n  materials_sum += (w.materials_total || 0);\n  machines_sum += (w.machines_total || 0);\n  labor_hours_sum += (w.labor_hours || 0);\n\n  if (w._found) found_count++;\n\n  return {\n    id: w.id,\n    name: w.name || w.sq,\n    query: w.sq || w.query,\n    qty: w.qty,\n    unit: w.unit,\n    room: w.room,\n    uc: uc,\n    tc: tc,\n    rate_code: w.rate_code || '',\n    rate_name: w.rate_name || '',\n    resources: w.resources || [],\n    workers_total: w.workers_total || 0,\n    materials_total: w.materials_total || 0,\n    machines_total: w.machines_total || 0,\n    labor_hours: w.labor_hours || 0,\n    found: w._found || false,\n    scope_of_work: w.scope_of_work || [],\n    original_query: w.original_query || w.name\n  };\n});\n\nconst pct = works.length > 0 ? Math.round(found_count / works.length * 100) : 0;\n\n// FREE DEMO info\nconst isLimited = session.isLimited || false;\nconst originalTotal = session.totalWorks || works.length;\nconst skippedWorks = originalTotal - works.length;\n\nconsole.log('Calculated:', works.length, '/', originalTotal);\nconsole.log('Found:', found_count, '/', works.length);\nconsole.log('Total cost:', total.toFixed(2));\nconsole.log('Limited:', isLimited);\n\n// Cleanup staticData\nif (sd.res?.[cid]) delete sd.res[cid];\nif (sd.calcProgress?.[cid]) delete sd.calcProgress[cid];\nif (sd.progress?.[cid]) delete sd.progress[cid];\n\n// Save for report generation\nsd.lastResults = { works, total, workers_sum, materials_sum, machines_sum, labor_hours_sum, found_count, pct, L };\n\nreturn {\n  json: {\n    chatId: cid,\n    bot_token: cfg.bot_token,\n    works: works,\n    total: Math.round(total * 100) / 100,\n    workers_sum: Math.round(workers_sum * 100) / 100,\n    materials_sum: Math.round(materials_sum * 100) / 100,\n    machines_sum: Math.round(machines_sum * 100) / 100,\n    labor_hours_sum: Math.round(labor_hours_sum * 100) / 100,\n    found_count: found_count,\n    total_count: works.length,\n    pct: pct,\n    L: L,\n    currency: L.sym || '‚Ç¨',\n    description: session.description || '',\n    // FREE DEMO\n    _is_limited: isLimited,\n    _total_works: originalTotal,\n    _skipped_works: skippedWorks\n  }\n};"
      },
      "id": "1ed33310-ab69-4c24-86cd-a242b60c8e45",
      "name": "Agg2",
      "type": "n8n-nodes-base.code",
      "position": [
        -544,
        14368
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/deleteMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('üßπ Prep Cleanup2').first().json.chatId }},\n  \"message_id\": {{ $('üßπ Prep Cleanup2').first().json._delete_progress_msg || 0 }}\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "37c599b6-adbb-427d-a623-1c329f18a0ff",
      "name": "üóëÔ∏è Delete Progress Msg2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -720,
        14368
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/deleteMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('üßπ Prep Cleanup2').first().json.chatId }},\n  \"message_id\": {{ $('üßπ Prep Cleanup2').first().json._delete_work_msg || 0 }}\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "eb03b668-fbe5-46a7-a333-f28c200d39c7",
      "name": "üóëÔ∏è Delete Work Msg2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -912,
        14368
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PREP CLEANUP - Prepare message IDs for deletion after loop completes\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config2').first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(cfg.chatId);\n\n// Get message IDs to delete\nconst lastMsgId = sd.calcProgress?.[cid]?.lastMsgId || null;\nconst progressMsgId = sd.progress?.[cid]?.message_id || null;\n\nconsole.log('=== PREP CLEANUP ===');\nconsole.log('ChatId:', cid);\nconsole.log('Work msg:', lastMsgId);\nconsole.log('Progress msg:', progressMsgId);\n\nreturn {\n  json: {\n    chatId: cfg.chatId,\n    bot_token: cfg.bot_token,\n    L: cfg.L,\n    _delete_work_msg: lastMsgId,\n    _delete_progress_msg: progressMsgId\n  }\n};"
      },
      "id": "efa50c61-fe75-41ef-b246-c36815c3c381",
      "name": "üßπ Prep Cleanup2",
      "type": "n8n-nodes-base.code",
      "position": [
        -1088,
        14368
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// ACC - Accumulate calculation results for final aggregation\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst sd = $getWorkflowStaticData('global');\nconst w = $('üìä Update Result2').first().json;\nconst cid = String(w.chatId);\n\nif (!sd.res) sd.res = {};\nif (!sd.res[cid]) sd.res[cid] = [];\nsd.res[cid].push(w);\n\nconsole.log('Accumulated:', sd.res[cid].length, '/', w.total_works);\n\nreturn { json: w };"
      },
      "id": "282f9f65-8fd3-4772-96f8-1c69bf9eaf8a",
      "name": "Acc2",
      "type": "n8n-nodes-base.code",
      "position": [
        -368,
        15168
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/editMessageText",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"message_id\": {{ $json._edit_msg_id || 0 }}, \"text\": {{ JSON.stringify($json._result_text) }}, \"parse_mode\": \"Markdown\"}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "1c883dbe-91e1-4f98-bca5-bc67cdc00681",
      "name": "üì§ Edit Result2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -544,
        15168
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// UPDATE RESULT - Format result message (‚úì Found / Not found)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst calcData = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(calcData.chatId);\nconst L = calcData.L || {};\n\nconst current = calcData.work_index || 1;\nconst total = calcData.total_works || 1;\nconst name = calcData.name || calcData.sq || 'Work';\n\nlet shortName = name.length > 22 ? name.substring(0, 19) + '...' : name;\n\nconst tc = parseFloat(calcData.tc) || 0;\nconst uc = parseFloat(calcData.uc) || 0;\nconst rateCode = String(calcData.rate_code || '');\nconst rateName = String(calcData.rate_name || '');\nconst currency = calcData.currency || L.sym || '‚Ç¨';\n\nconst hasValidRate = rateCode && \n  !rateCode.includes('NOT_FOUND') && \n  !rateCode.includes('PAYLOAD_NOT_FOUND');\n\nconst found = tc > 0 || uc > 0 || hasValidRate || (rateName && rateName.length > 0);\n\nconsole.log('Result:', shortName, found ? '‚úì' : '‚úó', tc.toFixed(0), currency);\n\nlet text = '';\nif (found) {\n  text = current + '/' + total + ' ' + shortName + ' ‚úì\\n';\n  text += tc.toFixed(0) + ' ' + currency;\n  if (rateCode && hasValidRate) text += ' ¬∑ ' + rateCode.substring(0, 20);\n} else {\n  text = current + '/' + total + ' ' + shortName + '\\n';\n  text += (L.not_found || '–ù–µ –Ω–∞–π–¥–µ–Ω–æ');\n}\n\nconst msgId = sd.calcProgress?.[cid]?.lastMsgId || null;\n\nreturn { json: { ...calcData, _result_text: text, _edit_msg_id: msgId, _found: found } };"
      },
      "id": "0f4bc0cf-8830-4a38-b38e-2ee5597d990e",
      "name": "üìä Update Result2",
      "type": "n8n-nodes-base.code",
      "position": [
        -704,
        15168
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PREP QUERY - Prepare search query with credentials from TOKEN\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst loopItem = $input.first().json;\nconst tokenData = $('üîë TOKEN2').first().json;\n\nconst originalQuery = loopItem.sq || loopItem.query || loopItem.name || '';\nconst collectionName = loopItem.db || '';\nconst L = loopItem.L || {};\nconst workUnit = loopItem.unit || 'm¬≤';\nconst workQty = loopItem.qty || 1;\n\n// Get credentials from TOKEN node\nconst OPENAI_API_KEY = tokenData.OPENAI_API_KEY || '';\nconst QDRANT_URL = tokenData.QDRANT_URL || 'http://localhost:6333';\nconst QDRANT_API_KEY = tokenData.QDRANT_API_KEY || '';\n\nconsole.log('=== PREP QUERY ===');\nconsole.log('Query:', originalQuery);\nconsole.log('Collection:', collectionName);\nconsole.log('Qdrant URL:', QDRANT_URL);\n\nif (!OPENAI_API_KEY || !originalQuery || !collectionName) {\n  console.log('ERROR: Missing required data');\n  return [{ json: { ...loopItem, _error: 'Missing data', _skip: true } }];\n}\n\nconst searchLang = L.search_lang || 'Russian';\n\n// Detect database language from collection name\nconst isRussianDB = collectionName.includes('RU_') || collectionName.includes('_RU');\nconst isGermanDB = collectionName.includes('DE_');\nconst dbLang = isRussianDB ? 'Russian' : (isGermanDB ? 'German' : 'English');\n\nconst transformPrompt = `You are a construction cost database search expert for ${dbLang} construction rates database.\n\nTASK: Transform user query into optimal SEARCH KEYWORDS that will match entries in a vector database of construction work rates.\n\nDATABASE CONTEXT:\n- Contains standardized construction work rates with codes, names, units, resources\n- Each rate has: rate_code, rate_name, rate_unit, scope_of_work, resources\n- Language: ${dbLang}\n\nTRANSFORMATION RULES:\n1. EXPAND abbreviations to full professional terms\n2. ADD synonyms and related construction terms\n3. INCLUDE work action verbs (install, apply, lay, mount)\n4. Keep original query terms + expanded terms\n5. Output in ${dbLang} language only\n\nUSER QUERY: ${originalQuery}\nUNIT: ${workUnit}\n\nReply with ONLY the optimized search keywords (one line, no explanations):`;\n\nreturn [{ json: {\n  ...loopItem,\n  _original_query: originalQuery,\n  _transform_prompt: transformPrompt,\n  _collection: collectionName,\n  _openai_key: OPENAI_API_KEY,\n  _db_lang: dbLang,\n  _qdrant_url: QDRANT_URL,\n  _qdrant_key: QDRANT_API_KEY\n}}];"
      },
      "id": "c07891e0-09e7-4f13-a19c-8166ba89a208",
      "name": "1Ô∏è‚É£ Prep Query2",
      "type": "n8n-nodes-base.code",
      "position": [
        -368,
        14768
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// SAVE WORK MSG - Store message ID for later editing/deletion\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst loopItem = $('üìù Prep Work Msg2').first().json;\nconst tgResp = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(loopItem.chatId);\n\nif (!sd.calcProgress) sd.calcProgress = {};\nif (!sd.calcProgress[cid]) sd.calcProgress[cid] = {};\nsd.calcProgress[cid].lastMsgId = tgResp.result?.message_id || null;\n\nconsole.log('Saved msg ID:', sd.calcProgress[cid].lastMsgId);\n\nreturn { json: loopItem };"
      },
      "id": "6a6baf8a-5c58-4413-8acb-ce1fce9ac1cf",
      "name": "üíæ Save Work Msg2",
      "type": "n8n-nodes-base.code",
      "position": [
        -544,
        14768
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $(\"üìù Prep Work Msg2\").item.json.chatId }}, \"text\": {{ JSON.stringify($(\"üìù Prep Work Msg2\").item.json._work_text) }}, \"parse_mode\": \"Markdown\"}",
        "options": {}
      },
      "id": "5af083b5-1ca5-48f8-8f5b-f55993f8cc9a",
      "name": "üì§ Send Work2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -720,
        14768
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/deleteMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"message_id\": {{ $json._prev_msg_id || 0 }}}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "da2d2d0a-8243-4f66-8378-d75ba2ddbe3e",
      "name": "üóëÔ∏è Delete Prev2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -912,
        14768
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PREP WORK MSG - Create \"Searching...\" message for current work\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst loopItem = $('Loop2').first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(loopItem.chatId);\nconst L = loopItem.L || {};\n\nconst current = loopItem.work_index || 1;\nconst total = loopItem.total_works || 1;\nconst name = loopItem.name || loopItem.sq || 'Work';\nconst qty = loopItem.qty || 1;\nconst unit = loopItem.unit || 'm¬≤';\nconst room = loopItem.room || '';\n\nlet shortName = name.length > 25 ? name.substring(0, 22) + '...' : name;\n\n// Minimal message\nlet text = current + '/' + total + ' ' + shortName + '\\n';\ntext += qty + ' ' + unit;\nif (room) text += ' ¬∑ ' + room;\ntext += '\\n...';\n\nconst prevMsgId = sd.calcProgress?.[cid]?.lastMsgId || null;\n\nconsole.log('Work', current, '/', total);\n\nreturn { json: { ...loopItem, _work_text: text, _prev_msg_id: prevMsgId } };"
      },
      "id": "949ada29-99e5-40c2-9aa2-e389081e709f",
      "name": "üìù Prep Work Msg2",
      "type": "n8n-nodes-base.code",
      "position": [
        -1088,
        14768
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "id": "20889cc1-e1b0-4d64-92d3-3a06d2b5ab95",
      "name": "Loop2",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [
        -1360,
        14464
      ],
      "typeVersion": 3
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PREP WORKS - Prepare work items for calculation loop (FREE DEMO: 5 items)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $input.first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\n\n// Get limited works list (max 5 for FREE DEMO)\nconst FREE_LIMIT = cfg._free_limit || 5;\nconst works = session.limitedWorks || (session.works || []).slice(0, FREE_LIMIT);\nconst db = session.db || cfg.db;\nconst L = session.L || cfg.L;\n\n// Initialize results accumulator\nif (!sd.res) sd.res = {};\nsd.res[cid] = [];\n\nconst totalWorks = works.length;\n\nconsole.log('=== PREP WORKS ===');\nconsole.log('Processing:', totalWorks, 'items');\n\n// Return array for loop processing\nreturn works.map((w, idx) => ({ \n  json: { \n    ...w, \n    db, \n    L, \n    currency: L?.sym || '‚Ç¨',\n    bot_token: cfg.bot_token, \n    chatId: cid, \n    sq: w.query || w.name,\n    original_query: w.query || w.name,\n    work_index: idx + 1, \n    total_works: totalWorks,\n    _is_limited: cfg._is_limited,\n    _original_total: cfg._total_works\n  } \n}));"
      },
      "id": "12010a88-b015-47b6-bd67-e2f8949f245c",
      "name": "Prep Works2",
      "type": "n8n-nodes-base.code",
      "position": [
        -1600,
        14464
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// SAVE PROGRESS ID - Store initial progress message ID for cleanup\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config2').first().json;\nconst prepData = $('üìù Prep Progress2').first().json;\nconst telegramResponse = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(cfg.chatId);\n\n// Store progress message info\nif (!sd.progress) sd.progress = {};\nsd.progress[cid] = {\n  message_id: telegramResponse.result?.message_id || 0,\n  chat_id: cfg.chatId,\n  bot_token: cfg.bot_token\n};\n\n// Initialize calculation progress tracker\nif (!sd.calcProgress) sd.calcProgress = {};\nsd.calcProgress[cid] = { lastMsgId: null };\n\nconsole.log('Progress msg ID:', sd.progress[cid].message_id);\n\nreturn { \n  json: { \n    ...cfg,\n    _free_limit: prepData._free_limit,\n    _is_limited: prepData._is_limited,\n    _total_works: prepData._total_works\n  } \n};"
      },
      "id": "060cbaba-df76-4ccd-ae93-24965c24b917",
      "name": "Save Progress ID2",
      "type": "n8n-nodes-base.code",
      "position": [
        -1776,
        14464
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json._progress_chat_id }}, \"text\": {{ JSON.stringify($json._progress_text) }}, \"parse_mode\": \"Markdown\"}",
        "options": {}
      },
      "id": "f0d346c7-32af-48f4-8b8a-16d1d96716b7",
      "name": "üì§ Send Progress2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -1984,
        14464
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PREP PROGRESS - Show initial calculation message with FREE DEMO limit\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config2').first().json;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(cfg.chatId);\nconst session = sd.sess?.[cid] || {};\n\nconst allWorks = session.works || [];\n\n// Get L from Config (primary) or session (fallback)\nconst L = cfg.L || session.L || {};\n\nconsole.log('=== PREP PROGRESS ===');\nconsole.log('L.search_lang:', L.search_lang);\n\n// FREE DEMO LIMIT\nconst FREE_LIMIT = 5;\nconst totalWorks = allWorks.length;\nconst isLimited = totalWorks > FREE_LIMIT;\nconst worksToProcess = Math.min(totalWorks, FREE_LIMIT);\n\nsession.isLimited = isLimited;\nsession.totalWorks = totalWorks;\nsession.limitedWorks = allWorks.slice(0, FREE_LIMIT);\n\nconst estimatedMinutes = Math.max(1, Math.ceil(worksToProcess * 8 / 60));\n\n// Use localized text with Russian fallback\nconst calcWord = L.loading || '–†–∞—Å—á—ë—Ç...';\nconst itemsWord = L.items || '–ø–æ–∑–∏—Ü–∏–π';\nconst minWord = L.min || '–º–∏–Ω';\n\nlet text = '';\nif (isLimited) {\n  text = 'FREE DEMO ¬∑ ' + FREE_LIMIT + '/' + totalWorks + ' ' + itemsWord + '\\n';\n} else {\n  text = calcWord + ' ' + worksToProcess + ' ' + itemsWord + '\\n';\n}\ntext += '~' + estimatedMinutes + ' ' + minWord;\n\nreturn {\n  json: {\n    ...cfg,\n    _progress_chat_id: cfg.chatId,\n    _progress_text: text,\n    _free_limit: FREE_LIMIT,\n    _is_limited: isLimited,\n    _total_works: totalWorks\n  }\n};"
      },
      "id": "2c6a6098-4f43-488b-baf3-9cb101e5ee9f",
      "name": "üìù Prep Progress2",
      "type": "n8n-nodes-base.code",
      "position": [
        -2224,
        14464
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// üìÑ PDF DOWNLOAD PREP\nconst cfg = $('Config2').first().json;\nconsole.log('=== PDF DOWNLOAD PREP ===');\nreturn {\n  json: {\n    ...cfg,\n    pdfFileId: cfg.pdfFileId,\n    pdfFileName: cfg.pdfFileName || 'document.pdf'\n  }\n};"
      },
      "id": "7a481d90-bee5-4bce-9551-de0c420fba8d",
      "name": "üìÑ PDF Download Prep1",
      "type": "n8n-nodes-base.code",
      "position": [
        -1792,
        13904
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// üßπ DEDUPLICATE & MERGE v7\nconst cfgNode = $('Config2').first().json;\nconst cid = String(cfgNode.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst acc = sd.pdfAcc?.[cid] || { rooms: [], works: [] };\n\nconsole.log('=== DEDUPLICATE v7 ===');\nconsole.log('Raw rooms:', acc.rooms.length, 'works:', acc.works.length);\n\n// Dedupe rooms\nconst roomMap = new Map();\nfor (const r of acc.rooms) {\n  const key = (r.name || '').toLowerCase().trim();\n  if (!roomMap.has(key) || (r.area_m2 || 0) > (roomMap.get(key).area_m2 || 0)) {\n    roomMap.set(key, r);\n  }\n}\nconst rooms = Array.from(roomMap.values()).map((r, i) => ({\n  ...r,\n  id: 'R' + String(i + 1).padStart(3, '0')\n}));\n\n// Dedupe works\nconst workMap = new Map();\nfor (const w of acc.works) {\n  const key = (w.name || '').toLowerCase().trim() + '_' + (w.unit || '') + '_' + (w.room || '');\n  if (workMap.has(key)) {\n    workMap.get(key).qty += (w.qty || 1);\n  } else {\n    workMap.set(key, { ...w, qty: w.qty || 1 });\n  }\n}\n\nconst works = Array.from(workMap.values()).map((w, i) => ({\n  id: 'W' + String(i + 1).padStart(3, '0'),\n  seq: i + 1,\n  name: w.name,\n  query: w.query || w.name,\n  qty: Math.round((w.qty || 1) * 100) / 100,\n  unit: w.unit || 'm¬≤',\n  room: w.room || '',\n  details: w.details || '',\n  conf: 'medium'\n}));\n\nconsole.log('Unique rooms:', rooms.length, 'works:', works.length);\n\nconst totalArea = rooms.reduce((sum, r) => sum + (r.area_m2 || 0), 0);\n\n// Save to session\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = {};\nsd.sess[cid].works = works;\nsd.sess[cid].rooms = rooms;\nsd.sess[cid].totalArea = totalArea;\nsd.sess[cid].L = cfgNode.L;\nsd.sess[cid].state = 'wait_edit';\n\n// Cleanup\nif (sd.pdfAcc) delete sd.pdfAcc[cid];\nif (sd.pdfData) delete sd.pdfData[cid];\n\nreturn {\n  json: {\n    chatId: cfgNode.chatId,\n    bot_token: cfgNode.bot_token,\n    L: cfgNode.L,\n    works,\n    rooms,\n    totalArea\n  }\n};"
      },
      "id": "35f8e8fd-de62-49c4-9dfd-1a9de94b3382",
      "name": "üßπ Deduplicate & Merge1",
      "type": "n8n-nodes-base.code",
      "position": [
        416,
        13776
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"text\": {{ JSON.stringify($json.msg) }}, \"parse_mode\": \"Markdown\", \"reply_markup\": {\"inline_keyboard\": {{ JSON.stringify($json.keyboard) }}}}",
        "options": {}
      },
      "id": "57a3f1b1-6fb0-422e-8e3a-57ef469e4809",
      "name": "üì§ Send Works2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        1056,
        13536
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// SHOW WORKS - Display extracted work items with edit buttons\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfgNode = $('Config2').first().json;\nconst inputData = $input.first().json;\nconst sd = $getWorkflowStaticData('global');\n\nconst chatId = inputData.chatId || cfgNode.chatId;\nconst bot_token = inputData.bot_token || cfgNode.bot_token;\nconst cid = String(chatId);\n\n// Get L from multiple sources (session is most reliable)\nconst session = sd.sess?.[cid] || {};\nlet L = cfgNode.L || session.L || inputData.L || {};\n\n// Get works from input (from Deduplicate) or session\nconst works = inputData.works || session.works || [];\nconst rooms = inputData.rooms || session.rooms || [];\n\nconsole.log('=== SHOW WORKS ===');\nconsole.log('Works:', works.length);\nconsole.log('L.search_lang:', L.search_lang);\n\n// Save to session\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = {};\nif (works.length > 0) {\n  sd.sess[cid].works = works;\n  sd.sess[cid].rooms = rooms;\n  sd.sess[cid].L = L;\n  sd.sess[cid].db = cfgNode.db;\n  sd.sess[cid].state = 'wait_edit';\n}\n\nfunction short(str, len) {\n  str = String(str || '');\n  return str.length > len ? str.substring(0, len - 1) + '‚Ä¶' : str;\n}\n\nconst totalArea = rooms.reduce((sum, r) => sum + (r.area_m2 || 0), 0);\n\n// Use localized labels with fallback\nconst roomWord = L.rooms || '–∫–æ–º–Ω–∞—Ç';\nconst workWord = L.works_identified || '–ø–æ–∑–∏—Ü–∏–π';\nconst generalWord = L.general || '–û–±—â–µ–µ';\n\nlet msg = '*' + rooms.length + ' ' + roomWord;\nif (totalArea > 0) msg += ' ¬∑ ' + (Math.round(totalArea * 10) / 10) + ' m¬≤';\nmsg += '*\\n';\nmsg += '_' + works.length + ' ' + workWord + '_\\n\\n';\n\nif (works.length === 0) {\n  msg += '_' + (L.no_works || '–†–∞–±–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã') + '_\\n';\n} else {\n  const worksByRoom = new Map();\n  const noRoom = [];\n\n  for (const w of works) {\n    if (w.room && w.room.length > 0) {\n      if (!worksByRoom.has(w.room)) worksByRoom.set(w.room, []);\n      worksByRoom.get(w.room).push(w);\n    } else {\n      noRoom.push(w);\n    }\n  }\n\n  let workNum = 1;\n\n  for (const [roomName, roomWorks] of worksByRoom) {\n    const room = rooms.find(r => r.name === roomName);\n    const areaStr = room?.area_m2 ? ' ¬∑ ' + room.area_m2 + ' m¬≤' : '';\n    msg += '*' + short(roomName, 20) + '*' + areaStr + '\\n';\n\n    for (const w of roomWorks) {\n      const wname = short(w.name || 'Work', 25);\n      const qty = typeof w.qty === 'number' ? Math.round(w.qty * 100) / 100 : w.qty;\n      msg += workNum + '. ' + wname + ' ‚Äî ' + qty + ' ' + (w.unit || '') + '\\n';\n      workNum++;\n    }\n    msg += '\\n';\n  }\n\n  if (noRoom.length > 0) {\n    msg += '*' + generalWord + '*\\n';\n    for (const w of noRoom) {\n      const wname = short(w.name || 'Work', 25);\n      const qty = typeof w.qty === 'number' ? Math.round(w.qty * 100) / 100 : w.qty;\n      msg += workNum + '. ' + wname + ' ‚Äî ' + qty + ' ' + (w.unit || '') + '\\n';\n      workNum++;\n    }\n  }\n}\n\n// Build keyboard\nconst keyboard = [];\nconst maxBtns = works.length;\nif (maxBtns > 0) {\n  for (let i = 0; i < maxBtns; i += 5) {\n    const row = [];\n    for (let j = 0; j < 5 && i + j < maxBtns; j++) {\n      row.push({ text: '‚úè' + (i + j + 1), callback_data: 'edit_work_' + (i + j) });\n    }\n    keyboard.push(row);\n  }\n}\n\nkeyboard.push([\n  { text: L.btn_add_work || '+ –ü–æ–∑–∏—Ü–∏—è', callback_data: 'add_work' },\n  { text: L.btn_calc || '‚ñ∂ –†–∞—Å—á—ë—Ç', callback_data: 'calculate' }\n]);\nkeyboard.push([\n  { text: L.btn_new || 'üîÑ –ó–∞–Ω–æ–≤–æ', callback_data: 'new_photo' }\n]);\n\nreturn { json: { chatId, bot_token, L, msg, keyboard, works, rooms } };"
      },
      "id": "e65d547c-94f6-4149-8dd3-a87ab2bc2fd8",
      "name": "üìä Show Works2",
      "type": "n8n-nodes-base.code",
      "position": [
        928,
        13680
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// üì¶ ACCUMULATE v7\nconst cfg = $input.first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\n\nif (!sd.pdfAcc) sd.pdfAcc = {};\nif (!sd.pdfAcc[cid]) sd.pdfAcc[cid] = { rooms: [], works: [], totalArea: 0 };\n\nconst acc = sd.pdfAcc[cid];\n\nif (cfg.pageRooms) acc.rooms.push(...cfg.pageRooms);\nif (cfg.pageWorks) acc.works.push(...cfg.pageWorks);\nif (cfg.totalArea) acc.totalArea = Math.max(acc.totalArea, cfg.totalArea);\n\nconsole.log('Accumulated - rooms:', acc.rooms.length, 'works:', acc.works.length);\n\nreturn { json: { ...cfg } };"
      },
      "id": "b4a24780-f0d2-4814-ba99-a9e1a3c10ab0",
      "name": "üì¶ Accumulate Pages1",
      "type": "n8n-nodes-base.code",
      "position": [
        656,
        13920
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// üè† PARSE PDF PAGE v7\nconst prepData = $('üëÅÔ∏è Prep Vision PDF1').first().json;\nconst resp = $input.first().json;\n\nif (prepData._skip_vision) {\n  return { json: { ...prepData, pageRooms: [], pageWorks: [], totalArea: 0 } };\n}\n\nlet raw = resp.candidates?.[0]?.content?.parts?.[0]?.text || '';\nlet parsed = { rooms: [], works: [], total_area_m2: 0 };\n\ntry {\n  let clean = raw.replace(/```json\\s*/gi, '').replace(/```\\s*/gi, '').trim();\n  const s = clean.indexOf('{'), e = clean.lastIndexOf('}');\n  if (s !== -1 && e > s) {\n    parsed = JSON.parse(clean.substring(s, e + 1));\n  }\n  console.log('Parsed - rooms:', parsed.rooms?.length, 'works:', parsed.works?.length);\n} catch(err) {\n  console.log('Parse error:', err.message);\n}\n\nconst rooms = (parsed.rooms || []).map((r, i) => ({\n  id: 'R' + String(i + 1).padStart(3, '0'),\n  name: r.name || 'Room ' + (i + 1),\n  area_m2: r.area_m2 || 0\n}));\n\nconst works = (parsed.works || []).map((w, i) => {\n  let name = w.name || 'Work';\n  if (w.details && w.details.length > 0 && w.details.length < 30) {\n    name = name + ' ' + w.details;\n  }\n  return {\n    id: 'W' + String(i + 1).padStart(3, '0'),\n    name: name.trim(),\n    query: (w.name || 'Work').trim(),\n    room: w.room || '',\n    qty: w.qty || w.quantity || 1,\n    unit: w.unit || 'm¬≤',\n    details: w.details || '',\n    conf: 'medium'\n  };\n});\n\nreturn {\n  json: {\n    ...prepData,\n    pageRooms: rooms,\n    pageWorks: works,\n    totalArea: parsed.total_area_m2 || 0\n  }\n};"
      },
      "id": "381969d9-5675-4708-ace9-b2edf9b730b6",
      "name": "üè† Parse PDF Page1",
      "type": "n8n-nodes-base.code",
      "position": [
        432,
        13920
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json._vision_url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json._vision_body) }}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          },
          "timeout": 120000
        }
      },
      "id": "fe970bc5-7176-42ae-a575-e3d97602fa34",
      "name": "üëÅÔ∏è Call Vision PDF1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        208,
        13920
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// üëÅÔ∏è PREP VISION PDF v7 - UNIVERSAL\nconst cfgNode = $('Config2').first().json;\nconst tokenConfig = $('üîë TOKEN2').first().json;\nconst loopData = $('üîÅ Loop PDF Pages1').first().json;\n\nconst GEMINI_API_KEY = tokenConfig.GEMINI_API_KEY;\nconst cid = String(cfgNode.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst pdfBase64 = sd.pdfData?.[cid]?.base64 || '';\n\nif (!pdfBase64 || pdfBase64.length < 100) {\n  return { json: { ...cfgNode, _skip_vision: true } };\n}\n\nconst lang = cfgNode.lang || 'EN';\nconst langName = {\n  'RU': 'Russian', 'EN': 'English', 'DE': 'German',\n  'ES': 'Spanish', 'FR': 'French', 'PT': 'Portuguese',\n  'ZH': 'Chinese', 'AR': 'Arabic', 'HI': 'Hindi'\n}[lang] || 'English';\n\nconst prompt = `Analyze this architectural floor plan / construction drawing.\n\nYOUR TASK:\n1. Find room schedule/table if present - extract room names and areas\n2. If no table, estimate rooms from the drawing\n3. Generate construction works list for cost estimation database search\n\nOUTPUT in ${langName}:\n{\n  \"total_area_m2\": 99.15,\n  \"rooms\": [\n    {\"name\": \"Room Name\", \"area_m2\": 15.5}\n  ],\n  \"works\": [\n    {\"name\": \"work description\", \"room\": \"Room Name\", \"qty\": 15.5, \"unit\": \"m¬≤\", \"details\": \"optional specs\"}\n  ]\n}\n\nWORK NAMING GUIDELINES:\n- Use short, searchable descriptions (good for database lookup)\n- Include specifications when visible: dimensions, materials, types\n- Examples of good work names:\n  - \"Floor tiling\" or \"Laminate flooring\" (not just \"flooring\")\n  - \"Wall plastering\" or \"Drywall installation\"\n  - \"Interior door 800√ó2000mm\" (include size if visible)\n  - \"Suspended ceiling\" or \"Stretch ceiling\"\n  - \"Toilet installation\" or \"Sink installation\"\n\nQUANTITY GUIDELINES:\n- Floor works: qty = room area\n- Wall works: estimate from perimeter √ó height (typically 2.5-3m)\n- Ceiling works: qty = room area\n- Doors/windows/fixtures: count from drawing\n- Use realistic quantities that match the total area\n\nIMPORTANT:\n- Read any tables/schedules in the drawing for accurate data\n- Each work should reference which room it belongs to\n- Include \"details\" field for dimensions, materials, or specifications when visible\n- Respond ONLY with valid JSON, no explanations`;\n\nconst apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=' + GEMINI_API_KEY;\nconst requestBody = {\n  contents: [{ parts: [\n    { text: prompt },\n    { inline_data: { mime_type: 'application/pdf', data: pdfBase64 } }\n  ]}],\n  generationConfig: { temperature: 0.1, maxOutputTokens: 8000 }\n};\n\nreturn { json: { ...cfgNode, _vision_url: apiUrl, _vision_body: requestBody } };"
      },
      "id": "d1e56c4b-6bca-4f09-a9f9-08ec9b8dcc68",
      "name": "üëÅÔ∏è Prep Vision PDF1",
      "type": "n8n-nodes-base.code",
      "position": [
        -16,
        13920
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "8685d884-6a71-410f-a29b-2d3729433518",
      "name": "üîÅ Loop PDF Pages1",
      "type": "n8n-nodes-base.splitInBatches",
      "position": [
        -224,
        13904
      ],
      "typeVersion": 3
    },
    {
      "parameters": {
        "jsCode": "// üìÑ PREP PAGES LOOP\nconst cfg = $('üìù Prep PDF Message1').first().json;\nconst pages = cfg.pdfPages || [{pageNum: 1}];\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst pdfData = sd.pdfData?.[cid] || {};\n\nreturn pages.map((p, i) => ({\n  json: {\n    ...cfg,\n    currentPage: p.pageNum,\n    totalPages: pages.length,\n    pdfBase64: pdfData.base64 || ''\n  }\n}));"
      },
      "id": "c80fc112-1a34-43a8-a95e-22502b4da4bd",
      "name": "üìÑ Prep Pages Loop1",
      "type": "n8n-nodes-base.code",
      "position": [
        -448,
        13904
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json._tg_chat_id }}, \"text\": {{ JSON.stringify($json._tg_text) }}, \"parse_mode\": \"Markdown\"}",
        "options": {}
      },
      "id": "b5d0be0e-d9a0-4fb4-9b8b-a04ab1cb3303",
      "name": "üì§ PDF Received1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -672,
        13904
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// üìù PREP PDF MESSAGE\nconst cfg = $('Config2').first().json;\nconst data = $input.first().json;\nconst pages = data.totalPages || 1;\nconst estMinutes = Math.max(1, Math.ceil(pages * 0.5));\n\nlet text = 'üìÑ *PDF received*\\n\\n';\ntext += '‚è≥ Analyzing drawing...\\n';\ntext += '‚è± ~' + estMinutes + ' min\\n\\n';\ntext += '_Report will be sent to this chat_';\n\nreturn {\n  json: {\n    ...data,\n    _tg_chat_id: cfg.chatId,\n    _tg_text: text\n  }\n};"
      },
      "id": "255a7ca0-d62a-4423-9b18-39998cc8b579",
      "name": "üìù Prep PDF Message1",
      "type": "n8n-nodes-base.code",
      "position": [
        -896,
        13904
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// üìÑ SPLIT PDF PAGES\nconst cfg = $('Config2').first().json;\nconst inputBinary = $input.first().binary;\nconst MAX_PAGES = 3;\nlet pdfBase64 = '';\n\nif (inputBinary) {\n  const key = Object.keys(inputBinary)[0];\n  if (key) pdfBase64 = inputBinary[key].data || '';\n}\n\nconst sizeKB = pdfBase64 ? (pdfBase64.length * 0.75) / 1024 : 0;\nconst totalPages = Math.min(Math.max(1, Math.ceil(sizeKB / 150)), MAX_PAGES);\n\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nif (!sd.pdfData) sd.pdfData = {};\nsd.pdfData[cid] = { base64: pdfBase64, totalPages };\n\nconsole.log('PDF size KB:', Math.round(sizeKB), 'Pages:', totalPages);\n\nreturn {\n  json: {\n    ...cfg,\n    pdfPages: Array.from({length: totalPages}, (_, i) => ({pageNum: i+1})),\n    totalPages\n  }\n};"
      },
      "id": "955ba95a-4f5f-4aa4-9918-36d1f6b46d7e",
      "name": "üìÑ Split PDF Pages1",
      "type": "n8n-nodes-base.code",
      "position": [
        -1104,
        13904
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/file/bot{{ $('üîë TOKEN2').first().json.bot_token }}/{{ $json.result.file_path }}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "20c81786-0d60-49e3-be7a-b844c4f13665",
      "name": "üìÑ Download PDF1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -1328,
        13904
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/getFile?file_id={{ $json.pdfFileId }}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "3449126b-d886-4e07-a435-69ee8351a019",
      "name": "üìÑ Get PDF Path1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -1568,
        13904
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Merge paths before Prep Vision\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst input = $input.first().json;\n\nconsole.log('=== MERGE TO VISION ===');\nconsole.log('photos:', input.photos?.length || 0);\nconsole.log('skipVision:', input.skipVision);\nconsole.log('L.search_lang:', input.L?.search_lang);\n\nreturn { json: input };"
      },
      "id": "934f2594-e5f1-477f-bcfe-5e0a43f389e9",
      "name": "Merge To Vision",
      "type": "n8n-nodes-base.code",
      "position": [
        -544,
        13552
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify('üì∑ ' + (($json.L && $json.L.photo) ? $json.L.photo.split('\\n')[0] : 'Please send a photo first')) }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "8ea6993a-ed8c-4803-ba6a-e005f9709077",
      "name": "üì§ No Photos Msg",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -720,
        13232
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "operator": {
                "type": "boolean",
                "operation": "equals"
              },
              "leftValue": "={{ $json.noPhotosError }}",
              "rightValue": true
            }
          ]
        },
        "options": {}
      },
      "id": "da6c635b-0c3a-44fd-9d9e-f0f45860353f",
      "name": "IF No Photos",
      "type": "n8n-nodes-base.if",
      "position": [
        -1008,
        13280
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Merge Vision API response with original input data\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst originalInput = $('Prep Vision').first().json;\nconst apiResponse = $input.first().json;\n\nconsole.log('=== MERGE VISION ===');\nconsole.log('Provider:', originalInput.provider);\nconsole.log('Has candidates:', (apiResponse.candidates || []).length);\nconsole.log('Has choices:', (apiResponse.choices || []).length);\n\nreturn { \n  json: { \n    ...originalInput,\n    candidates: apiResponse.candidates || [],\n    promptFeedback: apiResponse.promptFeedback,\n    choices: apiResponse.choices || [],\n    error: apiResponse.error\n  } \n};"
      },
      "id": "3edb191b-1b9c-44b6-a685-dc3cb816ca14",
      "name": "Merge Vision",
      "type": "n8n-nodes-base.code",
      "position": [
        -80,
        13552
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.apiUrl }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "={{ $json.provider === 'openai' ? 'Bearer ' + $json.apiKey : '' }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json.requestBody) }}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "a289b34d-dba1-436d-9663-043248aab4e5",
      "name": "Call Vision",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -240,
        13552
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Prepare request for Vision API (Gemini or OpenAI GPT-4o)\n// FIXED: Description in correct language\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst input = $input.first().json;\n\nconst photos = input.photos || [];\nconsole.log('=== PREP VISION ===');\nconsole.log('Photos received:', photos.length);\n\nif (photos.length === 0) {\n  console.log('‚ùå No photos to process');\n  return { json: { ...input, error: 'No photos', candidates: [], choices: [] } };\n}\n\nconsole.log('Photo base64 lengths:', photos.map(p => p.base64?.length || 0));\nconst description = input.description || '';\nconst L = input.L || {};\nconst searchLang = L.search_lang || 'German';\n\nconsole.log('Search language:', searchLang);\n\nconst tokenConfig = $('üîë TOKEN2').first().json;\nconst provider = (tokenConfig.AI_PROVIDER || 'gemini').toLowerCase();\nconst geminiKey = tokenConfig.GEMINI_API_KEY;\nconst openaiKey = tokenConfig.OPENAI_API_KEY;\n\nconsole.log('AI Provider:', provider);\n\nif (provider === 'gemini' && (!geminiKey || geminiKey === 'YOUR_GEMINI_API_KEY_HERE')) {\n  return { json: { ...input, error: 'GEMINI_API_KEY not configured', candidates: [] } };\n}\nif (provider === 'openai' && (!openaiKey || openaiKey === 'YOUR_OPENAI_API_KEY_HERE')) {\n  return { json: { ...input, error: 'OPENAI_API_KEY not configured', choices: [] } };\n}\n\nconst LANG_CONFIG = {\n  'German': {\n    good: ['Gipskartonwand 2-lagig CW75', 'Trockenbau Abhangdecke', 'Fliesen Feinsteinzeug verlegen', 'Malerarbeiten Dispersionsfarbe', 'Elektroinstallation Steckdosen UP'],\n    bad: ['Wand', 'Decke', 'Installation'],\n    descExample: 'Renovierung Badezimmer mit Trockenbau und Fliesen',\n    descInstruction: 'Beschreibung auf Deutsch'\n  },\n  'English': {\n    good: ['Drywall installation 2-layer metal stud CW75', 'Suspended ceiling installation', 'Porcelain tile flooring installation', 'Painting emulsion 2 coats', 'Electrical outlets flush mount'],\n    bad: ['Wall', 'Ceiling', 'Tiles'],\n    descExample: 'Bathroom renovation with drywall and tiles',\n    descInstruction: 'Description in English'\n  },\n  'Russian': {\n    good: ['–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–µ—Ä–µ–≥–æ—Ä–æ–¥–æ–∫ –∏–∑ –ì–ö–õ 2 —Å–ª–æ—è –ø—Ä–æ—Ñ–∏–ª—å –ü–ü60', '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–≤–µ—Å–Ω—ã—Ö –ø–æ—Ç–æ–ª–∫–æ–≤ –∏–∑ –≥–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω–∞', '–û–±–ª–∏—Ü–æ–≤–∫–∞ –ø–æ–ª–∞ –∫–µ—Ä–∞–º–æ–≥—Ä–∞–Ω–∏—Ç–æ–º 600x600', '–û–∫—Ä–∞—Å–∫–∞ –≤–æ–¥–æ—ç–º—É–ª—å—Å–∏–æ–Ω–Ω–æ–π –∫—Ä–∞—Å–∫–æ–π 2 —Å–ª–æ—è', '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–æ–∑–µ—Ç–æ–∫ —Å–∫—Ä—ã—Ç–æ–π –ø—Ä–æ–≤–æ–¥–∫–∏'],\n    bad: ['–°—Ç–µ–Ω–∞', '–ü–æ—Ç–æ–ª–æ–∫', '–ü–ª–∏—Ç–∫–∞'],\n    descExample: '–†–µ–º–æ–Ω—Ç —Å–∞–Ω—É–∑–ª–∞ —Å –º–æ–Ω—Ç–∞–∂–æ–º –∫–∞—Ä–∫–∞—Å–∞ –∏ —Ä–∞–∑–≤–æ–¥–∫–æ–π —Ç—Ä—É–±',\n    descInstruction: '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ'\n  },\n  'Spanish': {\n    good: ['Tabique pladur 2 capas perfil 70', 'Falso techo desmontable', 'Solado gres porcel√°nico 60x60', 'Pintura pl√°stica 2 manos', 'Mecanismos el√©ctricos empotrados'],\n    bad: ['Pared', 'Techo', 'Azulejos'],\n    descExample: 'Reforma ba√±o con pladur y azulejos',\n    descInstruction: 'Descripci√≥n en espa√±ol'\n  },\n  'French': {\n    good: ['Cloison placo 2 couches ossature 70', 'Plafond suspendu dalles', 'Carrelage gr√®s c√©rame 60x60', 'Peinture acrylique 2 couches', 'Prises √©lectriques encastr√©es'],\n    bad: ['Mur', 'Plafond', 'Carrelage'],\n    descExample: 'R√©novation salle de bain avec placo et carrelage',\n    descInstruction: 'Description en fran√ßais'\n  },\n  'Portuguese': {\n    good: ['Divis√≥ria drywall 2 camadas perfil 70', 'Forro de gesso acartonado', 'Piso porcelanato 60x60', 'Pintura acr√≠lica 2 dem√£os', 'Tomadas el√©tricas embutidas'],\n    bad: ['Parede', 'Teto', 'Piso'],\n    descExample: 'Reforma banheiro com drywall e porcelanato',\n    descInstruction: 'Descri√ß√£o em portugu√™s'\n  },\n  'Chinese': {\n    good: ['ËΩªÈí¢ÈæôÈ™®Áü≥ËÜèÊùøÈöîÂ¢ôÂèåÂ±Ç', 'Áü≥ËÜèÊùøÂêäÈ°∂ÂÆâË£Ö', 'Âú∞Á†ñÈì∫Ë¥¥600x600', '‰π≥ËÉ∂ÊºÜÊ∂ÇÂà∑‰∏§ÈÅç', 'ÊöóË£ÖÁîµÊ∫êÊèíÂ∫ß'],\n    bad: ['Â¢ô', 'È°∂', 'Á†ñ'],\n    descExample: 'Âç´ÁîüÈó¥Ë£Ö‰øÆÔºåÁü≥ËÜèÊùøÈöîÂ¢ôÂíåÁì∑Á†ñÈì∫Ë¥¥',\n    descInstruction: 'Áî®‰∏≠ÊñáÊèèËø∞'\n  },\n  'Arabic': {\n    good: ['ÿ™ÿ±ŸÉŸäÿ® ÿ¨ÿØÿ±ÿßŸÜ ÿ¨ÿ®ÿ≥ ÿ®Ÿàÿ±ÿØ ÿ∑ÿ®ŸÇÿ™ŸäŸÜ', 'ÿ≥ŸÇŸÅ ŸÖÿπŸÑŸÇ ÿ¨ÿ®ÿ≥ ÿ®Ÿàÿ±ÿØ', 'ÿ™ÿ±ŸÉŸäÿ® ÿ®ŸÑÿßÿ∑ ÿ®Ÿàÿ±ÿ≥ŸÑŸäŸÜ 60x60', 'ÿØŸáÿßŸÜ ŸÖÿßÿ¶Ÿä ÿ∑ÿ®ŸÇÿ™ŸäŸÜ', 'ÿ™ÿ±ŸÉŸäÿ® ŸÖŸÇÿßÿ®ÿ≥ ŸÉŸáÿ±ÿ®ÿßÿ¶Ÿäÿ© ŸÖÿÆŸÅŸäÿ©'],\n    bad: ['ÿ¨ÿØÿßÿ±', 'ÿ≥ŸÇŸÅ', 'ÿ®ŸÑÿßÿ∑'],\n    descExample: 'ÿ™ÿ¨ÿØŸäÿØ ÿßŸÑÿ≠ŸÖÿßŸÖ ŸÖÿπ ÿßŸÑÿ¨ÿ®ÿ≥ ÿ®Ÿàÿ±ÿØ ŸàÿßŸÑÿ®ŸÑÿßÿ∑',\n    descInstruction: 'ÿßŸÑŸàÿµŸÅ ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ©'\n  },\n  'Hindi': {\n    good: ['‡§°‡•ç‡§∞‡§æ‡§à‡§µ‡•â‡§≤ ‡§™‡§æ‡§∞‡•ç‡§ü‡•Ä‡§∂‡§® 2 ‡§≤‡•á‡§Ø‡§∞', '‡§´‡•â‡§≤‡•ç‡§∏ ‡§∏‡•Ä‡§≤‡§ø‡§Ç‡§ó ‡§ú‡§ø‡§™‡•ç‡§∏‡§Æ ‡§¨‡•ã‡§∞‡•ç‡§°', '‡§´‡•ç‡§≤‡•ã‡§∞ ‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ 600x600', '‡§á‡§Æ‡§≤‡•ç‡§∂‡§® ‡§™‡•á‡§Ç‡§ü 2 ‡§ï‡•ã‡§ü', '‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡§ø‡§ï ‡§∏‡•â‡§ï‡•á‡§ü‡•ç‡§∏ ‡§ï‡§Ç‡§∏‡•Ä‡§≤‡•ç‡§°'],\n    bad: ['‡§¶‡•Ä‡§µ‡§æ‡§∞', '‡§õ‡§§', '‡§ü‡§æ‡§á‡§≤'],\n    descExample: '‡§¨‡§æ‡§•‡§∞‡•Ç‡§Æ ‡§∞‡•á‡§®‡•ã‡§µ‡•á‡§∂‡§® ‡§°‡•ç‡§∞‡§æ‡§à‡§µ‡•â‡§≤ ‡§î‡§∞ ‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ ‡§ï‡•á ‡§∏‡§æ‡§•',\n    descInstruction: '‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§µ‡§ø‡§µ‡§∞‡§£'\n  }\n};\n\nconst langConfig = LANG_CONFIG[searchLang] || LANG_CONFIG['English'];\n\nconst prompt = `You are an expert construction cost estimator.\n\nCRITICAL LANGUAGE REQUIREMENT:\n- ALL your output MUST be ONLY in ${searchLang} language\n- The \"description\" field MUST be in ${searchLang} (${langConfig.descInstruction})\n- All \"name\" fields MUST be in ${searchLang}\n- Do NOT use English or any other language anywhere in your response\n\nAnalyze these photos and identify construction work items.\n\nGOOD QUERIES (specific, searchable) in ${searchLang}:\n${langConfig.good.map(e => '‚úì ' + e).join('\\n')}\n\nBAD QUERIES (too generic, avoid):\n${langConfig.bad.map(e => '‚úó ' + e).join('\\n')}\n\n${description ? 'CONTEXT: ' + description : ''}\n\nRULES:\n1. List ONLY what you can ACTUALLY SEE in the photos\n2. Use SPECIFIC technical terms in ${searchLang} like the good examples above\n3. Include materials, dimensions, specifications when visible\n4. Estimate quantities based on photo scale\n5. Write \"description\" field in ${searchLang} language\n\nFor each work item:\n- name: Specific ${searchLang} construction term (like good examples above)\n- qty: Estimated quantity (number)\n- unit: m¬≤ / m / pcs / kg\n- conf: high (clearly visible) / medium (partially visible)\n- cat: demolition / rough / finishing / mep\n\nEXAMPLE RESPONSE in ${searchLang}:\n{\"description\":\"${langConfig.descExample}\",\"items\":[{\"name\":\"${langConfig.good[0]}\",\"qty\":10,\"unit\":\"m¬≤\",\"conf\":\"high\",\"cat\":\"finishing\"}]}\n\nRespond ONLY with valid JSON. Remember: ALL text must be in ${searchLang}!`;\n\nlet requestBody, apiUrl, apiKey;\n\nif (provider === 'openai') {\n  apiUrl = 'https://generativelanguage.googleapis.com/v1beta/openai/chat/completions';\n  apiKey = openaiKey;\n  \n  const content = [{ type: 'text', text: prompt }];\n  \n  for (const photo of photos) {\n    if (photo.base64) {\n      content.push({\n        type: 'image_url',\n        image_url: {\n          url: 'data:image/jpeg;base64,' + photo.base64,\n          detail: 'high'\n        }\n      });\n    }\n  }\n  \n  requestBody = {\n    model: 'gpt-4o',\n    max_tokens: 4000,\n    temperature: 0.4,\n    messages: [\n      { role: 'system', content: `You are an expert construction cost estimator. CRITICAL: You MUST respond ONLY in ${searchLang} language. The \"description\" field and all \"name\" fields MUST be written in ${searchLang}. Do NOT use English. Respond only with valid JSON.` },\n      { role: 'user', content: content }\n    ]\n  };\n  \n} else {\n  apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + geminiKey;\n  apiKey = geminiKey;\n  \n  const parts = [];\n  \n  for (const photo of photos) {\n    if (photo.base64) {\n      parts.push({\n        inline_data: {\n          mime_type: 'image/jpeg',\n          data: photo.base64\n        }\n      });\n    }\n  }\n  \n  parts.push({ text: prompt });\n  \n  requestBody = {\n    contents: [{ parts: parts }],\n    generationConfig: {\n      temperature: 0.4,\n      maxOutputTokens: 4000\n    }\n  };\n}\n\nconsole.log('API URL:', apiUrl ? apiUrl.substring(0, 60) + '...' : 'EMPTY');\nconsole.log('Photos in request:', photos.length);\nconsole.log('Language:', searchLang);\n\nreturn { json: { \n  ...input, \n  provider: provider,\n  apiUrl: apiUrl,\n  apiKey: apiKey,\n  requestBody: requestBody \n}};"
      },
      "id": "4b5915bb-98b3-40a1-a9e4-0f9ad094e19f",
      "name": "Prep Vision",
      "type": "n8n-nodes-base.code",
      "position": [
        -384,
        13552
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Convert downloaded photo to base64 for Vision API\n// FIXED: Save base64 to session for Refine Analysis\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst prepData = $('Prep Photo Download1').first().json;\nconst binaryData = $input.first().binary;\nconst sd = $getWorkflowStaticData('global');\nconst cid = String(prepData.chatId);\n\nconsole.log('=== CONVERT TO BASE64 ===');\nconsole.log('chatId:', cid);\nconsole.log('Binary data keys:', Object.keys(binaryData || {}));\n\nconst photos = [];\n\nif (binaryData) {\n  const binaryKey = Object.keys(binaryData)[0];\n  if (binaryKey && binaryData[binaryKey]) {\n    const item = binaryData[binaryKey];\n    console.log('Binary item keys:', Object.keys(item));\n    \n    if (item.data) {\n      photos.push({\n        base64: item.data,\n        caption: ''\n      });\n      console.log('‚úÖ SUCCESS: Base64 length:', item.data.length);\n    }\n  }\n}\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –°–û–•–†–ê–ù–Ø–ï–ú base64 –≤ —Å–µ—Å—Å–∏—é –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (Refine Analysis)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = { lang: prepData.lang };\nsd.sess[cid].photos_base64 = photos;\nconsole.log('‚úÖ Saved base64 to session for chat:', cid, 'photos:', photos.length);\n\nconst L = prepData.L || sd.sess[cid]?.L || {};\n\nreturn { json: { \n  chatId: prepData.chatId,\n  bot_token: prepData.bot_token,\n  photos: photos,\n  photoCount: photos.length,\n  description: prepData.description || '',\n  L: L,\n  lang: prepData.lang,\n  skipVision: false\n}};"
      },
      "id": "76209c01-727e-4ccf-905e-0ce709b405f5",
      "name": "Convert To Base1",
      "type": "n8n-nodes-base.code",
      "position": [
        -720,
        13552
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/file/bot{{ $('üîë TOKEN2').first().json.bot_token }}/{{ $json.result.file_path }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "file"
            }
          }
        }
      },
      "id": "cb166498-b4fa-426d-a747-09cc7355fe5d",
      "name": "Download Photo File",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -912,
        13552
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/getFile?file_id={{ $json.fileId }}",
        "options": {}
      },
      "id": "4da3727e-47ab-4879-a402-f541df602e4a",
      "name": "Get File Path",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -1088,
        13552
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Use stored base64 images from session\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst input = $input.first().json;\nconst cid = String(input.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\n\nconsole.log('=== USE STORED BASE64 ===');\nconsole.log('input.photos:', input.photos?.length || 0);\n\nconst photos = input.photos || [];\n\nif (photos.length === 0) {\n  console.log('‚ùå No photos in input');\n  return { json: { ...input, skipVision: true, noPhotos: true } };\n}\n\nconsole.log('‚úÖ Using', photos.length, 'stored photos');\nconsole.log('First photo base64 length:', photos[0]?.base64?.length || 0);\n\nreturn { json: { \n  chatId: input.chatId,\n  bot_token: input.bot_token,\n  photos: photos,\n  photoCount: photos.length,\n  description: input.description || session.description || '',\n  L: input.L || session.L || {},\n  lang: input.lang || session.lang,\n  skipVision: false,\n  noPhotos: false\n}};"
      },
      "id": "d8f694ef-ef80-4757-9084-d677d3c5b63c",
      "name": "Use Stored Base",
      "type": "n8n-nodes-base.code",
      "position": [
        -720,
        13392
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "operator": {
                "type": "boolean",
                "operation": "equals"
              },
              "leftValue": "={{ $json.skipDownload }}",
              "rightValue": true
            }
          ]
        },
        "options": {}
      },
      "id": "825dda24-2190-4bc8-9d05-4a3f595efb0b",
      "name": "IF Skip Download1",
      "type": "n8n-nodes-base.if",
      "position": [
        -1280,
        13344
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// STEP 8: Calculate - FIXED VERSION v3\n// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ö\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst inputData = $input.first().json;\n\nconsole.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\nconsole.log('STEP 8: CALCULATE v3');\nconsole.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –£–ú–ù–´–ô –ü–û–ò–°–ö PAYLOAD - –∏—â–µ–º –≤–æ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nlet payload = null;\nlet payloadSource = 'not_found';\n\n// –í–∞—Ä–∏–∞–Ω—Ç 1: _best_result.payload\nif (inputData._best_result?.payload?.rate_code) {\n  payload = inputData._best_result.payload;\n  payloadSource = '_best_result.payload';\n}\n// –í–∞—Ä–∏–∞–Ω—Ç 2: _best_payload –Ω–∞–ø—Ä—è–º—É—é\nelse if (inputData._best_payload?.rate_code) {\n  payload = inputData._best_payload;\n  payloadSource = '_best_payload';\n}\n// –í–∞—Ä–∏–∞–Ω—Ç 3: –¥–∞–Ω–Ω—ã–µ –ª–µ–∂–∞—Ç –ø—Ä—è–º–æ –≤ _best_result (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ payload)\nelse if (inputData._best_result?.rate_code) {\n  payload = inputData._best_result;\n  payloadSource = '_best_result (direct)';\n}\n// –í–∞—Ä–∏–∞–Ω—Ç 4: payload –≤–Ω—É—Ç—Ä–∏ payload (–¥–≤–æ–π–Ω–∞—è –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å)\nelse if (inputData._best_result?.payload?.payload?.rate_code) {\n  payload = inputData._best_result.payload.payload;\n  payloadSource = '_best_result.payload.payload';\n}\n// –í–∞—Ä–∏–∞–Ω—Ç 5: –∏—â–µ–º rate_code –≥–¥–µ —É–≥–æ–¥–Ω–æ –≤ _best_result\nelse if (inputData._best_result) {\n  const br = inputData._best_result;\n  // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫\n  const findPayload = (obj, depth = 0) => {\n    if (!obj || depth > 3) return null;\n    if (obj.rate_code && obj.resources) return obj;\n    for (const key of Object.keys(obj)) {\n      if (typeof obj[key] === 'object' && obj[key] !== null) {\n        const found = findPayload(obj[key], depth + 1);\n        if (found) return found;\n      }\n    }\n    return null;\n  };\n  payload = findPayload(br);\n  if (payload) payloadSource = '_best_result (deep search)';\n}\n\nconsole.log('Payload source:', payloadSource);\nconsole.log('Payload found:', !!payload);\n\nif (payload) {\n  console.log('Payload keys:', Object.keys(payload));\n  console.log('rate_code:', payload.rate_code);\n  console.log('rate_name:', payload.rate_name?.substring(0, 50));\n  console.log('resources count:', (payload.resources || []).length);\n  console.log('cost_summary:', JSON.stringify(payload.cost_summary || {}).substring(0, 200));\n}\n\n// –ï—Å–ª–∏ payload –Ω–µ –Ω–∞–π–¥–µ–Ω - –≤—ã–≤–æ–¥–∏–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏\nif (!payload) {\n  console.log('');\n  console.log('‚ùå PAYLOAD NOT FOUND! Debug info:');\n  console.log('inputData keys:', Object.keys(inputData));\n  if (inputData._best_result) {\n    console.log('_best_result keys:', Object.keys(inputData._best_result));\n    console.log('_best_result.payload:', typeof inputData._best_result.payload);\n    if (inputData._best_result.payload) {\n      console.log('_best_result.payload keys:', Object.keys(inputData._best_result.payload));\n    }\n  }\n  \n  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π\n  return [{ json: { \n    ...inputData,\n    rate_code: 'PAYLOAD_NOT_FOUND',\n    rate_name: inputData.name || inputData.sq || 'Unknown',\n    uc: 0, tc: 0,\n    resources: [],\n    _debug_keys: Object.keys(inputData),\n    _debug_best_result_keys: Object.keys(inputData._best_result || {}),\n    _debug_payload_source: payloadSource\n  }}];\n}\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –¢–µ–ø–µ—Ä—å payload –Ω–∞–π–¥–µ–Ω - –∏–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã\nconst workName = inputData.name || inputData.sq || '';\nconst workQty = inputData.qty || 1;\nconst workUnit = inputData.unit || 'm¬≤';\n\nconsole.log('');\nconsole.log('Work:', workName);\nconsole.log('Qty:', workQty, workUnit);\n\n// –î–∞–Ω–Ω—ã–µ —Ä–∞—Å—Ü–µ–Ω–∫–∏\nconst rateCode = payload.rate_code || 'NOT_FOUND';\nconst rateName = payload.rate_name || workName;\nconst rateUnit = payload.rate_unit || '';\n\nconsole.log('Rate code:', rateCode);\nconsole.log('Rate name:', rateName?.substring(0, 50));\nconsole.log('Rate unit:', rateUnit);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –ü–æ–ª—É—á–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst costSummary = payload.cost_summary || {};\nlet totalCost = parseFloat(costSummary.total_cost_position || costSummary.total_cost || 0);\n\n// –ï—Å–ª–∏ cost_summary –ø—É—Å—Ç–æ–π, –≤—ã—á–∏—Å–ª—è–µ–º –∏–∑ —Ä–µ—Å—É—Ä—Å–æ–≤\nconst rawResources = payload.resources || [];\nif (totalCost === 0 && rawResources.length > 0) {\n  totalCost = rawResources.reduce((sum, r) => {\n    return sum + parseFloat(r.resource_cost_eur || 0);\n  }, 0);\n  console.log('Total cost calculated from resources:', totalCost);\n}\n\nconsole.log('Total cost:', totalCost);\nconsole.log('Resources count:', rawResources.length);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–ª–∏—Ç–µ–ª—å –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nlet unitDivisor = 1;\nconst rateUnitLower = (rateUnit || '').toLowerCase();\n\nif (rateUnitLower.includes('100 ') || rateUnitLower === '100 –º' || rateUnitLower === '100 –º¬≤' || rateUnitLower === '100 –º2') {\n  unitDivisor = 100;\n} else if (rateUnitLower.match(/^10\\s/) || rateUnitLower.includes('10 –º')) {\n  unitDivisor = 10;\n}\n\nconsole.log('Unit divisor:', unitDivisor);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Price calculation\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst uc = unitDivisor > 0 ? totalCost / unitDivisor : 0;\nconst tc = workQty * uc;\nconst scaleFactor = unitDivisor > 0 ? workQty / unitDivisor : workQty;\n\nconsole.log('');\nconsole.log('=== PRICE CALCULATION ===');\nconsole.log('UC (price per unit):', uc.toFixed(2), 'EUR');\nconsole.log('TC (total cost):', tc.toFixed(2), 'EUR');\nconsole.log('Scale factor:', scaleFactor);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nlet workersTotal = 0;\nlet materialsTotal = 0;\nlet machinesTotal = 0;\nlet laborHoursTotal = 0;\n\nconst resources = rawResources.map(r => {\n  const code = r.resource_code || '';\n  const name = r.resource_name || '';\n  const unit = r.resource_unit || '';\n  const rowType = r.row_type || '';\n  \n  const originalQty = r.resource_quantity !== null && r.resource_quantity !== undefined \n    ? parseFloat(r.resource_quantity) \n    : null;\n  const pricePerUnit = parseFloat(r.resource_price_per_unit_eur_current || 0);\n  const originalCost = parseFloat(r.resource_cost_eur || 0);\n  \n  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ä–µ—Å—É—Ä—Å–∞\n  let resourceType = 'material';\n  const rowTypeLower = (rowType || '').toLowerCase();\n  const codeUpper = (code || '').toUpperCase();\n  \n  if (rowTypeLower === '–º–∞—à–∏–Ω–∏—Å—Ç' || rowTypeLower.includes('–º–∞—à–∏–Ω–∏—Å—Ç')) {\n    resourceType = 'labor';\n  } else if (rowTypeLower === '—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ' || rowTypeLower.includes('—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤')) {\n    resourceType = 'machine';\n  } else if (codeUpper.startsWith('DXME') || codeUpper.startsWith('DX')) {\n    resourceType = 'machine';\n  } else if (codeUpper.startsWith('ME_') || codeUpper.startsWith('PU_') || codeUpper.startsWith('RI_')) {\n    resourceType = 'labor';\n  }\n  \n  // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ\n  let scaledQty = null;\n  let scaledCost = 0;\n  \n  if (originalQty !== null) {\n    scaledQty = originalQty * scaleFactor;\n    scaledCost = scaledQty * pricePerUnit;\n  } else {\n    scaledCost = originalCost * scaleFactor;\n  }\n  \n  // –°—É–º–º–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º\n  if (resourceType === 'labor') {\n    workersTotal += scaledCost;\n    if (unit === '—á' || unit === '—á–µ–ª.-—á' || unit === '—á–µ–ª-—á' || unit === '–º–∞—à.-—á') {\n      laborHoursTotal += scaledQty || 0;\n    }\n  } else if (resourceType === 'machine') {\n    machinesTotal += scaledCost;\n  } else {\n    materialsTotal += scaledCost;\n  }\n  \n  return {\n    resource_code: code,\n    resource_name: name,\n    resource_unit: unit,\n    resource_type: resourceType,\n    row_type: rowType,\n    resource_price: pricePerUnit,\n    original_quantity: originalQty,\n    original_cost: originalCost,\n    scaled_quantity: scaledQty,\n    scaled_cost: scaledCost\n  };\n});\n\nconsole.log('');\nconsole.log('=== RESOURCES BREAKDOWN ===');\nconsole.log('Resources processed:', resources.length);\nconsole.log('Workers total:', workersTotal.toFixed(2), 'EUR');\nconsole.log('Materials total:', materialsTotal.toFixed(2), 'EUR');\nconsole.log('Machines total:', machinesTotal.toFixed(2), 'EUR');\nconsole.log('Labor hours:', laborHoursTotal.toFixed(1), 'h');\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Scope of work\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst workSteps = payload.work_steps || [];\nconst scopeOfWork = workSteps.map(s => s.text || '').filter(t => t.length > 0);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// Quality\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst llmScore = inputData._llm_score || 0;\nconst qdrantScore = inputData._qdrant_score || 0;\n\nconst qualityLevel = llmScore >= 75 ? 'high' : \n                     llmScore >= 50 ? 'medium' : \n                     llmScore >= 25 ? 'low' : 'not_found';\n\nconsole.log('');\nconsole.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\nconsole.log('‚úÖ CALCULATION COMPLETE');\nconsole.log('Rate:', rateCode, '-', rateName?.substring(0, 40));\nconsole.log('Total:', tc.toFixed(2), 'EUR');\nconsole.log('Resources:', resources.length);\nconsole.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –§–ò–ù–ê–õ–¨–ù–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nreturn [{ json: { \n  // Original data\n  ...inputData,\n  name: workName,\n  qty: workQty,\n  unit: workUnit,\n  \n  // Rate\n  rate_code: rateCode,\n  rate_name: rateName,\n  rate_unit: workUnit,\n  original_rate_unit: rateUnit,\n  \n  // Prices\n  uc,\n  tc,\n  \n  // Labor\n  labor_hours: laborHoursTotal,\n  workers_total: workersTotal,\n  machines_total: machinesTotal,\n  materials_total: materialsTotal,\n  \n  // Quality\n  ql: qualityLevel,\n  quality_score: llmScore,\n  qdrant_score: qdrantScore,\n  llm_score: llmScore,\n  llm_reason: inputData._llm_reason || '',\n  \n  // Resources\n  resources,\n  \n  // Scope of work\n  scope_of_work: scopeOfWork,\n  \n  // Hierarchy\n  hierarchy: payload.hierarchy || {},\n  \n  // Breakdown\n  cost_breakdown: { \n    workers: workersTotal, \n    machines: machinesTotal, \n    materials: materialsTotal \n  },\n  \n  // Debug\n  _payload_source: payloadSource,\n  _scale_factor: scaleFactor,\n  _unit_divisor: unitDivisor,\n  _original_total_cost: totalCost\n}}];"
      },
      "id": "dac870d4-d635-4e51-8c95-ff621fa141a0",
      "name": "9Ô∏è‚É£ Calculate2",
      "type": "n8n-nodes-base.code",
      "position": [
        -912,
        15168
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// 8Ô∏è‚É£ APPLY RERANK v4 - Enhanced result selection\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst prepData = $('6Ô∏è‚É£ Prep Rerank2').first().json;\nconst llmResponse = $input.first().json;\n\nconsole.log('=== APPLY RERANK v4 ===');\n\nconst qdrantResults = prepData._qdrant_results || [];\n\nlet rankings = [];\ntry {\n  let text = llmResponse.choices?.[0]?.message?.content || '';\n  // Clear –æ—Ç markdown –∏ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤\n  text = text.replace(/```json\\n?/g, '').replace(/```/g, '').trim();\n  \n  // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ JSON\n  const jsonMatch = text.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    const parsed = JSON.parse(jsonMatch[0]);\n    rankings = parsed.rankings || [];\n    console.log('Parsed rankings:', rankings.length);\n  }\n} catch(e) {\n  console.log('Parse error:', e.message);\n  // Fallback - –∏—Å–ø–æ–ª—å–∑—É–µ–º Qdrant scores\n  rankings = qdrantResults.map((r, i) => ({\n    index: i,\n    score: Math.round((r.score || 0) * 100),\n    reason: 'qdrant score'\n  }));\n}\n\n// –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º LLM –∏ Qdrant scores\nconst scored = qdrantResults.map((r, i) => {\n  const p = r.payload || {};\n  const rank = rankings.find(x => x.index === i);\n  const llmScore = rank?.score || 0;\n  const reason = rank?.reason || '';\n  const qdrantScore = (r.score || 0) * 100;\n  \n  // Weighted combination: LLM –≤–∞–∂–Ω–µ–µ –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ Qdrant\n  let combinedScore;\n  if (llmScore > 0) {\n    // LLM 70% + Qdrant 30%\n    combinedScore = llmScore * 0.7 + qdrantScore * 0.3;\n  } else {\n    combinedScore = qdrantScore;\n  }\n  \n  console.log('[' + i + '] LLM=' + llmScore + ' Qdrant=' + qdrantScore.toFixed(0) + ' Combined=' + combinedScore.toFixed(0) + ' - ' + (p.rate_code || 'N/A'));\n  \n  return {\n    ...r,\n    payload: p,\n    llm_score: llmScore,\n    llm_reason: reason,\n    qdrant_score: r.score || 0,\n    combined_score: combinedScore\n  };\n});\n\n// Sort –ø–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É score\nscored.sort((a, b) => b.combined_score - a.combined_score);\n\nconst best = scored[0];\nconst bestPayload = best?.payload || {};\n\n// Determine quality —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞\nlet qualityLevel = 'not_found';\nif (best.combined_score >= 80) qualityLevel = 'high';\nelse if (best.combined_score >= 60) qualityLevel = 'medium';\nelse if (best.combined_score >= 40) qualityLevel = 'low';\n\nconsole.log('');\nconsole.log('‚úÖ BEST: ' + bestPayload.rate_code + ' - ' + (bestPayload.rate_name || '').substring(0, 50));\nconsole.log('   Combined: ' + best.combined_score.toFixed(0) + ' | Quality: ' + qualityLevel);\nconsole.log('   Reason: ' + best.llm_reason);\n\nreturn [{ json: {\n  ...prepData,\n  _best_result: best,\n  _best_payload: bestPayload,\n  _llm_score: best?.llm_score || 0,\n  _llm_reason: best?.llm_reason || '',\n  _qdrant_score: best?.qdrant_score || 0,\n  _quality_level: qualityLevel,\n  ql: qualityLevel,\n  _openai_key: prepData._openai_key,\n  _step: 'rerank_done'\n}}];"
      },
      "id": "1b12e625-7d83-44de-acc9-477ece1bd750",
      "name": "8Ô∏è‚É£ Apply Rerank2",
      "type": "n8n-nodes-base.code",
      "position": [
        -1104,
        15168
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/openai/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json._openai_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gemini-2.5-flash\",\n  \"messages\": [\n    {\"role\": \"system\", \"content\": \"You are a construction cost database expert. Respond ONLY with valid JSON, no markdown.\"},\n    {\"role\": \"user\", \"content\": {{ JSON.stringify($json._rerank_prompt) }}}\n  ],\n  \"temperature\": 0.1,\n  \"max_tokens\": 500\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          },
          "timeout": 30000
        }
      },
      "id": "1c2e6545-cf3a-4a25-953f-71877e77f01a",
      "name": "7Ô∏è‚É£ LLM Rerank1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -192,
        14976
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// 6Ô∏è‚É£ PREP RERANK v4 - Enhanced semantic matching\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst prepData = $('4Ô∏è‚É£ Extract Embedding2').first().json;\nconst qdrantResponse = $input.first().json;\n\nconsole.log('=== PREP RERANK v4 ===');\n\nif (qdrantResponse.status?.error) {\n  return [{ json: { ...prepData, rate_code: 'QDRANT_ERROR', uc: 0, tc: 0, ql: 'not_found', resources: [] }}];\n}\n\nconst results = qdrantResponse.result || [];\nconsole.log('Qdrant results:', results.length);\n\nif (results.length === 0) {\n  return [{ json: { ...prepData, rate_code: 'NOT_FOUND', rate_name: prepData._original_query, uc: 0, tc: 0, ql: 'not_found', resources: [] }}];\n}\n\nconst originalQuery = prepData._original_query || prepData.name || '';\nconst workUnit = prepData.unit || 'm¬≤';\nconst workQty = prepData.qty || 1;\n\n// Format –∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤\nconst candidates = results.slice(0, 5).map((r, i) => {\n  const p = r.payload || {};\n  const code = p.rate_code || '';\n  const name = p.rate_name || '';\n  const unit = p.rate_unit || '';\n  \n  // Scope of work\n  const workSteps = p.work_steps || [];\n  const scopeText = workSteps.slice(0, 3).map(s => s.text).join('; ');\n  \n  // Key materials\n  const resources = p.resources || [];\n  const materials = resources\n    .filter(r => !r.resource_code?.match(/^(DXME|ME_|PU_|RI_)/))\n    .slice(0, 3)\n    .map(r => r.resource_name)\n    .join(', ');\n  \n  const qdrantScore = (r.score * 100).toFixed(0);\n  \n  console.log('[' + i + '] ' + code + ' - ' + name?.substring(0, 40) + ' | ' + qdrantScore + '%');\n  \n  return i + '. [' + code + '] ' + name + '\\n   Unit: ' + unit + ' | Scope: ' + (scopeText || 'n/a').substring(0, 100) + '\\n   Materials: ' + (materials || 'n/a');\n}).join('\\n\\n');\n\nconst rerankPrompt = `TASK: Score construction rate candidates (0-100) for matching user's work request.\n\nSCORING GUIDE:\n95-100: EXACT MATCH - Same work type, method, materials, unit compatible\n80-94: VERY GOOD - Same work, minor spec differences (thickness, brand)\n65-79: GOOD - Same category, different specification\n50-64: PARTIAL - Related work, different scope\n30-49: WEAK - Same trade, different work type\n0-29: WRONG - Different trade or unrelated\n\nCRITICAL DISTINCTIONS:\n‚Ä¢ –ì–ö–õ (–≥–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω) ‚â† –ì–í–õ (–≥–∏–ø—Å–æ–≤–æ–ª–æ–∫–Ω–æ) - DIFFERENT materials, max 60\n‚Ä¢ –°—Ç–µ–Ω—ã ‚â† –ü–æ—Ç–æ–ª–æ–∫ - check work location matches\n‚Ä¢ –ú–æ–Ω—Ç–∞–∂ ‚â† –î–µ–º–æ–Ω—Ç–∞–∂ - opposite operations\n‚Ä¢ 1 —Å–ª–æ–π ‚â† 2 —Å–ª–æ—è - check layer count\n‚Ä¢ Profile types: –ü–ü60 = ceiling, –ü–° = wall stud, –ü–ù = guide\n\nUNIT MATCHING:\n‚Ä¢ Query unit: ${workUnit}\n‚Ä¢ Rate unit should be compatible or convertible\n‚Ä¢ m¬≤ work ‚Üí m¬≤ rate (ideal)\n‚Ä¢ m¬≤ work ‚Üí 100m¬≤ rate (ok, will scale)\n\nUSER REQUEST: \"${originalQuery}\" (${workQty} ${workUnit})\n\nCANDIDATES:\n${candidates}\n\nReturn ONLY valid JSON (no markdown):\n{\"rankings\":[{\"index\":0,\"score\":N,\"reason\":\"brief reason\"},{\"index\":1,\"score\":N,\"reason\":\"brief reason\"}]}`;\n\nconsole.log('Prompt length:', rerankPrompt.length);\n\nreturn [{ json: {\n  ...prepData,\n  _qdrant_results: results,\n  _rerank_prompt: rerankPrompt,\n  _openai_key: prepData._openai_key,\n  _step: 'prep_rerank_done'\n}}];"
      },
      "id": "8bf0078d-35c8-45db-8152-8fc2f145ab38",
      "name": "6Ô∏è‚É£ Prep Rerank2",
      "type": "n8n-nodes-base.code",
      "position": [
        -368,
        14976
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json._qdrant_url }}/collections/{{ $json._collection }}/points/search",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "api-key",
              "value": "={{ $json._qdrant_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"vector\": {{ JSON.stringify($json._embedding) }},\n  \"limit\": 10,\n  \"with_payload\": true,\n  \"with_vector\": false\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          },
          "timeout": 30000
        }
      },
      "id": "0dd68fc3-26b5-4199-85e5-f9b8176df558",
      "name": "5Ô∏è‚É£ Qdrant Search2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -544,
        14976
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// EXTRACT EMBEDDING - Get vector from OpenAI response\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst prepData = $('2Ô∏è‚É£ Extract Transform2').first().json;\nconst embResponse = $input.first().json;\n\nconsole.log('=== EXTRACT EMBEDDING ===');\n\nif (embResponse.error) {\n  console.log('OpenAI Error:', embResponse.error.message);\n  return [{ json: { ...prepData, _error: embResponse.error.message, _embedding: [] }}];\n}\n\nconst embedding = embResponse.data?.[0]?.embedding || [];\nconsole.log('Embedding length:', embedding.length);\n\nif (embedding.length !== 3072) {\n  console.log('WARNING: Expected 3072, got', embedding.length);\n}\n\n// Pass all data including Qdrant credentials\nreturn [{ json: {\n  ...prepData,\n  _embedding: embedding,\n  _collection: prepData._collection,\n  _qdrant_url: prepData._qdrant_url,\n  _qdrant_key: prepData._qdrant_key,\n  _openai_key: prepData._openai_key,\n  _step: 'embedding_done'\n}}];"
      },
      "id": "5483de0e-b63e-4360-80c5-5098ac08b701",
      "name": "4Ô∏è‚É£ Extract Embedding2",
      "type": "n8n-nodes-base.code",
      "position": [
        -704,
        14976
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/openai/embeddings",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json._openai_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gemini-embedding-001\",\n  \"input\": {{ JSON.stringify($json._query) }},\n  \"dimensions\": 3072\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          },
          "timeout": 30000
        }
      },
      "id": "22db3e86-cfa9-4784-9a96-287886389f85",
      "name": "3Ô∏è‚É£ OpenAI Embedding1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -912,
        14976
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// EXTRACT TRANSFORM - Clean LLM response and combine queries\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst prepData = $('1Ô∏è‚É£ Prep Query2').first().json;\nconst llmResponse = $input.first().json;\n\nconsole.log('=== EXTRACT TRANSFORM ===');\n\nlet transformedQuery = prepData._original_query;\n\ntry {\n  const content = llmResponse.choices?.[0]?.message?.content || '';\n  if (content && content.length > 5) {\n    transformedQuery = content\n      .replace(/^(keywords?:|search:|query:|result:)/i, '')\n      .replace(/[\\n\\r]+/g, ' ')\n      .trim();\n    console.log('Transformed OK');\n  }\n} catch(e) {\n  console.log('Transform failed:', e.message);\n}\n\nconsole.log('Original:', prepData._original_query);\nconsole.log('Transformed:', transformedQuery.substring(0, 80));\n\n// Smart combination - original is more important\nconst originalWords = prepData._original_query.toLowerCase().split(/\\s+/);\nconst transformedWords = transformedQuery.toLowerCase().split(/\\s+/);\n\n// Add only new words from transformation\nconst newWords = transformedWords.filter(w => \n  w.length > 2 && !originalWords.some(ow => ow.includes(w) || w.includes(ow))\n);\n\nconst combinedQuery = prepData._original_query + ' ' + newWords.slice(0, 10).join(' ');\n\nconsole.log('Combined:', combinedQuery.substring(0, 100));\n\n// Pass all data including Qdrant credentials\nreturn [{ json: {\n  ...prepData,\n  _query: combinedQuery.trim(),\n  _transformed_query: transformedQuery,\n  _collection: prepData._collection,\n  _qdrant_url: prepData._qdrant_url,\n  _qdrant_key: prepData._qdrant_key,\n  _openai_key: prepData._openai_key,\n  _step: 'transform_done'\n}}];"
      },
      "id": "8c9ca8b3-26a1-4703-92e6-c9362ed2f9cd",
      "name": "2Ô∏è‚É£ Extract Transform2",
      "type": "n8n-nodes-base.code",
      "position": [
        -1104,
        14976
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/openai/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "=Bearer {{ $json._openai_key }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"gemini-2.5-flash\",\n  \"messages\": [{\"role\": \"user\", \"content\": {{ JSON.stringify($json._transform_prompt) }}}],\n  \"temperature\": 0.3,\n  \"max_tokens\": 200\n}",
        "options": {
          "response": {
            "response": {
              "neverError": true,
              "responseFormat": "json"
            }
          },
          "timeout": 30000
        }
      },
      "id": "40173416-bb6b-415a-a864-71e229894802",
      "name": "1.5Ô∏è‚É£ LLM Transform1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -192,
        14768
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Parse Text LLM Response\n// Extract works from LLM API response\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst prepData = $('Prep Text LLM2').first().json;\nconst apiResponse = $input.first().json;\nconst cid = String(prepData.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst L = prepData.L || {};\nconst provider = prepData._llm_provider || 'gemini';\n\nconsole.log('=== PARSE TEXT LLM ===');\nconsole.log('Provider:', provider);\n\nlet works = [];\nlet rawContent = '';\n\ntry {\n  // Extract text based on provider\n  if (provider === 'openai') {\n    rawContent = apiResponse.choices?.[0]?.message?.content || '';\n  } else {\n    rawContent = apiResponse.candidates?.[0]?.content?.parts?.[0]?.text || '';\n  }\n  \n  console.log('Raw response length:', rawContent.length);\n  console.log('Raw response preview:', rawContent.substring(0, 200));\n  \n  if (rawContent) {\n    // Clean and parse JSON\n    let cleanContent = rawContent\n      .replace(/```json\\s*/gi, '')\n      .replace(/```\\s*/gi, '')\n      .replace(/^[^\\[]*/, '')  // Remove anything before [\n      .trim();\n    \n    const jsonStart = cleanContent.indexOf('[');\n    const jsonEnd = cleanContent.lastIndexOf(']');\n    \n    if (jsonStart !== -1 && jsonEnd !== -1) {\n      const jsonStr = cleanContent.substring(jsonStart, jsonEnd + 1);\n      console.log('JSON to parse:', jsonStr.substring(0, 200));\n      works = JSON.parse(jsonStr);\n      console.log('Parsed works count:', works.length);\n    }\n  }\n} catch(e) {\n  console.log('Parse error:', e.message);\n}\n\n// Validate and normalize\nconst validWorks = (works || [])\n  .filter(w => w && w.name && String(w.name).length > 2)\n  .map((w, i) => ({\n    id: 'W' + String(i + 1).padStart(3, '0'),\n    seq: i + 1,\n    name: String(w.name).substring(0, 80).trim(),\n    query: String(w.name).substring(0, 80).trim(),\n    qty: Math.max(0.1, parseFloat(w.qty) || 1),\n    unit: ['m¬≤', 'm', 'pcs', 'kg', 'l', '—à—Ç', '–º¬≤', '–º', 'St', 'Stk'].includes(w.unit) ? w.unit : 'm¬≤',\n    room: w.room || '',\n    conf: 'medium',\n    cat: 'finishing'\n  }));\n\nconsole.log('Valid works:', validWorks.length);\n\n// Save to session\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = { lang: prepData.lang };\nsd.sess[cid].works = validWorks;\nsd.sess[cid].description = prepData.description || '';\nsd.sess[cid].state = 'wait_edit';\nsd.sess[cid].db = prepData.db;\nsd.sess[cid].L = L;\n\nreturn { json: { \n  ...prepData,\n  chatId: cid, \n  works: validWorks,\n  description: prepData.description || '',\n  L\n}};"
      },
      "id": "2528036c-543c-4078-bf1c-d4a3d6894254",
      "name": "Parse Text LLM1",
      "type": "n8n-nodes-base.code",
      "position": [
        -2208,
        13680
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify($json.msg) }},\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [\n      [{\"text\": \"{{ $json.L.btn_export_excel || '‚Üì Excel' }}\", \"callback_data\": \"export_excel\"}, {\"text\": \"{{ $json.L.btn_export_pdf || '‚Üì PDF' }}\", \"callback_data\": \"export_pdf\"}],\n      [{\"text\": \"{{ $json.L.btn_restart || '‚Üª Restart' }}\", \"callback_data\": \"restart\"}]\n    ]\n  }\n}",
        "options": {}
      },
      "id": "4086d961-ad0d-4477-a2c1-f5f322937fc2",
      "name": "üì§ Details2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2224,
        14768
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// Detailed view with resource prices\nconst cfg = $('Config2').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst data = sd.lastResults || {};\nconst L = data.L || cfg.L || {};\nconst works = data.works || [];\nconst sym = L.sym || '‚Ç¨';\n\nfunction fmtCur(v) { \n  if (!v || v === 0) return sym + ' 0';\n  return sym + ' ' + v.toFixed(2); \n}\n\nlet msg = `*${L.ready} ‚Äî ${L.resources}*\\n\\n`;\n\nworks.forEach((w, i) => {\n  const qi = { 'high': '‚óè', 'medium': '‚óã', 'low': '‚óå', 'not_found': '‚úï' }[w.ql] || '‚óã';\n  \n  msg += `*${i+1}. ${w.name}*\\n`;\n  if (w.rate_code && w.rate_code !== 'NOT_FOUND') {\n    msg += `${qi} \\`${w.rate_code}\\`\\n`;\n    if (w.rate_name && w.rate_name !== w.name) {\n      const rateName = (w.rate_name || '').substring(0, 45);\n      msg += `_${rateName}_\\n`;\n    }\n  } else {\n    msg += `${qi} _${L.not_found}_\\n`;\n  }\n  msg += `${w.qty} ${w.unit} √ó ${fmtCur(w.uc)} = *${fmtCur(w.tc)}*\\n`;\n  \n  // Cost breakdown\n  const parts = [];\n  if (w.workers_total > 0) parts.push(`${L.workers}: ${fmtCur(w.workers_total)}`);\n  if (w.materials_total > 0) parts.push(`${L.materials}: ${fmtCur(w.materials_total)}`);\n  if (w.machines_total > 0) parts.push(`${L.machines}: ${fmtCur(w.machines_total)}`);\n  if (parts.length > 0) msg += `_${parts.join(' ¬∑ ')}_\\n`;\n  \n  // Resources with prices\n  const resources = w.resources || [];\n  if (resources.length > 0) {\n    msg += `\\n`;\n    const showCount = Math.min(5, resources.length);\n    resources.slice(0, showCount).forEach((r, ri) => {\n      const isLast = ri === showCount - 1 && resources.length <= 5;\n      const prefix = isLast ? '‚îî' : '‚îú';\n      const typeTag = r.resource_type === 'labor' ? L.res_labor : r.resource_type === 'machine' ? L.res_machine : L.res_material;\n      const resName = (r.resource_name || '').substring(0, 26);\n      msg += `${prefix} *${typeTag}*: ${resName}\\n`;\n      \n      // Show quantity and cost\n      const qtyVal = r.scaled_quantity || r.resource_quantity || 0;\n      const costVal = r.scaled_cost || r.resource_cost || 0;\n      if (costVal > 0) {\n        msg += `   ${qtyVal.toFixed(2)} ${r.resource_unit || ''} = ${fmtCur(costVal)}\\n`;\n      } else {\n        msg += `   ${qtyVal.toFixed(2)} ${r.resource_unit || ''}\\n`;\n      }\n    });\n    if (resources.length > 5) {\n      msg += `‚îî _...+${resources.length - 5} ${L.resources}_\\n`;\n    }\n  }\n  \n  // Scope of work\n  const scope = w.scope_of_work || [];\n  if (scope.length > 0) {\n    msg += `\\nüìã *${L.scope_title || 'Scope of Work'}:*\\n`;\n    scope.forEach((s, si) => {\n      const prefix = si === scope.length - 1 ? '‚îî' : '‚îú';\n      const sText = (s || '').substring(0, 45);\n      msg += `${prefix} ${sText}\\n`;\n    });\n  }\n  msg += `\\n`;\n});\n\n// Summary\nmsg += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n`;\nconst totalParts = [];\nif (data.workers_sum > 0) totalParts.push(`${L.workers}: ${fmtCur(data.workers_sum)}`);\nif (data.materials_sum > 0) totalParts.push(`${L.materials}: ${fmtCur(data.materials_sum)}`);\nif (data.machines_sum > 0) totalParts.push(`${L.machines}: ${fmtCur(data.machines_sum)}`);\nif (totalParts.length > 0) msg += totalParts.join('\\n') + '\\n\\n';\n\nmsg += `*${L.total}: ${fmtCur(data.total || 0)}*\\n`;\n\nreturn { json: { ...cfg, msg, chatId: cid, bot_token: cfg.bot_token, L } };"
      },
      "id": "97497760-1982-4bad-9ea5-28640d2aa340",
      "name": "View Details2",
      "type": "n8n-nodes-base.code",
      "position": [
        -2416,
        14768
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify(($json.L && $json.L.fallback_start) || \"Use /start to begin\") }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "79b08b1c-a240-4a41-a9a1-6c9dff24d1b1",
      "name": "üì§ Fallback2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2432,
        14112
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": \"*DDC CWICR - Help*\\n\\n*What is DDC CWICR?*\\nOpen source construction cost database\\nhttps://DataDrivenConstruction.io\\n\\n*Features:*\\nüì∏ Photo analysis with AI\\nüìù Text input with work lists\\nüåç 9 languages supported\\nüìä 55,000+ work items\\nüí∞ Regional pricing (EUR, USD, RUB, etc.)\\nüìÑ Excel & PDF export\\n\\n*How to use:*\\n1. Select your language\\n2. Send photo OR text description\\n3. Edit detected works if needed\\n4. Get cost estimate\\n\\n*Commands:*\\n/start - New estimate\\n\\n*Contact:*\\nGitHub: github.com/datadrivenconstruction/OpenConstructionEstimate-DDC-CWICR\",\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [[{\"text\": \"‚óÄÔ∏è Back\", \"callback_data\": \"back_to_lang\"}]]\n  }\n}",
        "options": {}
      },
      "id": "bd702901-5c81-46bf-9488-fb2cd1ac8285",
      "name": "üì§ Help2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2416,
        14768
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $json.chatId }}",
        "binaryData": true,
        "binaryPropertyName": "pdf",
        "additionalFields": {
          "caption": "={{ $json.L?.export_pdf_msg || 'üìÑ PDF Export (HTML)' }}",
          "fileName": "={{ $json.filename }}"
        }
      },
      "id": "2681180a-2487-467b-a396-b4adff374889",
      "name": "üì§ Send PDF2",
      "type": "n8n-nodes-base.telegram",
      "position": [
        -1984,
        14608
      ],
      "webhookId": "75b0ff85",
      "typeVersion": 1.2,
      "credentials": {
        "telegramApi": {
          "id": "Pg9c5uHdiZaPWTEZ",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "operator": {
                "type": "boolean",
                "operation": "notEquals"
              },
              "leftValue": "={{ $json.skip }}",
              "rightValue": true
            }
          ]
        },
        "options": {}
      },
      "id": "44c1c9d9-7492-4c09-88bc-e3e5a2926a81",
      "name": "IF PDF2",
      "type": "n8n-nodes-base.if",
      "position": [
        -2224,
        14624
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// Generate PDF (using HTML-to-PDF service or return HTML)\nconst cfg = $('Config2').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst html = sd.html_report || '';\nconst L = sd.lastResults?.L || cfg.L || {};\n\nif (!html) {\n  // No HTML report yet - send message\n  try {\n    await $http.request({\n      method: 'POST',\n      url: `https://api.telegram.org/bot${cfg.bot_token}/sendMessage`,\n      body: { chat_id: parseInt(cid), text: '‚ùå No report to export. Please calculate first.' },\n      json: true\n    });\n  } catch(e) {}\n  return { json: { skip: true } };\n}\n\n// For now, send HTML file as \"PDF alternative\"\nconst filename = `Estimate_${(L.region || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().substring(0, 10)}.html`;\n\nreturn { json: { chatId: cid, L, bot_token: cfg.bot_token, filename }, binary: { pdf: { data: Buffer.from(html, 'utf-8').toString('base64'), mimeType: 'text/html', fileName: filename } } };"
      },
      "id": "f6a1a35b-c16b-4080-b2da-ffd5089ecb06",
      "name": "Generate PDF2",
      "type": "n8n-nodes-base.code",
      "position": [
        -2416,
        14624
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $json.chatId }}",
        "binaryData": true,
        "binaryPropertyName": "excel",
        "additionalFields": {
          "caption": "={{ $json.L?.export_excel_msg || 'üìä Excel Export (CSV)' }}",
          "fileName": "={{ $json.filename }}"
        }
      },
      "id": "a267d3ed-b1f6-448c-bd38-e0b4c21f215b",
      "name": "üì§ Send Excel2",
      "type": "n8n-nodes-base.telegram",
      "position": [
        -2224,
        14928
      ],
      "webhookId": "401e16ac",
      "typeVersion": 1.2,
      "credentials": {
        "telegramApi": {
          "id": "Pg9c5uHdiZaPWTEZ",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// Generate Excel file\nconst cfg = $('Config2').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst data = sd.lastResults || {};\nconst L = data.L || cfg.L || {};\nconst works = data.works || [];\n\n// Create CSV content (Excel-compatible)\nlet csv = '\\uFEFF'; // BOM for UTF-8\ncsv += `${L.doc_title || 'ESTIMATE'} - ${data.description || 'Photo Estimate'}\\n`;\ncsv += `${L.region || 'Region'} | ${new Date().toLocaleDateString()}\\n\\n`;\n\n// Headers\ncsv += `${L.col_pos || 'Pos'};${L.col_code || 'Code'};${L.col_desc || 'Description'};${L.col_unit || 'Unit'};${L.col_qty || 'Qty'};${L.col_price || 'Price'};${L.col_total || 'Total'}\\n`;\n\n// Data rows\nworks.forEach((w, i) => {\n  const name = (w.rate_name || w.name || '').replace(/;/g, ',').replace(/\\n/g, ' ');\n  csv += `${i+1};${w.rate_code || ''};\"${name}\";${w.rate_unit || w.unit || ''};${(w.qty || 0).toFixed(2)};${(w.uc || 0).toFixed(2)};${(w.tc || 0).toFixed(2)}\\n`;\n  \n  // Resources\n  (w.resources || []).forEach(r => {\n    const resName = (r.resource_name || '').replace(/;/g, ',').replace(/\\n/g, ' ');\n    csv += `;${r.resource_code || ''};\"  ${resName}\";${r.resource_unit || ''};${(r.scaled_quantity || 0).toFixed(3)};${(r.resource_price || 0).toFixed(2)};${(r.scaled_cost || 0).toFixed(2)}\\n`;\n  });\n});\n\n// Totals\ncsv += `\\n;;;;;${L.total || 'TOTAL'};${(data.total || 0).toFixed(2)}\\n`;\ncsv += `;;;;;${L.workers || 'Labor'};${(data.workers_sum || 0).toFixed(2)}\\n`;\ncsv += `;;;;;${L.materials || 'Materials'};${(data.materials_sum || 0).toFixed(2)}\\n`;\ncsv += `;;;;;${L.machines || 'Equipment'};${(data.machines_sum || 0).toFixed(2)}\\n`;\n\nconst filename = `Estimate_${(L.region || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().substring(0, 10)}.csv`;\n\nreturn { json: { chatId: cid, L, bot_token: cfg.bot_token, filename }, binary: { excel: { data: Buffer.from(csv, 'utf-8').toString('base64'), mimeType: 'text/csv', fileName: filename } } };"
      },
      "id": "052e5005-e630-45c9-b187-62650a949992",
      "name": "Generate Excel2",
      "type": "n8n-nodes-base.code",
      "position": [
        -2416,
        14928
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $json.chatId }}",
        "binaryData": true,
        "binaryPropertyName": "html",
        "additionalFields": {
          "caption": "üìä Professional HTML Report",
          "fileName": "={{ $json.filename }}"
        }
      },
      "id": "52c6840a-04a5-4741-8fec-369ab6adab3b",
      "name": "üì§ Send HTML2",
      "type": "n8n-nodes-base.telegram",
      "position": [
        96,
        14400
      ],
      "webhookId": "a0c501c4",
      "typeVersion": 1.2,
      "credentials": {
        "telegramApi": {
          "id": "Pg9c5uHdiZaPWTEZ",
          "name": "Telegram Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst d = $input.first().json;\nconst html = d.html_content || '';\nconst L = d.L || {};\nconst now = new Date();\nconst ts = now.toISOString().replace(/[:.]/g, '-').substring(0, 16);\nconst filename = `Estimate_${(L.region || 'Report').replace(/[^a-zA-Z0-9]/g, '_')}_${ts}.html`;\n\nreturn { json: { chatId: d.chatId, bot_token: d.bot_token, filename }, binary: { html: { data: Buffer.from(html, 'utf-8').toString('base64'), mimeType: 'text/html', fileName: filename } } };"
      },
      "id": "e1959a7e-76fa-45ae-a4fe-9efc373df829",
      "name": "Prep HTML File2",
      "type": "n8n-nodes-base.code",
      "position": [
        -64,
        14400
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"chat_id\": {{ $json.chatId }}, \"text\": {{ JSON.stringify($json.msg) }}, \"parse_mode\": \"Markdown\", \"reply_markup\": {\"inline_keyboard\": [[{\"text\": \"{{ $json.L.resources || 'Resources' }}\", \"callback_data\": \"view_details\"}], [{\"text\": \"{{ $json.L.btn_export_excel || 'Excel' }}\", \"callback_data\": \"export_excel\"}, {\"text\": \"{{ $json.L.btn_export_pdf || 'PDF' }}\", \"callback_data\": \"export_pdf\"}], [{\"text\": \"{{ $json.L.btn_restart || 'New' }}\", \"callback_data\": \"restart\"}]]}}",
        "options": {}
      },
      "id": "1c7966d3-707e-4c6c-840a-23d5e13b0e8b",
      "name": "üì§ Final2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -64,
        14240
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Final message with resources preview\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst d = $('Generate HTML2').first().json;\nconst cid = d.chatId;\nconst sd = $getWorkflowStaticData('global');\nconst L = d.L || {};\n\nif (sd.res?.[cid]) delete sd.res[cid];\nif (sd.sess?.[cid]) sd.sess[cid].state = 'done';\n\nfunction fmt(v) { \n  try { return new Intl.NumberFormat(L.loc || 'en', { maximumFractionDigits: 0 }).format(v || 0); } \n  catch(e) { return (v || 0).toFixed(0); } \n}\nfunction fmtCur(v) { \n  const sym = L.sym || '$';\n  if (Math.abs(v) >= 1000) return sym + ' ' + fmt(v);\n  return sym + ' ' + (v || 0).toFixed(2);\n}\nfunction shortName(str, len) {\n  str = String(str || '');\n  if (str.length > len) return str.substring(0, len - 1) + '...';\n  return str;\n}\n\nfunction escMd(s) {\n  // Remove Markdown special chars for Telegram (Markdown mode doesn't support escaping)\n  return String(s || '').replace(/[_*`\\[\\]]/g, '');\n}\n\nconst works = d.works || [];\nconst total = d.total || 0;\nconst now = new Date();\nconst dateStr = now.toLocaleDateString(L.loc || 'en', { year: 'numeric', month: '2-digit', day: '2-digit' });\n\nconst qiMarks = { 'high': '‚óè', 'medium': '‚óã', 'low': '‚óå', 'not_found': '‚úï' };\n\n// Header\nlet msg = `*${L.doc_title || 'COST ESTIMATE'}*\\n`;\nmsg += `${dateStr} ¬∑ ${L.region || ''}\\n\\n`;\n\n// Works with resources\nworks.forEach((w, i) => {\n  const qi = qiMarks[w.ql] || '‚óã';\n  const name = escMd(shortName(w.rate_name || w.name || '', 30));\n  const sumStr = fmtCur(w.tc);\n  \n  msg += `${qi} *${i+1}.* ${name}\\n`;\n  msg += `   ${w.qty} ${w.unit} √ó ${fmtCur(w.uc)} = *${sumStr}*\\n`;\n  \n  // Show 2-3 resources\n  const resources = w.resources || [];\n  if (resources.length > 0) {\n    const preview = resources.slice(0, 3);\n    preview.forEach((r, ri) => {\n      const isLast = ri === preview.length - 1 && resources.length <= 3;\n      const prefix = isLast ? '‚îî' : '‚îú';\n      const typeIcon = r.resource_type === 'labor' ? 'L' : r.resource_type === 'machine' ? 'M' : 'R';\n      const rName = escMd(shortName(r.resource_name || '', 40));\n      const rCost = fmtCur(r.scaled_cost || 0);\n      msg += `   ${prefix} [${typeIcon}] ${rName} ${rCost}\\n`;\n    });\n    if (resources.length > 3) {\n      msg += `   ‚îî +${resources.length - 3} ${L.more_resources || 'more'}\\n`;\n    }\n  }\n  \n  // Show scope of work preview\n  const scope = w.scope_of_work || [];\n  if (scope.length > 0) {\n    msg += `   üìã ${L.scope_title || 'Scope'}:\\n`;\n    const scopePreview = scope.slice(0, 2);\n    scopePreview.forEach((s, si) => {\n      const isLast = si === scopePreview.length - 1 && scope.length <= 2;\n      const prefix = isLast ? '   ‚îî' : '   ‚îú';\n      const sText = escMd(shortName(s, 35));\n      msg += `${prefix} ‚Ä¢ ${sText}\\n`;\n    });\n    if (scope.length > 2) {\n      msg += `   ‚îî +${scope.length - 2} ${L.more_resources || 'more'}\\n`;\n    }\n  }\n});\n\n// Total\nmsg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n`;\nmsg += `*${L.total || 'TOTAL'}:* ${fmtCur(total)}\\n\\n`;\n\n// Quality legend\nconst qHigh = works.filter(w => w.ql === 'high').length;\nconst qMed = works.filter(w => w.ql === 'medium').length;\nconst qLow = works.filter(w => w.ql === 'low').length;\nconst qNone = works.filter(w => w.ql === 'not_found').length;\n\nconst avgLLM = works.length > 0 ? Math.round(works.reduce((s, w) => s + (w.llm_score || 0), 0) / works.length) : 0;\nmsg += `‚óè ${qHigh}  ‚óã ${qMed}  ‚óå ${qLow}  ‚úï ${qNone}  (${d.pct}% ${L.found_pct || 'found'})\\n`;\nif (avgLLM > 0) msg += `üéØ AI: ${avgLLM}%\\n`;\nmsg += `\\n`;\n\n// Cost breakdown\nif (d.workers_sum > 0 || d.materials_sum > 0 || d.machines_sum > 0) {\n  const parts = [];\n  if (d.workers_sum > 0) parts.push(`${L.workers || 'Labor'}: ${fmtCur(d.workers_sum)}`);\n  if (d.materials_sum > 0) parts.push(`${L.materials || 'Mat'}: ${fmtCur(d.materials_sum)}`);\n  if (d.machines_sum > 0) parts.push(`${L.machines || 'Equip'}: ${fmtCur(d.machines_sum)}`);\n  msg += parts.join(' ¬∑ ') + '\\n';\n}\n\nif (d.labor_hours_sum > 0) {\n  const days = Math.ceil(d.labor_hours_sum / 8);\n  msg += `${L.labor_hours || 'Hours'}: ${fmt(d.labor_hours_sum)}h ¬∑ ~${days} ${L.days || 'days'}\\n`;\n}\n\nmsg += `\\n_${L.price_note || 'Prices are approximate'}_\\n`;\nmsg += `_${L.more_in_html || 'Detailed report available'}_\\n\\n`;\nmsg += `${L.what_next || 'Options:'}`;\n\nreturn { json: { ...d, msg } };"
      },
      "id": "e476b5fb-afbc-4e44-9fa2-33f7e2509964",
      "name": "Final2",
      "type": "n8n-nodes-base.code",
      "position": [
        -208,
        14368
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Generate HTML Report with expandable resources\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst d = $('Agg2').first().json;\nconst L = d.L || {};\nconst cur = L.cur || 'USD'; \nconst loc = L.loc || 'en'; \nconst sym = L.sym || '$';\nconst works = d.works || []; \nconst total = d.total || 0;\n\nfunction fmt(v) { \n  try { \n    return new Intl.NumberFormat(loc, { style: 'currency', currency: cur, minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(v || 0); \n  } catch(e) { \n    return sym + ' ' + (v || 0).toFixed(2); \n  } \n}\nfunction fmtNum(v, dec) { \n  return new Intl.NumberFormat(loc, { minimumFractionDigits: dec || 2, maximumFractionDigits: dec || 2 }).format(v || 0); \n}\nfunction esc(t) { \n  return String(t || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); \n}\n\nconst now = new Date();\nconst dateStr = now.toLocaleDateString(loc, { day: '2-digit', month: '2-digit', year: 'numeric' });\nconst timeStr = now.toLocaleTimeString(loc, { hour: '2-digit', minute: '2-digit' });\n\nconst laborPct = total > 0 ? Math.round(d.workers_sum / total * 100) : 0;\nconst materialPct = total > 0 ? Math.round(d.materials_sum / total * 100) : 0;\nconst machinePct = total > 0 ? Math.round(d.machines_sum / total * 100) : 0;\nconst laborDays = Math.ceil((d.labor_hours_sum || 0) / 8);\n\nlet html = `<!DOCTYPE html>\n<html><head><meta charset=\"UTF-8\">\n<title>${esc(L.doc_title || 'Cost Estimate')} - ${esc(d.description || '')}</title>\n<style>\n:root{--primary:#007AFF;--text:#1D1D1F;--text2:#86868B;--text3:#AEAEB2;--bg:#FFF;--bg2:#F5F5F7;--bg3:#E8E8ED;--border:#D2D2D7;--labor:#E3F2FD;--labor-text:#1565C0;--material:#FFF3E0;--material-text:#E65100;--machine:#F3E5F5;--machine-text:#7B1FA2}\n*{box-sizing:border-box}\nbody{font-family:-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,sans-serif;margin:0;padding:16px;background:var(--bg2);color:var(--text);font-size:12px;line-height:1.4}\n.container{background:var(--bg);max-width:1200px;margin:0 auto;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,.08);overflow:hidden}\n.header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}\n.header h1{margin:0;font-size:18px;font-weight:600}\n.header-info{font-size:11px;color:var(--text3)}\n.toolbar{padding:10px 20px;background:var(--bg2);border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap}\n.btn{padding:6px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);cursor:pointer;font-size:11px}\n.btn:hover{background:var(--bg3)}\n.kpi{display:flex;gap:8px;padding:12px 20px;background:var(--bg2);flex-wrap:wrap}\n.kpi-card{background:var(--bg);border-radius:8px;padding:10px 14px;border:1px solid var(--border);min-width:100px}\n.kpi-value{font-size:16px;font-weight:600}\n.kpi-label{font-size:9px;color:var(--text3);text-transform:uppercase}\ntable{width:100%;border-collapse:collapse}\nth,td{padding:8px 10px;text-align:left;border-bottom:1px solid var(--border)}\nth{background:var(--bg2);font-weight:500;font-size:10px;text-transform:uppercase;color:var(--text2)}\n.work-row{cursor:pointer;transition:background 0.15s}\n.work-row:hover{background:var(--bg2)}\n.work-row td:first-child{font-weight:500}\n.toggle{width:20px;color:var(--text3);font-size:10px}\n.res-row{background:#FAFAFA;font-size:11px}\n.res-row.hidden{display:none}\n.scope-row{background:#F0FFF0;font-size:11px}\n.scope-row.hidden{display:none}\n.scope-row td{padding:6px 10px 6px 30px;border-bottom:1px dashed #D0E8D0}\n.scope-toggle{color:var(--primary);cursor:pointer;font-size:10px;margin-left:8px}\n.res-row td{padding:6px 10px 6px 30px;border-bottom:1px dashed var(--border)}\n.res-tag{display:inline-block;padding:2px 6px;border-radius:4px;font-size:9px;font-weight:500;margin-right:6px}\n.res-labor{background:var(--labor);color:var(--labor-text)}\n.res-material{background:var(--material);color:var(--material-text)}\n.res-machine{background:var(--machine);color:var(--machine-text)}\n.summary-row{background:linear-gradient(90deg,var(--bg2),var(--bg));font-size:10px}\n.summary-row.hidden{display:none}\n.summary-row td{padding:6px 10px 6px 30px;border-top:1px solid var(--border)}\n.dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:4px}\n.dot-high{background:#34C759}\n.dot-medium{background:#FF9500}\n.dot-low{background:#FF3B30}\n.dot-none{background:#8E8E93}\n.total-row{background:var(--bg2);font-weight:600}\n.total-row td{padding:12px 10px}\n.right{text-align:right}\n.footer{padding:16px 20px;text-align:center;font-size:10px;color:var(--text3);border-top:1px solid var(--border)}\n.footer a{color:var(--primary);text-decoration:none}\n@media(max-width:600px){\n  body{padding:8px;font-size:11px}\n  th,td{padding:6px}\n  .kpi-card{min-width:80px;padding:8px}\n  .kpi-value{font-size:14px}\n}\n</style>\n</head><body>\n<div class=\"container\">\n<div class=\"header\">\n  <h1>${esc(L.doc_title || 'Cost Estimate')}</h1>\n  <div class=\"header-info\">${dateStr} ${timeStr} ¬∑ ${esc(L.region || '')}</div>\n</div>\n<div class=\"toolbar\">\n  <button class=\"btn\" onclick=\"expandAll()\">${esc(L.expand_all || 'Expand All')}</button>\n  <button class=\"btn\" onclick=\"collapseAll()\">${esc(L.collapse_all || 'Collapse All')}</button>\n</div>\n<div class=\"kpi\">\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${fmt(total)}</div><div class=\"kpi-label\">${esc(L.kpi_total || 'Total')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${works.length}</div><div class=\"kpi-label\">${esc(L.kpi_items || 'Items')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${laborDays}d</div><div class=\"kpi-label\">${esc(L.kpi_days || 'Days')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${laborPct}%</div><div class=\"kpi-label\">${esc(L.workers || 'Labor')}</div></div>\n  <div class=\"kpi-card\"><div class=\"kpi-value\">${materialPct}%</div><div class=\"kpi-label\">${esc(L.materials || 'Materials')}</div></div>\n</div>\n<table>\n<tr>\n  <th style=\"width:30px\"></th>\n  <th>${esc(L.col_code || 'Code')}</th>\n  <th>${esc(L.col_desc || 'Description')}</th>\n  <th>${esc(L.col_unit || 'Unit')}</th>\n  <th class=\"right\">${esc(L.col_qty || 'Qty')}</th>\n  <th class=\"right\">${esc(L.col_price || 'Price')}</th>\n  <th class=\"right\">${esc(L.col_total || 'Total')}</th>\n  <th style=\"width:30px\"></th>\n</tr>`;\n\nworks.forEach((w, i) => {\n  console.log('Work ' + (i+1) + ': ' + (w.rate_name || w.name) + ' - Resources: ' + (w.resources || []).length);\n  const hasRes = (w.resources || []).length > 0;\n  const isFirst = i === 0;\n  const dotClass = w.ql === 'high' ? 'dot-high' : w.ql === 'medium' ? 'dot-medium' : w.ql === 'low' ? 'dot-low' : 'dot-none';\n  const code = w.rate_code && w.rate_code !== 'NOT_FOUND' ? w.rate_code : '‚Äî';\n  \n  const hasScope = (w.scope_of_work || []).length > 0;\n  const scopeBtn = hasScope ? '<span class=\"scope-toggle\" onclick=\"event.stopPropagation();toggleScope(' + i + ')\">üìã</span>' : '';\n  \n  html += `<tr class=\"work-row\" data-work=\"${i}\" onclick=\"toggleWork(${i})\">\n    <td class=\"toggle\"><span id=\"icon-${i}\">${isFirst ? '‚ñº' : '‚ñ∂'}</span></td>\n    <td style=\"font-size:10px;color:var(--text2)\">${esc(code)}</td>\n    <td><strong>${esc(w.rate_name || w.name)}</strong>${scopeBtn}</td>\n    <td>${esc(w.rate_unit || w.unit)}</td>\n    <td class=\"right\">${fmtNum(w.qty)}</td>\n    <td class=\"right\">${fmt(w.uc)}</td>\n    <td class=\"right\"><strong>${fmt(w.tc)}</strong></td>\n    <td><span class=\"dot ${dotClass}\" title=\"${w.llm_match || ''}\"></span>${w.llm_score ? '<span style=\"font-size:9px;color:var(--text3);margin-left:2px\">' + w.llm_score + '</span>' : ''}</td>\n  </tr>`;\n  \n  // Scope of work rows\n  const scopeItems = w.scope_of_work || [];\n  if (scopeItems.length > 0) {\n    html += `<tr class=\"scope-row hidden\" data-scope=\"${i}\">\n      <td></td>\n      <td colspan=\"6\" style=\"background:#F8FFF8\">\n        <strong style=\"color:#2E7D32\">üìã ${esc(L.scope_title || 'Scope of Work')}:</strong><br>\n        ${scopeItems.map((s, si) => '<span style=\"color:#555\">‚Ä¢ ' + esc(s) + '</span>').join('<br>')}\n      </td>\n      <td></td>\n    </tr>`;\n  }\n  \n  // Resources\n  const resources = w.resources || [];\n  resources.forEach((r, ri) => {\n    const tagClass = r.resource_type === 'labor' ? 'res-labor' : r.resource_type === 'machine' ? 'res-machine' : 'res-material';\n    const tagLabel = r.resource_type === 'labor' ? (L.res_labor || 'Labor') : r.resource_type === 'machine' ? (L.res_machine || 'Equip') : (L.res_material || 'Mat');\n    const hiddenClass = isFirst ? '' : 'hidden';\n    const resQty = r.scaled_quantity || r.resource_quantity || 0;\n    const resPrice = r.resource_price || 0;\n    const resCost = r.scaled_cost || 0;\n    const norm = r.resource_quantity || r.norma || 0;\n    const pct = w.tc > 0 ? Math.round(resCost / w.tc * 100) : 0;\n    \n    html += `<tr class=\"res-row ${hiddenClass}\" data-work=\"${i}\">\n      <td></td>\n      <td><span style=\"font-size:9px;color:var(--text3)\">${esc(r.resource_code || '')}</span></td>\n      <td>\n        <span class=\"res-tag ${tagClass}\">${esc(tagLabel)}</span>\n        ${esc(r.resource_name || '')}\n        ${norm ? '<span style=\"color:var(--text3);font-size:9px;margin-left:4px\">√ó' + fmtNum(norm, 4) + '</span>' : ''}\n      </td>\n      <td style=\"font-size:10px\">${esc(r.resource_unit || '')}</td>\n      <td class=\"right\" style=\"font-size:10px\">${fmtNum(resQty, 3)}</td>\n      <td class=\"right\" style=\"font-size:10px\">${fmt(resPrice)}</td>\n      <td class=\"right\">${fmt(resCost)} <span style=\"font-size:9px;color:var(--text3)\">${pct}%</span></td>\n      <td></td>\n    </tr>`;\n  });\n  \n  // Summary row for work\n  if (resources.length > 0) {\n    const laborSum = resources.filter(r => r.resource_type === 'labor').reduce((s, r) => s + (r.scaled_cost || 0), 0);\n    const matSum = resources.filter(r => r.resource_type === 'material').reduce((s, r) => s + (r.scaled_cost || 0), 0);\n    const machSum = resources.filter(r => r.resource_type === 'machine').reduce((s, r) => s + (r.scaled_cost || 0), 0);\n    const hiddenClass = isFirst ? '' : 'hidden';\n    \n    html += `<tr class=\"summary-row ${hiddenClass}\" data-work=\"${i}\">\n      <td colspan=\"2\"></td>\n      <td colspan=\"4\">\n        <span style=\"color:var(--labor-text)\">${L.workers || 'Labor'}: ${fmt(laborSum)}</span> ¬∑ \n        <span style=\"color:var(--material-text)\">${L.materials || 'Mat'}: ${fmt(matSum)}</span> ¬∑ \n        <span style=\"color:var(--machine-text)\">${L.machines || 'Equip'}: ${fmt(machSum)}</span>\n      </td>\n      <td class=\"right\"><strong>${fmt(w.tc)}</strong></td>\n      <td></td>\n    </tr>`;\n  }\n});\n\nhtml += `<tr class=\"total-row\">\n  <td colspan=\"6\" style=\"text-align:right\">${esc(L.grand_total || 'TOTAL')}</td>\n  <td class=\"right\">${fmt(total)}</td>\n  <td></td>\n</tr>\n</table>\n<div class=\"footer\">\n  <a href=\"https://DataDrivenConstruction.io\" target=\"_blank\">DDC CWICR</a> ¬∑ \n  Open Source Construction Cost Database ¬∑ ${dateStr}\n</div>\n</div>\n<script>\nfunction toggleWork(idx) {\n  const icon = document.getElementById('icon-' + idx);\n  const rows = document.querySelectorAll('tr[data-work=\"' + idx + '\"]:not(.work-row)');\n  const isHidden = rows.length > 0 && rows[0].classList.contains('hidden');\n  rows.forEach(r => r.classList.toggle('hidden', !isHidden));\n  if (icon) icon.textContent = isHidden ? '‚ñº' : '‚ñ∂';\n}\nfunction expandAll() {\n  document.querySelectorAll('tr[data-work]').forEach(r => r.classList.remove('hidden'));\n  document.querySelectorAll('[id^=\"icon-\"]').forEach(i => i.textContent = '‚ñº');\n}\nfunction collapseAll() {\n  document.querySelectorAll('tr.res-row, tr.summary-row, tr.scope-row').forEach(r => r.classList.add('hidden'));\n  document.querySelectorAll('[id^=\"icon-\"]').forEach(i => i.textContent = '‚ñ∂');\n}\nfunction toggleScope(idx) {\n  const rows = document.querySelectorAll('tr.scope-row[data-scope=\"' + idx + '\"]');\n  rows.forEach(r => r.classList.toggle('hidden'));\n}\n</script>\n</body></html>`;\n\nconst sd = $getWorkflowStaticData('global');\nsd.html_report = html;\n\nreturn { json: { ...d, html_content: html } };"
      },
      "id": "870bb87b-60b5-44f1-b301-266a55ea95fb",
      "name": "Generate HTML2",
      "type": "n8n-nodes-base.code",
      "position": [
        -368,
        14368
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/answerCallbackQuery",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"callback_query_id\": \"{{ $('Config2').item.json.callbackQueryId }}\",\n  \"text\": \"{{ $('Config2').item.json.L.loading }}\",\n  \"show_alert\": false\n}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "6eb4064a-5472-4028-aa3d-2ace19e92a3c",
      "name": "Answer Calc CB2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2416,
        14464
      ],
      "typeVersion": 4.2,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify($json.msg) }},\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": { \"inline_keyboard\": {{ JSON.stringify($json.keyboard) }} }\n}",
        "options": {}
      },
      "id": "60210980-5836-4915-8af8-d45f5cc9a429",
      "name": "üì§ Works Updated2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2224,
        14272
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// WORKS UPDATED - Show updated works list after quantity change\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config2').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst works = session.works || [];\nconst L = cfg.L || session.L || {};\n\nconsole.log('=== WORKS UPDATED ===');\nconsole.log('Works:', works.length);\nconsole.log('L.native:', L.native);\n\nlet msg = '‚úÖ ' + (L.work_added || '–û–±–Ω–æ–≤–ª–µ–Ω–æ') + '\\n\\n';\nmsg += '*' + works.length + ' ' + (L.items || '–ø–æ–∑–∏—Ü–∏–π') + '*\\n\\n';\n\nfor (let i = 0; i < works.length; i++) {\n  const w = works[i];\n  const name = w.name.length > 25 ? w.name.substring(0, 22) + '...' : w.name;\n  msg += (i + 1) + '. ' + name + ' ‚Äî ' + w.qty + ' ' + (w.unit || 'm¬≤') + '\\n';\n}\n\n// No limit\n\nconst keyboard = [];\nconst maxBtns = works.length;\nfor (let i = 0; i < maxBtns; i += 5) {\n  const row = [];\n  for (let j = 0; j < 5 && i + j < maxBtns; j++) {\n    row.push({ text: '‚úèÔ∏è' + (i + j + 1), callback_data: 'edit_work_' + (i + j) });\n  }\n  keyboard.push(row);\n}\n\nkeyboard.push([\n  { text: L.btn_add_work || '+ –ü–æ–∑–∏—Ü–∏—è', callback_data: 'add_work' },\n  { text: L.btn_calc || '‚ñ∂ –†–∞—Å—á—ë—Ç', callback_data: 'calculate' }\n]);\nkeyboard.push([{ text: L.btn_new || 'üîÑ –ó–∞–Ω–æ–≤–æ', callback_data: 'new_photo' }]);\n\nreturn { json: { ...cfg, msg, keyboard } };"
      },
      "id": "5828363a-e9c6-4369-a254-acfc5ebd957c",
      "name": "Works Updated2",
      "type": "n8n-nodes-base.code",
      "position": [
        -2432,
        14272
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('Config2').item.json.chatId }},\n  \"text\": {{ JSON.stringify($('Config2').item.json.L.enter_work) }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "8ff6ad8c-676e-4378-8b30-3d708ed13aa6",
      "name": "üì§ Ask New Work2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2208,
        13280
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// EDIT MENU - Show edit buttons for selected work item\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config2').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst works = session.works || [];\nconst L = cfg.L || session.L || {};\n\nconst idx = session.editingWorkIndex || cfg.editingWorkIndex || 0;\nconst work = works[idx];\n\nconsole.log('=== EDIT MENU ===');\nconsole.log('Editing work index:', idx);\nconsole.log('Work:', work?.name);\n\nif (!work) {\n  return { json: { ...cfg, _skip: true } };\n}\n\nconst name = work.name.length > 30 ? work.name.substring(0, 27) + '...' : work.name;\nlet msg = '‚úèÔ∏è *' + (L.btn_edit || '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ') + '*\\n\\n';\nmsg += '*' + (idx + 1) + '. ' + name + '*\\n';\nmsg += 'üìè ' + work.qty + ' ' + (work.unit || 'm¬≤') + '\\n\\n';\nmsg += (L.edit_hint || '–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:');\n\n// Quantity edit buttons\nconst keyboard = [\n  [\n    { text: '-10', callback_data: 'qty_work_' + idx + '_minus10' },\n    { text: '-1', callback_data: 'qty_work_' + idx + '_minus1' },\n    { text: '+1', callback_data: 'qty_work_' + idx + '_plus1' },\n    { text: '+10', callback_data: 'qty_work_' + idx + '_plus10' }\n  ],\n  [\n    { text: '√∑2', callback_data: 'qty_work_' + idx + '_half' },\n    { text: '√ó2', callback_data: 'qty_work_' + idx + '_double' }\n  ],\n  [\n    { text: 'üóë ' + (L.btn_delete || '–£–¥–∞–ª–∏—Ç—å'), callback_data: 'delete_work_' + idx }\n  ],\n  [\n    { text: '‚óÄÔ∏è ' + (L.btn_done || '–ù–∞–∑–∞–¥'), callback_data: 'done_editing' }\n  ]\n];\n\nreturn { json: { ...cfg, msg, keyboard, chatId: cid } };"
      },
      "id": "0e6efc6b-a169-4c21-af76-946512dcca12",
      "name": "Edit Menu2",
      "type": "n8n-nodes-base.code",
      "position": [
        -2416,
        14288
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PARSE AI RESPONSE - Extract work items from Vision API response\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst data = $input.first().json;\nconst cid = String(data.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst L = data.L || {};\nconst provider = data.provider || 'gemini';\n\nconsole.log('=== PARSE AI ===');\nconsole.log('Provider:', provider);\nconsole.log('ChatId:', cid);\n\nlet p = { description: '', items: [] };\nlet rawContent = '';\n\ntry {\n  // Extract text from response based on provider\n  if (provider === 'openai') {\n    rawContent = data.choices?.[0]?.message?.content || '';\n  } else {\n    rawContent = data.candidates?.[0]?.content?.parts?.[0]?.text || '';\n  }\n  \n  console.log('Response length:', rawContent.length);\n  \n  if (rawContent) {\n    // Clean markdown and extract JSON\n    let cleanContent = rawContent\n      .replace(/```json\\s*/gi, '')\n      .replace(/```\\s*/gi, '')\n      .trim();\n    \n    const jsonStart = cleanContent.indexOf('{');\n    const jsonEnd = cleanContent.lastIndexOf('}');\n    \n    if (jsonStart !== -1 && jsonEnd !== -1) {\n      const jsonStr = cleanContent.substring(jsonStart, jsonEnd + 1);\n      p = JSON.parse(jsonStr);\n      console.log('Parsed items:', p.items?.length || 0);\n    }\n  }\n} catch(e) { \n  console.log('Parse error:', e.message);\n}\n\n// Validate and normalize items\nconst validItems = (p.items || [])\n  .filter(it => it.name && it.name.length > 2)\n  .map((it, i) => ({\n    id: 'W' + String(i + 1).padStart(3, '0'),\n    seq: i + 1,\n    name: String(it.name).substring(0, 80).trim(),\n    query: String(it.name).substring(0, 80).trim(),\n    qty: Math.max(0.1, parseFloat(it.qty) || 1),\n    unit: ['m¬≤', 'm', 'pcs', 'kg', 'l', '—à—Ç', '–º¬≤', '–º'].includes(it.unit) ? it.unit : 'm¬≤',\n    conf: ['high', 'medium', 'low'].includes(it.conf) ? it.conf : 'medium',\n    cat: ['demolition', 'rough', 'finishing', 'mep'].includes(it.cat) ? it.cat : 'finishing'\n  }));\n\nconsole.log('Valid items:', validItems.length);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// CRITICAL: Save works to session for later access\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = { lang: data.lang };\n\nsd.sess[cid].works = validItems;\nsd.sess[cid].description = p.description || '';\nsd.sess[cid].state = 'wait_edit';\nsd.sess[cid].db = data.db;\nsd.sess[cid].L = data.L;\n\nconsole.log('Saved to session:', sd.sess[cid].works.length, 'works');\n\nreturn { \n  json: { \n    ...data,\n    chatId: cid, \n    works: validItems,\n    description: p.description || '',\n    L: data.L\n  }\n};"
      },
      "id": "a1006bd2-b241-4b65-a91a-b02e5f584d3c",
      "name": "Parse AI1",
      "type": "n8n-nodes-base.code",
      "position": [
        96,
        13552
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('Config2').item.json.chatId }},\n  \"text\": \"{{ $('Config2').item.json.L.photo_added }} ({{ $('Config2').item.json.photos.length }} {{ $('Config2').item.json.L.photos_count }})\",\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [\n      [{\"text\": \"{{ $('Config2').item.json.L.add_more }}\", \"callback_data\": \"add_more_photos\"}, {\"text\": \"{{ $('Config2').item.json.L.analyze_now }}\", \"callback_data\": \"analyze_photos\"}],\n      [{\"text\": \"{{ $('Config2').item.json.L.btn_help }}\", \"callback_data\": \"show_help\"}]\n    ]\n  }\n}",
        "options": {}
      },
      "id": "9d28df54-8a27-44ac-8ed7-1b1b1e90b239",
      "name": "üì§ Analyze Options1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2208,
        13152
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('Config2').item.json.chatId }},\n  \"text\": {{ JSON.stringify($('Config2').item.json.L.photo) }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "6fc470e5-5319-42e8-9963-5c7416236aaf",
      "name": "üì§ Ask Photo1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2208,
        12960
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/answerCallbackQuery",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"callback_query_id\": \"{{ $('Config2').item.json.callbackQueryId }}\"\n}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "0c95df47-5ab4-4c6c-b71e-2ed5f47e4d09",
      "name": "Answer Photo CB1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2416,
        12960
      ],
      "typeVersion": 4.2,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $('Config2').item.json.chatId }},\n  \"text\": {{ JSON.stringify($('Config2').item.json.L.ok + \"\\n\\n\" + $('Config2').item.json.L.photo) }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "ebfcab98-9066-46d7-ad5d-e53015262a16",
      "name": "üì§ Lang OK2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2208,
        12816
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/answerCallbackQuery",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"callback_query_id\": \"{{ $('Config2').item.json.callbackQueryId }}\"\n}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "2865a277-260a-4344-bc04-4f5ace3e7798",
      "name": "Answer Lang CB2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2416,
        12816
      ],
      "typeVersion": 4.2,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": \"*DDC CWICR Cost Estimator*\\nhttps://DataDrivenConstruction.io\\n\\n‚ñ∏ Photo analysis (up to 4)\\n‚ñ∏ Text description\\n‚ñ∏ 9 languages ¬∑ 55,000+ work items\\n‚ñ∏ Excel & PDF export\\n\\nSelect language:\",\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": {\n    \"inline_keyboard\": [\n      [{\"text\": \"üá©üá™ Deutsch\", \"callback_data\": \"lang_DE\"}, {\"text\": \"üá¨üáß English\", \"callback_data\": \"lang_EN\"}, {\"text\": \"üá∑üá∫ –†—É—Å—Å–∫–∏–π\", \"callback_data\": \"lang_RU\"}],\n      [{\"text\": \"üá™üá∏ Espa√±ol\", \"callback_data\": \"lang_ES\"}, {\"text\": \"üá´üá∑ Fran√ßais\", \"callback_data\": \"lang_FR\"}, {\"text\": \"üáßüá∑ Portugu√™s\", \"callback_data\": \"lang_PT\"}],\n      [{\"text\": \"üá®üá≥ ‰∏≠Êñá\", \"callback_data\": \"lang_ZH\"}, {\"text\": \"üá¶üá™ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©\", \"callback_data\": \"lang_AR\"}, {\"text\": \"üáÆüá≥ ‡§π‡§ø‡§®‡•ç‡§¶‡•Ä\", \"callback_data\": \"lang_HI\"}],\n      [{\"text\": \"‚ùì Help\", \"callback_data\": \"show_help\"}]\n    ]\n  }\n}",
        "options": {}
      },
      "id": "3eebc0dc-971a-483a-a87a-15ec4a61507b",
      "name": "üì§ Lang Menu2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2416,
        12672
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "a3c7266e-9deb-4abe-a856-0e835757cdc8",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_lang"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "LANG"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "abc9388b-156f-4a27-8b6b-16d0e18e9749",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "lang_selected"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "LANG_OK"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "6a8ae65c-90f2-4a74-ac8c-e7e34d8eb49f",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "ask_photo"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "PHOTO"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "96f28956-a38b-4d71-86b7-b9b2f2750cc7",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_analyze_options"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "ANALYZE_OPT"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "ea59db87-7ac6-44aa-9e6f-6f061c30b451",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "photo_added"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "PHOTO_ADDED"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "f1f0126d-794b-48f7-9097-9fb54d5f097e",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "analyze"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "ANALYZE"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "320b81af-ef5e-4776-814d-3aead2e0a38a",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "works_updated"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "WORKS_UPD"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "def6b912-0ac9-4066-b421-59fd67b596c8",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_edit_menu"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "EDIT_MENU"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "4ca5650d-0486-456a-b17c-34ec088923d1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "ask_new_work"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "ADD_WORK"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "8f7bceab-ef7c-43b4-8afa-a8c309a74645",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "start_calc"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "CALC"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "e1037d8b-0e5f-46c3-a008-ad16d97689c2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "export_excel"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "EXCEL"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "6fff52ee-58d7-4073-b42d-cb15298d5788",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "export_pdf"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "PDF"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "fdf49046-6eaf-4183-8ff8-209eff4fefc4",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "show_help"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "HELP"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "6b143832-1fbb-40ee-9465-ff85f59b0328",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "view_details"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "DETAILS"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "d687c3a2-8bec-42df-9b32-74609fbd2d89",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "refine_analysis"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "REFINE"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "244cd331-efdc-4e0e-b267-f51d8a6c6f3d",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "analyze_text"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "ANALYZE_TEXT"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "97856224-76ac-4a6d-8719-a5401d6d9ff1",
                    "operator": {
                      "name": "filter.operator.equals",
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "process_pdf"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "PDF_PROCESS"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "ee513a67-e199-41c2-a76f-31928070d298",
      "name": "Route2",
      "type": "n8n-nodes-base.switch",
      "position": [
        -2768,
        13344
      ],
      "typeVersion": 3.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// CONFIG v8.5 PRO - Professional style localization + PDF SUPPORT\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst input = $input.first().json;\nconst lang = (input.lang || 'EN').toUpperCase();\nconst chatId = String(input.chatId);\nconst sd = $getWorkflowStaticData('global');\n\nconst LANGS = {\n  'DE': { \n    fallback_start: 'Dr√ºcken Sie /start um zu beginnen', \n    rooms: 'R√§ume', works_identified: 'Positionen', general: 'Allgemein', no_works: 'Keine Arbeiten', items: 'Positionen', min: 'Min', \n    db: 'DE_BERLIN_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'German', flag: 'üá©üá™', native: 'Deutsch', cur: 'EUR', sym: '‚Ç¨', loc: 'de-DE', region: 'Berlin', search_lang: 'German',\n    // Professional welcome with PDF support\n    ok: '‚úÖ *Deutsch* ¬∑ Berlin ¬∑ EUR',\n    photo: `*Foto, PDF oder Beschreibung senden*\n\nüìÑ *PDF-Zeichnungen* ‚Äî Grundriss oder Bauplan (max. 3 Seiten)\nüì∑ *Foto* ‚Äî Raum oder Objekt fotografieren\n‚úèÔ∏è *Text* ‚Äî Arbeiten als Liste beschreiben\n\n_Beispiel zum Kopieren:_\n\\`\\`\\`\nGipskarton 2-lagig Metallprofil CW75 25m2\nFliesen Feinsteinzeug 60x60 Bad 15m2\nSpachteln Q3 Decken und Waende 120m2\nElektro Steckdosen UP 20 Stueck\n\\`\\`\\`\n\nOder Foto/PDF senden üì∑üìÑ`,\n    // PDF specific\n    pdf_received: 'üìÑ *PDF erhalten*',\n    pdf_processing: '‚è≥ Analysiere Zeichnung...',\n    pdf_pages: 'Seiten',\n    pdf_page_limit: '‚ö†Ô∏è Nur erste 3 Seiten werden verarbeitet',\n    pdf_rooms_found: 'üè† R√§ume gefunden',\n    pdf_elements_found: 'üß± Elemente gefunden',\n    pdf_works_generated: 'üìù Arbeiten generiert',\n    pdf_analyzing_page: 'üîç Analysiere Seite',\n    pdf_of: 'von',\n    pdf_complete: '‚úÖ Analyse abgeschlossen',\n    pdf_error: '‚ùå PDF-Verarbeitungsfehler',\n    // Rest of translations\n    photo_added: '‚úÖ Foto hinzugef√ºgt',\n    photos_count: 'Fotos',\n    add_more: '+ Weitere Fotos',\n    analyze_now: '‚ñ∂ Analyse starten',\n    analyzing: 'Bildanalyse l√§uft...',\n    found: '*Erkannte Leistungen:*',\n    edit_hint: 'Zur Bearbeitung antippen',\n    calc: 'Preisermittlung',\n    ready: '*KOSTENVORANSCHLAG*',\n    total: 'GESAMT',\n    days: 'Tage',\n    pct: 'Trefferquote',\n    workers: 'Lohn',\n    machines: 'Ger√§te',\n    materials: 'Material',\n    subtotal: 'Zusammenfassung',\n    searching: 'Suche',\n    of: 'von',\n    not_found: 'Keine √úbereinstimmung',\n    low_conf: 'Pr√ºfung empfohlen',\n    price_note: 'Preisbasis: Berlin 2025',\n    btn_calc: '‚ñ∂ Berechnen',\n    btn_new: '+ Neues Projekt',\n    btn_lang: '‚öô Sprache',\n    btn_edit: '‚úé √Ñndern',\n    btn_delete: '‚úï Entfernen',\n    btn_add_work: '+ Position',\n    btn_done: '‚úÖ Fertig',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª Neu starten',\n    btn_help: '? Hilfe',\n    loading: 'Preisermittlung l√§uft...',\n    more_in_html: 'Detaillierter Bericht verf√ºgbar',\n    resources: 'Details: Ressourcen & Leistungsumfang',\n    enter_work: '*Neue Position hinzuf√ºgen*\\nFormat: Bezeichnung, Menge Einheit\\nBeispiel: Gipskartonwand, 15 m¬≤',\n    work_added: '‚úÖ Position hinzugef√ºgt',\n    what_next: '*Weitere Optionen:*',\n    categories: 'Kategorien',\n    cat_demolition: 'Abbruch',\n    cat_rough: 'Rohbau',\n    cat_finishing: 'Ausbau',\n    cat_mep: 'TGA',\n    help_title: '*Benutzerhandbuch*',\n    help_text: `*Benutzerhandbuch*\n\n*1. Dokumentation*\nSenden Sie Fotos, PDF-Pl√§ne oder Beschreibung.\nPDF: max. 3 Seiten werden analysiert.\n\n*2. Pr√ºfung*\n√úberpr√ºfen Sie die erkannten Leistungen.\n\n*3. Kalkulation*\nPreisermittlung aus DDC CWICR Datenbank.\n\n*4. Export*\nErgebnisse als Excel oder PDF.\n\n*Befehle:*\n/start ‚Äî Neues Projekt\n/help ‚Äî Diese Hilfe`,\n    doc_title: 'KOSTENVORANSCHLAG',\n    col_pos: 'Pos', col_code: 'Kennziffer', col_desc: 'Bezeichnung', col_unit: 'Einh.', col_qty: 'Menge', col_price: 'EP', col_total: 'GP', col_labor: 'Std', col_quality: 'Q',\n    grand_total: 'GESAMTSUMME', labor_cost: 'Lohnkosten', material_cost: 'Materialkosten', labor_days: 'Arbeitstage',\n    kpi_total: 'Gesamtkosten', kpi_hours: 'Arbeitsstunden', kpi_days: 'Arbeitstage',\n    chart_cost_structure: 'Kostenstruktur', chart_labor: 'Lohn', chart_material: 'Material', chart_machines: 'Ger√§te',\n    res_labor: 'Lohn', res_material: 'Mat', res_machine: 'Ger',\n    collapse_all: 'Alle einklappen', expand_all: 'Alle ausklappen',\n    quality_high: 'Hohe √úbereinstimmung', quality_medium: 'Mittlere √úbereinstimmung', quality_low: 'Geringe √úbereinstimmung',\n    export_excel_msg: 'Excel-Export (CSV)', export_pdf_msg: 'PDF-Export', btn_refine: 'Genauer analysieren', found_pct: 'gefunden', more_resources: 'weitere', kpi_items: 'Positionen', scope_title: 'Leistungsumfang', show_scope: 'Leistungen anzeigen'\n  },\n\n  'EN': { \n    fallback_start: 'Use /start to begin', \n    rooms: '–∫–æ–º–Ω–∞—Ç', works_identified: 'works', general: '–û–±—â–µ–µ', no_works: '–†–∞–±–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', items: '–ø–æ–∑–∏—Ü–∏–π', min: '–º–∏–Ω', \n    db: 'ENG_TORONTO_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'English', flag: 'üá¨üáß', native: 'English', cur: 'CAD', sym: '$', loc: 'en-CA', region: 'Toronto', search_lang: 'English',\n    ok: '‚úÖ *English* ¬∑ Toronto ¬∑ CAD',\n    photo: `*Send photo, PDF or description*\n\nüìÑ *PDF drawings* ‚Äî floor plan or blueprint (max 3 pages)\nüì∑ *Photo* ‚Äî photograph room or object\n‚úèÔ∏è *Text* ‚Äî describe work as a list\n\n_Example to copy:_\n\\`\\`\\`\nDrywall 2-layer metal stud CW75 25m2\nPorcelain tiles 60x60 bathroom 15m2\nPlastering level 3 ceiling walls 120m2\nElectrical outlets flush mount 20 pcs\n\\`\\`\\`\n\nOr send photo/PDF üì∑üìÑ`,\n    // PDF specific\n    pdf_received: 'üìÑ *PDF received*',\n    pdf_processing: '‚è≥ Analyzing drawing...',\n    pdf_pages: 'pages',\n    pdf_page_limit: '‚ö†Ô∏è Processing first 3 pages only',\n    pdf_rooms_found: 'üè† Rooms found',\n    pdf_elements_found: 'üß± Elements found',\n    pdf_works_generated: 'üìù Works generated',\n    pdf_analyzing_page: 'üîç Analyzing page',\n    pdf_of: 'of',\n    pdf_complete: '‚úÖ Analysis complete',\n    pdf_error: '‚ùå PDF processing error',\n    // Rest\n    photo_added: '‚úÖ Photo added',\n    photos_count: 'photos',\n    add_more: '+ Add more',\n    analyze_now: '‚ñ∂ Start analysis',\n    analyzing: 'Analyzing images...',\n    found: '*Identified Work Items:*',\n    edit_hint: 'Tap to edit',\n    calc: 'Pricing lookup',\n    ready: '*COST ESTIMATE*',\n    total: 'TOTAL',\n    days: 'days',\n    pct: 'Match rate',\n    workers: 'Labor',\n    machines: 'Equipment',\n    materials: 'Materials',\n    subtotal: 'Summary',\n    searching: 'Searching',\n    of: 'of',\n    not_found: 'No match found',\n    low_conf: 'Review recommended',\n    price_note: 'Price basis: Toronto 2025',\n    btn_calc: '‚ñ∂ Calculate',\n    btn_new: '+ New Project',\n    btn_lang: '‚öô Language',\n    btn_edit: '‚úé Edit',\n    btn_delete: '‚úï Remove',\n    btn_add_work: '+ Add Item',\n    btn_done: '‚úÖ Done',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª Start Over',\n    btn_help: '? Help',\n    loading: 'Calculating prices...',\n    more_in_html: 'Detailed report available',\n    resources: 'Details: Resources & Scope of Work',\n    enter_work: '*Add New Item*\\nFormat: Description, Quantity Unit\\nExample: Drywall installation, 15 m¬≤',\n    work_added: '‚úÖ Item added',\n    what_next: '*Options:*',\n    categories: 'Categories',\n    cat_demolition: 'Demolition',\n    cat_rough: 'Structure',\n    cat_finishing: 'Finishes',\n    cat_mep: 'MEP',\n    help_title: '*User Guide*',\n    help_text: `*User Guide*\n\n*1. Documentation*\nSend photos, PDF plans or description.\nPDF: max 3 pages will be analyzed.\n\n*2. Review*\nCheck identified work items.\n\n*3. –†–∞—Å—á—ë—Ç*\nPricing from DDC CWICR database.\n\n*4. Export*\nExport as Excel or PDF.\n\n*Commands:*\n/start ‚Äî New project\n/help ‚Äî This guide`,\n    doc_title: 'COST ESTIMATE',\n    col_pos: 'No', col_code: 'Code', col_desc: 'Description', col_unit: 'Unit', col_qty: 'Qty', col_price: 'Rate', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'GRAND TOTAL', labor_cost: 'Labor Cost', material_cost: 'Material Cost', labor_days: 'Work Days',\n    kpi_total: 'Total Cost', kpi_hours: 'Work Hours', kpi_days: 'Work Days',\n    chart_cost_structure: 'Cost Structure', chart_labor: 'Labor', chart_material: 'Material', chart_machines: 'Equipment',\n    res_labor: 'Labor', res_material: 'Mat', res_machine: 'Equip',\n    collapse_all: 'Collapse all', expand_all: 'Expand all',\n    quality_high: 'High confidence', quality_medium: 'Medium confidence', quality_low: 'Low confidence',\n    export_excel_msg: 'Excel Export (CSV)', export_pdf_msg: 'PDF Export', btn_refine: 'Refine Analysis', found_pct: 'found', more_resources: 'more', kpi_items: 'Items', scope_title: 'Scope of Work', show_scope: 'Show scope'\n  },\n\n  'RU': { \n    fallback_start: '–ù–∞–∂–º–∏—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞', \n    rooms: '–∫–æ–º–Ω–∞—Ç', works_identified: '–ø–æ–∑–∏—Ü–∏–π', general: '–û–±—â–µ–µ', no_works: '–†–∞–±–æ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', items: '–ø–æ–∑–∏—Ü–∏–π', min: '–º–∏–Ω', \n    db: 'RU_STPETERSBURG_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Russian', flag: 'üá∑üá∫', native: '–†—É—Å—Å–∫–∏–π', cur: 'RUB', sym: '‚ÇΩ', loc: 'ru-RU', region: '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥', search_lang: 'Russian',\n    ok: '‚úÖ *–†—É—Å—Å–∫–∏–π* ¬∑ –°–ü–± ¬∑ RUB',\n    photo: `*–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ, PDF –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ*\n\nüìÑ *PDF —á–µ—Ä—Ç–µ–∂–∏* ‚Äî –ø–ª–∞–Ω —ç—Ç–∞–∂–∞ –∏–ª–∏ —á–µ—Ä—Ç—ë–∂ (–¥–æ 3 —Å—Ç—Ä.)\nüì∑ *–§–æ—Ç–æ* ‚Äî —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –ø–æ–º–µ—â–µ–Ω–∏–µ\n‚úèÔ∏è *–¢–µ–∫—Å—Ç* ‚Äî –æ–ø–∏—à–∏—Ç–µ —Ä–∞–±–æ—Ç—ã —Å–ø–∏—Å–∫–æ–º\n\n_–ü—Ä–∏–º–µ—Ä –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:_\n\\`\\`\\`\n–ì–∏–ø—Å–æ–∫–∞—Ä—Ç–æ–Ω 2 —Å–ª–æ—è –ø—Ä–æ—Ñ–∏–ª—å –ü–ü60 25–º2\n–ü–ª–∏—Ç–∫–∞ –∫–µ—Ä–∞–º–æ–≥—Ä–∞–Ω–∏—Ç 60x60 –≤–∞–Ω–Ω–∞—è 15–º2\n–®–ø–∞–∫–ª–µ–≤–∫–∞ –ø–æ–¥ –ø–æ–∫—Ä–∞—Å–∫—É –ø–æ—Ç–æ–ª–∫–∏ —Å—Ç–µ–Ω—ã 120–º2\n–†–æ–∑–µ—Ç–∫–∏ —Å–∫—Ä—ã—Ç—ã–π –º–æ–Ω—Ç–∞–∂ 20—à—Ç\n\\`\\`\\`\n\n–ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ/PDF üì∑üìÑ`,\n    // PDF specific\n    pdf_received: 'üìÑ *PDF –ø–æ–ª—É—á–µ–Ω*',\n    pdf_processing: '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —á–µ—Ä—Ç—ë–∂...',\n    pdf_pages: '—Å—Ç—Ä.',\n    pdf_page_limit: '‚ö†Ô∏è –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –ø–µ—Ä–≤—ã–µ 3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã',\n    pdf_rooms_found: 'üè† –ù–∞–π–¥–µ–Ω–æ –ø–æ–º–µ—â–µ–Ω–∏–π',\n    pdf_elements_found: 'üß± –ù–∞–π–¥–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤',\n    pdf_works_generated: 'üìù –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ —Ä–∞–±–æ—Ç',\n    pdf_analyzing_page: '–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É',\n    pdf_of: '–∏–∑',\n    pdf_complete: '‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω',\n    pdf_error: '‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ PDF',\n    // Rest\n    photo_added: '‚úÖ –§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ',\n    photos_count: '—Ñ–æ—Ç–æ',\n    add_more: '+ –ï—â—ë —Ñ–æ—Ç–æ',\n    analyze_now: '‚ñ∂ –ù–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑',\n    analyzing: '–ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...',\n    found: '*–û–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã:*',\n    edit_hint: '–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è',\n    calc: '–ü–æ–∏—Å–∫ —Ä–∞—Å—Ü–µ–Ω–æ–∫',\n    ready: '*–°–ú–ï–¢–ê*',\n    total: '–ò–¢–û–ì–û',\n    days: '–¥–Ω.',\n    pct: '–¢–æ—á–Ω–æ—Å—Ç—å',\n    workers: '–¢—Ä—É–¥',\n    machines: '–ú–µ—Ö–∞–Ω–∏–∑–º—ã',\n    materials: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã',\n    subtotal: '–°–≤–æ–¥–∫–∞',\n    searching: '–ü–æ–∏—Å–∫',\n    of: '–∏–∑',\n    not_found: '–ù–µ –Ω–∞–π–¥–µ–Ω–æ',\n    low_conf: '–¢—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏',\n    price_note: '–ë–∞–∑–∞ —Ü–µ–Ω: –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ 2025',\n    btn_calc: '‚ñ∂ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å',\n    btn_new: '+ –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç',\n    btn_lang: '‚öô –Ø–∑—ã–∫',\n    btn_edit: '‚úé –ò–∑–º–µ–Ω–∏—Ç—å',\n    btn_delete: '‚úï –£–¥–∞–ª–∏—Ç—å',\n    btn_add_work: '+ –ü–æ–∑–∏—Ü–∏—è',\n    btn_done: '‚úÖ –ì–æ—Ç–æ–≤–æ',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª –ó–∞–Ω–æ–≤–æ',\n    btn_help: '? –°–ø—Ä–∞–≤–∫–∞',\n    loading: '–†–∞—Å—á—ë—Ç...',\n    more_in_html: '–ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á—ë—Ç –¥–æ—Å—Ç—É–ø–µ–Ω',\n    resources: '–ü–æ–¥—Ä–æ–±–Ω–µ–µ: —Ä–µ—Å—É—Ä—Å—ã –∏ —Å–æ—Å—Ç–∞–≤—ã —Ä–∞–±–æ—Ç',\n    enter_work: '*–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é*\\n–§–æ—Ä–º–∞—Ç: –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ, –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ï–¥–∏–Ω–∏—Ü–∞\\n–ü—Ä–∏–º–µ—Ä: –ú–æ–Ω—Ç–∞–∂ –ì–ö–õ, 15 –º¬≤',\n    work_added: '‚úÖ –ü–æ–∑–∏—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞',\n    what_next: '*–î–µ–π—Å—Ç–≤–∏—è:*',\n    categories: '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏',\n    cat_demolition: '–î–µ–º–æ–Ω—Ç–∞–∂',\n    cat_rough: '–ß–µ—Ä–Ω–æ–≤—ã–µ',\n    cat_finishing: '–û—Ç–¥–µ–ª–∫–∞',\n    cat_mep: '–ò–Ω–∂–µ–Ω–µ—Ä–∏—è',\n    help_title: '*–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ*',\n    help_text: `*–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è*\n\n*1. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è*\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ, PDF-–ø–ª–∞–Ω –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏–µ.\nPDF: –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é—Ç—Å—è –¥–æ 3 —Å—Ç—Ä–∞–Ω–∏—Ü.\n\n*2. –ü—Ä–æ–≤–µ—Ä–∫–∞*\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã.\n\n*3. –†–∞—Å—á—ë—Ç*\n–¶–µ–Ω—ã –∏–∑ –±–∞–∑—ã DDC CWICR.\n\n*4. –≠–∫—Å–ø–æ—Ä—Ç*\n–í—ã–≥—Ä—É–∑–∫–∞ –≤ Excel –∏–ª–∏ PDF.\n\n*–ö–æ–º–∞–Ω–¥—ã:*\n/start ‚Äî –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç\n/help ‚Äî –°–ø—Ä–∞–≤–∫–∞`,\n    doc_title: '–°–ú–ï–¢–ê',\n    col_pos: '‚Ññ', col_code: '–®–∏—Ñ—Ä', col_desc: '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ', col_unit: '–ï–¥.', col_qty: '–ö–æ–ª.', col_price: '–¶–µ–Ω–∞', col_total: '–°—É–º–º–∞', col_labor: '–ß/—á', col_quality: '–ö',\n    grand_total: '–í–°–ï–ì–û', labor_cost: '–§–û–¢', material_cost: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã', labor_days: '–î–Ω–µ–π',\n    kpi_total: '–°—Ç–æ–∏–º–æ—Å—Ç—å', kpi_hours: '–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã', kpi_days: '–°—Ä–æ–∫',\n    chart_cost_structure: '–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞—Ç—Ä–∞—Ç', chart_labor: '–¢—Ä—É–¥', chart_material: '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã', chart_machines: '–ú–µ—Ö–∞–Ω–∏–∑–º—ã',\n    res_labor: '–¢—Ä—É–¥', res_material: '–ú–∞—Ç', res_machine: '–ú–µ—Ö',\n    collapse_all: '–°–≤–µ—Ä–Ω—É—Ç—å', expand_all: '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å',\n    quality_high: '–í—ã—Å–æ–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å', quality_medium: '–°—Ä–µ–¥–Ω—è—è —Ç–æ—á–Ω–æ—Å—Ç—å', quality_low: '–ù–∏–∑–∫–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å',\n    export_excel_msg: '–≠–∫—Å–ø–æ—Ä—Ç Excel (CSV)', export_pdf_msg: '–≠–∫—Å–ø–æ—Ä—Ç PDF', btn_refine: '–£—Ç–æ—á–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑', found_pct: '–Ω–∞–π–¥–µ–Ω–æ', more_resources: '–µ—â—ë', kpi_items: '–ü–æ–∑–∏—Ü–∏–∏', scope_title: '–°–æ—Å—Ç–∞–≤ —Ä–∞–±–æ—Ç', show_scope: '–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ—Å—Ç–∞–≤'\n  },\n\n  'ES': { \n    fallback_start: 'Pulse /start para comenzar', \n    rooms: 'habitaciones', works_identified: 'trabajos', general: '–û–±—â–µ–µ', no_works: 'Sin trabajos', items: 'elementos', min: '–º–∏–Ω', \n    db: 'ES_BARCELONA_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Spanish', flag: 'üá™üá∏', native: 'Espa√±ol', cur: 'EUR', sym: '‚Ç¨', loc: 'es-ES', region: 'Barcelona', search_lang: 'Spanish',\n    ok: '‚úÖ *Espa√±ol* ¬∑ Barcelona ¬∑ EUR',\n    photo: `*Env√≠e foto, PDF o descripci√≥n*\n\nüìÑ *Planos PDF* ‚Äî plano de planta o dibujo (m√°x. 3 p√°gs.)\nüì∑ *Foto* ‚Äî fotograf√≠e el espacio\n‚úèÔ∏è *Texto* ‚Äî describa trabajos en lista\n\n_Ejemplo para copiar:_\n\\`\\`\\`\nPladur 2 capas perfil met√°lico 25m2\nAzulejos porcel√°nico 60x60 ba√±o 15m2\nAlisado para pintura techos paredes 120m2\nEnchufes empotrados 20uds\n\\`\\`\\`\n\nO env√≠e foto/PDF üì∑üìÑ`,\n    pdf_received: 'üìÑ *PDF recibido*',\n    pdf_processing: '‚è≥ Analizando plano...',\n    pdf_pages: 'p√°ginas',\n    pdf_page_limit: '‚ö†Ô∏è Solo se procesan las primeras 3 p√°ginas',\n    pdf_rooms_found: 'üè† Habitaciones encontradas',\n    pdf_elements_found: 'üß± Elementos encontrados',\n    pdf_works_generated: 'üìù Trabajos generados',\n    pdf_analyzing_page: 'üîç Analizando p√°gina',\n    pdf_of: 'de',\n    pdf_complete: '‚úÖ An√°lisis completado',\n    pdf_error: '‚ùå Error al procesar PDF',\n    photo_added: '‚úÖ Foto a√±adida',\n    photos_count: 'fotos',\n    add_more: '+ M√°s fotos',\n    analyze_now: '‚ñ∂ Analizar',\n    analyzing: 'Analizando...',\n    found: '*Trabajos identificados:*',\n    edit_hint: 'Toque para editar',\n    calc: 'B√∫squeda de precios',\n    ready: '*PRESUPUESTO*',\n    total: 'TOTAL',\n    days: 'd√≠as',\n    pct: 'Precisi√≥n',\n    workers: 'M.O.',\n    machines: 'Equipos',\n    materials: 'Materiales',\n    subtotal: 'Resumen',\n    searching: 'Buscando',\n    of: 'de',\n    not_found: 'Sin coincidencia',\n    low_conf: 'Revisar',\n    price_note: 'Base: Barcelona 2025',\n    btn_calc: '‚ñ∂ Calcular',\n    btn_new: '+ Nuevo',\n    btn_lang: '‚öô Idioma',\n    btn_edit: '‚úé Editar',\n    btn_delete: '‚úï Eliminar',\n    btn_add_work: '+ Partida',\n    btn_done: '‚úÖ Listo',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª Reiniciar',\n    btn_help: '? Ayuda',\n    loading: 'Calculando...',\n    more_in_html: 'Informe detallado disponible',\n    resources: 'Detalles: recursos y alcance',\n    enter_work: '*A√±adir partida*\\nFormato: Descripci√≥n, Cantidad Unidad',\n    work_added: '‚úÖ A√±adido',\n    what_next: '*Opciones:*',\n    categories: 'Categor√≠as',\n    cat_demolition: 'Demolici√≥n',\n    cat_rough: 'Estructura',\n    cat_finishing: 'Acabados',\n    cat_mep: 'Instalaciones',\n    help_title: '*Gu√≠a*',\n    help_text: `*Gu√≠a de uso*\n\n*1.* Env√≠e fotos, PDF o descripci√≥n\nPDF: m√°x. 3 p√°ginas\n*2.* Revise los trabajos\n*3.* Calcule precios\n*4.* Exporte\n\n/start ‚Äî Nuevo\n/help ‚Äî Ayuda`,\n    doc_title: 'PRESUPUESTO',\n    col_pos: 'N¬∫', col_code: 'C√≥digo', col_desc: 'Descripci√≥n', col_unit: 'Ud', col_qty: 'Cant', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'TOTAL', labor_cost: 'M.O.', material_cost: 'Materiales', labor_days: 'D√≠as',\n    kpi_total: 'Coste Total', kpi_hours: 'Horas', kpi_days: 'D√≠as',\n    chart_cost_structure: 'Estructura', chart_labor: 'M.O.', chart_material: 'Mat', chart_machines: 'Eq',\n    res_labor: 'MO', res_material: 'Mat', res_machine: 'Eq',\n    collapse_all: 'Contraer', expand_all: 'Expandir',\n    quality_high: 'Alta', quality_medium: 'Media', quality_low: 'Baja',\n    export_excel_msg: 'Exportar Excel', export_pdf_msg: 'Exportar PDF', btn_refine: 'Refinar', found_pct: 'encontrado', more_resources: 'm√°s', kpi_items: 'Art√≠culos', scope_title: 'Alcance', show_scope: 'Ver alcance'\n  },\n\n  'FR': { \n    fallback_start: 'Appuyez sur /start pour commencer', \n    rooms: 'pi√®ces', works_identified: 'travaux', general: 'G√©n√©ral', no_works: 'Aucun travail', items: '√©l√©ments', min: '–º–∏–Ω', \n    db: 'FR_PARIS_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'French', flag: 'üá´üá∑', native: 'Fran√ßais', cur: 'EUR', sym: '‚Ç¨', loc: 'fr-FR', region: 'Paris', search_lang: 'French',\n    ok: '‚úÖ *Fran√ßais* ¬∑ Paris ¬∑ EUR',\n    photo: `*Envoyez photo, PDF ou description*\n\nüìÑ *Plans PDF* ‚Äî plan d'√©tage ou dessin (max 3 pages)\nüì∑ *Photo* ‚Äî photographiez l'espace\n‚úèÔ∏è *Texte* ‚Äî d√©crivez les travaux en liste\n\n_Exemple √† copier:_\n\\`\\`\\`\nPlaco 2 couches ossature m√©tallique 25m2\nCarrelage gr√®s c√©rame 60x60 sdb 15m2\nEnduit plafonds murs 120m2\nPrises encastr√©es 20pcs\n\\`\\`\\`\n\nOu envoyez photo/PDF üì∑üìÑ`,\n    pdf_received: 'üìÑ *PDF re√ßu*',\n    pdf_processing: '‚è≥ Analyse du plan...',\n    pdf_pages: 'pages',\n    pdf_page_limit: '‚ö†Ô∏è Seules les 3 premi√®res pages sont trait√©es',\n    pdf_rooms_found: 'üè† Pi√®ces trouv√©es',\n    pdf_elements_found: 'üß± √âl√©ments trouv√©s',\n    pdf_works_generated: 'üìù Travaux g√©n√©r√©s',\n    pdf_analyzing_page: 'üîç Analyse de la page',\n    pdf_of: 'sur',\n    pdf_complete: '‚úÖ Analyse termin√©e',\n    pdf_error: '‚ùå Erreur de traitement PDF',\n    photo_added: '‚úÖ Photo ajout√©e',\n    photos_count: 'photos',\n    add_more: '+ Autres photos',\n    analyze_now: '‚ñ∂ Analyser',\n    analyzing: 'Analyse en cours...',\n    found: '*Ouvrages identifi√©s:*',\n    edit_hint: 'Appuyez pour modifier',\n    calc: 'Recherche des prix',\n    ready: '*DEVIS*',\n    total: 'TOTAL',\n    days: 'jours',\n    pct: 'Pr√©cision',\n    workers: 'M.O.',\n    machines: 'Mat√©riel',\n    materials: 'Mat√©riaux',\n    subtotal: 'R√©sum√©',\n    searching: 'Recherche',\n    of: 'sur',\n    not_found: 'Non trouv√©',\n    low_conf: '√Ä v√©rifier',\n    price_note: 'Base: Paris 2025',\n    btn_calc: '‚ñ∂ Calculer',\n    btn_new: '+ Nouveau',\n    btn_lang: '‚öô Langue',\n    btn_edit: '‚úé Modifier',\n    btn_delete: '‚úï Supprimer',\n    btn_add_work: '+ Ouvrage',\n    btn_done: '‚úÖ Termin√©',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª Recommencer',\n    btn_help: '? Aide',\n    loading: 'Calcul en cours...',\n    more_in_html: 'Rapport d√©taill√© disponible',\n    resources: 'D√©tails: ressources et description',\n    enter_work: '*Ajouter ouvrage*\\nFormat: Description, Quantit√© Unit√©',\n    work_added: '‚úÖ Ajout√©',\n    what_next: '*Options:*',\n    categories: 'Cat√©gories',\n    cat_demolition: 'D√©molition',\n    cat_rough: 'Gros ≈ìuvre',\n    cat_finishing: 'Finitions',\n    cat_mep: 'CVC',\n    help_title: '*Guide*',\n    help_text: `*Guide d'utilisation*\n\n*1.* Envoyez photos, PDF ou description\nPDF: max 3 pages\n*2.* V√©rifiez les ouvrages\n*3.* Calculez les prix\n*4.* Exportez\n\n/start ‚Äî Nouveau\n/help ‚Äî Aide`,\n    doc_title: 'DEVIS',\n    col_pos: 'N¬∞', col_code: 'Code', col_desc: 'D√©signation', col_unit: 'U', col_qty: 'Qt√©', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'TOTAL', labor_cost: 'M.O.', material_cost: 'Mat√©riaux', labor_days: 'Jours',\n    kpi_total: 'Co√ªt Total', kpi_hours: 'Heures', kpi_days: 'Jours',\n    chart_cost_structure: 'Structure', chart_labor: 'M.O.', chart_material: 'Mat', chart_machines: '√âq',\n    res_labor: 'MO', res_material: 'Mat', res_machine: '√âq',\n    collapse_all: 'R√©duire', expand_all: 'D√©velopper',\n    quality_high: 'Haute', quality_medium: 'Moyenne', quality_low: 'Faible',\n    export_excel_msg: 'Export Excel', export_pdf_msg: 'Export PDF', btn_refine: 'Affiner', found_pct: 'trouv√©', more_resources: 'plus', kpi_items: 'Articles', scope_title: 'Description', show_scope: 'Voir description'\n  },\n\n  'PT': { \n    fallback_start: 'Pressione /start para come√ßar', \n    rooms: 'quartos', works_identified: 'trabalhos', general: 'Geral', no_works: 'Sem trabalhos', items: 'itens', min: '–º–∏–Ω', \n    db: 'PT_SAOPAULO_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Portuguese', flag: 'üáßüá∑', native: 'Portugu√™s', cur: 'BRL', sym: 'R$', loc: 'pt-BR', region: 'S√£o Paulo', search_lang: 'Portuguese',\n    ok: '‚úÖ *Portugu√™s* ¬∑ S√£o Paulo ¬∑ BRL',\n    photo: `*Envie foto, PDF ou descri√ß√£o*\n\nüìÑ *Plantas PDF* ‚Äî planta baixa ou desenho (m√°x. 3 p√°gs.)\nüì∑ *Foto* ‚Äî fotografe o ambiente\n‚úèÔ∏è *Texto* ‚Äî descreva os trabalhos em lista\n\n_Exemplo para copiar:_\n\\`\\`\\`\nDrywall 2 camadas perfil met√°lico 25m2\nPorcelanato 60x60 banheiro 15m2\nMassa corrida teto paredes 120m2\nTomadas embutidas 20un\n\\`\\`\\`\n\nOu envie foto/PDF üì∑üìÑ`,\n    pdf_received: 'üìÑ *PDF recebido*',\n    pdf_processing: '‚è≥ Analisando planta...',\n    pdf_pages: 'p√°ginas',\n    pdf_page_limit: '‚ö†Ô∏è Processando apenas as 3 primeiras p√°ginas',\n    pdf_rooms_found: 'üè† C√¥modos encontrados',\n    pdf_elements_found: 'üß± Elementos encontrados',\n    pdf_works_generated: 'üìù Trabalhos gerados',\n    pdf_analyzing_page: 'üîç Analisando p√°gina',\n    pdf_of: 'de',\n    pdf_complete: '‚úÖ An√°lise conclu√≠da',\n    pdf_error: '‚ùå Erro ao processar PDF',\n    photo_added: '‚úÖ Foto adicionada',\n    photos_count: 'fotos',\n    add_more: '+ Mais fotos',\n    analyze_now: '‚ñ∂ Analisar',\n    analyzing: 'Analisando...',\n    found: '*Servi√ßos identificados:*',\n    edit_hint: 'Toque para editar',\n    calc: 'Busca de pre√ßos',\n    ready: '*OR√áAMENTO*',\n    total: 'TOTAL',\n    days: 'dias',\n    pct: 'Precis√£o',\n    workers: 'M.O.',\n    machines: 'Equipamentos',\n    materials: 'Materiais',\n    subtotal: 'Resumo',\n    searching: 'Buscando',\n    of: 'de',\n    not_found: 'N√£o encontrado',\n    low_conf: 'Verificar',\n    price_note: 'Base: S√£o Paulo 2025',\n    btn_calc: '‚ñ∂ Calcular',\n    btn_new: '+ Novo',\n    btn_lang: '‚öô Idioma',\n    btn_edit: '‚úé Editar',\n    btn_delete: '‚úï Excluir',\n    btn_add_work: '+ Servi√ßo',\n    btn_done: '‚úÖ Pronto',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª Recome√ßar',\n    btn_help: '? Ajuda',\n    loading: 'Calculando...',\n    more_in_html: 'Relat√≥rio detalhado dispon√≠vel',\n    resources: 'Detalhes: recursos e escopo',\n    enter_work: '*Adicionar servi√ßo*\\nFormato: Descri√ß√£o, Quantidade Unidade',\n    work_added: '‚úÖ Adicionado',\n    what_next: '*Op√ß√µes:*',\n    categories: 'Categorias',\n    cat_demolition: 'Demoli√ß√£o',\n    cat_rough: 'Estrutura',\n    cat_finishing: 'Acabamento',\n    cat_mep: 'Instala√ß√µes',\n    help_title: '*Guia*',\n    help_text: `*Guia de uso*\n\n*1.* Envie fotos, PDF ou descri√ß√£o\nPDF: m√°x. 3 p√°ginas\n*2.* Revise os servi√ßos\n*3.* Calcule pre√ßos\n*4.* Exporte\n\n/start ‚Äî Novo\n/help ‚Äî Ajuda`,\n    doc_title: 'OR√áAMENTO',\n    col_pos: 'N¬∫', col_code: 'C√≥digo', col_desc: 'Descri√ß√£o', col_unit: 'Un', col_qty: 'Qtd', col_price: 'P.U.', col_total: 'Total', col_labor: 'Hrs', col_quality: 'Q',\n    grand_total: 'TOTAL', labor_cost: 'M.O.', material_cost: 'Materiais', labor_days: 'Dias',\n    kpi_total: 'Custo Total', kpi_hours: 'Horas', kpi_days: 'Dias',\n    chart_cost_structure: 'Estrutura', chart_labor: 'M.O.', chart_material: 'Mat', chart_machines: 'Eq',\n    res_labor: 'MO', res_material: 'Mat', res_machine: 'Eq',\n    collapse_all: 'Recolher', expand_all: 'Expandir',\n    quality_high: 'Alta', quality_medium: 'M√©dia', quality_low: 'Baixa',\n    export_excel_msg: 'Exportar Excel', export_pdf_msg: 'Exportar PDF', btn_refine: 'Refinar', found_pct: 'encontrado', more_resources: 'mais', kpi_items: 'Itens', scope_title: 'Escopo', show_scope: 'Ver escopo'\n  },\n\n  'ZH': { \n    db: 'ZH_SHANGHAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Chinese', flag: 'üá®üá≥', native: '‰∏≠Êñá', cur: 'CNY', sym: '¬•', loc: 'zh-CN', region: '‰∏äÊµ∑', search_lang: 'Chinese',\n    ok: '‚úÖ *‰∏≠Êñá* ¬∑ ‰∏äÊµ∑ ¬∑ CNY',\n    photo: `*ÂèëÈÄÅÁÖßÁâá„ÄÅPDFÊàñÊèèËø∞*\n\nüìÑ *PDFÂõæÁ∫∏* ‚Äî Âπ≥Èù¢ÂõæÊàñÂõæÁ∫∏ÔºàÊúÄÂ§ö3È°µÔºâ\nüì∑ *ÁÖßÁâá* ‚Äî ÊãçÊëÑÊàøÈó¥ÊàñÁâ©‰Ωì\n‚úèÔ∏è *ÊñáÂ≠ó* ‚Äî ‰ª•ÂàóË°®ÂΩ¢ÂºèÊèèËø∞\n\n_Â§çÂà∂Á§∫‰æãÔºö_\n\\`\\`\\`\nÁü≥ËÜèÊùøÂèåÂ±ÇËΩªÈí¢ÈæôÈ™® 25m2\nÁì∑Á†ñ600x600Âç´ÁîüÈó¥ 15m2\nËÖªÂ≠êÊâæÂπ≥È°∂Â¢ô 120m2\nÊöóË£ÖÊèíÂ∫ß 20‰∏™\n\\`\\`\\`\n\nÊàñÂèëÈÄÅÁÖßÁâá/PDF üì∑üìÑ`,\n    pdf_received: 'üìÑ *Â∑≤Êî∂Âà∞PDF*',\n    pdf_processing: '‚è≥ Ê≠£Âú®ÂàÜÊûêÂõæÁ∫∏...',\n    pdf_pages: 'È°µ',\n    pdf_page_limit: '‚ö†Ô∏è ‰ªÖÂ§ÑÁêÜÂâç3È°µ',\n    pdf_rooms_found: 'üè† ÂèëÁé∞ÊàøÈó¥',\n    pdf_elements_found: 'üß± ÂèëÁé∞ÂÖÉÁ¥†',\n    pdf_works_generated: 'üìù Â∑≤ÁîüÊàêÂ∑•‰ΩúÈ°π',\n    pdf_analyzing_page: 'üîç Ê≠£Âú®ÂàÜÊûêÁ¨¨',\n    pdf_of: 'È°µÔºåÂÖ±',\n    pdf_complete: '‚úÖ ÂàÜÊûêÂÆåÊàê',\n    pdf_error: '‚ùå PDFÂ§ÑÁêÜÈîôËØØ',\n    photo_added: '‚úÖ ÁÖßÁâáÂ∑≤Ê∑ªÂä†',\n    photos_count: 'Âº†',\n    add_more: '+ Êõ¥Â§öÁÖßÁâá',\n    analyze_now: '‚ñ∂ ÂºÄÂßãÂàÜÊûê',\n    analyzing: 'ÂàÜÊûê‰∏≠...',\n    found: '*ËØÜÂà´ÁöÑÂ∑•‰ΩúÈ°π:*',\n    edit_hint: 'ÁÇπÂáªÁºñËæë',\n    calc: '‰ª∑Ê†ºÊü•ËØ¢',\n    ready: '*Â∑•Á®ãÈ¢ÑÁÆó*',\n    total: 'ÂêàËÆ°',\n    days: 'Â§©',\n    pct: 'ÂåπÈÖçÁéá',\n    workers: '‰∫∫Â∑•',\n    machines: 'Êú∫Ê¢∞',\n    materials: 'ÊùêÊñô',\n    subtotal: 'ÊëòË¶Å',\n    searching: 'ÊêúÁ¥¢',\n    of: '/',\n    not_found: 'Êú™ÊâæÂà∞',\n    low_conf: 'ÈúÄÊ†∏Êü•',\n    price_note: '‰ª∑Ê†ºÂü∫ÂáÜÔºö‰∏äÊµ∑ 2025',\n    btn_calc: '‚ñ∂ ËÆ°ÁÆó',\n    btn_new: '+ Êñ∞È°πÁõÆ',\n    btn_lang: '‚öô ËØ≠Ë®Ä',\n    btn_edit: '‚úé ÁºñËæë',\n    btn_delete: '‚úï Âà†Èô§',\n    btn_add_work: '+ Ê∑ªÂä†',\n    btn_done: '‚úÖ ÂÆåÊàê',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª ÈáçÊñ∞ÂºÄÂßã',\n    btn_help: '? Â∏ÆÂä©',\n    loading: 'ËÆ°ÁÆó‰∏≠...',\n    more_in_html: 'ËØ¶ÁªÜÊä•ÂëäÂèØÁî®',\n    resources: 'ËØ¶ÊÉÖÔºöËµÑÊ∫êÂíåÂ∑•‰ΩúËåÉÂõ¥',\n    enter_work: '*Ê∑ªÂä†È°πÁõÆ*\\nÊ†ºÂºèÔºöÊèèËø∞ÔºåÊï∞Èáè Âçï‰Ωç',\n    work_added: '‚úÖ Â∑≤Ê∑ªÂä†',\n    what_next: '*ÈÄâÈ°π:*',\n    categories: 'Á±ªÂà´',\n    cat_demolition: 'ÊãÜÈô§',\n    cat_rough: 'ÁªìÊûÑ',\n    cat_finishing: 'Ë£ÖÈ•∞',\n    cat_mep: 'Êú∫Áîµ',\n    help_title: '*ÊåáÂçó*',\n    help_text: `*‰ΩøÁî®ÊåáÂçó*\n\n*1.* ÂèëÈÄÅÁÖßÁâá„ÄÅPDFÊàñÊèèËø∞\nPDFÔºöÊúÄÂ§ö3È°µ\n*2.* Ê£ÄÊü•Â∑•‰ΩúÈ°π\n*3.* ËÆ°ÁÆó‰ª∑Ê†º\n*4.* ÂØºÂá∫\n\n/start ‚Äî Êñ∞È°πÁõÆ\n/help ‚Äî Â∏ÆÂä©`,\n    doc_title: 'È¢ÑÁÆó',\n    col_pos: 'Â∫èÂè∑', col_code: 'ÁºñÁ†Å', col_desc: 'ÂêçÁß∞', col_unit: 'Âçï‰Ωç', col_qty: 'Êï∞Èáè', col_price: 'Âçï‰ª∑', col_total: 'ÂêàËÆ°', col_labor: 'Â∑•Êó∂', col_quality: 'Ë¥®',\n    grand_total: 'ÊÄªËÆ°', labor_cost: '‰∫∫Â∑•Ë¥π', material_cost: 'ÊùêÊñôË¥π', labor_days: 'Â∑•Êúü',\n    kpi_total: 'ÊÄªÊàêÊú¨', kpi_hours: 'Â∑•Êó∂', kpi_days: 'Â∑•Êúü',\n    chart_cost_structure: 'ÊàêÊú¨ÁªìÊûÑ', chart_labor: '‰∫∫Â∑•', chart_material: 'ÊùêÊñô', chart_machines: 'Êú∫Ê¢∞',\n    res_labor: '‰∫∫Â∑•', res_material: 'ÊùêÊñô', res_machine: 'Êú∫Ê¢∞',\n    collapse_all: 'ÊäòÂè†', expand_all: 'Â±ïÂºÄ',\n    quality_high: 'È´ò', quality_medium: '‰∏≠', quality_low: '‰Ωé',\n    export_excel_msg: 'ÂØºÂá∫Excel', export_pdf_msg: 'ÂØºÂá∫PDF', btn_refine: 'Á≤æÁ°ÆÂàÜÊûê', found_pct: 'ÊâæÂà∞', more_resources: 'Êõ¥Â§ö', kpi_items: 'È°πÁõÆ', scope_title: 'Â∑•‰ΩúËåÉÂõ¥', show_scope: 'Êü•ÁúãËåÉÂõ¥'\n  },\n\n  'AR': { \n    db: 'AR_DUBAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Arabic', flag: 'üá¶üá™', native: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', cur: 'AED', sym: 'ÿØ.ÿ•', loc: 'ar-AE', region: 'ÿØÿ®Ÿä', search_lang: 'Arabic',\n    ok: '‚úÖ *ÿßŸÑÿπÿ±ÿ®Ÿäÿ©* ¬∑ ÿØÿ®Ÿä ¬∑ AED',\n    photo: `*ÿ£ÿ±ÿ≥ŸÑ ÿµŸàÿ±ÿ© ÿ£Ÿà PDF ÿ£Ÿà ŸàÿµŸÅ*\n\nüìÑ *ŸÖÿÆÿ∑ÿ∑ÿßÿ™ PDF* ‚Äî ŸÖÿÆÿ∑ÿ∑ ÿßŸÑÿ∑ÿßÿ®ŸÇ ÿ£Ÿà ÿßŸÑÿ±ÿ≥ŸÖ (ÿ≠ÿ™Ÿâ 3 ÿµŸÅÿ≠ÿßÿ™)\nüì∑ *ÿµŸàÿ±ÿ©* ‚Äî ÿßŸÑÿ™ŸÇÿ∑ ÿµŸàÿ±ÿ© ŸÑŸÑŸÖŸÉÿßŸÜ\n‚úèÔ∏è *ŸÜÿµ* ‚Äî ÿµŸÅ ÿßŸÑÿ£ÿπŸÖÿßŸÑ ŸÉŸÇÿßÿ¶ŸÖÿ©\n\n_ŸÖÿ´ÿßŸÑ ŸÑŸÑŸÜÿ≥ÿÆ:_\n\\`\\`\\`\nÿ¨ÿ®ÿ≥ ÿ®Ÿàÿ±ÿØ ÿ∑ÿ®ŸÇÿ™ŸäŸÜ ŸáŸäŸÉŸÑ ŸÖÿπÿØŸÜŸä 25ŸÖ2\nÿ®ŸÑÿßÿ∑ ÿ≥Ÿäÿ±ÿßŸÖŸäŸÉ 60x60 ÿ≠ŸÖÿßŸÖ 15ŸÖ2\nŸÖÿπÿ¨ŸàŸÜ ÿ£ÿ≥ŸÇŸÅ ÿ¨ÿØÿ±ÿßŸÜ 120ŸÖ2\nŸÖŸÇÿßÿ®ÿ≥ ŸÖÿÆŸÅŸäÿ© 20ŸÇÿ∑ÿπÿ©\n\\`\\`\\`\n\nÿ£Ÿà ÿ£ÿ±ÿ≥ŸÑ ÿµŸàÿ±ÿ©/PDF üì∑üìÑ`,\n    pdf_received: 'üìÑ *ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ PDF*',\n    pdf_processing: '‚è≥ ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑŸÖÿÆÿ∑ÿ∑...',\n    pdf_pages: 'ÿµŸÅÿ≠ÿßÿ™',\n    pdf_page_limit: '‚ö†Ô∏è ŸÖÿπÿßŸÑÿ¨ÿ© ÿ£ŸàŸÑ 3 ÿµŸÅÿ≠ÿßÿ™ ŸÅŸÇÿ∑',\n    pdf_rooms_found: 'üè† ÿßŸÑÿ∫ÿ±ŸÅ ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©',\n    pdf_elements_found: 'üß± ÿßŸÑÿπŸÜÿßÿµÿ± ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©',\n    pdf_works_generated: 'üìù ÿßŸÑÿ£ÿπŸÖÿßŸÑ ÿßŸÑŸÖŸèŸÜÿ¥ÿ£ÿ©',\n    pdf_analyzing_page: 'üîç ÿ™ÿ≠ŸÑŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©',\n    pdf_of: 'ŸÖŸÜ',\n    pdf_complete: '‚úÖ ÿßŸÉÿ™ŸÖŸÑ ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ',\n    pdf_error: '‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© PDF',\n    photo_added: '‚úÖ ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©',\n    photos_count: 'ÿµŸàÿ±',\n    add_more: '+ ÿßŸÑŸÖÿ≤ŸäÿØ',\n    analyze_now: '‚ñ∂ ÿ™ÿ≠ŸÑŸäŸÑ',\n    analyzing: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÑŸäŸÑ...',\n    found: '*ÿßŸÑÿ£ÿπŸÖÿßŸÑ ÿßŸÑŸÖÿ≠ÿØÿØÿ©:*',\n    edit_hint: 'ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ™ÿπÿØŸäŸÑ',\n    calc: 'ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑÿ£ÿ≥ÿπÿßÿ±',\n    ready: '*ÿßŸÑÿ™ŸÇÿØŸäÿ±*',\n    total: 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ',\n    days: 'ŸäŸàŸÖ',\n    pct: 'ÿßŸÑÿØŸÇÿ©',\n    workers: 'ÿπŸÖÿßŸÑÿ©',\n    machines: 'ŸÖÿπÿØÿßÿ™',\n    materials: 'ŸÖŸàÿßÿØ',\n    subtotal: 'ŸÖŸÑÿÆÿµ',\n    searching: 'ÿ®ÿ≠ÿ´',\n    of: 'ŸÖŸÜ',\n    not_found: 'ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ',\n    low_conf: 'ŸÑŸÑŸÖÿ±ÿßÿ¨ÿπÿ©',\n    price_note: 'ÿßŸÑÿ£ÿ≥ÿßÿ≥: ÿØÿ®Ÿä 2025',\n    btn_calc: '‚ñ∂ ÿ≠ÿ≥ÿßÿ®',\n    btn_new: '+ ÿ¨ÿØŸäÿØ',\n    btn_lang: '‚öô ŸÑÿ∫ÿ©',\n    btn_edit: '‚úé ÿ™ÿπÿØŸäŸÑ',\n    btn_delete: '‚úï ÿ≠ÿ∞ŸÅ',\n    btn_add_work: '+ ÿ•ÿ∂ÿßŸÅÿ©',\n    btn_done: '‚úÖ ÿ™ŸÖ',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª ÿßŸÑÿ®ÿØÿ° ŸÖŸÜ ÿ¨ÿØŸäÿØ',\n    btn_help: '? ŸÖÿ≥ÿßÿπÿØÿ©',\n    loading: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ÿ≥ÿßÿ®...',\n    more_in_html: 'ÿ™ŸÇÿ±Ÿäÿ± ŸÖŸÅÿµŸÑ ŸÖÿ™ÿßÿ≠',\n    resources: 'ÿßŸÑÿ™ŸÅÿßÿµŸäŸÑ: ÿßŸÑŸÖŸàÿßÿ±ÿØ ŸàŸÜÿ∑ÿßŸÇ ÿßŸÑÿπŸÖŸÑ',\n    enter_work: '*ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸÜÿØ*\\nÿßŸÑÿµŸäÿ∫ÿ©: ÿßŸÑŸàÿµŸÅÿå ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸàÿ≠ÿØÿ©',\n    work_added: '‚úÖ ÿ™ŸÖÿ™ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©',\n    what_next: '*ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™:*',\n    categories: 'ÿßŸÑŸÅÿ¶ÿßÿ™',\n    cat_demolition: 'ŸáÿØŸÖ',\n    cat_rough: 'ŸáŸäŸÉŸÑ',\n    cat_finishing: 'ÿ™ÿ¥ÿ∑Ÿäÿ®',\n    cat_mep: 'ŸÖŸäŸÉÿßŸÜŸäŸÉ',\n    help_title: '*ÿØŸÑŸäŸÑ*',\n    help_text: `*ÿØŸÑŸäŸÑ ÿßŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ*\n\n*1.* ÿ£ÿ±ÿ≥ŸÑ ÿµŸàÿ± ÿ£Ÿà PDF ÿ£Ÿà ŸàÿµŸÅ\nPDF: ÿ≠ÿ™Ÿâ 3 ÿµŸÅÿ≠ÿßÿ™\n*2.* ÿ±ÿßÿ¨ÿπ ÿßŸÑÿ£ÿπŸÖÿßŸÑ\n*3.* ÿßÿ≠ÿ≥ÿ® ÿßŸÑÿ£ÿ≥ÿπÿßÿ±\n*4.* ÿµÿØŸëÿ±\n\n/start ‚Äî ÿ¨ÿØŸäÿØ\n/help ‚Äî ŸÖÿ≥ÿßÿπÿØÿ©`,\n    doc_title: 'ÿßŸÑÿ™ŸÇÿØŸäÿ±',\n    col_pos: 'ÿ±ŸÇŸÖ', col_code: 'ÿßŸÑÿ±ŸÖÿ≤', col_desc: 'ÿßŸÑŸàÿµŸÅ', col_unit: 'Ÿàÿ≠ÿØÿ©', col_qty: 'ŸÉŸÖŸäÿ©', col_price: 'ÿ≥ÿπÿ±', col_total: 'ÿßŸÑŸÖÿ¨ŸÖŸàÿπ', col_labor: 'ÿ≥ÿßÿπÿßÿ™', col_quality: 'ÿ¨',\n    grand_total: 'ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä', labor_cost: 'ÿπŸÖÿßŸÑÿ©', material_cost: 'ŸÖŸàÿßÿØ', labor_days: 'ÿ£ŸäÿßŸÖ',\n    kpi_total: 'ÿßŸÑÿ™ŸÉŸÑŸÅÿ©', kpi_hours: 'ÿ≥ÿßÿπÿßÿ™', kpi_days: 'ÿ£ŸäÿßŸÖ',\n    chart_cost_structure: 'ÿßŸÑŸáŸäŸÉŸÑ', chart_labor: 'ÿπŸÖÿßŸÑÿ©', chart_material: 'ŸÖŸàÿßÿØ', chart_machines: 'ŸÖÿπÿØÿßÿ™',\n    res_labor: 'ÿπŸÖÿßŸÑÿ©', res_material: 'ŸÖŸàÿßÿØ', res_machine: 'ŸÖÿπÿØÿßÿ™',\n    collapse_all: 'ÿ∑Ÿä', expand_all: 'ÿ™Ÿàÿ≥Ÿäÿπ',\n    quality_high: 'ÿπÿßŸÑŸäÿ©', quality_medium: 'ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©', quality_low: 'ŸÖŸÜÿÆŸÅÿ∂ÿ©',\n    export_excel_msg: 'ÿ™ÿµÿØŸäÿ± Excel', export_pdf_msg: 'ÿ™ÿµÿØŸäÿ± PDF', btn_refine: 'ÿ™ÿ≠ŸÑŸäŸÑ ÿ£ÿØŸÇ', found_pct: 'Ÿàÿ¨ÿØ', more_resources: 'ÿßŸÑŸÖÿ≤ŸäÿØ', kpi_items: 'ÿ®ŸÜŸàÿØ', scope_title: 'ŸÜÿ∑ÿßŸÇ ÿßŸÑÿπŸÖŸÑ', show_scope: 'ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ∑ÿßŸÇ'\n  },\n\n  'HI': { \n    db: 'HI_MUMBAI_workitems_costs_resources_EMBEDDINGS_3072_DDC_CWICR', \n    name: 'Hindi', flag: 'üáÆüá≥', native: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä', cur: 'INR', sym: '‚Çπ', loc: 'hi-IN', region: '‡§Æ‡•Å‡§Ç‡§¨‡§à', search_lang: 'Hindi',\n    ok: '‚úÖ *‡§π‡§ø‡§®‡•ç‡§¶‡•Ä* ¬∑ ‡§Æ‡•Å‡§Ç‡§¨‡§à ¬∑ INR',\n    photo: `*‡§´‡§º‡•ã‡§ü‡•ã, PDF ‡§Ø‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡•á‡§ú‡•á‡§Ç*\n\nüìÑ *PDF ‡§°‡•ç‡§∞‡§æ‡§á‡§Ç‡§ó* ‚Äî ‡§´‡•ç‡§≤‡•ã‡§∞ ‡§™‡•ç‡§≤‡§æ‡§® ‡§Ø‡§æ ‡§¨‡•ç‡§≤‡•Ç‡§™‡•ç‡§∞‡§ø‡§Ç‡§ü (‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 3 ‡§™‡•á‡§ú)\nüì∑ *‡§´‡§º‡•ã‡§ü‡•ã* ‚Äî ‡§ï‡§Æ‡§∞‡•á ‡§Ø‡§æ ‡§µ‡§∏‡•ç‡§§‡•Å ‡§ï‡•Ä ‡§´‡§º‡•ã‡§ü‡•ã\n‚úèÔ∏è *‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü* ‚Äî ‡§ï‡§æ‡§∞‡•ç‡§Ø‡•ã‡§Ç ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§∏‡•Ç‡§ö‡•Ä ‡§Æ‡•á‡§Ç\n\n_‡§ï‡•â‡§™‡•Ä ‡§â‡§¶‡§æ‡§π‡§∞‡§£:_\n\\`\\`\\`\n‡§°‡•ç‡§∞‡§æ‡§à‡§µ‡•â‡§≤ 2 ‡§≤‡•á‡§Ø‡§∞ ‡§Æ‡•á‡§ü‡§≤ ‡§´‡•ç‡§∞‡•á‡§Æ 25m2\n‡§ü‡§æ‡§á‡§≤‡•ç‡§∏ 60x60 ‡§¨‡§æ‡§•‡§∞‡•Ç‡§Æ 15m2\n‡§™‡•Å‡§ü‡•ç‡§ü‡•Ä ‡§õ‡§§ ‡§¶‡•Ä‡§µ‡§æ‡§∞‡•á‡§Ç 120m2\n‡§∏‡•â‡§ï‡•á‡§ü 20 ‡§™‡•Ä‡§∏\n\\`\\`\\`\n\n‡§Ø‡§æ ‡§´‡§º‡•ã‡§ü‡•ã/PDF ‡§≠‡•á‡§ú‡•á‡§Ç üì∑üìÑ`,\n    pdf_received: 'üìÑ *PDF ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§*',\n    pdf_processing: '‚è≥ ‡§°‡•ç‡§∞‡§æ‡§á‡§Ç‡§ó ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£...',\n    pdf_pages: '‡§™‡•á‡§ú',\n    pdf_page_limit: '‚ö†Ô∏è ‡§ï‡•á‡§µ‡§≤ ‡§™‡§π‡§≤‡•á 3 ‡§™‡•á‡§ú ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏ ‡§π‡•ã‡§Ç‡§ó‡•á',\n    pdf_rooms_found: 'üè† ‡§ï‡§Æ‡§∞‡•á ‡§Æ‡§ø‡§≤‡•á',\n    pdf_elements_found: 'üß± ‡§è‡§≤‡§ø‡§Æ‡•á‡§Ç‡§ü ‡§Æ‡§ø‡§≤‡•á',\n    pdf_works_generated: 'üìù ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§¨‡§®‡§æ‡§è ‡§ó‡§è',\n    pdf_analyzing_page: 'üîç ‡§™‡•á‡§ú ‡§ï‡§æ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£',\n    pdf_of: '‡§Æ‡•á‡§Ç ‡§∏‡•á',\n    pdf_complete: '‚úÖ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ ‡§™‡•Ç‡§∞‡•ç‡§£',\n    pdf_error: '‚ùå PDF ‡§™‡•ç‡§∞‡•ã‡§∏‡•á‡§∏‡§ø‡§Ç‡§ó ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø',\n    photo_added: '‚úÖ ‡§´‡§º‡•ã‡§ü‡•ã ‡§ú‡•ã‡§°‡§º‡•Ä ‡§ó‡§à',\n    photos_count: '‡§´‡§º‡•ã‡§ü‡•ã',\n    add_more: '+ ‡§î‡§∞ ‡§´‡§º‡•ã‡§ü‡•ã',\n    analyze_now: '‚ñ∂ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£',\n    analyzing: '‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£...',\n    found: '*‡§™‡§π‡§ö‡§æ‡§®‡•á ‡§ó‡§è ‡§ï‡§æ‡§∞‡•ç‡§Ø:*',\n    edit_hint: '‡§∏‡§Ç‡§™‡§æ‡§¶‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ü‡•à‡§™ ‡§ï‡§∞‡•á‡§Ç',\n    calc: '‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§ñ‡•ã‡§ú',\n    ready: '*‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®*',\n    total: '‡§ï‡•Å‡§≤',\n    days: '‡§¶‡§ø‡§®',\n    pct: '‡§∏‡§ü‡•Ä‡§ï‡§§‡§æ',\n    workers: '‡§∂‡•ç‡§∞‡§Æ',\n    machines: '‡§â‡§™‡§ï‡§∞‡§£',\n    materials: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä',\n    subtotal: '‡§∏‡§æ‡§∞‡§æ‡§Ç‡§∂',\n    searching: '‡§ñ‡•ã‡§ú',\n    of: '‡§Æ‡•á‡§Ç ‡§∏‡•á',\n    not_found: '‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ',\n    low_conf: '‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç',\n    price_note: '‡§Ü‡§ß‡§æ‡§∞: ‡§Æ‡•Å‡§Ç‡§¨‡§à 2025',\n    btn_calc: '‚ñ∂ ‡§ó‡§£‡§®‡§æ',\n    btn_new: '+ ‡§®‡§Ø‡§æ',\n    btn_lang: '‚öô ‡§≠‡§æ‡§∑‡§æ',\n    btn_edit: '‚úé ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§',\n    btn_delete: '‚úï ‡§π‡§ü‡§æ‡§è‡§Ç',\n    btn_add_work: '+ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç',\n    btn_done: '‚úÖ ‡§π‡•ã ‡§ó‡§Ø‡§æ',\n    btn_export_excel: '‚Üì Excel',\n    btn_export_pdf: '‚Üì PDF',\n    btn_restart: '‚Üª ‡§´‡§ø‡§∞ ‡§∏‡•á',\n    btn_help: '? ‡§Æ‡§¶‡§¶',\n    loading: '‡§ó‡§£‡§®‡§æ...',\n    more_in_html: '‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§â‡§™‡§≤‡§¨‡•ç‡§ß',\n    resources: '‡§µ‡§ø‡§µ‡§∞‡§£: ‡§∏‡§Ç‡§∏‡§æ‡§ß‡§® ‡§î‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞',\n    enter_work: '*‡§Ü‡§á‡§ü‡§Æ ‡§ú‡•ã‡§°‡§º‡•á‡§Ç*\\n‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™: ‡§µ‡§ø‡§µ‡§∞‡§£, ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ ‡§á‡§ï‡§æ‡§à',\n    work_added: '‚úÖ ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ',\n    what_next: '*‡§µ‡§ø‡§ï‡§≤‡•ç‡§™:*',\n    categories: '‡§∂‡•ç‡§∞‡•á‡§£‡§ø‡§Ø‡§æ‡§Ç',\n    cat_demolition: '‡§§‡•ã‡§°‡§º‡§´‡•ã‡§°‡§º',\n    cat_rough: '‡§¢‡§æ‡§Ç‡§ö‡§æ',\n    cat_finishing: '‡§´‡§º‡§ø‡§®‡§ø‡§∂‡§ø‡§Ç‡§ó',\n    cat_mep: 'MEP',\n    help_title: '*‡§ó‡§æ‡§á‡§°*',\n    help_text: `*‡§â‡§™‡§Ø‡•ã‡§ó ‡§ó‡§æ‡§á‡§°*\n\n*1.* ‡§´‡§º‡•ã‡§ü‡•ã, PDF ‡§Ø‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§≠‡•á‡§ú‡•á‡§Ç\nPDF: ‡§Ö‡§ß‡§ø‡§ï‡§§‡§Æ 3 ‡§™‡•á‡§ú\n*2.* ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ú‡§æ‡§Å‡§ö‡•á‡§Ç\n*3.* ‡§Æ‡•Ç‡§≤‡•ç‡§Ø ‡§ó‡§£‡§®‡§æ\n*4.* ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§\n\n/start ‚Äî ‡§®‡§Ø‡§æ\n/help ‚Äî ‡§Æ‡§¶‡§¶`,\n    doc_title: '‡§Ö‡§®‡•Å‡§Æ‡§æ‡§®',\n    col_pos: '‡§ï‡•ç‡§∞‡§Æ', col_code: '‡§ï‡•ã‡§°', col_desc: '‡§µ‡§ø‡§µ‡§∞‡§£', col_unit: '‡§á‡§ï‡§æ‡§à', col_qty: '‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ', col_price: '‡§¶‡§∞', col_total: '‡§ï‡•Å‡§≤', col_labor: '‡§ò‡§Ç‡§ü‡•á', col_quality: '‡§ó‡•Å',\n    grand_total: '‡§ï‡•Å‡§≤ ‡§Ø‡•ã‡§ó', labor_cost: '‡§∂‡•ç‡§∞‡§Æ', material_cost: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä', labor_days: '‡§¶‡§ø‡§®',\n    kpi_total: '‡§ï‡•Å‡§≤ ‡§≤‡§æ‡§ó‡§§', kpi_hours: '‡§ò‡§Ç‡§ü‡•á', kpi_days: '‡§¶‡§ø‡§®',\n    chart_cost_structure: '‡§∏‡§Ç‡§∞‡§ö‡§®‡§æ', chart_labor: '‡§∂‡•ç‡§∞‡§Æ', chart_material: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä', chart_machines: '‡§â‡§™‡§ï‡§∞‡§£',\n    res_labor: '‡§∂‡•ç‡§∞‡§Æ', res_material: '‡§∏‡§æ‡§Æ‡§ó‡•ç‡§∞‡•Ä', res_machine: '‡§â‡§™‡§ï‡§∞‡§£',\n    collapse_all: '‡§∏‡§Ç‡§ï‡•ç‡§∑‡§ø‡§™‡•ç‡§§', expand_all: '‡§µ‡§ø‡§∏‡•ç‡§§‡•É‡§§',\n    quality_high: '‡§â‡§ö‡•ç‡§ö', quality_medium: '‡§Æ‡§ß‡•ç‡§Ø‡§Æ', quality_low: '‡§®‡§ø‡§Æ‡•ç‡§®',\n    export_excel_msg: 'Excel ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§', export_pdf_msg: 'PDF ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§', btn_refine: '‡§∏‡•Å‡§ß‡§æ‡§∞‡•á‡§Ç', found_pct: '‡§Æ‡§ø‡§≤‡§æ', more_resources: '‡§î‡§∞', kpi_items: '‡§Ü‡§á‡§ü‡§Æ', scope_title: '‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞', show_scope: '‡§¶‡•á‡§ñ‡•á‡§Ç'\n  }\n};\n\nconst L = LANGS[lang] || LANGS['EN'];\n\n// Update session with language data\nif (sd.sess && sd.sess[chatId]) { \n  sd.sess[chatId].db = L.db; \n  sd.sess[chatId].L = L; \n}\n\n// Get voice/PDF file IDs from session if available\nconst voiceFileId = sd.sess?.[chatId]?.voiceFileId || input.voiceFileId || null;\nconst pdfFileId = sd.sess?.[chatId]?.pdfFileId || input.pdfFileId || null;\nconst pdfFileName = sd.sess?.[chatId]?.pdfFileName || input.pdfFileName || null;\n\nreturn { \n  json: { \n    ...input, \n    L: L, \n    db: L.db, \n    voiceFileId,\n    pdfFileId,\n    pdfFileName,\n    // API Keys passthrough\n    AI_PROVIDER: input.AI_PROVIDER || 'gemini',\n    GEMINI_API_KEY: input.GEMINI_API_KEY,\n    OPENAI_API_KEY: input.OPENAI_API_KEY\n  } \n};"
      },
      "id": "fd21108b-d72d-4187-9db8-f9846503e2eb",
      "name": "Config2",
      "type": "n8n-nodes-base.code",
      "position": [
        -2976,
        13600
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// MAIN ROUTER - Central message handler\n// DDC CWICR - Data Driven Construction Cost Estimator\n// https://DataDrivenConstruction.io\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// https://DataDrivenConstruction.io\n// Open source construction cost database with 55,000+ work items\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// MAIN ROUTER v8.5 PRO - Multi-photo, Voice, PDF, Edit, Categories, Export\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst update = $('Telegram Trigger2').first().json;\nconst botToken = $input.first().json.bot_token;\nconst isCallback = !!update.callback_query;\n\nlet chatId, callbackData, callbackQueryId, text, fileId, hasImage, caption;\nlet hasVoice, voiceFileId, mediaGroupId;\nlet hasPDF, pdfFileId, pdfFileName; // PDF support\n\nif (isCallback) {\n  const cb = update.callback_query;\n  chatId = cb.message?.chat?.id;\n  callbackData = cb.data || '';\n  callbackQueryId = cb.id;\n  text = ''; fileId = null; hasImage = false; caption = ''; \n  hasVoice = false; voiceFileId = null; mediaGroupId = null;\n  hasPDF = false; pdfFileId = null; pdfFileName = null;\n} else {\n  const msg = update.message || {};\n  chatId = msg.chat?.id;\n  callbackData = ''; callbackQueryId = '';\n  text = msg.text || ''; caption = msg.caption || '';\n  mediaGroupId = msg.media_group_id || null;\n  \n  // Photo detection\n  const photo = msg.photo || [];\n  fileId = photo.length > 0 ? photo[photo.length - 1].file_id : null;\n  hasImage = !!fileId;\n  if (!fileId && msg.document?.mime_type?.startsWith('image/')) {\n    fileId = msg.document.file_id; hasImage = true;\n  }\n  \n  // Voice detection\n  hasVoice = !!(msg.voice || msg.audio);\n  voiceFileId = msg.voice?.file_id || msg.audio?.file_id || null;\n  \n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  // PDF DOCUMENT DETECTION\n  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n  const doc = msg.document || {};\n  hasPDF = doc.mime_type === 'application/pdf';\n  pdfFileId = hasPDF ? doc.file_id : null;\n  pdfFileName = hasPDF ? (doc.file_name || 'document.pdf') : null;\n}\n\nconst sd = $getWorkflowStaticData('global');\nif (!sd.sess) sd.sess = {};\nconst cid = String(chatId);\nif (!sd.sess[cid]) sd.sess[cid] = { \n  lang: null, works: [], state: 'new', db: null, L: null, \n  photos: [], voiceText: '', description: '',\n  categories: { demolition: true, rough: true, finishing: true, mep: true },\n  // PDF state\n  pdfFileId: null, pdfFileName: null, pdfPages: [], \n  rooms: [], elements: [], pdfProcessed: false\n};\nconst S = sd.sess[cid];\n\nlet action = 'none';\n\n// === COMMANDS ===\nif (text.toLowerCase() === '/start') {\n  S.lang = null; S.works = []; S.state = 'wait_lang'; S.db = null; S.L = null;\n  S.photos = []; S.voiceText = ''; S.description = '';\n  S.pdfFileId = null; S.pdfFileName = null; S.rooms = []; S.elements = []; S.pdfProcessed = false;\n  action = 'show_lang';\n}\nelse if (text.toLowerCase() === '/help') {\n  action = 'show_help';\n}\n\n// === LANGUAGE SELECTION ===\nelse if (/^lang_(DE|EN|RU|ES|FR|PT|ZH|AR|HI)$/i.test(callbackData)) {\n  S.lang = callbackData.replace('lang_', '').toUpperCase();\n  S.state = 'wait_photo'; action = 'lang_selected';\n}\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// PDF HANDLING\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nelse if (hasPDF && S.lang) {\n  S.pdfFileId = pdfFileId;\n  S.pdfFileName = pdfFileName;\n  S.state = 'processing_pdf';\n  S.description = `üìÑ ${pdfFileName}`;\n  action = 'process_pdf';\n}\n\n// === PHOTO HANDLING (Multi-photo support) ===\nelse if (hasImage && S.lang) {\n  S.photos.push({ fileId, caption });\n  if (caption) S.description = caption;\n  \n  if (mediaGroupId) {\n    S.mediaGroupId = mediaGroupId;\n    S.state = 'collecting_photos';\n    action = 'photo_added';\n  } else {\n    S.state = 'ready_to_analyze';\n    action = 'show_analyze_options';\n  }\n}\n\n// === VOICE MESSAGE ===\nelse if (hasVoice && S.lang) {\n  S.voiceFileId = voiceFileId;\n  S.state = 'processing_voice';\n  action = 'process_voice';\n}\n\n// === ANALYZE BUTTON ===\nelse if (callbackData === 'analyze_photos') {\n  if (S.photos.length > 0) {\n    S.state = 'analyzing';\n    action = 'analyze';\n  } else {\n    action = 'ask_photo';\n  }\n}\n\n// === ADD MORE PHOTOS ===\nelse if (callbackData === 'add_more_photos') {\n  S.state = 'wait_photo';\n  action = 'ask_photo';\n}\n\n// === CATEGORY FILTERS ===\nelse if (/^cat_(demolition|rough|finishing|mep)$/.test(callbackData)) {\n  const cat = callbackData.replace('cat_', '');\n  S.categories[cat] = !S.categories[cat];\n  action = 'update_categories';\n}\n\n// === EDIT WORK ITEMS ===\nelse if (/^edit_work_(\\d+)$/.test(callbackData)) {\n  const idx = parseInt(callbackData.match(/edit_work_(\\d+)/)[1]);\n  S.editingWorkIndex = idx;\n  S.state = 'editing_work';\n  action = 'show_edit_menu';\n}\nelse if (/^delete_work_(\\d+)$/.test(callbackData)) {\n  const idx = parseInt(callbackData.match(/delete_work_(\\d+)/)[1]);\n  if (S.works[idx]) {\n    S.works.splice(idx, 1);\n    S.works.forEach((w, i) => { w.seq = i + 1; w.id = `W${String(i+1).padStart(3,'0')}`; });\n  }\n  action = 'works_updated';\n}\nelse if (/^qty_work_(\\d+)_(.+)$/.test(callbackData)) {\n  const match = callbackData.match(/qty_work_(\\d+)_(.+)/);\n  const idx = parseInt(match[1]);\n  const change = match[2];\n  if (S.works[idx]) {\n    let q = S.works[idx].qty;\n    if (change === 'plus10') q += 10;\n    else if (change === 'minus10') q = Math.max(1, q - 10);\n    else if (change === 'plus1') q += 1;\n    else if (change === 'minus1') q = Math.max(1, q - 1);\n    else if (change === 'double') q *= 2;\n    else if (change === 'half') q = Math.max(1, Math.round(q / 2));\n    S.works[idx].qty = q;\n  }\n  action = 'works_updated';\n}\nelse if (callbackData === 'add_work') {\n  S.state = 'adding_work';\n  action = 'ask_new_work';\n}\nelse if (callbackData === 'done_editing') {\n  S.state = 'works_shown';\n  action = 'works_updated';\n}\n\n// === CALCULATE ===\nelse if (callbackData === 'refine_analysis') {\n  action = 'refine_analysis';\n}\nelse if (callbackData === 'calculate') {\n  if (S.works && S.works.length > 0) {\n    S.state = 'calc';\n    action = 'start_calc';\n  } else {\n    action = 'ask_photo';\n  }\n}\n\n// === EXPORT OPTIONS ===\nelse if (callbackData === 'view_details') {\n  action = 'view_details';\n}\nelse if (callbackData === 'export_excel') {\n  action = 'export_excel';\n}\nelse if (callbackData === 'export_pdf') {\n  action = 'export_pdf';\n}\n\n// === NEW ESTIMATE / RESTART ===\nelse if (callbackData === 'new_photo' || callbackData === 'new_estimate' || callbackData === 'restart') {\n  S.photos = []; S.works = []; S.voiceText = ''; S.description = '';\n  S.pdfFileId = null; S.pdfFileName = null; S.rooms = []; S.elements = []; S.pdfProcessed = false;\n  S.state = 'wait_photo';\n  action = 'ask_photo';\n}\nelse if (callbackData === 'show_help' || callbackData === 'help') {\n  action = 'show_help';\n}\nelse if (callbackData === 'change_language') {\n  S.lang = null; S.state = 'wait_lang';\n  action = 'show_lang';\n}\n\n// === TEXT INPUT (for adding work) ===\nelse if (text && S.state === 'adding_work') {\n  const parts = text.split(',');\n  const name = parts[0]?.trim() || text;\n  let qty = 1, unit = 'm¬≤';\n  if (parts[1]) {\n    const qtyMatch = parts[1].match(/([\\d.,]+)\\s*(.*)/);\n    if (qtyMatch) {\n      qty = parseFloat(qtyMatch[1].replace(',', '.')) || 1;\n      unit = qtyMatch[2]?.trim() || 'm¬≤';\n    }\n  }\n  const newWork = {\n    id: `W${String(S.works.length + 1).padStart(3,'0')}`,\n    name, query: name, qty, unit, conf: 'medium', category: 'general', seq: S.works.length + 1\n  };\n  S.works.push(newWork);\n  S.state = 'works_shown';\n  action = 'works_updated';\n}\n\n// === FALLBACKS ===\nelse if (!S.lang) { action = 'show_lang'; }\nelse if (S.state === 'wait_photo' && !hasImage && !hasPDF && text && text.length > 5) {\n  S.description = text;\n  S.textInput = text;\n  S.photos = S.photos || [];\n  action = 'analyze_text';\n}\nelse if (S.state === 'wait_photo' && !hasImage && !hasPDF) { action = 'ask_photo'; }\nelse if (S.state === 'collecting_photos') {\n  action = 'none';\n}\n\nreturn { json: { \n  bot_token: botToken, chatId, action, lang: S.lang, works: S.works, \n  callbackData, callbackQueryId, isCallback, hasImage, hasVoice, \n  fileId, voiceFileId, text, caption, photos: S.photos,\n  categories: S.categories, editingWorkIndex: S.editingWorkIndex,\n  description: S.description, voiceText: S.voiceText,\n  // PDF fields\n  hasPDF, pdfFileId, pdfFileName,\n  rooms: S.rooms, elements: S.elements, pdfProcessed: S.pdfProcessed\n}};"
      },
      "id": "c43adc43-2bea-4a13-a088-c7067c85b467",
      "name": "Main2",
      "type": "n8n-nodes-base.code",
      "position": [
        -3232,
        13600
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{\n  \"bot_token\": \"YOUR_TELEGRAM_BOT_TOKEN\",\n  \"AI_PROVIDER\": \"gemini\",\n  \"GEMINI_API_KEY\": \"AIzaSyBRqtnMxmXWHa_oG4hA9VfjmXuUWZEQypc\",\n  \"OPENAI_API_KEY\": \"AIzaSyBRqtnMxmXWHa_oG4hA9VfjmXuUWZEQypc\",\n  \"QDRANT_URL\": \"http://localhost:6333\",\n  \"QDRANT_API_KEY\": \"YOUR_QDRANT_API_KEY\"\n}",
        "options": {}
      },
      "id": "18b63526-0829-4ef1-aae1-f5b65a834eac",
      "name": "üîë TOKEN2",
      "type": "n8n-nodes-base.set",
      "position": [
        -3504,
        13600
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "telegram-bot-MRnTJ_NK",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "1f755ebb-7536-45ff-992a-07959072e6ac",
      "name": "Telegram Trigger2",
      "type": "n8n-nodes-base.webhook",
      "position": [
        -3696,
        13600
      ],
      "webhookId": "00faed2e",
      "typeVersion": 2
    },
    {
      "parameters": {
        "content": "## üëÅÔ∏è Block 4: Vision Analysis Pipeline\n\n**Photo Analysis Flow:**\n```\nRefine ‚Üí Prep Download ‚Üí Get File ‚Üí Download ‚Üí Convert Base64 ‚Üí Merge ‚Üí Prep Vision ‚Üí Call API ‚Üí Parse AI ‚Üí Show Works\n```\n\n**AI Providers:**\n- **Gemini 2.0 Flash** ‚Äî Fast, multilingual\n- **GPT-4 Vision** ‚Äî High accuracy\n\n**Output:** JSON with work items:\n- name, qty, unit, conf, cat",
        "height": 644,
        "width": 2248,
        "color": 6
      },
      "id": "913af829-5f37-4711-b010-74b4f3a1bc6d",
      "name": "Block 4 - Vision1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2032,
        13056
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üìÑ Block 5: PDF Floor Plan Processing\n\n**PDF Pipeline:**\n```\nDownload Prep ‚Üí Get Path ‚Üí Download ‚Üí Split Pages ‚Üí Loop ‚Üí Vision per Page ‚Üí Parse ‚Üí Accumulate\n```\n\n**Features:**\n- Multi-page PDF support\n- Room detection per page\n- Measurements extraction\n- Aggregation across pages",
        "height": 312,
        "width": 2896,
        "color": 6
      },
      "id": "dad16242-e442-46f4-8e35-14acc3133b2b",
      "name": "Block 5 - PDF1",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2032,
        13744
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üîÑ Block 6: Calculation Loop\n\n**Per Work Item:**\n```\nPrep Query ‚Üí LLM Transform ‚Üí Embedding ‚Üí Qdrant Search ‚Üí Rerank ‚Üí Calculate ‚Üí Update Result ‚Üí Accumulate\n```\n\n**Vector Search:**\n- OpenAI embeddings\n- Qdrant vector DB\n- 55,000+ construction rates\n\n**AI Reranking:**\n- LLM validates matches\n- Quality scoring (‚óè‚óã‚óå‚úï)",
        "height": 724,
        "width": 1728,
        "color": 3
      },
      "id": "57b837cf-d0e8-4140-b339-b1a7c4abeb47",
      "name": "Block 6 - Calculation2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1456,
        14592
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üìä Block 7: Aggregation & Reports\n\n**Final Processing:**\n```\nCleanup ‚Üí Delete Messages ‚Üí Aggregate ‚Üí Generate HTML ‚Üí Final Message ‚Üí Send HTML\n```\n\n**Report Contents:**\n- Work items with resources\n- Cost breakdown (Labor/Materials/Equipment)\n- Quality indicators\n- Total calculation",
        "height": 420,
        "width": 1720,
        "color": 6
      },
      "id": "9226f8c5-b53f-4b89-9a1a-9a1d3fdebf57",
      "name": "Block 7 - Reports2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -1456,
        14144
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üì• Block 8: Export Options\n\n**Available Exports:**\n- üìä **Excel (CSV)** ‚Äî Spreadsheet format\n- üìÑ **PDF** ‚Äî Professional document\n- üåê **HTML** ‚Äî Interactive report\n\n**View Details:**\n- Full resource breakdown\n- Scope of work preview\n- Rate codes & names",
        "height": 692,
        "width": 1320,
        "color": 6
      },
      "id": "446a2615-eb39-4441-b1db-cd45d1410306",
      "name": "Block 8 - Export2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -2800,
        14416
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "content": "## üîç Vector Search Setup\n\n**Qdrant Collections:**\n- `DDC_CWICR_DE` ‚Äî German\n- `DDC_CWICR_EN` ‚Äî English  \n- `DDC_CWICR_RU` ‚Äî Russian\n- ... (9 languages total)\n\n**To enable:**\n1. Install Qdrant locally/VPS\n2. Upload datasets from GitHub\n3. Configure URL & API key\n\n**Database:** 55,000+ rates",
        "height": 384,
        "width": 236
      },
      "id": "6945fda9-a600-4f8d-b204-92ed20230b61",
      "name": "Qdrant Info2",
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        16,
        14912
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Refine analysis with advanced prompt\n// FIXED: Check if photos are available before proceeding\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config2').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst L = cfg.L || session.L || {};\n\nconsole.log('=== REFINE ANALYSIS ===');\nconsole.log('Session keys:', Object.keys(session));\nconsole.log('photos_base64:', session.photos_base64?.length || 0);\nconsole.log('photos:', (cfg.photos || session.photos || []).length);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –ü–†–û–í–ï–†–Ø–ï–ú: –µ—Å—Ç—å –ª–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞?\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nconst hasStoredBase64 = session.photos_base64 && session.photos_base64.length > 0;\nconst hasPhotoFileIds = (cfg.photos && cfg.photos.length > 0) || (session.photos && session.photos.length > 0);\n\nconsole.log('hasStoredBase64:', hasStoredBase64);\nconsole.log('hasPhotoFileIds:', hasPhotoFileIds);\n\nif (!hasStoredBase64 && !hasPhotoFileIds) {\n  console.log('No photos available for refinement - will ask user');\n  \n  if (!sd.sess) sd.sess = {};\n  if (!sd.sess[cid]) sd.sess[cid] = {};\n  sd.sess[cid].state = 'wait_photo';\n  \n  return { json: { \n    ...cfg, \n    chatId: cid,\n    skipRefine: true,\n    noPhotos: true,\n    L \n  }};\n}\n\nconsole.log('Photos available - proceeding with refine');\n\nif (!sd.sess) sd.sess = {};\nif (!sd.sess[cid]) sd.sess[cid] = {};\nsd.sess[cid].use_advanced_prompt = true;\n\nreturn { json: { \n  ...cfg, \n  chatId: cid,\n  use_advanced_prompt: true, \n  skipRefine: false,\n  noPhotos: false,\n  L \n}};"
      },
      "id": "41a81c6d-fd9e-4b79-915b-e51ec55b6a7b",
      "name": "Refine Analysis1",
      "type": "n8n-nodes-base.code",
      "position": [
        -1872,
        13392
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "14fdccc2-7a01-4d7d-9da0-81c0174beb68",
              "operator": {
                "type": "boolean",
                "operation": "equals"
              },
              "leftValue": "={{ $json.skipRefine }}",
              "rightValue": true
            }
          ]
        },
        "options": {}
      },
      "id": "9f7b78e6-853d-4785-af79-3837d2004cb8",
      "name": "IF Skip Refine1",
      "type": "n8n-nodes-base.if",
      "position": [
        -1728,
        13328
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify('üì∑ ' + (($json.L && $json.L.photo) ? $json.L.photo.split('\\n')[0] : 'Please send a photo first')) }},\n  \"parse_mode\": \"Markdown\"\n}",
        "options": {}
      },
      "id": "291821a4-7479-4542-bdd7-7978d872c476",
      "name": "üì§ Ask Photo Refine1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -1520,
        13200
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Prepare photo download\n// FIXED: Check for stored base64 first (for Refine Analysis)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config2').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst botToken = $('üîë TOKEN2').first().json.bot_token;\nconst L = cfg.L || session.L || {};\n\nconsole.log('=== PREP PHOTO DOWNLOAD ===');\nconsole.log('chatId:', cid);\nconsole.log('session.photos_base64:', session.photos_base64?.length || 0);\nconsole.log('cfg.photos:', (cfg.photos || []).length);\nconsole.log('session.photos:', (session.photos || []).length);\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// –ü–†–û–í–ï–†–Ø–ï–ú: –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Å–µ—Å—Å–∏–∏?\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\nif (session.photos_base64 && session.photos_base64.length > 0) {\n  console.log('‚úÖ Found stored base64 in session:', session.photos_base64.length, 'photos');\n  console.log('First photo base64 length:', session.photos_base64[0]?.base64?.length || 0);\n  \n  return { json: { \n    ...cfg,\n    chatId: cid,\n    bot_token: cfg.bot_token,\n    photos: session.photos_base64,\n    photoCount: session.photos_base64.length,\n    description: session.description || cfg.description || '',\n    useStoredBase64: true,\n    skipDownload: true,\n    botToken: botToken,\n    lang: cfg.lang || session.lang,\n    L\n  }};\n}\n\nconst photos = cfg.photos || session.photos || [];\n\nconsole.log('Photos to download:', photos.length);\n\nif (!photos || photos.length === 0) {\n  console.log('‚ùå No photos available');\n  return { json: { \n    ...cfg, \n    chatId: cid,\n    bot_token: cfg.bot_token,\n    photos: [], \n    photoCount: 0,\n    skipDownload: true,\n    noPhotosError: true,\n    botToken: botToken,\n    L\n  }};\n}\n\nconst firstPhoto = photos[0];\n\nconsole.log('Downloading photo with fileId:', firstPhoto.fileId);\n\nreturn { json: { \n  ...cfg,\n  chatId: cid,\n  bot_token: cfg.bot_token,\n  fileId: firstPhoto.fileId,\n  allPhotos: photos,\n  photoIndex: 0,\n  botToken: botToken,\n  useStoredBase64: false,\n  skipDownload: false,\n  L\n}};"
      },
      "id": "9920795e-53ae-41fd-9eb8-62cfba0dd75b",
      "name": "Prep Photo Download1",
      "type": "n8n-nodes-base.code",
      "position": [
        -1520,
        13344
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "jsCode": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// DDC CWICR - Prep Text LLM Request\n// Prepare API request for text-to-works analysis\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nconst cfg = $('Config2').first().json;\nconst tokenConfig = $('üîë TOKEN2').first().json;\nconst cid = String(cfg.chatId);\nconst sd = $getWorkflowStaticData('global');\nconst session = sd.sess?.[cid] || {};\nconst L = cfg.L || {};\n\nconst textInput = cfg.text || session.textInput || cfg.textInput || cfg.description || '';\nconst searchLang = L.search_lang || 'English';\n\nconsole.log('=== PREP TEXT LLM ===');\nconsole.log('Input:', textInput);\nconsole.log('Language:', searchLang);\n\nif (!textInput || textInput.length < 3) {\n  return { json: { ...cfg, chatId: cid, _skip_llm: true, works: [], description: 'No input' }};\n}\n\nconst GEMINI_API_KEY = tokenConfig.GEMINI_API_KEY || '';\nconst OPENAI_API_KEY = tokenConfig.OPENAI_API_KEY || '';\nconst provider = (tokenConfig.AI_PROVIDER || 'gemini').toLowerCase();\n\n// Language-specific examples\nconst LANG_EXAMPLES = {\n  'German': {\n    input: 'Renovierung Badezimmer 8qm',\n    output: '[{\"name\": \"Fliesendemontage Wand Boden\", \"qty\": 24, \"unit\": \"m¬≤\"}, {\"name\": \"Wandfliesen Feinsteinzeug 30x60\", \"qty\": 16, \"unit\": \"m¬≤\"}, {\"name\": \"Bodenfliesen rutschfest\", \"qty\": 8, \"unit\": \"m¬≤\"}, {\"name\": \"WC wandh√§ngend montieren\", \"qty\": 1, \"unit\": \"pcs\"}, {\"name\": \"Waschtisch montieren\", \"qty\": 1, \"unit\": \"pcs\"}]'\n  },\n  'English': {\n    input: 'Bathroom renovation 8sqm',\n    output: '[{\"name\": \"Tile removal walls floor\", \"qty\": 24, \"unit\": \"m¬≤\"}, {\"name\": \"Wall tiles porcelain 30x60\", \"qty\": 16, \"unit\": \"m¬≤\"}, {\"name\": \"Floor tiles anti-slip\", \"qty\": 8, \"unit\": \"m¬≤\"}, {\"name\": \"Wall-hung toilet install\", \"qty\": 1, \"unit\": \"pcs\"}, {\"name\": \"Vanity basin install\", \"qty\": 1, \"unit\": \"pcs\"}]'\n  },\n  'Russian': {\n    input: '—Ä–µ–º–æ–Ω—Ç –∫—É—Ö–Ω–∏ 20–º2 —Å—Ç–µ–Ω—ã –∏ –ª–∞–º–∏–Ω–∞—Ç',\n    output: '[{\"name\": \"–î–µ–º–æ–Ω—Ç–∞–∂ —Å—Ç–∞—Ä—ã—Ö –æ–±–æ–µ–≤\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"–®—Ç—É–∫–∞—Ç—É—Ä–∫–∞ —Å—Ç–µ–Ω –≥–∏–ø—Å–æ–≤–∞—è\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"–®–ø–∞–∫–ª—ë–≤–∫–∞ —Å—Ç–µ–Ω —Ñ–∏–Ω–∏—à–Ω–∞—è\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"–û–∫—Ä–∞—Å–∫–∞ —Å—Ç–µ–Ω –≤–æ–¥–æ—ç–º—É–ª—å—Å–∏–æ–Ω–Ω–∞—è\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"–î–µ–º–æ–Ω—Ç–∞–∂ –Ω–∞–ø–æ–ª—å–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è\", \"qty\": 20, \"unit\": \"m¬≤\"}, {\"name\": \"–£–∫–ª–∞–¥–∫–∞ –ª–∞–º–∏–Ω–∞—Ç–∞ —Å –ø–æ–¥–ª–æ–∂–∫–æ–π\", \"qty\": 20, \"unit\": \"m¬≤\"}, {\"name\": \"–ú–æ–Ω—Ç–∞–∂ –ø–ª–∏–Ω—Ç—É—Å–∞\", \"qty\": 18, \"unit\": \"m\"}]'\n  },\n  'Spanish': {\n    input: 'reforma cocina 20m2 paredes y suelo',\n    output: '[{\"name\": \"Retirada papel pintado\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Enlucido paredes\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Pintura paredes\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Demolici√≥n suelo\", \"qty\": 20, \"unit\": \"m¬≤\"}, {\"name\": \"Tarima flotante\", \"qty\": 20, \"unit\": \"m¬≤\"}]'\n  },\n  'French': {\n    input: 'r√©novation cuisine 20m2 murs et sol',\n    output: '[{\"name\": \"D√©pose papier peint\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Enduit murs\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Peinture murs\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"D√©pose rev√™tement sol\", \"qty\": 20, \"unit\": \"m¬≤\"}, {\"name\": \"Pose parquet flottant\", \"qty\": 20, \"unit\": \"m¬≤\"}]'\n  },\n  'Portuguese': {\n    input: 'reforma cozinha 20m2 paredes e piso',\n    output: '[{\"name\": \"Remo√ß√£o papel parede\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Reboco paredes\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Pintura paredes\", \"qty\": 50, \"unit\": \"m¬≤\"}, {\"name\": \"Remo√ß√£o piso\", \"qty\": 20, \"unit\": \"m¬≤\"}, {\"name\": \"Piso laminado\", \"qty\": 20, \"unit\": \"m¬≤\"}]'\n  }\n};\n\nconst langExample = LANG_EXAMPLES[searchLang] || LANG_EXAMPLES['English'];\n\nconst prompt = `You are a construction cost estimator. Extract ALL construction works from user's text.\n\nRULES:\n1. Output ONLY valid JSON array - NO explanations, NO markdown code blocks\n2. Generate works in ${searchLang} language  \n3. Be COMPREHENSIVE - include ALL works needed for described scope\n4. Use REALISTIC quantities based on area/room size mentioned\n5. Work names must be SPECIFIC for database search (not generic like \"wall work\")\n\nUNITS: m¬≤ (area), m (linear), pcs (items), kg, l\n\nEXAMPLE:\nInput: \"${langExample.input}\"\nOutput: ${langExample.output}\n\nUSER INPUT: \"${textInput}\"\n\nJSON ARRAY OUTPUT:`;\n\nlet apiUrl, requestBody;\n\nif (provider === 'gemini' && GEMINI_API_KEY) {\n  apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=' + GEMINI_API_KEY;\n  requestBody = {\n    contents: [{ parts: [{ text: prompt }] }],\n    generationConfig: { temperature: 0.15, maxOutputTokens: 4000 }\n  };\n} else if (OPENAI_API_KEY) {\n  apiUrl = 'https://generativelanguage.googleapis.com/v1beta/openai/chat/completions';\n  requestBody = {\n    model: 'gemini-2.5-flash',\n    messages: [{ role: 'user', content: prompt }],\n    temperature: 0.15,\n    max_tokens: 4000\n  };\n}\n\nconsole.log('Provider:', provider);\nconsole.log('API URL:', apiUrl ? 'configured' : 'MISSING');\n\nreturn { json: { \n  ...cfg, \n  chatId: cid, \n  textInput,\n  description: textInput.substring(0, 50) + (textInput.length > 50 ? '...' : ''),\n  _llm_provider: provider,\n  _llm_api_url: apiUrl,\n  _llm_request_body: requestBody,\n  _llm_api_key: provider === 'openai' ? OPENAI_API_KEY : '',\n  L\n}};"
      },
      "id": "a4596262-18b8-4ab6-a9ec-55cc01ded0f2",
      "name": "Prep Text LLM2",
      "type": "n8n-nodes-base.code",
      "position": [
        -2608,
        13680
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json._llm_api_url }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "={{ $json._llm_provider === 'openai' ? 'Bearer ' + $json._llm_api_key : '' }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json._llm_request_body) }}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "89ef4075-4d58-49d1-807f-a813ea35c0fd",
      "name": "Call Text LLM1",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2416,
        13680
      ],
      "typeVersion": 4.2
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $('üîë TOKEN2').first().json.bot_token }}/sendMessage",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"chat_id\": {{ $json.chatId }},\n  \"text\": {{ JSON.stringify($json.msg) }},\n  \"parse_mode\": \"Markdown\",\n  \"reply_markup\": { \"inline_keyboard\": {{ JSON.stringify($json.keyboard) }} }\n}",
        "options": {}
      },
      "id": "fe8ad292-c10b-4a4c-8e61-6f2210fee72e",
      "name": "üì§ Edit Menu2",
      "type": "n8n-nodes-base.httpRequest",
      "position": [
        -2224,
        14288
      ],
      "typeVersion": 4.2
    }
  ],
  "connections": {
    "When clicking ‚ÄòExecute workflow‚Äô": {
      "main": [
        [
          {
            "node": "Set path to file and converter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Set path to file and converter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agg": {
      "main": [
        [
          {
            "node": "Generate HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üóëÔ∏è Delete Progress Msg": {
      "main": [
        [
          {
            "node": "Agg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üóëÔ∏è Delete Work Msg": {
      "main": [
        [
          {
            "node": "üóëÔ∏è Delete Progress Msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üßπ Prep Cleanup": {
      "main": [
        [
          {
            "node": "üóëÔ∏è Delete Work Msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Acc": {
      "main": [
        [
          {
            "node": "Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Edit Result": {
      "main": [
        [
          {
            "node": "Acc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Update Result": {
      "main": [
        [
          {
            "node": "üì§ Edit Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1Ô∏è‚É£ Prep Query": {
      "main": [
        [
          {
            "node": "1.5Ô∏è‚É£ LLM Transform",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Save Work Msg": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£ Prep Query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Send Work": {
      "main": [
        [
          {
            "node": "üíæ Save Work Msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üóëÔ∏è Delete Prev": {
      "main": [
        [
          {
            "node": "üì§ Send Work",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù Prep Work Msg": {
      "main": [
        [
          {
            "node": "üóëÔ∏è Delete Prev",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop": {
      "main": [
        [
          {
            "node": "üßπ Prep Cleanup",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üìù Prep Work Msg",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Works": {
      "main": [
        [
          {
            "node": "Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Progress ID": {
      "main": [
        [
          {
            "node": "Prep Works",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Send Progress": {
      "main": [
        [
          {
            "node": "Save Progress ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù Prep Progress": {
      "main": [
        [
          {
            "node": "üì§ Send Progress",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìÑ PDF Download Prep": {
      "main": [
        [
          {
            "node": "üìÑ Get PDF Path",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üßπ Deduplicate & Merge": {
      "main": [
        [
          {
            "node": "üìä Show Works",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Show Works": {
      "main": [
        [
          {
            "node": "üì§ Send Works",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì¶ Accumulate Pages": {
      "main": [
        [
          {
            "node": "üîÅ Loop PDF Pages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üè† Parse PDF Page": {
      "main": [
        [
          {
            "node": "üì¶ Accumulate Pages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üëÅÔ∏è Call Vision PDF": {
      "main": [
        [
          {
            "node": "üè† Parse PDF Page",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üëÅÔ∏è Prep Vision PDF": {
      "main": [
        [
          {
            "node": "üëÅÔ∏è Call Vision PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÅ Loop PDF Pages": {
      "main": [
        [
          {
            "node": "üßπ Deduplicate & Merge",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üëÅÔ∏è Prep Vision PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìÑ Prep Pages Loop": {
      "main": [
        [
          {
            "node": "üîÅ Loop PDF Pages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ PDF Received": {
      "main": [
        [
          {
            "node": "üìÑ Prep Pages Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù Prep PDF Message": {
      "main": [
        [
          {
            "node": "üì§ PDF Received",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìÑ Split PDF Pages": {
      "main": [
        [
          {
            "node": "üìù Prep PDF Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìÑ Download PDF": {
      "main": [
        [
          {
            "node": "üìÑ Split PDF Pages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìÑ Get PDF Path": {
      "main": [
        [
          {
            "node": "üìÑ Download PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge To Vision1": {
      "main": [
        [
          {
            "node": "Prep Vision1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF No Photos1": {
      "main": [
        [
          {
            "node": "üì§ No Photos Msg1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Use Stored Base64",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Vision1": {
      "main": [
        [
          {
            "node": "Parse AI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Vision1": {
      "main": [
        [
          {
            "node": "Merge Vision1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Vision1": {
      "main": [
        [
          {
            "node": "Call Vision1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert To Base": {
      "main": [
        [
          {
            "node": "Merge To Vision1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Photo File1": {
      "main": [
        [
          {
            "node": "Convert To Base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get File Path1": {
      "main": [
        [
          {
            "node": "Download Photo File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Use Stored Base64": {
      "main": [
        [
          {
            "node": "Merge To Vision1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Skip Download": {
      "main": [
        [
          {
            "node": "IF No Photos1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get File Path1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "9Ô∏è‚É£ Calculate": {
      "main": [
        [
          {
            "node": "üìä Update Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "8Ô∏è‚É£ Apply Rerank": {
      "main": [
        [
          {
            "node": "9Ô∏è‚É£ Calculate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7Ô∏è‚É£ LLM Rerank": {
      "main": [
        [
          {
            "node": "8Ô∏è‚É£ Apply Rerank",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6Ô∏è‚É£ Prep Rerank": {
      "main": [
        [
          {
            "node": "7Ô∏è‚É£ LLM Rerank",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5Ô∏è‚É£ Qdrant Search": {
      "main": [
        [
          {
            "node": "6Ô∏è‚É£ Prep Rerank",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4Ô∏è‚É£ Extract Embedding": {
      "main": [
        [
          {
            "node": "5Ô∏è‚É£ Qdrant Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3Ô∏è‚É£ OpenAI Embedding": {
      "main": [
        [
          {
            "node": "4Ô∏è‚É£ Extract Embedding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2Ô∏è‚É£ Extract Transform": {
      "main": [
        [
          {
            "node": "3Ô∏è‚É£ OpenAI Embedding",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1.5Ô∏è‚É£ LLM Transform": {
      "main": [
        [
          {
            "node": "2Ô∏è‚É£ Extract Transform",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Text LLM": {
      "main": [
        [
          {
            "node": "üìä Show Works",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "View Details": {
      "main": [
        [
          {
            "node": "üì§ Details",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF PDF": {
      "main": [
        [
          {
            "node": "üì§ Send PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate PDF": {
      "main": [
        [
          {
            "node": "IF PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Excel": {
      "main": [
        [
          {
            "node": "üì§ Send Excel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep HTML File": {
      "main": [
        [
          {
            "node": "üì§ Send HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Final": {
      "main": [
        [
          {
            "node": "Prep HTML File",
            "type": "main",
            "index": 0
          },
          {
            "node": "üì§ Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate HTML": {
      "main": [
        [
          {
            "node": "Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Calc CB": {
      "main": [
        [
          {
            "node": "üìù Prep Progress",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Works Updated": {
      "main": [
        [
          {
            "node": "üì§ Works Updated",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Menu": {
      "main": [
        [
          {
            "node": "üì§ Edit Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI": {
      "main": [
        [
          {
            "node": "üìä Show Works",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Photo CB": {
      "main": [
        [
          {
            "node": "üì§ Ask Photo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Lang CB": {
      "main": [
        [
          {
            "node": "üì§ Lang OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route": {
      "main": [
        [
          {
            "node": "üì§ Lang Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Lang CB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Photo CB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üì§ Analyze Options",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üì§ Analyze Options",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Refine Analysis",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Works Updated",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üì§ Ask New Work",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Calc CB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate Excel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate PDF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üì§ Help",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "View Details",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Refine Analysis",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prep Text LLM",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üìÑ PDF Download Prep",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üì§ Fallback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Config": {
      "main": [
        [
          {
            "node": "Route",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Main": {
      "main": [
        [
          {
            "node": "Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîë TOKEN": {
      "main": [
        [
          {
            "node": "Main",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "üîë TOKEN",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Refine Analysis": {
      "main": [
        [
          {
            "node": "IF Skip Refine",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Skip Refine": {
      "main": [
        [
          {
            "node": "üì§ Ask Photo Refine",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prep Photo Download",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Photo Download": {
      "main": [
        [
          {
            "node": "IF Skip Download",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Text LLM": {
      "main": [
        [
          {
            "node": "Call Text LLM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Text LLM": {
      "main": [
        [
          {
            "node": "Parse Text LLM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Trigger1": {
      "main": [
        [
          {
            "node": "Set the conversion variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check - Did extraction succeed?": {
      "main": [
        [
          {
            "node": "Error - Show what went wrong",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Success - Create Excel filename",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Success - Create Excel filename": {
      "main": [
        [
          {
            "node": "Extract - Read Excel file from disk",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract - Read Excel file from disk": {
      "main": [
        [
          {
            "node": "Extract - Parse Excel to data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract - Parse Excel to data": {
      "main": [
        [
          {
            "node": "On the standard 3D View",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Trigger2": {
      "main": [
        [
          {
            "node": "Setup - Define file paths",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform - Filter only OST_Walls": {
      "main": [
        [
          {
            "node": "Transform - Clean wall data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform - Clean wall data": {
      "main": [
        [
          {
            "node": "Transform - Group by Type Name & sum Volume",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform - Group by Type Name & sum Volume": {
      "main": [
        [
          {
            "node": "Transform - Generate HTML Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transform - Generate HTML Report": {
      "main": [
        [
          {
            "node": "Load - Save HTML Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load - Save HTML Report": {
      "main": [
        [
          {
            "node": "Success - Final results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check - Did extraction succeed?1": {
      "main": [
        [
          {
            "node": "Error - Show what went wrong1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Success - Create Excel filename1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Success - Create Excel filename1": {
      "main": [
        [
          {
            "node": "Extract - Read Excel file from disk1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract - Read Excel file from disk1": {
      "main": [
        [
          {
            "node": "Extract - Parse Excel to data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract - Parse Excel to data1": {
      "main": [
        [
          {
            "node": "On the standard 3D View1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "On the standard 3D View1": {
      "main": [
        [
          {
            "node": "Transform - Filter only OST_Walls",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Non-3D View Elements Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook Trigger3": {
      "main": [
        [
          {
            "node": "Setup - Define file paths1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture Pipeline Start Time1": {
      "main": [
        [
          {
            "node": "Set Configuration Parameters1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge Pipeline Start with Config1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Pipeline Start with Config1": {
      "main": [
        [
          {
            "node": "Merge Config with Search Results1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Configuration Parameters1": {
      "main": [
        [
          {
            "node": "Merge Pipeline Start with Config1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Config with Search Results1": {
      "main": [
        [
          {
            "node": "Process File List1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process File List1": {
      "main": [
        [
          {
            "node": "Check if Files Exist1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Files Exist1": {
      "main": [
        [
          {
            "node": "Split Files for Processing1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Files Found Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Files for Processing1": {
      "main": [
        [
          {
            "node": "Merge File Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge File Data1": {
      "main": [
        [
          {
            "node": "Capture Start Time1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture Start Time1": {
      "main": [
        [
          {
            "node": "Small Delay",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge Data Before Verification1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calculate Conversion Time1": {
      "main": [
        [
          {
            "node": "Merge Data Before Verification1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Complete File Verification1": {
      "main": [
        [
          {
            "node": "Generate HTML Report1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate HTML Report1": {
      "main": [
        [
          {
            "node": "Prepare Binary Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Binary Data1": {
      "main": [
        [
          {
            "node": "Save HTML File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save HTML File1": {
      "main": [
        [
          {
            "node": "Verify and Prepare Path1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger1": {
      "main": [
        [
          {
            "node": "üîë TOKEN1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Lang OK": {
      "main": [
        [
          {
            "node": "üì§ Lang OK1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîß Config Parse": {
      "main": [
        [
          {
            "node": "ü§ñ AI Parse Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ü§ñ AI Parse Text": {
      "main": [
        [
          {
            "node": "üìù Parse Text Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Model 1": {
      "ai_languageModel": [
        [
          {
            "node": "ü§ñ AI Parse Text",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "üîß Config Transform": {
      "main": [
        [
          {
            "node": "ü§ñ AI Transform",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ü§ñ AI Transform": {
      "main": [
        [
          {
            "node": "2Ô∏è‚É£ Extract Transform1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Model 2": {
      "ai_languageModel": [
        [
          {
            "node": "ü§ñ AI Transform",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "ü§ñ AI Rerank",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "üîß Config Rerank": {
      "main": [
        [
          {
            "node": "ü§ñ AI Rerank",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ü§ñ AI Rerank": {
      "main": [
        [
          {
            "node": "8Ô∏è‚É£ Apply Rerank1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù Parse Text Response": {
      "main": [
        [
          {
            "node": "üìä Show Works1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîß Config Embed": {
      "main": [
        [
          {
            "node": "3Ô∏è‚É£ Embeddings API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3Ô∏è‚É£ Embeddings API": {
      "main": [
        [
          {
            "node": "4Ô∏è‚É£ Extract Embedding1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîë TOKEN1": {
      "main": [
        [
          {
            "node": "Main1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agg1": {
      "main": [
        [
          {
            "node": "Generate HTML1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üóëÔ∏è Delete Progress Msg1": {
      "main": [
        [
          {
            "node": "Agg1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üóëÔ∏è Delete Work Msg1": {
      "main": [
        [
          {
            "node": "üóëÔ∏è Delete Progress Msg1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üßπ Prep Cleanup1": {
      "main": [
        [
          {
            "node": "üóëÔ∏è Delete Work Msg1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Acc1": {
      "main": [
        [
          {
            "node": "Loop1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Edit Result1": {
      "main": [
        [
          {
            "node": "Acc1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Update Result1": {
      "main": [
        [
          {
            "node": "üì§ Edit Result1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1Ô∏è‚É£ Prep Query1": {
      "main": [
        [
          {
            "node": "üîß Config Transform",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Save Work Msg1": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£ Prep Query1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Send Work1": {
      "main": [
        [
          {
            "node": "üíæ Save Work Msg1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üóëÔ∏è Delete Prev1": {
      "main": [
        [
          {
            "node": "üì§ Send Work1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù Prep Work Msg1": {
      "main": [
        [
          {
            "node": "üóëÔ∏è Delete Prev1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop1": {
      "main": [
        [
          {
            "node": "üßπ Prep Cleanup1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üìù Prep Work Msg1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Works1": {
      "main": [
        [
          {
            "node": "Loop1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Progress ID1": {
      "main": [
        [
          {
            "node": "Prep Works1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Send Progress1": {
      "main": [
        [
          {
            "node": "Save Progress ID1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù Prep Progress1": {
      "main": [
        [
          {
            "node": "üì§ Send Progress1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Show Works1": {
      "main": [
        [
          {
            "node": "üì§ Send Works1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "9Ô∏è‚É£ Calculate1": {
      "main": [
        [
          {
            "node": "üìä Update Result1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "8Ô∏è‚É£ Apply Rerank1": {
      "main": [
        [
          {
            "node": "9Ô∏è‚É£ Calculate1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6Ô∏è‚É£ Prep Rerank1": {
      "main": [
        [
          {
            "node": "üîß Config Rerank",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5Ô∏è‚É£ Qdrant Search1": {
      "main": [
        [
          {
            "node": "6Ô∏è‚É£ Prep Rerank1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4Ô∏è‚É£ Extract Embedding1": {
      "main": [
        [
          {
            "node": "5Ô∏è‚É£ Qdrant Search1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2Ô∏è‚É£ Extract Transform1": {
      "main": [
        [
          {
            "node": "üîß Config Embed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "View Details1": {
      "main": [
        [
          {
            "node": "üì§ Details1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF PDF1": {
      "main": [
        [
          {
            "node": "üì§ Send PDF1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate PDF1": {
      "main": [
        [
          {
            "node": "IF PDF1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Excel1": {
      "main": [
        [
          {
            "node": "üì§ Send Excel1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep HTML File1": {
      "main": [
        [
          {
            "node": "üì§ Send HTML1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Final1": {
      "main": [
        [
          {
            "node": "Prep HTML File1",
            "type": "main",
            "index": 0
          },
          {
            "node": "üì§ Final1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate HTML1": {
      "main": [
        [
          {
            "node": "Final1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Calc CB1": {
      "main": [
        [
          {
            "node": "üìù Prep Progress1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Works Updated1": {
      "main": [
        [
          {
            "node": "üì§ Works Updated1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Menu1": {
      "main": [
        [
          {
            "node": "üì§ Edit Menu1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Lang CB1": {
      "main": [
        [
          {
            "node": "Prep Lang OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route1": {
      "main": [
        [
          {
            "node": "üì§ Lang Menu1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Lang CB1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Works Updated1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Menu1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üì§ Ask New Work1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Calc CB1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate Excel1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate PDF1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üì§ Help1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "View Details1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prep Text LLM1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üì§ Fallback1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Config1": {
      "main": [
        [
          {
            "node": "Route1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Main1": {
      "main": [
        [
          {
            "node": "Config1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Text LLM1": {
      "main": [
        [
          {
            "node": "üîß Config Parse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Photo Upload Form": {
      "main": [
        [
          {
            "node": "Extract Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Input": {
      "main": [
        [
          {
            "node": "Configure Language",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Configure Language": {
      "main": [
        [
          {
            "node": "Has Photo?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Has Photo?": {
      "main": [
        [
          {
            "node": "STAGE 1 Vision Prompt",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error No Photo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "STAGE 1 Vision Prompt": {
      "main": [
        [
          {
            "node": "STAGE 1 Analyze Photo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "STAGE 1 Analyze Photo": {
      "main": [
        [
          {
            "node": "Parse STAGE 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GPT-4 Vision": {
      "ai_languageModel": [
        [
          {
            "node": "STAGE 1 Analyze Photo",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse STAGE 1": {
      "main": [
        [
          {
            "node": "STAGE 4 Decompose Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "STAGE 4 Decompose Prompt": {
      "main": [
        [
          {
            "node": "STAGE 4 Decompose LLM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "STAGE 4 Decompose LLM": {
      "main": [
        [
          {
            "node": "Parse STAGE 4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GPT-4 Decompose": {
      "ai_languageModel": [
        [
          {
            "node": "STAGE 4 Decompose LLM",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Parse STAGE 4": {
      "main": [
        [
          {
            "node": "Prepare Works",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Works": {
      "main": [
        [
          {
            "node": "Loop Works",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Works": {
      "main": [
        [
          {
            "node": "STAGE 7.5 Aggregate & Validate",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Store Work Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Work Data": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Restore Work Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Restore Work Data": {
      "main": [
        [
          {
            "node": "Vector Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vector Search": {
      "main": [
        [
          {
            "node": "STAGE 5 Parse & Score",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings": {
      "ai_embedding": [
        [
          {
            "node": "Vector Search",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "STAGE 5 Parse & Score": {
      "main": [
        [
          {
            "node": "Accumulate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Accumulate": {
      "main": [
        [
          {
            "node": "Loop Works",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "STAGE 7.5 Aggregate & Validate": {
      "main": [
        [
          {
            "node": "STAGE 9 HTML Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "STAGE 9 HTML Report": {
      "main": [
        [
          {
            "node": "Final HTML Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agg2": {
      "main": [
        [
          {
            "node": "Generate HTML2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üóëÔ∏è Delete Progress Msg2": {
      "main": [
        [
          {
            "node": "Agg2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üóëÔ∏è Delete Work Msg2": {
      "main": [
        [
          {
            "node": "üóëÔ∏è Delete Progress Msg2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üßπ Prep Cleanup2": {
      "main": [
        [
          {
            "node": "üóëÔ∏è Delete Work Msg2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Acc2": {
      "main": [
        [
          {
            "node": "Loop2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Edit Result2": {
      "main": [
        [
          {
            "node": "Acc2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Update Result2": {
      "main": [
        [
          {
            "node": "üì§ Edit Result2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1Ô∏è‚É£ Prep Query2": {
      "main": [
        [
          {
            "node": "1.5Ô∏è‚É£ LLM Transform1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Save Work Msg2": {
      "main": [
        [
          {
            "node": "1Ô∏è‚É£ Prep Query2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Send Work2": {
      "main": [
        [
          {
            "node": "üíæ Save Work Msg2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üóëÔ∏è Delete Prev2": {
      "main": [
        [
          {
            "node": "üì§ Send Work2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù Prep Work Msg2": {
      "main": [
        [
          {
            "node": "üóëÔ∏è Delete Prev2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop2": {
      "main": [
        [
          {
            "node": "üßπ Prep Cleanup2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üìù Prep Work Msg2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Works2": {
      "main": [
        [
          {
            "node": "Loop2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Progress ID2": {
      "main": [
        [
          {
            "node": "Prep Works2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Send Progress2": {
      "main": [
        [
          {
            "node": "Save Progress ID2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù Prep Progress2": {
      "main": [
        [
          {
            "node": "üì§ Send Progress2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìÑ PDF Download Prep1": {
      "main": [
        [
          {
            "node": "üìÑ Get PDF Path1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üßπ Deduplicate & Merge1": {
      "main": [
        [
          {
            "node": "üìä Show Works2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìä Show Works2": {
      "main": [
        [
          {
            "node": "üì§ Send Works2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì¶ Accumulate Pages1": {
      "main": [
        [
          {
            "node": "üîÅ Loop PDF Pages1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üè† Parse PDF Page1": {
      "main": [
        [
          {
            "node": "üì¶ Accumulate Pages1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üëÅÔ∏è Call Vision PDF1": {
      "main": [
        [
          {
            "node": "üè† Parse PDF Page1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üëÅÔ∏è Prep Vision PDF1": {
      "main": [
        [
          {
            "node": "üëÅÔ∏è Call Vision PDF1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÅ Loop PDF Pages1": {
      "main": [
        [
          {
            "node": "üßπ Deduplicate & Merge1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üëÅÔ∏è Prep Vision PDF1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìÑ Prep Pages Loop1": {
      "main": [
        [
          {
            "node": "üîÅ Loop PDF Pages1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üì§ PDF Received1": {
      "main": [
        [
          {
            "node": "üìÑ Prep Pages Loop1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìù Prep PDF Message1": {
      "main": [
        [
          {
            "node": "üì§ PDF Received1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìÑ Split PDF Pages1": {
      "main": [
        [
          {
            "node": "üìù Prep PDF Message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìÑ Download PDF1": {
      "main": [
        [
          {
            "node": "üìÑ Split PDF Pages1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìÑ Get PDF Path1": {
      "main": [
        [
          {
            "node": "üìÑ Download PDF1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge To Vision": {
      "main": [
        [
          {
            "node": "Prep Vision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF No Photos": {
      "main": [
        [
          {
            "node": "üì§ No Photos Msg",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Use Stored Base",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Vision": {
      "main": [
        [
          {
            "node": "Parse AI1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Vision": {
      "main": [
        [
          {
            "node": "Merge Vision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Vision": {
      "main": [
        [
          {
            "node": "Call Vision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert To Base1": {
      "main": [
        [
          {
            "node": "Merge To Vision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download Photo File": {
      "main": [
        [
          {
            "node": "Convert To Base1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get File Path": {
      "main": [
        [
          {
            "node": "Download Photo File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Use Stored Base": {
      "main": [
        [
          {
            "node": "Merge To Vision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Skip Download1": {
      "main": [
        [
          {
            "node": "IF No Photos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get File Path",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "9Ô∏è‚É£ Calculate2": {
      "main": [
        [
          {
            "node": "üìä Update Result2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "8Ô∏è‚É£ Apply Rerank2": {
      "main": [
        [
          {
            "node": "9Ô∏è‚É£ Calculate2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "7Ô∏è‚É£ LLM Rerank1": {
      "main": [
        [
          {
            "node": "8Ô∏è‚É£ Apply Rerank2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "6Ô∏è‚É£ Prep Rerank2": {
      "main": [
        [
          {
            "node": "7Ô∏è‚É£ LLM Rerank1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "5Ô∏è‚É£ Qdrant Search2": {
      "main": [
        [
          {
            "node": "6Ô∏è‚É£ Prep Rerank2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "4Ô∏è‚É£ Extract Embedding2": {
      "main": [
        [
          {
            "node": "5Ô∏è‚É£ Qdrant Search2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "3Ô∏è‚É£ OpenAI Embedding1": {
      "main": [
        [
          {
            "node": "4Ô∏è‚É£ Extract Embedding2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "2Ô∏è‚É£ Extract Transform2": {
      "main": [
        [
          {
            "node": "3Ô∏è‚É£ OpenAI Embedding1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "1.5Ô∏è‚É£ LLM Transform1": {
      "main": [
        [
          {
            "node": "2Ô∏è‚É£ Extract Transform2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Text LLM1": {
      "main": [
        [
          {
            "node": "üìä Show Works2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "View Details2": {
      "main": [
        [
          {
            "node": "üì§ Details2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF PDF2": {
      "main": [
        [
          {
            "node": "üì§ Send PDF2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate PDF2": {
      "main": [
        [
          {
            "node": "IF PDF2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Excel2": {
      "main": [
        [
          {
            "node": "üì§ Send Excel2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep HTML File2": {
      "main": [
        [
          {
            "node": "üì§ Send HTML2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Final2": {
      "main": [
        [
          {
            "node": "Prep HTML File2",
            "type": "main",
            "index": 0
          },
          {
            "node": "üì§ Final2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate HTML2": {
      "main": [
        [
          {
            "node": "Final2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Calc CB2": {
      "main": [
        [
          {
            "node": "üìù Prep Progress2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Works Updated2": {
      "main": [
        [
          {
            "node": "üì§ Works Updated2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Menu2": {
      "main": [
        [
          {
            "node": "üì§ Edit Menu2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse AI1": {
      "main": [
        [
          {
            "node": "üìä Show Works2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Photo CB1": {
      "main": [
        [
          {
            "node": "üì§ Ask Photo1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer Lang CB2": {
      "main": [
        [
          {
            "node": "üì§ Lang OK2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route2": {
      "main": [
        [
          {
            "node": "üì§ Lang Menu2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Lang CB2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Photo CB1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üì§ Analyze Options1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üì§ Analyze Options1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Refine Analysis1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Works Updated2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Menu2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üì§ Ask New Work2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Answer Calc CB2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate Excel2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Generate PDF2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üì§ Help2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "View Details2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Refine Analysis1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prep Text LLM2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üìÑ PDF Download Prep1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üì§ Fallback2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Config2": {
      "main": [
        [
          {
            "node": "Route2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Main2": {
      "main": [
        [
          {
            "node": "Config2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîë TOKEN2": {
      "main": [
        [
          {
            "node": "Main2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger2": {
      "main": [
        [
          {
            "node": "üîë TOKEN2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Refine Analysis1": {
      "main": [
        [
          {
            "node": "IF Skip Refine1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Skip Refine1": {
      "main": [
        [
          {
            "node": "üì§ Ask Photo Refine1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prep Photo Download1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Photo Download1": {
      "main": [
        [
          {
            "node": "IF Skip Download1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Text LLM2": {
      "main": [
        [
          {
            "node": "Call Text LLM1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Text LLM1": {
      "main": [
        [
          {
            "node": "Parse Text LLM1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {
    "When clicking ‚ÄòExecute workflow‚Äô": [
      {}
    ]
  },
  "meta": {
    "instanceId": "06264f9623e205074e9489830ccdc830bd45718f4ec7a306f423b0c7a104f1a6"
  }
}