# Проект «Viewer» — Что это и как работает

## Коротко

Viewer — это веб-приложение, которое открывает и показывает файлы разных форматов прямо в браузере. Не нужно устанавливать AutoCAD, Excel или специальные BIM-программы — всё работает на одной веб-странице.

Поддерживаемые форматы:
- **Excel** (.xlsx, .xls) — таблицы
- **PDF** (.pdf) — документы
- **CAD** (.dwg, .dxf) — чертежи
- **IFC** (.ifc) — 3D-модели зданий

---

## Зачем это нужно

В строительстве и проектировании работают с кучей разных файлов: чертежи в AutoCAD, 3D-модели в Revit, сметы в Excel, документация в PDF. Чтобы открыть каждый файл, нужна отдельная программа, причём часто дорогая.

Viewer решает эту проблему: загрузил файл в браузер — и сразу видишь содержимое. Без установки программ, без лицензий, с любого устройства.

---

## Как устроено приложение

### Навигация

Вверху страницы — четыре вкладки: **Excel**, **PDF**, **CAD**, **IFC**. Нажал на вкладку — открылся соответствующий просмотрщик. Каждый работает независимо.

### Загрузка файлов

Во всех просмотрщиках одинаковый принцип: либо нажимаешь кнопку и выбираешь файл, либо просто перетаскиваешь файл в окно браузера (drag & drop).

---

## Четыре просмотрщика — подробно

### 1. Excel-просмотрщик

**Что делает:** Открывает таблицы Excel прямо в браузере. Не просто показывает — можно редактировать ячейки, вводить формулы, переключаться между листами.

**Как работает:**
- Файл загружается и разбирается библиотекой XLSX.js
- Данные передаются в движок UniverJS — это полноценный редактор таблиц
- Поддерживает формулы, форматирование, несколько листов

**По сути:** Это как Google Таблицы, только локально в браузере, без отправки данных на сервер.

---

### 2. PDF-просмотрщик

**Что делает:** Показывает PDF-документы с возможностью наложения аннотаций (пометок).

**Как работает:**
- PDF рендерится через библиотеку PDF.js (та же, что используется в Firefox)
- Каждая страница рисуется на canvas (как картинка, но векторная)
- Масштаб от 0.5x до 4x
- Можно загрузить файл разметки (XML или JSON) — тогда поверх PDF отобразятся аннотации
- Есть боковая панель для управления слоями аннотаций: включать/выключать видимость, менять цвет и прозрачность

**По сути:** Просмотр PDF + система аннотаций для ревью документации.

---

### 3. CAD-просмотрщик

**Что делает:** Открывает чертежи AutoCAD (DWG и DXF) без установки AutoCAD.

**Как работает:**
- При загрузке проверяется, что файл настоящий DWG (проверка «магических байтов» в начале файла)
- Парсинг происходит через WebAssembly-модуль libredwg в отдельном потоке (worker)
- Чертёж рисуется в WebGL-canvas через библиотеку mlightcad
- Доступны стандартные действия: масштабирование, перемещение, вписать в экран, управление слоями

**По сути:** Лёгкий просмотрщик AutoCAD-чертежей в браузере.

---

### 4. IFC/BIM-просмотрщик (самый сложный)

**Что делает:** Открывает 3D-модели зданий в формате IFC (Industry Foundation Classes). Это основной и самый проработанный модуль.

**Как работает:**
- IFC-файл разбирается WebAssembly-парсером web-ifc
- Из файла извлекается геометрия (стены, окна, двери, перекрытия и т.д.)
- 3D-сцена строится через Three.js — библиотеку для 3D-графики в браузере
- Камера управляется мышкой: вращение, перемещение, приближение

**Что умеет:**

| Функция | Описание |
|---------|----------|
| **Выделение элементов** | Клик по элементу — он подсвечивается. Ctrl+Click — добавляет к выделению. Можно выделить рамкой |
| **Скрытие/изоляция** | Скрыть выбранные элементы, показать только выбранные, показать остальные как проволочный каркас |
| **Раскраска** | Покрасить выбранные элементы в любой цвет |
| **Рабочие наборы (Worksets)** | Сгруппировать элементы, дать имя, назначить цвет и прозрачность. Сохраняются в базу данных |
| **Фильтр (Smart Filter)** | Найти элементы по свойствам (например, все стены толщиной 200мм) |
| **Количественный анализ** | Подсчёт объёмов, площадей, количества элементов по категориям |
| **Дерево структуры** | Навигация по этажам и помещениям |
| **Профиль внешнего вида** | Автоматическая раскраска по типу элемента или материалу |
| **Поиск и сохранение выборок** | Найти элементы → сохранить выборку с именем → вернуться к ней позже |
| **Аннотации** | Поставить точку в 3D-пространстве с текстовым комментарием |
| **Измерения** | Измерить расстояние между точками |
| **Секущие плоскости** | «Разрезать» модель плоскостью, чтобы увидеть внутренности |
| **Точки обзора (Viewpoints)** | Сохранить положение камеры, чтобы вернуться к нему позже |
| **Панель свойств** | Детальная информация о выбранном элементе: тип, материал, свойства, классификации |

**По сути:** Это мини-версия BIM-вьюера уровня Navisworks или BIMcollab, но работающий в браузере.

---

## Технологии

| Что | Чем сделано |
|-----|-------------|
| Интерфейс | React 19 |
| Сборка | Vite 7 |
| Язык | TypeScript |
| 3D-графика | Three.js |
| PDF | PDF.js |
| Таблицы | UniverJS |
| Чертежи | mlightcad + libredwg (WebAssembly) |
| IFC-парсинг | web-ifc (WebAssembly) |
| База данных | Supabase (для сохранения рабочих наборов, точек обзора, свойств элементов) |
| Тестирование | Vitest + Playwright |

---

## Структура проекта (упрощённо)

```
test/
├── src/
│   ├── App.tsx                    — Роутинг (переключение вкладок)
│   ├── components/
│   │   ├── Layout/TabNavigation   — Верхние вкладки
│   │   ├── ExcelViewer/           — Просмотрщик Excel
│   │   ├── PdfViewer/             — Просмотрщик PDF + аннотации
│   │   ├── CadViewer/             — Просмотрщик CAD
│   │   ├── IfcViewer/             — 3D-просмотрщик IFC
│   │   ├── ModelViewerPage/       — Полная страница IFC с панелями
│   │   ├── PropertiesPanel/       — Свойства элемента
│   │   ├── WorksetsWidget/        — Управление рабочими наборами
│   │   ├── SmartFilter/           — Фильтрация элементов
│   │   ├── Quantification/        — Подсчёт количеств
│   │   ├── SelectionTree/         — Дерево структуры здания
│   │   ├── Annotations/           — 3D-аннотации
│   │   ├── MeasureTools/          — Инструменты измерений
│   │   ├── SectionPlanes/         — Секущие плоскости
│   │   └── Viewpoints/            — Сохранённые виды
│   ├── services/                  — Работа с базой данных
│   └── pages/                     — Страницы-обёртки для каждого вьюера
├── packages/                      — Локальные библиотеки (исходники)
├── public/
│   ├── wasm/                      — WebAssembly файлы
│   └── assets/                    — Worker-скрипты для парсинга
└── package.json
```

---

## Как всё связано (схема работы)

```
Пользователь
    │
    ▼
[ Браузер ]
    │
    ├─ Вкладка Excel  →  XLSX.js → UniverJS → Редактор таблиц
    │
    ├─ Вкладка PDF    →  PDF.js → Canvas + SVG-аннотации
    │
    ├─ Вкладка CAD    →  libredwg (WASM) → mlightcad → WebGL-чертёж
    │
    └─ Вкладка IFC    →  web-ifc (WASM) → Three.js → 3D-сцена
                              │
                              ▼
                         [ Supabase ]
                         (хранит рабочие наборы,
                          свойства, точки обзора)
```

---

## Итого

Viewer — это универсальный веб-просмотрщик для строительной отрасли. Он позволяет открывать чертежи, 3D-модели, таблицы и документы в одном месте, без установки тяжёлого софта. Главная ценность — IFC/BIM-вьюер с профессиональными инструментами (выделение, фильтрация, измерения, рабочие наборы), который работает прямо в браузере.
